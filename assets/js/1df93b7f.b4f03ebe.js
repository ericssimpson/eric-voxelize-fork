/*! For license information please see 1df93b7f.b4f03ebe.js.LICENSE.txt */
"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3237],{7024:(g,I,C)=>{C.d(I,{E:()=>i});var A=C(7378),t=C(7853),e=C(6173),o=C(4246);const i=()=>{const g=(0,A.useRef)(null);return(0,A.useEffect)((()=>{if(!g.current)return;const I=g.current,C=new e.CP7({canvas:I,antialias:!0,alpha:!0});C.setPixelRatio(window.devicePixelRatio),C.setSize(I.clientWidth,I.clientHeight),C.outputColorSpace=e.KI_;const A=new e.xsS,o=new e.cPb(75,I.clientWidth/I.clientHeight,.1,1e3);o.position.set(0,.5,2.5),o.lookAt(0,-.5,0);const i=new t.zk;A.add(i);const l=new e.Pa4;let c=0,n=0;function d(g){const C=I.getBoundingClientRect();c=g.clientX-(C.x+I.clientWidth/2),n=g.clientY-(C.y+I.clientHeight/2)}document.addEventListener("mousemove",d,!1);const s=()=>{requestAnimationFrame(s),l.x=.02*c,l.y=.02*-n,l.z=o.position.z,i.set([0,0,0],[l.x,l.y-1,l.z]),i.update(),C.render(A,o)};s();const Z=I.parentElement;return window.addEventListener("resize",(()=>{I.width=Z.clientWidth,I.height=Z.clientHeight,o.aspect=Z.clientWidth/Z.clientHeight,o.updateProjectionMatrix(),C.setSize(Z.clientWidth,Z.clientHeight)})),()=>{document.removeEventListener("mousemove",d,!1)}}),[g]),(0,o.jsx)("canvas",{className:"w-full h-full",ref:g})}},3253:(g,I,C)=>{C.r(I),C.d(I,{default:()=>s});C(7378);var A=C(5594),t=C(1191),e=C(9939),o=C(2577),i=C(6156),l=C(5404),c=C(4246);const n=()=>{const{siteConfig:g}=(0,e.Z)();return(0,c.jsxs)("div",{className:"flex flex-col-reverse justify-end items-center min-h-[100vh] lg:flex-row md:min-h-[80vh]",children:[(0,c.jsxs)("div",{className:"flex flex-col justify-start items-center lg:items-start",children:[(0,c.jsxs)("div",{className:"my-10 flex flex-col items-center lg:items-start",children:[(0,c.jsx)("h1",{className:"font-display font-black text-6xl mb-3 md:text-8xl",children:g.title}),(0,c.jsx)(i.e,{sequence:["A multiplayer voxel game engine",1e3,"An immersive 3D web experience",1e3,"A 3D web framework",1e3,"A full-stack game framework",1e3,"A 3D voxel editor",1e3],wrapper:"div",cursor:!1,speed:50,repeat:1/0,className:"font-body text-2xl text-center lg:text-start"})]}),(0,c.jsx)(t.Z,{to:"/tutorials/intro/what-is-voxelize",children:(0,c.jsx)("button",{className:"button button--secondary button--lg",style:{verticalAlign:"middle"},children:"Get Started \u2192"})})]}),(0,c.jsx)("div",{className:"w-[400px] h-[400px] lg:h-[600px]",children:(0,c.jsx)(A.Z,{children:()=>{const g=C(7024).E;return(0,c.jsx)(g,{})}})})]})},d=l.ZP.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  width: 60%;
  margin: 0 auto;
  min-width: 300px;
`,s=()=>(0,c.jsx)(o.Z,{title:"Welcome",description:"\ud83c\udf44 A well-optimized, highly extensible full-stack library to create immersive multiplayer voxel experiences.",children:(0,c.jsx)(d,{children:(0,c.jsx)(n,{})})})},7853:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{zk:()=>Character});var three__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6173),three_examples_jsm_libs_stats_module_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(9597),postprocessing__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(9249),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==__webpack_require__.g?__webpack_require__.g:"undefined"!=typeof self?self:{};function commonjsRequire(g){throw new Error('Could not dynamically require "'+g+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}function iota$1(g){for(var I=new Array(g),C=0;C<g;++C)I[C]=C;return I}var iota_1=iota$1,isBuffer_1=function(g){return null!=g&&(isBuffer$1(g)||isSlowBuffer(g)||!!g._isBuffer)};function isBuffer$1(g){return!!g.constructor&&"function"==typeof g.constructor.isBuffer&&g.constructor.isBuffer(g)}function isSlowBuffer(g){return"function"==typeof g.readFloatLE&&"function"==typeof g.slice&&isBuffer$1(g.slice(0,0))}var iota=iota_1,isBuffer=isBuffer_1,hasTypedArrays="undefined"!=typeof Float64Array;function compare1st(g,I){return g[0]-I[0]}function order(){var g,I=this.stride,C=new Array(I.length);for(g=0;g<C.length;++g)C[g]=[Math.abs(I[g]),g];C.sort(compare1st);var A=new Array(C.length);for(g=0;g<A.length;++g)A[g]=C[g][1];return A}function compileConstructor(g,I){var C=["View",I,"d",g].join("");I<0&&(C="View_Nil"+g);var A="generic"===g;if(-1===I){var t="function "+C+"(a){this.data=a;};var proto="+C+".prototype;proto.dtype='"+g+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+C+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+C+"(a){return new "+C+"(a);}";return new Function(t)()}if(0===I){t="function "+C+"(a,d) {this.data = a;this.offset = d};var proto="+C+".prototype;proto.dtype='"+g+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+C+"_copy() {return new "+C+"(this.data,this.offset)};proto.pick=function "+C+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+C+"_get(){return "+(A?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+C+"_set(v){return "+(A?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+C+"(a,b,c,d){return new "+C+"(a,d)}";return new Function("TrivialArray",t)(CACHED_CONSTRUCTORS[g][0])}t=["'use strict'"];var e=iota(I),o=e.map((function(g){return"i"+g})),i="this.offset+"+e.map((function(g){return"this.stride["+g+"]*i"+g})).join("+"),l=e.map((function(g){return"b"+g})).join(","),c=e.map((function(g){return"c"+g})).join(",");t.push("function "+C+"(a,"+l+","+c+",d){this.data=a","this.shape=["+l+"]","this.stride=["+c+"]","this.offset=d|0}","var proto="+C+".prototype","proto.dtype='"+g+"'","proto.dimension="+I),t.push("Object.defineProperty(proto,'size',{get:function "+C+"_size(){return "+e.map((function(g){return"this.shape["+g+"]"})).join("*"),"}})"),1===I?t.push("proto.order=[0]"):(t.push("Object.defineProperty(proto,'order',{get:"),I<4?(t.push("function "+C+"_order(){"),2===I?t.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===I&&t.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):t.push("ORDER})")),t.push("proto.set=function "+C+"_set("+o.join(",")+",v){"),A?t.push("return this.data.set("+i+",v)}"):t.push("return this.data["+i+"]=v}"),t.push("proto.get=function "+C+"_get("+o.join(",")+"){"),A?t.push("return this.data.get("+i+")}"):t.push("return this.data["+i+"]}"),t.push("proto.index=function "+C+"_index(",o.join(),"){return "+i+"}"),t.push("proto.hi=function "+C+"_hi("+o.join(",")+"){return new "+C+"(this.data,"+e.map((function(g){return["(typeof i",g,"!=='number'||i",g,"<0)?this.shape[",g,"]:i",g,"|0"].join("")})).join(",")+","+e.map((function(g){return"this.stride["+g+"]"})).join(",")+",this.offset)}");var n=e.map((function(g){return"a"+g+"=this.shape["+g+"]"})),d=e.map((function(g){return"c"+g+"=this.stride["+g+"]"}));t.push("proto.lo=function "+C+"_lo("+o.join(",")+"){var b=this.offset,d=0,"+n.join(",")+","+d.join(","));for(var s=0;s<I;++s)t.push("if(typeof i"+s+"==='number'&&i"+s+">=0){d=i"+s+"|0;b+=c"+s+"*d;a"+s+"-=d}");t.push("return new "+C+"(this.data,"+e.map((function(g){return"a"+g})).join(",")+","+e.map((function(g){return"c"+g})).join(",")+",b)}"),t.push("proto.step=function "+C+"_step("+o.join(",")+"){var "+e.map((function(g){return"a"+g+"=this.shape["+g+"]"})).join(",")+","+e.map((function(g){return"b"+g+"=this.stride["+g+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(s=0;s<I;++s)t.push("if(typeof i"+s+"==='number'){d=i"+s+"|0;if(d<0){c+=b"+s+"*(a"+s+"-1);a"+s+"=ceil(-a"+s+"/d)}else{a"+s+"=ceil(a"+s+"/d)}b"+s+"*=d}");t.push("return new "+C+"(this.data,"+e.map((function(g){return"a"+g})).join(",")+","+e.map((function(g){return"b"+g})).join(",")+",c)}");var Z=new Array(I),b=new Array(I);for(s=0;s<I;++s)Z[s]="a[i"+s+"]",b[s]="b[i"+s+"]";t.push("proto.transpose=function "+C+"_transpose("+o+"){"+o.map((function(g,I){return g+"=("+g+"===undefined?"+I+":"+g+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+C+"(this.data,"+Z.join(",")+","+b.join(",")+",this.offset)}"),t.push("proto.pick=function "+C+"_pick("+o+"){var a=[],b=[],c=this.offset");for(s=0;s<I;++s)t.push("if(typeof i"+s+"==='number'&&i"+s+">=0){c=(c+this.stride["+s+"]*i"+s+")|0}else{a.push(this.shape["+s+"]);b.push(this.stride["+s+"])}");return t.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),t.push("return function construct_"+C+"(data,shape,stride,offset){return new "+C+"(data,"+e.map((function(g){return"shape["+g+"]"})).join(",")+","+e.map((function(g){return"stride["+g+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",t.join("\n"))(CACHED_CONSTRUCTORS[g],order)}function arrayDType(g){if(isBuffer(g))return"buffer";if(hasTypedArrays)switch(Object.prototype.toString.call(g)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(g)?"array":"generic"}var CACHED_CONSTRUCTORS={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function wrappedNDArrayCtor(g,I,C,A){if(void 0===g)return(0,CACHED_CONSTRUCTORS.array[0])([]);"number"==typeof g&&(g=[g]),void 0===I&&(I=[g.length]);var t=I.length;if(void 0===C){C=new Array(t);for(var e=t-1,o=1;e>=0;--e)C[e]=o,o*=I[e]}if(void 0===A){A=0;for(e=0;e<t;++e)C[e]<0&&(A-=(I[e]-1)*C[e])}for(var i=arrayDType(g),l=CACHED_CONSTRUCTORS[i];l.length<=t+1;)l.push(compileConstructor(i,l.length-1));return(0,l[t+1])(g,I,C,A)}var ndarray=wrappedNDArrayCtor;function decodeBase64(g,I){var C=atob(g);if(I){for(var A=new Uint8Array(C.length),t=0,e=C.length;t<e;++t)A[t]=C.charCodeAt(t);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}function createURL(g,I,C){var A=void 0===I?null:I,t=decodeBase64(g,void 0!==C&&C),e=t.indexOf("\n",10)+1,o=t.substring(e)+(A?"//# sourceMappingURL="+A:""),i=new Blob([o],{type:"application/javascript"});return URL.createObjectURL(i)}function createBase64WorkerFactory(g,I,C){var A;return function(t){return A=A||createURL(g,I,C),new Worker(A,t)}}var WorkerFactory$4=createBase64WorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgaW1wb3J0U2NyaXB0cygiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9ub2lzZWpzQDIuMS4wL2luZGV4Lm1pbi5qcyIpOwogIGZ1bmN0aW9uIHNldChhcnIsIHgsIHksIHosIHN0cmlkZSwgdmFsdWUpIHsKICAgICAgYXJyW3ggKiBzdHJpZGVbMF0gKyB5ICogc3RyaWRlWzFdICsgeiAqIHN0cmlkZVsyXV0gPSB2YWx1ZTsKICB9CiAgLy8gQHRzLWlnbm9yZQogIGNvbnN0IGluc3RhbmNlID0gbmV3IE5vaXNlKCk7CiAgZnVuY3Rpb24gbm9pc2UoeCwgeSwgeiwgb2N0YXZlcywgZmFsbG9mZiwgbGFjdW5hcml0eSA9IDAuOCkgewogICAgICBsZXQgdG90YWwgPSAwOwogICAgICBsZXQgZnJlcXVlbmN5ID0gMS4wOwogICAgICBsZXQgYW1wbGl0dWRlID0gMS4wOwogICAgICBsZXQgbWF4VmFsID0gMC4wOwogICAgICBmb3IobGV0IGkgPSAwOyBpIDwgb2N0YXZlczsgaSsrKXsKICAgICAgICAgIHRvdGFsICs9IGluc3RhbmNlLnNpbXBsZXgzKHggKiBmcmVxdWVuY3ksIHkgKiBmcmVxdWVuY3ksIHogKiBmcmVxdWVuY3kpICogYW1wbGl0dWRlOwogICAgICAgICAgbWF4VmFsICs9IGFtcGxpdHVkZTsKICAgICAgICAgIGFtcGxpdHVkZSAqPSBmYWxsb2ZmOwogICAgICAgICAgZnJlcXVlbmN5ICo9IGxhY3VuYXJpdHk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRvdGFsIC8gbWF4VmFsOwogIH0KICAvLyBAdHMtaWdub3JlCiAgb25tZXNzYWdlID0gZnVuY3Rpb24oZSkgewogICAgICBjb25zdCB7IGRhdGEgLCBjb25maWdzOiB7IG1pbiAsIG1heCAsIG5vaXNlU2NhbGUgLCB0aHJlc2hvbGQgLCBzdHJpZGUgLCBvY3RhdmVzICwgZmFsbG9mZiAsIHNlZWQgIH0gIH0gPSBlLmRhdGE7CiAgICAgIGluc3RhbmNlLnNlZWQoc2VlZCk7CiAgICAgIGNvbnN0IFtzdGFydFgsIHN0YXJ0WSwgc3RhcnRaXSA9IG1pbjsKICAgICAgY29uc3QgW2VuZFgsIGVuZFksIGVuZFpdID0gbWF4OwogICAgICBmb3IobGV0IHZ4ID0gc3RhcnRYLCBseCA9IDA7IHZ4IDwgZW5kWDsgKyt2eCwgKytseCl7CiAgICAgICAgICBmb3IobGV0IHZ6ID0gc3RhcnRaLCBseiA9IDA7IHZ6IDwgZW5kWjsgKyt2eiwgKytseil7CiAgICAgICAgICAgICAgZm9yKGxldCB2eSA9IHN0YXJ0WSwgbHkgPSAwOyB2eSA8IGVuZFk7ICsrdnksICsrbHkpewogICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vaXNlKHZ4ICogbm9pc2VTY2FsZSwgdnkgKiBub2lzZVNjYWxlLCB2eiAqIG5vaXNlU2NhbGUsIG9jdGF2ZXMsIGZhbGxvZmYpID4gdGhyZXNob2xkID8gMSA6IDA7CiAgICAgICAgICAgICAgICAgIHNldChkYXRhLCBseCwgbHksIGx6LCBzdHJpZGUsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQHRzLWlnbm9yZQogICAgICBwb3N0TWVzc2FnZShkYXRhLCBbCiAgICAgICAgICBkYXRhLmJ1ZmZlcgogICAgICBdKTsKICB9OwoKfSkoKTsKCg==",null,!1),WorkerFactory$3=createBase64WorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgY29uc3QgRkFDRVMgPSBbCiAgICAgIHsKICAgICAgICAgIC8vIGxlZnQKICAgICAgICAgIGRpcjogWwogICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgMAogICAgICAgICAgXSwKICAgICAgICAgIGNvcm5lcnM6IFsKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMAogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAxCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICBdCiAgICAgICAgICBdCiAgICAgIH0sCiAgICAgIHsKICAgICAgICAgIC8vIHJpZ2h0CiAgICAgICAgICBkaXI6IFsKICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgMAogICAgICAgICAgXSwKICAgICAgICAgIGNvcm5lcnM6IFsKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICBdCiAgICAgICAgICBdCiAgICAgIH0sCiAgICAgIHsKICAgICAgICAgIC8vIGJvdHRvbQogICAgICAgICAgZGlyOiBbCiAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICAwCiAgICAgICAgICBdLAogICAgICAgICAgY29ybmVyczogWwogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAxCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMAogICAgICAgICAgICAgIF0KICAgICAgICAgIF0KICAgICAgfSwKICAgICAgewogICAgICAgICAgLy8gdG9wCiAgICAgICAgICBkaXI6IFsKICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgMAogICAgICAgICAgXSwKICAgICAgICAgIGNvcm5lcnM6IFsKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICBdCiAgICAgICAgICBdCiAgICAgIH0sCiAgICAgIHsKICAgICAgICAgIC8vIGJhY2sKICAgICAgICAgIGRpcjogWwogICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAtMQogICAgICAgICAgXSwKICAgICAgICAgIGNvcm5lcnM6IFsKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMAogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICBdCiAgICAgICAgICBdCiAgICAgIH0sCiAgICAgIHsKICAgICAgICAgIC8vIGZyb250CiAgICAgICAgICBkaXI6IFsKICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgMQogICAgICAgICAgXSwKICAgICAgICAgIGNvcm5lcnM6IFsKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgICAxCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICBdCiAgICAgICAgICBdCiAgICAgIH0KICBdOwogIGZ1bmN0aW9uIGdldChhcnIsIHgsIHksIHosIHN0cmlkZSkgewogICAgICBjb25zdCBpbmRleCA9IHggKiBzdHJpZGVbMF0gKyB5ICogc3RyaWRlWzFdICsgeiAqIHN0cmlkZVsyXTsKICAgICAgcmV0dXJuIGluZGV4ID4gYXJyLmxlbmd0aCB8fCBpbmRleCA8IDAgPyAwIDogYXJyW2luZGV4XTsKICB9CiAgZnVuY3Rpb24gY29udGFpbnModm94ZWwsIG1pbiwgbWF4KSB7CiAgICAgIGNvbnN0IFtzeCwgc3ksIHN6XSA9IG1pbjsKICAgICAgY29uc3QgW2V4LCBleSwgZXpdID0gbWF4OwogICAgICBjb25zdCBbdngsIHZ5LCB2el0gPSB2b3hlbDsKICAgICAgcmV0dXJuIHZ4IDwgZXggJiYgdnggPj0gc3ggJiYgdnkgPCBleSAmJiB2eSA+PSBzeSAmJiB2eiA8IGV6ICYmIHZ6ID49IHN6OwogIH0KICAvLyBAdHMtaWdub3JlCiAgb25tZXNzYWdlID0gZnVuY3Rpb24oZSkgewogICAgICBjb25zdCB7IGRhdGEgLCBjb25maWdzOiB7IGRpbWVuc2lvbnMgLCBtaW4gLCBtYXggLCByZWFsTWluICwgcmVhbE1heCAsIHN0cmlkZSAgfSAgfSA9IGUuZGF0YTsKICAgICAgY29uc3QgcG9zaXRpb25zID0gW107CiAgICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgICAgY29uc3QgaW5kaWNlcyA9IFtdOwogICAgICBjb25zdCBbc3RhcnRYLCBzdGFydFksIHN0YXJ0Wl0gPSBtaW47CiAgICAgIGNvbnN0IFtlbmRYLCBlbmRZLCBlbmRaXSA9IG1heDsKICAgICAgY29uc3QgW2R4LCBkeSwgZHpdID0gZGltZW5zaW9uczsKICAgICAgZm9yKGxldCB2eCA9IHN0YXJ0WCwgeCA9IDA7IHZ4IDwgZW5kWDsgKyt2eCwgKyt4KXsKICAgICAgICAgIGZvcihsZXQgdnogPSBzdGFydFosIHogPSAwOyB2eiA8IGVuZFo7ICsrdnosICsreil7CiAgICAgICAgICAgICAgZm9yKGxldCB2eSA9IHN0YXJ0WSwgeSA9IDA7IHZ5IDwgZW5kWTsgKyt2eSwgKyt5KXsKICAgICAgICAgICAgICAgICAgY29uc3Qgdm94ZWwgPSBnZXQoZGF0YSwgdngsIHZ5LCB2eiwgc3RyaWRlKTsKICAgICAgICAgICAgICAgICAgaWYgKHZveGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBUaGVyZSBpcyBhIHZveGVsIGhlcmUgYnV0IGRvIHdlIG5lZWQgZmFjZXMgZm9yIGl0PwogICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCB7IGRpciAsIGNvcm5lcnMgIH0gb2YgRkFDRVMpewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG52eCA9IHZ4ICsgZGlyWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG52eSA9IHZ5ICsgZGlyWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG52eiA9IHZ6ICsgZGlyWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5Wb3hlbCA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnZ4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG52egogICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFnZXQoZGF0YSwgbnZ4LCBudnksIG52eiwgc3RyaWRlKSB8fCAhY29udGFpbnMoblZveGVsLCByZWFsTWluLCByZWFsTWF4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHZveGVsIGhhcyBubyBuZWlnaGJvciBpbiB0aGlzIGRpcmVjdGlvbiBzbyB3ZSBuZWVkIGEgZmFjZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmR4ID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcG9zIG9mIGNvcm5lcnMpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zWCA9IHBvc1swXSArIHg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3NZID0gcG9zWzFdICsgeTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvc1ogPSBwb3NbMl0gKyB6OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2gocG9zWCAqIGR4LCBwb3NZICogZHksIHBvc1ogKiBkeik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxzLnB1c2goLi4uZGlyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRpY2VzLnB1c2gobmR4LCBuZHggKyAxLCBuZHggKyAyLCBuZHggKyAyLCBuZHggKyAxLCBuZHggKyAzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgcG9zaXRpb25zQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KHBvc2l0aW9ucyk7CiAgICAgIGNvbnN0IG5vcm1hbHNBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkobm9ybWFscyk7CiAgICAgIGNvbnN0IGluZGljZXNBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoaW5kaWNlcyk7CiAgICAgIHBvc3RNZXNzYWdlKHsKICAgICAgICAgIHBvc2l0aW9uczogcG9zaXRpb25zQXJyYXksCiAgICAgICAgICBub3JtYWxzOiBub3JtYWxzQXJyYXksCiAgICAgICAgICBpbmRpY2VzOiBpbmRpY2VzQXJyYXkKICAgICAgfSwgLy8gQHRzLWlnbm9yZQogICAgICBbCiAgICAgICAgICBwb3NpdGlvbnNBcnJheS5idWZmZXIsCiAgICAgICAgICBub3JtYWxzQXJyYXkuYnVmZmVyLAogICAgICAgICAgaW5kaWNlc0FycmF5LmJ1ZmZlcgogICAgICBdKTsKICB9OwoKfSkoKTsKCg==",null,!1);function _defineProperty$D(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}const defaultOptions$h={maxWorker:8};class WorkerPool{get isBusy(){return this.available.length<=0}get workingCount(){return this.workers.length-this.available.length}constructor(g,I){void 0===I&&(I=defaultOptions$h),_defineProperty$D(this,"Proto",void 0),_defineProperty$D(this,"options",void 0),_defineProperty$D(this,"queue",void 0),_defineProperty$D(this,"workers",void 0),_defineProperty$D(this,"available",void 0),_defineProperty$D(this,"addJob",void 0),_defineProperty$D(this,"postMessage",void 0),_defineProperty$D(this,"process",void 0),this.Proto=g,this.options=I,this.queue=[],this.workers=[],this.available=[],this.addJob=g=>{this.queue.push(g),this.process()},this.postMessage=(g,I)=>{for(const C of this.workers)C.postMessage(g,I)},this.process=()=>{if(0!==this.queue.length&&this.available.length>0){const g=this.available.pop(),I=this.workers[g],{message:C,buffers:A,resolve:t}=this.queue.shift();I.postMessage(C,A),WorkerPool.WORKING_COUNT++;const e=C=>{let{data:A}=C;WorkerPool.WORKING_COUNT--,I.removeEventListener("message",e),this.available.unshift(g),t(A),this.queue.length>0&&setTimeout(this.process,0)};I.addEventListener("message",e)}};const{maxWorker:C}=I;for(let A=0;A<C;A++){const I=new g;this.workers.push(I),this.available.push(A)}}}_defineProperty$D(WorkerPool,"WORKING_COUNT",0);const cullPool=new WorkerPool(WorkerFactory$3,{maxWorker:2});async function cull(g,I){const{stride:C,data:A}=g,{dimensions:t,min:e,max:o,realMin:i,realMax:l}=I;return new Promise((g=>{cullPool.addJob({message:{data:A,configs:{min:e,max:o,dimensions:t,stride:C,realMin:i,realMax:l}},resolve:g,buffers:[A.buffer.slice(0)]})}))}var CloudsFragmentShader="#define GLSLIFY 1\nuniform vec3 uFogColor;uniform vec3 uCloudColor;uniform float uFogNear;uniform float uFogFar;uniform float uCloudAlpha;varying vec4 vWorldPosition;void main(){gl_FragColor=vec4(uCloudColor,uCloudAlpha);vec3 fogOrigin=cameraPosition;float depth=sqrt(pow(vWorldPosition.x-fogOrigin.x,2.0)+pow(vWorldPosition.z-fogOrigin.z,2.0))/8.0;float fogFactor=smoothstep(uFogNear,uFogFar,depth);gl_FragColor.rgb=mix(gl_FragColor.rgb,uFogColor,fogFactor);}",CloudsVertexShader="#define GLSLIFY 1\nvarying vec4 vWorldPosition;void main(){vWorldPosition=modelMatrix*vec4(position,1.0);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}";function _defineProperty$C(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$h(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$C(g,I,C[I])}))}return g}const defaultOptions$g={alpha:.8,color:"#fff",count:16,noiseScale:.08,width:8,height:3,dimensions:[20,20,20],speedFactor:8,lerpFactor:.3,threshold:.05,octaves:5,falloff:.9,seed:-1,cloudHeight:256};class Clouds extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{constructor(g){var I;void 0===g&&(g={}),super(),I=this,_defineProperty$C(this,"options",void 0),_defineProperty$C(this,"isInitialized",!1),_defineProperty$C(this,"material",void 0),_defineProperty$C(this,"meshes",[]),_defineProperty$C(this,"xOffset",0),_defineProperty$C(this,"zOffset",0),_defineProperty$C(this,"locatedCell",[0,0]),_defineProperty$C(this,"newPosition",new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),_defineProperty$C(this,"pool",new WorkerPool(WorkerFactory$4,{maxWorker:2})),_defineProperty$C(this,"clock",new three__WEBPACK_IMPORTED_MODULE_0__.SUY),_defineProperty$C(this,"reset",(async()=>{this.children.forEach((g=>{var I;g.parent&&(g.parent.remove(g),null===(I=g.geometry)||void 0===I||I.dispose())})),this.meshes.length=0,await this.initialize()})),_defineProperty$C(this,"update",(g=>{if(!this.isInitialized)return;const I=Math.min(.1,this.clock.getDelta()),{speedFactor:C,count:A,dimensions:t}=this.options;this.newPosition=this.position.clone(),this.newPosition.z-=C*I;const e=[Math.floor((g.x-this.position.x)/(A*t[0])),Math.floor((g.z-this.position.z)/(A*t[2]))];if(this.locatedCell[0]!==e[0]||this.locatedCell[1]!==e[1]){const g=e[0]-this.locatedCell[0],I=e[1]-this.locatedCell[1];this.locatedCell=e,Math.abs(g)>1||Math.abs(I)>1?this.reset():(g&&this.shiftX(g),I&&this.shiftZ(I))}this.position.lerp(this.newPosition,this.options.lerpFactor)})),_defineProperty$C(this,"initialize",(async()=>{const{width:g}=this.options,[I,C]=this.locatedCell;for(let A=0;A<g;A++){const t=[];for(let e=0;e<g;e++){const g=await this.makeCell(A+I,e+C);this.add(g),t.push(g)}this.meshes.push(t)}this.isInitialized=!0})),_defineProperty$C(this,"shiftX",(async function(g){void 0===g&&(g=1);const{width:C}=I.options,A=g>0?I.meshes.shift():I.meshes.pop();for(let t=0;t<C;t++)await I.makeCell(I.xOffset+(g>0?C:0),t+I.zOffset,A[t]);g>0?I.meshes.push(A):I.meshes.unshift(A),I.xOffset+=g})),_defineProperty$C(this,"shiftZ",(async function(g){void 0===g&&(g=1);const{width:C}=I.options;for(let A=0;A<C;A++){const t=I.meshes[A],e=g>0?t.shift():t.pop();await I.makeCell(A+I.xOffset,I.zOffset+(g>0?C:0),e),g>0?t.push(e):t.unshift(e)}I.zOffset+=g})),_defineProperty$C(this,"makeCell",(async(g,I,C)=>{const{width:A,height:t,count:e,noiseScale:o,seed:i,threshold:l,dimensions:c,cloudHeight:n,octaves:d,falloff:s}=this.options,Z=C?C.userData.data:ndarray(new Uint8Array((e+2)*t*(e+2)),[e+2,t,e+2]),b=[g*e-1,0,I*e-1],a=[(g+1)*e+1,t,(I+1)*e+1],m=await new Promise((g=>this.pool.addJob({message:{data:Z.data,configs:{min:b,max:a,noiseScale:o,threshold:l,stride:Z.stride,octaves:d,falloff:s,seed:i}},resolve:g,buffers:[Z.data.buffer.slice(0)]})));Z.data=m;const{positions:r,indices:h,normals:B}=await cull(Z,{dimensions:c,min:[1,0,1],max:[e+1,t,e+1],realMin:[0,0,0],realMax:[e+2,t,e+2]}),G=C?C.geometry:new three__WEBPACK_IMPORTED_MODULE_0__.u9r;return G.setAttribute("position",new three__WEBPACK_IMPORTED_MODULE_0__.a$l(r,3)),G.setAttribute("normal",new three__WEBPACK_IMPORTED_MODULE_0__.RNb(B,3)),G.setIndex(Array.from(h)),G.computeBoundingBox(),(C=C||new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(G,this.material)).position.setX((-A/2+g)*e*c[0]),C.position.setY(n),C.position.setZ((-A/2+I)*e*c[2]),C.userData.data=Z,C.renderOrder=-1,C})),this.options=_objectSpread$h({},defaultOptions$g,g);const{seed:C,color:A,alpha:t,uFogNear:e,uFogFar:o,uFogColor:i}=this.options;-1===C&&(this.options.seed=Math.floor(10230123*Math.random())),this.material=new three__WEBPACK_IMPORTED_MODULE_0__.jyz({transparent:!0,vertexShader:CloudsVertexShader,fragmentShader:CloudsFragmentShader,side:three__WEBPACK_IMPORTED_MODULE_0__.Wl3,uniforms:{uFogNear:e||{value:500},uFogFar:o||{value:1e3},uFogColor:i||{value:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#fff")},uCloudColor:{value:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(A)},uCloudAlpha:{value:t}}}),this.material.toneMapped=!1,this.initialize()}}function _defineProperty$B(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class DOMUtils{constructor(){}}_defineProperty$B(DOMUtils,"applyStyles",((g,I)=>{if(g)return Object.keys(I).forEach((C=>{const A=I[C];Array.isArray(g)?g.forEach((g=>g.style[C]=A)):g.style[C]=A})),g})),_defineProperty$B(DOMUtils,"rgba",((g,I,C,A)=>`rgba(${255*g}, ${255*I}, ${255*C}, ${A})`));var _AABB=class{get width(){return this.maxX-this.minX}get height(){return this.maxY-this.minY}get depth(){return this.maxZ-this.minZ}get mag(){return Math.sqrt((this.maxX-this.minX)**2+(this.maxY-this.minY)**2+(this.maxZ-this.minZ)**2)}computeOffsetX(g,I){const C=this.intersection(g);return C.height<=0||C.depth<=0?I:C.width>=0?0:I>0&&g.minX>=this.maxX?Math.min(g.minX-this.maxX,I):I<0&&g.maxX<=this.minX?Math.max(g.maxX-this.minX,I):I}computeOffsetY(g,I){const C=this.intersection(g);return C.width<=0||C.depth<=0?I:C.height>=0?0:I>0&&g.minY>=this.maxY?Math.min(g.minY-this.maxY,I):I<0&&g.maxY<=this.minY?Math.max(g.maxY-this.minY,I):I}computeOffsetZ(g,I){const C=this.intersection(g);return C.width<=0||C.height<=0?I:C.depth>=0?0:I>0&&g.minZ>=this.maxZ?Math.min(g.minZ-this.maxZ,I):I<0&&g.maxZ<=this.minZ?Math.max(g.maxZ-this.minZ,I):I}constructor(g,I,C,A,t,e){this.minX=g,this.minY=I,this.minZ=C,this.maxX=A,this.maxY=t,this.maxZ=e,this.getMin=g=>{if(0===g)return this.minX;if(1===g)return this.minY;if(2===g)return this.minZ;throw new Error("GetMinError: Unknown axis.")},this.setMin=(g,I)=>{if(0===g)this.minX=I;else if(1===g)this.minY=I;else{if(2!==g)throw new Error("SetMinError: Unknown axis.");this.minZ=I}},this.getMax=g=>{if(0===g)return this.maxX;if(1===g)return this.maxY;if(2===g)return this.maxZ;throw new Error("GetMaxError: Unknown axis.")},this.setMax=(g,I)=>{if(0===g)this.maxX=I;else if(1===g)this.maxY=I;else{if(2!==g)throw new Error("SetMaxError: Unknown axis.");this.maxZ=I}},this.translate=g=>{let[I,C,A]=g;return this.minX+=I,this.minY+=C,this.minZ+=A,this.maxX+=I,this.maxY+=C,this.maxZ+=A,this},this.translateAxis=(g,I)=>{if(0===g)this.minX+=I,this.maxX+=I;else if(1===g)this.minY+=I,this.maxY+=I;else{if(2!==g)throw new Error("TranslateAxisError: Unknown axis.");this.minZ+=I,this.maxZ+=I}return this},this.setPosition=g=>{let[I,C,A]=g;return this.maxX=I+this.width,this.maxY=C+this.height,this.maxZ=A+this.depth,this.minX=I,this.minY=C,this.minZ=A,this},this.intersects=g=>!(g.minX>=this.maxX)&&(!(g.minY>=this.maxY)&&(!(g.minZ>=this.maxZ)&&(!(g.maxX<=this.minX)&&(!(g.maxY<=this.minY)&&!(g.maxZ<=this.minZ))))),this.touches=g=>{const I=this.intersection(g);return null!==I&&(0===I.width||0===I.height||0===I.depth)},this.union=g=>new _AABB(Math.min(this.minX,g.minX),Math.min(this.minY,g.minY),Math.min(this.minZ,g.minZ),Math.max(this.maxX,g.maxX),Math.max(this.maxY,g.maxY),Math.max(this.maxZ,g.maxZ)),this.intersection=g=>new _AABB(Math.max(this.minX,g.minX),Math.max(this.minY,g.minY),Math.max(this.minZ,g.minZ),Math.min(this.maxX,g.maxX),Math.min(this.maxY,g.maxY),Math.min(this.maxZ,g.maxZ)),this.clone=()=>new _AABB(this.minX,this.minY,this.minZ,this.maxX,this.maxY,this.maxZ)}},AABB=_AABB;function _defineProperty$A(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}AABB.union=g=>{let I=g[0].minX,C=g[0].minY,A=g[0].minZ,t=g[0].maxX,e=g[0].maxY,o=g[0].maxZ;for(const i of g)I=Math.min(I,i.minX),C=Math.min(C,i.minY),A=Math.min(A,i.minZ),t=Math.max(t,i.maxX),e=Math.max(e,i.maxY),o=Math.max(o,i.maxZ);return new _AABB(I,C,A,t,e,o)};const PY_ROTATION=0,NY_ROTATION=1,PX_ROTATION=2,NX_ROTATION=3,PZ_ROTATION=4,NZ_ROTATION=5,Y_ROT_SEGMENTS=16,Y_ROT_MAP=[];for(let g=0;g<Y_ROT_SEGMENTS;g++)Y_ROT_MAP.push([g/Y_ROT_SEGMENTS*Math.PI*2,g]),Y_ROT_MAP.push([g/Y_ROT_SEGMENTS*Math.PI*2-2*Math.PI,g]);const PI=Math.PI,PI_2$1=Math.PI/2;class BlockRotation{rotateTransparency(g){let[I,C,A,t,e,o]=g;const i=this.value;if(Math.abs(i)<Number.EPSILON)return[I,C,A,t,e,o];const l=[1,2,3],c=[4,5,6];this.rotateNode(l,!0,!1),this.rotateNode(c,!0,!1);const n=l.map((g=>1===g?I:2===g?C:3===g?A:4===g?t:5===g?e:o)),d=c.map((g=>1===g?I:2===g?C:3===g?A:4===g?t:5===g?e:o));return[n[0],n[1],n[2],d[0],d[1],d[2]]}constructor(g,I){var C=this;void 0===g&&(g=PY_ROTATION),void 0===I&&(I=0),_defineProperty$A(this,"value",void 0),_defineProperty$A(this,"yRotation",void 0),_defineProperty$A(this,"rotateNode",(function(g,I,A){switch(void 0===I&&(I=!0),void 0===A&&(A=!0),I&&0!==C.yRotation&&(g[0]-=.5,g[2]-=.5,BlockRotation.rotateY(g,C.yRotation),g[0]+=.5,g[2]+=.5),C.value){case PX_ROTATION:BlockRotation.rotateZ(g,-PI_2$1),A&&(g[1]+=1);break;case NX_ROTATION:BlockRotation.rotateZ(g,PI_2$1),A&&(g[0]+=1);break;case PY_ROTATION:break;case NY_ROTATION:BlockRotation.rotateX(g,PI),A&&(g[1]+=1,g[2]+=1);break;case PZ_ROTATION:BlockRotation.rotateX(g,PI_2$1),A&&(g[1]+=1);break;case NZ_ROTATION:BlockRotation.rotateX(g,-PI_2$1),A&&(g[2]+=1)}})),_defineProperty$A(this,"rotateAABB",(function(g,I,A){void 0===I&&(I=!0),void 0===A&&(A=!0);const t=[g.minX,g.minY,g.minZ],e=[g.maxX,g.maxY,g.maxZ];let o=null,i=null,l=null,c=null;if(I&&0!==C.yRotation){[[g.minX,g.minY,g.minZ],[g.minX,g.minY,g.maxZ],[g.maxX,g.minY,g.minZ],[g.maxX,g.minY,g.maxZ]].forEach((g=>{C.rotateNode(g,!0,!0),o=null===o?g[0]:Math.min(o,g[0]),i=null===i?g[2]:Math.min(i,g[2])}));[[g.minX,g.maxY,g.minZ],[g.minX,g.maxY,g.maxZ],[g.maxX,g.maxY,g.minZ],[g.maxX,g.maxY,g.maxZ]].forEach((g=>{C.rotateNode(g,!0,!0),l=null===l?g[0]:Math.max(l,g[0]),c=null===c?g[2]:Math.max(c,g[2])}))}C.rotateNode(t,I,A),C.rotateNode(e,I,A);const n=g=>g<1e-4?0:g;t[0]=n(t[0]),t[1]=n(t[1]),t[2]=n(t[2]),e[0]=n(e[0]),e[1]=n(e[1]),e[2]=n(e[2]);const d=[null!==o?n(o):Math.min(t[0],e[0]),Math.min(t[1],e[1]),null!==i?n(i):Math.min(t[2],e[2])],s=[null!==l?n(l):Math.max(t[0],e[0]),Math.max(t[1],e[1]),null!==c?n(c):Math.max(t[2],e[2])];return new AABB(d[0],d[1],d[2],s[0],s[1],s[2])})),this.value=g,this.yRotation=I}}function _defineProperty$z(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}_defineProperty$A(BlockRotation,"encode",(function(g,I){void 0===I&&(I=0);const C=I*Math.PI*2/Y_ROT_SEGMENTS;return new BlockRotation(g,C)})),_defineProperty$A(BlockRotation,"decode",(g=>[g.value,Math.round(g.yRotation*Y_ROT_SEGMENTS/(2*Math.PI))%Y_ROT_SEGMENTS])),_defineProperty$A(BlockRotation,"rotateX",((g,I)=>{const C=Math.sin(I),A=Math.cos(I),[,t,e]=g;g[1]=t*A-e*C,g[2]=e*A+t*C})),_defineProperty$A(BlockRotation,"rotateY",((g,I)=>{const C=Math.sin(I),A=Math.cos(I),[t,,e]=g;g[0]=t*A+e*C,g[2]=e*A-t*C})),_defineProperty$A(BlockRotation,"rotateZ",((g,I)=>{const C=Math.sin(I),A=Math.cos(I),[t,e]=g;g[0]=t*A-e*C,g[1]=e*A+t*C}));const ROTATION_MASK=4293984255,Y_ROTATION_MASK=4279238655,STAGE_MASK=4043309055;class BlockUtils{static getBlockRotatedTransparency(g,I){return I.rotateTransparency(g.isTransparent)}constructor(){}}_defineProperty$z(BlockUtils,"extractID",(g=>65535&g)),_defineProperty$z(BlockUtils,"insertID",((g,I)=>4294901760&g|65535&I)),_defineProperty$z(BlockUtils,"extractRotation",(g=>{const I=g>>16&15,C=g>>20&15;return BlockRotation.encode(I,C)})),_defineProperty$z(BlockUtils,"insertRotation",((g,I)=>{const[C,A]=BlockRotation.decode(I);return(g&ROTATION_MASK|(15&C)<<16)&Y_ROTATION_MASK|(15&A)<<20})),_defineProperty$z(BlockUtils,"extractStage",(g=>g>>24&15)),_defineProperty$z(BlockUtils,"insertStage",((g,I)=>g&STAGE_MASK|I<<24)),_defineProperty$z(BlockUtils,"insertAll",((g,I,C)=>{let A=0;return A=BlockUtils.insertID(A,g),I&&(A=BlockUtils.insertRotation(A,I)),void 0!==C&&(A=BlockUtils.insertStage(A,C)),A})),_defineProperty$z(BlockUtils,"getBlockTorchLightLevel",((g,I)=>{switch(I){case"RED":return g.redLightLevel;case"GREEN":return g.greenLightLevel;case"BLUE":return g.blueLightLevel}return 0}));var epsilon=1e-6,create_1=create$2;function create$2(){var g=new Float32Array(3);return g[0]=0,g[1]=0,g[2]=0,g}var clone_1=clone;function clone(g){var I=new Float32Array(3);return I[0]=g[0],I[1]=g[1],I[2]=g[2],I}var fromValues_1=fromValues$1;function fromValues$1(g,I,C){var A=new Float32Array(3);return A[0]=g,A[1]=I,A[2]=C,A}var normalize_1=normalize$1;function normalize$1(g,I){var C=I[0],A=I[1],t=I[2],e=C*C+A*A+t*t;return e>0&&(e=1/Math.sqrt(e),g[0]=I[0]*e,g[1]=I[1]*e,g[2]=I[2]*e),g}var dot_1=dot$1;function dot$1(g,I){return g[0]*I[0]+g[1]*I[1]+g[2]*I[2]}var angle_1=angle,fromValues=fromValues_1,normalize=normalize_1,dot=dot_1;function angle(g,I){var C=fromValues(g[0],g[1],g[2]),A=fromValues(I[0],I[1],I[2]);normalize(C,C),normalize(A,A);var t=dot(C,A);return t>1?0:Math.acos(t)}var copy_1=copy;function copy(g,I){return g[0]=I[0],g[1]=I[1],g[2]=I[2],g}var set_1=set;function set(g,I,C,A){return g[0]=I,g[1]=C,g[2]=A,g}var equals_1=equals,EPSILON=epsilon;function equals(g,I){var C=g[0],A=g[1],t=g[2],e=I[0],o=I[1],i=I[2];return Math.abs(C-e)<=EPSILON*Math.max(1,Math.abs(C),Math.abs(e))&&Math.abs(A-o)<=EPSILON*Math.max(1,Math.abs(A),Math.abs(o))&&Math.abs(t-i)<=EPSILON*Math.max(1,Math.abs(t),Math.abs(i))}var exactEquals_1=exactEquals;function exactEquals(g,I){return g[0]===I[0]&&g[1]===I[1]&&g[2]===I[2]}var add_1=add;function add(g,I,C){return g[0]=I[0]+C[0],g[1]=I[1]+C[1],g[2]=I[2]+C[2],g}var subtract_1=subtract;function subtract(g,I,C){return g[0]=I[0]-C[0],g[1]=I[1]-C[1],g[2]=I[2]-C[2],g}var sub=subtract_1,multiply_1=multiply;function multiply(g,I,C){return g[0]=I[0]*C[0],g[1]=I[1]*C[1],g[2]=I[2]*C[2],g}var mul=multiply_1,divide_1=divide;function divide(g,I,C){return g[0]=I[0]/C[0],g[1]=I[1]/C[1],g[2]=I[2]/C[2],g}var div=divide_1,min_1=min;function min(g,I,C){return g[0]=Math.min(I[0],C[0]),g[1]=Math.min(I[1],C[1]),g[2]=Math.min(I[2],C[2]),g}var max_1=max;function max(g,I,C){return g[0]=Math.max(I[0],C[0]),g[1]=Math.max(I[1],C[1]),g[2]=Math.max(I[2],C[2]),g}var floor_1=floor;function floor(g,I){return g[0]=Math.floor(I[0]),g[1]=Math.floor(I[1]),g[2]=Math.floor(I[2]),g}var ceil_1=ceil;function ceil(g,I){return g[0]=Math.ceil(I[0]),g[1]=Math.ceil(I[1]),g[2]=Math.ceil(I[2]),g}var round_1=round;function round(g,I){return g[0]=Math.round(I[0]),g[1]=Math.round(I[1]),g[2]=Math.round(I[2]),g}var scale_1=scale;function scale(g,I,C){return g[0]=I[0]*C,g[1]=I[1]*C,g[2]=I[2]*C,g}var scaleAndAdd_1=scaleAndAdd;function scaleAndAdd(g,I,C,A){return g[0]=I[0]+C[0]*A,g[1]=I[1]+C[1]*A,g[2]=I[2]+C[2]*A,g}var distance_1=distance;function distance(g,I){var C=I[0]-g[0],A=I[1]-g[1],t=I[2]-g[2];return Math.sqrt(C*C+A*A+t*t)}var dist=distance_1,squaredDistance_1=squaredDistance;function squaredDistance(g,I){var C=I[0]-g[0],A=I[1]-g[1],t=I[2]-g[2];return C*C+A*A+t*t}var sqrDist=squaredDistance_1,length_1=length;function length(g){var I=g[0],C=g[1],A=g[2];return Math.sqrt(I*I+C*C+A*A)}var len=length_1,squaredLength_1=squaredLength;function squaredLength(g){var I=g[0],C=g[1],A=g[2];return I*I+C*C+A*A}var sqrLen=squaredLength_1,negate_1=negate;function negate(g,I){return g[0]=-I[0],g[1]=-I[1],g[2]=-I[2],g}var inverse_1=inverse;function inverse(g,I){return g[0]=1/I[0],g[1]=1/I[1],g[2]=1/I[2],g}var cross_1=cross;function cross(g,I,C){var A=I[0],t=I[1],e=I[2],o=C[0],i=C[1],l=C[2];return g[0]=t*l-e*i,g[1]=e*o-A*l,g[2]=A*i-t*o,g}var lerp_1=lerp;function lerp(g,I,C,A){var t=I[0],e=I[1],o=I[2];return g[0]=t+A*(C[0]-t),g[1]=e+A*(C[1]-e),g[2]=o+A*(C[2]-o),g}var random_1=random;function random(g,I){I=I||1;var C=2*Math.random()*Math.PI,A=2*Math.random()-1,t=Math.sqrt(1-A*A)*I;return g[0]=Math.cos(C)*t,g[1]=Math.sin(C)*t,g[2]=A*I,g}var transformMat4_1=transformMat4;function transformMat4(g,I,C){var A=I[0],t=I[1],e=I[2],o=C[3]*A+C[7]*t+C[11]*e+C[15];return o=o||1,g[0]=(C[0]*A+C[4]*t+C[8]*e+C[12])/o,g[1]=(C[1]*A+C[5]*t+C[9]*e+C[13])/o,g[2]=(C[2]*A+C[6]*t+C[10]*e+C[14])/o,g}var transformMat3_1=transformMat3;function transformMat3(g,I,C){var A=I[0],t=I[1],e=I[2];return g[0]=A*C[0]+t*C[3]+e*C[6],g[1]=A*C[1]+t*C[4]+e*C[7],g[2]=A*C[2]+t*C[5]+e*C[8],g}var transformQuat_1=transformQuat;function transformQuat(g,I,C){var A=I[0],t=I[1],e=I[2],o=C[0],i=C[1],l=C[2],c=C[3],n=c*A+i*e-l*t,d=c*t+l*A-o*e,s=c*e+o*t-i*A,Z=-o*A-i*t-l*e;return g[0]=n*c+Z*-o+d*-l-s*-i,g[1]=d*c+Z*-i+s*-o-n*-l,g[2]=s*c+Z*-l+n*-i-d*-o,g}var rotateX_1=rotateX;function rotateX(g,I,C,A){var t=C[1],e=C[2],o=I[1]-t,i=I[2]-e,l=Math.sin(A),c=Math.cos(A);return g[0]=I[0],g[1]=t+o*c-i*l,g[2]=e+o*l+i*c,g}var rotateY_1=rotateY$1;function rotateY$1(g,I,C,A){var t=C[0],e=C[2],o=I[0]-t,i=I[2]-e,l=Math.sin(A),c=Math.cos(A);return g[0]=t+i*l+o*c,g[1]=I[1],g[2]=e+i*c-o*l,g}var rotateZ_1=rotateZ;function rotateZ(g,I,C,A){var t=C[0],e=C[1],o=I[0]-t,i=I[1]-e,l=Math.sin(A),c=Math.cos(A);return g[0]=t+o*c-i*l,g[1]=e+o*l+i*c,g[2]=I[2],g}var forEach_1=forEach,vec=create_1();function forEach(g,I,C,A,t,e){var o,i;for(I||(I=3),C||(C=0),i=A?Math.min(A*I+C,g.length):g.length,o=C;o<i;o+=I)vec[0]=g[o],vec[1]=g[o+1],vec[2]=g[o+2],t(vec,vec,e),g[o]=vec[0],g[o+1]=vec[1],g[o+2]=vec[2];return g}var glVec3={EPSILON:epsilon,create:create_1,clone:clone_1,angle:angle_1,fromValues:fromValues_1,copy:copy_1,set:set_1,equals:equals_1,exactEquals:exactEquals_1,add:add_1,subtract:subtract_1,sub:sub,multiply:multiply_1,mul:mul,divide:divide_1,div:div,min:min_1,max:max_1,floor:floor_1,ceil:ceil_1,round:round_1,scale:scale_1,scaleAndAdd:scaleAndAdd_1,distance:distance_1,dist:dist,squaredDistance:squaredDistance_1,sqrDist:sqrDist,length:length_1,len:len,squaredLength:squaredLength_1,sqrLen:sqrLen,negate:negate_1,inverse:inverse_1,normalize:normalize_1,dot:dot_1,cross:cross_1,lerp:lerp_1,random:random_1,transformMat4:transformMat4_1,transformMat3:transformMat3_1,transformQuat:transformQuat_1,rotateX:rotateX_1,rotateY:rotateY_1,rotateZ:rotateZ_1,forEach:forEach_1};function _defineProperty$y(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class ChunkUtils{constructor(){}}function _defineProperty$x(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}_defineProperty$y(ChunkUtils,"getChunkName",(function(g,I){return void 0===I&&(I="|"),g[0]+I+g[1]})),_defineProperty$y(ChunkUtils,"getVoxelName",(function(g,I){return void 0===I&&(I="|"),(0|g[0])+I+(0|g[1])+I+(0|g[2])})),_defineProperty$y(ChunkUtils,"parseChunkName",(function(g,I){return void 0===I&&(I="|"),g.split(I).map((g=>parseInt(g,10)))})),_defineProperty$y(ChunkUtils,"scaleCoordsF",((g,I)=>{const C=glVec3.scale([0,0,0],g,I);return glVec3.floor(C,C)})),_defineProperty$y(ChunkUtils,"mapVoxelToChunkLocal",((g,I)=>{const[C,A]=ChunkUtils.mapVoxelToChunk(g,I),[t,e,o]=g;return[t-C*I,e,o-A*I]})),_defineProperty$y(ChunkUtils,"mapVoxelToChunk",((g,I)=>{const C=ChunkUtils.scaleCoordsF(g,1/I);return[C[0],C[2]]})),_defineProperty$y(ChunkUtils,"mapChunkToVoxel",((g,I)=>{const C=[0,0,0];return glVec3.copy(C,[g[0],0,g[1]]),glVec3.scale(C,C,I),C})),_defineProperty$y(ChunkUtils,"mapWorldToVoxel",(g=>ChunkUtils.scaleCoordsF(g,1)));class LightUtils{constructor(){}}_defineProperty$x(LightUtils,"extractSunlight",(g=>g>>12&15)),_defineProperty$x(LightUtils,"insertSunlight",((g,I)=>4095&g|I<<12)),_defineProperty$x(LightUtils,"extractRedLight",(g=>g>>8&15)),_defineProperty$x(LightUtils,"insertRedLight",((g,I)=>61695&g|I<<8)),_defineProperty$x(LightUtils,"extractGreenLight",(g=>g>>4&15)),_defineProperty$x(LightUtils,"insertGreenLight",((g,I)=>65295&g|I<<4)),_defineProperty$x(LightUtils,"extractBlueLight",(g=>15&g)),_defineProperty$x(LightUtils,"insertBlueLight",((g,I)=>65520&g|I)),_defineProperty$x(LightUtils,"canEnterInto",((g,I,C,A)=>{if(1!==Math.abs(I+C+A))throw new Error("This isn't supposed to happen. Light neighboring direction should be on 1 axis only.");const[t,e,o,i,l,c]=g;return 1===I?i:-1===I?t:1===C?l:-1===C?e:1===A?c:o})),_defineProperty$x(LightUtils,"canEnter",((g,I,C,A,t)=>{if(1!==Math.abs(C+A+t))throw new Error("This isn't supposed to happen. Light neighboring direction should be on 1 axis only.");const[e,o,i,l,c,n]=g,[d,s,Z,b,a,m]=I;return 1===C?e&&b:-1===C?l&&d:1===A?o&&a:-1===A?c&&s:1===t?i&&m:n&&Z}));const RED_LIGHT="RED",GREEN_LIGHT="GREEN",BLUE_LIGHT="BLUE",SUNLIGHT="SUNLIGHT";function _defineProperty$w(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}const TWO_PI=2*Math.PI;class MathUtils{constructor(){}}function _defineProperty$v(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$g(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$v(g,I,C[I])}))}return g}_defineProperty$w(MathUtils,"round",((g,I)=>Math.round(g*10**I)/10**I)),_defineProperty$w(MathUtils,"normalizeAngle",(g=>g-TWO_PI*Math.floor((g+Math.PI)/TWO_PI))),_defineProperty$w(MathUtils,"directionToQuaternion",((g,I,C)=>{const A=(()=>{const A=new three__WEBPACK_IMPORTED_MODULE_0__.yGw,t=new three__WEBPACK_IMPORTED_MODULE_0__._fP,e=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,0,0),o=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,1,0);return()=>t.setFromRotationMatrix(A.lookAt(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(-g,-I,-C),e,o))})();return A()}));const defaultOptions$f={gap:0,layers:1,width:1,widthSegments:8,side:three__WEBPACK_IMPORTED_MODULE_0__.Wl3,transparent:!1},BOX_SIDES=["back","front","top","bottom","left","right"];class BoxLayer extends three__WEBPACK_IMPORTED_MODULE_0__.Kj0{constructor(g,I,C,A,t,e,o,i){super(new three__WEBPACK_IMPORTED_MODULE_0__.DvJ(g,I,C)),_defineProperty$v(this,"materials",new Map),_defineProperty$v(this,"width",void 0),_defineProperty$v(this,"height",void 0),_defineProperty$v(this,"depth",void 0),_defineProperty$v(this,"widthSegments",void 0),_defineProperty$v(this,"heightSegments",void 0),_defineProperty$v(this,"depthSegments",void 0),_defineProperty$v(this,"side",void 0),_defineProperty$v(this,"transparent",void 0),_defineProperty$v(this,"paint",((g,I)=>{const C="all"===g?BOX_SIDES:"sides"===g?["front","back","left","right"]:Array.isArray(g)?g:[g];for(const t of C){var A;const g=this.materials.get(t);if(!g)continue;const C=null===(A=g.map)||void 0===A?void 0:A.image;if(!C)continue;const e=C.getContext("2d");if(!e)continue;e.imageSmoothingEnabled=!1;const{width:o,height:i}=this.getDimensionFromSide(t);I instanceof three__WEBPACK_IMPORTED_MODULE_0__.xEZ?e.drawImage(I.image,0,0,o,i):I instanceof three__WEBPACK_IMPORTED_MODULE_0__.Ilk?(e.save(),e.fillStyle=`rgb(${255*I.r},${255*I.g},${255*I.b})`,e.fillRect(0,0,o,i),e.restore()):"function"==typeof I?I(e,C):console.warn("Invalid art type: ",I),g.needsUpdate=!0,g.map.needsUpdate=!0}})),_defineProperty$v(this,"createCanvasMaterial",(g=>{const I=document.createElement("canvas"),{width:C,height:A}=this.getDimensionFromSide(g);I.width=C,I.height=A;const t=new three__WEBPACK_IMPORTED_MODULE_0__.vBJ({side:this.side,map:new three__WEBPACK_IMPORTED_MODULE_0__.xEZ(I),transparent:this.transparent,name:g});return t.toneMapped=!1,t.map&&(t.map.magFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD,t.map.minFilter=three__WEBPACK_IMPORTED_MODULE_0__.FDw,t.map.wrapS=three__WEBPACK_IMPORTED_MODULE_0__.rpg,t.map.wrapT=three__WEBPACK_IMPORTED_MODULE_0__.rpg,t.map.needsUpdate=!0),t})),_defineProperty$v(this,"getDimensionFromSide",(g=>{switch(g){case"front":case"back":case"top":case"bottom":return{width:this.widthSegments,height:this.heightSegments};case"left":case"right":return{width:this.depthSegments,height:this.heightSegments};default:throw new Error("Cannot derive width/height from unknown side.")}})),this.width=g,this.height=I,this.depth=C,this.widthSegments=A,this.heightSegments=t,this.depthSegments=e,this.side=o,this.transparent=i;for(const n of BOX_SIDES)this.materials.set(n,this.createCanvasMaterial(n));const l=Array.from(this.materials.values()),c=l[0];l[0]=l[1],l[1]=c,this.material=l,this.rotation.y=Math.PI/2}}class CanvasBox extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{get boxMaterials(){return this.boxLayers[0].materials}constructor(g){var I;void 0===g&&(g={}),super(),I=this,_defineProperty$v(this,"options",void 0),_defineProperty$v(this,"boxLayers",[]),_defineProperty$v(this,"width",void 0),_defineProperty$v(this,"height",void 0),_defineProperty$v(this,"depth",void 0),_defineProperty$v(this,"paint",(function(g,C,A){if(void 0===A&&(A=0),A>=I.boxLayers.length)throw new Error("Canvas box layer does not exist.");I.boxLayers[A].paint(g,C)})),_defineProperty$v(this,"makeBoxes",(()=>{const{layers:g,gap:I,side:C,width:A,height:t,depth:e,widthSegments:o,heightSegments:i,depthSegments:l,transparent:c}=this.options;if(!A)throw new Error("CanvasBox width must be specified.");this.width=A,this.height=t||A,this.depth=e||A;for(let n=0;n<g;n++){const g=new BoxLayer(A+n*I*2,(t||A)+n*I*2,(e||A)+n*I*2,o,i||o,l||o,C,c);this.boxLayers.push(g),this.add(g)}})),this.options=_objectSpread$g({},defaultOptions$f,g),this.makeBoxes()}}const drawSun=function(g,I){return void 0===g&&(g=50),void 0===I&&(I="#f8ffb5"),(C,A)=>{const t=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(I);C.save(),C.beginPath();let e=A.width/2,o=A.height/2;const i=C.createRadialGradient(e,o,1,e,o,2*g);i.addColorStop(0,DOMUtils.rgba(1,1,1,.3)),i.addColorStop(1,DOMUtils.rgba(1,1,1,0)),C.arc(e,o,3*g,0,2*Math.PI,!1),C.fillStyle=i,C.fill(),C.closePath(),C.beginPath(),e=A.width/2-g/2,o=A.height/2-g/2,C.rect(e,o,g,g),C.fillStyle=DOMUtils.rgba(t.r,t.g,t.b,1),C.fill(),C.closePath(),C.beginPath();const l=g/1.6;e=A.width/2-l/2,o=A.height/2-l/2,C.rect(e,o,l,l),C.fillStyle=DOMUtils.rgba(1,1,1,.5),C.fill(),C.closePath(),C.restore()}},drawMoon=function(g,I,C){return void 0===g&&(g=20),void 0===I&&(I="#e6e2d1"),void 0===C&&(C=1),(A,t)=>{const e=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(I),o=t.width/2,i=t.height/2;A.beginPath();const l=A.createRadialGradient(o+g/2,i+g/2,1,o+g/2,i+g/2,2*g);l.addColorStop(0,DOMUtils.rgba(1,1,1,.3)),l.addColorStop(1,DOMUtils.rgba(1,1,1,0)),A.arc(o+g/2,i+g/2,2*g,0,2*Math.PI,!1),A.fillStyle=l,A.fill(),A.closePath(),A.save(),A.beginPath(),A.rect(o,i,g,g),A.clip(),A.beginPath(),A.rect(o,i,g,g),A.fillStyle=DOMUtils.rgba(e.r,e.g,e.b,1),A.fill(),A.translate(o,i),A.beginPath(),A.rect(4,4,g-8,g-8),A.fillStyle=DOMUtils.rgba(1,1,1,.8),A.fill();const c=C*g*2-g;A.beginPath(),A.rect(c,0,g,g),A.fillStyle=DOMUtils.rgba(0,0,0,.8),A.fill(),A.beginPath(),A.rect(2+c,2,g-4,g-4),A.fillStyle=DOMUtils.rgba(0,0,0,.9),A.fill(),A.restore()}},drawStars=function(g,I){return void 0===g&&(g=100),void 0===I&&(I=["#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#8589FF","#FF8585"]),(C,A)=>{const t=C.globalAlpha;for(let e=0;e<g;e++)C.globalAlpha=1*Math.random()+.5,C.beginPath(),C.arc(Math.random()*A.width,Math.random()*A.height,.5*Math.random(),0,2*Math.PI,!1),C.fillStyle=I[Math.floor(Math.random()*I.length)],C.fill();C.globalAlpha=t}},drawCrown=g=>{g.fillStyle="#f7ea00",[[0,0],[0,1],[0,2],[1,2],[2,2],[2,1],[3,0],[3,2],[4,0],[4,2],[5,1],[5,2],[6,2],[7,0],[7,1],[7,2]].forEach((I=>{let[C,A]=I;return g.fillRect(C,A,1,1)})),g.fillStyle="#51c2d5",[[1,1],[6,1]].forEach((I=>{let[C,A]=I;return g.fillRect(C,A,1,1)})),g.fillStyle="#ff005c",g.fillRect(3,1,1,1),g.fillRect(4,1,1,1)},artFunctions={drawCrown:drawCrown,drawSun:drawSun,drawMoon:drawMoon,drawStars:drawStars};var SkyFragmentShader="#define GLSLIFY 1\nuniform vec3 uTopColor;uniform vec3 uMiddleColor;uniform vec3 uBottomColor;uniform float uSkyOffset;uniform float uVoidOffset;uniform float uExponent;uniform float uExponent2;varying vec3 vWorldPosition;void main(){float h=normalize(vWorldPosition+uSkyOffset).y;float h2=normalize(vWorldPosition+uVoidOffset).y;vec3 color=mix(uMiddleColor,uTopColor,max(pow(max(h,0.0),uExponent),0.0));gl_FragColor=vec4(mix(color,uBottomColor,max(pow(max(-h2,0.0),uExponent2),0.0)),1.0);}",SkyVertexShader="#define GLSLIFY 1\nvarying vec3 vWorldPosition;void main(){vec4 worldPosition=modelMatrix*vec4(position,1.0);vWorldPosition=worldPosition.xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}";function _defineProperty$u(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$f(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$u(g,I,C[I])}))}return g}const defaultOptions$e={dimension:2e3,lerpFactor:.1,transitionSpan:.05};class Sky extends CanvasBox{constructor(g){void 0===g&&(g={}),super({width:.8*(g.dimension?g.dimension:defaultOptions$e.dimension),side:three__WEBPACK_IMPORTED_MODULE_0__._Li,transparent:!0,widthSegments:512,heightSegments:512,depthSegments:512}),_defineProperty$u(this,"options",void 0),_defineProperty$u(this,"uTopColor",void 0),_defineProperty$u(this,"uMiddleColor",void 0),_defineProperty$u(this,"uBottomColor",void 0),_defineProperty$u(this,"uSkyOffset",void 0),_defineProperty$u(this,"uVoidOffset",void 0),_defineProperty$u(this,"shadingData",[]),_defineProperty$u(this,"setShadingPhases",(g=>{if(0!==g.length){if(1===g.length){const{top:I,middle:C,bottom:A}=g[0].color,t=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(I).convertLinearToSRGB(),e=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(C).convertLinearToSRGB(),o=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(A).convertLinearToSRGB();this.uTopColor.value.copy(t),this.uMiddleColor.value.copy(e),this.uBottomColor.value.copy(o),this.uSkyOffset.value=g[0].skyOffset,this.uVoidOffset.value=g[0].voidOffset}this.shadingData=g,this.shadingData.sort(((g,I)=>g.start-I.start))}})),_defineProperty$u(this,"getTopColor",(()=>this.uTopColor.value)),_defineProperty$u(this,"getMiddleColor",(()=>this.uMiddleColor.value)),_defineProperty$u(this,"getBottomColor",(()=>this.uBottomColor.value)),_defineProperty$u(this,"update",((g,I,C)=>{if(this.rotation.z=2*Math.PI*(I/C),["top","right","left","front","back"].forEach((g=>{this.boxMaterials.get(g)})),this.position.copy(g),this.shadingData.length<=1)return;const A=[],t=this.options.transitionSpan*C;for(let d=0;d<this.shadingData.length;d++){const g=this.shadingData[d],e=this.shadingData[(d+1)%this.shadingData.length],{start:o}=g,i=o*C,l=e.start*C;if(i<l?I>=i&&I<l:I<l||I>=i){const e=Math.max(Math.min(I>=i?(I-i)/t:(I+C-i)/t,1),0);if(A.push([e,g]),I>=i?I<i+t:I+C<i+t){const g=this.shadingData[(d-1<0?d-1+this.shadingData.length:d-1)%this.shadingData.length];A.push([1-e,g])}break}}const e=[0,0,0],o=[0,0,0],i=[0,0,0];let l=0,c=0;const n={r:0,g:0,b:0};A.forEach((g=>{let[I,C]=g;const{skyOffset:A,voidOffset:t,color:{top:d,middle:s,bottom:Z}}=C,b=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(d).convertLinearToSRGB(),a=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(s).convertLinearToSRGB(),m=new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(Z).convertLinearToSRGB();b.getRGB(n),e[0]+=n.r*I,e[1]+=n.g*I,e[2]+=n.b*I,a.getRGB(n),o[0]+=n.r*I,o[1]+=n.g*I,o[2]+=n.b*I,m.getRGB(n),i[0]+=n.r*I,i[1]+=n.g*I,i[2]+=n.b*I,l+=I*A,c+=I*t})),this.uTopColor.value.setRGB(e[0],e[1],e[2]),this.uMiddleColor.value.setRGB(o[0],o[1],o[2]),this.uBottomColor.value.setRGB(i[0],i[1],i[2]),this.uSkyOffset.value=l,this.uVoidOffset.value=c})),_defineProperty$u(this,"createSkyShading",(()=>{const{color:{top:g,middle:I,bottom:C},skyOffset:A,voidOffset:t}={color:{top:"#222",middle:"#222",bottom:"#222"},skyOffset:0,voidOffset:1200};this.uTopColor={value:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(g)},this.uMiddleColor={value:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(I)},this.uBottomColor={value:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(C)},this.uSkyOffset={value:A},this.uVoidOffset={value:t};const e=new three__WEBPACK_IMPORTED_MODULE_0__.Kgo(this.options.dimension,2),o=new three__WEBPACK_IMPORTED_MODULE_0__.jyz({uniforms:{uTopColor:this.uTopColor,uMiddleColor:this.uMiddleColor,uBottomColor:this.uBottomColor,uSkyOffset:this.uSkyOffset,uVoidOffset:this.uVoidOffset,uExponent:{value:.6},uExponent2:{value:1.2}},vertexShader:SkyVertexShader,fragmentShader:SkyFragmentShader,depthWrite:!1,side:three__WEBPACK_IMPORTED_MODULE_0__._Li}),i=new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(e,o);this.attach(i)})),this.options=_objectSpread$f({},this.options,defaultOptions$e,g),this.boxMaterials.forEach((g=>g.depthWrite=!1)),this.frustumCulled=!1,this.renderOrder=-1,this.createSkyShading()}}function _defineProperty$t(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$e(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$t(g,I,C[I])}))}return g}const defaultOptions$d={radius:.1,height:.8,coneRadius:.2,coneHeight:.2,color:"red"};class Arrow extends three__WEBPACK_IMPORTED_MODULE_0__.tGC{constructor(g){void 0===g&&(g={}),super(),_defineProperty$t(this,"options",void 0);const{radius:I,height:C,coneRadius:A,coneHeight:t}=this.options=_objectSpread$e({},defaultOptions$d,g),e="string"==typeof this.options.color?new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(this.options.color):this.options.color;[...this.children].forEach((g=>this.remove(g))),this.add(new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(new three__WEBPACK_IMPORTED_MODULE_0__.fHI(I,I,C),new three__WEBPACK_IMPORTED_MODULE_0__.vBJ({color:e})));const o=new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(new three__WEBPACK_IMPORTED_MODULE_0__.fHI(0,A,t),new three__WEBPACK_IMPORTED_MODULE_0__.vBJ({color:e}));o.position.y=(t+C)/2,this.add(o)}}function _defineProperty$s(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class ColorText{static split(g,I){void 0===I&&(I="black");const C=g.split(new RegExp(`(\\${ColorText.SPLITTER}[^\\${ColorText.SPLITTER}]*\\${ColorText.SPLITTER})`)).filter(Boolean);C.length&&(C[0].includes(ColorText.SPLITTER)||C.unshift(`${ColorText.SPLITTER}${I}${ColorText.SPLITTER}`),C[C.length-1].includes(ColorText.SPLITTER)&&C.push(""));const A=[];for(let t=0;t<C.length;t+=2){const g=C[t].substring(1,C[t].length-1),I=C[t+1];A.push({color:g,text:I})}return A}}function _defineProperty$r(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}_defineProperty$s(ColorText,"SPLITTER","\u2206");class SpriteText extends three__WEBPACK_IMPORTED_MODULE_0__.jyi{get text(){return this._text}set text(g){this._text=g,this.generate()}get textHeight(){return this._textHeight}set textHeight(g){this._textHeight=g,this.generate()}get backgroundColor(){return this._backgroundColor}set backgroundColor(g){this._backgroundColor=g,this.generate()}get padding(){return this._padding}set padding(g){this._padding=g,this.generate()}get borderWidth(){return this._borderWidth}set borderWidth(g){this._borderWidth=g,this.generate()}get borderRadius(){return this._borderRadius}set borderRadius(g){this._borderRadius=g,this.generate()}get borderColor(){return this._borderColor}set borderColor(g){this._borderColor=g,this.generate()}get fontFace(){return this._fontFace}set fontFace(g){this._fontFace=g,this.generate()}get fontSize(){return this._fontSize}set fontSize(g){this._fontSize=g,this.generate()}get fontWeight(){return this._fontWeight}set fontWeight(g){this._fontWeight=g,this.generate()}get strokeWidth(){return this._strokeWidth}set strokeWidth(g){this._strokeWidth=g,this.generate()}get strokeColor(){return this._strokeColor}set strokeColor(g){this._strokeColor=g,this.generate()}constructor(g,I){void 0===g&&(g=""),void 0===I&&(I=10),super(new three__WEBPACK_IMPORTED_MODULE_0__.xeV),_defineProperty$r(this,"_text",void 0),_defineProperty$r(this,"_textHeight",void 0),_defineProperty$r(this,"_backgroundColor",void 0),_defineProperty$r(this,"_padding",0),_defineProperty$r(this,"_borderWidth",0),_defineProperty$r(this,"_borderRadius",0),_defineProperty$r(this,"_borderColor","white"),_defineProperty$r(this,"_strokeWidth",0),_defineProperty$r(this,"_strokeColor","white"),_defineProperty$r(this,"_fontFace","Arial"),_defineProperty$r(this,"_fontSize",90),_defineProperty$r(this,"_fontWeight","normal"),_defineProperty$r(this,"_canvas",document.createElement("canvas")),_defineProperty$r(this,"generate",(()=>{const g=this._canvas,I=g.getContext("2d"),C=Array.isArray(this.borderWidth)?this.borderWidth:[this.borderWidth,this.borderWidth],A=C.map((g=>g*this.fontSize*.1)),t=(Array.isArray(this.borderRadius)?this.borderRadius:[this.borderRadius,this.borderRadius,this.borderRadius,this.borderRadius]).map((g=>g*this.fontSize*.1)),e=Array.isArray(this.padding)?this.padding:[this.padding,this.padding],o=e.map((g=>g*this.fontSize*.1)),i=this.text.split("\n"),l=`${this.fontWeight} ${this.fontSize}px ${this.fontFace}`;I.font=l;const c=Math.max(...i.map((g=>{const C=ColorText.split(g);let A=0;return C.forEach((g=>{let{text:C}=g;return A+=I.measureText(C).width})),A}))),n=this.fontSize*i.length;if(g.width=c+2*A[0]+2*o[0],g.height=n+2*A[1]+2*o[1],this.borderWidth){if(I.strokeStyle=this.borderColor,A[0]){const C=A[0]/2;I.lineWidth=A[0],I.beginPath(),I.moveTo(C,t[0]),I.lineTo(C,g.height-t[3]),I.moveTo(g.width-C,t[1]),I.lineTo(g.width-C,g.height-t[2]),I.stroke()}if(A[1]){const C=A[1]/2;I.lineWidth=A[1],I.beginPath(),I.moveTo(Math.max(A[0],t[0]),C),I.lineTo(g.width-Math.max(A[0],t[1]),C),I.moveTo(Math.max(A[0],t[3]),g.height-C),I.lineTo(g.width-Math.max(A[0],t[2]),g.height-C),I.stroke()}if(this.borderRadius){const C=Math.max(...A),e=C/2;I.lineWidth=C,I.beginPath(),[!!t[0]&&[t[0],e,e,t[0]],!!t[1]&&[g.width-t[1],g.width-e,e,t[1]],!!t[2]&&[g.width-t[2],g.width-e,g.height-e,g.height-t[2]],!!t[3]&&[t[3],e,g.height-e,g.height-t[3]]].filter((g=>g)).forEach((g=>{let[C,A,t,e]=g;I.moveTo(C,t),I.quadraticCurveTo(A,t,A,e)})),I.stroke()}}this.backgroundColor&&(I.fillStyle=this.backgroundColor,this.borderRadius?(I.beginPath(),I.moveTo(A[0],t[0]),[[A[0],t[0],g.width-t[1],A[1],A[1],A[1]],[g.width-A[0],g.width-A[0],g.width-A[0],A[1],t[1],g.height-t[2]],[g.width-A[0],g.width-t[2],t[3],g.height-A[1],g.height-A[1],g.height-A[1]],[A[0],A[0],A[0],g.height-A[1],g.height-t[3],t[0]]].forEach((g=>{let[C,A,t,e,o,i]=g;I.quadraticCurveTo(C,e,A,o),I.lineTo(t,i)})),I.closePath(),I.fill()):I.fillRect(A[0],A[1],g.width-2*A[0],g.height-2*A[1])),I.translate(...A),I.translate(...o),I.font=l,I.textBaseline="bottom";const d=this.strokeWidth>0;d&&(I.lineWidth=this.strokeWidth*this.fontSize/10,I.strokeStyle=this.strokeColor),i.forEach(((g,C)=>{const A=ColorText.split(g,this.strokeColor);let t=0;A.forEach((g=>{let{text:C}=g;return t+=I.measureText(C).width}));let e=(c-t)/2;const o=(C+1)*this.fontSize;A.forEach((g=>{let{color:C,text:A}=g;I.fillStyle=C,I.fillText(A,e,o),d&&I.strokeText(A,e,o),I.fillText(A,e,o),e+=I.measureText(A).width}))})),this.material.map&&this.material.map.dispose();const s=this.material.map=new three__WEBPACK_IMPORTED_MODULE_0__.xEZ(g);s.minFilter=three__WEBPACK_IMPORTED_MODULE_0__.wem,s.needsUpdate=!0;const Z=this.textHeight*i.length+2*C[1]+2*e[1];this.scale.set(Z*g.width/g.height,Z,0)})),this._text=`${g}`,this._textHeight=I,this._backgroundColor=!1,this.generate()}}function _defineProperty$q(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$d(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$q(g,I,C[I])}))}return g}const defaultOptions$c={fontFace:"monospace",fontSize:.1,yOffset:0,color:"#ffffff",backgroundColor:"#00000077"};class NameTag extends SpriteText{constructor(g,I){var C;void 0===I&&(I={}),super(g,null!==(C=I.fontSize)&&void 0!==C?C:defaultOptions$c.fontSize);const{fontFace:A,yOffset:t,backgroundColor:e,color:o}=_objectSpread$d({},defaultOptions$c,I);this.fontFace=A,this.position.y+=t,this.backgroundColor=e,this.material.depthTest=!1,this.renderOrder=1e12,this.strokeColor=o;const i=this.material.map;i&&(i.minFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD,i.magFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD)}}function _defineProperty$p(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$c(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$p(g,I,C[I])}))}return g}function ownKeys$2(g,I){var C=Object.keys(g);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(g);I&&(A=A.filter((function(I){return Object.getOwnPropertyDescriptor(g,I).enumerable}))),C.push.apply(C,A)}return C}function _objectSpreadProps$2(g,I){return I=null!=I?I:{},Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(I)):ownKeys$2(Object(I)).forEach((function(C){Object.defineProperty(g,C,Object.getOwnPropertyDescriptor(I,C))})),g}const CHARACTER_SCALE=.9,defaultCharacterOptions={swingLerp:.8,walkingSpeed:1.4,positionLerp:.7,rotationLerp:.2,idleArmSwing:.06},defaultHeadOptions={gap:.1*CHARACTER_SCALE,layers:1,side:three__WEBPACK_IMPORTED_MODULE_0__.ehD,width:.5*CHARACTER_SCALE,widthSegments:16,height:.25*CHARACTER_SCALE,heightSegments:8,depth:.5*CHARACTER_SCALE,depthSegments:16,neckGap:.05*CHARACTER_SCALE},defaultBodyOptions={gap:.1*CHARACTER_SCALE,layers:1,side:three__WEBPACK_IMPORTED_MODULE_0__.ehD,width:1*CHARACTER_SCALE,widthSegments:16},defaultArmsOptions={gap:.1*CHARACTER_SCALE,layers:1,side:three__WEBPACK_IMPORTED_MODULE_0__.ehD,width:.25*CHARACTER_SCALE,height:.5*CHARACTER_SCALE,depth:.25*CHARACTER_SCALE,widthSegments:8,heightSegments:16,depthSegments:8,shoulderGap:.05*CHARACTER_SCALE,shoulderDrop:.25*CHARACTER_SCALE},defaultLegsOptions={gap:.1*CHARACTER_SCALE,layers:1,side:three__WEBPACK_IMPORTED_MODULE_0__.ehD,width:.25*CHARACTER_SCALE,height:.25*CHARACTER_SCALE,depth:.25*CHARACTER_SCALE,widthSegments:3,heightSegments:3,depthSegments:3,betweenLegsGap:.2*CHARACTER_SCALE};class Character extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{update(){this.calculateDelta(),this.playArmSwingAnimation(),this.playWalkingAnimation(),this.lerpAll()}set(g,I){g&&I&&(this.newPosition.set(g[0],g[1],g[2]),this.newDirection.copy(MathUtils.directionToQuaternion(I[0],I[1],I[2])),this.newBodyDirection.copy(MathUtils.directionToQuaternion(I[0],0,I[2])))}set username(g){var I;this.nametag||(this.nametag=new NameTag(g,_objectSpread$c({yOffset:this.head.height/2+.2,fontSize:.2},null!==(I=this.options.nameTagOptions)&&void 0!==I?I:{})),this.add(this.nametag));g?this.nametag.text=g:this.nametag.visible=!1}get username(){return this.nametag?this.nametag.text:""}get eyeHeight(){return this.options.legs.height+this.options.body.height+this.options.head.neckGap+this.options.head.height/2}get totalHeight(){return this.options.legs.height+this.options.body.height+this.options.head.neckGap+this.options.head.height}constructor(g){var I,C,A,t,e,o,i,l,c;void 0===g&&(g={}),super(),_defineProperty$p(this,"options",void 0),_defineProperty$p(this,"headGroup",void 0),_defineProperty$p(this,"bodyGroup",void 0),_defineProperty$p(this,"leftArmGroup",void 0),_defineProperty$p(this,"rightArmGroup",void 0),_defineProperty$p(this,"leftLegGroup",void 0),_defineProperty$p(this,"rightLegGroup",void 0),_defineProperty$p(this,"head",void 0),_defineProperty$p(this,"body",void 0),_defineProperty$p(this,"leftArm",void 0),_defineProperty$p(this,"rightArm",void 0),_defineProperty$p(this,"leftLeg",void 0),_defineProperty$p(this,"rightLeg",void 0),_defineProperty$p(this,"nametag",void 0),_defineProperty$p(this,"speed",0),_defineProperty$p(this,"newPosition",new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),_defineProperty$p(this,"newBodyDirection",new three__WEBPACK_IMPORTED_MODULE_0__._fP),_defineProperty$p(this,"newDirection",new three__WEBPACK_IMPORTED_MODULE_0__._fP),_defineProperty$p(this,"onMove",void 0),_defineProperty$p(this,"onIdle",void 0),_defineProperty$p(this,"createModel",(()=>{const g=new CanvasBox(_objectSpread$c({},defaultHeadOptions,this.options.head?this.options.head:{})),I=new CanvasBox(_objectSpread$c({},defaultBodyOptions,this.options.body?this.options.body:{})),C=new CanvasBox(_objectSpread$c({},defaultArmsOptions,this.options.arms?this.options.arms:{})),A=new CanvasBox(_objectSpread$c({},defaultArmsOptions,this.options.arms?this.options.arms:{})),t=new CanvasBox(_objectSpread$c({},defaultLegsOptions,this.options.legs?this.options.legs:{})),e=new CanvasBox(_objectSpread$c({},defaultLegsOptions,this.options.legs?this.options.legs:{}));this.headGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.bodyGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.leftArmGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.rightArmGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.leftLegGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.rightLegGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.headGroup.add(g),g.position.y+=g.height/2,this.headGroup.position.y+=I.height+t.height,this.options.head&&this.options.head.neckGap&&(this.headGroup.position.y+=this.options.head.neckGap),this.bodyGroup.add(I),I.position.y+=I.height/2,this.bodyGroup.position.y+=t.height,this.leftArmGroup.add(C),C.position.y-=C.height/2,C.position.x-=C.width/2,this.leftArmGroup.position.y+=I.height,this.leftArmGroup.position.x-=I.width/2,this.rightArmGroup.add(A),A.position.y-=A.height/2,A.position.x+=A.width/2,this.rightArmGroup.position.y+=I.height,this.rightArmGroup.position.x+=I.width/2,this.options.arms&&(this.options.arms.shoulderDrop&&(this.leftArmGroup.position.y-=this.options.arms.shoulderDrop,this.rightArmGroup.position.y-=this.options.arms.shoulderDrop),this.options.arms.shoulderGap&&(this.leftArmGroup.position.x-=this.options.arms.shoulderGap,this.rightArmGroup.position.x+=this.options.arms.shoulderGap)),this.leftLegGroup.add(t),t.position.y-=t.height/2,t.position.x-=t.width/2,this.rightLegGroup.add(e),e.position.y-=e.height/2,e.position.x+=e.width/2,this.options.legs&&this.options.legs.betweenLegsGap&&(this.leftLegGroup.position.x-=this.options.legs.betweenLegsGap/2,this.rightLegGroup.position.x+=this.options.legs.betweenLegsGap/2),g.paint("all",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#96baff")),g.paint("front",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#f99999")),I.paint("all",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#2b2e42")),C.paint("all",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#548ca8")),A.paint("all",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#548ca8")),t.paint("all",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#96baff")),e.paint("all",new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#96baff")),this.add(this.headGroup,this.bodyGroup),this.bodyGroup.add(this.leftArmGroup,this.rightArmGroup,this.leftLegGroup,this.rightLegGroup),this.headGroup.position.y-=this.eyeHeight,this.bodyGroup.position.y-=this.eyeHeight,this.head=g,this.body=I,this.leftArm=C,this.rightArm=A,this.leftLeg=t,this.rightLeg=e})),_defineProperty$p(this,"calculateDelta",(()=>{const g=this.position.clone(),I=this.newPosition.clone();g.y=I.y=0;var C,A;g.distanceTo(I)>1e-5?(0===this.speed&&(null===(C=this.onMove)||void 0===C||C.call(this)),this.speed=this.options.walkingSpeed):(this.speed>0&&(null===(A=this.onIdle)||void 0===A||A.call(this)),this.speed=0)})),_defineProperty$p(this,"lerpAll",(()=>{0!==this.newPosition.length()&&this.position.lerp(this.newPosition,this.options.positionLerp),0!==this.newDirection.length()&&this.headGroup.rotation.setFromQuaternion(this.newDirection),0!==this.newBodyDirection.length()&&this.bodyGroup.quaternion.slerp(this.newBodyDirection,this.options.rotationLerp)})),_defineProperty$p(this,"playArmSwingAnimation",(()=>{const g=100,I=Math.max(this.speed,this.options.idleArmSwing),C=1*I;this.leftArmGroup.rotation.x=three__WEBPACK_IMPORTED_MODULE_0__.M8C.lerp(this.leftArmGroup.rotation.x,Math.sin(performance.now()*I/g)*C,this.options.swingLerp),this.leftArmGroup.rotation.z=three__WEBPACK_IMPORTED_MODULE_0__.M8C.lerp(this.leftArmGroup.rotation.z,Math.cos(performance.now()*I/g)**2*C*.1,this.options.swingLerp),this.rightArmGroup.rotation.x=three__WEBPACK_IMPORTED_MODULE_0__.M8C.lerp(this.rightArmGroup.rotation.x,Math.sin(performance.now()*I/g+Math.PI)*C,this.options.swingLerp),this.rightArmGroup.rotation.z=three__WEBPACK_IMPORTED_MODULE_0__.M8C.lerp(this.rightArmGroup.rotation.z,-(Math.sin(performance.now()*I/g)**2)*C*.1,this.options.swingLerp)})),_defineProperty$p(this,"playWalkingAnimation",(()=>{const g=1*this.speed;this.leftLegGroup.rotation.x=-Math.sin(performance.now()*this.speed/100)*g,this.rightLegGroup.rotation.x=Math.sin(performance.now()*this.speed/100)*g})),this.options=_objectSpreadProps$2(_objectSpread$c({},defaultCharacterOptions,g),{head:_objectSpreadProps$2(_objectSpread$c({},defaultHeadOptions,g.head||{}),{depth:(null===(I=g.head)||void 0===I?void 0:I.depth)||(null===(C=g.head)||void 0===C?void 0:C.width)||defaultHeadOptions.width,height:(null===(A=g.head)||void 0===A?void 0:A.height)||defaultHeadOptions.height||defaultHeadOptions.width}),body:_objectSpreadProps$2(_objectSpread$c({},defaultBodyOptions,g.body||{}),{depth:(null===(t=g.body)||void 0===t?void 0:t.depth)||defaultBodyOptions.depth||defaultBodyOptions.width,height:(null===(e=g.body)||void 0===e?void 0:e.height)||defaultBodyOptions.height||defaultBodyOptions.width}),arms:_objectSpreadProps$2(_objectSpread$c({},defaultArmsOptions,g.arms||{}),{depth:(null===(o=g.arms)||void 0===o?void 0:o.depth)||defaultArmsOptions.width,height:(null===(i=g.arms)||void 0===i?void 0:i.height)||defaultArmsOptions.height}),legs:_objectSpreadProps$2(_objectSpread$c({},defaultLegsOptions,g.legs||{}),{depth:(null===(l=g.legs)||void 0===l?void 0:l.depth)||defaultLegsOptions.width,height:(null===(c=g.legs)||void 0===c?void 0:c.height)||defaultLegsOptions.height})}),this.createModel()}}function _defineProperty$o(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$b(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$o(g,I,C[I])}))}return g}const defaultOptions$b={stats:!0,onByDefault:!0,entryStyles:{},entriesClass:"debug-entries",lineStyles:{},lineClass:"debug-line",dataStyles:{},dataClass:"debug-data",showVoxelize:!0,asyncPeriod:1e3};class Debug extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{constructor(g,I){var C;void 0===g&&(g=document.body),void 0===I&&(I={}),super(),C=this,_defineProperty$o(this,"options",void 0),_defineProperty$o(this,"stats",void 0),_defineProperty$o(this,"dataWrapper",void 0),_defineProperty$o(this,"entriesWrapper",void 0),_defineProperty$o(this,"domElement",void 0),_defineProperty$o(this,"dataEntries",[]),_defineProperty$o(this,"registerDisplay",(function(g,I,A,t){void 0===t&&(t=g=>g);const e=C.makeDataEntry(),o={title:g,element:e,object:I,formatter:t,attribute:A};return C.dataEntries.push(o),C.entriesWrapper.insertBefore(e,C.entriesWrapper.firstChild),"AsyncFunction"===I.constructor.name&&setInterval((()=>{I().then((I=>{e.textContent=`${g?`${g}: `:""}${t(I)}`}))}),C.options.asyncPeriod),C})),_defineProperty$o(this,"removeDisplay",(g=>{const I=this.dataEntries.findIndex((I=>I.title===g)),C=this.dataEntries.splice(I,1)[0];C&&this.entriesWrapper.removeChild(C.element)})),_defineProperty$o(this,"displayTitle",(g=>{const I=this.makeDataEntry(!0);return I.textContent=g,this.entriesWrapper.insertBefore(I,this.entriesWrapper.firstChild),this})),_defineProperty$o(this,"displayNewline",(()=>{const g=this.makeDataEntry(!0);return this.entriesWrapper.insertBefore(g,this.entriesWrapper.firstChild),this})),_defineProperty$o(this,"toggle",(function(g){void 0===g&&(g=null),C.visible=null!==g?g:!C.visible;const I=C.entriesWrapper.style.visibility,A=g?"visible":"visible"===I?"hidden":"visible";C.entriesWrapper.style.visibility=A,C.dataWrapper.style.visibility=A,C.stats&&(C.stats.dom.style.visibility=A)})),_defineProperty$o(this,"update",(()=>{var g;for(const{element:I,title:C,attribute:A,object:t,formatter:e}of this.dataEntries){if("AsyncFunction"===t.constructor.name)continue;const g=t?"function"==typeof t?t():A?t[A]:"":"";I.textContent=`${C?`${C}: `:""}${e(g)}`}null===(g=this.stats)||void 0===g||g.update()})),_defineProperty$o(this,"makeDataEntry",(function(g){void 0===g&&(g=!1);const I=document.createElement("p");return I.classList.add(C.options.lineClass),DOMUtils.applyStyles(I,_objectSpread$b({},g?{height:"16px"}:{},C.options.lineStyles||{})),I})),_defineProperty$o(this,"makeDOM",(()=>{var g;(this.dataWrapper=document.createElement("div"),this.dataWrapper.id="data-wrapper",this.dataWrapper.classList.add(this.options.dataClass),this.entriesWrapper=document.createElement("div"),this.entriesWrapper.classList.add(this.options.entriesClass),DOMUtils.applyStyles(this.dataWrapper,this.options.dataStyles),DOMUtils.applyStyles(this.entriesWrapper,this.options.entryStyles),this.options.stats)&&(this.stats=new three_examples_jsm_libs_stats_module_js__WEBPACK_IMPORTED_MODULE_1__.Z,null===(g=this.stats.dom.parentNode)||void 0===g||g.removeChild(this.stats.dom),DOMUtils.applyStyles(this.stats.dom,{position:"relative",top:"unset",bottom:"unset",left:"unset",zIndex:"1000000000000",marginTop:"13.333px"}))})),_defineProperty$o(this,"setup",(()=>{this.options.showVoxelize&&(this.displayTitle("Voxelize 0.1.150"),this.displayNewline())})),_defineProperty$o(this,"mount",(()=>{var g;(this.dataWrapper.appendChild(this.entriesWrapper),this.stats)&&this.dataWrapper.appendChild(null===(g=this.stats)||void 0===g?void 0:g.dom);this.domElement.appendChild(this.dataWrapper)})),this.domElement=g;const{onByDefault:A}=this.options=_objectSpread$b({},defaultOptions$b,I);this.makeDOM(),this.setup(),this.mount(),this.toggle(A)}}var OverlayFragmentShader="#define GLSLIFY 1\nuniform vec3 overlay;uniform float opacity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=vec4(mix(inputColor.rgb,overlay,opacity),inputColor.a);}";function _defineProperty$n(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class BlockOverlayEffect extends postprocessing__WEBPACK_IMPORTED_MODULE_2__.Qm{get opacity(){return this.uniforms.get("opacity").value}set opacity(g){this.uniforms.get("opacity").value=g}get overlay(){return this.uniforms.get("overlay").value}set overlay(g){const I=this.uniforms.get("overlay").value;I.x=g.r,I.y=g.g,I.z=g.b}constructor(g,I){super("BlockOverlayEffect",OverlayFragmentShader,{uniforms:new Map([["overlay",new three__WEBPACK_IMPORTED_MODULE_0__.xWb(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,0,1))],["opacity",new three__WEBPACK_IMPORTED_MODULE_0__.xWb(0)]])}),_defineProperty$n(this,"world",void 0),_defineProperty$n(this,"camera",void 0),_defineProperty$n(this,"overlays",void 0),_defineProperty$n(this,"oldId",void 0),_defineProperty$n(this,"addOverlay",void 0),_defineProperty$n(this,"update",void 0),this.world=g,this.camera=I,this.overlays=new Map,this.addOverlay=(g,I,C)=>{this.overlays.set("number"==typeof g?g:g.toLowerCase(),[I,C])},this.update=()=>{if(!this.world.isInitialized)return;const g=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4;this.camera.getWorldPosition(g);const I=this.world.getVoxelAt(g.x,g.y,g.z);if(this.oldId===I)return;this.oldId=I;const C=this.world.getBlockById(I),A=this.overlays.get(I)||this.overlays.get(C.name.toLowerCase());A?(this.overlay=A[0],this.opacity=A[1]):this.opacity=0}}}function _defineProperty$m(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$a(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$m(g,I,C[I])}))}return g}const defaultOptions$a={maxDistance:10,maxRadius:.5};class Shadow extends three__WEBPACK_IMPORTED_MODULE_0__.Kj0{constructor(g,I){void 0===I&&(I={}),super(Shadow.GEOMETRY,Shadow.MATERIAL),_defineProperty$m(this,"world",void 0),_defineProperty$m(this,"options",void 0),_defineProperty$m(this,"update",void 0),this.world=g,this.update=()=>{if(!this.parent)return;const g=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4;this.parent.getWorldPosition(g);const{maxDistance:I}=this.options,C=this.world.raycastVoxels(g.toArray(),[0,-1,0],I);if(this.visible=!!C,!C)return;const{point:A}=C;if(isNaN(A[0]))return;const t=Math.sqrt((A[0]-g.x)**2+(A[1]-g.y)**2+(A[2]-g.z)**2),e=Math.max(1-t/I,0)**2,o=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(A[0],A[1]+Shadow.Y_OFFSET,A[2]);o.sub(g),this.position.copy(o),this.scale.set(e,e,1)},this.options=_objectSpread$a({},defaultOptions$a,I),this.rotateX(Math.PI/2),this.renderOrder=-1}}_defineProperty$m(Shadow,"MATERIAL",new three__WEBPACK_IMPORTED_MODULE_0__.vBJ({side:three__WEBPACK_IMPORTED_MODULE_0__.ehD,color:"rgb(0,0,0)",opacity:.3,depthWrite:!1,transparent:!0})),_defineProperty$m(Shadow,"GEOMETRY",new three__WEBPACK_IMPORTED_MODULE_0__.zf8(defaultOptions$a.maxRadius,30)),_defineProperty$m(Shadow,"Y_OFFSET",.01);class Shadows extends Array{constructor(g){var I;if(super(),I=this,_defineProperty$m(this,"world",void 0),_defineProperty$m(this,"update",(()=>{this.forEach(((g,I)=>{g.parent||this.splice(I,1)})),this.forEach((g=>{g.update()}))})),_defineProperty$m(this,"add",(function(g,C){void 0===C&&(C={});const A=new Shadow(I.world,C);g.add(A),I.push(A)})),!g)throw new Error("Shadows: world is required.");this.world=g}}function _defineProperty$l(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$9(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$l(g,I,C[I])}))}return g}const position=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,defaultOptions$9={lerpFactor:.1};class LightShined{constructor(g,I){var C=this;void 0===I&&(I={}),_defineProperty$l(this,"world",void 0),_defineProperty$l(this,"options",void 0),_defineProperty$l(this,"list",void 0),_defineProperty$l(this,"ignored",void 0),_defineProperty$l(this,"add",void 0),_defineProperty$l(this,"remove",void 0),_defineProperty$l(this,"update",void 0),_defineProperty$l(this,"ignore",void 0),_defineProperty$l(this,"updateObject",void 0),_defineProperty$l(this,"recursiveUpdate",void 0),this.world=g,this.list=new Set,this.ignored=new Set,this.add=g=>{this.list.add(g)},this.remove=g=>{this.list.delete(g)},this.update=()=>{this.list.forEach((g=>{this.recursiveUpdate(g)}))},this.ignore=function(){for(var g=arguments.length,I=new Array(g),A=0;A<g;A++)I[A]=arguments[A];I.forEach((g=>{C.ignored.add(g)}))},this.updateObject=(g,I)=>{for(const C of this.ignored)if(g instanceof C)return;if(g instanceof three__WEBPACK_IMPORTED_MODULE_0__.Kj0){(Array.isArray(g.material)?g.material:[g.material]).forEach((g=>{g&&g.color&&g.color.copy(I)}))}},this.recursiveUpdate=function(g,I){if(void 0===I&&(I=null),g.parent){for(const I of C.ignored)if(g instanceof I)return;if(null===I){g.getWorldPosition(position);const A=ChunkUtils.mapWorldToVoxel(position.toArray());if(!C.world.getChunkByPosition(...A))return;I=C.world.getLightColorAt(...A)}if(g.userData.voxelizeLightShined){const C=g.userData.voxelizeLightShined.sub(I);if(C.r**2+C.g**2+C.b**2<.01)return}C.updateObject(g,I),g.traverse((g=>{C.updateObject(g,I)}))}},this.options=_objectSpread$9({},defaultOptions$9,I),this.ignore(Shadow),this.ignore(NameTag)}}var isMergeableObject=function(g){return isNonNullObject(g)&&!isSpecial(g)};function isNonNullObject(g){return!!g&&"object"==typeof g}function isSpecial(g){var I=Object.prototype.toString.call(g);return"[object RegExp]"===I||"[object Date]"===I||isReactElement(g)}var canUseSymbol="function"==typeof Symbol&&Symbol.for,REACT_ELEMENT_TYPE=canUseSymbol?Symbol.for("react.element"):60103;function isReactElement(g){return g.$$typeof===REACT_ELEMENT_TYPE}function emptyTarget(g){return Array.isArray(g)?[]:{}}function cloneUnlessOtherwiseSpecified(g,I){return!1!==I.clone&&I.isMergeableObject(g)?deepmerge(emptyTarget(g),g,I):g}function defaultArrayMerge(g,I,C){return g.concat(I).map((function(g){return cloneUnlessOtherwiseSpecified(g,C)}))}function getMergeFunction(g,I){if(!I.customMerge)return deepmerge;var C=I.customMerge(g);return"function"==typeof C?C:deepmerge}function getEnumerableOwnPropertySymbols(g){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(g).filter((function(I){return Object.propertyIsEnumerable.call(g,I)})):[]}function getKeys(g){return Object.keys(g).concat(getEnumerableOwnPropertySymbols(g))}function propertyIsOnObject(g,I){try{return I in g}catch(C){return!1}}function propertyIsUnsafe(g,I){return propertyIsOnObject(g,I)&&!(Object.hasOwnProperty.call(g,I)&&Object.propertyIsEnumerable.call(g,I))}function mergeObject(g,I,C){var A={};return C.isMergeableObject(g)&&getKeys(g).forEach((function(I){A[I]=cloneUnlessOtherwiseSpecified(g[I],C)})),getKeys(I).forEach((function(t){propertyIsUnsafe(g,t)||(propertyIsOnObject(g,t)&&C.isMergeableObject(I[t])?A[t]=getMergeFunction(t,C)(g[t],I[t],C):A[t]=cloneUnlessOtherwiseSpecified(I[t],C))})),A}function deepmerge(g,I,C){(C=C||{}).arrayMerge=C.arrayMerge||defaultArrayMerge,C.isMergeableObject=C.isMergeableObject||isMergeableObject,C.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified;var A=Array.isArray(I);return A===Array.isArray(g)?A?C.arrayMerge(g,I,C):mergeObject(g,I,C):cloneUnlessOtherwiseSpecified(I,C)}deepmerge.all=function(g,I){if(!Array.isArray(g))throw new Error("first argument should be an array");return g.reduce((function(g,C){return deepmerge(g,C,I)}),{})};var deepmerge_1=deepmerge,cjs=deepmerge_1;const TRANSPARENT_RENDER_ORDER=1e5,OPAQUE_RENDER_ORDER=100,empty=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,TRANSPARENT_SORT=g=>(I,C)=>{if(I.object&&I.object.isMesh&&I.object.userData.isChunk&&C.object&&C.object.isMesh&&C.object.userData.isChunk){const A=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,t=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,{object:e}=I,{object:o}=C,{geometry:i}=e,{geometry:l}=o;return i.boundingBox||i.computeBoundingBox(),l.boundingBox||l.computeBoundingBox(),i&&i.boundingBox?(i.boundingBox.getCenter(A),A.add(e.getWorldPosition(empty))):e.getWorldPosition(A),l&&l.boundingBox?(l.boundingBox.getCenter(t),t.add(o.getWorldPosition(empty))):o.getWorldPosition(t),t.distanceToSquared(g.position)-A.distanceToSquared(g.position)>0?1:-1}return I.groupOrder!==C.groupOrder?I.groupOrder-C.groupOrder:I.renderOrder!==C.renderOrder?I.renderOrder-C.renderOrder:I.z!==C.z?C.z-I.z:I.id-C.id},noop$1=()=>{};function _defineProperty$k(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$8(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$k(g,I,C[I])}))}return g}function ownKeys$1(g,I){var C=Object.keys(g);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(g);I&&(A=A.filter((function(I){return Object.getOwnPropertyDescriptor(g,I).enumerable}))),C.push.apply(C,A)}return C}function _objectSpreadProps$1(g,I){return I=null!=I?I:{},Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(I)):ownKeys$1(Object(I)).forEach((function(C){Object.defineProperty(g,C,Object.getOwnPropertyDescriptor(I,C))})),g}const defaultOptions$8={wrapperClass:"item-slots",wrapperStyles:{},slotClass:"item-slots-slot",slotHoverClass:"item-slots-slot-hover",slotFocusClass:"item-slots-slot-focus",slotSubscriptClass:"item-slots-slot-subscript",slotMargin:2,slotPadding:2,slotWidth:50,slotHeight:50,slotStyles:{},slotSubscriptStyles:{},horizontalCount:5,verticalCount:1,focusFirstByDefault:!0,activatedByDefault:!0,zoom:1,perspective:"pxyz",scrollable:!0};class ItemSlot{constructor(g,I){_defineProperty$k(this,"row",void 0),_defineProperty$k(this,"col",void 0),_defineProperty$k(this,"scene",void 0),_defineProperty$k(this,"object",void 0),_defineProperty$k(this,"light",void 0),_defineProperty$k(this,"camera",new three__WEBPACK_IMPORTED_MODULE_0__.iKG(-1,1,1,-1,0,10)),_defineProperty$k(this,"element",void 0),_defineProperty$k(this,"subscriptElement",void 0),_defineProperty$k(this,"subscript",void 0),_defineProperty$k(this,"content",void 0),_defineProperty$k(this,"zoom",1),_defineProperty$k(this,"lightRotationOffset",-Math.PI/8),_defineProperty$k(this,"offset",new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),_defineProperty$k(this,"getObject",(()=>this.object)),_defineProperty$k(this,"setObject",(g=>{this.object&&this.scene.remove(this.object),this.object=g,this.scene.add(g)})),_defineProperty$k(this,"getContent",(()=>this.content)),_defineProperty$k(this,"setContent",(g=>{this.content=g})),_defineProperty$k(this,"getSubscript",(()=>this.subscript)),_defineProperty$k(this,"setSubscript",(g=>{this.subscript=g,this.subscriptElement.innerText=g})),_defineProperty$k(this,"setZoom",(g=>{this.zoom=g,this.camera.far=3*g+1,this.updateCamera()})),_defineProperty$k(this,"setPerspective",(g=>{const I=g.startsWith("n")?-1:1,C=g.includes("x")?1:0,A=g.includes("y")?1:0,t=g.includes("z")?1:0;this.offset.set(C,A,t).multiplyScalar(I),this.updateCamera()})),_defineProperty$k(this,"applyClass",(g=>{this.element.classList.add(g)})),_defineProperty$k(this,"removeClass",(g=>{this.element.classList.remove(g)})),_defineProperty$k(this,"applySubscriptClass",(g=>{this.subscriptElement.classList.add(g)})),_defineProperty$k(this,"removeSubscriptClass",(g=>{this.subscriptElement.classList.remove(g)})),_defineProperty$k(this,"applyStyles",(g=>{DOMUtils.applyStyles(this.element,g)})),_defineProperty$k(this,"applySubscriptStyles",(g=>{DOMUtils.applyStyles(this.subscriptElement,g)})),_defineProperty$k(this,"updateCamera",(()=>{this.camera.position.copy(this.offset.clone().multiplyScalar(3.5*(this.zoom||1))),this.camera.lookAt(0,0,0);const g=this.camera.position.clone();g.applyAxisAngle(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,1,0),this.lightRotationOffset),this.light.position.copy(g)})),this.row=g,this.col=I,this.scene=new three__WEBPACK_IMPORTED_MODULE_0__.xsS,this.camera=new three__WEBPACK_IMPORTED_MODULE_0__.iKG(-1,1,1,-1,0,10),this.element=document.createElement("div"),this.subscriptElement=document.createElement("div"),this.element.appendChild(this.subscriptElement),this.offset=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,this.light=new three__WEBPACK_IMPORTED_MODULE_0__.Ox3(16777215,3),this.scene.add(this.light),this.updateCamera()}}class ItemSlots{get element(){return this.wrapper}constructor(g){var I=this;void 0===g&&(g={}),_defineProperty$k(this,"options",void 0),_defineProperty$k(this,"wrapper",void 0),_defineProperty$k(this,"canvas",void 0),_defineProperty$k(this,"renderer",void 0),_defineProperty$k(this,"focusedRow",-1),_defineProperty$k(this,"focusedCol",-1),_defineProperty$k(this,"activated",!1),_defineProperty$k(this,"slotTotalWidth",void 0),_defineProperty$k(this,"slotTotalHeight",void 0),_defineProperty$k(this,"onSlotClick",noop$1),_defineProperty$k(this,"onSlotUpdate",noop$1),_defineProperty$k(this,"onFocusChange",noop$1),_defineProperty$k(this,"slots",void 0),_defineProperty$k(this,"animationFrame",-1),_defineProperty$k(this,"activate",(()=>{this.activated||(this.activated=!0,DOMUtils.applyStyles(this.wrapper,{display:"flex"}),this.render())})),_defineProperty$k(this,"deactivate",(()=>{this.activated&&(this.activated=!1,DOMUtils.applyStyles(this.wrapper,{display:"none"}),cancelAnimationFrame(this.animationFrame))})),_defineProperty$k(this,"setObject",((g,I,C)=>{var A;if(!this.slots[g]||!this.slots[g][I])return;const t=this.slots[g][I];t.setObject(C),null===(A=this.onSlotUpdate)||void 0===A||A.call(this,t)})),_defineProperty$k(this,"setContent",((g,I,C)=>{var A;if(!this.slots[g]||!this.slots[g][I])return;const t=this.slots[g][I];t.setContent(C),null===(A=this.onSlotUpdate)||void 0===A||A.call(this,t)})),_defineProperty$k(this,"setSubscript",((g,I,C)=>{var A;if(!this.slots[g]||!this.slots[g][I])return;const t=this.slots[g][I];t.setSubscript(C),null===(A=this.onSlotUpdate)||void 0===A||A.call(this,t)})),_defineProperty$k(this,"setFocused",((g,I)=>{if(g===this.focusedRow&&I===this.focusedCol)return;const C=-1!==this.focusedRow&&-1!==this.focusedCol&&(this.focusedRow!==g||this.focusedCol!==I);if(C){this.slots[this.focusedRow][this.focusedCol].element.classList.remove(this.options.slotFocusClass)}this.focusedRow=g,this.focusedCol=I;const A=this.slots[this.focusedRow][this.focusedCol];this.onFocusChange(C?this.slots[this.focusedRow][this.focusedCol]:null,A),A.element.classList.add(this.options.slotFocusClass),this.onSlotClick(A)})),_defineProperty$k(this,"getObject",((g,I)=>this.slots[g]&&this.slots[g][I]?this.slots[g][I].object:null)),_defineProperty$k(this,"getContent",((g,I)=>this.slots[g]&&this.slots[g][I]?this.slots[g][I].content:null)),_defineProperty$k(this,"getSubscript",((g,I)=>this.slots[g]&&this.slots[g][I]?this.slots[g][I].subscript:null)),_defineProperty$k(this,"getFocused",(()=>-1===this.focusedRow||-1===this.focusedCol?null:this.slots[this.focusedRow][this.focusedCol])),_defineProperty$k(this,"getRowColFromEvent",(g=>{const I=this.canvas.getBoundingClientRect(),C=g.clientX-I.left,A=(g.clientY-I.top)/this.slotTotalHeight,t=C/this.slotTotalWidth,{slotMargin:e,slotWidth:o,slotHeight:i}=this.options,{verticalCount:l,horizontalCount:c}=this.options;return A<0||A>=l||t<0||t>=c||A%1<e/i||A%1>1-e/i||t%1<e/o||t%1>1-e/o?{row:-1,col:-1}:{row:Math.floor(A),col:Math.floor(t)}})),_defineProperty$k(this,"getSlot",((g,I)=>g<0||g>=this.options.verticalCount||I<0||I>=this.options.horizontalCount?null:this.slots[g][I])),_defineProperty$k(this,"connect",(function(g,C){void 0===C&&(C="*");const{slotHoverClass:A,scrollable:t}=I.options;let e=null,o=null;I.canvas.onmouseenter=()=>{I.activated&&(I.canvas.onmousemove=g=>{const{row:C,col:t}=I.getRowColFromEvent(g);-1!==C&&-1!==t?(null===e||null===o||C===e&&t===o||I.slots[e][o].element.classList.remove(A),I.slots[C][t].element.classList.add(A),DOMUtils.applyStyles(I.canvas,{cursor:"pointer"}),e=C,o=t):null!==e&&null!==o&&(I.slots[e][o].element.classList.remove(A),DOMUtils.applyStyles(I.canvas,{cursor:"default"}))})},I.canvas.onmouseleave=()=>{I.activated&&(null!==e&&null!==o&&(I.slots[e][o].element.classList.remove(A),DOMUtils.applyStyles(I.canvas,{cursor:"default"})),I.canvas.onmousemove=null)},I.canvas.onmousedown=g=>{if(!I.activated)return;const{row:C,col:A}=I.getRowColFromEvent(g);-1!==C&&-1!==A&&I.setFocused(C,A)};const i=t?g.scroll((()=>{if(!I.activated)return;if(-1===I.focusedRow||-1===I.focusedCol)return;const{horizontalCount:g,verticalCount:C}=I.options,A=I.focusedRow,t=I.focusedCol;0===t?I.setFocused(0===A?C-1:A-1,g-1):I.setFocused(A,t-1)}),(()=>{if(!I.activated)return;if(-1===I.focusedRow||-1===I.focusedCol)return;const{horizontalCount:g,verticalCount:C}=I.options,A=I.focusedRow,t=I.focusedCol;t===g-1?I.setFocused(A===C-1?0:A+1,0):I.setFocused(A,t+1)}),C):noop$1;return()=>{try{i(),I.canvas.onmousedown=null,I.canvas.onmouseenter=null,I.canvas.onmouseleave=null}catch(g){}}})),_defineProperty$k(this,"render",(()=>{if(this.animationFrame=requestAnimationFrame(this.render),!this.activated)return;const{horizontalCount:g,verticalCount:I,slotMargin:C,slotPadding:A}=this.options,t=this.canvas.clientWidth,e=this.canvas.clientHeight;this.canvas.width===t&&this.canvas.height===e||this.renderer.setSize(t,e,!1),this.renderer.setScissorTest(!1),this.renderer.clear(),this.renderer.setScissorTest(!0);const o=this.renderer.domElement.getBoundingClientRect();let i=!1;for(let l=0;l<I;l++)for(let I=0;I<g;I++){const{scene:g,camera:t,element:e,object:c}=this.slots[l][I];if(!c)continue;const n=e.getBoundingClientRect();if(n.top+n.height<o.top||n.top>o.top+o.height||n.left+n.width<o.left||n.left>o.left+o.width)continue;i=!0;const d=n.right-n.left-2*C-2*A,s=n.bottom-n.top-2*C-2*A;if(d<=0||s<=0)continue;const Z=n.left-o.left+C+A,b=o.height-(n.bottom-o.top)+C+A;this.renderer.setViewport(Z,b,d,s),this.renderer.setScissor(Z,b,d,s),this.renderer.render(g,t)}i||(this.renderer.setViewport(0,0,t,e),this.renderer.setScissor(0,0,t,e),this.renderer.render(this.slots[0][0].scene,this.slots[0][0].camera))})),_defineProperty$k(this,"generate",(()=>{const{wrapperClass:g,wrapperStyles:I,slotClass:C,slotStyles:A,slotSubscriptClass:t,slotSubscriptStyles:e,horizontalCount:o,verticalCount:i,zoom:l,perspective:c}=this.options,{slotWidth:n,slotHeight:d,slotMargin:s,slotPadding:Z}=this.options,b=(n+2*s+2*Z)*o,a=(d+2*s+2*Z)*i;this.wrapper=document.createElement("div"),this.wrapper.classList.add(g),DOMUtils.applyStyles(this.wrapper,_objectSpreadProps$1(_objectSpread$8({},I),{width:`${b}px`,height:`${a}px`,display:"none"})),this.slots=[];for(let m=0;m<i;m++){this.slots[m]=[];for(let g=0;g<o;g++){const I=new ItemSlot(m,g);I.applyClass(C),I.applyStyles(_objectSpread$8({width:`${n}px`,height:`${d}px`,borderRadius:.1*n+"px",borderWidth:.08*n+"px",boxShadow:`inset 0 0 ${.05*n}px var(--item-slots-slot-color)`},A)),I.applySubscriptClass(t),I.applySubscriptStyles(e),I.applyStyles({position:"absolute",top:`${(d+2*s+2*Z)*m+s}px`,left:`${(n+2*s+2*Z)*g+s}px`}),I.setZoom(l),I.setPerspective(c),this.slots[m][g]=I,this.wrapper.appendChild(I.element)}}this.canvas=document.createElement("canvas"),this.canvas.width=b,this.canvas.height=a,DOMUtils.applyStyles(this.canvas,{position:"absolute",background:"transparent",top:"0",left:"0",zIndex:"-1"}),this.wrapper.appendChild(this.canvas),this.renderer=new three__WEBPACK_IMPORTED_MODULE_0__.CP7({canvas:this.canvas,antialias:!1,alpha:!0}),this.renderer.outputColorSpace=three__WEBPACK_IMPORTED_MODULE_0__.KI_,this.renderer.setSize(b,a)}));const{focusFirstByDefault:C,activatedByDefault:A,slotHeight:t,slotMargin:e,slotWidth:o,slotPadding:i}=this.options=cjs(defaultOptions$8,g);this.slotTotalWidth=o+2*e+2*i,this.slotTotalHeight=t+2*e+2*i,this.generate(),C&&this.setFocused(0,0),A&&this.activate()}}function _defineProperty$j(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$7(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$j(g,I,C[I])}))}return g}const defaultOptions$7={maxDistance:5,blockMargin:.3,lerpFactor:.5,ignoreSeeThrough:!0,ignoreFluids:!0};class Perspective{set state(g){const{camera:I}=this.controls;var C;("first"===g?I.position.copy(this.firstPersonPosition):I.position.set(0,0,0),I.quaternion.set(0,0,0,0),g!==this._state)&&(null===(C=this.onChangeState)||void 0===C||C.call(this,g),this._state=g)}get state(){return this._state}constructor(g,I,C){var A=this;if(void 0===C&&(C={}),_defineProperty$j(this,"options",void 0),_defineProperty$j(this,"controls",void 0),_defineProperty$j(this,"world",void 0),_defineProperty$j(this,"inputs",void 0),_defineProperty$j(this,"_state","first"),_defineProperty$j(this,"firstPersonPosition",new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),_defineProperty$j(this,"onChangeState",void 0),_defineProperty$j(this,"connect",(function(g,I){void 0===I&&(I="*");const C=g.bind("c",A.toggle,I,{identifier:Perspective.INPUT_IDENTIFIER});return A.inputs=g,()=>{try{C()}catch(g){}}})),_defineProperty$j(this,"toggle",(()=>{switch(this.state){case"first":this.state="third";break;case"second":this.state="first";break;case"third":this.state="second"}})),_defineProperty$j(this,"update",(()=>{const{object:g,camera:I}=this.controls;this.controls.character&&("first"===this.state&&this.controls.character.visible?this.controls.character.visible=!1:"first"===this.state||this.controls.character.visible||(this.controls.character.visible=!0));const C=()=>{const C=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4;("second"===this.state?g:I).getWorldDirection(C),C.normalize(),C.multiplyScalar(-1);const A=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4;g.getWorldPosition(A),A.add(C.clone().multiplyScalar(this.options.blockMargin));const t=this.world.raycastVoxels(A.toArray(),C.toArray(),this.options.maxDistance,{ignoreFluids:this.options.ignoreFluids,ignoreSeeThrough:this.options.ignoreSeeThrough});return t?A.distanceTo(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(...t.point)):this.options.maxDistance};switch(this.state){case"first":break;case"second":{const A=I.position.clone();A.z=-C(),I.position.lerp(A,this.options.lerpFactor),I.lookAt(g.position);break}case"third":{const g=I.position.clone();g.z=C(),I.position.lerp(g,this.options.lerpFactor);break}}})),!g)throw new Error("Perspective: invalid rigid controls.");if(!I)throw new Error("Perspective: invalid world.");this.controls=g,this.world=I,this.options=_objectSpread$7({},defaultOptions$7,C),this.firstPersonPosition.copy(this.controls.camera.position),this.state="first"}}function _defineProperty$i(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$6(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$i(g,I,C[I])}))}return g}_defineProperty$j(Perspective,"INPUT_IDENTIFIER","voxelize-perspective");const defaultOptions$6={zoom:1,perspective:"pxyz",width:100,height:100,renderOnce:!1,lightRotationOffset:-Math.PI/8};class Portrait{constructor(g,I){if(void 0===I&&(I={}),_defineProperty$i(this,"options",void 0),_defineProperty$i(this,"camera",void 0),_defineProperty$i(this,"scene",void 0),_defineProperty$i(this,"canvas",void 0),_defineProperty$i(this,"object",void 0),_defineProperty$i(this,"animationFrameId",-1),_defineProperty$i(this,"setObject",(g=>{this.object&&this.scene.remove(this.object),this.scene.add(g),this.object=g})),_defineProperty$i(this,"dispose",(()=>{cancelAnimationFrame(this.animationFrameId),this.scene.remove(this.object),this.object=null})),_defineProperty$i(this,"render",(()=>{this.animationFrameId=requestAnimationFrame(this.render);const g=Portrait.renderer,{renderOnce:I}=this.options,{width:C,height:A}=g.getSize(new three__WEBPACK_IMPORTED_MODULE_0__.FM8(0,0));C===this.canvas.width&&A===this.canvas.height||g.setSize(this.canvas.width,this.canvas.height),g.render(this.scene,this.camera);const t=g.domElement,e=this.canvas.getContext("2d");e.globalCompositeOperation="copy",e.drawImage(t,0,t.height-A,C,A,0,0,C,A),I&&this.dispose()})),!g)throw new Error("A target object is required for portraits.");Portrait.renderer.outputColorSpace=three__WEBPACK_IMPORTED_MODULE_0__.KI_;const{width:C,height:A,zoom:t,perspective:e,lightRotationOffset:o}=this.options=_objectSpread$6({},defaultOptions$6,I);this.canvas=document.createElement("canvas"),this.canvas.width=C,this.canvas.height=A,this.scene=new three__WEBPACK_IMPORTED_MODULE_0__.xsS;const i=e.includes("n")?-1:1,l=e.includes("x")?1:0,c=e.includes("y")?1:0,n=e.includes("z")?1:0;this.camera=new three__WEBPACK_IMPORTED_MODULE_0__.iKG(-t,t,t,-t),this.camera.far=10*t+1,this.camera.near=.1,this.camera.position.set(i*l*t*3.5,i*c*t*3.5,i*n*t*3.5),this.camera.lookAt(0,0,0);const d=this.camera.position.clone();d.applyAxisAngle(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,1,0),o);const s=new three__WEBPACK_IMPORTED_MODULE_0__.Ox3(16777215,3);s.position.copy(d),this.scene.add(s),this.setObject(g),this.render()}}function _defineProperty$h(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}_defineProperty$i(Portrait,"renderer",new three__WEBPACK_IMPORTED_MODULE_0__.CP7({antialias:!1}));const defaultOptions$5={maxWorker:8};class SharedWorkerPool{get isBusy(){return this.available.length<=0}get workingCount(){return this.workers.length-this.available.length}constructor(g,I){void 0===I&&(I=defaultOptions$5),_defineProperty$h(this,"Proto",void 0),_defineProperty$h(this,"options",void 0),_defineProperty$h(this,"queue",void 0),_defineProperty$h(this,"workers",void 0),_defineProperty$h(this,"available",void 0),_defineProperty$h(this,"addJob",void 0),_defineProperty$h(this,"process",void 0),this.Proto=g,this.options=I,this.queue=[],this.workers=[],this.available=[],this.addJob=g=>{this.queue.push(g),this.process()},this.process=()=>{if(0!==this.queue.length&&this.available.length>0){const g=this.available.shift(),I=this.workers[g],{message:C,buffers:A,resolve:t}=this.queue.shift();I.port.postMessage(C,A||[]),SharedWorkerPool.WORKING_COUNT++;const e=C=>{let{data:A}=C;SharedWorkerPool.WORKING_COUNT--,I.port.removeEventListener("message",e),this.available.push(g),t(A),0!==this.queue.length&&this.available.length>0&&setTimeout(this.process,0)};I.port.addEventListener("message",e)}};const{maxWorker:C}=I;for(let A=0;A<C;A++){const I=new g;I.port.start(),this.workers.push(I),this.available.push(A)}}}function _defineProperty$g(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$5(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$g(g,I,C[I])}))}return g}_defineProperty$h(SharedWorkerPool,"WORKING_COUNT",0);const defaultOptions$4={reachDistance:32,ignoreFluids:!0,highlightType:"box",highlightScale:1.002,highlightLerp:1,inverseDirection:!1,highlightColor:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("white"),highlightOpacity:.1,potentialVisuals:!1};class VoxelInteract extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{get lookingAt(){return this.target?this.world.getBlockAt(this.target[0],this.target[1],this.target[2]):null}constructor(g,I,C){var A;if(void 0===C&&(C={}),super(),A=this,_defineProperty$g(this,"object",void 0),_defineProperty$g(this,"world",void 0),_defineProperty$g(this,"options",void 0),_defineProperty$g(this,"active",void 0),_defineProperty$g(this,"potential",void 0),_defineProperty$g(this,"target",void 0),_defineProperty$g(this,"newTargetScale",void 0),_defineProperty$g(this,"newTargetPosition",void 0),_defineProperty$g(this,"targetGroup",void 0),_defineProperty$g(this,"potentialGroup",void 0),_defineProperty$g(this,"potentialArrow",void 0),_defineProperty$g(this,"yRotArrow",void 0),_defineProperty$g(this,"toggle",void 0),_defineProperty$g(this,"update",void 0),_defineProperty$g(this,"setup",void 0),this.object=g,this.world=I,this.active=!0,this.potential={voxel:[0,0,0],rotation:PY_ROTATION,yRotation:0},this.target=[0,0,0],this.newTargetScale=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,this.newTargetPosition=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,this.targetGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.potentialGroup=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu,this.toggle=function(g){void 0===g&&(g=null),A.active=null===g?!A.active:g,A.potential=null,A.target=null,A.visible=A.active},this.update=()=>{if(!this.active)return;const{reachDistance:g,highlightScale:I}=this.options;this.targetGroup.scale.lerp(this.newTargetScale,this.options.highlightLerp),this.targetGroup.position.lerp(this.newTargetPosition,this.options.highlightLerp);const C=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,A=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4;this.object.getWorldPosition(C),this.object.getWorldDirection(A),A.normalize(),this.options.inverseDirection&&A.multiplyScalar(-1);const t=this.world.raycastVoxels(C.toArray(),A.toArray(),g,{ignoreFluids:this.options.ignoreFluids});if(!t)return this.visible=!1,this.target=null,void(this.potential=null);const{voxel:e,normal:o}=t,[i,l,c]=o,n=ChunkUtils.mapWorldToVoxel(e);if(0===this.world.getVoxelAt(...n))return this.visible=!1,this.target=null,void(this.potential=null);this.visible=!0,this.target=n;const{lookingAt:d}=this;if(d&&this.target){const{isDynamic:g,dynamicFn:C}=d,A=g?C(e).aabbs:d.aabbs;if(!A.length)return;const t=this.world.getVoxelRotationAt(...this.target);let o=t.rotateAABB(A[0]);for(let I=1;I<A.length;I++){const g=t.rotateAABB(A[I]);o=o.union(g)}o.translate(this.target);let{width:i,height:l,depth:c}=o;i*=I,l*=I,c*=I,this.newTargetScale.set(i,l,c),this.newTargetPosition.set(o.minX,o.minY,o.minZ)}const s=[this.target[0]+i,this.target[1]+l,this.target[2]+c],Z=0!==i?i>0?PX_ROTATION:NX_ROTATION:0!==l?l>0?PY_ROTATION:NY_ROTATION:0!==c?c>0?PZ_ROTATION:NZ_ROTATION:0,b=(()=>{if(0!==Math.abs(l)){this.yRotArrow.visible=!0;const[g,I,A]=[C.x,C.y,C.z],[t,e,o]=[s[0]+.5,s[1]+.5,s[2]+.5];let i=l>0?Math.atan2(g-t,A-o):Math.atan2(A-o,g-t);l<0&&(i+=Math.PI/2);const c=MathUtils.normalizeAngle(i);let n,d,Z=1/0;Y_ROT_MAP.forEach((g=>{let[I,C]=g;Math.abs(c-I)<Z&&(Z=Math.abs(c-I),n=C,d=I)}));const b=l<0?Math.cos(d-Math.PI/2):Math.sin(d),a=l<0?Math.sin(d-Math.PI/2):Math.cos(d);return this.yRotArrow.setDirection(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(b,0,a).normalize()),n}return this.yRotArrow.visible=!1,0})();this.potential={voxel:s,rotation:Z,yRotation:b},this.potential&&(this.potentialGroup.position.set(this.potential.voxel[0]+.5,this.potential.voxel[1]+.5,this.potential.voxel[2]+.5),this.potentialArrow.setDirection(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(i,l,c)))},this.setup=()=>{const{highlightType:g,highlightScale:I,highlightColor:C,highlightOpacity:A}=this.options,t=new three__WEBPACK_IMPORTED_MODULE_0__.vBJ({color:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(C),opacity:A,transparent:!0});if("outline"===g){const g=.01,C=I,A=new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(new three__WEBPACK_IMPORTED_MODULE_0__.DvJ(C,g,g),t);for(let I=-1;I<=1;I+=2)for(let t=-1;t<=1;t+=2){const e=A.clone();e.position.y=(C-g)/2*I,e.position.z=(C-g)/2*t,this.targetGroup.add(e)}for(let I=-1;I<=1;I+=2)for(let t=-1;t<=1;t+=2){const e=A.clone();e.position.z=(C-g)/2*I,e.position.x=(C-g)/2*t,e.rotation.z=Math.PI/2,this.targetGroup.add(e)}for(let I=-1;I<=1;I+=2)for(let t=-1;t<=1;t+=2){const e=A.clone();e.position.x=(C-g)/2*I,e.position.y=(C-g)/2*t,e.rotation.y=Math.PI/2,this.targetGroup.add(e)}const e=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(.5,.5,.5);this.targetGroup.children.forEach((g=>{g.position.add(e)}))}else{if("box"!==g)throw new Error("Invalid highlight type");{const g=new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(new three__WEBPACK_IMPORTED_MODULE_0__.DvJ(I,I,I),t);g.position.x+=.5,g.position.y+=.5,g.position.z+=.5,this.targetGroup.add(g)}}this.potentialArrow=new Arrow({color:"red"}),this.yRotArrow=new Arrow({color:"green"}),this.potentialGroup.add(this.potentialArrow,this.yRotArrow),this.targetGroup.frustumCulled=!1,this.targetGroup.renderOrder=1e6},!g)throw new Error("VoxelInteract: object is required.");if(!I)throw new Error("VoxelInteract: a world is required to be operated on");const{potentialVisuals:t}=this.options=_objectSpread$5({},defaultOptions$4,C);this.setup(),this.add(this.targetGroup,this.potentialGroup),this.potentialGroup.visible=t}}function _defineProperty$f(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$4(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$f(g,I,C[I])}))}return g}const emptyQ$1=new three__WEBPACK_IMPORTED_MODULE_0__._fP,emptyP=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4,defaultOptions$3={countSelf:!1,updateChildren:!0};class Peers extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{setOwnPeer(g){this.ownPeer=g,this.add(g)}setOwnUsername(g){this.ownUsername=g}packInfo(){const{x:g,y:I,z:C}=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,0,-1).applyQuaternion(this.object.getWorldQuaternion(emptyQ$1)).normalize(),{x:A,y:t,z:e}=this.object.getWorldPosition(emptyP);return{id:this.ownID,username:this.ownUsername,metadata:{position:[A,t,e],direction:[g,I,C]}}}update(){if(!this.object)return;const g=this.packInfo();if(this.ownPeer&&g&&this.onPeerUpdate(this.ownPeer,g.metadata,{id:g.id,username:g.username}),g){const I={type:"PEER",peers:[g]};this.packets.push(I)}this.options.updateChildren&&this.children.forEach((g=>{g!==this.ownPeer&&g instanceof Character&&g.update()}))}constructor(g,I){void 0===I&&(I={}),super(),_defineProperty$f(this,"object",void 0),_defineProperty$f(this,"options",void 0),_defineProperty$f(this,"ownID",void 0),_defineProperty$f(this,"ownUsername",void 0),_defineProperty$f(this,"ownPeer",void 0),_defineProperty$f(this,"packets",void 0),_defineProperty$f(this,"createPeer",void 0),_defineProperty$f(this,"onPeerJoin",void 0),_defineProperty$f(this,"onPeerUpdate",void 0),_defineProperty$f(this,"onPeerLeave",void 0),_defineProperty$f(this,"onMessage",void 0),_defineProperty$f(this,"getPeerById",void 0),this.object=g,this.ownID="",this.ownUsername="",this.packets=[],this.onMessage=(g,I)=>{let{username:C}=I;this.ownUsername=C;const A=g=>{const I=this.createPeer(g);return I.name=g,this.add(I),I};switch(g.type){case"INIT":{const{id:I}=g.json;this.ownID=I;break}case"JOIN":{var t;const{text:I}=g;if(!(this.options.countSelf||this.ownID&&this.ownID!==I))return;if(!this.createPeer)return void console.warn("Peers.createPeer is not defined, skipping peer join.");if(this.getObjectByName(I))break;A(I),null===(t=this.onPeerJoin)||void 0===t||t.call(this,I);break}case"LEAVE":{var e;const{text:I}=g,C=this.getObjectByName(I);C&&this.remove(C),null===(e=this.onPeerLeave)||void 0===e||e.call(this,I);break}}const{peers:o}=g;o&&o.forEach((I=>{var C;if(!(this.options.countSelf||this.ownID&&I.id!==this.ownID))return;"INIT"===g.type&&(null===(C=this.onPeerJoin)||void 0===C||C.call(this,I.id));let t=this.getObjectByName(I.id);t||(t=A(I.id)),this.onPeerUpdate?this.onPeerUpdate(t,I.metadata,{id:I.id,username:I.username}):console.warn("Peers.onPeerUpdate is not defined, skipping peer update.")}))},this.getPeerById=g=>this.getObjectByName(g),this.options=_objectSpread$4({},defaultOptions$3,I)}}var indexMinimal={},minimal$1={},aspromise=asPromise;function asPromise(g,I){for(var C=new Array(arguments.length-1),A=0,t=2,e=!0;t<arguments.length;)C[A++]=arguments[t++];return new Promise((function(t,o){C[A]=function(g){if(e)if(e=!1,g)o(g);else{for(var I=new Array(arguments.length-1),C=0;C<I.length;)I[C++]=arguments[C];t.apply(null,I)}};try{g.apply(I||null,C)}catch(i){e&&(e=!1,o(i))}}))}var base64$1={};!function(g){var I=g;I.length=function(g){var I=g.length;if(!I)return 0;for(var C=0;--I%4>1&&"="===g.charAt(I);)++C;return Math.ceil(3*g.length)/4-C};for(var C=new Array(64),A=new Array(123),t=0;t<64;)A[C[t]=t<26?t+65:t<52?t+71:t<62?t-4:t-59|43]=t++;I.encode=function(g,I,A){for(var t,e=null,o=[],i=0,l=0;I<A;){var c=g[I++];switch(l){case 0:o[i++]=C[c>>2],t=(3&c)<<4,l=1;break;case 1:o[i++]=C[t|c>>4],t=(15&c)<<2,l=2;break;case 2:o[i++]=C[t|c>>6],o[i++]=C[63&c],l=0}i>8191&&((e||(e=[])).push(String.fromCharCode.apply(String,o)),i=0)}return l&&(o[i++]=C[t],o[i++]=61,1===l&&(o[i++]=61)),e?(i&&e.push(String.fromCharCode.apply(String,o.slice(0,i))),e.join("")):String.fromCharCode.apply(String,o.slice(0,i))};var e="invalid encoding";I.decode=function(g,I,C){for(var t,o=C,i=0,l=0;l<g.length;){var c=g.charCodeAt(l++);if(61===c&&i>1)break;if(void 0===(c=A[c]))throw Error(e);switch(i){case 0:t=c,i=1;break;case 1:I[C++]=t<<2|(48&c)>>4,t=c,i=2;break;case 2:I[C++]=(15&t)<<4|(60&c)>>2,t=c,i=3;break;case 3:I[C++]=(3&t)<<6|c,i=0}}if(1===i)throw Error(e);return C-o},I.test=function(g){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(g)}}(base64$1);var eventemitter=EventEmitter$1;function EventEmitter$1(){this._listeners={}}EventEmitter$1.prototype.on=function(g,I,C){return(this._listeners[g]||(this._listeners[g]=[])).push({fn:I,ctx:C||this}),this},EventEmitter$1.prototype.off=function(g,I){if(void 0===g)this._listeners={};else if(void 0===I)this._listeners[g]=[];else for(var C=this._listeners[g],A=0;A<C.length;)C[A].fn===I?C.splice(A,1):++A;return this},EventEmitter$1.prototype.emit=function(g){var I=this._listeners[g];if(I){for(var C=[],A=1;A<arguments.length;)C.push(arguments[A++]);for(A=0;A<I.length;)I[A].fn.apply(I[A++].ctx,C)}return this};var float=factory(factory);function factory(g){return"undefined"!=typeof Float32Array?function(){var I=new Float32Array([-0]),C=new Uint8Array(I.buffer),A=128===C[3];function t(g,A,t){I[0]=g,A[t]=C[0],A[t+1]=C[1],A[t+2]=C[2],A[t+3]=C[3]}function e(g,A,t){I[0]=g,A[t]=C[3],A[t+1]=C[2],A[t+2]=C[1],A[t+3]=C[0]}function o(g,A){return C[0]=g[A],C[1]=g[A+1],C[2]=g[A+2],C[3]=g[A+3],I[0]}function i(g,A){return C[3]=g[A],C[2]=g[A+1],C[1]=g[A+2],C[0]=g[A+3],I[0]}g.writeFloatLE=A?t:e,g.writeFloatBE=A?e:t,g.readFloatLE=A?o:i,g.readFloatBE=A?i:o}():function(){function I(g,I,C,A){var t=I<0?1:0;if(t&&(I=-I),0===I)g(1/I>0?0:2147483648,C,A);else if(isNaN(I))g(2143289344,C,A);else if(I>34028234663852886e22)g((t<<31|2139095040)>>>0,C,A);else if(I<11754943508222875e-54)g((t<<31|Math.round(I/1401298464324817e-60))>>>0,C,A);else{var e=Math.floor(Math.log(I)/Math.LN2);g((t<<31|e+127<<23|8388607&Math.round(I*Math.pow(2,-e)*8388608))>>>0,C,A)}}function C(g,I,C){var A=g(I,C),t=2*(A>>31)+1,e=A>>>23&255,o=8388607&A;return 255===e?o?NaN:t*(1/0):0===e?1401298464324817e-60*t*o:t*Math.pow(2,e-150)*(o+8388608)}g.writeFloatLE=I.bind(null,writeUintLE),g.writeFloatBE=I.bind(null,writeUintBE),g.readFloatLE=C.bind(null,readUintLE),g.readFloatBE=C.bind(null,readUintBE)}(),"undefined"!=typeof Float64Array?function(){var I=new Float64Array([-0]),C=new Uint8Array(I.buffer),A=128===C[7];function t(g,A,t){I[0]=g,A[t]=C[0],A[t+1]=C[1],A[t+2]=C[2],A[t+3]=C[3],A[t+4]=C[4],A[t+5]=C[5],A[t+6]=C[6],A[t+7]=C[7]}function e(g,A,t){I[0]=g,A[t]=C[7],A[t+1]=C[6],A[t+2]=C[5],A[t+3]=C[4],A[t+4]=C[3],A[t+5]=C[2],A[t+6]=C[1],A[t+7]=C[0]}function o(g,A){return C[0]=g[A],C[1]=g[A+1],C[2]=g[A+2],C[3]=g[A+3],C[4]=g[A+4],C[5]=g[A+5],C[6]=g[A+6],C[7]=g[A+7],I[0]}function i(g,A){return C[7]=g[A],C[6]=g[A+1],C[5]=g[A+2],C[4]=g[A+3],C[3]=g[A+4],C[2]=g[A+5],C[1]=g[A+6],C[0]=g[A+7],I[0]}g.writeDoubleLE=A?t:e,g.writeDoubleBE=A?e:t,g.readDoubleLE=A?o:i,g.readDoubleBE=A?i:o}():function(){function I(g,I,C,A,t,e){var o=A<0?1:0;if(o&&(A=-A),0===A)g(0,t,e+I),g(1/A>0?0:2147483648,t,e+C);else if(isNaN(A))g(0,t,e+I),g(2146959360,t,e+C);else if(A>17976931348623157e292)g(0,t,e+I),g((o<<31|2146435072)>>>0,t,e+C);else{var i;if(A<22250738585072014e-324)g((i=A/5e-324)>>>0,t,e+I),g((o<<31|i/4294967296)>>>0,t,e+C);else{var l=Math.floor(Math.log(A)/Math.LN2);1024===l&&(l=1023),g(4503599627370496*(i=A*Math.pow(2,-l))>>>0,t,e+I),g((o<<31|l+1023<<20|1048576*i&1048575)>>>0,t,e+C)}}}function C(g,I,C,A,t){var e=g(A,t+I),o=g(A,t+C),i=2*(o>>31)+1,l=o>>>20&2047,c=4294967296*(1048575&o)+e;return 2047===l?c?NaN:i*(1/0):0===l?5e-324*i*c:i*Math.pow(2,l-1075)*(c+4503599627370496)}g.writeDoubleLE=I.bind(null,writeUintLE,0,4),g.writeDoubleBE=I.bind(null,writeUintBE,4,0),g.readDoubleLE=C.bind(null,readUintLE,0,4),g.readDoubleBE=C.bind(null,readUintBE,4,0)}(),g}function writeUintLE(g,I,C){I[C]=255&g,I[C+1]=g>>>8&255,I[C+2]=g>>>16&255,I[C+3]=g>>>24}function writeUintBE(g,I,C){I[C]=g>>>24,I[C+1]=g>>>16&255,I[C+2]=g>>>8&255,I[C+3]=255&g}function readUintLE(g,I){return(g[I]|g[I+1]<<8|g[I+2]<<16|g[I+3]<<24)>>>0}function readUintBE(g,I){return(g[I]<<24|g[I+1]<<16|g[I+2]<<8|g[I+3])>>>0}var inquire_1=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}var utf8$2={};!function(g){var I=g;I.length=function(g){for(var I=0,C=0,A=0;A<g.length;++A)(C=g.charCodeAt(A))<128?I+=1:C<2048?I+=2:55296==(64512&C)&&56320==(64512&g.charCodeAt(A+1))?(++A,I+=4):I+=3;return I},I.read=function(g,I,C){if(C-I<1)return"";for(var A,t=null,e=[],o=0;I<C;)(A=g[I++])<128?e[o++]=A:A>191&&A<224?e[o++]=(31&A)<<6|63&g[I++]:A>239&&A<365?(A=((7&A)<<18|(63&g[I++])<<12|(63&g[I++])<<6|63&g[I++])-65536,e[o++]=55296+(A>>10),e[o++]=56320+(1023&A)):e[o++]=(15&A)<<12|(63&g[I++])<<6|63&g[I++],o>8191&&((t||(t=[])).push(String.fromCharCode.apply(String,e)),o=0);return t?(o&&t.push(String.fromCharCode.apply(String,e.slice(0,o))),t.join("")):String.fromCharCode.apply(String,e.slice(0,o))},I.write=function(g,I,C){for(var A,t,e=C,o=0;o<g.length;++o)(A=g.charCodeAt(o))<128?I[C++]=A:A<2048?(I[C++]=A>>6|192,I[C++]=63&A|128):55296==(64512&A)&&56320==(64512&(t=g.charCodeAt(o+1)))?(A=65536+((1023&A)<<10)+(1023&t),++o,I[C++]=A>>18|240,I[C++]=A>>12&63|128,I[C++]=A>>6&63|128,I[C++]=63&A|128):(I[C++]=A>>12|224,I[C++]=A>>6&63|128,I[C++]=63&A|128);return C-e}}(utf8$2);var pool_1=pool;function pool(g,I,C){var A=C||8192,t=A>>>1,e=null,o=A;return function(C){if(C<1||C>t)return g(C);o+C>A&&(e=g(A),o=0);var i=I.call(e,o,o+=C);return 7&o&&(o=1+(7|o)),i}}var longbits=LongBits$2,util$5=minimal$1;function LongBits$2(g,I){this.lo=g>>>0,this.hi=I>>>0}var zero=LongBits$2.zero=new LongBits$2(0,0);zero.toNumber=function(){return 0},zero.zzEncode=zero.zzDecode=function(){return this},zero.length=function(){return 1};var zeroHash=LongBits$2.zeroHash="\0\0\0\0\0\0\0\0";LongBits$2.fromNumber=function(g){if(0===g)return zero;var I=g<0;I&&(g=-g);var C=g>>>0,A=(g-C)/4294967296>>>0;return I&&(A=~A>>>0,C=~C>>>0,++C>4294967295&&(C=0,++A>4294967295&&(A=0))),new LongBits$2(C,A)},LongBits$2.from=function(g){if("number"==typeof g)return LongBits$2.fromNumber(g);if(util$5.isString(g)){if(!util$5.Long)return LongBits$2.fromNumber(parseInt(g,10));g=util$5.Long.fromString(g)}return g.low||g.high?new LongBits$2(g.low>>>0,g.high>>>0):zero},LongBits$2.prototype.toNumber=function(g){if(!g&&this.hi>>>31){var I=1+~this.lo>>>0,C=~this.hi>>>0;return I||(C=C+1>>>0),-(I+4294967296*C)}return this.lo+4294967296*this.hi},LongBits$2.prototype.toLong=function(g){return util$5.Long?new util$5.Long(0|this.lo,0|this.hi,Boolean(g)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(g)}};var charCodeAt=String.prototype.charCodeAt;LongBits$2.fromHash=function(g){return g===zeroHash?zero:new LongBits$2((charCodeAt.call(g,0)|charCodeAt.call(g,1)<<8|charCodeAt.call(g,2)<<16|charCodeAt.call(g,3)<<24)>>>0,(charCodeAt.call(g,4)|charCodeAt.call(g,5)<<8|charCodeAt.call(g,6)<<16|charCodeAt.call(g,7)<<24)>>>0)},LongBits$2.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},LongBits$2.prototype.zzEncode=function(){var g=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^g)>>>0,this.lo=(this.lo<<1^g)>>>0,this},LongBits$2.prototype.zzDecode=function(){var g=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^g)>>>0,this.hi=(this.hi>>>1^g)>>>0,this},LongBits$2.prototype.length=function(){var g=this.lo,I=(this.lo>>>28|this.hi<<4)>>>0,C=this.hi>>>24;return 0===C?0===I?g<16384?g<128?1:2:g<2097152?3:4:I<16384?I<128?5:6:I<2097152?7:8:C<128?9:10},function(g){var I=g;function C(g,I,C){for(var A=Object.keys(I),t=0;t<A.length;++t)void 0!==g[A[t]]&&C||(g[A[t]]=I[A[t]]);return g}function A(g){function I(g,A){if(!(this instanceof I))return new I(g,A);Object.defineProperty(this,"message",{get:function(){return g}}),Error.captureStackTrace?Error.captureStackTrace(this,I):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),A&&C(this,A)}return I.prototype=Object.create(Error.prototype,{constructor:{value:I,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return g},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),I}I.asPromise=aspromise,I.base64=base64$1,I.EventEmitter=eventemitter,I.float=float,I.inquire=inquire_1,I.utf8=utf8$2,I.pool=pool_1,I.LongBits=longbits,I.isNode=Boolean(void 0!==commonjsGlobal&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),I.global=I.isNode&&commonjsGlobal||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||commonjsGlobal,I.emptyArray=Object.freeze?Object.freeze([]):[],I.emptyObject=Object.freeze?Object.freeze({}):{},I.isInteger=Number.isInteger||function(g){return"number"==typeof g&&isFinite(g)&&Math.floor(g)===g},I.isString=function(g){return"string"==typeof g||g instanceof String},I.isObject=function(g){return g&&"object"==typeof g},I.isset=I.isSet=function(g,I){var C=g[I];return!(null==C||!g.hasOwnProperty(I))&&("object"!=typeof C||(Array.isArray(C)?C.length:Object.keys(C).length)>0)},I.Buffer=function(){try{var g=I.inquire("buffer").Buffer;return g.prototype.utf8Write?g:null}catch(C){return null}}(),I._Buffer_from=null,I._Buffer_allocUnsafe=null,I.newBuffer=function(g){return"number"==typeof g?I.Buffer?I._Buffer_allocUnsafe(g):new I.Array(g):I.Buffer?I._Buffer_from(g):"undefined"==typeof Uint8Array?g:new Uint8Array(g)},I.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,I.Long=I.global.dcodeIO&&I.global.dcodeIO.Long||I.global.Long||I.inquire("long"),I.key2Re=/^true|false|0|1$/,I.key32Re=/^-?(?:0|[1-9][0-9]*)$/,I.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,I.longToHash=function(g){return g?I.LongBits.from(g).toHash():I.LongBits.zeroHash},I.longFromHash=function(g,C){var A=I.LongBits.fromHash(g);return I.Long?I.Long.fromBits(A.lo,A.hi,C):A.toNumber(Boolean(C))},I.merge=C,I.lcFirst=function(g){return g.charAt(0).toLowerCase()+g.substring(1)},I.newError=A,I.ProtocolError=A("ProtocolError"),I.oneOfGetter=function(g){for(var I={},C=0;C<g.length;++C)I[g[C]]=1;return function(){for(var g=Object.keys(this),C=g.length-1;C>-1;--C)if(1===I[g[C]]&&void 0!==this[g[C]]&&null!==this[g[C]])return g[C]}},I.oneOfSetter=function(g){return function(I){for(var C=0;C<g.length;++C)g[C]!==I&&delete this[g[C]]}},I.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},I._configure=function(){var g=I.Buffer;g?(I._Buffer_from=g.from!==Uint8Array.from&&g.from||function(I,C){return new g(I,C)},I._Buffer_allocUnsafe=g.allocUnsafe||function(I){return new g(I)}):I._Buffer_from=I._Buffer_allocUnsafe=null}}(minimal$1);var writer=Writer$1,util$4=minimal$1,BufferWriter$1,LongBits$1=util$4.LongBits,base64=util$4.base64,utf8$1=util$4.utf8;function Op(g,I,C){this.fn=g,this.len=I,this.next=void 0,this.val=C}function noop(){}function State(g){this.head=g.head,this.tail=g.tail,this.len=g.len,this.next=g.states}function Writer$1(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create$1=function(){return util$4.Buffer?function(){return(Writer$1.create=function(){return new BufferWriter$1})()}:function(){return new Writer$1}};function writeByte(g,I,C){I[C]=255&g}function writeVarint32(g,I,C){for(;g>127;)I[C++]=127&g|128,g>>>=7;I[C]=g}function VarintOp(g,I){this.len=g,this.next=void 0,this.val=I}function writeVarint64(g,I,C){for(;g.hi;)I[C++]=127&g.lo|128,g.lo=(g.lo>>>7|g.hi<<25)>>>0,g.hi>>>=7;for(;g.lo>127;)I[C++]=127&g.lo|128,g.lo=g.lo>>>7;I[C++]=g.lo}function writeFixed32(g,I,C){I[C]=255&g,I[C+1]=g>>>8&255,I[C+2]=g>>>16&255,I[C+3]=g>>>24}Writer$1.create=create$1(),Writer$1.alloc=function(g){return new util$4.Array(g)},util$4.Array!==Array&&(Writer$1.alloc=util$4.pool(Writer$1.alloc,util$4.Array.prototype.subarray)),Writer$1.prototype._push=function(g,I,C){return this.tail=this.tail.next=new Op(g,I,C),this.len+=I,this},VarintOp.prototype=Object.create(Op.prototype),VarintOp.prototype.fn=writeVarint32,Writer$1.prototype.uint32=function(g){return this.len+=(this.tail=this.tail.next=new VarintOp((g>>>=0)<128?1:g<16384?2:g<2097152?3:g<268435456?4:5,g)).len,this},Writer$1.prototype.int32=function(g){return g<0?this._push(writeVarint64,10,LongBits$1.fromNumber(g)):this.uint32(g)},Writer$1.prototype.sint32=function(g){return this.uint32((g<<1^g>>31)>>>0)},Writer$1.prototype.uint64=function(g){var I=LongBits$1.from(g);return this._push(writeVarint64,I.length(),I)},Writer$1.prototype.int64=Writer$1.prototype.uint64,Writer$1.prototype.sint64=function(g){var I=LongBits$1.from(g).zzEncode();return this._push(writeVarint64,I.length(),I)},Writer$1.prototype.bool=function(g){return this._push(writeByte,1,g?1:0)},Writer$1.prototype.fixed32=function(g){return this._push(writeFixed32,4,g>>>0)},Writer$1.prototype.sfixed32=Writer$1.prototype.fixed32,Writer$1.prototype.fixed64=function(g){var I=LongBits$1.from(g);return this._push(writeFixed32,4,I.lo)._push(writeFixed32,4,I.hi)},Writer$1.prototype.sfixed64=Writer$1.prototype.fixed64,Writer$1.prototype.float=function(g){return this._push(util$4.float.writeFloatLE,4,g)},Writer$1.prototype.double=function(g){return this._push(util$4.float.writeDoubleLE,8,g)};var writeBytes=util$4.Array.prototype.set?function(g,I,C){I.set(g,C)}:function(g,I,C){for(var A=0;A<g.length;++A)I[C+A]=g[A]};Writer$1.prototype.bytes=function(g){var I=g.length>>>0;if(!I)return this._push(writeByte,1,0);if(util$4.isString(g)){var C=Writer$1.alloc(I=base64.length(g));base64.decode(g,C,0),g=C}return this.uint32(I)._push(writeBytes,I,g)},Writer$1.prototype.string=function(g){var I=utf8$1.length(g);return I?this.uint32(I)._push(utf8$1.write,I,g):this._push(writeByte,1,0)},Writer$1.prototype.fork=function(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this},Writer$1.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this},Writer$1.prototype.ldelim=function(){var g=this.head,I=this.tail,C=this.len;return this.reset().uint32(C),C&&(this.tail.next=g.next,this.tail=I,this.len+=C),this},Writer$1.prototype.finish=function(){for(var g=this.head.next,I=this.constructor.alloc(this.len),C=0;g;)g.fn(g.val,I,C),C+=g.len,g=g.next;return I},Writer$1._configure=function(g){BufferWriter$1=g,Writer$1.create=create$1(),BufferWriter$1._configure()};var writer_buffer=BufferWriter,Writer=writer;(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util$3=minimal$1;function BufferWriter(){Writer.call(this)}function writeStringBuffer(g,I,C){g.length<40?util$3.utf8.write(g,I,C):I.utf8Write?I.utf8Write(g,C):I.write(g,C)}BufferWriter._configure=function(){BufferWriter.alloc=util$3._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util$3.Buffer&&util$3.Buffer.prototype instanceof Uint8Array&&"set"===util$3.Buffer.prototype.set.name?function(g,I,C){I.set(g,C)}:function(g,I,C){if(g.copy)g.copy(I,C,0,g.length);else for(var A=0;A<g.length;)I[C++]=g[A++]}},BufferWriter.prototype.bytes=function(g){util$3.isString(g)&&(g=util$3._Buffer_from(g,"base64"));var I=g.length>>>0;return this.uint32(I),I&&this._push(BufferWriter.writeBytesBuffer,I,g),this},BufferWriter.prototype.string=function(g){var I=util$3.Buffer.byteLength(g);return this.uint32(I),I&&this._push(writeStringBuffer,I,g),this},BufferWriter._configure();var reader=Reader$1,util$2=minimal$1,BufferReader$1,LongBits=util$2.LongBits,utf8=util$2.utf8;function indexOutOfRange(g,I){return RangeError("index out of range: "+g.pos+" + "+(I||1)+" > "+g.len)}function Reader$1(g){this.buf=g,this.pos=0,this.len=g.length}var create_array="undefined"!=typeof Uint8Array?function(g){if(g instanceof Uint8Array||Array.isArray(g))return new Reader$1(g);throw Error("illegal buffer")}:function(g){if(Array.isArray(g))return new Reader$1(g);throw Error("illegal buffer")},create=function(){return util$2.Buffer?function(g){return(Reader$1.create=function(g){return util$2.Buffer.isBuffer(g)?new BufferReader$1(g):create_array(g)})(g)}:create_array},value;function readLongVarint(){var g=new LongBits(0,0),I=0;if(!(this.len-this.pos>4)){for(;I<3;++I){if(this.pos>=this.len)throw indexOutOfRange(this);if(g.lo=(g.lo|(127&this.buf[this.pos])<<7*I)>>>0,this.buf[this.pos++]<128)return g}return g.lo=(g.lo|(127&this.buf[this.pos++])<<7*I)>>>0,g}for(;I<4;++I)if(g.lo=(g.lo|(127&this.buf[this.pos])<<7*I)>>>0,this.buf[this.pos++]<128)return g;if(g.lo=(g.lo|(127&this.buf[this.pos])<<28)>>>0,g.hi=(g.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return g;if(I=0,this.len-this.pos>4){for(;I<5;++I)if(g.hi=(g.hi|(127&this.buf[this.pos])<<7*I+3)>>>0,this.buf[this.pos++]<128)return g}else for(;I<5;++I){if(this.pos>=this.len)throw indexOutOfRange(this);if(g.hi=(g.hi|(127&this.buf[this.pos])<<7*I+3)>>>0,this.buf[this.pos++]<128)return g}throw Error("invalid varint encoding")}function readFixed32_end(g,I){return(g[I-4]|g[I-3]<<8|g[I-2]<<16|g[I-1]<<24)>>>0}function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader$1.create=create(),Reader$1.prototype._slice=util$2.Array.prototype.subarray||util$2.Array.prototype.slice,Reader$1.prototype.uint32=(value=4294967295,function(){if(value=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return value;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return value}),Reader$1.prototype.int32=function(){return 0|this.uint32()},Reader$1.prototype.sint32=function(){var g=this.uint32();return g>>>1^-(1&g)|0},Reader$1.prototype.bool=function(){return 0!==this.uint32()},Reader$1.prototype.fixed32=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)},Reader$1.prototype.sfixed32=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return 0|readFixed32_end(this.buf,this.pos+=4)},Reader$1.prototype.float=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var g=util$2.float.readFloatLE(this.buf,this.pos);return this.pos+=4,g},Reader$1.prototype.double=function(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var g=util$2.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,g},Reader$1.prototype.bytes=function(){var g=this.uint32(),I=this.pos,C=this.pos+g;if(C>this.len)throw indexOutOfRange(this,g);return this.pos+=g,Array.isArray(this.buf)?this.buf.slice(I,C):I===C?new this.buf.constructor(0):this._slice.call(this.buf,I,C)},Reader$1.prototype.string=function(){var g=this.bytes();return utf8.read(g,0,g.length)},Reader$1.prototype.skip=function(g){if("number"==typeof g){if(this.pos+g>this.len)throw indexOutOfRange(this,g);this.pos+=g}else do{if(this.pos>=this.len)throw indexOutOfRange(this)}while(128&this.buf[this.pos++]);return this},Reader$1.prototype.skipType=function(g){switch(g){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(g=7&this.uint32());)this.skipType(g);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+g+" at offset "+this.pos)}return this},Reader$1._configure=function(g){BufferReader$1=g,Reader$1.create=create(),BufferReader$1._configure();var I=util$2.Long?"toLong":"toNumber";util$2.merge(Reader$1.prototype,{int64:function(){return readLongVarint.call(this)[I](!1)},uint64:function(){return readLongVarint.call(this)[I](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[I](!1)},fixed64:function(){return readFixed64.call(this)[I](!0)},sfixed64:function(){return readFixed64.call(this)[I](!1)}})};var reader_buffer=BufferReader,Reader=reader;(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util$1=minimal$1;function BufferReader(g){Reader.call(this,g)}BufferReader._configure=function(){util$1.Buffer&&(BufferReader.prototype._slice=util$1.Buffer.prototype.slice)},BufferReader.prototype.string=function(){var g=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+g,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+g,this.len))},BufferReader._configure();var rpc={},service=Service,util=minimal$1,exports;function Service(g,I,C){if("function"!=typeof g)throw TypeError("rpcImpl must be a function");util.EventEmitter.call(this),this.rpcImpl=g,this.requestDelimited=Boolean(I),this.responseDelimited=Boolean(C)}(Service.prototype=Object.create(util.EventEmitter.prototype)).constructor=Service,Service.prototype.rpcCall=function g(I,C,A,t,e){if(!t)throw TypeError("request must be specified");var o=this;if(!e)return util.asPromise(g,o,I,C,A,t);if(o.rpcImpl)try{return o.rpcImpl(I,C[o.requestDelimited?"encodeDelimited":"encode"](t).finish(),(function(g,C){if(g)return o.emit("error",g,I),e(g);if(null!==C){if(!(C instanceof A))try{C=A[o.responseDelimited?"decodeDelimited":"decode"](C)}catch(g){return o.emit("error",g,I),e(g)}return o.emit("data",C,I),e(null,C)}o.end(!0)}))}catch(i){return o.emit("error",i,I),void setTimeout((function(){e(i)}),0)}else setTimeout((function(){e(Error("already ended"))}),0)},Service.prototype.end=function(g){return this.rpcImpl&&(g||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},exports=rpc,exports.Service=service;var roots={};!function(g){var I=g;function C(){I.util._configure(),I.Writer._configure(I.BufferWriter),I.Reader._configure(I.BufferReader)}I.build="minimal",I.Writer=writer,I.BufferWriter=writer_buffer,I.Reader=reader,I.BufferReader=reader_buffer,I.util=minimal$1,I.rpc=rpc,I.roots=roots,I.configure=C,C()}(indexMinimal);var minimal=indexMinimal,$protobuf=minimal,$Reader=$protobuf.Reader,$Writer=$protobuf.Writer,$util=$protobuf.util,$root=$protobuf.roots.default||($protobuf.roots.default={});$root.protocol=function(){var g={};return g.Geometry=function(){function g(g){if(this.positions=[],this.uvs=[],this.indices=[],this.lights=[],g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}var I;return g.prototype.voxel=0,g.prototype.faceName=null,g.prototype.positions=$util.emptyArray,g.prototype.uvs=$util.emptyArray,g.prototype.indices=$util.emptyArray,g.prototype.lights=$util.emptyArray,Object.defineProperty(g.prototype,"_faceName",{get:$util.oneOfGetter(I=["faceName"]),set:$util.oneOfSetter(I)}),g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=$Writer.create()),null!=g.voxel&&Object.hasOwnProperty.call(g,"voxel")&&I.uint32(8).uint32(g.voxel),null!=g.faceName&&Object.hasOwnProperty.call(g,"faceName")&&I.uint32(18).string(g.faceName),null!=g.positions&&g.positions.length){I.uint32(26).fork();for(var C=0;C<g.positions.length;++C)I.float(g.positions[C]);I.ldelim()}if(null!=g.uvs&&g.uvs.length){I.uint32(34).fork();for(C=0;C<g.uvs.length;++C)I.float(g.uvs[C]);I.ldelim()}if(null!=g.indices&&g.indices.length){I.uint32(42).fork();for(C=0;C<g.indices.length;++C)I.int32(g.indices[C]);I.ldelim()}if(null!=g.lights&&g.lights.length){I.uint32(50).fork();for(C=0;C<g.lights.length;++C)I.int32(g.lights[C]);I.ldelim()}return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Geometry;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.voxel=g.uint32();break;case 2:A.faceName=g.string();break;case 3:if(A.positions&&A.positions.length||(A.positions=[]),2==(7&t))for(var e=g.uint32()+g.pos;g.pos<e;)A.positions.push(g.float());else A.positions.push(g.float());break;case 4:if(A.uvs&&A.uvs.length||(A.uvs=[]),2==(7&t))for(e=g.uint32()+g.pos;g.pos<e;)A.uvs.push(g.float());else A.uvs.push(g.float());break;case 5:if(A.indices&&A.indices.length||(A.indices=[]),2==(7&t))for(e=g.uint32()+g.pos;g.pos<e;)A.indices.push(g.int32());else A.indices.push(g.int32());break;case 6:if(A.lights&&A.lights.length||(A.lights=[]),2==(7&t))for(e=g.uint32()+g.pos;g.pos<e;)A.lights.push(g.int32());else A.lights.push(g.int32());break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.voxel&&g.hasOwnProperty("voxel")&&!$util.isInteger(g.voxel))return"voxel: integer expected";if(null!=g.faceName&&g.hasOwnProperty("faceName")&&!$util.isString(g.faceName))return"faceName: string expected";if(null!=g.positions&&g.hasOwnProperty("positions")){if(!Array.isArray(g.positions))return"positions: array expected";for(var I=0;I<g.positions.length;++I)if("number"!=typeof g.positions[I])return"positions: number[] expected"}if(null!=g.uvs&&g.hasOwnProperty("uvs")){if(!Array.isArray(g.uvs))return"uvs: array expected";for(I=0;I<g.uvs.length;++I)if("number"!=typeof g.uvs[I])return"uvs: number[] expected"}if(null!=g.indices&&g.hasOwnProperty("indices")){if(!Array.isArray(g.indices))return"indices: array expected";for(I=0;I<g.indices.length;++I)if(!$util.isInteger(g.indices[I]))return"indices: integer[] expected"}if(null!=g.lights&&g.hasOwnProperty("lights")){if(!Array.isArray(g.lights))return"lights: array expected";for(I=0;I<g.lights.length;++I)if(!$util.isInteger(g.lights[I]))return"lights: integer[] expected"}return null},g.fromObject=function(g){if(g instanceof $root.protocol.Geometry)return g;var I=new $root.protocol.Geometry;if(null!=g.voxel&&(I.voxel=g.voxel>>>0),null!=g.faceName&&(I.faceName=String(g.faceName)),g.positions){if(!Array.isArray(g.positions))throw TypeError(".protocol.Geometry.positions: array expected");I.positions=[];for(var C=0;C<g.positions.length;++C)I.positions[C]=Number(g.positions[C])}if(g.uvs){if(!Array.isArray(g.uvs))throw TypeError(".protocol.Geometry.uvs: array expected");I.uvs=[];for(C=0;C<g.uvs.length;++C)I.uvs[C]=Number(g.uvs[C])}if(g.indices){if(!Array.isArray(g.indices))throw TypeError(".protocol.Geometry.indices: array expected");I.indices=[];for(C=0;C<g.indices.length;++C)I.indices[C]=0|g.indices[C]}if(g.lights){if(!Array.isArray(g.lights))throw TypeError(".protocol.Geometry.lights: array expected");I.lights=[];for(C=0;C<g.lights.length;++C)I.lights[C]=0|g.lights[C]}return I},g.toObject=function(g,I){I||(I={});var C={};if((I.arrays||I.defaults)&&(C.positions=[],C.uvs=[],C.indices=[],C.lights=[]),I.defaults&&(C.voxel=0),null!=g.voxel&&g.hasOwnProperty("voxel")&&(C.voxel=g.voxel),null!=g.faceName&&g.hasOwnProperty("faceName")&&(C.faceName=g.faceName,I.oneofs&&(C._faceName="faceName")),g.positions&&g.positions.length){C.positions=[];for(var A=0;A<g.positions.length;++A)C.positions[A]=I.json&&!isFinite(g.positions[A])?String(g.positions[A]):g.positions[A]}if(g.uvs&&g.uvs.length){C.uvs=[];for(A=0;A<g.uvs.length;++A)C.uvs[A]=I.json&&!isFinite(g.uvs[A])?String(g.uvs[A]):g.uvs[A]}if(g.indices&&g.indices.length){C.indices=[];for(A=0;A<g.indices.length;++A)C.indices[A]=g.indices[A]}if(g.lights&&g.lights.length){C.lights=[];for(A=0;A<g.lights.length;++A)C.lights[A]=g.lights[A]}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Geometry"},g}(),g.Mesh=function(){function g(g){if(this.geometries=[],g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.level=0,g.prototype.geometries=$util.emptyArray,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=$Writer.create()),null!=g.level&&Object.hasOwnProperty.call(g,"level")&&I.uint32(8).int32(g.level),null!=g.geometries&&g.geometries.length)for(var C=0;C<g.geometries.length;++C)$root.protocol.Geometry.encode(g.geometries[C],I.uint32(18).fork()).ldelim();return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Mesh;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.level=g.int32();break;case 2:A.geometries&&A.geometries.length||(A.geometries=[]),A.geometries.push($root.protocol.Geometry.decode(g,g.uint32()));break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.level&&g.hasOwnProperty("level")&&!$util.isInteger(g.level))return"level: integer expected";if(null!=g.geometries&&g.hasOwnProperty("geometries")){if(!Array.isArray(g.geometries))return"geometries: array expected";for(var I=0;I<g.geometries.length;++I){var C=$root.protocol.Geometry.verify(g.geometries[I]);if(C)return"geometries."+C}}return null},g.fromObject=function(g){if(g instanceof $root.protocol.Mesh)return g;var I=new $root.protocol.Mesh;if(null!=g.level&&(I.level=0|g.level),g.geometries){if(!Array.isArray(g.geometries))throw TypeError(".protocol.Mesh.geometries: array expected");I.geometries=[];for(var C=0;C<g.geometries.length;++C){if("object"!=typeof g.geometries[C])throw TypeError(".protocol.Mesh.geometries: object expected");I.geometries[C]=$root.protocol.Geometry.fromObject(g.geometries[C])}}return I},g.toObject=function(g,I){I||(I={});var C={};if((I.arrays||I.defaults)&&(C.geometries=[]),I.defaults&&(C.level=0),null!=g.level&&g.hasOwnProperty("level")&&(C.level=g.level),g.geometries&&g.geometries.length){C.geometries=[];for(var A=0;A<g.geometries.length;++A)C.geometries[A]=$root.protocol.Geometry.toObject(g.geometries[A],I)}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Mesh"},g}(),g.Chunk=function(){function g(g){if(this.meshes=[],this.voxels=[],this.lights=[],g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.x=0,g.prototype.z=0,g.prototype.id="",g.prototype.meshes=$util.emptyArray,g.prototype.voxels=$util.emptyArray,g.prototype.lights=$util.emptyArray,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=$Writer.create()),null!=g.x&&Object.hasOwnProperty.call(g,"x")&&I.uint32(8).int32(g.x),null!=g.z&&Object.hasOwnProperty.call(g,"z")&&I.uint32(16).int32(g.z),null!=g.id&&Object.hasOwnProperty.call(g,"id")&&I.uint32(26).string(g.id),null!=g.meshes&&g.meshes.length)for(var C=0;C<g.meshes.length;++C)$root.protocol.Mesh.encode(g.meshes[C],I.uint32(34).fork()).ldelim();if(null!=g.voxels&&g.voxels.length){I.uint32(42).fork();for(C=0;C<g.voxels.length;++C)I.uint32(g.voxels[C]);I.ldelim()}if(null!=g.lights&&g.lights.length){I.uint32(50).fork();for(C=0;C<g.lights.length;++C)I.uint32(g.lights[C]);I.ldelim()}return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Chunk;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.x=g.int32();break;case 2:A.z=g.int32();break;case 3:A.id=g.string();break;case 4:A.meshes&&A.meshes.length||(A.meshes=[]),A.meshes.push($root.protocol.Mesh.decode(g,g.uint32()));break;case 5:if(A.voxels&&A.voxels.length||(A.voxels=[]),2==(7&t))for(var e=g.uint32()+g.pos;g.pos<e;)A.voxels.push(g.uint32());else A.voxels.push(g.uint32());break;case 6:if(A.lights&&A.lights.length||(A.lights=[]),2==(7&t))for(e=g.uint32()+g.pos;g.pos<e;)A.lights.push(g.uint32());else A.lights.push(g.uint32());break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.x&&g.hasOwnProperty("x")&&!$util.isInteger(g.x))return"x: integer expected";if(null!=g.z&&g.hasOwnProperty("z")&&!$util.isInteger(g.z))return"z: integer expected";if(null!=g.id&&g.hasOwnProperty("id")&&!$util.isString(g.id))return"id: string expected";if(null!=g.meshes&&g.hasOwnProperty("meshes")){if(!Array.isArray(g.meshes))return"meshes: array expected";for(var I=0;I<g.meshes.length;++I){var C=$root.protocol.Mesh.verify(g.meshes[I]);if(C)return"meshes."+C}}if(null!=g.voxels&&g.hasOwnProperty("voxels")){if(!Array.isArray(g.voxels))return"voxels: array expected";for(I=0;I<g.voxels.length;++I)if(!$util.isInteger(g.voxels[I]))return"voxels: integer[] expected"}if(null!=g.lights&&g.hasOwnProperty("lights")){if(!Array.isArray(g.lights))return"lights: array expected";for(I=0;I<g.lights.length;++I)if(!$util.isInteger(g.lights[I]))return"lights: integer[] expected"}return null},g.fromObject=function(g){if(g instanceof $root.protocol.Chunk)return g;var I=new $root.protocol.Chunk;if(null!=g.x&&(I.x=0|g.x),null!=g.z&&(I.z=0|g.z),null!=g.id&&(I.id=String(g.id)),g.meshes){if(!Array.isArray(g.meshes))throw TypeError(".protocol.Chunk.meshes: array expected");I.meshes=[];for(var C=0;C<g.meshes.length;++C){if("object"!=typeof g.meshes[C])throw TypeError(".protocol.Chunk.meshes: object expected");I.meshes[C]=$root.protocol.Mesh.fromObject(g.meshes[C])}}if(g.voxels){if(!Array.isArray(g.voxels))throw TypeError(".protocol.Chunk.voxels: array expected");I.voxels=[];for(C=0;C<g.voxels.length;++C)I.voxels[C]=g.voxels[C]>>>0}if(g.lights){if(!Array.isArray(g.lights))throw TypeError(".protocol.Chunk.lights: array expected");I.lights=[];for(C=0;C<g.lights.length;++C)I.lights[C]=g.lights[C]>>>0}return I},g.toObject=function(g,I){I||(I={});var C={};if((I.arrays||I.defaults)&&(C.meshes=[],C.voxels=[],C.lights=[]),I.defaults&&(C.x=0,C.z=0,C.id=""),null!=g.x&&g.hasOwnProperty("x")&&(C.x=g.x),null!=g.z&&g.hasOwnProperty("z")&&(C.z=g.z),null!=g.id&&g.hasOwnProperty("id")&&(C.id=g.id),g.meshes&&g.meshes.length){C.meshes=[];for(var A=0;A<g.meshes.length;++A)C.meshes[A]=$root.protocol.Mesh.toObject(g.meshes[A],I)}if(g.voxels&&g.voxels.length){C.voxels=[];for(A=0;A<g.voxels.length;++A)C.voxels[A]=g.voxels[A]}if(g.lights&&g.lights.length){C.lights=[];for(A=0;A<g.lights.length;++A)C.lights[A]=g.lights[A]}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Chunk"},g}(),g.Peer=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.id="",g.prototype.username="",g.prototype.metadata="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.id&&Object.hasOwnProperty.call(g,"id")&&I.uint32(10).string(g.id),null!=g.username&&Object.hasOwnProperty.call(g,"username")&&I.uint32(18).string(g.username),null!=g.metadata&&Object.hasOwnProperty.call(g,"metadata")&&I.uint32(26).string(g.metadata),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Peer;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.id=g.string();break;case 2:A.username=g.string();break;case 3:A.metadata=g.string();break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.id&&g.hasOwnProperty("id")&&!$util.isString(g.id)?"id: string expected":null!=g.username&&g.hasOwnProperty("username")&&!$util.isString(g.username)?"username: string expected":null!=g.metadata&&g.hasOwnProperty("metadata")&&!$util.isString(g.metadata)?"metadata: string expected":null},g.fromObject=function(g){if(g instanceof $root.protocol.Peer)return g;var I=new $root.protocol.Peer;return null!=g.id&&(I.id=String(g.id)),null!=g.username&&(I.username=String(g.username)),null!=g.metadata&&(I.metadata=String(g.metadata)),I},g.toObject=function(g,I){I||(I={});var C={};return I.defaults&&(C.id="",C.username="",C.metadata=""),null!=g.id&&g.hasOwnProperty("id")&&(C.id=g.id),null!=g.username&&g.hasOwnProperty("username")&&(C.username=g.username),null!=g.metadata&&g.hasOwnProperty("metadata")&&(C.metadata=g.metadata),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Peer"},g}(),g.Entity=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}var I,C;return g.prototype.operation=0,g.prototype.id="",g.prototype.type="",g.prototype.metadata="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.operation&&Object.hasOwnProperty.call(g,"operation")&&I.uint32(8).int32(g.operation),null!=g.id&&Object.hasOwnProperty.call(g,"id")&&I.uint32(18).string(g.id),null!=g.type&&Object.hasOwnProperty.call(g,"type")&&I.uint32(26).string(g.type),null!=g.metadata&&Object.hasOwnProperty.call(g,"metadata")&&I.uint32(34).string(g.metadata),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Entity;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.operation=g.int32();break;case 2:A.id=g.string();break;case 3:A.type=g.string();break;case 4:A.metadata=g.string();break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.operation&&g.hasOwnProperty("operation"))switch(g.operation){default:return"operation: enum value expected";case 0:case 1:case 2:}return null!=g.id&&g.hasOwnProperty("id")&&!$util.isString(g.id)?"id: string expected":null!=g.type&&g.hasOwnProperty("type")&&!$util.isString(g.type)?"type: string expected":null!=g.metadata&&g.hasOwnProperty("metadata")&&!$util.isString(g.metadata)?"metadata: string expected":null},g.fromObject=function(g){if(g instanceof $root.protocol.Entity)return g;var I=new $root.protocol.Entity;switch(g.operation){default:if("number"==typeof g.operation){I.operation=g.operation;break}break;case"CREATE":case 0:I.operation=0;break;case"DELETE":case 1:I.operation=1;break;case"UPDATE":case 2:I.operation=2}return null!=g.id&&(I.id=String(g.id)),null!=g.type&&(I.type=String(g.type)),null!=g.metadata&&(I.metadata=String(g.metadata)),I},g.toObject=function(g,I){I||(I={});var C={};return I.defaults&&(C.operation=I.enums===String?"CREATE":0,C.id="",C.type="",C.metadata=""),null!=g.operation&&g.hasOwnProperty("operation")&&(C.operation=I.enums===String?void 0===$root.protocol.Entity.Operation[g.operation]?g.operation:$root.protocol.Entity.Operation[g.operation]:g.operation),null!=g.id&&g.hasOwnProperty("id")&&(C.id=g.id),null!=g.type&&g.hasOwnProperty("type")&&(C.type=g.type),null!=g.metadata&&g.hasOwnProperty("metadata")&&(C.metadata=g.metadata),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Entity"},g.Operation=(I={},(C=Object.create(I))[I[0]="CREATE"]=0,C[I[1]="DELETE"]=1,C[I[2]="UPDATE"]=2,C),g}(),g.Event=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.name="",g.prototype.payload=null,g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.name&&Object.hasOwnProperty.call(g,"name")&&I.uint32(10).string(g.name),null!=g.payload&&Object.hasOwnProperty.call(g,"payload")&&$root.google.protobuf.Struct.encode(g.payload,I.uint32(18).fork()).ldelim(),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Event;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.name=g.string();break;case 2:A.payload=$root.google.protobuf.Struct.decode(g,g.uint32());break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.name&&g.hasOwnProperty("name")&&!$util.isString(g.name))return"name: string expected";if(null!=g.payload&&g.hasOwnProperty("payload")){var I=$root.google.protobuf.Struct.verify(g.payload);if(I)return"payload."+I}return null},g.fromObject=function(g){if(g instanceof $root.protocol.Event)return g;var I=new $root.protocol.Event;if(null!=g.name&&(I.name=String(g.name)),null!=g.payload){if("object"!=typeof g.payload)throw TypeError(".protocol.Event.payload: object expected");I.payload=$root.google.protobuf.Struct.fromObject(g.payload)}return I},g.toObject=function(g,I){I||(I={});var C={};return I.defaults&&(C.name="",C.payload=null),null!=g.name&&g.hasOwnProperty("name")&&(C.name=g.name),null!=g.payload&&g.hasOwnProperty("payload")&&(C.payload=$root.google.protobuf.Struct.toObject(g.payload,I)),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Event"},g}(),g.Method=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.name="",g.prototype.payload="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.name&&Object.hasOwnProperty.call(g,"name")&&I.uint32(10).string(g.name),null!=g.payload&&Object.hasOwnProperty.call(g,"payload")&&I.uint32(18).string(g.payload),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Method;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.name=g.string();break;case 2:A.payload=g.string();break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.name&&g.hasOwnProperty("name")&&!$util.isString(g.name)?"name: string expected":null!=g.payload&&g.hasOwnProperty("payload")&&!$util.isString(g.payload)?"payload: string expected":null},g.fromObject=function(g){if(g instanceof $root.protocol.Method)return g;var I=new $root.protocol.Method;return null!=g.name&&(I.name=String(g.name)),null!=g.payload&&(I.payload=String(g.payload)),I},g.toObject=function(g,I){I||(I={});var C={};return I.defaults&&(C.name="",C.payload=""),null!=g.name&&g.hasOwnProperty("name")&&(C.name=g.name),null!=g.payload&&g.hasOwnProperty("payload")&&(C.payload=g.payload),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Method"},g}(),g.Update=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.vx=0,g.prototype.vy=0,g.prototype.vz=0,g.prototype.voxel=0,g.prototype.light=0,g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.vx&&Object.hasOwnProperty.call(g,"vx")&&I.uint32(8).int32(g.vx),null!=g.vy&&Object.hasOwnProperty.call(g,"vy")&&I.uint32(16).int32(g.vy),null!=g.vz&&Object.hasOwnProperty.call(g,"vz")&&I.uint32(24).int32(g.vz),null!=g.voxel&&Object.hasOwnProperty.call(g,"voxel")&&I.uint32(32).uint32(g.voxel),null!=g.light&&Object.hasOwnProperty.call(g,"light")&&I.uint32(40).uint32(g.light),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Update;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.vx=g.int32();break;case 2:A.vy=g.int32();break;case 3:A.vz=g.int32();break;case 4:A.voxel=g.uint32();break;case 5:A.light=g.uint32();break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.vx&&g.hasOwnProperty("vx")&&!$util.isInteger(g.vx)?"vx: integer expected":null!=g.vy&&g.hasOwnProperty("vy")&&!$util.isInteger(g.vy)?"vy: integer expected":null!=g.vz&&g.hasOwnProperty("vz")&&!$util.isInteger(g.vz)?"vz: integer expected":null!=g.voxel&&g.hasOwnProperty("voxel")&&!$util.isInteger(g.voxel)?"voxel: integer expected":null!=g.light&&g.hasOwnProperty("light")&&!$util.isInteger(g.light)?"light: integer expected":null},g.fromObject=function(g){if(g instanceof $root.protocol.Update)return g;var I=new $root.protocol.Update;return null!=g.vx&&(I.vx=0|g.vx),null!=g.vy&&(I.vy=0|g.vy),null!=g.vz&&(I.vz=0|g.vz),null!=g.voxel&&(I.voxel=g.voxel>>>0),null!=g.light&&(I.light=g.light>>>0),I},g.toObject=function(g,I){I||(I={});var C={};return I.defaults&&(C.vx=0,C.vy=0,C.vz=0,C.voxel=0,C.light=0),null!=g.vx&&g.hasOwnProperty("vx")&&(C.vx=g.vx),null!=g.vy&&g.hasOwnProperty("vy")&&(C.vy=g.vy),null!=g.vz&&g.hasOwnProperty("vz")&&(C.vz=g.vz),null!=g.voxel&&g.hasOwnProperty("voxel")&&(C.voxel=g.voxel),null!=g.light&&g.hasOwnProperty("light")&&(C.light=g.light),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Update"},g}(),g.ChatMessage=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.type="",g.prototype.sender="",g.prototype.body="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.type&&Object.hasOwnProperty.call(g,"type")&&I.uint32(10).string(g.type),null!=g.sender&&Object.hasOwnProperty.call(g,"sender")&&I.uint32(18).string(g.sender),null!=g.body&&Object.hasOwnProperty.call(g,"body")&&I.uint32(26).string(g.body),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.ChatMessage;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.type=g.string();break;case 2:A.sender=g.string();break;case 3:A.body=g.string();break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.type&&g.hasOwnProperty("type")&&!$util.isString(g.type)?"type: string expected":null!=g.sender&&g.hasOwnProperty("sender")&&!$util.isString(g.sender)?"sender: string expected":null!=g.body&&g.hasOwnProperty("body")&&!$util.isString(g.body)?"body: string expected":null},g.fromObject=function(g){if(g instanceof $root.protocol.ChatMessage)return g;var I=new $root.protocol.ChatMessage;return null!=g.type&&(I.type=String(g.type)),null!=g.sender&&(I.sender=String(g.sender)),null!=g.body&&(I.body=String(g.body)),I},g.toObject=function(g,I){I||(I={});var C={};return I.defaults&&(C.type="",C.sender="",C.body=""),null!=g.type&&g.hasOwnProperty("type")&&(C.type=g.type),null!=g.sender&&g.hasOwnProperty("sender")&&(C.sender=g.sender),null!=g.body&&g.hasOwnProperty("body")&&(C.body=g.body),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.ChatMessage"},g}(),g.Message=function(){function g(g){if(this.peers=[],this.entities=[],this.chunks=[],this.events=[],this.updates=[],g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}var I,C;return g.prototype.type=0,g.prototype.json="",g.prototype.text="",g.prototype.method=null,g.prototype.chat=null,g.prototype.peers=$util.emptyArray,g.prototype.entities=$util.emptyArray,g.prototype.chunks=$util.emptyArray,g.prototype.events=$util.emptyArray,g.prototype.updates=$util.emptyArray,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=$Writer.create()),null!=g.type&&Object.hasOwnProperty.call(g,"type")&&I.uint32(8).int32(g.type),null!=g.json&&Object.hasOwnProperty.call(g,"json")&&I.uint32(18).string(g.json),null!=g.text&&Object.hasOwnProperty.call(g,"text")&&I.uint32(26).string(g.text),null!=g.method&&Object.hasOwnProperty.call(g,"method")&&$root.protocol.Method.encode(g.method,I.uint32(34).fork()).ldelim(),null!=g.chat&&Object.hasOwnProperty.call(g,"chat")&&$root.protocol.ChatMessage.encode(g.chat,I.uint32(42).fork()).ldelim(),null!=g.peers&&g.peers.length)for(var C=0;C<g.peers.length;++C)$root.protocol.Peer.encode(g.peers[C],I.uint32(50).fork()).ldelim();if(null!=g.entities&&g.entities.length)for(C=0;C<g.entities.length;++C)$root.protocol.Entity.encode(g.entities[C],I.uint32(58).fork()).ldelim();if(null!=g.chunks&&g.chunks.length)for(C=0;C<g.chunks.length;++C)$root.protocol.Chunk.encode(g.chunks[C],I.uint32(66).fork()).ldelim();if(null!=g.events&&g.events.length)for(C=0;C<g.events.length;++C)$root.protocol.Event.encode(g.events[C],I.uint32(74).fork()).ldelim();if(null!=g.updates&&g.updates.length)for(C=0;C<g.updates.length;++C)$root.protocol.Update.encode(g.updates[C],I.uint32(82).fork()).ldelim();return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.protocol.Message;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.type=g.int32();break;case 2:A.json=g.string();break;case 3:A.text=g.string();break;case 4:A.method=$root.protocol.Method.decode(g,g.uint32());break;case 5:A.chat=$root.protocol.ChatMessage.decode(g,g.uint32());break;case 6:A.peers&&A.peers.length||(A.peers=[]),A.peers.push($root.protocol.Peer.decode(g,g.uint32()));break;case 7:A.entities&&A.entities.length||(A.entities=[]),A.entities.push($root.protocol.Entity.decode(g,g.uint32()));break;case 8:A.chunks&&A.chunks.length||(A.chunks=[]),A.chunks.push($root.protocol.Chunk.decode(g,g.uint32()));break;case 9:A.events&&A.events.length||(A.events=[]),A.events.push($root.protocol.Event.decode(g,g.uint32()));break;case 10:A.updates&&A.updates.length||(A.updates=[]),A.updates.push($root.protocol.Update.decode(g,g.uint32()));break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.type&&g.hasOwnProperty("type"))switch(g.type){default:return"type: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:}if(null!=g.json&&g.hasOwnProperty("json")&&!$util.isString(g.json))return"json: string expected";if(null!=g.text&&g.hasOwnProperty("text")&&!$util.isString(g.text))return"text: string expected";if(null!=g.method&&g.hasOwnProperty("method")&&(C=$root.protocol.Method.verify(g.method)))return"method."+C;if(null!=g.chat&&g.hasOwnProperty("chat")&&(C=$root.protocol.ChatMessage.verify(g.chat)))return"chat."+C;if(null!=g.peers&&g.hasOwnProperty("peers")){if(!Array.isArray(g.peers))return"peers: array expected";for(var I=0;I<g.peers.length;++I){if(C=$root.protocol.Peer.verify(g.peers[I]))return"peers."+C}}if(null!=g.entities&&g.hasOwnProperty("entities")){if(!Array.isArray(g.entities))return"entities: array expected";for(I=0;I<g.entities.length;++I){if(C=$root.protocol.Entity.verify(g.entities[I]))return"entities."+C}}if(null!=g.chunks&&g.hasOwnProperty("chunks")){if(!Array.isArray(g.chunks))return"chunks: array expected";for(I=0;I<g.chunks.length;++I){if(C=$root.protocol.Chunk.verify(g.chunks[I]))return"chunks."+C}}if(null!=g.events&&g.hasOwnProperty("events")){if(!Array.isArray(g.events))return"events: array expected";for(I=0;I<g.events.length;++I){if(C=$root.protocol.Event.verify(g.events[I]))return"events."+C}}if(null!=g.updates&&g.hasOwnProperty("updates")){if(!Array.isArray(g.updates))return"updates: array expected";for(I=0;I<g.updates.length;++I){var C;if(C=$root.protocol.Update.verify(g.updates[I]))return"updates."+C}}return null},g.fromObject=function(g){if(g instanceof $root.protocol.Message)return g;var I=new $root.protocol.Message;switch(g.type){default:if("number"==typeof g.type){I.type=g.type;break}break;case"INIT":case 0:I.type=0;break;case"JOIN":case 1:I.type=1;break;case"LEAVE":case 2:I.type=2;break;case"ERROR":case 3:I.type=3;break;case"PEER":case 4:I.type=4;break;case"ENTITY":case 5:I.type=5;break;case"LOAD":case 6:I.type=6;break;case"UNLOAD":case 7:I.type=7;break;case"UPDATE":case 8:I.type=8;break;case"METHOD":case 9:I.type=9;break;case"CHAT":case 10:I.type=10;break;case"TRANSPORT":case 11:I.type=11;break;case"EVENT":case 12:I.type=12;break;case"ACTION":case 13:I.type=13;break;case"STATS":case 14:I.type=14}if(null!=g.json&&(I.json=String(g.json)),null!=g.text&&(I.text=String(g.text)),null!=g.method){if("object"!=typeof g.method)throw TypeError(".protocol.Message.method: object expected");I.method=$root.protocol.Method.fromObject(g.method)}if(null!=g.chat){if("object"!=typeof g.chat)throw TypeError(".protocol.Message.chat: object expected");I.chat=$root.protocol.ChatMessage.fromObject(g.chat)}if(g.peers){if(!Array.isArray(g.peers))throw TypeError(".protocol.Message.peers: array expected");I.peers=[];for(var C=0;C<g.peers.length;++C){if("object"!=typeof g.peers[C])throw TypeError(".protocol.Message.peers: object expected");I.peers[C]=$root.protocol.Peer.fromObject(g.peers[C])}}if(g.entities){if(!Array.isArray(g.entities))throw TypeError(".protocol.Message.entities: array expected");I.entities=[];for(C=0;C<g.entities.length;++C){if("object"!=typeof g.entities[C])throw TypeError(".protocol.Message.entities: object expected");I.entities[C]=$root.protocol.Entity.fromObject(g.entities[C])}}if(g.chunks){if(!Array.isArray(g.chunks))throw TypeError(".protocol.Message.chunks: array expected");I.chunks=[];for(C=0;C<g.chunks.length;++C){if("object"!=typeof g.chunks[C])throw TypeError(".protocol.Message.chunks: object expected");I.chunks[C]=$root.protocol.Chunk.fromObject(g.chunks[C])}}if(g.events){if(!Array.isArray(g.events))throw TypeError(".protocol.Message.events: array expected");I.events=[];for(C=0;C<g.events.length;++C){if("object"!=typeof g.events[C])throw TypeError(".protocol.Message.events: object expected");I.events[C]=$root.protocol.Event.fromObject(g.events[C])}}if(g.updates){if(!Array.isArray(g.updates))throw TypeError(".protocol.Message.updates: array expected");I.updates=[];for(C=0;C<g.updates.length;++C){if("object"!=typeof g.updates[C])throw TypeError(".protocol.Message.updates: object expected");I.updates[C]=$root.protocol.Update.fromObject(g.updates[C])}}return I},g.toObject=function(g,I){I||(I={});var C={};if((I.arrays||I.defaults)&&(C.peers=[],C.entities=[],C.chunks=[],C.events=[],C.updates=[]),I.defaults&&(C.type=I.enums===String?"INIT":0,C.json="",C.text="",C.method=null,C.chat=null),null!=g.type&&g.hasOwnProperty("type")&&(C.type=I.enums===String?void 0===$root.protocol.Message.Type[g.type]?g.type:$root.protocol.Message.Type[g.type]:g.type),null!=g.json&&g.hasOwnProperty("json")&&(C.json=g.json),null!=g.text&&g.hasOwnProperty("text")&&(C.text=g.text),null!=g.method&&g.hasOwnProperty("method")&&(C.method=$root.protocol.Method.toObject(g.method,I)),null!=g.chat&&g.hasOwnProperty("chat")&&(C.chat=$root.protocol.ChatMessage.toObject(g.chat,I)),g.peers&&g.peers.length){C.peers=[];for(var A=0;A<g.peers.length;++A)C.peers[A]=$root.protocol.Peer.toObject(g.peers[A],I)}if(g.entities&&g.entities.length){C.entities=[];for(A=0;A<g.entities.length;++A)C.entities[A]=$root.protocol.Entity.toObject(g.entities[A],I)}if(g.chunks&&g.chunks.length){C.chunks=[];for(A=0;A<g.chunks.length;++A)C.chunks[A]=$root.protocol.Chunk.toObject(g.chunks[A],I)}if(g.events&&g.events.length){C.events=[];for(A=0;A<g.events.length;++A)C.events[A]=$root.protocol.Event.toObject(g.events[A],I)}if(g.updates&&g.updates.length){C.updates=[];for(A=0;A<g.updates.length;++A)C.updates[A]=$root.protocol.Update.toObject(g.updates[A],I)}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Message"},g.Type=(I={},(C=Object.create(I))[I[0]="INIT"]=0,C[I[1]="JOIN"]=1,C[I[2]="LEAVE"]=2,C[I[3]="ERROR"]=3,C[I[4]="PEER"]=4,C[I[5]="ENTITY"]=5,C[I[6]="LOAD"]=6,C[I[7]="UNLOAD"]=7,C[I[8]="UPDATE"]=8,C[I[9]="METHOD"]=9,C[I[10]="CHAT"]=10,C[I[11]="TRANSPORT"]=11,C[I[12]="EVENT"]=12,C[I[13]="ACTION"]=13,C[I[14]="STATS"]=14,C),g}(),g}(),$root.google=function(){var g,I,C,A={};return A.protobuf=((C={}).Struct=function(){function g(g){if(this.fields={},g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.fields=$util.emptyObject,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=$Writer.create()),null!=g.fields&&Object.hasOwnProperty.call(g,"fields"))for(var C=Object.keys(g.fields),A=0;A<C.length;++A)I.uint32(10).fork().uint32(10).string(C[A]),$root.google.protobuf.Value.encode(g.fields[C[A]],I.uint32(18).fork()).ldelim().ldelim();return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C,A,t=void 0===I?g.len:g.pos+I,e=new $root.google.protobuf.Struct;g.pos<t;){var o=g.uint32();if(o>>>3==1){e.fields===$util.emptyObject&&(e.fields={});var i=g.uint32()+g.pos;for(C="",A=null;g.pos<i;){var l=g.uint32();switch(l>>>3){case 1:C=g.string();break;case 2:A=$root.google.protobuf.Value.decode(g,g.uint32());break;default:g.skipType(7&l)}}e.fields[C]=A}else g.skipType(7&o)}return e},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.fields&&g.hasOwnProperty("fields")){if(!$util.isObject(g.fields))return"fields: object expected";for(var I=Object.keys(g.fields),C=0;C<I.length;++C){var A=$root.google.protobuf.Value.verify(g.fields[I[C]]);if(A)return"fields."+A}}return null},g.fromObject=function(g){if(g instanceof $root.google.protobuf.Struct)return g;var I=new $root.google.protobuf.Struct;if(g.fields){if("object"!=typeof g.fields)throw TypeError(".google.protobuf.Struct.fields: object expected");I.fields={};for(var C=Object.keys(g.fields),A=0;A<C.length;++A){if("object"!=typeof g.fields[C[A]])throw TypeError(".google.protobuf.Struct.fields: object expected");I.fields[C[A]]=$root.google.protobuf.Value.fromObject(g.fields[C[A]])}}return I},g.toObject=function(g,I){I||(I={});var C,A={};if((I.objects||I.defaults)&&(A.fields={}),g.fields&&(C=Object.keys(g.fields)).length){A.fields={};for(var t=0;t<C.length;++t)A.fields[C[t]]=$root.google.protobuf.Value.toObject(g.fields[C[t]],I)}return A},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/google.protobuf.Struct"},g}(),C.Value=function(){function g(g){if(g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}var I;return g.prototype.nullValue=null,g.prototype.numberValue=null,g.prototype.stringValue=null,g.prototype.boolValue=null,g.prototype.structValue=null,g.prototype.listValue=null,Object.defineProperty(g.prototype,"kind",{get:$util.oneOfGetter(I=["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]),set:$util.oneOfSetter(I)}),g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=$Writer.create()),null!=g.nullValue&&Object.hasOwnProperty.call(g,"nullValue")&&I.uint32(8).int32(g.nullValue),null!=g.numberValue&&Object.hasOwnProperty.call(g,"numberValue")&&I.uint32(17).double(g.numberValue),null!=g.stringValue&&Object.hasOwnProperty.call(g,"stringValue")&&I.uint32(26).string(g.stringValue),null!=g.boolValue&&Object.hasOwnProperty.call(g,"boolValue")&&I.uint32(32).bool(g.boolValue),null!=g.structValue&&Object.hasOwnProperty.call(g,"structValue")&&$root.google.protobuf.Struct.encode(g.structValue,I.uint32(42).fork()).ldelim(),null!=g.listValue&&Object.hasOwnProperty.call(g,"listValue")&&$root.google.protobuf.ListValue.encode(g.listValue,I.uint32(50).fork()).ldelim(),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.google.protobuf.Value;g.pos<C;){var t=g.uint32();switch(t>>>3){case 1:A.nullValue=g.int32();break;case 2:A.numberValue=g.double();break;case 3:A.stringValue=g.string();break;case 4:A.boolValue=g.bool();break;case 5:A.structValue=$root.google.protobuf.Struct.decode(g,g.uint32());break;case 6:A.listValue=$root.google.protobuf.ListValue.decode(g,g.uint32());break;default:g.skipType(7&t)}}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";var I={};if(null!=g.nullValue&&g.hasOwnProperty("nullValue")&&(I.kind=1,0!==g.nullValue))return"nullValue: enum value expected";if(null!=g.numberValue&&g.hasOwnProperty("numberValue")){if(1===I.kind)return"kind: multiple values";if(I.kind=1,"number"!=typeof g.numberValue)return"numberValue: number expected"}if(null!=g.stringValue&&g.hasOwnProperty("stringValue")){if(1===I.kind)return"kind: multiple values";if(I.kind=1,!$util.isString(g.stringValue))return"stringValue: string expected"}if(null!=g.boolValue&&g.hasOwnProperty("boolValue")){if(1===I.kind)return"kind: multiple values";if(I.kind=1,"boolean"!=typeof g.boolValue)return"boolValue: boolean expected"}if(null!=g.structValue&&g.hasOwnProperty("structValue")){if(1===I.kind)return"kind: multiple values";if(I.kind=1,C=$root.google.protobuf.Struct.verify(g.structValue))return"structValue."+C}if(null!=g.listValue&&g.hasOwnProperty("listValue")){if(1===I.kind)return"kind: multiple values";var C;if(I.kind=1,C=$root.google.protobuf.ListValue.verify(g.listValue))return"listValue."+C}return null},g.fromObject=function(g){if(g instanceof $root.google.protobuf.Value)return g;var I=new $root.google.protobuf.Value;switch(g.nullValue){default:if("number"==typeof g.nullValue){I.nullValue=g.nullValue;break}break;case"NULL_VALUE":case 0:I.nullValue=0}if(null!=g.numberValue&&(I.numberValue=Number(g.numberValue)),null!=g.stringValue&&(I.stringValue=String(g.stringValue)),null!=g.boolValue&&(I.boolValue=Boolean(g.boolValue)),null!=g.structValue){if("object"!=typeof g.structValue)throw TypeError(".google.protobuf.Value.structValue: object expected");I.structValue=$root.google.protobuf.Struct.fromObject(g.structValue)}if(null!=g.listValue){if("object"!=typeof g.listValue)throw TypeError(".google.protobuf.Value.listValue: object expected");I.listValue=$root.google.protobuf.ListValue.fromObject(g.listValue)}return I},g.toObject=function(g,I){I||(I={});var C={};return null!=g.nullValue&&g.hasOwnProperty("nullValue")&&(C.nullValue=I.enums===String?void 0===$root.google.protobuf.NullValue[g.nullValue]?g.nullValue:$root.google.protobuf.NullValue[g.nullValue]:g.nullValue,I.oneofs&&(C.kind="nullValue")),null!=g.numberValue&&g.hasOwnProperty("numberValue")&&(C.numberValue=I.json&&!isFinite(g.numberValue)?String(g.numberValue):g.numberValue,I.oneofs&&(C.kind="numberValue")),null!=g.stringValue&&g.hasOwnProperty("stringValue")&&(C.stringValue=g.stringValue,I.oneofs&&(C.kind="stringValue")),null!=g.boolValue&&g.hasOwnProperty("boolValue")&&(C.boolValue=g.boolValue,I.oneofs&&(C.kind="boolValue")),null!=g.structValue&&g.hasOwnProperty("structValue")&&(C.structValue=$root.google.protobuf.Struct.toObject(g.structValue,I),I.oneofs&&(C.kind="structValue")),null!=g.listValue&&g.hasOwnProperty("listValue")&&(C.listValue=$root.google.protobuf.ListValue.toObject(g.listValue,I),I.oneofs&&(C.kind="listValue")),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/google.protobuf.Value"},g}(),C.NullValue=(g={},(I=Object.create(g))[g[0]="NULL_VALUE"]=0,I),C.ListValue=function(){function g(g){if(this.values=[],g)for(var I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.values=$util.emptyArray,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=$Writer.create()),null!=g.values&&g.values.length)for(var C=0;C<g.values.length;++C)$root.google.protobuf.Value.encode(g.values[C],I.uint32(10).fork()).ldelim();return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof $Reader||(g=$Reader.create(g));for(var C=void 0===I?g.len:g.pos+I,A=new $root.google.protobuf.ListValue;g.pos<C;){var t=g.uint32();t>>>3==1?(A.values&&A.values.length||(A.values=[]),A.values.push($root.google.protobuf.Value.decode(g,g.uint32()))):g.skipType(7&t)}return A},g.decodeDelimited=function(g){return g instanceof $Reader||(g=new $Reader(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.values&&g.hasOwnProperty("values")){if(!Array.isArray(g.values))return"values: array expected";for(var I=0;I<g.values.length;++I){var C=$root.google.protobuf.Value.verify(g.values[I]);if(C)return"values."+C}}return null},g.fromObject=function(g){if(g instanceof $root.google.protobuf.ListValue)return g;var I=new $root.google.protobuf.ListValue;if(g.values){if(!Array.isArray(g.values))throw TypeError(".google.protobuf.ListValue.values: array expected");I.values=[];for(var C=0;C<g.values.length;++C){if("object"!=typeof g.values[C])throw TypeError(".google.protobuf.ListValue.values: object expected");I.values[C]=$root.google.protobuf.Value.fromObject(g.values[C])}}return I},g.toObject=function(g,I){I||(I={});var C={};if((I.arrays||I.defaults)&&(C.values=[]),g.values&&g.values.length){C.values=[];for(var A=0;A<g.values.length;++A)C.values[A]=$root.google.protobuf.Value.toObject(g.values[A],I)}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/google.protobuf.ListValue"},g}(),C),A}();var protocol=$root;function encodeObjectToStruct(g,I){if(void 0===I&&(I=new Set),"object"!=typeof g||null===g)return encodeStructValue(g,I);const C={fields:{}};I.add(g);for(const A in g)if(g.hasOwnProperty(A)){const t=g[A];if(void 0===t)continue;C.fields[A]=encodeStructValue(t,I)}return I.delete(g),C}function encodeStructValue(g,I){if(null==g)return{nullValue:0};if("number"==typeof g)return{numberValue:g};if("string"==typeof g)return{stringValue:g};if("boolean"==typeof g)return{boolValue:g};if(Array.isArray(g))return{listValue:{values:g.map((g=>encodeStructValue(g,I)))}};if("object"==typeof g)return I.has(g)?(console.warn("Circular object detected"),{stringValue:"[Circular]"}):{structValue:encodeObjectToStruct(g,I)};throw new Error("Unknown type: "+typeof g)}function _defineProperty$e(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}const{google:google}=protocol;class Events extends Map{constructor(){var g;super(),g=this,_defineProperty$e(this,"packets",[]),_defineProperty$e(this,"onMessage",(g=>{if("EVENT"!==g.type);else{const{events:I}=g;I.forEach((g=>{this.handle(g.name,g.payload)}))}})),_defineProperty$e(this,"addEventListener",((g,I)=>{this.on(g,I)})),_defineProperty$e(this,"on",((g,I)=>{this.has(g)?console.warn(`Registering handler for ${g} canceled: handler already exists.`):this.set(g,I)})),_defineProperty$e(this,"emit",(function(I,C){void 0===C&&(C={}),g.packets.push({type:"EVENT",events:[{name:I,payload:encodeObjectToStruct(C)}]})})),_defineProperty$e(this,"emitMany",(g=>{this.packets.push({type:"EVENT",events:g.map((g=>({name:g.name,payload:google.protobuf.Struct.fromObject(g.payload||{})})))})})),_defineProperty$e(this,"handle",((g,I)=>{const C=this.get(g);C&&C(I)}))}}function _defineProperty$d(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Entity extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{constructor(g){super(),_defineProperty$d(this,"entId",void 0),_defineProperty$d(this,"onCreate",void 0),_defineProperty$d(this,"onUpdate",void 0),_defineProperty$d(this,"onDelete",void 0),this.entId=g}}class Entities extends three__WEBPACK_IMPORTED_MODULE_0__.ZAu{constructor(){super(...arguments),_defineProperty$d(this,"map",new Map),_defineProperty$d(this,"types",new Map),_defineProperty$d(this,"setClass",((g,I)=>{this.types.set(g.toLowerCase(),I)})),_defineProperty$d(this,"onMessage",(g=>{const{entities:I}=g;I&&I.length&&I.forEach((g=>{const{id:I,type:C,metadata:A,operation:t}=g;let e=this.map.get(I);switch(t){case"CREATE":var o;if(e)return;e=this.createEntityOfType(C,I),null===(o=e.onCreate)||void 0===o||o.call(e,A);break;case"UPDATE":var i,l;if(!e)e=this.createEntityOfType(C,I),null===(l=e.onCreate)||void 0===l||l.call(e,A);null===(i=e.onUpdate)||void 0===i||i.call(e,A);break;case"DELETE":var c,n;if(!e)return void console.warn(`Entity ${I} does not exist.`);this.map.delete(I),null===(c=e.parent)||void 0===c||c.remove(e),null===(n=e.onDelete)||void 0===n||n.call(e,A)}}))})),_defineProperty$d(this,"createEntityOfType",((g,I)=>{if(!this.types.has(g))return void console.warn(`Entity type ${g} is not registered.`);const C=new(this.types.get(g.toLowerCase()))(I);return this.map.set(I,C),this.add(C),C}))}}var events={exports:{}},R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(g,I,C){return Function.prototype.apply.call(g,I,C)},ReflectOwnKeys;function ProcessEmitWarning(g){console&&console.warn&&console.warn(g)}ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:function(g){return Object.getOwnPropertyNames(g)};var NumberIsNaN=Number.isNaN||function(g){return g!=g};function EventEmitter(){EventEmitter.init.call(this)}events.exports=EventEmitter,events.exports.once=once,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(g){if("function"!=typeof g)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof g)}function _getMaxListeners(g){return void 0===g._maxListeners?EventEmitter.defaultMaxListeners:g._maxListeners}function _addListener(g,I,C,A){var t,e,o;if(checkListener(C),void 0===(e=g._events)?(e=g._events=Object.create(null),g._eventsCount=0):(void 0!==e.newListener&&(g.emit("newListener",I,C.listener?C.listener:C),e=g._events),o=e[I]),void 0===o)o=e[I]=C,++g._eventsCount;else if("function"==typeof o?o=e[I]=A?[C,o]:[o,C]:A?o.unshift(C):o.push(C),(t=_getMaxListeners(g))>0&&o.length>t&&!o.warned){o.warned=!0;var i=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(I)+" listeners added. Use emitter.setMaxListeners() to increase limit");i.name="MaxListenersExceededWarning",i.emitter=g,i.type=I,i.count=o.length,ProcessEmitWarning(i)}return g}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(g,I,C){var A={fired:!1,wrapFn:void 0,target:g,type:I,listener:C},t=onceWrapper.bind(A);return t.listener=C,A.wrapFn=t,t}function _listeners(g,I,C){var A=g._events;if(void 0===A)return[];var t=A[I];return void 0===t?[]:"function"==typeof t?C?[t.listener||t]:[t]:C?unwrapListeners(t):arrayClone(t,t.length)}function listenerCount(g){var I=this._events;if(void 0!==I){var C=I[g];if("function"==typeof C)return 1;if(void 0!==C)return C.length}return 0}function arrayClone(g,I){for(var C=new Array(I),A=0;A<I;++A)C[A]=g[A];return C}function spliceOne(g,I){for(;I+1<g.length;I++)g[I]=g[I+1];g.pop()}function unwrapListeners(g){for(var I=new Array(g.length),C=0;C<I.length;++C)I[C]=g[C].listener||g[C];return I}function once(g,I){return new Promise((function(C,A){function t(C){g.removeListener(I,e),A(C)}function e(){"function"==typeof g.removeListener&&g.removeListener("error",t),C([].slice.call(arguments))}eventTargetAgnosticAddListener(g,I,e,{once:!0}),"error"!==I&&addErrorHandlerIfEventEmitter(g,t,{once:!0})}))}function addErrorHandlerIfEventEmitter(g,I,C){"function"==typeof g.on&&eventTargetAgnosticAddListener(g,"error",I,C)}function eventTargetAgnosticAddListener(g,I,C,A){if("function"==typeof g.on)A.once?g.once(I,C):g.on(I,C);else{if("function"!=typeof g.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof g);g.addEventListener(I,(function t(e){A.once&&g.removeEventListener(I,t),C(e)}))}}function _defineProperty$c(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$3(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$c(g,I,C[I])}))}return g}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(g){if("number"!=typeof g||g<0||NumberIsNaN(g))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+g+".");defaultMaxListeners=g}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(g){if("number"!=typeof g||g<0||NumberIsNaN(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this},EventEmitter.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function(g){for(var I=[],C=1;C<arguments.length;C++)I.push(arguments[C]);var A="error"===g,t=this._events;if(void 0!==t)A=A&&void 0===t.error;else if(!A)return!1;if(A){var e;if(I.length>0&&(e=I[0]),e instanceof Error)throw e;var o=new Error("Unhandled error."+(e?" ("+e.message+")":""));throw o.context=e,o}var i=t[g];if(void 0===i)return!1;if("function"==typeof i)ReflectApply(i,this,I);else{var l=i.length,c=arrayClone(i,l);for(C=0;C<l;++C)ReflectApply(c[C],this,I)}return!0},EventEmitter.prototype.addListener=function(g,I){return _addListener(this,g,I,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(g,I){return _addListener(this,g,I,!0)},EventEmitter.prototype.once=function(g,I){return checkListener(I),this.on(g,_onceWrap(this,g,I)),this},EventEmitter.prototype.prependOnceListener=function(g,I){return checkListener(I),this.prependListener(g,_onceWrap(this,g,I)),this},EventEmitter.prototype.removeListener=function(g,I){var C,A,t,e,o;if(checkListener(I),void 0===(A=this._events))return this;if(void 0===(C=A[g]))return this;if(C===I||C.listener===I)0==--this._eventsCount?this._events=Object.create(null):(delete A[g],A.removeListener&&this.emit("removeListener",g,C.listener||I));else if("function"!=typeof C){for(t=-1,e=C.length-1;e>=0;e--)if(C[e]===I||C[e].listener===I){o=C[e].listener,t=e;break}if(t<0)return this;0===t?C.shift():spliceOne(C,t),1===C.length&&(A[g]=C[0]),void 0!==A.removeListener&&this.emit("removeListener",g,o||I)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(g){var I,C,A;if(void 0===(C=this._events))return this;if(void 0===C.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==C[g]&&(0==--this._eventsCount?this._events=Object.create(null):delete C[g]),this;if(0===arguments.length){var t,e=Object.keys(C);for(A=0;A<e.length;++A)"removeListener"!==(t=e[A])&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(I=C[g]))this.removeListener(g,I);else if(void 0!==I)for(A=I.length-1;A>=0;A--)this.removeListener(g,I[A]);return this},EventEmitter.prototype.listeners=function(g){return _listeners(this,g,!0)},EventEmitter.prototype.rawListeners=function(g){return _listeners(this,g,!1)},EventEmitter.listenerCount=function(g,I){return"function"==typeof g.listenerCount?g.listenerCount(I):listenerCount.call(g,I)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};const PI_2=Math.PI/2,emptyQ=new three__WEBPACK_IMPORTED_MODULE_0__._fP;function rotateY(g,I,C){const A=I[0],t=I[2],e=g[0]-A,o=g[2]-t,i=Math.sin(C),l=Math.cos(C),c=[0,0,0];return c[0]=A+o*i+e*l,c[1]=g[1],c[2]=t+o*l-e*i,c}const defaultControlState={heading:0,running:!1,jumping:!1,sprinting:!1,crouching:!1,jumpCount:0,isJumping:!1,currentJumpTime:0},defaultOptions$2={sensitivity:100,minPolarAngle:.01*Math.PI,maxPolarAngle:.99*Math.PI,initialPosition:[0,80,10],rotationLerp:.9,positionLerp:1,stepLerp:.6,bodyWidth:.8,bodyHeight:1.55,bodyDepth:.8,eyeHeight:.9193548387096774,maxSpeed:6,moveForce:30,responsiveness:240,runningFriction:.1,standingFriction:4,flySpeed:40,flyForce:80,flyImpulse:2.5,flyInertia:6,sprintFactor:1.4,crouchFactor:.6,alwaysSprint:!1,airMoveMult:.7,fluidPushForce:.3,jumpImpulse:8,jumpForce:1,jumpTime:50,airJumps:0,stepHeight:.5};class RigidControls extends events.exports.EventEmitter{on(g,I){return super.on(g,I)}get ghostMode(){return this.body.aabb.width<=0}get flyMode(){return 0===this.body.gravityMultiplier&&!this.ghostMode}get voxel(){const[g,I,C]=this.body.getPosition();return ChunkUtils.mapWorldToVoxel([g,I-.5*this.options.bodyHeight,C])}get position(){const g=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(...this.body.getPosition());return g.y-=.5*this.options.bodyHeight,g}get chunk(){return ChunkUtils.mapVoxelToChunk(this.voxel,this.world.options.chunkSize)}constructor(g,I,C,A){var t;if(void 0===A&&(A={}),super(),t=this,_defineProperty$c(this,"options",void 0),_defineProperty$c(this,"camera",void 0),_defineProperty$c(this,"inputs",void 0),_defineProperty$c(this,"world",void 0),_defineProperty$c(this,"character",void 0),_defineProperty$c(this,"domElement",void 0),_defineProperty$c(this,"object",new three__WEBPACK_IMPORTED_MODULE_0__.ZAu),_defineProperty$c(this,"state",void 0),_defineProperty$c(this,"isLocked",!1),_defineProperty$c(this,"body",void 0),_defineProperty$c(this,"movements",{up:!1,down:!1,left:!1,right:!1,front:!1,back:!1,sprint:!1}),_defineProperty$c(this,"lockCallback",void 0),_defineProperty$c(this,"unlockCallback",void 0),_defineProperty$c(this,"euler",new three__WEBPACK_IMPORTED_MODULE_0__.USm(0,0,0,"YXZ")),_defineProperty$c(this,"quaternion",new three__WEBPACK_IMPORTED_MODULE_0__._fP),_defineProperty$c(this,"vector",new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),_defineProperty$c(this,"newPosition",new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),_defineProperty$c(this,"justUnlocked",!1),_defineProperty$c(this,"clock",new three__WEBPACK_IMPORTED_MODULE_0__.SUY),_defineProperty$c(this,"onMessage",(g=>{switch(g.type){case"EVENT":{const{events:I}=g;for(const g of I)if("position"===g.name.toLowerCase())this.body.setPosition(g.payload);break}}})),_defineProperty$c(this,"update",(()=>{const g=Math.min(.1,this.clock.getDelta());if(this.object.quaternion.slerp(this.quaternion,this.options.rotationLerp),this.object.position.lerp(this.newPosition,this.options.positionLerp),this.character){const{x:g,y:I,z:C}=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,0,-1).applyQuaternion(this.object.getWorldQuaternion(emptyQ)).normalize(),A=this.object.position.toArray();this.character.set(A,[g,I,C]),this.character.update()}this.moveRigidBody(),this.updateRigidBody(g)})),_defineProperty$c(this,"connect",(function(g,I){void 0===I&&(I="*");const C=[];return t.domElement.addEventListener("mousemove",(g=>{t.onMouseMove(g)})),t.domElement.ownerDocument.addEventListener("pointerlockchange",(()=>{t.onPointerlockChange()})),t.domElement.ownerDocument.addEventListener("pointerlockerror",t.onPointerlockError),t.domElement.addEventListener("click",t.onDocumentClick),C.push((()=>{t.domElement.removeEventListener("mousemove",(g=>{t.onMouseMove(g)})),t.domElement.ownerDocument.removeEventListener("pointerlockchange",(()=>{t.onPointerlockChange()})),t.domElement.ownerDocument.removeEventListener("pointerlockerror",t.onPointerlockError),t.domElement.removeEventListener("click",t.onDocumentClick)})),[["r","sprint"],["w","front"],["a","left"],["s","back"],["d","right"],[" ","up"],["shift","down"]].forEach((A=>{let[e,o]=A;C.push(g.bind(e,(()=>{t.isLocked&&(t.movements[o]=!0)}),I,{identifier:RigidControls.INPUT_IDENTIFIER})),C.push(g.bind(e,(()=>{t.isLocked&&(t.movements[o]=!1)}),I,{occasion:"keyup",identifier:RigidControls.INPUT_IDENTIFIER}))})),t.inputs=g,()=>{C.forEach((g=>{try{g()}catch(I){}}))}})),_defineProperty$c(this,"getDirection",(()=>new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(0,0,-1).applyQuaternion(this.object.quaternion).normalize())),_defineProperty$c(this,"lock",(g=>{this.domElement.requestPointerLock(),g&&(this.lockCallback=g)})),_defineProperty$c(this,"unlock",(g=>{this.domElement.ownerDocument.exitPointerLock(),g&&(this.unlockCallback=g)})),_defineProperty$c(this,"teleport",((g,I,C)=>{const{bodyHeight:A,eyeHeight:t}=this.options;this.newPosition.set(g+.5,I+A*t+1,C+.5),this.body&&this.body.setPosition([g+.5,I+A/2+1,C+.5])})),_defineProperty$c(this,"teleportToTop",((g,I)=>{if(void 0===g||void 0===I){const{x:g,z:I}=this.object.position,C=this.world.getMaxHeightAt(g,I);return void this.teleport(Math.floor(g),C,Math.floor(I))}const[C,A]=ChunkUtils.mapVoxelToChunk([g,0,I],this.world.options.chunkSize);this.teleport(g,0,I),this.world.addChunkInitListener([C,A],(()=>{const C=this.world.getMaxHeightAt(g,I);this.teleport(Math.floor(g),C,Math.floor(I))}))})),_defineProperty$c(this,"lookAt",((g,I,C)=>{const A=this.object.position.clone().add(this.object.position.clone().sub(new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(g,I,C)));this.object.lookAt(A)})),_defineProperty$c(this,"resetMovements",(()=>{this.movements={sprint:!1,front:!1,back:!1,left:!1,right:!1,down:!1,up:!1}})),_defineProperty$c(this,"toggleGhostMode",(()=>{const{aabb:g}=this.body,[I,C,A]=this.body.getPosition(),{bodyWidth:t,bodyHeight:e,bodyDepth:o}=this.options;if(this.ghostMode)g.minX=I-t/2,g.minY=C-e/2,g.minZ=A-o/2,g.maxX=g.minX+t,g.maxY=g.minY+e,g.maxZ=g.minZ+o,this.body.gravityMultiplier=1;else{const I=(g.minX+g.maxX)/2,C=(g.minY+g.maxY)/2,A=(g.minZ+g.maxZ)/2;g.minX=I+1,g.maxX=I-1,g.minY=C+1,g.maxY=C-1,g.minZ=A+1,g.maxZ=A-1,this.body.gravityMultiplier=0}})),_defineProperty$c(this,"toggleFly",(()=>{if(!this.ghostMode){const g=0===this.body.gravityMultiplier;g||this.body.applyImpulse([0,8,0]),setTimeout((()=>{this.body.gravityMultiplier=g?1:0}),100)}})),_defineProperty$c(this,"reset",(()=>{this.teleport(...this.options.initialPosition),this.object.rotation.set(0,0,0),this.resetMovements()})),_defineProperty$c(this,"moveForward",(g=>{this.vector.setFromMatrixColumn(this.object.matrix,0),this.vector.crossVectors(this.object.up,this.vector),this.object.position.addScaledVector(this.vector,g)})),_defineProperty$c(this,"moveRight",(g=>{this.vector.setFromMatrixColumn(this.object.matrix,0),this.object.position.addScaledVector(this.vector,g)})),_defineProperty$c(this,"attachCharacter",(function(g,I){void 0===I&&(I=1),g instanceof Character?(g.options.positionLerp=I,t.options.bodyHeight=g.totalHeight,t.options.bodyWidth=g.body.width,t.options.bodyDepth=g.body.depth,t.options.eyeHeight=g.eyeHeight/g.totalHeight,t.body.aabb.maxX=t.body.aabb.minX+t.options.bodyWidth,t.body.aabb.maxY=t.body.aabb.minY+t.options.bodyHeight,t.body.aabb.maxZ=t.body.aabb.minZ+t.options.bodyDepth,t.character=g):console.warn("Character not attached: not a default character.")})),_defineProperty$c(this,"moveRigidBody",(()=>{const{object:g,state:I}=this,{sprint:C,right:A,left:t,up:e,down:o,front:i,back:l}=this.movements,c=i?l?0:1:l?-1:0,n=t?A?0:1:A?-1:0,d=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4;d.setFromMatrixColumn(g.matrix,0),d.crossVectors(g.up,d);const{x:s,z:Z}=d;d.setFromMatrixColumn(g.matrix,0);const{x:b,z:a}=d,m=s+b,r=Z+a;let h=Math.atan2(m,r);0==(c|n)?(I.running=!1,I.sprinting&&(this.movements.sprint=!1,I.sprinting=!1)):(I.running=!0,c?(-1===c&&(h+=Math.PI),n&&(h+=Math.PI/4*c*n)):h+=n*Math.PI/2,I.heading=h+Math.PI/4),I.jumping=e,I.crouching=o,I.sprinting=!!this.options.alwaysSprint||C,this.ghostMode||0===this.body.gravityMultiplier&&-1===this.body.atRestY&&(this.body.gravityMultiplier=1)})),_defineProperty$c(this,"updateRigidBody",(g=>{const{airJumps:I,jumpForce:C,jumpTime:A,jumpImpulse:t,maxSpeed:e,sprintFactor:o,crouchFactor:i,moveForce:l,airMoveMult:c,responsiveness:n,runningFriction:d,standingFriction:s,flyInertia:Z,flyImpulse:b,flyForce:a,flySpeed:m,fluidPushForce:r}=this.options;if(this.body.gravityMultiplier){const Z=this.body.atRestY<0,b=Z||this.state.jumpCount<I;if(Z&&(this.state.isJumping=!1,this.state.jumpCount=0),this.state.jumping)if(this.state.isJumping){if(this.state.currentJumpTime>0){let I=C;this.state.currentJumpTime<g&&(I*=this.state.currentJumpTime/g),this.body.applyForce([0,I,0]),this.state.currentJumpTime-=g}}else b?(this.state.isJumping=!0,Z||this.state.jumpCount++,this.state.currentJumpTime=A,this.body.applyImpulse([0,t,0]),!Z&&this.body.velocity[1]<0&&(this.body.velocity[1]=0)):this.body.ratioInFluid>0&&this.body.applyImpulse([0,r,0]);else this.state.isJumping=!1;let a=[0,0,0],m=[0,0,0];if(this.state.running){let g=e;this.state.sprinting&&(g*=o),this.state.crouching&&(g*=i),a[2]=g,a=rotateY(a,[0,0,0],this.state.heading),m=[a[0]-this.body.velocity[0],a[1]-this.body.velocity[1],a[2]-this.body.velocity[2]],m[1]=0;const I=Math.sqrt(m[0]**2+m[1]**2+m[2]**2);if(m[0]/=I,m[1]/=I,m[2]/=I,I>0){let g=l;Z||(g*=c);const C=n*I;g>C&&(g=C),m[0]*=g,m[1]*=g,m[2]*=g,this.body.applyForce(m)}this.body.friction=d}else this.body.friction=s}else{this.body.velocity[0]-=this.body.velocity[0]*Z*g,this.body.velocity[1]-=this.body.velocity[1]*Z*g,this.body.velocity[2]-=this.body.velocity[2]*Z*g,this.state.jumping&&this.body.applyImpulse([0,b,0]),this.state.crouching&&this.body.applyImpulse([0,-b,0]);let I=[0,0,0],C=[0,0,0];if(this.state.running){let g=m;this.state.sprinting&&(g*=o),this.state.crouching&&(g*=i),I[2]=g,I=rotateY(I,[0,0,0],this.state.heading),C=[I[0]-this.body.velocity[0],I[1]-this.body.velocity[1],I[2]-this.body.velocity[2]],C[1]=0;const A=Math.sqrt(C[0]**2+C[1]**2+C[2]**2);if(C[0]/=A,C[1]/=A,C[2]/=A,A>0){let g=a;const I=n*A;g>I&&(g=I),C[0]*=g,C[1]*=g,C[2]*=g,this.body.applyForce(C)}this.body.friction=d}else this.body.friction=s}const[h,B,G]=this.body.getPosition(),{eyeHeight:W,bodyHeight:u}=this.options;this.newPosition.set(h,B+u*(W-.5),G)})),_defineProperty$c(this,"onMouseMove",(g=>{if(!1===this.isLocked)return;if(this.justUnlocked)return void(this.justUnlocked=!1);const I=g.movementX||0,C=g.movementY||0;this.euler.setFromQuaternion(this.quaternion),this.euler.y-=I*this.options.sensitivity*.002/100,this.euler.x-=C*this.options.sensitivity*.002/100,this.euler.x=Math.max(PI_2-this.options.maxPolarAngle,Math.min(PI_2-this.options.minPolarAngle,this.euler.x)),this.quaternion.setFromEuler(this.euler)})),_defineProperty$c(this,"onPointerlockChange",(()=>{this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.onLock(),this.lockCallback&&(this.lockCallback(),this.lockCallback=void 0),this.isLocked=!0):(this.onUnlock(),this.unlockCallback&&(this.unlockCallback(),this.unlockCallback=void 0),this.isLocked=!1)})),_defineProperty$c(this,"onPointerlockError",(()=>{console.error("VOXELIZE.RigidControls: Unable to use Pointer Lock API")})),_defineProperty$c(this,"onDocumentClick",(()=>{this.isLocked||this.lock()})),_defineProperty$c(this,"onLock",(()=>{this.emit("lock")})),_defineProperty$c(this,"onUnlock",(()=>{this.emit("unlock"),this.justUnlocked=!0})),!g)throw new Error("RigidControls: Camera is required.");if(!I)throw new Error("RigidControls: DOM Element is required.");if(!C)throw new Error("RigidControls: World is required.");this.camera=g,this.world=C,this.domElement=I,this.state=defaultControlState;const{bodyWidth:e,bodyHeight:o,bodyDepth:i}=this.options=_objectSpread$3({},defaultOptions$2,A);this.object.add(this.camera),this.world.add(this.object),this.body=C.physics.addBody({aabb:new AABB(0,0,0,e,o,i),onStep:g=>{const{positionLerp:I,stepLerp:C}=this.options;this.options.positionLerp=C,this.body.aabb=g.clone();const A=setTimeout((()=>{this.options.positionLerp=I,clearTimeout(A)}),500)},stepHeight:this.options.stepHeight}),this.teleport(...this.options.initialPosition)}}_defineProperty$c(RigidControls,"INPUT_IDENTIFIER","voxelize-rigid-controls");var RigidBody=class{get atRestX(){return this.resting[0]}get atRestY(){return this.resting[1]}get atRestZ(){return this.resting[2]}constructor(g,I,C,A,t,e,o,i){this.aabb=g,this.mass=I,this.friction=C,this.restitution=A,this.gravityMultiplier=t,this.stepHeight=e,this.onStep=o,this.onCollide=i,this.resting=[0,0,0],this.velocity=[0,0,0],this.inFluid=!1,this.ratioInFluid=0,this.forces=[0,0,0],this.impulses=[0,0,0],this.sleepFrameCount=10,this.setPosition=g=>{this.aabb.setPosition([g[0]-this.aabb.width/2,g[1]-this.aabb.height/2,g[2]-this.aabb.depth/2]),this.markActive()},this.getPosition=()=>[this.aabb.minX+this.aabb.width/2,this.aabb.minY+this.aabb.height/2,this.aabb.minZ+this.aabb.depth/2],this.applyForce=g=>{this.forces[0]+=g[0],this.forces[1]+=g[1],this.forces[2]+=g[2],this.markActive()},this.applyImpulse=g=>{this.impulses[0]+=g[0],this.impulses[1]+=g[1],this.impulses[2]+=g[2],this.markActive()},this.markActive=()=>{this.sleepFrameCount=10},this.airDrag=-1,this.fluidDrag=-1}};function lineToPlane(g,I,C){const[A,t,e]=g,[o,i,l]=I,[c,n,d]=C,s=c*A+n*t+d*e;return 0===s?1/0:(c*o+n*i+d*l)/s}function between(g,I,C){return g>=I&&g<=C}function sweepAABB(g,I,C){const A=I.minX-g.maxX,t=I.minY-g.maxY,e=I.minZ-g.maxZ,o=g.width+I.width,i=g.height+I.height,l=g.depth+I.depth,[c,n,d]=C;let s=1,Z=0,b=0,a=0,m=0;return Z=lineToPlane(C,[A,t,e],[-1,0,0]),Z>=0&&c>0&&Z<s&&between(Z*n,t,t+i)&&between(Z*d,e,e+l)&&(s=Z,b=-1,a=0,m=0),Z=lineToPlane(C,[A+o,t,e],[1,0,0]),Z>=0&&c<0&&Z<s&&between(Z*n,t,t+i)&&between(Z*d,e,e+l)&&(s=Z,b=1,a=0,m=0),Z=lineToPlane(C,[A,t,e],[0,-1,0]),Z>=0&&n>0&&Z<s&&between(Z*c,A,A+o)&&between(Z*d,e,e+l)&&(s=Z,b=0,a=-1,m=0),Z=lineToPlane(C,[A,t+i,e],[0,1,0]),Z>=0&&n<0&&Z<s&&between(Z*c,A,A+o)&&between(Z*d,e,e+l)&&(s=Z,b=0,a=1,m=0),Z=lineToPlane(C,[A,t,e],[0,0,-1]),Z>=0&&d>0&&Z<s&&between(Z*c,A,A+o)&&between(Z*n,t,t+i)&&(s=Z,b=0,a=0,m=-1),Z=lineToPlane(C,[A,t,e+l],[0,0,1]),Z>=0&&d<0&&Z<s&&between(Z*c,A,A+o)&&between(Z*n,t,t+i)&&(s=Z,b=0,a=0,m=1),{h:s,nx:b,ny:a,nz:m}}function sweep(g,I,C,A,t,e){if(void 0===t&&(t=!0),void 0===e&&(e=100),e<=0)return;const[o,i,l]=C,c=Math.sqrt(o*o+i*i+l*l),n=Math.floor(o>0?I.minX:I.minX+o)-1,d=Math.floor(i>0?I.minY:I.minY+i)-1,s=Math.floor(l>0?I.minZ:I.minZ+l)-1,Z=Math.floor(o>0?I.maxX+o:I.maxX)+1,b=Math.floor(i>0?I.maxY+i:I.maxY)+1,a=Math.floor(l>0?I.maxZ+l:I.maxZ)+1;let m=[],r={h:1,nx:0,ny:0,nz:0};for(let p=n;p<=Z;p++)for(let A=s;A<=a;A++)for(let t=d;t<=b;t++){const e=g(p,t,A);for(const g of e){const e=sweepAABB(I,g,C);e.h<r.h&&(r=e,m=[p,t,A])}}const h=r.h*o+Engine.EPSILON*r.nx,B=r.h*i+Engine.EPSILON*r.ny,G=r.h*l+Engine.EPSILON*r.nz;if(t&&I.translate([h,B,G]),1===r.h)return;const W=0!==r.nx?0:0!==r.ny?1:2,u=-(r.nx+r.ny+r.nz),y=[(1-r.h)*o,(1-r.h)*i,(1-r.h)*l];0!==u&&A(c*r.h,W,u,y,m)||y[0]**2+y[1]**2+y[2]**2!=0&&sweep(g,I,y,A,t,e-1)}function approxEquals(g,I){return Math.abs(g-I)<1e-5}var _Engine=class{constructor(g,I,C){this.getVoxel=g,this.testFluid=I,this.options=C,this.bodies=[],this.addBody=g=>{const I={aabb:new AABB(0,0,0,1,1,1),mass:1,friction:1,restitution:0,gravityMultiplier:1,stepHeight:0},{aabb:C,mass:A,friction:t,restitution:e,gravityMultiplier:o,stepHeight:i,onStep:l,onCollide:c}={...I,...g},n=new RigidBody(C,A,t,e,o,i,l,c);return this.bodies.push(n),n},this.removeBody=g=>{const I=this.bodies.indexOf(g);I<0||this.bodies.splice(I,1)},this.update=g=>{const I=approxEquals(0,this.options.gravity[0]**2+this.options.gravity[1]**2+this.options.gravity[2]**2);this.bodies.forEach((C=>this.iterateBody(C,g,I)))},this.iterateBody=(g,I,C)=>{const A=[...g.resting];if(g.mass<=0)return g.velocity=[0,0,0],g.forces=[0,0,0],void(g.impulses=[0,0,0]);const t=C||0===g.gravityMultiplier;if(this.isBodyAsleep(g,I,t))return;g.sleepFrameCount--,this.applyFluidForces(g);const e=[g.forces[0]/g.mass+this.options.gravity[0]*g.gravityMultiplier,g.forces[1]/g.mass+this.options.gravity[1]*g.gravityMultiplier,g.forces[2]/g.mass+this.options.gravity[2]*g.gravityMultiplier],o=[g.impulses[0]/g.mass+e[0]*I,g.impulses[1]/g.mass+e[1]*I,g.impulses[2]/g.mass+e[2]*I];g.velocity=[g.velocity[0]+o[0],g.velocity[1]+o[1],g.velocity[2]+o[2]],g.friction&&(this.applyFrictionByAxis(0,g,o),this.applyFrictionByAxis(1,g,o),this.applyFrictionByAxis(2,g,o));let i=g.airDrag>=0?g.airDrag:this.options.airDrag;g.inFluid&&(i=g.fluidDrag>=0?g.fluidDrag:this.options.fluidDrag,i*=1-(1-g.ratioInFluid)**2);const l=Math.max(1-i*I/g.mass,0);g.velocity=[g.velocity[0]*l,g.velocity[1]*l,g.velocity[2]*l];const c=[g.velocity[0]*I,g.velocity[1]*I,g.velocity[2]*I];g.forces=[0,0,0],g.impulses=[0,0,0];const n=g.aabb.clone();this.processCollisions(g.aabb,c,g.resting),g.stepHeight>0&&this.tryAutoStepping(g,n,c);const d=[0,0,0];for(let Z=0;Z<3;++Z)g.resting[Z]&&(A[Z]||(d[Z]=-g.velocity[Z]),g.velocity[Z]=0);const s=Math.sqrt(d[0]**2+d[1]**2+d[2]**2);s>.001&&(d[0]=d[0]*g.mass,d[1]=d[1]*g.mass,d[2]=d[2]*g.mass,g.onCollide&&g.onCollide(d),g.restitution>0&&s>this.options.minBounceImpulse&&(d[0]=d[0]*g.restitution,d[1]=d[1]*g.restitution,d[2]=d[2]*g.restitution,g.applyImpulse(d)));g.velocity[0]**2+g.velocity[1]**2+g.velocity[2]**2>1e-5&&g.markActive()},this.applyFluidForces=g=>{const I=g.aabb,C=Math.floor(I.minX),A=Math.floor(I.minZ),t=Math.floor(I.minY),e=Math.floor(I.maxY);if(!this.testFluid(C,t,A))return g.inFluid=!1,void(g.ratioInFluid=0);let o=1,i=t+1;for(;i<=e&&this.testFluid(C,i,A);)o++,i++;let l=(t+o-I.minY)/(I.maxY-I.minY);l>1&&(l=1);const c=(I.maxX-I.minX)*(I.maxY-I.minY)*(I.maxZ-I.minZ)*l,n=-this.options.fluidDensity*c,d=[this.options.gravity[0]*n,this.options.gravity[1]*n,this.options.gravity[2]*n];g.applyForce(d),g.inFluid=!0,g.ratioInFluid=l},this.applyFrictionByAxis=(g,I,C)=>{const A=I.resting[g],t=C[g];if(0===A)return;if(A*t<=0)return;const e=[...I.velocity];e[g]=0;const o=Math.sqrt(e[0]**2+e[1]**2+e[2]**2);if(approxEquals(o,0))return;const i=Math.abs(I.friction*t),l=o>i?(o-i)/o:0;I.velocity[(g+1)%3]*=l,I.velocity[(g+2)%3]*=l},this.processCollisions=(g,I,C)=>{C[0]=0,C[1]=0,C[2]=0,sweep(this.getVoxel,g,I,(function(g,I,A,t){return C[I]=A,t[I]=0,!1}))},this.tryAutoStepping=(g,I,C)=>{if(g.resting[1]>=0&&!g.inFluid)return;const A=0!==g.resting[0],t=0!==g.resting[2];if(!A&&!t)return;const e=[I.minX+C[0],I.minY+C[1],I.minZ+C[2]];let o=[];sweep(this.getVoxel,I,C,(function(g,I,C,A,t){return 1===I?(A[I]=0,!1):(o=t||[],!0)}));const i=g.aabb.minY;let l=0;if(o){this.getVoxel(o[0],o[1],o[2]).forEach((g=>{g.maxY>l&&(l=g.maxY)}))}const c=Math.floor(i)+l-i+_Engine.EPSILON,n=[0,Math.min(c,g.stepHeight+.001),0];let d=!1;if(sweep(this.getVoxel,I,n,(function(){return d=!0,!0})),d)return;const s=[e[0]-I.minX,e[1]-I.minY,e[2]-I.minZ];s[1]=0;const Z=[0,0,0];if(this.processCollisions(I,s,Z),A&&!approxEquals(I.minX,e[0]))return;if(t&&!approxEquals(I.minZ,e[2]))return;const b=I.clone();sweep(this.getVoxel,b,[0,-c,0],(g=>(g>_Engine.EPSILON&&I.translate([0,-g+_Engine.EPSILON,0]),!0))),g.resting[0]=Z[0],g.resting[2]=Z[2],g.onStep?g.onStep(I,Z):g.aabb=I.clone()},this.isBodyAsleep=(g,I,C)=>{if(g.sleepFrameCount>0)return!1;if(C)return!0;let A=!1;const t=.5*I*I*g.gravityMultiplier,e=[this.options.gravity[0]*t,this.options.gravity[1]*t,this.options.gravity[2]*t];return sweep(this.getVoxel,g.aabb,e,(function(){return A=!0,!0}),!1),A},this.teleport=(g,I,C)=>{const A=1e3,t=g.getPosition(),e=(I[0]-t[0])/A,o=(I[1]-t[1])/A,i=(I[2]-t[2])/A;setInterval((()=>{g.aabb.translate([e,o,i])}),C/A)}}},Engine=_Engine;function raycastAABB(g,I,C,A){void 0===A&&(A=1/0);const[t,e,o]=I,i=(C.minX-g[0])/t,l=(C.maxX-g[0])/t,c=(C.minY-g[1])/e,n=(C.maxY-g[1])/e,d=(C.minZ-g[2])/o,s=(C.maxZ-g[2])/o,Z=Math.max(Math.max(Math.min(i,l),Math.min(c,n)),Math.min(d,s)),b=Z===i||Z===l?0:Z===c||Z===n?1:2,a=Math.min(Math.min(Math.max(i,l),Math.max(c,n)),Math.max(d,s));return a<0||Z>a?null:Z<0?a>A?null:{axis:Z===i||Z===l?0:Z===c||Z===n?1:2,distance:a}:Z>A?null:{axis:b,distance:Z}}function raycast(g,I,C,A){let t=+C[0],e=+C[1],o=+C[2];const i=Math.sqrt(t*t+e*e+o*o);if(0===i)throw new Error("Can't raycast along a zero vector");t/=i,e/=i,o/=i;const[l,c,n]=I;let d=0,s=0|Math.floor(l),Z=0|Math.floor(c),b=0|Math.floor(n);const a=t>0?1:-1,m=e>0?1:-1,r=o>0?1:-1,h=Math.abs(1/t),B=Math.abs(1/e),G=Math.abs(1/o);let W=h<1/0?h*(a>0?s+1-l:l-s):1/0,u=B<1/0?B*(m>0?Z+1-c:c-Z):1/0,y=G<1/0?G*(r>0?b+1-n:n-b):1/0;for(;d<=A;){let C;if((g(s,Z,b)||[]).forEach((g=>{const i=raycastAABB(I,[t,e,o],g.clone().translate([s,Z,b]),A);i&&(C=i)})),C)return{point:[l+C.distance*t,c+C.distance*e,n+C.distance*o],normal:[0===C.axis?-a:0,1===C.axis?-m:0,2===C.axis?-r:0],voxel:[s,Z,b]};W<u?W<y?(s+=a,d=W,W+=h):(b+=r,d=y,y+=G):u<y?(Z+=m,d=u,u+=B):(b+=r,d=y,y+=G)}return null}Engine.EPSILON=1e-10;var WorkerFactory$2=createBase64WorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLy8gc3JjL2luZGV4LnRzCiAgdmFyIF9BQUJCID0gY2xhc3MgewogICAgICBnZXQgd2lkdGgoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5tYXhYIC0gdGhpcy5taW5YOwogICAgICB9CiAgICAgIGdldCBoZWlnaHQoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5tYXhZIC0gdGhpcy5taW5ZOwogICAgICB9CiAgICAgIGdldCBkZXB0aCgpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1heFogLSB0aGlzLm1pblo7CiAgICAgIH0KICAgICAgZ2V0IG1hZygpIHsKICAgICAgICAgIHJldHVybiBNYXRoLnNxcnQoKHRoaXMubWF4WCAtIHRoaXMubWluWCkgKiogMiArICh0aGlzLm1heFkgLSB0aGlzLm1pblkpICoqIDIgKyAodGhpcy5tYXhaIC0gdGhpcy5taW5aKSAqKiAyKTsKICAgICAgfQogICAgICBjb21wdXRlT2Zmc2V0WChhYWJiLCBkZWx0YVgpIHsKICAgICAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICAgICAgaWYgKGludGVyc2VjdGlvbi5oZWlnaHQgPD0gMCB8fCBpbnRlcnNlY3Rpb24uZGVwdGggPD0gMCkgewogICAgICAgICAgICAgIHJldHVybiBkZWx0YVg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoID49IDApIHsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWx0YVggPiAwICYmIGFhYmIubWluWCA+PSB0aGlzLm1heFgpIHsKICAgICAgICAgICAgICByZXR1cm4gTWF0aC5taW4oYWFiYi5taW5YIC0gdGhpcy5tYXhYLCBkZWx0YVgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlbHRhWCA8IDAgJiYgYWFiYi5tYXhYIDw9IHRoaXMubWluWCkgewogICAgICAgICAgICAgIHJldHVybiBNYXRoLm1heChhYWJiLm1heFggLSB0aGlzLm1pblgsIGRlbHRhWCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGVsdGFYOwogICAgICB9CiAgICAgIGNvbXB1dGVPZmZzZXRZKGFhYmIsIGRlbHRhWSkgewogICAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gdGhpcy5pbnRlcnNlY3Rpb24oYWFiYik7CiAgICAgICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoIDw9IDAgfHwgaW50ZXJzZWN0aW9uLmRlcHRoIDw9IDApIHsKICAgICAgICAgICAgICByZXR1cm4gZGVsdGFZOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGludGVyc2VjdGlvbi5oZWlnaHQgPj0gMCkgewogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlbHRhWSA+IDAgJiYgYWFiYi5taW5ZID49IHRoaXMubWF4WSkgewogICAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbihhYWJiLm1pblkgLSB0aGlzLm1heFksIGRlbHRhWSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVsdGFZIDwgMCAmJiBhYWJiLm1heFkgPD0gdGhpcy5taW5ZKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WSAtIHRoaXMubWluWSwgZGVsdGFZKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZWx0YVk7CiAgICAgIH0KICAgICAgY29tcHV0ZU9mZnNldFooYWFiYiwgZGVsdGFaKSB7CiAgICAgICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSB0aGlzLmludGVyc2VjdGlvbihhYWJiKTsKICAgICAgICAgIGlmIChpbnRlcnNlY3Rpb24ud2lkdGggPD0gMCB8fCBpbnRlcnNlY3Rpb24uaGVpZ2h0IDw9IDApIHsKICAgICAgICAgICAgICByZXR1cm4gZGVsdGFaOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGludGVyc2VjdGlvbi5kZXB0aCA+PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVsdGFaID4gMCAmJiBhYWJiLm1pblogPj0gdGhpcy5tYXhaKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWiAtIHRoaXMubWF4WiwgZGVsdGFaKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWx0YVogPCAwICYmIGFhYmIubWF4WiA8PSB0aGlzLm1pblopIHsKICAgICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoYWFiYi5tYXhaIC0gdGhpcy5taW5aLCBkZWx0YVopOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRlbHRhWjsKICAgICAgfQogICAgICBjb25zdHJ1Y3RvcihtaW5YLCBtaW5ZLCBtaW5aLCBtYXhYLCBtYXhZLCBtYXhaKXsKICAgICAgICAgIHRoaXMubWluWCA9IG1pblg7CiAgICAgICAgICB0aGlzLm1pblkgPSBtaW5ZOwogICAgICAgICAgdGhpcy5taW5aID0gbWluWjsKICAgICAgICAgIHRoaXMubWF4WCA9IG1heFg7CiAgICAgICAgICB0aGlzLm1heFkgPSBtYXhZOwogICAgICAgICAgdGhpcy5tYXhaID0gbWF4WjsKICAgICAgICAgIHRoaXMuZ2V0TWluID0gKGF4aXMpPT57CiAgICAgICAgICAgICAgaWYgKGF4aXMgPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWluWDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWluWTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWluWjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdldE1pbkVycm9yOiBVbmtub3duIGF4aXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuc2V0TWluID0gKGF4aXMsIHZhbHVlKT0+ewogICAgICAgICAgICAgIGlmIChheGlzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMubWluWCA9IHZhbHVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMSkgewogICAgICAgICAgICAgICAgICB0aGlzLm1pblkgPSB2YWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5taW5aID0gdmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTZXRNaW5FcnJvcjogVW5rbm93biBheGlzLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLmdldE1heCA9IChheGlzKT0+ewogICAgICAgICAgICAgIGlmIChheGlzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1heFg7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1heFk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1heFo7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJHZXRNYXhFcnJvcjogVW5rbm93biBheGlzLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLnNldE1heCA9IChheGlzLCB2YWx1ZSk9PnsKICAgICAgICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgICAgICAgICB0aGlzLm1heFggPSB2YWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5tYXhZID0gdmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMubWF4WiA9IHZhbHVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0TWF4RXJyb3I6IFVua25vd24gYXhpcy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy50cmFuc2xhdGUgPSAoW2R4LCBkeSwgZHpdKT0+ewogICAgICAgICAgICAgIHRoaXMubWluWCArPSBkeDsKICAgICAgICAgICAgICB0aGlzLm1pblkgKz0gZHk7CiAgICAgICAgICAgICAgdGhpcy5taW5aICs9IGR6OwogICAgICAgICAgICAgIHRoaXMubWF4WCArPSBkeDsKICAgICAgICAgICAgICB0aGlzLm1heFkgKz0gZHk7CiAgICAgICAgICAgICAgdGhpcy5tYXhaICs9IGR6OwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMudHJhbnNsYXRlQXhpcyA9IChheGlzLCBkZWx0YSk9PnsKICAgICAgICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgICAgICAgICB0aGlzLm1pblggKz0gZGVsdGE7CiAgICAgICAgICAgICAgICAgIHRoaXMubWF4WCArPSBkZWx0YTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5taW5ZICs9IGRlbHRhOwogICAgICAgICAgICAgICAgICB0aGlzLm1heFkgKz0gZGVsdGE7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMubWluWiArPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgdGhpcy5tYXhaICs9IGRlbHRhOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHJhbnNsYXRlQXhpc0Vycm9yOiBVbmtub3duIGF4aXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuc2V0UG9zaXRpb24gPSAoW3B4LCBweSwgcHpdKT0+ewogICAgICAgICAgICAgIHRoaXMubWF4WCA9IHB4ICsgdGhpcy53aWR0aDsKICAgICAgICAgICAgICB0aGlzLm1heFkgPSBweSArIHRoaXMuaGVpZ2h0OwogICAgICAgICAgICAgIHRoaXMubWF4WiA9IHB6ICsgdGhpcy5kZXB0aDsKICAgICAgICAgICAgICB0aGlzLm1pblggPSBweDsKICAgICAgICAgICAgICB0aGlzLm1pblkgPSBweTsKICAgICAgICAgICAgICB0aGlzLm1pblogPSBwejsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLmludGVyc2VjdHMgPSAoYWFiYik9PnsKICAgICAgICAgICAgICBpZiAoYWFiYi5taW5YID49IHRoaXMubWF4WCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIGlmIChhYWJiLm1pblkgPj0gdGhpcy5tYXhZKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKGFhYmIubWluWiA+PSB0aGlzLm1heFopIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICBpZiAoYWFiYi5tYXhYIDw9IHRoaXMubWluWCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIGlmIChhYWJiLm1heFkgPD0gdGhpcy5taW5ZKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKGFhYmIubWF4WiA8PSB0aGlzLm1pblopIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLnRvdWNoZXMgPSAoYWFiYik9PnsKICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSB0aGlzLmludGVyc2VjdGlvbihhYWJiKTsKICAgICAgICAgICAgICByZXR1cm4gaW50ZXJzZWN0aW9uICE9PSBudWxsICYmIChpbnRlcnNlY3Rpb24ud2lkdGggPT09IDAgfHwgaW50ZXJzZWN0aW9uLmhlaWdodCA9PT0gMCB8fCBpbnRlcnNlY3Rpb24uZGVwdGggPT09IDApOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMudW5pb24gPSAoYWFiYik9PnsKICAgICAgICAgICAgICByZXR1cm4gbmV3IF9BQUJCKE1hdGgubWluKHRoaXMubWluWCwgYWFiYi5taW5YKSwgTWF0aC5taW4odGhpcy5taW5ZLCBhYWJiLm1pblkpLCBNYXRoLm1pbih0aGlzLm1pblosIGFhYmIubWluWiksIE1hdGgubWF4KHRoaXMubWF4WCwgYWFiYi5tYXhYKSwgTWF0aC5tYXgodGhpcy5tYXhZLCBhYWJiLm1heFkpLCBNYXRoLm1heCh0aGlzLm1heFosIGFhYmIubWF4WikpOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuaW50ZXJzZWN0aW9uID0gKGFhYmIpPT57CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBfQUFCQihNYXRoLm1heCh0aGlzLm1pblgsIGFhYmIubWluWCksIE1hdGgubWF4KHRoaXMubWluWSwgYWFiYi5taW5ZKSwgTWF0aC5tYXgodGhpcy5taW5aLCBhYWJiLm1pblopLCBNYXRoLm1pbih0aGlzLm1heFgsIGFhYmIubWF4WCksIE1hdGgubWluKHRoaXMubWF4WSwgYWFiYi5tYXhZKSwgTWF0aC5taW4odGhpcy5tYXhaLCBhYWJiLm1heFopKTsKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLmNsb25lID0gKCk9PnsKICAgICAgICAgICAgICByZXR1cm4gbmV3IF9BQUJCKHRoaXMubWluWCwgdGhpcy5taW5ZLCB0aGlzLm1pblosIHRoaXMubWF4WCwgdGhpcy5tYXhZLCB0aGlzLm1heFopOwogICAgICAgICAgfTsKICAgICAgfQogIH07CiAgdmFyIEFBQkIgPSBfQUFCQjsKICBBQUJCLnVuaW9uID0gKGFsbCk9PnsKICAgICAgbGV0IG1pblggPSBhbGxbMF0ubWluWDsKICAgICAgbGV0IG1pblkgPSBhbGxbMF0ubWluWTsKICAgICAgbGV0IG1pblogPSBhbGxbMF0ubWluWjsKICAgICAgbGV0IG1heFggPSBhbGxbMF0ubWF4WDsKICAgICAgbGV0IG1heFkgPSBhbGxbMF0ubWF4WTsKICAgICAgbGV0IG1heFogPSBhbGxbMF0ubWF4WjsKICAgICAgZm9yIChjb25zdCBhYWJiIG9mIGFsbCl7CiAgICAgICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgYWFiYi5taW5YKTsKICAgICAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBhYWJiLm1pblkpOwogICAgICAgICAgbWluWiA9IE1hdGgubWluKG1pblosIGFhYmIubWluWik7CiAgICAgICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgYWFiYi5tYXhYKTsKICAgICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCBhYWJiLm1heFkpOwogICAgICAgICAgbWF4WiA9IE1hdGgubWF4KG1heFosIGFhYmIubWF4Wik7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBfQUFCQihtaW5YLCBtaW5ZLCBtaW5aLCBtYXhYLCBtYXhZLCBtYXhaKTsKICB9OwoKICB2YXIgZXBzaWxvbiA9IDAuMDAwMDAxOwoKICB2YXIgY3JlYXRlXzEgPSBjcmVhdGU7CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcsIGVtcHR5IHZlYzMKICAgKgogICAqIEByZXR1cm5zIHt2ZWMzfSBhIG5ldyAzRCB2ZWN0b3IKICAgKi8KICBmdW5jdGlvbiBjcmVhdGUoKSB7CiAgICAgIHZhciBvdXQgPSBuZXcgRmxvYXQzMkFycmF5KDMpOwogICAgICBvdXRbMF0gPSAwOwogICAgICBvdXRbMV0gPSAwOwogICAgICBvdXRbMl0gPSAwOwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgY2xvbmVfMSA9IGNsb25lOwoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHZlYzMgaW5pdGlhbGl6ZWQgd2l0aCB2YWx1ZXMgZnJvbSBhbiBleGlzdGluZyB2ZWN0b3IKICAgKgogICAqIEBwYXJhbSB7dmVjM30gYSB2ZWN0b3IgdG8gY2xvbmUKICAgKiBAcmV0dXJucyB7dmVjM30gYSBuZXcgM0QgdmVjdG9yCiAgICovCiAgZnVuY3Rpb24gY2xvbmUoYSkgewogICAgICB2YXIgb3V0ID0gbmV3IEZsb2F0MzJBcnJheSgzKTsKICAgICAgb3V0WzBdID0gYVswXTsKICAgICAgb3V0WzFdID0gYVsxXTsKICAgICAgb3V0WzJdID0gYVsyXTsKICAgICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIGZyb21WYWx1ZXNfMSA9IGZyb21WYWx1ZXMkMTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyB2ZWMzIGluaXRpYWxpemVkIHdpdGggdGhlIGdpdmVuIHZhbHVlcwogICAqCiAgICogQHBhcmFtIHtOdW1iZXJ9IHggWCBjb21wb25lbnQKICAgKiBAcGFyYW0ge051bWJlcn0geSBZIGNvbXBvbmVudAogICAqIEBwYXJhbSB7TnVtYmVyfSB6IFogY29tcG9uZW50CiAgICogQHJldHVybnMge3ZlYzN9IGEgbmV3IDNEIHZlY3RvcgogICAqLwogIGZ1bmN0aW9uIGZyb21WYWx1ZXMkMSh4LCB5LCB6KSB7CiAgICAgIHZhciBvdXQgPSBuZXcgRmxvYXQzMkFycmF5KDMpOwogICAgICBvdXRbMF0gPSB4OwogICAgICBvdXRbMV0gPSB5OwogICAgICBvdXRbMl0gPSB6OwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgbm9ybWFsaXplXzEgPSBub3JtYWxpemUkMTsKCiAgLyoqCiAgICogTm9ybWFsaXplIGEgdmVjMwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdmVjdG9yIHRvIG5vcm1hbGl6ZQogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemUkMShvdXQsIGEpIHsKICAgICAgdmFyIHggPSBhWzBdLAogICAgICAgICAgeSA9IGFbMV0sCiAgICAgICAgICB6ID0gYVsyXTsKICAgICAgdmFyIGxlbiA9IHgqeCArIHkqeSArIHoqejsKICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgIC8vVE9ETzogZXZhbHVhdGUgdXNlIG9mIGdsbV9pbnZzcXJ0IGhlcmU/CiAgICAgICAgICBsZW4gPSAxIC8gTWF0aC5zcXJ0KGxlbik7CiAgICAgICAgICBvdXRbMF0gPSBhWzBdICogbGVuOwogICAgICAgICAgb3V0WzFdID0gYVsxXSAqIGxlbjsKICAgICAgICAgIG91dFsyXSA9IGFbMl0gKiBsZW47CiAgICAgIH0KICAgICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIGRvdF8xID0gZG90JDE7CgogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIGRvdCBwcm9kdWN0IG9mIHR3byB2ZWMzJ3MKICAgKgogICAqIEBwYXJhbSB7dmVjM30gYSB0aGUgZmlyc3Qgb3BlcmFuZAogICAqIEBwYXJhbSB7dmVjM30gYiB0aGUgc2Vjb25kIG9wZXJhbmQKICAgKiBAcmV0dXJucyB7TnVtYmVyfSBkb3QgcHJvZHVjdCBvZiBhIGFuZCBiCiAgICovCiAgZnVuY3Rpb24gZG90JDEoYSwgYikgewogICAgICByZXR1cm4gYVswXSAqIGJbMF0gKyBhWzFdICogYlsxXSArIGFbMl0gKiBiWzJdCiAgfQoKICB2YXIgYW5nbGVfMSA9IGFuZ2xlOwoKICB2YXIgZnJvbVZhbHVlcyA9IGZyb21WYWx1ZXNfMTsKICB2YXIgbm9ybWFsaXplID0gbm9ybWFsaXplXzE7CiAgdmFyIGRvdCA9IGRvdF8xOwoKICAvKioKICAgKiBHZXQgdGhlIGFuZ2xlIGJldHdlZW4gdHdvIDNEIHZlY3RvcnMKICAgKiBAcGFyYW0ge3ZlYzN9IGEgVGhlIGZpcnN0IG9wZXJhbmQKICAgKiBAcGFyYW0ge3ZlYzN9IGIgVGhlIHNlY29uZCBvcGVyYW5kCiAgICogQHJldHVybnMge051bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMKICAgKi8KICBmdW5jdGlvbiBhbmdsZShhLCBiKSB7CiAgICAgIHZhciB0ZW1wQSA9IGZyb21WYWx1ZXMoYVswXSwgYVsxXSwgYVsyXSk7CiAgICAgIHZhciB0ZW1wQiA9IGZyb21WYWx1ZXMoYlswXSwgYlsxXSwgYlsyXSk7CiAgIAogICAgICBub3JtYWxpemUodGVtcEEsIHRlbXBBKTsKICAgICAgbm9ybWFsaXplKHRlbXBCLCB0ZW1wQik7CiAgIAogICAgICB2YXIgY29zaW5lID0gZG90KHRlbXBBLCB0ZW1wQik7CgogICAgICBpZihjb3NpbmUgPiAxLjApewogICAgICAgICAgcmV0dXJuIDAKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBNYXRoLmFjb3MoY29zaW5lKQogICAgICB9ICAgICAKICB9CgogIHZhciBjb3B5XzEgPSBjb3B5OwoKICAvKioKICAgKiBDb3B5IHRoZSB2YWx1ZXMgZnJvbSBvbmUgdmVjMyB0byBhbm90aGVyCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7dmVjM30gYSB0aGUgc291cmNlIHZlY3RvcgogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiBjb3B5KG91dCwgYSkgewogICAgICBvdXRbMF0gPSBhWzBdOwogICAgICBvdXRbMV0gPSBhWzFdOwogICAgICBvdXRbMl0gPSBhWzJdOwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgc2V0XzEgPSBzZXQ7CgogIC8qKgogICAqIFNldCB0aGUgY29tcG9uZW50cyBvZiBhIHZlYzMgdG8gdGhlIGdpdmVuIHZhbHVlcwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge051bWJlcn0geCBYIGNvbXBvbmVudAogICAqIEBwYXJhbSB7TnVtYmVyfSB5IFkgY29tcG9uZW50CiAgICogQHBhcmFtIHtOdW1iZXJ9IHogWiBjb21wb25lbnQKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gc2V0KG91dCwgeCwgeSwgeikgewogICAgICBvdXRbMF0gPSB4OwogICAgICBvdXRbMV0gPSB5OwogICAgICBvdXRbMl0gPSB6OwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgZXF1YWxzXzEgPSBlcXVhbHM7CgogIHZhciBFUFNJTE9OID0gZXBzaWxvbjsKCiAgLyoqCiAgICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCB0aGUgdmVjdG9ycyBoYXZlIGFwcHJveGltYXRlbHkgdGhlIHNhbWUgZWxlbWVudHMgaW4gdGhlIHNhbWUgcG9zaXRpb24uCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IGEgVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge3ZlYzN9IGIgVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZlY3RvcnMgYXJlIGVxdWFsLCBmYWxzZSBvdGhlcndpc2UuCiAgICovCiAgZnVuY3Rpb24gZXF1YWxzKGEsIGIpIHsKICAgIHZhciBhMCA9IGFbMF07CiAgICB2YXIgYTEgPSBhWzFdOwogICAgdmFyIGEyID0gYVsyXTsKICAgIHZhciBiMCA9IGJbMF07CiAgICB2YXIgYjEgPSBiWzFdOwogICAgdmFyIGIyID0gYlsyXTsKICAgIHJldHVybiAoTWF0aC5hYnMoYTAgLSBiMCkgPD0gRVBTSUxPTiAqIE1hdGgubWF4KDEuMCwgTWF0aC5hYnMoYTApLCBNYXRoLmFicyhiMCkpICYmCiAgICAgICAgICAgIE1hdGguYWJzKGExIC0gYjEpIDw9IEVQU0lMT04gKiBNYXRoLm1heCgxLjAsIE1hdGguYWJzKGExKSwgTWF0aC5hYnMoYjEpKSAmJgogICAgICAgICAgICBNYXRoLmFicyhhMiAtIGIyKSA8PSBFUFNJTE9OICogTWF0aC5tYXgoMS4wLCBNYXRoLmFicyhhMiksIE1hdGguYWJzKGIyKSkpCiAgfQoKICB2YXIgZXhhY3RFcXVhbHNfMSA9IGV4YWN0RXF1YWxzOwoKICAvKioKICAgKiBSZXR1cm5zIHdoZXRoZXIgb3Igbm90IHRoZSB2ZWN0b3JzIGV4YWN0bHkgaGF2ZSB0aGUgc2FtZSBlbGVtZW50cyBpbiB0aGUgc2FtZSBwb3NpdGlvbiAod2hlbiBjb21wYXJlZCB3aXRoID09PSkKICAgKgogICAqIEBwYXJhbSB7dmVjM30gYSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7dmVjM30gYiBUaGUgc2Vjb25kIHZlY3Rvci4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmVjdG9ycyBhcmUgZXF1YWwsIGZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBmdW5jdGlvbiBleGFjdEVxdWFscyhhLCBiKSB7CiAgICByZXR1cm4gYVswXSA9PT0gYlswXSAmJiBhWzFdID09PSBiWzFdICYmIGFbMl0gPT09IGJbMl0KICB9CgogIHZhciBhZGRfMSA9IGFkZDsKCiAgLyoqCiAgICogQWRkcyB0d28gdmVjMydzCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7dmVjM30gYSB0aGUgZmlyc3Qgb3BlcmFuZAogICAqIEBwYXJhbSB7dmVjM30gYiB0aGUgc2Vjb25kIG9wZXJhbmQKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gYWRkKG91dCwgYSwgYikgewogICAgICBvdXRbMF0gPSBhWzBdICsgYlswXTsKICAgICAgb3V0WzFdID0gYVsxXSArIGJbMV07CiAgICAgIG91dFsyXSA9IGFbMl0gKyBiWzJdOwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgc3VidHJhY3RfMSA9IHN1YnRyYWN0OwoKICAvKioKICAgKiBTdWJ0cmFjdHMgdmVjdG9yIGIgZnJvbSB2ZWN0b3IgYQogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdGhlIGZpcnN0IG9wZXJhbmQKICAgKiBAcGFyYW0ge3ZlYzN9IGIgdGhlIHNlY29uZCBvcGVyYW5kCiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIHN1YnRyYWN0KG91dCwgYSwgYikgewogICAgICBvdXRbMF0gPSBhWzBdIC0gYlswXTsKICAgICAgb3V0WzFdID0gYVsxXSAtIGJbMV07CiAgICAgIG91dFsyXSA9IGFbMl0gLSBiWzJdOwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgc3ViID0gc3VidHJhY3RfMTsKCiAgdmFyIG11bHRpcGx5XzEgPSBtdWx0aXBseTsKCiAgLyoqCiAgICogTXVsdGlwbGllcyB0d28gdmVjMydzCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7dmVjM30gYSB0aGUgZmlyc3Qgb3BlcmFuZAogICAqIEBwYXJhbSB7dmVjM30gYiB0aGUgc2Vjb25kIG9wZXJhbmQKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gbXVsdGlwbHkob3V0LCBhLCBiKSB7CiAgICAgIG91dFswXSA9IGFbMF0gKiBiWzBdOwogICAgICBvdXRbMV0gPSBhWzFdICogYlsxXTsKICAgICAgb3V0WzJdID0gYVsyXSAqIGJbMl07CiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciBtdWwgPSBtdWx0aXBseV8xOwoKICB2YXIgZGl2aWRlXzEgPSBkaXZpZGU7CgogIC8qKgogICAqIERpdmlkZXMgdHdvIHZlYzMncwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdGhlIGZpcnN0IG9wZXJhbmQKICAgKiBAcGFyYW0ge3ZlYzN9IGIgdGhlIHNlY29uZCBvcGVyYW5kCiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIGRpdmlkZShvdXQsIGEsIGIpIHsKICAgICAgb3V0WzBdID0gYVswXSAvIGJbMF07CiAgICAgIG91dFsxXSA9IGFbMV0gLyBiWzFdOwogICAgICBvdXRbMl0gPSBhWzJdIC8gYlsyXTsKICAgICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIGRpdiA9IGRpdmlkZV8xOwoKICB2YXIgbWluXzEgPSBtaW47CgogIC8qKgogICAqIFJldHVybnMgdGhlIG1pbmltdW0gb2YgdHdvIHZlYzMncwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdGhlIGZpcnN0IG9wZXJhbmQKICAgKiBAcGFyYW0ge3ZlYzN9IGIgdGhlIHNlY29uZCBvcGVyYW5kCiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIG1pbihvdXQsIGEsIGIpIHsKICAgICAgb3V0WzBdID0gTWF0aC5taW4oYVswXSwgYlswXSk7CiAgICAgIG91dFsxXSA9IE1hdGgubWluKGFbMV0sIGJbMV0pOwogICAgICBvdXRbMl0gPSBNYXRoLm1pbihhWzJdLCBiWzJdKTsKICAgICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIG1heF8xID0gbWF4OwoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBtYXhpbXVtIG9mIHR3byB2ZWMzJ3MKICAgKgogICAqIEBwYXJhbSB7dmVjM30gb3V0IHRoZSByZWNlaXZpbmcgdmVjdG9yCiAgICogQHBhcmFtIHt2ZWMzfSBhIHRoZSBmaXJzdCBvcGVyYW5kCiAgICogQHBhcmFtIHt2ZWMzfSBiIHRoZSBzZWNvbmQgb3BlcmFuZAogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiBtYXgob3V0LCBhLCBiKSB7CiAgICAgIG91dFswXSA9IE1hdGgubWF4KGFbMF0sIGJbMF0pOwogICAgICBvdXRbMV0gPSBNYXRoLm1heChhWzFdLCBiWzFdKTsKICAgICAgb3V0WzJdID0gTWF0aC5tYXgoYVsyXSwgYlsyXSk7CiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciBmbG9vcl8xID0gZmxvb3I7CgogIC8qKgogICAqIE1hdGguZmxvb3IgdGhlIGNvbXBvbmVudHMgb2YgYSB2ZWMzCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7dmVjM30gYSB2ZWN0b3IgdG8gZmxvb3IKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gZmxvb3Iob3V0LCBhKSB7CiAgICBvdXRbMF0gPSBNYXRoLmZsb29yKGFbMF0pOwogICAgb3V0WzFdID0gTWF0aC5mbG9vcihhWzFdKTsKICAgIG91dFsyXSA9IE1hdGguZmxvb3IoYVsyXSk7CiAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgY2VpbF8xID0gY2VpbDsKCiAgLyoqCiAgICogTWF0aC5jZWlsIHRoZSBjb21wb25lbnRzIG9mIGEgdmVjMwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdmVjdG9yIHRvIGNlaWwKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gY2VpbChvdXQsIGEpIHsKICAgIG91dFswXSA9IE1hdGguY2VpbChhWzBdKTsKICAgIG91dFsxXSA9IE1hdGguY2VpbChhWzFdKTsKICAgIG91dFsyXSA9IE1hdGguY2VpbChhWzJdKTsKICAgIHJldHVybiBvdXQKICB9CgogIHZhciByb3VuZF8xID0gcm91bmQ7CgogIC8qKgogICAqIE1hdGgucm91bmQgdGhlIGNvbXBvbmVudHMgb2YgYSB2ZWMzCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7dmVjM30gYSB2ZWN0b3IgdG8gcm91bmQKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gcm91bmQob3V0LCBhKSB7CiAgICBvdXRbMF0gPSBNYXRoLnJvdW5kKGFbMF0pOwogICAgb3V0WzFdID0gTWF0aC5yb3VuZChhWzFdKTsKICAgIG91dFsyXSA9IE1hdGgucm91bmQoYVsyXSk7CiAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgc2NhbGVfMSA9IHNjYWxlOwoKICAvKioKICAgKiBTY2FsZXMgYSB2ZWMzIGJ5IGEgc2NhbGFyIG51bWJlcgogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdGhlIHZlY3RvciB0byBzY2FsZQogICAqIEBwYXJhbSB7TnVtYmVyfSBiIGFtb3VudCB0byBzY2FsZSB0aGUgdmVjdG9yIGJ5CiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIHNjYWxlKG91dCwgYSwgYikgewogICAgICBvdXRbMF0gPSBhWzBdICogYjsKICAgICAgb3V0WzFdID0gYVsxXSAqIGI7CiAgICAgIG91dFsyXSA9IGFbMl0gKiBiOwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgc2NhbGVBbmRBZGRfMSA9IHNjYWxlQW5kQWRkOwoKICAvKioKICAgKiBBZGRzIHR3byB2ZWMzJ3MgYWZ0ZXIgc2NhbGluZyB0aGUgc2Vjb25kIG9wZXJhbmQgYnkgYSBzY2FsYXIgdmFsdWUKICAgKgogICAqIEBwYXJhbSB7dmVjM30gb3V0IHRoZSByZWNlaXZpbmcgdmVjdG9yCiAgICogQHBhcmFtIHt2ZWMzfSBhIHRoZSBmaXJzdCBvcGVyYW5kCiAgICogQHBhcmFtIHt2ZWMzfSBiIHRoZSBzZWNvbmQgb3BlcmFuZAogICAqIEBwYXJhbSB7TnVtYmVyfSBzY2FsZSB0aGUgYW1vdW50IHRvIHNjYWxlIGIgYnkgYmVmb3JlIGFkZGluZwogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiBzY2FsZUFuZEFkZChvdXQsIGEsIGIsIHNjYWxlKSB7CiAgICAgIG91dFswXSA9IGFbMF0gKyAoYlswXSAqIHNjYWxlKTsKICAgICAgb3V0WzFdID0gYVsxXSArIChiWzFdICogc2NhbGUpOwogICAgICBvdXRbMl0gPSBhWzJdICsgKGJbMl0gKiBzY2FsZSk7CiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciBkaXN0YW5jZV8xID0gZGlzdGFuY2U7CgogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIGV1Y2xpZGlhbiBkaXN0YW5jZSBiZXR3ZWVuIHR3byB2ZWMzJ3MKICAgKgogICAqIEBwYXJhbSB7dmVjM30gYSB0aGUgZmlyc3Qgb3BlcmFuZAogICAqIEBwYXJhbSB7dmVjM30gYiB0aGUgc2Vjb25kIG9wZXJhbmQKICAgKiBAcmV0dXJucyB7TnVtYmVyfSBkaXN0YW5jZSBiZXR3ZWVuIGEgYW5kIGIKICAgKi8KICBmdW5jdGlvbiBkaXN0YW5jZShhLCBiKSB7CiAgICAgIHZhciB4ID0gYlswXSAtIGFbMF0sCiAgICAgICAgICB5ID0gYlsxXSAtIGFbMV0sCiAgICAgICAgICB6ID0gYlsyXSAtIGFbMl07CiAgICAgIHJldHVybiBNYXRoLnNxcnQoeCp4ICsgeSp5ICsgeip6KQogIH0KCiAgdmFyIGRpc3QgPSBkaXN0YW5jZV8xOwoKICB2YXIgc3F1YXJlZERpc3RhbmNlXzEgPSBzcXVhcmVkRGlzdGFuY2U7CgogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIHNxdWFyZWQgZXVjbGlkaWFuIGRpc3RhbmNlIGJldHdlZW4gdHdvIHZlYzMncwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBhIHRoZSBmaXJzdCBvcGVyYW5kCiAgICogQHBhcmFtIHt2ZWMzfSBiIHRoZSBzZWNvbmQgb3BlcmFuZAogICAqIEByZXR1cm5zIHtOdW1iZXJ9IHNxdWFyZWQgZGlzdGFuY2UgYmV0d2VlbiBhIGFuZCBiCiAgICovCiAgZnVuY3Rpb24gc3F1YXJlZERpc3RhbmNlKGEsIGIpIHsKICAgICAgdmFyIHggPSBiWzBdIC0gYVswXSwKICAgICAgICAgIHkgPSBiWzFdIC0gYVsxXSwKICAgICAgICAgIHogPSBiWzJdIC0gYVsyXTsKICAgICAgcmV0dXJuIHgqeCArIHkqeSArIHoqegogIH0KCiAgdmFyIHNxckRpc3QgPSBzcXVhcmVkRGlzdGFuY2VfMTsKCiAgdmFyIGxlbmd0aF8xID0gbGVuZ3RoOwoKICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBsZW5ndGggb2YgYSB2ZWMzCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdmVjdG9yIHRvIGNhbGN1bGF0ZSBsZW5ndGggb2YKICAgKiBAcmV0dXJucyB7TnVtYmVyfSBsZW5ndGggb2YgYQogICAqLwogIGZ1bmN0aW9uIGxlbmd0aChhKSB7CiAgICAgIHZhciB4ID0gYVswXSwKICAgICAgICAgIHkgPSBhWzFdLAogICAgICAgICAgeiA9IGFbMl07CiAgICAgIHJldHVybiBNYXRoLnNxcnQoeCp4ICsgeSp5ICsgeip6KQogIH0KCiAgdmFyIGxlbiA9IGxlbmd0aF8xOwoKICB2YXIgc3F1YXJlZExlbmd0aF8xID0gc3F1YXJlZExlbmd0aDsKCiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgc3F1YXJlZCBsZW5ndGggb2YgYSB2ZWMzCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdmVjdG9yIHRvIGNhbGN1bGF0ZSBzcXVhcmVkIGxlbmd0aCBvZgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IHNxdWFyZWQgbGVuZ3RoIG9mIGEKICAgKi8KICBmdW5jdGlvbiBzcXVhcmVkTGVuZ3RoKGEpIHsKICAgICAgdmFyIHggPSBhWzBdLAogICAgICAgICAgeSA9IGFbMV0sCiAgICAgICAgICB6ID0gYVsyXTsKICAgICAgcmV0dXJuIHgqeCArIHkqeSArIHoqegogIH0KCiAgdmFyIHNxckxlbiA9IHNxdWFyZWRMZW5ndGhfMTsKCiAgdmFyIG5lZ2F0ZV8xID0gbmVnYXRlOwoKICAvKioKICAgKiBOZWdhdGVzIHRoZSBjb21wb25lbnRzIG9mIGEgdmVjMwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdmVjdG9yIHRvIG5lZ2F0ZQogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiBuZWdhdGUob3V0LCBhKSB7CiAgICAgIG91dFswXSA9IC1hWzBdOwogICAgICBvdXRbMV0gPSAtYVsxXTsKICAgICAgb3V0WzJdID0gLWFbMl07CiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciBpbnZlcnNlXzEgPSBpbnZlcnNlOwoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBpbnZlcnNlIG9mIHRoZSBjb21wb25lbnRzIG9mIGEgdmVjMwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdmVjdG9yIHRvIGludmVydAogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiBpbnZlcnNlKG91dCwgYSkgewogICAgb3V0WzBdID0gMS4wIC8gYVswXTsKICAgIG91dFsxXSA9IDEuMCAvIGFbMV07CiAgICBvdXRbMl0gPSAxLjAgLyBhWzJdOwogICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIGNyb3NzXzEgPSBjcm9zczsKCiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGNyb3NzIHByb2R1Y3Qgb2YgdHdvIHZlYzMncwogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdGhlIGZpcnN0IG9wZXJhbmQKICAgKiBAcGFyYW0ge3ZlYzN9IGIgdGhlIHNlY29uZCBvcGVyYW5kCiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIGNyb3NzKG91dCwgYSwgYikgewogICAgICB2YXIgYXggPSBhWzBdLCBheSA9IGFbMV0sIGF6ID0gYVsyXSwKICAgICAgICAgIGJ4ID0gYlswXSwgYnkgPSBiWzFdLCBieiA9IGJbMl07CgogICAgICBvdXRbMF0gPSBheSAqIGJ6IC0gYXogKiBieTsKICAgICAgb3V0WzFdID0gYXogKiBieCAtIGF4ICogYno7CiAgICAgIG91dFsyXSA9IGF4ICogYnkgLSBheSAqIGJ4OwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgbGVycF8xID0gbGVycDsKCiAgLyoqCiAgICogUGVyZm9ybXMgYSBsaW5lYXIgaW50ZXJwb2xhdGlvbiBiZXR3ZWVuIHR3byB2ZWMzJ3MKICAgKgogICAqIEBwYXJhbSB7dmVjM30gb3V0IHRoZSByZWNlaXZpbmcgdmVjdG9yCiAgICogQHBhcmFtIHt2ZWMzfSBhIHRoZSBmaXJzdCBvcGVyYW5kCiAgICogQHBhcmFtIHt2ZWMzfSBiIHRoZSBzZWNvbmQgb3BlcmFuZAogICAqIEBwYXJhbSB7TnVtYmVyfSB0IGludGVycG9sYXRpb24gYW1vdW50IGJldHdlZW4gdGhlIHR3byBpbnB1dHMKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gbGVycChvdXQsIGEsIGIsIHQpIHsKICAgICAgdmFyIGF4ID0gYVswXSwKICAgICAgICAgIGF5ID0gYVsxXSwKICAgICAgICAgIGF6ID0gYVsyXTsKICAgICAgb3V0WzBdID0gYXggKyB0ICogKGJbMF0gLSBheCk7CiAgICAgIG91dFsxXSA9IGF5ICsgdCAqIChiWzFdIC0gYXkpOwogICAgICBvdXRbMl0gPSBheiArIHQgKiAoYlsyXSAtIGF6KTsKICAgICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIHJhbmRvbV8xID0gcmFuZG9tOwoKICAvKioKICAgKiBHZW5lcmF0ZXMgYSByYW5kb20gdmVjdG9yIHdpdGggdGhlIGdpdmVuIHNjYWxlCiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7TnVtYmVyfSBbc2NhbGVdIExlbmd0aCBvZiB0aGUgcmVzdWx0aW5nIHZlY3Rvci4gSWYgb21taXR0ZWQsIGEgdW5pdCB2ZWN0b3Igd2lsbCBiZSByZXR1cm5lZAogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiByYW5kb20ob3V0LCBzY2FsZSkgewogICAgICBzY2FsZSA9IHNjYWxlIHx8IDEuMDsKCiAgICAgIHZhciByID0gTWF0aC5yYW5kb20oKSAqIDIuMCAqIE1hdGguUEk7CiAgICAgIHZhciB6ID0gKE1hdGgucmFuZG9tKCkgKiAyLjApIC0gMS4wOwogICAgICB2YXIgelNjYWxlID0gTWF0aC5zcXJ0KDEuMC16KnopICogc2NhbGU7CgogICAgICBvdXRbMF0gPSBNYXRoLmNvcyhyKSAqIHpTY2FsZTsKICAgICAgb3V0WzFdID0gTWF0aC5zaW4ocikgKiB6U2NhbGU7CiAgICAgIG91dFsyXSA9IHogKiBzY2FsZTsKICAgICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIHRyYW5zZm9ybU1hdDRfMSA9IHRyYW5zZm9ybU1hdDQ7CgogIC8qKgogICAqIFRyYW5zZm9ybXMgdGhlIHZlYzMgd2l0aCBhIG1hdDQuCiAgICogNHRoIHZlY3RvciBjb21wb25lbnQgaXMgaW1wbGljaXRseSAnMScKICAgKgogICAqIEBwYXJhbSB7dmVjM30gb3V0IHRoZSByZWNlaXZpbmcgdmVjdG9yCiAgICogQHBhcmFtIHt2ZWMzfSBhIHRoZSB2ZWN0b3IgdG8gdHJhbnNmb3JtCiAgICogQHBhcmFtIHttYXQ0fSBtIG1hdHJpeCB0byB0cmFuc2Zvcm0gd2l0aAogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiB0cmFuc2Zvcm1NYXQ0KG91dCwgYSwgbSkgewogICAgICB2YXIgeCA9IGFbMF0sIHkgPSBhWzFdLCB6ID0gYVsyXSwKICAgICAgICAgIHcgPSBtWzNdICogeCArIG1bN10gKiB5ICsgbVsxMV0gKiB6ICsgbVsxNV07CiAgICAgIHcgPSB3IHx8IDEuMDsKICAgICAgb3V0WzBdID0gKG1bMF0gKiB4ICsgbVs0XSAqIHkgKyBtWzhdICogeiArIG1bMTJdKSAvIHc7CiAgICAgIG91dFsxXSA9IChtWzFdICogeCArIG1bNV0gKiB5ICsgbVs5XSAqIHogKyBtWzEzXSkgLyB3OwogICAgICBvdXRbMl0gPSAobVsyXSAqIHggKyBtWzZdICogeSArIG1bMTBdICogeiArIG1bMTRdKSAvIHc7CiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciB0cmFuc2Zvcm1NYXQzXzEgPSB0cmFuc2Zvcm1NYXQzOwoKICAvKioKICAgKiBUcmFuc2Zvcm1zIHRoZSB2ZWMzIHdpdGggYSBtYXQzLgogICAqCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgdGhlIHJlY2VpdmluZyB2ZWN0b3IKICAgKiBAcGFyYW0ge3ZlYzN9IGEgdGhlIHZlY3RvciB0byB0cmFuc2Zvcm0KICAgKiBAcGFyYW0ge21hdDR9IG0gdGhlIDN4MyBtYXRyaXggdG8gdHJhbnNmb3JtIHdpdGgKICAgKiBAcmV0dXJucyB7dmVjM30gb3V0CiAgICovCiAgZnVuY3Rpb24gdHJhbnNmb3JtTWF0MyhvdXQsIGEsIG0pIHsKICAgICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl07CiAgICAgIG91dFswXSA9IHggKiBtWzBdICsgeSAqIG1bM10gKyB6ICogbVs2XTsKICAgICAgb3V0WzFdID0geCAqIG1bMV0gKyB5ICogbVs0XSArIHogKiBtWzddOwogICAgICBvdXRbMl0gPSB4ICogbVsyXSArIHkgKiBtWzVdICsgeiAqIG1bOF07CiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciB0cmFuc2Zvcm1RdWF0XzEgPSB0cmFuc2Zvcm1RdWF0OwoKICAvKioKICAgKiBUcmFuc2Zvcm1zIHRoZSB2ZWMzIHdpdGggYSBxdWF0CiAgICoKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCB0aGUgcmVjZWl2aW5nIHZlY3RvcgogICAqIEBwYXJhbSB7dmVjM30gYSB0aGUgdmVjdG9yIHRvIHRyYW5zZm9ybQogICAqIEBwYXJhbSB7cXVhdH0gcSBxdWF0ZXJuaW9uIHRvIHRyYW5zZm9ybSB3aXRoCiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIHRyYW5zZm9ybVF1YXQob3V0LCBhLCBxKSB7CiAgICAgIC8vIGJlbmNobWFya3M6IGh0dHA6Ly9qc3BlcmYuY29tL3F1YXRlcm5pb24tdHJhbnNmb3JtLXZlYzMtaW1wbGVtZW50YXRpb25zCgogICAgICB2YXIgeCA9IGFbMF0sIHkgPSBhWzFdLCB6ID0gYVsyXSwKICAgICAgICAgIHF4ID0gcVswXSwgcXkgPSBxWzFdLCBxeiA9IHFbMl0sIHF3ID0gcVszXSwKCiAgICAgICAgICAvLyBjYWxjdWxhdGUgcXVhdCAqIHZlYwogICAgICAgICAgaXggPSBxdyAqIHggKyBxeSAqIHogLSBxeiAqIHksCiAgICAgICAgICBpeSA9IHF3ICogeSArIHF6ICogeCAtIHF4ICogeiwKICAgICAgICAgIGl6ID0gcXcgKiB6ICsgcXggKiB5IC0gcXkgKiB4LAogICAgICAgICAgaXcgPSAtcXggKiB4IC0gcXkgKiB5IC0gcXogKiB6OwoKICAgICAgLy8gY2FsY3VsYXRlIHJlc3VsdCAqIGludmVyc2UgcXVhdAogICAgICBvdXRbMF0gPSBpeCAqIHF3ICsgaXcgKiAtcXggKyBpeSAqIC1xeiAtIGl6ICogLXF5OwogICAgICBvdXRbMV0gPSBpeSAqIHF3ICsgaXcgKiAtcXkgKyBpeiAqIC1xeCAtIGl4ICogLXF6OwogICAgICBvdXRbMl0gPSBpeiAqIHF3ICsgaXcgKiAtcXogKyBpeCAqIC1xeSAtIGl5ICogLXF4OwogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgcm90YXRlWF8xID0gcm90YXRlWDsKCiAgLyoqCiAgICogUm90YXRlIGEgM0QgdmVjdG9yIGFyb3VuZCB0aGUgeC1heGlzCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgVGhlIHJlY2VpdmluZyB2ZWMzCiAgICogQHBhcmFtIHt2ZWMzfSBhIFRoZSB2ZWMzIHBvaW50IHRvIHJvdGF0ZQogICAqIEBwYXJhbSB7dmVjM30gYiBUaGUgb3JpZ2luIG9mIHRoZSByb3RhdGlvbgogICAqIEBwYXJhbSB7TnVtYmVyfSBjIFRoZSBhbmdsZSBvZiByb3RhdGlvbgogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiByb3RhdGVYKG91dCwgYSwgYiwgYyl7CiAgICAgIHZhciBieSA9IGJbMV07CiAgICAgIHZhciBieiA9IGJbMl07CgogICAgICAvLyBUcmFuc2xhdGUgcG9pbnQgdG8gdGhlIG9yaWdpbgogICAgICB2YXIgcHkgPSBhWzFdIC0gYnk7CiAgICAgIHZhciBweiA9IGFbMl0gLSBiejsKCiAgICAgIHZhciBzYyA9IE1hdGguc2luKGMpOwogICAgICB2YXIgY2MgPSBNYXRoLmNvcyhjKTsKCiAgICAgIC8vIHBlcmZvcm0gcm90YXRpb24gYW5kIHRyYW5zbGF0ZSB0byBjb3JyZWN0IHBvc2l0aW9uCiAgICAgIG91dFswXSA9IGFbMF07CiAgICAgIG91dFsxXSA9IGJ5ICsgcHkgKiBjYyAtIHB6ICogc2M7CiAgICAgIG91dFsyXSA9IGJ6ICsgcHkgKiBzYyArIHB6ICogY2M7CgogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgcm90YXRlWV8xID0gcm90YXRlWTsKCiAgLyoqCiAgICogUm90YXRlIGEgM0QgdmVjdG9yIGFyb3VuZCB0aGUgeS1heGlzCiAgICogQHBhcmFtIHt2ZWMzfSBvdXQgVGhlIHJlY2VpdmluZyB2ZWMzCiAgICogQHBhcmFtIHt2ZWMzfSBhIFRoZSB2ZWMzIHBvaW50IHRvIHJvdGF0ZQogICAqIEBwYXJhbSB7dmVjM30gYiBUaGUgb3JpZ2luIG9mIHRoZSByb3RhdGlvbgogICAqIEBwYXJhbSB7TnVtYmVyfSBjIFRoZSBhbmdsZSBvZiByb3RhdGlvbgogICAqIEByZXR1cm5zIHt2ZWMzfSBvdXQKICAgKi8KICBmdW5jdGlvbiByb3RhdGVZKG91dCwgYSwgYiwgYyl7CiAgICAgIHZhciBieCA9IGJbMF07CiAgICAgIHZhciBieiA9IGJbMl07CgogICAgICAvLyB0cmFuc2xhdGUgcG9pbnQgdG8gdGhlIG9yaWdpbgogICAgICB2YXIgcHggPSBhWzBdIC0gYng7CiAgICAgIHZhciBweiA9IGFbMl0gLSBiejsKICAgICAgCiAgICAgIHZhciBzYyA9IE1hdGguc2luKGMpOwogICAgICB2YXIgY2MgPSBNYXRoLmNvcyhjKTsKICAgIAogICAgICAvLyBwZXJmb3JtIHJvdGF0aW9uIGFuZCB0cmFuc2xhdGUgdG8gY29ycmVjdCBwb3NpdGlvbgogICAgICBvdXRbMF0gPSBieCArIHB6ICogc2MgKyBweCAqIGNjOwogICAgICBvdXRbMV0gPSBhWzFdOwogICAgICBvdXRbMl0gPSBieiArIHB6ICogY2MgLSBweCAqIHNjOwogICAgCiAgICAgIHJldHVybiBvdXQKICB9CgogIHZhciByb3RhdGVaXzEgPSByb3RhdGVaOwoKICAvKioKICAgKiBSb3RhdGUgYSAzRCB2ZWN0b3IgYXJvdW5kIHRoZSB6LWF4aXMKICAgKiBAcGFyYW0ge3ZlYzN9IG91dCBUaGUgcmVjZWl2aW5nIHZlYzMKICAgKiBAcGFyYW0ge3ZlYzN9IGEgVGhlIHZlYzMgcG9pbnQgdG8gcm90YXRlCiAgICogQHBhcmFtIHt2ZWMzfSBiIFRoZSBvcmlnaW4gb2YgdGhlIHJvdGF0aW9uCiAgICogQHBhcmFtIHtOdW1iZXJ9IGMgVGhlIGFuZ2xlIG9mIHJvdGF0aW9uCiAgICogQHJldHVybnMge3ZlYzN9IG91dAogICAqLwogIGZ1bmN0aW9uIHJvdGF0ZVoob3V0LCBhLCBiLCBjKXsKICAgICAgdmFyIGJ4ID0gYlswXTsKICAgICAgdmFyIGJ5ID0gYlsxXTsKCiAgICAgIC8vVHJhbnNsYXRlIHBvaW50IHRvIHRoZSBvcmlnaW4KICAgICAgdmFyIHB4ID0gYVswXSAtIGJ4OwogICAgICB2YXIgcHkgPSBhWzFdIC0gYnk7CiAgICAKICAgICAgdmFyIHNjID0gTWF0aC5zaW4oYyk7CiAgICAgIHZhciBjYyA9IE1hdGguY29zKGMpOwoKICAgICAgLy8gcGVyZm9ybSByb3RhdGlvbiBhbmQgdHJhbnNsYXRlIHRvIGNvcnJlY3QgcG9zaXRpb24KICAgICAgb3V0WzBdID0gYnggKyBweCAqIGNjIC0gcHkgKiBzYzsKICAgICAgb3V0WzFdID0gYnkgKyBweCAqIHNjICsgcHkgKiBjYzsKICAgICAgb3V0WzJdID0gYVsyXTsKICAgIAogICAgICByZXR1cm4gb3V0CiAgfQoKICB2YXIgZm9yRWFjaF8xID0gZm9yRWFjaDsKCiAgdmFyIHZlYyA9IGNyZWF0ZV8xKCk7CgogIC8qKgogICAqIFBlcmZvcm0gc29tZSBvcGVyYXRpb24gb3ZlciBhbiBhcnJheSBvZiB2ZWMzcy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGEgdGhlIGFycmF5IG9mIHZlY3RvcnMgdG8gaXRlcmF0ZSBvdmVyCiAgICogQHBhcmFtIHtOdW1iZXJ9IHN0cmlkZSBOdW1iZXIgb2YgZWxlbWVudHMgYmV0d2VlbiB0aGUgc3RhcnQgb2YgZWFjaCB2ZWMzLiBJZiAwIGFzc3VtZXMgdGlnaHRseSBwYWNrZWQKICAgKiBAcGFyYW0ge051bWJlcn0gb2Zmc2V0IE51bWJlciBvZiBlbGVtZW50cyB0byBza2lwIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5CiAgICogQHBhcmFtIHtOdW1iZXJ9IGNvdW50IE51bWJlciBvZiB2ZWMzcyB0byBpdGVyYXRlIG92ZXIuIElmIDAgaXRlcmF0ZXMgb3ZlciBlbnRpcmUgYXJyYXkKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBGdW5jdGlvbiB0byBjYWxsIGZvciBlYWNoIHZlY3RvciBpbiB0aGUgYXJyYXkKICAgKiBAcGFyYW0ge09iamVjdH0gW2FyZ10gYWRkaXRpb25hbCBhcmd1bWVudCB0byBwYXNzIHRvIGZuCiAgICogQHJldHVybnMge0FycmF5fSBhCiAgICogQGZ1bmN0aW9uCiAgICovCiAgZnVuY3Rpb24gZm9yRWFjaChhLCBzdHJpZGUsIG9mZnNldCwgY291bnQsIGZuLCBhcmcpIHsKICAgICAgICAgIHZhciBpLCBsOwogICAgICAgICAgaWYoIXN0cmlkZSkgewogICAgICAgICAgICAgIHN0cmlkZSA9IDM7CiAgICAgICAgICB9CgogICAgICAgICAgaWYoIW9mZnNldCkgewogICAgICAgICAgICAgIG9mZnNldCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgICAgIGlmKGNvdW50KSB7CiAgICAgICAgICAgICAgbCA9IE1hdGgubWluKChjb3VudCAqIHN0cmlkZSkgKyBvZmZzZXQsIGEubGVuZ3RoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbCA9IGEubGVuZ3RoOwogICAgICAgICAgfQoKICAgICAgICAgIGZvcihpID0gb2Zmc2V0OyBpIDwgbDsgaSArPSBzdHJpZGUpIHsKICAgICAgICAgICAgICB2ZWNbMF0gPSBhW2ldOyAKICAgICAgICAgICAgICB2ZWNbMV0gPSBhW2krMV07IAogICAgICAgICAgICAgIHZlY1syXSA9IGFbaSsyXTsKICAgICAgICAgICAgICBmbih2ZWMsIHZlYywgYXJnKTsKICAgICAgICAgICAgICBhW2ldID0gdmVjWzBdOyAKICAgICAgICAgICAgICBhW2krMV0gPSB2ZWNbMV07IAogICAgICAgICAgICAgIGFbaSsyXSA9IHZlY1syXTsKICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgcmV0dXJuIGEKICB9CgogIHZhciBnbFZlYzMgPSB7CiAgICBFUFNJTE9OOiBlcHNpbG9uCiAgICAsIGNyZWF0ZTogY3JlYXRlXzEKICAgICwgY2xvbmU6IGNsb25lXzEKICAgICwgYW5nbGU6IGFuZ2xlXzEKICAgICwgZnJvbVZhbHVlczogZnJvbVZhbHVlc18xCiAgICAsIGNvcHk6IGNvcHlfMQogICAgLCBzZXQ6IHNldF8xCiAgICAsIGVxdWFsczogZXF1YWxzXzEKICAgICwgZXhhY3RFcXVhbHM6IGV4YWN0RXF1YWxzXzEKICAgICwgYWRkOiBhZGRfMQogICAgLCBzdWJ0cmFjdDogc3VidHJhY3RfMQogICAgLCBzdWI6IHN1YgogICAgLCBtdWx0aXBseTogbXVsdGlwbHlfMQogICAgLCBtdWw6IG11bAogICAgLCBkaXZpZGU6IGRpdmlkZV8xCiAgICAsIGRpdjogZGl2CiAgICAsIG1pbjogbWluXzEKICAgICwgbWF4OiBtYXhfMQogICAgLCBmbG9vcjogZmxvb3JfMQogICAgLCBjZWlsOiBjZWlsXzEKICAgICwgcm91bmQ6IHJvdW5kXzEKICAgICwgc2NhbGU6IHNjYWxlXzEKICAgICwgc2NhbGVBbmRBZGQ6IHNjYWxlQW5kQWRkXzEKICAgICwgZGlzdGFuY2U6IGRpc3RhbmNlXzEKICAgICwgZGlzdDogZGlzdAogICAgLCBzcXVhcmVkRGlzdGFuY2U6IHNxdWFyZWREaXN0YW5jZV8xCiAgICAsIHNxckRpc3Q6IHNxckRpc3QKICAgICwgbGVuZ3RoOiBsZW5ndGhfMQogICAgLCBsZW46IGxlbgogICAgLCBzcXVhcmVkTGVuZ3RoOiBzcXVhcmVkTGVuZ3RoXzEKICAgICwgc3FyTGVuOiBzcXJMZW4KICAgICwgbmVnYXRlOiBuZWdhdGVfMQogICAgLCBpbnZlcnNlOiBpbnZlcnNlXzEKICAgICwgbm9ybWFsaXplOiBub3JtYWxpemVfMQogICAgLCBkb3Q6IGRvdF8xCiAgICAsIGNyb3NzOiBjcm9zc18xCiAgICAsIGxlcnA6IGxlcnBfMQogICAgLCByYW5kb206IHJhbmRvbV8xCiAgICAsIHRyYW5zZm9ybU1hdDQ6IHRyYW5zZm9ybU1hdDRfMQogICAgLCB0cmFuc2Zvcm1NYXQzOiB0cmFuc2Zvcm1NYXQzXzEKICAgICwgdHJhbnNmb3JtUXVhdDogdHJhbnNmb3JtUXVhdF8xCiAgICAsIHJvdGF0ZVg6IHJvdGF0ZVhfMQogICAgLCByb3RhdGVZOiByb3RhdGVZXzEKICAgICwgcm90YXRlWjogcm90YXRlWl8xCiAgICAsIGZvckVhY2g6IGZvckVhY2hfMQogIH07CgogIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eSQ1KG9iaiwga2V5LCB2YWx1ZSkgewogICAgICBpZiAoa2V5IGluIG9iaikgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9ialtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICB9CiAgLyoqCiAgICogQSB1dGlsaXR5IGNsYXNzIGZvciBhbGwgdGhpbmdzIHJlbGF0ZWQgdG8gY2h1bmtzIGFuZCBjaHVuayBjb29yZGluYXRlcy4KICAgKgogICAqICMgRXhhbXBsZQogICAqIGBgYHRzCiAgICogLy8gR2V0IHRoZSBjaHVuayBjb29yZGluYXRlcyBvZiBhIHZveGVsLCAoMCwgMCkgd2l0aCBgY2h1bmtTaXplPTE2YC4KICAgKiBjb25zdCBjaHVua0Nvb3JkcyA9IENodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rKFsxLCAxMCwgMTJdKTsKICAgKiBgYGAKICAgKgogICAqIEBjYXRlZ29yeSBVdGlscwogICAqLyBjbGFzcyBDaHVua1V0aWxzIHsKICAgICAgY29uc3RydWN0b3IoKXsKICAgICAgLy8gTk9USElORwogICAgICB9CiAgfQogIC8qKgogICAgICogQ29udmVydCBhIDJEIGNodW5rIGNvb3JkaW5hdGUgdG8gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIGNvb3JkcyBUaGUgY29vcmRpbmF0ZXMgdG8gY29udmVydC4KICAgICAqIEBwYXJhbSBjb25jYXQgVGhlIGNvbmNhdGVuYXRpb24gc3RyaW5nIHRvIHVzZS4KICAgICAqIEByZXR1cm5zIFRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGNvb3JkaW5hdGVzLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ1KENodW5rVXRpbHMsICJnZXRDaHVua05hbWUiLCAoY29vcmRzLCBjb25jYXQgPSAifCIpPT57CiAgICAgIHJldHVybiBjb29yZHNbMF0gKyBjb25jYXQgKyBjb29yZHNbMV07CiAgfSk7CiAgLyoqCiAgICAgKiBDb252ZXJ0IGEgM0Qgdm94ZWwgY29vcmRpbmF0ZSB0byBhIHN0cmluZyByZXByZXNlbnRhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gY29vcmRzIFRoZSBjb29yZGluYXRlcyB0byBjb252ZXJ0LgogICAgICogQHBhcmFtIGNvbmNhdCBUaGUgY29uY2F0ZW5hdGlvbiBzdHJpbmcgdG8gdXNlLgogICAgICogQHJldHVybnMgVGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgY29vcmRpbmF0ZXMuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDUoQ2h1bmtVdGlscywgImdldFZveGVsTmFtZSIsIChjb29yZHMsIGNvbmNhdCA9ICJ8Iik9PnsKICAgICAgcmV0dXJuIChjb29yZHNbMF0gfCAwKSArIGNvbmNhdCArIChjb29yZHNbMV0gfCAwKSArIGNvbmNhdCArIChjb29yZHNbMl0gfCAwKTsKICB9KTsKICAvKioKICAgICAqIEdpdmVuIGEgY2h1bmsgcmVwcmVzZW50YXRpb24sIHBhcnNlIHRoZSBjaHVuayBjb29yZGluYXRlcy4KICAgICAqCiAgICAgKiBAcGFyYW0gbmFtZSBUaGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjaHVuay4KICAgICAqIEBwYXJhbSBjb25jYXQgVGhlIGNvbmNhdGVuYXRpb24gc3RyaW5nIHVzZWQuCiAgICAgKiBAcmV0dXJucyBUaGUgcGFyc2VkIGNodW5rIGNvb3JkaW5hdGVzLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ1KENodW5rVXRpbHMsICJwYXJzZUNodW5rTmFtZSIsIChuYW1lLCBjb25jYXQgPSAifCIpPT57CiAgICAgIHJldHVybiBuYW1lLnNwbGl0KGNvbmNhdCkubWFwKChzKT0+cGFyc2VJbnQocywgMTApKTsKICB9KTsKICAvKioKICAgICAqIFNjYWxlIGFuZCBmbG9vciBhIDNEIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIGNvb3JkcyBUaGUgY29vcmRpbmF0ZXMgdG8gc2NhbGUgYW5kIGZsb29yLgogICAgICogQHBhcmFtIGZhY3RvciBUaGUgZmFjdG9yIHRvIHNjYWxlIGJ5LgogICAgICogQHJldHVybnMgVGhlIHNjYWxlZCBhbmQgZmxvb3JlZCBjb29yZGluYXRlcy4KICAgICAqLyBfZGVmaW5lUHJvcGVydHkkNShDaHVua1V0aWxzLCAic2NhbGVDb29yZHNGIiwgKGNvb3JkcywgZmFjdG9yKT0+ewogICAgICBjb25zdCByZXN1bHQgPSBbCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAKICAgICAgXTsKICAgICAgY29uc3Qgc2NhbGVkID0gZ2xWZWMzLnNjYWxlKHJlc3VsdCwgY29vcmRzLCBmYWN0b3IpOwogICAgICByZXR1cm4gZ2xWZWMzLmZsb29yKHNjYWxlZCwgc2NhbGVkKTsKICB9KTsKICAvKioKICAgICAqIE1hcCBhIDNEIHZveGVsIGNvb3JkaW5hdGUgdG8gdGhlIGxvY2FsIDNEIHZveGVsIGNvb3JkaW5hdGUgaW4gdGhlIHNpdHVhdGVkIGNodW5rLgogICAgICoKICAgICAqIEBwYXJhbSB2b3hlbFBvcyBUaGUgdm94ZWwgY29vcmRpbmF0ZSB0byBtYXAuCiAgICAgKiBAcGFyYW0gY2h1bmtTaXplIFRoZSBob3Jpem9udGFsIGRpbWVuc2lvbiBvZiBhIGNodW5rLgogICAgICogQHJldHVybnMgVGhlIG1hcHBlZCBjb29yZGluYXRlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ1KENodW5rVXRpbHMsICJtYXBWb3hlbFRvQ2h1bmtMb2NhbCIsICh2b3hlbFBvcywgY2h1bmtTaXplKT0+ewogICAgICBjb25zdCBbY3gsIGN6XSA9IENodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rKHZveGVsUG9zLCBjaHVua1NpemUpOwogICAgICBjb25zdCBbdngsIHZ5LCB2el0gPSB2b3hlbFBvczsKICAgICAgcmV0dXJuIFsKICAgICAgICAgIHZ4IC0gY3ggKiBjaHVua1NpemUsCiAgICAgICAgICB2eSwKICAgICAgICAgIHZ6IC0gY3ogKiBjaHVua1NpemUKICAgICAgXTsKICB9KTsKICAvKioKICAgICAqIE1hcCBhIDNEIHZveGVsIGNvb3JkaW5hdGUgdG8gdGhlIDJEIGNodW5rIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZveGVsUG9zIFRoZSB2b3hlbCBjb29yZGluYXRlIHRvIG1hcC4KICAgICAqIEBwYXJhbSBjaHVua1NpemUgIFRoZSBob3Jpem9udGFsIGRpbWVuc2lvbiBvZiBhIGNodW5rLgogICAgICogQHJldHVybnMgVGhlIG1hcHBlZCBjb29yZGluYXRlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ1KENodW5rVXRpbHMsICJtYXBWb3hlbFRvQ2h1bmsiLCAodm94ZWxQb3MsIGNodW5rU2l6ZSk9PnsKICAgICAgY29uc3QgY29vcmRzMyA9IENodW5rVXRpbHMuc2NhbGVDb29yZHNGKHZveGVsUG9zLCAxIC8gY2h1bmtTaXplKTsKICAgICAgcmV0dXJuIFsKICAgICAgICAgIGNvb3JkczNbMF0sCiAgICAgICAgICBjb29yZHMzWzJdCiAgICAgIF07CiAgfSk7CiAgLyoqCiAgICAgKiBNYXAgYSAyRCBjaHVuayBjb29yZGluYXRlIHRvIHRoZSAzRCB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSBjaHVua1BvcyBUaGUgY2h1bmsgY29vcmRpbmF0ZSB0byBtYXAuCiAgICAgKiBAcGFyYW0gY2h1bmtTaXplIFRoZSBob3Jpem9udGFsIGRpbWVuc2lvbiBvZiBhIGNodW5rLgogICAgICogQHJldHVybnMgVGhlIG1hcHBlZCBjb29yZGluYXRlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ1KENodW5rVXRpbHMsICJtYXBDaHVua1RvVm94ZWwiLCAoY2h1bmtQb3MsIGNodW5rU2l6ZSk9PnsKICAgICAgY29uc3QgcmVzdWx0ID0gWwogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwCiAgICAgIF07CiAgICAgIGdsVmVjMy5jb3B5KHJlc3VsdCwgWwogICAgICAgICAgY2h1bmtQb3NbMF0sCiAgICAgICAgICAwLAogICAgICAgICAgY2h1bmtQb3NbMV0KICAgICAgXSk7CiAgICAgIGdsVmVjMy5zY2FsZShyZXN1bHQsIHJlc3VsdCwgY2h1bmtTaXplKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICB9KTsKICAvKioKICAgICAqIE1hcCBhIDNEIHdvcmxkIGNvb3JkaW5hdGUgdG8gdGhlIDNEIHZveGVsIGNvb3JkaW5hdGUuIFNpbmNlIGEgdm94ZWwgaXMKICAgICAqIGV4YWN0bHkgMSB1bml0IGluIHNpemUsIHRoaXMgaXMganVzdCBhIGZsb29yIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gd29ybGRQb3MgVGhlIHdvcmxkIGNvb3JkaW5hdGUgdG8gbWFwLgogICAgICogQHJldHVybnMgVGhlIG1hcHBlZCBjb29yZGluYXRlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ1KENodW5rVXRpbHMsICJtYXBXb3JsZFRvVm94ZWwiLCAod29ybGRQb3MpPT57CiAgICAgIHJldHVybiBDaHVua1V0aWxzLnNjYWxlQ29vcmRzRih3b3JsZFBvcywgMSk7CiAgfSk7CgogIC8qKgogICAqIEEgdXRpbGl0eSBjbGFzcyBmb3IgZXh0cmFjdGluZyBhbmQgaW5zZXJ0aW5nIGxpZ2h0IGRhdGEgZnJvbSBhbmQgaW50byBudW1iZXJzLgogICAqCiAgICogVGhlIGxpZ2h0IGRhdGEgaXMgc3RvcmVkIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogICAqIC0gU3VubGlnaHQ6IGAweGZmMDAwMDAwYAogICAqIC0gUmVkIGxpZ2h0OiBgMHgwMGZmMDAwMGAKICAgKiAtIEdyZWVuIGxpZ2h0OiBgMHgwMDAwZmYwMGAKICAgKiAtIEJsdWUgbGlnaHQ6IGAweDAwMDAwMGZmYAogICAqCiAgICogVE9ETy1ET0NTCiAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgbGlnaHRpbmcgZGF0YSwgc2VlIFtoZXJlXSgvKQogICAqCiAgICogIyBFeGFtcGxlCiAgICogYGBgdHMKICAgKiAvLyBJbnNlcnQgYSBsZXZlbCAxMyBzdW5saWdodCBpbnRvIHplcm8uCiAgICogY29uc3QgbnVtYmVyID0gTGlnaHRVdGlscy5pbnNlcnRTdW5saWdodCgwLCAxMyk7CiAgICogYGBgCiAgICoKICAgKiBAY2F0ZWdvcnkgVXRpbHMKICAgKi8gZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5JDQob2JqLCBrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gb2JqOwogIH0KICBjbGFzcyBMaWdodFV0aWxzIHsKICAgICAgY29uc3RydWN0b3IoKXsKICAgICAgLy8gTk9USElORwogICAgICB9CiAgfQogIC8qKgogICAgICogRXh0cmFjdCB0aGUgc3VubGlnaHQgbGV2ZWwgZnJvbSBhIG51bWJlci4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlnaHQgVGhlIGxpZ2h0IHZhbHVlIHRvIGV4dHJhY3QgZnJvbS4KICAgICAqIEByZXR1cm5zIFRoZSBleHRyYWN0ZWQgc3VubGlnaHQgdmFsdWUuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDQoTGlnaHRVdGlscywgImV4dHJhY3RTdW5saWdodCIsIChsaWdodCk9PnsKICAgICAgcmV0dXJuIGxpZ2h0ID4+IDEyICYgMHhmOwogIH0pOwogIC8qKgogICAgICogSW5zZXJ0IGEgc3VubGlnaHQgbGV2ZWwgaW50byBhIG51bWJlci4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlnaHQgVGhlIGxpZ2h0IHZhbHVlIHRvIGluc2VydCB0aGUgbGV2ZWwgaW50by4KICAgICAqIEBwYXJhbSBsZXZlbCBUaGUgc3VubGlnaHQgbGV2ZWwgdG8gaW5zZXJ0LgogICAgICogQHJldHVybnMgVGhlIGluc2VydGVkIGxpZ2h0IHZhbHVlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJpbnNlcnRTdW5saWdodCIsIChsaWdodCwgbGV2ZWwpPT57CiAgICAgIHJldHVybiBsaWdodCAmIDB4ZmZmIHwgbGV2ZWwgPDwgMTI7CiAgfSk7CiAgLyoqCiAgICAgKiBFeHRyYWN0IHRoZSByZWQgbGlnaHQgbGV2ZWwgZnJvbSBhIG51bWJlci4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlnaHQgVGhlIGxpZ2h0IHZhbHVlIHRvIGV4dHJhY3QgZnJvbS4KICAgICAqIEByZXR1cm5zIFRoZSBleHRyYWN0ZWQgcmVkIGxpZ2h0IHZhbHVlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJleHRyYWN0UmVkTGlnaHQiLCAobGlnaHQpPT57CiAgICAgIHJldHVybiBsaWdodCA+PiA4ICYgMHhmOwogIH0pOwogIC8qKgogICAgICogSW5zZXJ0IGEgcmVkIGxpZ2h0IGxldmVsIGludG8gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIGxpZ2h0IFRoZSBsaWdodCB2YWx1ZSB0byBpbnNlcnQgdGhlIGxldmVsIGludG8uCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIHJlZCBsaWdodCBsZXZlbCB0byBpbnNlcnQuCiAgICAgKiBAcmV0dXJucyBUaGUgaW5zZXJ0ZWQgbGlnaHQgdmFsdWUuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDQoTGlnaHRVdGlscywgImluc2VydFJlZExpZ2h0IiwgKGxpZ2h0LCBsZXZlbCk9PnsKICAgICAgcmV0dXJuIGxpZ2h0ICYgMHhmMGZmIHwgbGV2ZWwgPDwgODsKICB9KTsKICAvKioKICAgICAqIEV4dHJhY3QgdGhlIGdyZWVuIGxpZ2h0IGxldmVsIGZyb20gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIGxpZ2h0IFRoZSBsaWdodCB2YWx1ZSB0byBleHRyYWN0IGZyb20uCiAgICAgKiBAcmV0dXJucyBUaGUgZXh0cmFjdGVkIGdyZWVuIGxpZ2h0IHZhbHVlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJleHRyYWN0R3JlZW5MaWdodCIsIChsaWdodCk9PnsKICAgICAgcmV0dXJuIGxpZ2h0ID4+IDQgJiAweGY7CiAgfSk7CiAgLyoqCiAgICAgKiBJbnNlcnQgYSBncmVlbiBsaWdodCBsZXZlbCBpbnRvIGEgbnVtYmVyLgogICAgICoKICAgICAqIEBwYXJhbSBsaWdodCBUaGUgbGlnaHQgdmFsdWUgdG8gaW5zZXJ0IHRoZSBsZXZlbCBpbnRvLgogICAgICogQHBhcmFtIGxldmVsIFRoZSBncmVlbiBsaWdodCBsZXZlbCB0byBpbnNlcnQuCiAgICAgKiBAcmV0dXJucyBUaGUgaW5zZXJ0ZWQgbGlnaHQgdmFsdWUuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDQoTGlnaHRVdGlscywgImluc2VydEdyZWVuTGlnaHQiLCAobGlnaHQsIGxldmVsKT0+ewogICAgICByZXR1cm4gbGlnaHQgJiAweGZmMGYgfCBsZXZlbCA8PCA0OwogIH0pOwogIC8qKgogICAgICogRXh0cmFjdCB0aGUgYmx1ZSBsaWdodCBsZXZlbCBmcm9tIGEgbnVtYmVyLgogICAgICoKICAgICAqIEBwYXJhbSBsaWdodCBUaGUgbGlnaHQgdmFsdWUgdG8gZXh0cmFjdCBmcm9tLgogICAgICogQHJldHVybnMgVGhlIGV4dHJhY3RlZCBibHVlIGxpZ2h0IHZhbHVlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJleHRyYWN0Qmx1ZUxpZ2h0IiwgKGxpZ2h0KT0+ewogICAgICByZXR1cm4gbGlnaHQgJiAweGY7CiAgfSk7CiAgLyoqCiAgICAgKiBJbnNlcnQgYSBibHVlIGxpZ2h0IGxldmVsIGludG8gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIGxpZ2h0IFRoZSBsaWdodCB2YWx1ZSB0byBpbnNlcnQgdGhlIGxldmVsIGludG8uCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGJsdWUgbGlnaHQgbGV2ZWwgdG8gaW5zZXJ0LgogICAgICogQHJldHVybnMgVGhlIGluc2VydGVkIGxpZ2h0IHZhbHVlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJpbnNlcnRCbHVlTGlnaHQiLCAobGlnaHQsIGxldmVsKT0+ewogICAgICByZXR1cm4gbGlnaHQgJiAweGZmZjAgfCBsZXZlbDsKICB9KTsKICAvKioKICAgICAqIENoZWNrIHRvIHNlZSBpZiBsaWdodCBjYW4gZ28gImludG8iIG9uZSBibG9jaywgZGlzcmVnYXJkaW5nIHRoZSBzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdGFyZ2V0IGJsb2NrJ3MgdHJhbnNwYXJlbmN5LgogICAgICogQHBhcmFtIGR4IFRoZSBjaGFuZ2UgaW4geCBkaXJlY3Rpb24uCiAgICAgKiBAcGFyYW0gZHkgVGhlIGNoYW5nZSBpbiB5IGRpcmVjdGlvbi4KICAgICAqIEBwYXJhbSBkeiBUaGUgY2hhbmdlIGluIHogZGlyZWN0aW9uLgogICAgICogQHJldHVybnMgV2hldGhlciBsaWdodCBjYW4gZW50ZXIgaW50byB0aGUgdGFyZ2V0IGJsb2NrLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJjYW5FbnRlckludG8iLCAodGFyZ2V0LCBkeCwgZHksIGR6KT0+ewogICAgICBpZiAoTWF0aC5hYnMoZHggKyBkeSArIGR6KSAhPT0gMSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGlzbid0IHN1cHBvc2VkIHRvIGhhcHBlbi4gTGlnaHQgbmVpZ2hib3JpbmcgZGlyZWN0aW9uIHNob3VsZCBiZSBvbiAxIGF4aXMgb25seS4iKTsKICAgICAgfQogICAgICBjb25zdCBbcHgsIHB5LCBweiwgbngsIG55LCBuel0gPSB0YXJnZXQ7CiAgICAgIC8vIEdvaW5nIGludG8gdGhlIE5YIG9mIHRoZSB0YXJnZXQuCiAgICAgIGlmIChkeCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIG54OwogICAgICB9CiAgICAgIC8vIEdvaW5nIGludG8gdGhlIFBYIG9mIHRoZSB0YXJnZXQuCiAgICAgIGlmIChkeCA9PT0gLTEpIHsKICAgICAgICAgIHJldHVybiBweDsKICAgICAgfQogICAgICAvLyBHb2luZyBpbnRvIHRoZSBOWSBvZiB0aGUgdGFyZ2V0LgogICAgICBpZiAoZHkgPT09IDEpIHsKICAgICAgICAgIHJldHVybiBueTsKICAgICAgfQogICAgICAvLyBHb2luZyBpbnRvIHRoZSBQWSBvZiB0aGUgdGFyZ2V0LgogICAgICBpZiAoZHkgPT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gcHk7CiAgICAgIH0KICAgICAgLy8gR29pbmcgaW50byB0aGUgTlogb2YgdGhlIHRhcmdldC4KICAgICAgaWYgKGR6ID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gbno7CiAgICAgIH0KICAgICAgLy8gR29pbmcgaW50byB0aGUgUFogb2YgdGhlIHRhcmdldC4KICAgICAgcmV0dXJuIHB6OwogIH0pOwogIC8qKgogICAgICogQ2hlY2sgdG8gc2VlIGlmIGxpZ2h0IGNhbiBlbnRlciBmcm9tIG9uZSBibG9jayB0byBhbm90aGVyLgogICAgICoKICAgICAqIEBwYXJhbSBzb3VyY2UgVGhlIHNvdXJjZSBibG9jaydzIHRyYW5zcGFyZW5jeS4KICAgICAqIEBwYXJhbSB0YXJnZXQgVGhlIHRhcmdldCBibG9jaydzIHRyYW5zcGFyZW5jeS4KICAgICAqIEBwYXJhbSBkeCBUaGUgY2hhbmdlIGluIHggZGlyZWN0aW9uLgogICAgICogQHBhcmFtIGR5IFRoZSBjaGFuZ2UgaW4geSBkaXJlY3Rpb24uCiAgICAgKiBAcGFyYW0gZHogVGhlIGNoYW5nZSBpbiB6IGRpcmVjdGlvbi4KICAgICAqIEByZXR1cm5zIFdoZXRoZXIgbGlnaHQgY2FuIGVudGVyIGZyb20gdGhlIHNvdXJjZSBibG9jayB0byB0aGUgdGFyZ2V0IGJsb2NrLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQ0KExpZ2h0VXRpbHMsICJjYW5FbnRlciIsIChzb3VyY2UsIHRhcmdldCwgZHgsIGR5LCBkeik9PnsKICAgICAgaWYgKE1hdGguYWJzKGR4ICsgZHkgKyBkeikgIT09IDEpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBpc24ndCBzdXBwb3NlZCB0byBoYXBwZW4uIExpZ2h0IG5laWdoYm9yaW5nIGRpcmVjdGlvbiBzaG91bGQgYmUgb24gMSBheGlzIG9ubHkuIik7CiAgICAgIH0KICAgICAgY29uc3QgW3NweCwgc3B5LCBzcHosIHNueCwgc255LCBzbnpdID0gc291cmNlOwogICAgICBjb25zdCBbdHB4LCB0cHksIHRweiwgdG54LCB0bnksIHRuel0gPSB0YXJnZXQ7CiAgICAgIC8vIEdvaW5nIGZyb20gUFggb2Ygc291cmNlIHRvIE5YIG9mIHRhcmdldAogICAgICBpZiAoZHggPT09IDEpIHsKICAgICAgICAgIHJldHVybiBzcHggJiYgdG54OwogICAgICB9CiAgICAgIC8vIEdvaW5nIGZyb20gTlggb2Ygc291cmNlIHRvIFBYIG9mIHRhcmdldAogICAgICBpZiAoZHggPT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gc254ICYmIHRweDsKICAgICAgfQogICAgICAvLyBHb2luZyBmcm9tIFBZIG9mIHNvdXJjZSB0byBOWSBvZiB0YXJnZXQKICAgICAgaWYgKGR5ID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gc3B5ICYmIHRueTsKICAgICAgfQogICAgICAvLyBHb2luZyBmcm9tIE5ZIG9mIHNvdXJjZSB0byBQWSBvZiB0YXJnZXQKICAgICAgaWYgKGR5ID09PSAtMSkgewogICAgICAgICAgcmV0dXJuIHNueSAmJiB0cHk7CiAgICAgIH0KICAgICAgLy8gR29pbmcgZnJvbSBQWiBvZiBzb3VyY2UgdG8gTlogb2YgdGFyZ2V0CiAgICAgIGlmIChkeiA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIHNweiAmJiB0bno7CiAgICAgIH0KICAgICAgLy8gR29pbmcgZnJvbSBOWiBvZiBzb3VyY2UgdG8gUFogb2YgdGFyZ2V0CiAgICAgIHJldHVybiBzbnogJiYgdHB6OwogIH0pOwoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkkMyhvYmosIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSBpbiBvYmopIHsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvYmpba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBvYmo7CiAgfQogIC8qKgogICAqIFRoZSBudW1lcmljYWwgcmVwcmVzZW50YXRpb24gb2YgdGhlIHBvc2l0aXZlIFkgcm90YXRpb24uCiAgICovIGNvbnN0IFBZX1JPVEFUSU9OID0gMDsKICAvKioKICAgKiBUaGUgbnVtZXJpY2FsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBuZWdhdGl2ZSBZIHJvdGF0aW9uLgogICAqLyBjb25zdCBOWV9ST1RBVElPTiA9IDE7CiAgLyoqCiAgICogVGhlIG51bWVyaWNhbCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcG9zaXRpdmUgWCByb3RhdGlvbi4KICAgKi8gY29uc3QgUFhfUk9UQVRJT04gPSAyOwogIC8qKgogICAqIFRoZSBudW1lcmljYWwgcmVwcmVzZW50YXRpb24gb2YgdGhlIG5lZ2F0aXZlIFggcm90YXRpb24uCiAgICovIGNvbnN0IE5YX1JPVEFUSU9OID0gMzsKICAvKioKICAgKiBUaGUgbnVtZXJpY2FsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBwb3NpdGl2ZSBaIHJvdGF0aW9uLgogICAqLyBjb25zdCBQWl9ST1RBVElPTiA9IDQ7CiAgLyoqCiAgICogVGhlIG51bWVyaWNhbCByZXByZXNlbnRhdGlvbiBvZiB0aGUgbmVnYXRpdmUgWiByb3RhdGlvbi4KICAgKi8gY29uc3QgTlpfUk9UQVRJT04gPSA1OwogIC8qKgogICAqIFRoZSBhbW91bnQgb2YgWS1yb3RhdGlvbiBzZWdtZW50cyBzaG91bGQgYmUgYWxsb3dlZCBmb3IgeS1yb3RhdGFibGUgYmxvY2tzLiBJbiBvdGhlciB3b3JkcywKICAgKiB0aGUgYW1vdW50IG9mIHRpbWVzIHRoZSBibG9jayBjYW4gYmUgcm90YXRlZCBhcm91bmQgdGhlIHktYXhpcyB3aXRoaW4gMzYwIGRlZ3JlZXMuCiAgICoKICAgKiBUaGUgYWNjZXB0ZWQgWS1yb3RhdGlvbiB2YWx1ZXMgd2lsbCBiZSBmcm9tIGAwYCB0byBgWV9ST1RBVElPTl9TRUdNRU5UUyAtIDFgLgogICAqLyBjb25zdCBZX1JPVF9TRUdNRU5UUyA9IDE2OwogIGNvbnN0IFBJID0gTWF0aC5QSTsKICBjb25zdCBQSV8yID0gTWF0aC5QSSAvIDIuMDsKICAvKioKICAgKiBBIGJsb2NrIHJvdGF0aW9uIGNvbnNpc3RzIG9mIHR3byByb3RhdGlvbnM6IG9uZSBpcyB0aGUgYXhpcyB0aGlzIGJsb2NrIGlzIHBvaW50aW5nIHRvd2FyZHMsCiAgICogYW5kIHRoZSBvdGhlciBpcyB0aGUgcm90YXRpb24gYXJvdW5kIHRoYXQgYXhpcyAoeS1yb3RhdGlvbikuIFktcm90YXRpb24gaXMgb25seSBhcHBsaWNhYmxlCiAgICogdG8gdGhlIHBvc2l0aXZlIGFuZCBuZWdhdGl2ZSB4LWF4aXMuCiAgICovIGNsYXNzIEJsb2NrUm90YXRpb24gewogICAgICByb3RhdGVUcmFuc3BhcmVuY3koW3B4LCBweSwgcHosIG54LCBueSwgbnpdKSB7CiAgICAgICAgICBjb25zdCByb3QgPSB0aGlzLnZhbHVlOwogICAgICAgICAgaWYgKE1hdGguYWJzKHJvdCkgPCBOdW1iZXIuRVBTSUxPTikgewogICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgIHB4LAogICAgICAgICAgICAgICAgICBweSwKICAgICAgICAgICAgICAgICAgcHosCiAgICAgICAgICAgICAgICAgIG54LAogICAgICAgICAgICAgICAgICBueSwKICAgICAgICAgICAgICAgICAgbnoKICAgICAgICAgICAgICBdOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcG9zaXRpdmUgPSBbCiAgICAgICAgICAgICAgMS4wLAogICAgICAgICAgICAgIDIuMCwKICAgICAgICAgICAgICAzLjAKICAgICAgICAgIF07CiAgICAgICAgICBjb25zdCBuZWdhdGl2ZSA9IFsKICAgICAgICAgICAgICA0LjAsCiAgICAgICAgICAgICAgNS4wLAogICAgICAgICAgICAgIDYuMAogICAgICAgICAgXTsKICAgICAgICAgIHRoaXMucm90YXRlTm9kZShwb3NpdGl2ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgdGhpcy5yb3RhdGVOb2RlKG5lZ2F0aXZlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpdmUubWFwKChuKT0+ewogICAgICAgICAgICAgIGlmIChuID09PSAxLjApIHJldHVybiBweDsKICAgICAgICAgICAgICBpZiAobiA9PT0gMi4wKSByZXR1cm4gcHk7CiAgICAgICAgICAgICAgaWYgKG4gPT09IDMuMCkgcmV0dXJuIHB6OwogICAgICAgICAgICAgIGlmIChuID09PSA0LjApIHJldHVybiBueDsKICAgICAgICAgICAgICBpZiAobiA9PT0gNS4wKSByZXR1cm4gbnk7CiAgICAgICAgICAgICAgcmV0dXJuIG56OwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBuID0gbmVnYXRpdmUubWFwKChuKT0+ewogICAgICAgICAgICAgIGlmIChuID09PSAxLjApIHJldHVybiBweDsKICAgICAgICAgICAgICBpZiAobiA9PT0gMi4wKSByZXR1cm4gcHk7CiAgICAgICAgICAgICAgaWYgKG4gPT09IDMuMCkgcmV0dXJuIHB6OwogICAgICAgICAgICAgIGlmIChuID09PSA0LjApIHJldHVybiBueDsKICAgICAgICAgICAgICBpZiAobiA9PT0gNS4wKSByZXR1cm4gbnk7CiAgICAgICAgICAgICAgcmV0dXJuIG56OwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgIHBbMF0sCiAgICAgICAgICAgICAgcFsxXSwKICAgICAgICAgICAgICBwWzJdLAogICAgICAgICAgICAgIG5bMF0sCiAgICAgICAgICAgICAgblsxXSwKICAgICAgICAgICAgICBuWzJdCiAgICAgICAgICBdOwogICAgICB9CiAgICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGJsb2NrIHJvdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgYXhpcyB0aGlzIGJsb2NrIGlzIHBvaW50aW5nIHRvd2FyZHMuCiAgICAgKiBAcGFyYW0geVJvdGF0aW9uIFRoZSByb3RhdGlvbiBhcm91bmQgdGhlIGF4aXMgdGhpcyBibG9jayBpcyBwb2ludGluZyB0b3dhcmRzLCByb3VuZGVkIHRvIHRoZSBuZWFyZXN0ICgzNjAgLyAxNikgZGVncmVlcy4KICAgICAqLyBjb25zdHJ1Y3Rvcih2YWx1ZSA9IFBZX1JPVEFUSU9OLCB5Um90YXRpb24gPSAwKXsKICAgICAgICAgIC8qKgogICAgICogVGhlIGF4aXMgdGhpcyBibG9jayBpcyBwb2ludGluZyB0b3dhcmRzLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQzKHRoaXMsICJ2YWx1ZSIsIHZvaWQgMCk7CiAgICAgICAgICAvKioKICAgICAqIFRoZSByb3RhdGlvbiBhcm91bmQgdGhlIGF4aXMgdGhpcyBibG9jayBpcyBwb2ludGluZyB0b3dhcmRzLCByb3VuZGVkIHRvIHRoZSBuZWFyZXN0CiAgICAgKiAoMzYwIC8gMTYpIGRlZ3JlZXMuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDModGhpcywgInlSb3RhdGlvbiIsIHZvaWQgMCk7CiAgICAgICAgICAvKioKICAgICAqIFJvdGF0ZSBhIDNEIGNvb3JkaW5hdGUgYnkgdGhpcyBibG9jayByb3RhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gbm9kZSBBIDNEIGNvb3JkaW5hdGUgaW4gdGhlIGZvcm0gb2YgW3gsIHksIHpdIHRvIGJlIHJvdGF0ZWQgYnkgdGhpcyBibG9jayByb3RhdGlvbi4KICAgICAqIEBwYXJhbSB5Um90YXRlIFdoZXRoZXIgb3Igbm90IHNob3VsZCB0aGUgeS1yb3RhdGlvbiBiZSBhcHBsaWVkLgogICAgICogQHBhcmFtIHRyYW5zbGF0ZSBXaGV0aGVyIG9yIG5vdCBzaG91bGQgdGhlIHRyYW5zbGF0aW9uIGJlIGFwcGxpZWQuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDModGhpcywgInJvdGF0ZU5vZGUiLCAobm9kZSwgeVJvdGF0ZSA9IHRydWUsIHRyYW5zbGF0ZSA9IHRydWUpPT57CiAgICAgICAgICAgICAgaWYgKHlSb3RhdGUgJiYgdGhpcy55Um90YXRpb24gIT09IDApIHsKICAgICAgICAgICAgICAgICAgbm9kZVswXSAtPSAwLjU7CiAgICAgICAgICAgICAgICAgIG5vZGVbMl0gLT0gMC41OwogICAgICAgICAgICAgICAgICBCbG9ja1JvdGF0aW9uLnJvdGF0ZVkobm9kZSwgdGhpcy55Um90YXRpb24pOwogICAgICAgICAgICAgICAgICBub2RlWzBdICs9IDAuNTsKICAgICAgICAgICAgICAgICAgbm9kZVsyXSArPSAwLjU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN3aXRjaCh0aGlzLnZhbHVlKXsKICAgICAgICAgICAgICAgICAgY2FzZSBQWF9ST1RBVElPTjoKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBCbG9ja1JvdGF0aW9uLnJvdGF0ZVoobm9kZSwgLVBJXzIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUpIG5vZGVbMV0gKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBOWF9ST1RBVElPTjoKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBCbG9ja1JvdGF0aW9uLnJvdGF0ZVoobm9kZSwgUElfMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSkgbm9kZVswXSArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIFBZX1JPVEFUSU9OOgogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIE5ZX1JPVEFUSU9OOgogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIEJsb2NrUm90YXRpb24ucm90YXRlWChub2RlLCBQSSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlWzFdICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbMl0gKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgUFpfUk9UQVRJT046CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgQmxvY2tSb3RhdGlvbi5yb3RhdGVYKG5vZGUsIFBJXzIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUpIG5vZGVbMV0gKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBOWl9ST1RBVElPTjoKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBCbG9ja1JvdGF0aW9uLnJvdGF0ZVgobm9kZSwgLVBJXzIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUpIG5vZGVbMl0gKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIC8qKgogICAgICogUm90YXRlIGFuIGF4aXMgYWxpZ25lZCBib3VuZGluZyBib3ggYnkgdGhpcyBibG9jayByb3RhdGlvbiwgcmVjYWxjdWxhdGluZyB0aGUgbmV3CiAgICAgKiBtYXhpbXVtIGFuZCBtaW5pbXVtIGNvb3JkaW5hdGVzIHRvIHRoaXMgQUFCQi4KICAgICAqCiAgICAgKiBAcGFyYW0gYWFiYiBUaGUgYXhpcyBhbGlnbmVkIGJvdW5kaW5nIGJveCB0byBiZSByb3RhdGVkLgogICAgICogQHBhcmFtIHlSb3RhdGUgV2hldGhlciBvciBub3Qgc2hvdWxkIHRoZSB5LXJvdGF0aW9uIGJlIGFwcGxpZWQuCiAgICAgKiBAcGFyYW0gdHJhbnNsYXRlIFdoZXRoZXIgb3Igbm90IHNob3VsZCB0aGUgdHJhbnNsYXRpb24gYmUgYXBwbGllZC4KICAgICAqIEByZXR1cm5zIEEgbmV3IGF4aXMgYWxpZ25lZCBib3VuZGluZyBib3guCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDModGhpcywgInJvdGF0ZUFBQkIiLCAoYWFiYiwgeVJvdGF0ZSA9IHRydWUsIHRyYW5zbGF0ZSA9IHRydWUpPT57CiAgICAgICAgICAgICAgY29uc3QgbWluID0gWwogICAgICAgICAgICAgICAgICBhYWJiLm1pblgsCiAgICAgICAgICAgICAgICAgIGFhYmIubWluWSwKICAgICAgICAgICAgICAgICAgYWFiYi5taW5aCiAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICBjb25zdCBtYXggPSBbCiAgICAgICAgICAgICAgICAgIGFhYmIubWF4WCwKICAgICAgICAgICAgICAgICAgYWFiYi5tYXhZLAogICAgICAgICAgICAgICAgICBhYWJiLm1heFoKICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgIGxldCBtaW5YID0gbnVsbDsKICAgICAgICAgICAgICBsZXQgbWluWiA9IG51bGw7CiAgICAgICAgICAgICAgbGV0IG1heFggPSBudWxsOwogICAgICAgICAgICAgIGxldCBtYXhaID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoeVJvdGF0ZSAmJiB0aGlzLnlSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgICAgICAgICBjb25zdCBtaW4xID0gWwogICAgICAgICAgICAgICAgICAgICAgYWFiYi5taW5YLAogICAgICAgICAgICAgICAgICAgICAgYWFiYi5taW5ZLAogICAgICAgICAgICAgICAgICAgICAgYWFiYi5taW5aCiAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgIGNvbnN0IG1pbjIgPSBbCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1pblgsCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1pblksCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1heFoKICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgY29uc3QgbWluMyA9IFsKICAgICAgICAgICAgICAgICAgICAgIGFhYmIubWF4WCwKICAgICAgICAgICAgICAgICAgICAgIGFhYmIubWluWSwKICAgICAgICAgICAgICAgICAgICAgIGFhYmIubWluWgogICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICBjb25zdCBtaW40ID0gWwogICAgICAgICAgICAgICAgICAgICAgYWFiYi5tYXhYLAogICAgICAgICAgICAgICAgICAgICAgYWFiYi5taW5ZLAogICAgICAgICAgICAgICAgICAgICAgYWFiYi5tYXhaCiAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgIG1pbjEsCiAgICAgICAgICAgICAgICAgICAgICBtaW4yLAogICAgICAgICAgICAgICAgICAgICAgbWluMywKICAgICAgICAgICAgICAgICAgICAgIG1pbjQKICAgICAgICAgICAgICAgICAgXS5mb3JFYWNoKChtaW4pPT57CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWluLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgIG1pblggPSBtaW5YID09PSBudWxsID8gbWluWzBdIDogTWF0aC5taW4obWluWCwgbWluWzBdKTsKICAgICAgICAgICAgICAgICAgICAgIG1pblogPSBtaW5aID09PSBudWxsID8gbWluWzJdIDogTWF0aC5taW4obWluWiwgbWluWzJdKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG1heDEgPSBbCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1pblgsCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1heFksCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1pbloKICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgY29uc3QgbWF4MiA9IFsKICAgICAgICAgICAgICAgICAgICAgIGFhYmIubWluWCwKICAgICAgICAgICAgICAgICAgICAgIGFhYmIubWF4WSwKICAgICAgICAgICAgICAgICAgICAgIGFhYmIubWF4WgogICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICBjb25zdCBtYXgzID0gWwogICAgICAgICAgICAgICAgICAgICAgYWFiYi5tYXhYLAogICAgICAgICAgICAgICAgICAgICAgYWFiYi5tYXhZLAogICAgICAgICAgICAgICAgICAgICAgYWFiYi5taW5aCiAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgIGNvbnN0IG1heDQgPSBbCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1heFgsCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1heFksCiAgICAgICAgICAgICAgICAgICAgICBhYWJiLm1heFoKICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgbWF4MSwKICAgICAgICAgICAgICAgICAgICAgIG1heDIsCiAgICAgICAgICAgICAgICAgICAgICBtYXgzLAogICAgICAgICAgICAgICAgICAgICAgbWF4NAogICAgICAgICAgICAgICAgICBdLmZvckVhY2goKG1heCk9PnsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm90YXRlTm9kZShtYXgsIHRydWUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgbWF4WCA9IG1heFggPT09IG51bGwgPyBtYXhbMF0gOiBNYXRoLm1heChtYXhYLCBtYXhbMF0pOwogICAgICAgICAgICAgICAgICAgICAgbWF4WiA9IG1heFogPT09IG51bGwgPyBtYXhbMl0gOiBNYXRoLm1heChtYXhaLCBtYXhbMl0pOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5yb3RhdGVOb2RlKG1pbiwgeVJvdGF0ZSwgdHJhbnNsYXRlKTsKICAgICAgICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWF4LCB5Um90YXRlLCB0cmFuc2xhdGUpOwogICAgICAgICAgICAgIGNvbnN0IEVQU0lMT04gPSAwLjAwMDE7CiAgICAgICAgICAgICAgY29uc3QganVzdGlmeSA9IChudW0pPT5udW0gPCBFUFNJTE9OID8gMCA6IG51bTsKICAgICAgICAgICAgICBtaW5bMF0gPSBqdXN0aWZ5KG1pblswXSk7CiAgICAgICAgICAgICAgbWluWzFdID0ganVzdGlmeShtaW5bMV0pOwogICAgICAgICAgICAgIG1pblsyXSA9IGp1c3RpZnkobWluWzJdKTsKICAgICAgICAgICAgICBtYXhbMF0gPSBqdXN0aWZ5KG1heFswXSk7CiAgICAgICAgICAgICAgbWF4WzFdID0ganVzdGlmeShtYXhbMV0pOwogICAgICAgICAgICAgIG1heFsyXSA9IGp1c3RpZnkobWF4WzJdKTsKICAgICAgICAgICAgICBjb25zdCByZWFsTWluID0gWwogICAgICAgICAgICAgICAgICBtaW5YICE9PSBudWxsID8ganVzdGlmeShtaW5YKSA6IE1hdGgubWluKG1pblswXSwgbWF4WzBdKSwKICAgICAgICAgICAgICAgICAgTWF0aC5taW4obWluWzFdLCBtYXhbMV0pLAogICAgICAgICAgICAgICAgICBtaW5aICE9PSBudWxsID8ganVzdGlmeShtaW5aKSA6IE1hdGgubWluKG1pblsyXSwgbWF4WzJdKQogICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgY29uc3QgcmVhbE1heCA9IFsKICAgICAgICAgICAgICAgICAgbWF4WCAhPT0gbnVsbCA/IGp1c3RpZnkobWF4WCkgOiBNYXRoLm1heChtaW5bMF0sIG1heFswXSksCiAgICAgICAgICAgICAgICAgIE1hdGgubWF4KG1pblsxXSwgbWF4WzFdKSwKICAgICAgICAgICAgICAgICAgbWF4WiAhPT0gbnVsbCA/IGp1c3RpZnkobWF4WikgOiBNYXRoLm1heChtaW5bMl0sIG1heFsyXSkKICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgIHJldHVybiBuZXcgQUFCQihyZWFsTWluWzBdLCByZWFsTWluWzFdLCByZWFsTWluWzJdLCByZWFsTWF4WzBdLCByZWFsTWF4WzFdLCByZWFsTWF4WzJdKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgdGhpcy55Um90YXRpb24gPSB5Um90YXRpb247CiAgICAgIH0KICB9CiAgLyoqCiAgICAgKiBFbmNvZGUgdHdvIHJvdGF0aW9ucyBpbnRvIGEgbmV3IGJsb2NrIHJvdGF0aW9uIGluc3RhbmNlLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgYXhpcyB0aGlzIGJsb2NrIGlzIHBvaW50aW5nIHRvd2FyZHMuCiAgICAgKiBAcGFyYW0geVJvdGF0aW9uIFRoZSByb3RhdGlvbiBhcm91bmQgdGhlIGF4aXMgdGhpcyBibG9jayBpcyBwb2ludGluZyB0b3dhcmRzLgogICAgICogQHJldHVybnMgQSBuZXcgYmxvY2sgcm90YXRpb24uCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDMoQmxvY2tSb3RhdGlvbiwgImVuY29kZSIsICh2YWx1ZSwgeVJvdGF0aW9uID0gMCk9PnsKICAgICAgY29uc3QgeUVuY29kZWQgPSB5Um90YXRpb24gKiBNYXRoLlBJICogMi4wIC8gWV9ST1RfU0VHTUVOVFM7CiAgICAgIHJldHVybiBuZXcgQmxvY2tSb3RhdGlvbih2YWx1ZSwgeUVuY29kZWQpOwogIH0pOwogIC8qKgogICAgICogRGVjb2RlIGEgYmxvY2sgcm90YXRpb24gaW50byB0d28gcm90YXRpb25zLgogICAgICoKICAgICAqIEBwYXJhbSByb3RhdGlvbiBUaGUgYmxvY2sgcm90YXRpb24gdG8gZGVjb2RlLgogICAgICogQHJldHVybnMgVHdvIHZhbHVlcywgdGhlIGZpcnN0IGlzIHRoZSBheGlzIHRoaXMgYmxvY2sgaXMgcG9pbnRpbmcgdG93YXJkcywgYW5kCiAgICAgKiAgIHRoZSBzZWNvbmQgaXMgdGhlIHJvdGF0aW9uIGFyb3VuZCB0aGF0IGF4aXMuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDMoQmxvY2tSb3RhdGlvbiwgImRlY29kZSIsIChyb3RhdGlvbik9PnsKICAgICAgY29uc3QgdmFsdWUgPSByb3RhdGlvbi52YWx1ZTsKICAgICAgY29uc3QgeURlY29kZWQgPSBNYXRoLnJvdW5kKHJvdGF0aW9uLnlSb3RhdGlvbiAqIFlfUk9UX1NFR01FTlRTIC8gKE1hdGguUEkgKiAyLjApKSAlIFlfUk9UX1NFR01FTlRTOwogICAgICByZXR1cm4gWwogICAgICAgICAgdmFsdWUsCiAgICAgICAgICB5RGVjb2RlZAogICAgICBdOwogIH0pOwogIC8vIFJlZmVyZW5jZToKICAvLyBodHRwczovL3d3dy5raGFuYWNhZGVteS5vcmcvY29tcHV0ZXItcHJvZ3JhbW1pbmcvY3ViZS1yb3RhdGVkLWFyb3VuZC14LXktYW5kLXovNDkzMDY3OTY2ODQ3Mzg1NgogIC8qKgogICAgICogUm90YXRlIGEgM0QgY29vcmRpbmF0ZSBhcm91bmQgdGhlIFggYXhpcy4KICAgICAqLyBfZGVmaW5lUHJvcGVydHkkMyhCbG9ja1JvdGF0aW9uLCAicm90YXRlWCIsIChub2RlLCB0aGV0YSk9PnsKICAgICAgY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbih0aGV0YSk7CiAgICAgIGNvbnN0IGNvc1RoZXRhID0gTWF0aC5jb3ModGhldGEpOwogICAgICBjb25zdCBbLCB5LCB6XSA9IG5vZGU7CiAgICAgIG5vZGVbMV0gPSB5ICogY29zVGhldGEgLSB6ICogc2luVGhldGE7CiAgICAgIG5vZGVbMl0gPSB6ICogY29zVGhldGEgKyB5ICogc2luVGhldGE7CiAgfSk7CiAgLyoqCiAgICAgKiBSb3RhdGUgYSAzRCBjb29yZGluYXRlIGFyb3VuZCB0aGUgWSBheGlzLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQzKEJsb2NrUm90YXRpb24sICJyb3RhdGVZIiwgKG5vZGUsIHRoZXRhKT0+ewogICAgICBjb25zdCBzaW5UaGV0YSA9IE1hdGguc2luKHRoZXRhKTsKICAgICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICAgIGNvbnN0IFt4LCAsIHpdID0gbm9kZTsKICAgICAgbm9kZVswXSA9IHggKiBjb3NUaGV0YSArIHogKiBzaW5UaGV0YTsKICAgICAgbm9kZVsyXSA9IHogKiBjb3NUaGV0YSAtIHggKiBzaW5UaGV0YTsKICB9KTsKICAvKioKICAgICAqIFJvdGF0ZSBhIDNEIGNvb3JkaW5hdGUgYXJvdW5kIHRoZSBaIGF4aXMuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDMoQmxvY2tSb3RhdGlvbiwgInJvdGF0ZVoiLCAobm9kZSwgdGhldGEpPT57CiAgICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgICBjb25zdCBjb3NUaGV0YSA9IE1hdGguY29zKHRoZXRhKTsKICAgICAgY29uc3QgW3gsIHldID0gbm9kZTsKICAgICAgbm9kZVswXSA9IHggKiBjb3NUaGV0YSAtIHkgKiBzaW5UaGV0YTsKICAgICAgbm9kZVsxXSA9IHkgKiBjb3NUaGV0YSArIHggKiBzaW5UaGV0YTsKICB9KTsKCiAgZnVuY3Rpb24gaW90YSQxKG4pIHsKICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkobik7CiAgICBmb3IodmFyIGk9MDsgaTxuOyArK2kpIHsKICAgICAgcmVzdWx0W2ldID0gaTsKICAgIH0KICAgIHJldHVybiByZXN1bHQKICB9CgogIHZhciBpb3RhXzEgPSBpb3RhJDE7CgogIC8qIQogICAqIERldGVybWluZSBpZiBhbiBvYmplY3QgaXMgYSBCdWZmZXIKICAgKgogICAqIEBhdXRob3IgICBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwczovL2Zlcm9zcy5vcmc+CiAgICogQGxpY2Vuc2UgIE1JVAogICAqLwoKICAvLyBUaGUgX2lzQnVmZmVyIGNoZWNrIGlzIGZvciBTYWZhcmkgNS03IHN1cHBvcnQsIGJlY2F1c2UgaXQncyBtaXNzaW5nCiAgLy8gT2JqZWN0LnByb3RvdHlwZS5jb25zdHJ1Y3Rvci4gUmVtb3ZlIHRoaXMgZXZlbnR1YWxseQogIHZhciBpc0J1ZmZlcl8xID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiAhPSBudWxsICYmIChpc0J1ZmZlciQxKG9iaikgfHwgaXNTbG93QnVmZmVyKG9iaikgfHwgISFvYmouX2lzQnVmZmVyKQogIH07CgogIGZ1bmN0aW9uIGlzQnVmZmVyJDEgKG9iaikgewogICAgcmV0dXJuICEhb2JqLmNvbnN0cnVjdG9yICYmIHR5cGVvZiBvYmouY29uc3RydWN0b3IuaXNCdWZmZXIgPT09ICdmdW5jdGlvbicgJiYgb2JqLmNvbnN0cnVjdG9yLmlzQnVmZmVyKG9iaikKICB9CgogIC8vIEZvciBOb2RlIHYwLjEwIHN1cHBvcnQuIFJlbW92ZSB0aGlzIGV2ZW50dWFsbHkuCiAgZnVuY3Rpb24gaXNTbG93QnVmZmVyIChvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqLnJlYWRGbG9hdExFID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmouc2xpY2UgPT09ICdmdW5jdGlvbicgJiYgaXNCdWZmZXIkMShvYmouc2xpY2UoMCwgMCkpCiAgfQoKICB2YXIgaW90YSA9IGlvdGFfMTsKICB2YXIgaXNCdWZmZXIgPSBpc0J1ZmZlcl8xOwoKICB2YXIgaGFzVHlwZWRBcnJheXMgID0gKCh0eXBlb2YgRmxvYXQ2NEFycmF5KSAhPT0gInVuZGVmaW5lZCIpOwoKICBmdW5jdGlvbiBjb21wYXJlMXN0KGEsIGIpIHsKICAgIHJldHVybiBhWzBdIC0gYlswXQogIH0KCiAgZnVuY3Rpb24gb3JkZXIoKSB7CiAgICB2YXIgc3RyaWRlID0gdGhpcy5zdHJpZGU7CiAgICB2YXIgdGVybXMgPSBuZXcgQXJyYXkoc3RyaWRlLmxlbmd0aCk7CiAgICB2YXIgaTsKICAgIGZvcihpPTA7IGk8dGVybXMubGVuZ3RoOyArK2kpIHsKICAgICAgdGVybXNbaV0gPSBbTWF0aC5hYnMoc3RyaWRlW2ldKSwgaV07CiAgICB9CiAgICB0ZXJtcy5zb3J0KGNvbXBhcmUxc3QpOwogICAgdmFyIHJlc3VsdCA9IG5ldyBBcnJheSh0ZXJtcy5sZW5ndGgpOwogICAgZm9yKGk9MDsgaTxyZXN1bHQubGVuZ3RoOyArK2kpIHsKICAgICAgcmVzdWx0W2ldID0gdGVybXNbaV1bMV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBmdW5jdGlvbiBjb21waWxlQ29uc3RydWN0b3IoZHR5cGUsIGRpbWVuc2lvbikgewogICAgdmFyIGNsYXNzTmFtZSA9IFsiVmlldyIsIGRpbWVuc2lvbiwgImQiLCBkdHlwZV0uam9pbigiIik7CiAgICBpZihkaW1lbnNpb24gPCAwKSB7CiAgICAgIGNsYXNzTmFtZSA9ICJWaWV3X05pbCIgKyBkdHlwZTsKICAgIH0KICAgIHZhciB1c2VHZXR0ZXJzID0gKGR0eXBlID09PSAiZ2VuZXJpYyIpOwoKICAgIGlmKGRpbWVuc2lvbiA9PT0gLTEpIHsKICAgICAgLy9TcGVjaWFsIGNhc2UgZm9yIHRyaXZpYWwgYXJyYXlzCiAgICAgIHZhciBjb2RlID0KICAgICAgICAiZnVuY3Rpb24gIitjbGFzc05hbWUrIihhKXt0aGlzLmRhdGE9YTt9O1wKdmFyIHByb3RvPSIrY2xhc3NOYW1lKyIucHJvdG90eXBlO1wKcHJvdG8uZHR5cGU9JyIrZHR5cGUrIic7XApwcm90by5pbmRleD1mdW5jdGlvbigpe3JldHVybiAtMX07XApwcm90by5zaXplPTA7XApwcm90by5kaW1lbnNpb249LTE7XApwcm90by5zaGFwZT1wcm90by5zdHJpZGU9cHJvdG8ub3JkZXI9W107XApwcm90by5sbz1wcm90by5oaT1wcm90by50cmFuc3Bvc2U9cHJvdG8uc3RlcD1cCmZ1bmN0aW9uKCl7cmV0dXJuIG5ldyAiK2NsYXNzTmFtZSsiKHRoaXMuZGF0YSk7fTtcCnByb3RvLmdldD1wcm90by5zZXQ9ZnVuY3Rpb24oKXt9O1wKcHJvdG8ucGljaz1mdW5jdGlvbigpe3JldHVybiBudWxsfTtcCnJldHVybiBmdW5jdGlvbiBjb25zdHJ1Y3RfIitjbGFzc05hbWUrIihhKXtyZXR1cm4gbmV3ICIrY2xhc3NOYW1lKyIoYSk7fSI7CiAgICAgIHZhciBwcm9jZWR1cmUgPSBuZXcgRnVuY3Rpb24oY29kZSk7CiAgICAgIHJldHVybiBwcm9jZWR1cmUoKQogICAgfSBlbHNlIGlmKGRpbWVuc2lvbiA9PT0gMCkgewogICAgICAvL1NwZWNpYWwgY2FzZSBmb3IgMGQgYXJyYXlzCiAgICAgIHZhciBjb2RlID0KICAgICAgICAiZnVuY3Rpb24gIitjbGFzc05hbWUrIihhLGQpIHtcCnRoaXMuZGF0YSA9IGE7XAp0aGlzLm9mZnNldCA9IGRcCn07XAp2YXIgcHJvdG89IitjbGFzc05hbWUrIi5wcm90b3R5cGU7XApwcm90by5kdHlwZT0nIitkdHlwZSsiJztcCnByb3RvLmluZGV4PWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMub2Zmc2V0fTtcCnByb3RvLmRpbWVuc2lvbj0wO1wKcHJvdG8uc2l6ZT0xO1wKcHJvdG8uc2hhcGU9XApwcm90by5zdHJpZGU9XApwcm90by5vcmRlcj1bXTtcCnByb3RvLmxvPVwKcHJvdG8uaGk9XApwcm90by50cmFuc3Bvc2U9XApwcm90by5zdGVwPWZ1bmN0aW9uICIrY2xhc3NOYW1lKyJfY29weSgpIHtcCnJldHVybiBuZXcgIitjbGFzc05hbWUrIih0aGlzLmRhdGEsdGhpcy5vZmZzZXQpXAp9O1wKcHJvdG8ucGljaz1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX3BpY2soKXtcCnJldHVybiBUcml2aWFsQXJyYXkodGhpcy5kYXRhKTtcCn07XApwcm90by52YWx1ZU9mPXByb3RvLmdldD1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX2dldCgpe1wKcmV0dXJuICIrKHVzZUdldHRlcnMgPyAidGhpcy5kYXRhLmdldCh0aGlzLm9mZnNldCkiIDogInRoaXMuZGF0YVt0aGlzLm9mZnNldF0iKSsKICAifTtcCnByb3RvLnNldD1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX3NldCh2KXtcCnJldHVybiAiKyh1c2VHZXR0ZXJzID8gInRoaXMuZGF0YS5zZXQodGhpcy5vZmZzZXQsdikiIDogInRoaXMuZGF0YVt0aGlzLm9mZnNldF09diIpKyJcCn07XApyZXR1cm4gZnVuY3Rpb24gY29uc3RydWN0XyIrY2xhc3NOYW1lKyIoYSxiLGMsZCl7cmV0dXJuIG5ldyAiK2NsYXNzTmFtZSsiKGEsZCl9IjsKICAgICAgdmFyIHByb2NlZHVyZSA9IG5ldyBGdW5jdGlvbigiVHJpdmlhbEFycmF5IiwgY29kZSk7CiAgICAgIHJldHVybiBwcm9jZWR1cmUoQ0FDSEVEX0NPTlNUUlVDVE9SU1tkdHlwZV1bMF0pCiAgICB9CgogICAgdmFyIGNvZGUgPSBbIid1c2Ugc3RyaWN0JyJdOwoKICAgIC8vQ3JlYXRlIGNvbnN0cnVjdG9yIGZvciB2aWV3CiAgICB2YXIgaW5kaWNlcyA9IGlvdGEoZGltZW5zaW9uKTsKICAgIHZhciBhcmdzID0gaW5kaWNlcy5tYXAoZnVuY3Rpb24oaSkgeyByZXR1cm4gImkiK2kgfSk7CiAgICB2YXIgaW5kZXhfc3RyID0gInRoaXMub2Zmc2V0KyIgKyBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7CiAgICAgICAgICByZXR1cm4gInRoaXMuc3RyaWRlWyIgKyBpICsgIl0qaSIgKyBpCiAgICAgICAgfSkuam9pbigiKyIpOwogICAgdmFyIHNoYXBlQXJnID0gaW5kaWNlcy5tYXAoZnVuY3Rpb24oaSkgewogICAgICAgIHJldHVybiAiYiIraQogICAgICB9KS5qb2luKCIsIik7CiAgICB2YXIgc3RyaWRlQXJnID0gaW5kaWNlcy5tYXAoZnVuY3Rpb24oaSkgewogICAgICAgIHJldHVybiAiYyIraQogICAgICB9KS5qb2luKCIsIik7CiAgICBjb2RlLnB1c2goCiAgICAgICJmdW5jdGlvbiAiK2NsYXNzTmFtZSsiKGEsIiArIHNoYXBlQXJnICsgIiwiICsgc3RyaWRlQXJnICsgIixkKXt0aGlzLmRhdGE9YSIsCiAgICAgICAgInRoaXMuc2hhcGU9WyIgKyBzaGFwZUFyZyArICJdIiwKICAgICAgICAidGhpcy5zdHJpZGU9WyIgKyBzdHJpZGVBcmcgKyAiXSIsCiAgICAgICAgInRoaXMub2Zmc2V0PWR8MH0iLAogICAgICAidmFyIHByb3RvPSIrY2xhc3NOYW1lKyIucHJvdG90eXBlIiwKICAgICAgInByb3RvLmR0eXBlPSciK2R0eXBlKyInIiwKICAgICAgInByb3RvLmRpbWVuc2lvbj0iK2RpbWVuc2lvbik7CgogICAgLy92aWV3LnNpemU6CiAgICBjb2RlLnB1c2goIk9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywnc2l6ZScse2dldDpmdW5jdGlvbiAiK2NsYXNzTmFtZSsiX3NpemUoKXtcCnJldHVybiAiK2luZGljZXMubWFwKGZ1bmN0aW9uKGkpIHsgcmV0dXJuICJ0aGlzLnNoYXBlWyIraSsiXSIgfSkuam9pbigiKiIpLAogICJ9fSkiKTsKCiAgICAvL3ZpZXcub3JkZXI6CiAgICBpZihkaW1lbnNpb24gPT09IDEpIHsKICAgICAgY29kZS5wdXNoKCJwcm90by5vcmRlcj1bMF0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUucHVzaCgiT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCdvcmRlcicse2dldDoiKTsKICAgICAgaWYoZGltZW5zaW9uIDwgNCkgewogICAgICAgIGNvZGUucHVzaCgiZnVuY3Rpb24gIitjbGFzc05hbWUrIl9vcmRlcigpeyIpOwogICAgICAgIGlmKGRpbWVuc2lvbiA9PT0gMikgewogICAgICAgICAgY29kZS5wdXNoKCJyZXR1cm4gKE1hdGguYWJzKHRoaXMuc3RyaWRlWzBdKT5NYXRoLmFicyh0aGlzLnN0cmlkZVsxXSkpP1sxLDBdOlswLDFdfX0pIik7CiAgICAgICAgfSBlbHNlIGlmKGRpbWVuc2lvbiA9PT0gMykgewogICAgICAgICAgY29kZS5wdXNoKAogICJ2YXIgczA9TWF0aC5hYnModGhpcy5zdHJpZGVbMF0pLHMxPU1hdGguYWJzKHRoaXMuc3RyaWRlWzFdKSxzMj1NYXRoLmFicyh0aGlzLnN0cmlkZVsyXSk7XAppZihzMD5zMSl7XAppZihzMT5zMil7XApyZXR1cm4gWzIsMSwwXTtcCn1lbHNlIGlmKHMwPnMyKXtcCnJldHVybiBbMSwyLDBdO1wKfWVsc2V7XApyZXR1cm4gWzEsMCwyXTtcCn1cCn1lbHNlIGlmKHMwPnMyKXtcCnJldHVybiBbMiwwLDFdO1wKfWVsc2UgaWYoczI+czEpe1wKcmV0dXJuIFswLDEsMl07XAp9ZWxzZXtcCnJldHVybiBbMCwyLDFdO1wKfX19KSIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb2RlLnB1c2goIk9SREVSfSkiKTsKICAgICAgfQogICAgfQoKICAgIC8vdmlldy5zZXQoaTAsIC4uLiwgdik6CiAgICBjb2RlLnB1c2goCiAgInByb3RvLnNldD1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX3NldCgiK2FyZ3Muam9pbigiLCIpKyIsdil7Iik7CiAgICBpZih1c2VHZXR0ZXJzKSB7CiAgICAgIGNvZGUucHVzaCgicmV0dXJuIHRoaXMuZGF0YS5zZXQoIitpbmRleF9zdHIrIix2KX0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUucHVzaCgicmV0dXJuIHRoaXMuZGF0YVsiK2luZGV4X3N0cisiXT12fSIpOwogICAgfQoKICAgIC8vdmlldy5nZXQoaTAsIC4uLik6CiAgICBjb2RlLnB1c2goInByb3RvLmdldD1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX2dldCgiK2FyZ3Muam9pbigiLCIpKyIpeyIpOwogICAgaWYodXNlR2V0dGVycykgewogICAgICBjb2RlLnB1c2goInJldHVybiB0aGlzLmRhdGEuZ2V0KCIraW5kZXhfc3RyKyIpfSIpOwogICAgfSBlbHNlIHsKICAgICAgY29kZS5wdXNoKCJyZXR1cm4gdGhpcy5kYXRhWyIraW5kZXhfc3RyKyJdfSIpOwogICAgfQoKICAgIC8vdmlldy5pbmRleDoKICAgIGNvZGUucHVzaCgKICAgICAgInByb3RvLmluZGV4PWZ1bmN0aW9uICIrY2xhc3NOYW1lKyJfaW5kZXgoIiwgYXJncy5qb2luKCksICIpe3JldHVybiAiK2luZGV4X3N0cisifSIpOwoKICAgIC8vdmlldy5oaSgpOgogICAgY29kZS5wdXNoKCJwcm90by5oaT1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX2hpKCIrYXJncy5qb2luKCIsIikrIil7cmV0dXJuIG5ldyAiK2NsYXNzTmFtZSsiKHRoaXMuZGF0YSwiKwogICAgICBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuIFsiKHR5cGVvZiBpIixpLCIhPT0nbnVtYmVyJ3x8aSIsaSwiPDApP3RoaXMuc2hhcGVbIiwgaSwgIl06aSIsIGksInwwIl0uam9pbigiIikKICAgICAgfSkuam9pbigiLCIpKyIsIisKICAgICAgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaSkgewogICAgICAgIHJldHVybiAidGhpcy5zdHJpZGVbIitpICsgIl0iCiAgICAgIH0pLmpvaW4oIiwiKSsiLHRoaXMub2Zmc2V0KX0iKTsKCiAgICAvL3ZpZXcubG8oKToKICAgIHZhciBhX3ZhcnMgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7IHJldHVybiAiYSIraSsiPXRoaXMuc2hhcGVbIitpKyJdIiB9KTsKICAgIHZhciBjX3ZhcnMgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7IHJldHVybiAiYyIraSsiPXRoaXMuc3RyaWRlWyIraSsiXSIgfSk7CiAgICBjb2RlLnB1c2goInByb3RvLmxvPWZ1bmN0aW9uICIrY2xhc3NOYW1lKyJfbG8oIithcmdzLmpvaW4oIiwiKSsiKXt2YXIgYj10aGlzLm9mZnNldCxkPTAsIithX3ZhcnMuam9pbigiLCIpKyIsIitjX3ZhcnMuam9pbigiLCIpKTsKICAgIGZvcih2YXIgaT0wOyBpPGRpbWVuc2lvbjsgKytpKSB7CiAgICAgIGNvZGUucHVzaCgKICAiaWYodHlwZW9mIGkiK2krIj09PSdudW1iZXInJiZpIitpKyI+PTApe1wKZD1pIitpKyJ8MDtcCmIrPWMiK2krIipkO1wKYSIraSsiLT1kfSIpOwogICAgfQogICAgY29kZS5wdXNoKCJyZXR1cm4gbmV3ICIrY2xhc3NOYW1lKyIodGhpcy5kYXRhLCIrCiAgICAgIGluZGljZXMubWFwKGZ1bmN0aW9uKGkpIHsKICAgICAgICByZXR1cm4gImEiK2kKICAgICAgfSkuam9pbigiLCIpKyIsIisKICAgICAgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaSkgewogICAgICAgIHJldHVybiAiYyIraQogICAgICB9KS5qb2luKCIsIikrIixiKX0iKTsKCiAgICAvL3ZpZXcuc3RlcCgpOgogICAgY29kZS5wdXNoKCJwcm90by5zdGVwPWZ1bmN0aW9uICIrY2xhc3NOYW1lKyJfc3RlcCgiK2FyZ3Muam9pbigiLCIpKyIpe3ZhciAiKwogICAgICBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuICJhIitpKyI9dGhpcy5zaGFwZVsiK2krIl0iCiAgICAgIH0pLmpvaW4oIiwiKSsiLCIrCiAgICAgIGluZGljZXMubWFwKGZ1bmN0aW9uKGkpIHsKICAgICAgICByZXR1cm4gImIiK2krIj10aGlzLnN0cmlkZVsiK2krIl0iCiAgICAgIH0pLmpvaW4oIiwiKSsiLGM9dGhpcy5vZmZzZXQsZD0wLGNlaWw9TWF0aC5jZWlsIik7CiAgICBmb3IodmFyIGk9MDsgaTxkaW1lbnNpb247ICsraSkgewogICAgICBjb2RlLnB1c2goCiAgImlmKHR5cGVvZiBpIitpKyI9PT0nbnVtYmVyJyl7XApkPWkiK2krInwwO1wKaWYoZDwwKXtcCmMrPWIiK2krIiooYSIraSsiLTEpO1wKYSIraSsiPWNlaWwoLWEiK2krIi9kKVwKfWVsc2V7XAphIitpKyI9Y2VpbChhIitpKyIvZClcCn1cCmIiK2krIio9ZFwKfSIpOwogICAgfQogICAgY29kZS5wdXNoKCJyZXR1cm4gbmV3ICIrY2xhc3NOYW1lKyIodGhpcy5kYXRhLCIrCiAgICAgIGluZGljZXMubWFwKGZ1bmN0aW9uKGkpIHsKICAgICAgICByZXR1cm4gImEiICsgaQogICAgICB9KS5qb2luKCIsIikrIiwiKwogICAgICBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuICJiIiArIGkKICAgICAgfSkuam9pbigiLCIpKyIsYyl9Iik7CgogICAgLy92aWV3LnRyYW5zcG9zZSgpOgogICAgdmFyIHRTaGFwZSA9IG5ldyBBcnJheShkaW1lbnNpb24pOwogICAgdmFyIHRTdHJpZGUgPSBuZXcgQXJyYXkoZGltZW5zaW9uKTsKICAgIGZvcih2YXIgaT0wOyBpPGRpbWVuc2lvbjsgKytpKSB7CiAgICAgIHRTaGFwZVtpXSA9ICJhW2kiK2krIl0iOwogICAgICB0U3RyaWRlW2ldID0gImJbaSIraSsiXSI7CiAgICB9CiAgICBjb2RlLnB1c2goInByb3RvLnRyYW5zcG9zZT1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX3RyYW5zcG9zZSgiK2FyZ3MrIil7IisKICAgICAgYXJncy5tYXAoZnVuY3Rpb24obixpZHgpIHsgcmV0dXJuIG4gKyAiPSgiICsgbiArICI9PT11bmRlZmluZWQ/IiArIGlkeCArICI6IiArIG4gKyAifDApIn0pLmpvaW4oIjsiKSwKICAgICAgInZhciBhPXRoaXMuc2hhcGUsYj10aGlzLnN0cmlkZTtyZXR1cm4gbmV3ICIrY2xhc3NOYW1lKyIodGhpcy5kYXRhLCIrdFNoYXBlLmpvaW4oIiwiKSsiLCIrdFN0cmlkZS5qb2luKCIsIikrIix0aGlzLm9mZnNldCl9Iik7CgogICAgLy92aWV3LnBpY2soKToKICAgIGNvZGUucHVzaCgicHJvdG8ucGljaz1mdW5jdGlvbiAiK2NsYXNzTmFtZSsiX3BpY2soIithcmdzKyIpe3ZhciBhPVtdLGI9W10sYz10aGlzLm9mZnNldCIpOwogICAgZm9yKHZhciBpPTA7IGk8ZGltZW5zaW9uOyArK2kpIHsKICAgICAgY29kZS5wdXNoKCJpZih0eXBlb2YgaSIraSsiPT09J251bWJlcicmJmkiK2krIj49MCl7Yz0oYyt0aGlzLnN0cmlkZVsiK2krIl0qaSIraSsiKXwwfWVsc2V7YS5wdXNoKHRoaXMuc2hhcGVbIitpKyJdKTtiLnB1c2godGhpcy5zdHJpZGVbIitpKyJdKX0iKTsKICAgIH0KICAgIGNvZGUucHVzaCgidmFyIGN0b3I9Q1RPUl9MSVNUW2EubGVuZ3RoKzFdO3JldHVybiBjdG9yKHRoaXMuZGF0YSxhLGIsYyl9Iik7CgogICAgLy9BZGQgcmV0dXJuIHN0YXRlbWVudAogICAgY29kZS5wdXNoKCJyZXR1cm4gZnVuY3Rpb24gY29uc3RydWN0XyIrY2xhc3NOYW1lKyIoZGF0YSxzaGFwZSxzdHJpZGUsb2Zmc2V0KXtyZXR1cm4gbmV3ICIrY2xhc3NOYW1lKyIoZGF0YSwiKwogICAgICBpbmRpY2VzLm1hcChmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuICJzaGFwZVsiK2krIl0iCiAgICAgIH0pLmpvaW4oIiwiKSsiLCIrCiAgICAgIGluZGljZXMubWFwKGZ1bmN0aW9uKGkpIHsKICAgICAgICByZXR1cm4gInN0cmlkZVsiK2krIl0iCiAgICAgIH0pLmpvaW4oIiwiKSsiLG9mZnNldCl9Iik7CgogICAgLy9Db21waWxlIHByb2NlZHVyZQogICAgdmFyIHByb2NlZHVyZSA9IG5ldyBGdW5jdGlvbigiQ1RPUl9MSVNUIiwgIk9SREVSIiwgY29kZS5qb2luKCJcbiIpKTsKICAgIHJldHVybiBwcm9jZWR1cmUoQ0FDSEVEX0NPTlNUUlVDVE9SU1tkdHlwZV0sIG9yZGVyKQogIH0KCiAgZnVuY3Rpb24gYXJyYXlEVHlwZShkYXRhKSB7CiAgICBpZihpc0J1ZmZlcihkYXRhKSkgewogICAgICByZXR1cm4gImJ1ZmZlciIKICAgIH0KICAgIGlmKGhhc1R5cGVkQXJyYXlzKSB7CiAgICAgIHN3aXRjaChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZGF0YSkpIHsKICAgICAgICBjYXNlICJbb2JqZWN0IEZsb2F0NjRBcnJheV0iOgogICAgICAgICAgcmV0dXJuICJmbG9hdDY0IgogICAgICAgIGNhc2UgIltvYmplY3QgRmxvYXQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImZsb2F0MzIiCiAgICAgICAgY2FzZSAiW29iamVjdCBJbnQ4QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiaW50OCIKICAgICAgICBjYXNlICJbb2JqZWN0IEludDE2QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiaW50MTYiCiAgICAgICAgY2FzZSAiW29iamVjdCBJbnQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImludDMyIgogICAgICAgIGNhc2UgIltvYmplY3QgVWludDhBcnJheV0iOgogICAgICAgICAgcmV0dXJuICJ1aW50OCIKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQxNkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gInVpbnQxNiIKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gInVpbnQzMiIKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSI6CiAgICAgICAgICByZXR1cm4gInVpbnQ4X2NsYW1wZWQiCiAgICAgICAgY2FzZSAiW29iamVjdCBCaWdJbnQ2NEFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImJpZ2ludDY0IgogICAgICAgIGNhc2UgIltvYmplY3QgQmlnVWludDY0QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiYmlndWludDY0IgogICAgICB9CiAgICB9CiAgICBpZihBcnJheS5pc0FycmF5KGRhdGEpKSB7CiAgICAgIHJldHVybiAiYXJyYXkiCiAgICB9CiAgICByZXR1cm4gImdlbmVyaWMiCiAgfQoKICB2YXIgQ0FDSEVEX0NPTlNUUlVDVE9SUyA9IHsKICAgICJmbG9hdDMyIjpbXSwKICAgICJmbG9hdDY0IjpbXSwKICAgICJpbnQ4IjpbXSwKICAgICJpbnQxNiI6W10sCiAgICAiaW50MzIiOltdLAogICAgInVpbnQ4IjpbXSwKICAgICJ1aW50MTYiOltdLAogICAgInVpbnQzMiI6W10sCiAgICAiYXJyYXkiOltdLAogICAgInVpbnQ4X2NsYW1wZWQiOltdLAogICAgImJpZ2ludDY0IjogW10sCiAgICAiYmlndWludDY0IjogW10sCiAgICAiYnVmZmVyIjpbXSwKICAgICJnZW5lcmljIjpbXQogIH0KCiAgOwogIGZ1bmN0aW9uIHdyYXBwZWROREFycmF5Q3RvcihkYXRhLCBzaGFwZSwgc3RyaWRlLCBvZmZzZXQpIHsKICAgIGlmKGRhdGEgPT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgY3RvciA9IENBQ0hFRF9DT05TVFJVQ1RPUlMuYXJyYXlbMF07CiAgICAgIHJldHVybiBjdG9yKFtdKQogICAgfSBlbHNlIGlmKHR5cGVvZiBkYXRhID09PSAibnVtYmVyIikgewogICAgICBkYXRhID0gW2RhdGFdOwogICAgfQogICAgaWYoc2hhcGUgPT09IHVuZGVmaW5lZCkgewogICAgICBzaGFwZSA9IFsgZGF0YS5sZW5ndGggXTsKICAgIH0KICAgIHZhciBkID0gc2hhcGUubGVuZ3RoOwogICAgaWYoc3RyaWRlID09PSB1bmRlZmluZWQpIHsKICAgICAgc3RyaWRlID0gbmV3IEFycmF5KGQpOwogICAgICBmb3IodmFyIGk9ZC0xLCBzej0xOyBpPj0wOyAtLWkpIHsKICAgICAgICBzdHJpZGVbaV0gPSBzejsKICAgICAgICBzeiAqPSBzaGFwZVtpXTsKICAgICAgfQogICAgfQogICAgaWYob2Zmc2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgb2Zmc2V0ID0gMDsKICAgICAgZm9yKHZhciBpPTA7IGk8ZDsgKytpKSB7CiAgICAgICAgaWYoc3RyaWRlW2ldIDwgMCkgewogICAgICAgICAgb2Zmc2V0IC09IChzaGFwZVtpXS0xKSpzdHJpZGVbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB2YXIgZHR5cGUgPSBhcnJheURUeXBlKGRhdGEpOwogICAgdmFyIGN0b3JfbGlzdCA9IENBQ0hFRF9DT05TVFJVQ1RPUlNbZHR5cGVdOwogICAgd2hpbGUoY3Rvcl9saXN0Lmxlbmd0aCA8PSBkKzEpIHsKICAgICAgY3Rvcl9saXN0LnB1c2goY29tcGlsZUNvbnN0cnVjdG9yKGR0eXBlLCBjdG9yX2xpc3QubGVuZ3RoLTEpKTsKICAgIH0KICAgIHZhciBjdG9yID0gY3Rvcl9saXN0W2QrMV07CiAgICByZXR1cm4gY3RvcihkYXRhLCBzaGFwZSwgc3RyaWRlLCBvZmZzZXQpCiAgfQoKICB2YXIgbmRhcnJheSA9IHdyYXBwZWROREFycmF5Q3RvcjsKCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5JDIob2JqLCBrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gb2JqOwogIH0KICBjb25zdCBST1RBVElPTl9NQVNLID0gMHhmZmYwZmZmZjsKICBjb25zdCBZX1JPVEFUSU9OX01BU0sgPSAweGZmMGZmZmZmOwogIGNvbnN0IFNUQUdFX01BU0sgPSAweGYwZmZmZmZmOwogIC8qKgogICAqIEEgdXRpbGl0eSBjbGFzcyBmb3IgZXh0cmFjdGluZyBhbmQgaW5zZXJ0aW5nIHZveGVsIGRhdGEgZnJvbSBhbmQgaW50byBudW1iZXJzLgogICAqCiAgICogVGhlIHZveGVsIGRhdGEgaXMgc3RvcmVkIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogICAqIC0gVm94ZWwgdHlwZTogYDB4MDAwMGZmZmZgCiAgICogLSBSb3RhdGlvbjogYDB4MDAwZjAwMDBgCiAgICogLSBZLXJvdGF0aW9uOiBgMHgwMGYwMDAwMGAKICAgKiAtIFN0YWdlOiBgMHhmZjAwMDAwMGAKICAgKgogICAqIFRPRE8tRE9DUwogICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IHZveGVsIGRhdGEsIHNlZSBbaGVyZV0oLykKICAgKgogICAqICMgRXhhbXBsZQogICAqIGBgYHRzCiAgICogLy8gSW5zZXJ0IGEgdm94ZWwgdHlwZSAxMyBpbnRvIHplcm8uCiAgICogY29uc3QgbnVtYmVyID0gVm94ZWxVdGlscy5pbnNlcnRJRCgwLCAxMyk7CiAgICogYGBgCiAgICoKICAgKiBAY2F0ZWdvcnkgVXRpbHMKICAgKi8gY2xhc3MgQmxvY2tVdGlscyB7CiAgICAgIHN0YXRpYyBnZXRCbG9ja1JvdGF0ZWRUcmFuc3BhcmVuY3koYmxvY2ssIHJvdGF0aW9uKSB7CiAgICAgICAgICByZXR1cm4gcm90YXRpb24ucm90YXRlVHJhbnNwYXJlbmN5KGJsb2NrLmlzVHJhbnNwYXJlbnQpOwogICAgICB9CiAgICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgIC8vIE5PVEhJTkcKICAgICAgfQogIH0KICAvKioKICAgICAqIEV4dHJhY3QgdGhlIHZveGVsIGlkIGZyb20gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZveGVsIFRoZSB2b3hlbCB2YWx1ZSB0byBleHRyYWN0IGZyb20uCiAgICAgKiBAcmV0dXJucyBUaGUgZXh0cmFjdGVkIHZveGVsIGlkLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQyKEJsb2NrVXRpbHMsICJleHRyYWN0SUQiLCAodm94ZWwpPT57CiAgICAgIHJldHVybiB2b3hlbCAmIDB4ZmZmZjsKICB9KTsKICAvKioKICAgICAqIEluc2VydCBhIHZveGVsIGlkIGludG8gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZveGVsIFRoZSB2b3hlbCB2YWx1ZSB0byBpbnNlcnQgdGhlIGlkIGludG8uCiAgICAgKiBAcGFyYW0gaWQgVGhlIHZveGVsIGlkIHRvIGluc2VydC4KICAgICAqIEByZXR1cm5zIFRoZSBpbnNlcnRlZCB2b3hlbCB2YWx1ZS4KICAgICAqLyBfZGVmaW5lUHJvcGVydHkkMihCbG9ja1V0aWxzLCAiaW5zZXJ0SUQiLCAodm94ZWwsIGlkKT0+ewogICAgICByZXR1cm4gdm94ZWwgJiAweGZmZmYwMDAwIHwgaWQgJiAweGZmZmY7CiAgfSk7CiAgLyoqCiAgICAgKiBFeHRyYWN0IHRoZSB2b3hlbCByb3RhdGlvbiBmcm9tIGEgbnVtYmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2b3hlbCBUaGUgdm94ZWwgdmFsdWUgdG8gZXh0cmFjdCBmcm9tLgogICAgICogQHJldHVybnMgVGhlIGV4dHJhY3RlZCB2b3hlbCByb3RhdGlvbi4KICAgICAqLyBfZGVmaW5lUHJvcGVydHkkMihCbG9ja1V0aWxzLCAiZXh0cmFjdFJvdGF0aW9uIiwgKHZveGVsKT0+ewogICAgICBjb25zdCByb3RhdGlvbiA9IHZveGVsID4+IDE2ICYgMHhmOwogICAgICBjb25zdCB5Um90ID0gdm94ZWwgPj4gMjAgJiAweGY7CiAgICAgIHJldHVybiBCbG9ja1JvdGF0aW9uLmVuY29kZShyb3RhdGlvbiwgeVJvdCk7CiAgfSk7CiAgLyoqCiAgICAgKiBJbnNlcnQgYSB2b3hlbCByb3RhdGlvbiBpbnRvIGEgbnVtYmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2b3hlbCBUaGUgdm94ZWwgdmFsdWUgdG8gaW5zZXJ0IHRoZSByb3RhdGlvbiBpbnRvLgogICAgICogQHBhcmFtIHJvdGF0aW9uIFRoZSB2b3hlbCByb3RhdGlvbiB0byBpbnNlcnQuCiAgICAgKiBAcmV0dXJucyBUaGUgaW5zZXJ0ZWQgdm94ZWwgdmFsdWUuCiAgICAgKi8gX2RlZmluZVByb3BlcnR5JDIoQmxvY2tVdGlscywgImluc2VydFJvdGF0aW9uIiwgKHZveGVsLCByb3RhdGlvbik9PnsKICAgICAgY29uc3QgW3JvdCwgeVJvdF0gPSBCbG9ja1JvdGF0aW9uLmRlY29kZShyb3RhdGlvbik7CiAgICAgIGNvbnN0IHZhbHVlID0gdm94ZWwgJiBST1RBVElPTl9NQVNLIHwgKHJvdCAmIDB4ZikgPDwgMTY7CiAgICAgIHJldHVybiB2YWx1ZSAmIFlfUk9UQVRJT05fTUFTSyB8ICh5Um90ICYgMHhmKSA8PCAyMDsKICB9KTsKICAvKioKICAgICAqIEV4dHJhY3QgdGhlIHZveGVsIHN0YWdlIGZyb20gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZveGVsIFRoZSB2b3hlbCB2YWx1ZSB0byBleHRyYWN0IGZyb20uCiAgICAgKiBAcmV0dXJucyBUaGUgZXh0cmFjdGVkIHZveGVsIHN0YWdlLgogICAgICovIF9kZWZpbmVQcm9wZXJ0eSQyKEJsb2NrVXRpbHMsICJleHRyYWN0U3RhZ2UiLCAodm94ZWwpPT57CiAgICAgIHJldHVybiB2b3hlbCA+PiAyNCAmIDB4ZjsKICB9KTsKICAvKioKICAgICAqIEluc2VydCBhIHZveGVsIHN0YWdlIGludG8gYSBudW1iZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZveGVsIFRoZSB2b3hlbCB2YWx1ZSB0byBpbnNlcnQgdGhlIHN0YWdlIGludG8uCiAgICAgKiBAcGFyYW0gc3RhZ2UgVGhlIHZveGVsIHN0YWdlIHRvIGluc2VydC4KICAgICAqIEByZXR1cm5zIFRoZSBpbnNlcnRlZCB2b3hlbCB2YWx1ZS4KICAgICAqLyBfZGVmaW5lUHJvcGVydHkkMihCbG9ja1V0aWxzLCAiaW5zZXJ0U3RhZ2UiLCAodm94ZWwsIHN0YWdlKT0+ewogICAgICByZXR1cm4gdm94ZWwgJiBTVEFHRV9NQVNLIHwgc3RhZ2UgPDwgMjQ7CiAgfSk7CiAgX2RlZmluZVByb3BlcnR5JDIoQmxvY2tVdGlscywgImluc2VydEFsbCIsIChpZCwgcm90YXRpb24sIHN0YWdlKT0+ewogICAgICBsZXQgdmFsdWUgPSAwOwogICAgICB2YWx1ZSA9IEJsb2NrVXRpbHMuaW5zZXJ0SUQodmFsdWUsIGlkKTsKICAgICAgaWYgKHJvdGF0aW9uKSB2YWx1ZSA9IEJsb2NrVXRpbHMuaW5zZXJ0Um90YXRpb24odmFsdWUsIHJvdGF0aW9uKTsKICAgICAgaWYgKHN0YWdlICE9PSB1bmRlZmluZWQpIHZhbHVlID0gQmxvY2tVdGlscy5pbnNlcnRTdGFnZSh2YWx1ZSwgc3RhZ2UpOwogICAgICByZXR1cm4gdmFsdWU7CiAgfSk7CiAgX2RlZmluZVByb3BlcnR5JDIoQmxvY2tVdGlscywgImdldEJsb2NrVG9yY2hMaWdodExldmVsIiwgKGJsb2NrLCBjb2xvcik9PnsKICAgICAgc3dpdGNoKGNvbG9yKXsKICAgICAgICAgIGNhc2UgIlJFRCI6CiAgICAgICAgICAgICAgcmV0dXJuIGJsb2NrLnJlZExpZ2h0TGV2ZWw7CiAgICAgICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgICAgICAgcmV0dXJuIGJsb2NrLmdyZWVuTGlnaHRMZXZlbDsKICAgICAgICAgIGNhc2UgIkJMVUUiOgogICAgICAgICAgICAgIHJldHVybiBibG9jay5ibHVlTGlnaHRMZXZlbDsKICAgICAgfQogICAgICByZXR1cm4gMDsKICB9KTsKCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5JDEob2JqLCBrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gb2JqOwogIH0KICBjbGFzcyBSYXdDaHVuayB7CiAgICAgIHNlcmlhbGl6ZSgpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZDogdGhpcy5pZCwKICAgICAgICAgICAgICAgICAgeDogdGhpcy5jb29yZHNbMF0sCiAgICAgICAgICAgICAgICAgIHo6IHRoaXMuY29vcmRzWzFdLAogICAgICAgICAgICAgICAgICB2b3hlbHM6IHRoaXMudm94ZWxzLmRhdGEuYnVmZmVyLAogICAgICAgICAgICAgICAgICBsaWdodHM6IHRoaXMubGlnaHRzLmRhdGEuYnVmZmVyLAogICAgICAgICAgICAgICAgICBvcHRpb25zOiB0aGlzLm9wdGlvbnMKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgdGhpcy52b3hlbHMuZGF0YS5idWZmZXIuc2xpY2UoMCksCiAgICAgICAgICAgICAgICAgIHRoaXMubGlnaHRzLmRhdGEuYnVmZmVyLnNsaWNlKDApCiAgICAgICAgICAgICAgXQogICAgICAgICAgXTsKICAgICAgfQogICAgICBzdGF0aWMgZGVzZXJpYWxpemUoZGF0YSkgewogICAgICAgICAgY29uc3QgeyBpZCAsIHggLCB6ICwgdm94ZWxzICwgbGlnaHRzICwgb3B0aW9ucyAgfSA9IGRhdGE7CiAgICAgICAgICBjb25zdCBjaHVuayA9IG5ldyBSYXdDaHVuayhpZCwgWwogICAgICAgICAgICAgIHgsCiAgICAgICAgICAgICAgegogICAgICAgICAgXSwgb3B0aW9ucyk7CiAgICAgICAgICBpZiAobGlnaHRzICYmIGxpZ2h0cy5ieXRlTGVuZ3RoKSBjaHVuay5saWdodHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheShsaWdodHMpOwogICAgICAgICAgaWYgKHZveGVscyAmJiB2b3hlbHMuYnl0ZUxlbmd0aCkgY2h1bmsudm94ZWxzLmRhdGEgPSBuZXcgVWludDMyQXJyYXkodm94ZWxzKTsKICAgICAgICAgIHJldHVybiBjaHVuazsKICAgICAgfQogICAgICBzZXREYXRhKGRhdGEpIHsKICAgICAgICAgIGNvbnN0IHsgaWQgLCB4ICwgeiAgfSA9IGRhdGE7CiAgICAgICAgICBpZiAodGhpcy5pZCAhPT0gaWQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNodW5rIGlkIG1pc21hdGNoIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5jb29yZHNbMF0gIT09IHggfHwgdGhpcy5jb29yZHNbMV0gIT09IHopIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNodW5rIGNvb3JkcyBtaXNtYXRjaCIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgeyB2b3hlbHMgLCBsaWdodHMgIH0gPSBkYXRhOwogICAgICAgICAgaWYgKGxpZ2h0cyAmJiBsaWdodHMuYnl0ZUxlbmd0aCkgdGhpcy5saWdodHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheShsaWdodHMpOwogICAgICAgICAgaWYgKHZveGVscyAmJiB2b3hlbHMuYnl0ZUxlbmd0aCkgdGhpcy52b3hlbHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheSh2b3hlbHMpOwogICAgICB9CiAgICAgIC8qKgogICAgICogR2V0IHRoZSByYXcgdm94ZWwgdmFsdWUgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgdm94ZWwgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBpcyBub3Qgd2l0aGluCiAgICAgKiB0aGUgY2h1bmssIHRoaXMgbWV0aG9kIHJldHVybnMgYDBgLgogICAgICovIGdldFJhd1ZhbHVlKHZ4LCB2eSwgdnopIHsKICAgICAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICAgICAgcmV0dXJuIHRoaXMudm94ZWxzLmdldChseCwgbHksIGx6KTsKICAgICAgfQogICAgICAvKioKICAgICAqIFNldCB0aGUgcmF3IHZveGVsIHZhbHVlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgcmF3IHZveGVsIHZhbHVlIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgdm94ZWwgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8gc2V0UmF3VmFsdWUodngsIHZ5LCB2eiwgdmFsKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICAgICAgcmV0dXJuIHRoaXMudm94ZWxzLnNldChseCwgbHksIGx6LCB2YWwpOwogICAgICB9CiAgICAgIC8qKgogICAgICogR2V0IHRoZSByYXcgbGlnaHQgdmFsdWUgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgbGlnaHQgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8gZ2V0UmF3TGlnaHQodngsIHZ5LCB2eikgewogICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSByZXR1cm4gMDsKICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiB0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseik7CiAgICAgIH0KICAgICAgLyoqCiAgICAgKiBTZXQgdGhlIHJhdyBsaWdodCB2YWx1ZSBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIHJhdyBsaWdodCBsZXZlbCB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgcmF3IGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovIHNldFJhd0xpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldChseCwgbHksIGx6LCBsZXZlbCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgKiBHZXQgdGhlIHZveGVsIHR5cGUgSUQgYXQgYSBnaXZlbiB2b3hlbCBvciB3b3JsZCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSB2b3hlbCB0eXBlIElEIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovIGdldFZveGVsKHZ4LCB2eSwgdnopIHsKICAgICAgICAgIHJldHVybiBCbG9ja1V0aWxzLmV4dHJhY3RJRCh0aGlzLmdldFJhd1ZhbHVlKHZ4IHwgMCwgdnkgfCAwLCB2eiB8IDApKTsKICAgICAgfQogICAgICAvKioKICAgICAqIFNldCB0aGUgdm94ZWwgdHlwZSBJRCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gaWQgVGhlIHZveGVsIHR5cGUgSUQgdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHZveGVsIHR5cGUgSUQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8gc2V0Vm94ZWwodngsIHZ5LCB2eiwgaWQpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gQmxvY2tVdGlscy5pbnNlcnRJRCgwLCBpZCk7CiAgICAgICAgICB0aGlzLnNldFJhd1ZhbHVlKHZ4LCB2eSwgdnosIHZhbHVlKTsKICAgICAgICAgIHJldHVybiBpZDsKICAgICAgfQogICAgICAvKioKICAgICAqIEdldCB0aGUgdm94ZWwgcm90YXRpb24gYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSB2b3hlbCByb3RhdGlvbiBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqLyBnZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnopIHsKICAgICAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgcmV0dXJuIG5ldyBCbG9ja1JvdGF0aW9uKCk7CiAgICAgICAgICByZXR1cm4gQmxvY2tVdGlscy5leHRyYWN0Um90YXRpb24odGhpcy5nZXRSYXdWYWx1ZSh2eCwgdnksIHZ6KSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgKiBTZXQgdGhlIHZveGVsIHJvdGF0aW9uIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSByb3RhdGlvbiBUaGUgdm94ZWwgcm90YXRpb24gdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovIHNldFZveGVsUm90YXRpb24odngsIHZ5LCB2eiwgcm90YXRpb24pIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbih0aGlzLmdldFJhd1ZhbHVlKHZ4LCB2eSwgdnopLCByb3RhdGlvbik7CiAgICAgICAgICB0aGlzLnNldFJhd1ZhbHVlKHZ4LCB2eSwgdnosIHZhbHVlKTsKICAgICAgfQogICAgICAvKioKICAgICAqIEdldCB0aGUgdm94ZWwgc3RhZ2UgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSB2b3hlbCBzdGFnZSBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqLyBnZXRWb3hlbFN0YWdlKHZ4LCB2eSwgdnopIHsKICAgICAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgcmV0dXJuIDA7CiAgICAgICAgICByZXR1cm4gQmxvY2tVdGlscy5leHRyYWN0U3RhZ2UodGhpcy5nZXRSYXdWYWx1ZSh2eCwgdnksIHZ6KSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgKiBTZXQgdGhlIHZveGVsIHN0YWdlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSBzdGFnZSBUaGUgdm94ZWwgc3RhZ2UgdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHZveGVsIHN0YWdlIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovIHNldFZveGVsU3RhZ2UodngsIHZ5LCB2eiwgc3RhZ2UpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gQmxvY2tVdGlscy5pbnNlcnRTdGFnZSh0aGlzLmdldFJhd1ZhbHVlKHZ4LCB2eSwgdnopLCBzdGFnZSk7CiAgICAgICAgICB0aGlzLnNldFJhd1ZhbHVlKHZ4LCB2eSwgdnosIHZhbHVlKTsKICAgICAgICAgIHJldHVybiBzdGFnZTsKICAgICAgfQogICAgICAvKioKICAgICAqIEdldCB0aGUgcmVkIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgcmVkIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8gZ2V0UmVkTGlnaHQodngsIHZ5LCB2eikgewogICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRMb2NhbFJlZExpZ2h0KGx4LCBseSwgbHopOwogICAgICB9CiAgICAgIC8qKgogICAgICogU2V0IHRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIGxldmVsIFRoZSByZWQgbGlnaHQgbGV2ZWwgdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHJlZCBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovIHNldFJlZExpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiB0aGlzLnNldExvY2FsUmVkTGlnaHQobHgsIGx5LCBseiwgbGV2ZWwpOwogICAgICB9CiAgICAgIC8qKgogICAgICogR2V0IHRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHJldHVybnMgVGhlIGdyZWVuIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8gZ2V0R3JlZW5MaWdodCh2eCwgdnksIHZ6KSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiB0aGlzLmdldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6KTsKICAgICAgfQogICAgICAvKioKICAgICAqIFNldCB0aGUgZ3JlZW4gbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIGxldmVsIFRoZSBncmVlbiBsaWdodCBsZXZlbCB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgZ3JlZW4gbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLyBzZXRHcmVlbkxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiB0aGlzLnNldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6LCBsZXZlbCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgKiBHZXQgdGhlIGJsdWUgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEByZXR1cm5zIFRoZSBibHVlIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8gZ2V0Qmx1ZUxpZ2h0KHZ4LCB2eSwgdnopIHsKICAgICAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TG9jYWxCbHVlTGlnaHQobHgsIGx5LCBseik7CiAgICAgIH0KICAgICAgLyoqCiAgICAgKiBTZXQgdGhlIGJsdWUgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIGxldmVsIFRoZSBibHVlIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBibHVlIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8gc2V0Qmx1ZUxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiB0aGlzLnNldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgICAgfQogICAgICAvKioKICAgICAqIEdldCB0aGUgY29sb3JlZCB0b3JjaCBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIGNvbG9yIFRoZSBjb2xvciBvZiB0aGUgbGlnaHQgdG8gZ2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8gZ2V0VG9yY2hMaWdodCh2eCwgdnksIHZ6LCBjb2xvcikgewogICAgICAgICAgc3dpdGNoKGNvbG9yKXsKICAgICAgICAgICAgICBjYXNlICJSRUQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRSZWRMaWdodCh2eCwgdnksIHZ6KTsKICAgICAgICAgICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEdyZWVuTGlnaHQodngsIHZ5LCB2eik7CiAgICAgICAgICAgICAgY2FzZSAiQkxVRSI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEJsdWVMaWdodCh2eCwgdnksIHZ6KTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlY2VpdmVkIHVua25vd24gbGlnaHQgY29sb3IuLi4iKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICAvKioKICAgICAqIFNldCB0aGUgY29sb3JlZCB0b3JjaCBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSBjb2xvciBUaGUgY29sb3Igb2YgdGhlIGxpZ2h0IHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovIHNldFRvcmNoTGlnaHQodngsIHZ5LCB2eiwgbGV2ZWwsIGNvbG9yKSB7CiAgICAgICAgICBzd2l0Y2goY29sb3IpewogICAgICAgICAgICAgIGNhc2UgIlJFRCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFJlZExpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKTsKICAgICAgICAgICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldEdyZWVuTGlnaHQodngsIHZ5LCB2eiwgbGV2ZWwpOwogICAgICAgICAgICAgIGNhc2UgIkJMVUUiOgogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRCbHVlTGlnaHQodngsIHZ5LCB2eiwgbGV2ZWwpOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVjZWl2ZWQgdW5rbm93biBsaWdodCBjb2xvci4uLiIpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8qKgogICAgICogR2V0IHRoZSBzdW5saWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHJldHVybnMgVGhlIHN1bmxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8gZ2V0U3VubGlnaHQodngsIHZ5LCB2eikgewogICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRMb2NhbFN1bmxpZ2h0KGx4LCBseSwgbHopOwogICAgICB9CiAgICAgIC8qKgogICAgICogU2V0IHRoZSBzdW5saWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIHN1bmxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBzdW5saWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovIHNldFN1bmxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiB0aGlzLnNldExvY2FsU3VubGlnaHQobHgsIGx5LCBseiwgbGV2ZWwpOwogICAgICB9CiAgICAgIC8qKgogICAgICogV2hldGhlciBvciBub3QgaXMgdGhpcyBjaHVuayByZWFkeSB0byBiZSByZW5kZXJlZCBhbmQgc2VlbiBpbiB0aGUgd29ybGQuCiAgICAgKi8gZ2V0IGlzUmVhZHkoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5saWdodHMuZGF0YS5sZW5ndGggIT09IDAgJiYgdGhpcy52b3hlbHMuZGF0YS5sZW5ndGggIT09IDA7CiAgICAgIH0KICAgICAgZ2V0TG9jYWxSZWRMaWdodChseCwgbHksIGx6KSB7CiAgICAgICAgICByZXR1cm4gTGlnaHRVdGlscy5leHRyYWN0UmVkTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopKTsKICAgICAgfQogICAgICBzZXRMb2NhbFJlZExpZ2h0KGx4LCBseSwgbHosIGxldmVsKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5saWdodHMuc2V0KGx4LCBseSwgbHosIExpZ2h0VXRpbHMuaW5zZXJ0UmVkTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkpOwogICAgICB9CiAgICAgIGdldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6KSB7CiAgICAgICAgICByZXR1cm4gTGlnaHRVdGlscy5leHRyYWN0R3JlZW5MaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgICB9CiAgICAgIHNldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6LCBsZXZlbCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldChseCwgbHksIGx6LCBMaWdodFV0aWxzLmluc2VydEdyZWVuTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkpOwogICAgICB9CiAgICAgIGdldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHopIHsKICAgICAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RCbHVlTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopKTsKICAgICAgfQogICAgICBzZXRMb2NhbEJsdWVMaWdodChseCwgbHksIGx6LCBsZXZlbCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldChseCwgbHksIGx6LCBMaWdodFV0aWxzLmluc2VydEJsdWVMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseiksIGxldmVsKSk7CiAgICAgIH0KICAgICAgZ2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6KSB7CiAgICAgICAgICByZXR1cm4gTGlnaHRVdGlscy5leHRyYWN0U3VubGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopKTsKICAgICAgfQogICAgICBzZXRMb2NhbFN1bmxpZ2h0KGx4LCBseSwgbHosIGxldmVsKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5saWdodHMuc2V0KGx4LCBseSwgbHosIExpZ2h0VXRpbHMuaW5zZXJ0U3VubGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkpOwogICAgICB9CiAgICAgIHRvTG9jYWwodngsIHZ5LCB2eikgewogICAgICAgICAgY29uc3QgW214LCBteSwgbXpdID0gdGhpcy5taW47CiAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICh2eCB8IDApIC0gbXgsCiAgICAgICAgICAgICAgKHZ5IHwgMCkgLSBteSwKICAgICAgICAgICAgICAodnogfCAwKSAtIG16CiAgICAgICAgICBdOwogICAgICB9CiAgICAgIGNvbnRhaW5zKHZ4LCB2eSwgdnopIHsKICAgICAgICAgIGNvbnN0IHsgc2l6ZSAsIG1heEhlaWdodCAgfSA9IHRoaXMub3B0aW9uczsKICAgICAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiBseCA8IHNpemUgJiYgbHkgPj0gMCAmJiBseSA8IG1heEhlaWdodCAmJiBseiA+PSAwICYmIGx6IDwgc2l6ZTsKICAgICAgfQogICAgICBjb25zdHJ1Y3RvcihpZCwgY29vcmRzLCBvcHRpb25zKXsKICAgICAgICAgIF9kZWZpbmVQcm9wZXJ0eSQxKHRoaXMsICJvcHRpb25zIiwgdm9pZCAwKTsKICAgICAgICAgIF9kZWZpbmVQcm9wZXJ0eSQxKHRoaXMsICJpZCIsIHZvaWQgMCk7CiAgICAgICAgICBfZGVmaW5lUHJvcGVydHkkMSh0aGlzLCAibmFtZSIsIHZvaWQgMCk7CiAgICAgICAgICBfZGVmaW5lUHJvcGVydHkkMSh0aGlzLCAiY29vcmRzIiwgdm9pZCAwKTsKICAgICAgICAgIF9kZWZpbmVQcm9wZXJ0eSQxKHRoaXMsICJtaW4iLCB2b2lkIDApOwogICAgICAgICAgX2RlZmluZVByb3BlcnR5JDEodGhpcywgIm1heCIsIHZvaWQgMCk7CiAgICAgICAgICBfZGVmaW5lUHJvcGVydHkkMSh0aGlzLCAidm94ZWxzIiwgdm9pZCAwKTsKICAgICAgICAgIF9kZWZpbmVQcm9wZXJ0eSQxKHRoaXMsICJsaWdodHMiLCB2b2lkIDApOwogICAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgICAgdGhpcy5uYW1lID0gQ2h1bmtVdGlscy5nZXRDaHVua05hbWUoY29vcmRzKTsKICAgICAgICAgIHRoaXMuY29vcmRzID0gY29vcmRzOwogICAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICAgIGNvbnN0IHsgc2l6ZSAsIG1heEhlaWdodCAgfSA9IG9wdGlvbnM7CiAgICAgICAgICB0aGlzLnZveGVscyA9IG5kYXJyYXkoW10sIFsKICAgICAgICAgICAgICBzaXplLAogICAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgICBzaXplCiAgICAgICAgICBdKTsKICAgICAgICAgIHRoaXMubGlnaHRzID0gbmRhcnJheShbXSwgWwogICAgICAgICAgICAgIHNpemUsCiAgICAgICAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgICAgICAgIHNpemUKICAgICAgICAgIF0pOwogICAgICAgICAgY29uc3QgW3gsIHpdID0gY29vcmRzOwogICAgICAgICAgdGhpcy5taW4gPSBbCiAgICAgICAgICAgICAgeCAqIHNpemUsCiAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICB6ICogc2l6ZQogICAgICAgICAgXTsKICAgICAgICAgIHRoaXMubWF4ID0gWwogICAgICAgICAgICAgICh4ICsgMSkgKiBzaXplLAogICAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgICAoeiArIDEpICogc2l6ZQogICAgICAgICAgXTsKICAgICAgfQogIH0KCiAgZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KG9iaiwga2V5LCB2YWx1ZSkgewogICAgICBpZiAoa2V5IGluIG9iaikgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9ialtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICB9CiAgY2xhc3MgUmVnaXN0cnkgewogICAgICBzZXJpYWxpemUoKSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgYmxvY2tzQnlOYW1lOiBBcnJheS5mcm9tKHRoaXMuYmxvY2tzQnlOYW1lLmVudHJpZXMoKSksCiAgICAgICAgICAgICAgYmxvY2tzQnlJZDogQXJyYXkuZnJvbSh0aGlzLmJsb2Nrc0J5SWQuZW50cmllcygpKSwKICAgICAgICAgICAgICBuYW1lTWFwOiBBcnJheS5mcm9tKHRoaXMubmFtZU1hcC5lbnRyaWVzKCkpLAogICAgICAgICAgICAgIGlkTWFwOiBBcnJheS5mcm9tKHRoaXMuaWRNYXAuZW50cmllcygpKQogICAgICAgICAgfSkpOwogICAgICB9CiAgICAgIHN0YXRpYyBkZXNlcmlhbGl6ZShkYXRhKSB7CiAgICAgICAgICBjb25zdCByZWdpc3RyeSA9IG5ldyBSZWdpc3RyeSgpOwogICAgICAgICAgcmVnaXN0cnkuYmxvY2tzQnlOYW1lID0gbmV3IE1hcChkYXRhLmJsb2Nrc0J5TmFtZSk7CiAgICAgICAgICByZWdpc3RyeS5ibG9ja3NCeUlkID0gbmV3IE1hcChkYXRhLmJsb2Nrc0J5SWQpOwogICAgICAgICAgcmVnaXN0cnkubmFtZU1hcCA9IG5ldyBNYXAoZGF0YS5uYW1lTWFwKTsKICAgICAgICAgIHJlZ2lzdHJ5LmlkTWFwID0gbmV3IE1hcChkYXRhLmlkTWFwKTsKICAgICAgICAgIHJldHVybiByZWdpc3RyeTsKICAgICAgfQogICAgICAvKioKICAgICAqIEBoaWRkZW4KICAgICAqLyBjb25zdHJ1Y3RvcigpewogICAgICAgICAgX2RlZmluZVByb3BlcnR5KHRoaXMsICJibG9ja3NCeU5hbWUiLCBuZXcgTWFwKCkpOwogICAgICAgICAgX2RlZmluZVByb3BlcnR5KHRoaXMsICJibG9ja3NCeUlkIiwgbmV3IE1hcCgpKTsKICAgICAgICAgIF9kZWZpbmVQcm9wZXJ0eSh0aGlzLCAibmFtZU1hcCIsIG5ldyBNYXAoKSk7CiAgICAgICAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgImlkTWFwIiwgbmV3IE1hcCgpKTsKICAgICAgLy8gRE8gTk9USElORwogICAgICB9CiAgfQoKICBsZXQgcmVnaXN0cnk7CiAgLy8gQHRzLWlnbm9yZQogIG9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgY29uc3QgeyB0eXBlICB9ID0gZS5kYXRhOwogICAgICBpZiAodHlwZSAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgPT09ICJpbml0IikgewogICAgICAgICAgcmVnaXN0cnkgPSBSZWdpc3RyeS5kZXNlcmlhbGl6ZShlLmRhdGEucmVnaXN0cnlEYXRhKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBmdW5jdGlvbiB2ZXJ0ZXhBTyhzaWRlMSwgc2lkZTIsIGNvcm5lcikgewogICAgICAgICAgY29uc3QgbnVtUzEgPSBOdW1iZXIoIXNpZGUxKTsKICAgICAgICAgIGNvbnN0IG51bVMyID0gTnVtYmVyKCFzaWRlMik7CiAgICAgICAgICBjb25zdCBudW1DID0gTnVtYmVyKCFjb3JuZXIpOwogICAgICAgICAgaWYgKG51bVMxID09PSAxICYmIG51bVMyID09PSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMyAtIChudW1TMSArIG51bVMyICsgbnVtQyk7CiAgICAgIH0KICAgICAgY29uc3QgeyBjaHVua3NEYXRhICwgbWluICwgbWF4ICB9ID0gZS5kYXRhOwogICAgICBjb25zdCB7IGNodW5rU2l6ZSAsIG1heExpZ2h0TGV2ZWwgIH0gPSBlLmRhdGEub3B0aW9uczsKICAgICAgY29uc3QgY2h1bmtzID0gY2h1bmtzRGF0YS5tYXAoKGNodW5rRGF0YSk9PnsKICAgICAgICAgIGlmICghY2h1bmtEYXRhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBjaHVuayA9IFJhd0NodW5rLmRlc2VyaWFsaXplKGNodW5rRGF0YSk7CiAgICAgICAgICByZXR1cm4gY2h1bms7CiAgICAgIH0pOwogICAgICBjb25zdCBnZXRDaHVua0J5Q29vcmRzID0gKGNvb3Jkcyk9PnsKICAgICAgICAgIGNvbnN0IGNlbnRlckNvb3JkcyA9IGNodW5rc1s0XS5jb29yZHM7CiAgICAgICAgICBjb25zdCBkeCA9IGNvb3Jkc1swXSAtIGNlbnRlckNvb3Jkc1swXTsKICAgICAgICAgIGNvbnN0IGR5ID0gY29vcmRzWzFdIC0gY2VudGVyQ29vcmRzWzFdOwogICAgICAgICAgY29uc3QgaW5kZXggPSAoZHkgKyAxKSAqIDMgKyAoZHggKyAxKTsKICAgICAgICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gY2h1bmtzLmxlbmd0aCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBjb29yZGluYXRlczogJHtjb29yZHN9YCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2h1bmtzW2luZGV4XTsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0Vm94ZWxBdCA9ICh2eCwgdnksIHZ6KT0+ewogICAgICAgICAgY29uc3QgY29vcmRzID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoWwogICAgICAgICAgICAgIHZ4LAogICAgICAgICAgICAgIHZ5LAogICAgICAgICAgICAgIHZ6CiAgICAgICAgICBdLCBjaHVua1NpemUpOwogICAgICAgICAgY29uc3QgY2h1bmsgPSBnZXRDaHVua0J5Q29vcmRzKGNvb3Jkcyk7CiAgICAgICAgICB2YXIgX2NodW5rX2dldFZveGVsOwogICAgICAgICAgcmV0dXJuIChfY2h1bmtfZ2V0Vm94ZWwgPSBjaHVuayA9PT0gbnVsbCB8fCBjaHVuayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2h1bmsuZ2V0Vm94ZWwodngsIHZ5LCB2eikpICE9PSBudWxsICYmIF9jaHVua19nZXRWb3hlbCAhPT0gdm9pZCAwID8gX2NodW5rX2dldFZveGVsIDogMDsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0U3VubGlnaHRBdCA9ICh2eCwgdnksIHZ6KT0+ewogICAgICAgICAgY29uc3QgY29vcmRzID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoWwogICAgICAgICAgICAgIHZ4LAogICAgICAgICAgICAgIHZ5LAogICAgICAgICAgICAgIHZ6CiAgICAgICAgICBdLCBjaHVua1NpemUpOwogICAgICAgICAgY29uc3QgY2h1bmsgPSBnZXRDaHVua0J5Q29vcmRzKGNvb3Jkcyk7CiAgICAgICAgICB2YXIgX2NodW5rX2dldFN1bmxpZ2h0OwogICAgICAgICAgcmV0dXJuIChfY2h1bmtfZ2V0U3VubGlnaHQgPSBjaHVuayA9PT0gbnVsbCB8fCBjaHVuayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2h1bmsuZ2V0U3VubGlnaHQodngsIHZ5LCB2eikpICE9PSBudWxsICYmIF9jaHVua19nZXRTdW5saWdodCAhPT0gdm9pZCAwID8gX2NodW5rX2dldFN1bmxpZ2h0IDogMDsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0VG9yY2hsaWdodEF0ID0gKHZ4LCB2eSwgdnosIGNvbG9yKT0+ewogICAgICAgICAgY29uc3QgY29vcmRzID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoWwogICAgICAgICAgICAgIHZ4LAogICAgICAgICAgICAgIHZ5LAogICAgICAgICAgICAgIHZ6CiAgICAgICAgICBdLCBjaHVua1NpemUpOwogICAgICAgICAgY29uc3QgY2h1bmsgPSBnZXRDaHVua0J5Q29vcmRzKGNvb3Jkcyk7CiAgICAgICAgICB2YXIgX2NodW5rX2dldFRvcmNoTGlnaHQ7CiAgICAgICAgICByZXR1cm4gKF9jaHVua19nZXRUb3JjaExpZ2h0ID0gY2h1bmsgPT09IG51bGwgfHwgY2h1bmsgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNodW5rLmdldFRvcmNoTGlnaHQodngsIHZ5LCB2eiwgY29sb3IpKSAhPT0gbnVsbCAmJiBfY2h1bmtfZ2V0VG9yY2hMaWdodCAhPT0gdm9pZCAwID8gX2NodW5rX2dldFRvcmNoTGlnaHQgOiAwOwogICAgICB9OwogICAgICBjb25zdCBnZXRWb3hlbFJvdGF0aW9uQXQgPSAodngsIHZ5LCB2eik9PnsKICAgICAgICAgIGNvbnN0IGNvb3JkcyA9IENodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rKFsKICAgICAgICAgICAgICB2eCwKICAgICAgICAgICAgICB2eSwKICAgICAgICAgICAgICB2egogICAgICAgICAgXSwgY2h1bmtTaXplKTsKICAgICAgICAgIGNvbnN0IGNodW5rID0gZ2V0Q2h1bmtCeUNvb3Jkcyhjb29yZHMpOwogICAgICAgICAgdmFyIF9jaHVua19nZXRWb3hlbFJvdGF0aW9uOwogICAgICAgICAgcmV0dXJuIChfY2h1bmtfZ2V0Vm94ZWxSb3RhdGlvbiA9IGNodW5rID09PSBudWxsIHx8IGNodW5rID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjaHVuay5nZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnopKSAhPT0gbnVsbCAmJiBfY2h1bmtfZ2V0Vm94ZWxSb3RhdGlvbiAhPT0gdm9pZCAwID8gX2NodW5rX2dldFZveGVsUm90YXRpb24gOiBuZXcgQmxvY2tSb3RhdGlvbigpOwogICAgICB9OwogICAgICBjb25zdCBnZXRWb3hlbFN0YWdlQXQgPSAodngsIHZ5LCB2eik9PnsKICAgICAgICAgIGNvbnN0IGNvb3JkcyA9IENodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rKFsKICAgICAgICAgICAgICB2eCwKICAgICAgICAgICAgICB2eSwKICAgICAgICAgICAgICB2egogICAgICAgICAgXSwgY2h1bmtTaXplKTsKICAgICAgICAgIGNvbnN0IGNodW5rID0gZ2V0Q2h1bmtCeUNvb3Jkcyhjb29yZHMpOwogICAgICAgICAgdmFyIF9jaHVua19nZXRWb3hlbFN0YWdlOwogICAgICAgICAgcmV0dXJuIChfY2h1bmtfZ2V0Vm94ZWxTdGFnZSA9IGNodW5rID09PSBudWxsIHx8IGNodW5rID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjaHVuay5nZXRWb3hlbFN0YWdlKHZ4LCB2eSwgdnopKSAhPT0gbnVsbCAmJiBfY2h1bmtfZ2V0Vm94ZWxTdGFnZSAhPT0gdm9pZCAwID8gX2NodW5rX2dldFZveGVsU3RhZ2UgOiAwOwogICAgICB9OwogICAgICBjb25zdCBnZXRCbG9ja0F0ID0gKHZ4LCB2eSwgdnopPT57CiAgICAgICAgICBjb25zdCB2b3hlbElkID0gZ2V0Vm94ZWxBdCh2eCwgdnksIHZ6KTsKICAgICAgICAgIHJldHVybiByZWdpc3RyeS5ibG9ja3NCeUlkLmdldCh2b3hlbElkKTsKICAgICAgfTsKICAgICAgLy8gU3RhcnQgbWVzaGluZwogICAgICBjb25zdCBbbWluWCwgbWluWSwgbWluWl0gPSBtaW47CiAgICAgIGNvbnN0IFttYXhYLCBtYXhZLCBtYXhaXSA9IG1heDsKICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IHt9OwogICAgICBmb3IobGV0IHZ4ID0gbWluWDsgdnggPCBtYXhYOyB2eCsrKXsKICAgICAgICAgIGZvcihsZXQgdnogPSBtaW5aOyB2eiA8IG1heFo7IHZ6KyspewogICAgICAgICAgICAgIGZvcihsZXQgdnkgPSBtaW5ZOyB2eSA8IG1heFk7IHZ5KyspewogICAgICAgICAgICAgICAgICBjb25zdCB2b3hlbCA9IGdldFZveGVsQXQodngsIHZ5LCB2eik7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHJvdGF0aW9uID0gZ2V0Vm94ZWxSb3RhdGlvbkF0KHZ4LCB2eSwgdnopOwogICAgICAgICAgICAgICAgICBjb25zdCBibG9jayA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KHZveGVsKTsKICAgICAgICAgICAgICAgICAgY29uc3QgeyBpZCAsIGlzU2VlVGhyb3VnaCAsIGlzRW1wdHkgLCBpc09wYXF1ZSAsIG5hbWUgLCByb3RhdGFibGUgLCB5Um90YXRhYmxlICwgaXNEeW5hbWljICwgZHluYW1pY1BhdHRlcm5zICB9ID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgIGxldCBhYWJicyA9IGJsb2NrLmFhYmJzOwogICAgICAgICAgICAgICAgICBsZXQgZmFjZXMgPSBibG9jay5mYWNlczsKICAgICAgICAgICAgICAgICAgaWYgKGlzRHluYW1pYyAmJiAhZHluYW1pY1BhdHRlcm5zIHx8IGlzRW1wdHkgfHwgZmFjZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY1BhdHRlcm5zKSB7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgZHluYW1pY1BhdHRlcm5zKXsKICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGF0dGVybk1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgcGF0dGVybi5ydWxlcyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG94ID0gcnVsZS5vZmZzZXRbMF0gKyB2eDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3kgPSBydWxlLm9mZnNldFsxXSArIHZ5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBveiA9IHJ1bGUub2Zmc2V0WzJdICsgdno7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBoYXNSdWxlUGFzc2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChydWxlLmlkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IGdldFZveGVsQXQob3gsIG95LCBveik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWQgIT09IHJ1bGUuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuTWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUnVsZVBhc3NlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJ1bGUucm90YXRpb24gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvdGF0aW9uID0gZ2V0Vm94ZWxSb3RhdGlvbkF0KG94LCBveSwgb3opOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJvdGF0aW9uLnZhbHVlICE9PSBydWxlLnJvdGF0aW9uLnZhbHVlIHx8IHJvdGF0aW9uLnlSb3RhdGlvbiAhPT0gcnVsZS5yb3RhdGlvbi55Um90YXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuTWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUnVsZVBhc3NlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJ1bGUuc3RhZ2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YWdlID0gZ2V0Vm94ZWxTdGFnZUF0KHZ4LCB2eSwgdnopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWdlICE9PSBydWxlLnN0YWdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybk1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1J1bGVQYXNzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNSdWxlUGFzc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGF0dGVybk1hdGNoZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFjZXMgPSBwYXR0ZXJuLmZhY2VzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYWJicyA9IHBhdHRlcm4uYWFiYnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBTa2lwIGJsb2NrcyB0aGF0IGFyZSBjb21wbGV0ZWx5IHN1cnJvdW5kZWQgYnkgb3RoZXIgYmxvY2tzCiAgICAgICAgICAgICAgICAgIGxldCBpc1N1cnJvdW5kZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IFtkeCwgZHksIGR6XSBvZiBbCiAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMAogICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMAogICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgLTEKICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgXSl7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvciA9IGdldFZveGVsQXQodnggKyBkeCwgdnkgKyBkeSwgdnogKyBkeik7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvckJsb2NrID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQobmVpZ2hib3IpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCEobmVpZ2hib3JCbG9jayA9PT0gbnVsbCB8fCBuZWlnaGJvckJsb2NrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBuZWlnaGJvckJsb2NrLmlzT3BhcXVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlzU3Vycm91bmRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChpc1N1cnJvdW5kZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnN0IHV2TWFwID0ge307CiAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZmFjZSBvZiBmYWNlcyl7CiAgICAgICAgICAgICAgICAgICAgICB1dk1hcFtmYWNlLm5hbWVdID0gZmFjZS5yYW5nZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGZhY2Ugb2YgZmFjZXMpewogICAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gZmFjZS5pbmRlcGVuZGVudCA/IGAke25hbWUudG9Mb3dlckNhc2UoKX06OiR7ZmFjZS5uYW1lLnRvTG93ZXJDYXNlKCl9YCA6IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfZ2VvbWV0cmllc19rZXk7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IChfZ2VvbWV0cmllc19rZXkgPSBnZW9tZXRyaWVzW2tleV0pICE9PSBudWxsICYmIF9nZW9tZXRyaWVzX2tleSAhPT0gdm9pZCAwID8gX2dlb21ldHJpZXNfa2V5IDogewogICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0czogW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgdm94ZWw6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uczogW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXZzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRpY2VzOiBbXQogICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChmYWNlLmluZGVwZW5kZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkuZmFjZU5hbWUgPSBmYWNlLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAvLyBQcm9jZXNzIHRoZSBmYWNlCiAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRpcjogZmFjZURpciAsIGNvcm5lcnMgIH0gPSBmYWNlOwogICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgIC4uLmZhY2VEaXIKICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICBpZiAocm90YXRhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRpb24ucm90YXRlTm9kZShkaXIsIHlSb3RhdGFibGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRpclswXSA9IE1hdGgucm91bmQoZGlyWzBdKTsKICAgICAgICAgICAgICAgICAgICAgIGRpclsxXSA9IE1hdGgucm91bmQoZGlyWzFdKTsKICAgICAgICAgICAgICAgICAgICAgIGRpclsyXSA9IE1hdGgucm91bmQoZGlyWzJdKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG52eCA9IHZ4ICsgZGlyWzBdOwogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnZ5ID0gdnkgKyBkaXJbMV07CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBudnogPSB2eiArIGRpclsyXTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9ySWQgPSBnZXRWb3hlbEF0KG52eCwgbnZ5LCBudnopOwogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbkNvb3JkcyA9IENodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rKFsKICAgICAgICAgICAgICAgICAgICAgICAgICBudngsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbnZ5LAogICAgICAgICAgICAgICAgICAgICAgICAgIG52egogICAgICAgICAgICAgICAgICAgICAgXSwgY2h1bmtTaXplKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5Jc1ZvaWQgPSAhZ2V0Q2h1bmtCeUNvb3JkcyhuQ29vcmRzKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5CbG9jayA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9ySWQpOwogICAgICAgICAgICAgICAgICAgICAgbGV0IHNlZVRocm91Z2hDaGVjayA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU2VlVGhyb3VnaCAmJiAhaXNPcGFxdWUgJiYgbkJsb2NrLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZkJvdW5kaW5nID0gQUFCQi51bmlvbihhYWJicyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbkJvdW5kaW5nID0gQUFCQi51bmlvbihuQmxvY2suYWFiYnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG5Cb3VuZGluZy50cmFuc2xhdGUoZGlyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShzZWxmQm91bmRpbmcuaW50ZXJzZWN0cyhuQm91bmRpbmcpIHx8IHNlbGZCb3VuZGluZy50b3VjaGVzKG5Cb3VuZGluZykpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZVRocm91Z2hDaGVjayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKG5Jc1ZvaWQgJiYgbkJsb2NrLmlzRW1wdHkgfHwgaXNTZWVUaHJvdWdoICYmICFpc09wYXF1ZSAmJiAhbkJsb2NrLmlzT3BhcXVlICYmIChpc1NlZVRocm91Z2ggJiYgbmVpZ2hib3JJZCA9PSBpZCAmJiBuQmxvY2sudHJhbnNwYXJlbnRTdGFuZGFsb25lIHx8IG5laWdoYm9ySWQgIT0gaWQgJiYgKGlzU2VlVGhyb3VnaCB8fCBuQmxvY2suaXNTZWVUaHJvdWdoKSB8fCBzZWVUaHJvdWdoQ2hlY2spIHx8ICFpc1NlZVRocm91Z2ggJiYgKCFpc09wYXF1ZSB8fCAhbkJsb2NrLmlzT3BhcXVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgc3RhcnRVICwgc3RhcnRWICwgZW5kVSAsIGVuZFYgIH0gPSB1dk1hcFtmYWNlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5keCA9IE1hdGguZmxvb3IoZ2VvbWV0cnkucG9zaXRpb25zLmxlbmd0aCAvIDMpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhY2VBT3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3VyUmVkTGlnaHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZm91ckdyZWVuTGlnaHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZm91ckJsdWVMaWdodHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHsgcG9zOiBjb3JuZXJQb3MgLCB1diAgfSBvZiBjb3JuZXJzKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uY29ybmVyUG9zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyb3RhdGFibGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uLnJvdGF0ZU5vZGUocG9zLCB5Um90YXRhYmxlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb3NYID0gdnggKyBwb3NbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvc1kgPSB2eSArIHBvc1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9zWiA9IHZ6ICsgcG9zWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzY2FsZSA9IGlzT3BhcXVlID8gMC4wIDogMC4wMDAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW9tZXRyeS5wb3NpdGlvbnMucHVzaChwb3NYIC0gbWluWCAtIGRpclswXSAqIHNjYWxlLCBwb3NZIC0gbWluWSAtIGRpclsxXSAqIHNjYWxlLCBwb3NaIC0gbWluWiAtIGRpclsyXSAqIHNjYWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkudXZzLnB1c2godXZbMF0gKiAoZW5kVSAtIHN0YXJ0VSkgKyBzdGFydFUsIHV2WzFdICogKGVuZFYgLSBzdGFydFYpICsgc3RhcnRWKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZHggPSBNYXRoLnJvdW5kKHBvc1swXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGR5ID0gTWF0aC5yb3VuZChwb3NbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkeiA9IE1hdGgucm91bmQocG9zWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5pdER4ID0gZHggPT09IDAgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuaXREeSA9IGR5ID09PSAwID8gLTEgOiAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1bml0RHogPSBkeiA9PT0gMCA/IC0xIDogMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3VtU3VubGlnaHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1bVJlZExpZ2h0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdW1HcmVlbkxpZ2h0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdW1CbHVlTGlnaHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGIwMTEgPSAhZ2V0QmxvY2tBdCh2eCArIDAsIHZ5ICsgdW5pdER5LCB2eiArIHVuaXREeikuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGIxMDEgPSAhZ2V0QmxvY2tBdCh2eCArIHVuaXREeCwgdnkgKyAwLCB2eiArIHVuaXREeikuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGIxMTAgPSAhZ2V0QmxvY2tBdCh2eCArIHVuaXREeCwgdnkgKyB1bml0RHksIHZ6ICsgMCkuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGIxMTEgPSAhZ2V0QmxvY2tBdCh2eCArIHVuaXREeCwgdnkgKyB1bml0RHksIHZ6ICsgdW5pdER6KS5pc09wYXF1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYW8gPSBpc1NlZVRocm91Z2ggPyAzIDogTWF0aC5hYnMoZGlyWzBdKSA9PT0gMSA/IHZlcnRleEFPKGIxMTAsIGIxMDEsIGIxMTEpIDogTWF0aC5hYnMoZGlyWzFdKSA9PT0gMSA/IHZlcnRleEFPKGIxMTAsIGIwMTEsIGIxMTEpIDogdmVydGV4QU8oYjAxMSwgYjEwMSwgYjExMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdW5saWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlZExpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZ3JlZW5MaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGJsdWVMaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU2VlVGhyb3VnaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VubGlnaHQgPSBnZXRTdW5saWdodEF0KHZ4LCB2eSwgdnopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVkTGlnaHQgPSBnZXRUb3JjaGxpZ2h0QXQodngsIHZ5LCB2eiwgIlJFRCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JlZW5MaWdodCA9IGdldFRvcmNobGlnaHRBdCh2eCwgdnksIHZ6LCAiR1JFRU4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsdWVMaWdodCA9IGdldFRvcmNobGlnaHRBdCh2eCwgdnksIHZ6LCAiQkxVRSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCA5IG5laWdoYm9ycyBvZiB0aGlzIHZlcnRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCB4ID0gMDsgeCA8PSAxOyB4KyspewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgeSA9IDA7IHkgPD0gMTsgeSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCB6ID0gMDsgeiA8PSAxOyB6KyspewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0WCA9IHggKiB1bml0RHg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXRZID0geSAqIHVuaXREeTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldFogPSB6ICogdW5pdER6OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYWxTdW5saWdodCA9IGdldFN1bmxpZ2h0QXQodnggKyBvZmZzZXRYLCB2eSArIG9mZnNldFksIHZ6ICsgb2Zmc2V0Wik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2NhbFJlZExpZ2h0ID0gZ2V0VG9yY2hsaWdodEF0KHZ4ICsgb2Zmc2V0WCwgdnkgKyBvZmZzZXRZLCB2eiArIG9mZnNldFosICJSRUQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsR3JlZW5MaWdodCA9IGdldFRvcmNobGlnaHRBdCh2eCArIG9mZnNldFgsIHZ5ICsgb2Zmc2V0WSwgdnogKyBvZmZzZXRaLCAiR1JFRU4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsQmx1ZUxpZ2h0ID0gZ2V0VG9yY2hsaWdodEF0KHZ4ICsgb2Zmc2V0WCwgdnkgKyBvZmZzZXRZLCB2eiArIG9mZnNldFosICJCTFVFIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9jYWxTdW5saWdodCA9PSAwICYmIGxvY2FsUmVkTGlnaHQgPT0gMCAmJiBsb2NhbEdyZWVuTGlnaHQgPT0gMCAmJiBsb2NhbEJsdWVMaWdodCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWFnb25hbDQgPSBnZXRCbG9ja0F0KHZ4ICsgb2Zmc2V0WCwgdnkgKyBvZmZzZXRZLCB2eiArIG9mZnNldFopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpYWdvbmFsNC5pc09wYXF1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpclswXSAqIG9mZnNldFggKyBkaXJbMV0gKiBvZmZzZXRZICsgZGlyWzJdICogb2Zmc2V0WiA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhY2luZyA9IGdldEJsb2NrQXQodnggKyBvZmZzZXRYICogZGlyWzBdLCB2eSArIG9mZnNldFkgKiBkaXJbMV0sIHZ6ICsgb2Zmc2V0WiAqIGRpclsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZhY2luZy5pc09wYXF1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaWFnb25hbCBsaWdodCBsZWFraW5nIGZpeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKG9mZnNldFgpICsgTWF0aC5hYnMob2Zmc2V0WSkgKyBNYXRoLmFicyhvZmZzZXRaKSA9PT0gMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpYWdvbmFsWVogPSBnZXRCbG9ja0F0KHZ4LCB2eSArIG9mZnNldFksIHZ6ICsgb2Zmc2V0Wik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlhZ29uYWxYWiA9IGdldEJsb2NrQXQodnggKyBvZmZzZXRYLCB2eSwgdnogKyBvZmZzZXRaKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWFnb25hbFhZID0gZ2V0QmxvY2tBdCh2eCArIG9mZnNldFgsIHZ5ICsgb2Zmc2V0WSwgdnopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRocmVlIGNvcm5lcnMgYXJlIGJsb2NrZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlhZ29uYWxZWi5pc09wYXF1ZSAmJiBkaWFnb25hbFhaLmlzT3BhcXVlICYmIGRpYWdvbmFsWFkuaXNPcGFxdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFR3byBjb3JuZXJzIGFyZSBibG9ja2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpYWdvbmFsWFkuaXNPcGFxdWUgJiYgZGlhZ29uYWxYWi5pc09wYXF1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvclkgPSBnZXRCbG9ja0F0KHZ4LCB2eSArIG9mZnNldFksIHZ6KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmVpZ2hib3JaID0gZ2V0QmxvY2tBdCh2eCwgdnksIHZ6ICsgb2Zmc2V0Wik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZWlnaGJvclkuaXNPcGFxdWUgJiYgbmVpZ2hib3JaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlhZ29uYWxYWS5pc09wYXF1ZSAmJiBkaWFnb25hbFlaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWCA9IGdldEJsb2NrQXQodnggKyBvZmZzZXRYLCB2eSwgdnopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvclogPSBnZXRCbG9ja0F0KHZ4LCB2eSwgdnogKyBvZmZzZXRaKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5laWdoYm9yWC5pc09wYXF1ZSAmJiBuZWlnaGJvclouaXNPcGFxdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaWFnb25hbFhaLmlzT3BhcXVlICYmIGRpYWdvbmFsWVouaXNPcGFxdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmVpZ2hib3JYID0gZ2V0QmxvY2tBdCh2eCArIG9mZnNldFgsIHZ5LCB2eik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWSA9IGdldEJsb2NrQXQodngsIHZ5ICsgb2Zmc2V0WSwgdnopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmVpZ2hib3JYLmlzT3BhcXVlICYmIG5laWdoYm9yWS5pc09wYXF1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdW1TdW5saWdodHMucHVzaChsb2NhbFN1bmxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1bVJlZExpZ2h0cy5wdXNoKGxvY2FsUmVkTGlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VtR3JlZW5MaWdodHMucHVzaChsb2NhbEdyZWVuTGlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VtQmx1ZUxpZ2h0cy5wdXNoKGxvY2FsQmx1ZUxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1bmxpZ2h0ID0gc3VtU3VubGlnaHRzLnJlZHVjZSgoYSwgYik9PmEgKyBiLCAwKSAvIHN1bVN1bmxpZ2h0cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWRMaWdodCA9IHN1bVJlZExpZ2h0cy5yZWR1Y2UoKGEsIGIpPT5hICsgYiwgMCkgLyBzdW1SZWRMaWdodHMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JlZW5MaWdodCA9IHN1bUdyZWVuTGlnaHRzLnJlZHVjZSgoYSwgYik9PmEgKyBiLCAwKSAvIHN1bUdyZWVuTGlnaHRzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsdWVMaWdodCA9IHN1bUJsdWVMaWdodHMucmVkdWNlKChhLCBiKT0+YSArIGIsIDApIC8gc3VtQmx1ZUxpZ2h0cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxpZ2h0ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQgPSBMaWdodFV0aWxzLmluc2VydFJlZExpZ2h0KGxpZ2h0LCByZWRMaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0ID0gTGlnaHRVdGlscy5pbnNlcnRHcmVlbkxpZ2h0KGxpZ2h0LCBncmVlbkxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQgPSBMaWdodFV0aWxzLmluc2VydEJsdWVMaWdodChsaWdodCwgYmx1ZUxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQgPSBMaWdodFV0aWxzLmluc2VydFN1bmxpZ2h0KGxpZ2h0LCBzdW5saWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJ5LmxpZ2h0cy5wdXNoKE1hdGguZmxvb3IobGlnaHQpIHwgYW8gPDwgMTYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VyUmVkTGlnaHRzLnB1c2gocmVkTGlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VyR3JlZW5MaWdodHMucHVzaChncmVlbkxpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91ckJsdWVMaWdodHMucHVzaChibHVlTGlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNlQU9zLnB1c2goYW8pOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhUnQgPSBmb3VyUmVkTGlnaHRzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJSdCA9IGZvdXJSZWRMaWdodHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY1J0ID0gZm91clJlZExpZ2h0c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkUnQgPSBmb3VyUmVkTGlnaHRzWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFHdCA9IGZvdXJHcmVlbkxpZ2h0c1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiR3QgPSBmb3VyR3JlZW5MaWdodHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY0d0ID0gZm91ckdyZWVuTGlnaHRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRHdCA9IGZvdXJHcmVlbkxpZ2h0c1szXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhQnQgPSBmb3VyQmx1ZUxpZ2h0c1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiQnQgPSBmb3VyQmx1ZUxpZ2h0c1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjQnQgPSBmb3VyQmx1ZUxpZ2h0c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkQnQgPSBmb3VyQmx1ZUxpZ2h0c1szXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJlc2hvbGQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovIC8qICAgICAgICAgICAgICAgICAgICAgSSBLTk9XIFRISVMgSVMgVUdMWSwgQlVUIElUIFdPUktTISAgICAgICAgICAgICAgICAgICAgICovIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovIC8vIGF0IGxlYXN0IG9uZSB6ZXJvCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb25lVHIwID0gYVJ0IDw9IHRocmVzaG9sZCB8fCBiUnQgPD0gdGhyZXNob2xkIHx8IGNSdCA8PSB0aHJlc2hvbGQgfHwgZFJ0IDw9IHRocmVzaG9sZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvbmVUZzAgPSBhR3QgPD0gdGhyZXNob2xkIHx8IGJHdCA8PSB0aHJlc2hvbGQgfHwgY0d0IDw9IHRocmVzaG9sZCB8fCBkR3QgPD0gdGhyZXNob2xkOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9uZVRiMCA9IGFCdCA8PSB0aHJlc2hvbGQgfHwgYkJ0IDw9IHRocmVzaG9sZCB8fCBjQnQgPD0gdGhyZXNob2xkIHx8IGRCdCA8PSB0aHJlc2hvbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25lIGlzIHplcm8sIGFuZCBhbyBydWxlLCBidXQgb25seSBmb3IgemVybyBBTydzCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZkVxdWFscyA9IGZhY2VBT3NbMF0gKyBmYWNlQU9zWzNdID09IGZhY2VBT3NbMV0gKyBmYWNlQU9zWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG96YW9SID0gYVJ0ICsgZFJ0IDwgYlJ0ICsgY1J0ICYmIGZFcXVhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3phb0cgPSBhR3QgKyBkR3QgPCBiR3QgKyBjR3QgJiYgZkVxdWFsczsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvemFvQiA9IGFCdCArIGRCdCA8IGJCdCArIGNCdCAmJiBmRXF1YWxzOwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFsbCBub3QgemVybywgNCBwYXJ0cwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuenAxUiA9IGJSdCA+IChhUnQgKyBkUnQpIC8gMi4wICYmIChhUnQgKyBkUnQpIC8gMi4wID4gY1J0IHx8IGNSdCA+IChhUnQgKyBkUnQpIC8gMi4wICYmIChhUnQgKyBkUnQpIC8gMi4wID4gYlJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuenAxRyA9IGJHdCA+IChhR3QgKyBkR3QpIC8gMi4wICYmIChhR3QgKyBkR3QpIC8gMi4wID4gY0d0IHx8IGNHdCA+IChhR3QgKyBkR3QpIC8gMi4wICYmIChhR3QgKyBkR3QpIC8gMi4wID4gYkd0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuenAxQiA9IGJCdCA+IChhQnQgKyBkQnQpIC8gMi4wICYmIChhQnQgKyBkQnQpIC8gMi4wID4gY0J0IHx8IGNCdCA+IChhQnQgKyBkQnQpIC8gMi4wICYmIChhQnQgKyBkQnQpIC8gMi4wID4gYkJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpeGVkIHR3byBsaWdodCBzb3VyY2VzIGNvbGxpZGluZwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuelIgPSBvbmVUcjAgJiYgYW56cDFSOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuekcgPSBvbmVUZzAgJiYgYW56cDFHOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuekIgPSBvbmVUYjAgJiYgYW56cDFCOwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbW1vbiBzdGFydGluZyBpbmRpY2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmYWNlQU9zWzBdICsgZmFjZUFPc1szXSA+IGZhY2VBT3NbMV0gKyBmYWNlQU9zWzJdIHx8IG96YW9SIHx8IG96YW9HIHx8IG96YW9CIHx8IGFuelIgfHwgYW56RyB8fCBhbnpCKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlIGZsaXBwZWQgdHJpYW5nbGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzLnB1c2gobmR4ICsgMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlIG5vcm1hbCB0cmlhbmdsZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzLnB1c2gobmR4ICsgMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDMpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2VydCBpbnRvIHRoZSBtYXAKICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXNba2V5XSA9IGdlb21ldHJ5OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGFycmF5QnVmZmVycyA9IFtdOwogICAgICBjb25zdCBnZW9tZXRyaWVzUGFja2VkID0gT2JqZWN0LnZhbHVlcyhnZW9tZXRyaWVzKS5tYXAoKGdlb21ldHJ5KT0+ewogICAgICAgICAgY29uc3QgcGFja2VkR2VvbWV0cnkgPSB7CiAgICAgICAgICAgICAgaW5kaWNlczogbmV3IFVpbnQxNkFycmF5KGdlb21ldHJ5LmluZGljZXMpLAogICAgICAgICAgICAgIGxpZ2h0czogbmV3IFVpbnQzMkFycmF5KGdlb21ldHJ5LmxpZ2h0cyksCiAgICAgICAgICAgICAgcG9zaXRpb25zOiBuZXcgRmxvYXQzMkFycmF5KGdlb21ldHJ5LnBvc2l0aW9ucyksCiAgICAgICAgICAgICAgdXZzOiBuZXcgRmxvYXQzMkFycmF5KGdlb21ldHJ5LnV2cyksCiAgICAgICAgICAgICAgdm94ZWw6IGdlb21ldHJ5LnZveGVsLAogICAgICAgICAgICAgIGZhY2VOYW1lOiBnZW9tZXRyeS5mYWNlTmFtZQogICAgICAgICAgfTsKICAgICAgICAgIGFycmF5QnVmZmVycy5wdXNoKHBhY2tlZEdlb21ldHJ5LmluZGljZXMuYnVmZmVyKTsKICAgICAgICAgIGFycmF5QnVmZmVycy5wdXNoKHBhY2tlZEdlb21ldHJ5LmxpZ2h0cy5idWZmZXIpOwogICAgICAgICAgYXJyYXlCdWZmZXJzLnB1c2gocGFja2VkR2VvbWV0cnkucG9zaXRpb25zLmJ1ZmZlcik7CiAgICAgICAgICBhcnJheUJ1ZmZlcnMucHVzaChwYWNrZWRHZW9tZXRyeS51dnMuYnVmZmVyKTsKICAgICAgICAgIHJldHVybiBwYWNrZWRHZW9tZXRyeTsKICAgICAgfSkuZmlsdGVyKChnZW9tZXRyeSk9Pmdlb21ldHJ5LnBvc2l0aW9ucy5sZW5ndGggPiAwKTsKICAgICAgLy8gQHRzLWlnbm9yZQogICAgICBwb3N0TWVzc2FnZSh7CiAgICAgICAgICBnZW9tZXRyaWVzOiBnZW9tZXRyaWVzUGFja2VkCiAgICAgIH0sIGFycmF5QnVmZmVycyk7CiAgfTsKCn0pKCk7Cgo=",null,!1),WorkerFactory$1=createBase64WorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLy8gQHRzLWlnbm9yZQogIG9ubWVzc2FnZSA9IChlKT0+ewogICAgICBjb25zdCB7IGRhdGE6IHsgaW50ZXJ2YWwgLCBzaWduYWwgIH0gIH0gPSBlOwogICAgICBsZXQgaWQ7CiAgICAgIGlmIChzaWduYWwgPT09ICJzdGFydCIpIHsKICAgICAgICAgIGlkID0gc2V0SW50ZXJ2YWwoKCk9PnsKICAgICAgICAgICAgICBwb3N0TWVzc2FnZSgidGljayIpOwogICAgICAgICAgfSwgaW50ZXJ2YWwpOwogICAgICB9IGVsc2UgaWYgKHNpZ25hbCA9PT0gInN0b3AiKSB7CiAgICAgICAgICBjbGVhckludGVydmFsKGlkKTsKICAgICAgfQogIH07Cgp9KSgpOwoK",null,!1);function setWorkerInterval(g,I){const C=new WorkerFactory$1;return console.log(C),C.postMessage({signal:"start",interval:I}),C.onmessage=I=>{"tick"===I.data&&g()},()=>{C.postMessage({signal:"stop"})}}function _defineProperty$b(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class RawChunk{serialize(){return[{id:this.id,x:this.coords[0],z:this.coords[1],voxels:this.voxels.data.buffer,lights:this.lights.data.buffer,options:this.options},[this.voxels.data.buffer.slice(0),this.lights.data.buffer.slice(0)]]}static deserialize(g){const{id:I,x:C,z:A,voxels:t,lights:e,options:o}=g,i=new RawChunk(I,[C,A],o);return e&&e.byteLength&&(i.lights.data=new Uint32Array(e)),t&&t.byteLength&&(i.voxels.data=new Uint32Array(t)),i}setData(g){const{id:I,x:C,z:A}=g;if(this.id!==I)throw new Error("Chunk id mismatch");if(this.coords[0]!==C||this.coords[1]!==A)throw new Error("Chunk coords mismatch");const{voxels:t,lights:e}=g;e&&e.byteLength&&(this.lights.data=new Uint32Array(e)),t&&t.byteLength&&(this.voxels.data=new Uint32Array(t))}getRawValue(g,I,C){if(!this.contains(g,I,C))return 0;const[A,t,e]=this.toLocal(g,I,C);return this.voxels.get(A,t,e)}setRawValue(g,I,C,A){if(!this.contains(g,I,C))return 0;const[t,e,o]=this.toLocal(g,I,C);return this.voxels.set(t,e,o,A)}getRawLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,t,e]=this.toLocal(g,I,C);return this.lights.get(A,t,e)}setRawLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[t,e,o]=this.toLocal(g,I,C);return this.lights.set(t,e,o,A)}getVoxel(g,I,C){return BlockUtils.extractID(this.getRawValue(0|g,0|I,0|C))}setVoxel(g,I,C,A){const t=BlockUtils.insertID(0,A);return this.setRawValue(g,I,C,t),A}getVoxelRotation(g,I,C){return this.contains(g,I,C)?BlockUtils.extractRotation(this.getRawValue(g,I,C)):new BlockRotation}setVoxelRotation(g,I,C,A){const t=BlockUtils.insertRotation(this.getRawValue(g,I,C),A);this.setRawValue(g,I,C,t)}getVoxelStage(g,I,C){return this.contains(g,I,C)?BlockUtils.extractStage(this.getRawValue(g,I,C)):0}setVoxelStage(g,I,C,A){const t=BlockUtils.insertStage(this.getRawValue(g,I,C),A);return this.setRawValue(g,I,C,t),A}getRedLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,t,e]=this.toLocal(g,I,C);return this.getLocalRedLight(A,t,e)}setRedLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[t,e,o]=this.toLocal(g,I,C);return this.setLocalRedLight(t,e,o,A)}getGreenLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,t,e]=this.toLocal(g,I,C);return this.getLocalGreenLight(A,t,e)}setGreenLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[t,e,o]=this.toLocal(g,I,C);return this.setLocalGreenLight(t,e,o,A)}getBlueLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,t,e]=this.toLocal(g,I,C);return this.getLocalBlueLight(A,t,e)}setBlueLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[t,e,o]=this.toLocal(g,I,C);return this.setLocalBlueLight(t,e,o,A)}getTorchLight(g,I,C,A){switch(A){case"RED":return this.getRedLight(g,I,C);case"GREEN":return this.getGreenLight(g,I,C);case"BLUE":return this.getBlueLight(g,I,C);default:throw new Error("Received unknown light color...")}}setTorchLight(g,I,C,A,t){switch(t){case"RED":return this.setRedLight(g,I,C,A);case"GREEN":return this.setGreenLight(g,I,C,A);case"BLUE":return this.setBlueLight(g,I,C,A);default:throw new Error("Received unknown light color...")}}getSunlight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,t,e]=this.toLocal(g,I,C);return this.getLocalSunlight(A,t,e)}setSunlight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[t,e,o]=this.toLocal(g,I,C);return this.setLocalSunlight(t,e,o,A)}get isReady(){return 0!==this.lights.data.length&&0!==this.voxels.data.length}getLocalRedLight(g,I,C){return LightUtils.extractRedLight(this.lights.get(g,I,C))}setLocalRedLight(g,I,C,A){return this.lights.set(g,I,C,LightUtils.insertRedLight(this.lights.get(g,I,C),A))}getLocalGreenLight(g,I,C){return LightUtils.extractGreenLight(this.lights.get(g,I,C))}setLocalGreenLight(g,I,C,A){return this.lights.set(g,I,C,LightUtils.insertGreenLight(this.lights.get(g,I,C),A))}getLocalBlueLight(g,I,C){return LightUtils.extractBlueLight(this.lights.get(g,I,C))}setLocalBlueLight(g,I,C,A){return this.lights.set(g,I,C,LightUtils.insertBlueLight(this.lights.get(g,I,C),A))}getLocalSunlight(g,I,C){return LightUtils.extractSunlight(this.lights.get(g,I,C))}setLocalSunlight(g,I,C,A){return this.lights.set(g,I,C,LightUtils.insertSunlight(this.lights.get(g,I,C),A))}toLocal(g,I,C){const[A,t,e]=this.min;return[(0|g)-A,(0|I)-t,(0|C)-e]}contains(g,I,C){const{size:A,maxHeight:t}=this.options,[e,o,i]=this.toLocal(g,I,C);return e<A&&o>=0&&o<t&&i>=0&&i<A}constructor(g,I,C){_defineProperty$b(this,"options",void 0),_defineProperty$b(this,"id",void 0),_defineProperty$b(this,"name",void 0),_defineProperty$b(this,"coords",void 0),_defineProperty$b(this,"min",void 0),_defineProperty$b(this,"max",void 0),_defineProperty$b(this,"voxels",void 0),_defineProperty$b(this,"lights",void 0),this.id=g,this.name=ChunkUtils.getChunkName(I),this.coords=I,this.options=C;const{size:A,maxHeight:t}=C;this.voxels=ndarray([],[A,t,A]),this.lights=ndarray([],[A,t,A]);const[e,o]=I;this.min=[e*A,0,o*A],this.max=[(e+1)*A,t,(o+1)*A]}}function _defineProperty$a(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Chunk extends RawChunk{setData(g){const{id:I,x:C,z:A}=g;if(this.id!==I)throw new Error("Chunk id mismatch");if(this.coords[0]!==C||this.coords[1]!==A)throw new Error("Chunk coords mismatch");const{voxels:t,lights:e}=g;e&&e.byteLength&&(this.lights.data=new Uint32Array(e)),t&&t.byteLength&&(this.voxels.data=new Uint32Array(t))}dispose(){this.meshes.forEach((g=>{g.forEach((g=>{var I;g&&(null===(I=g.geometry)||void 0===I||I.dispose(),g.parent&&g.parent.remove(g))}))})),this.lights.data=new Uint32Array,this.voxels.data=new Uint32Array}constructor(g,I,C){super(g,I,C),_defineProperty$a(this,"meshes",new Map),_defineProperty$a(this,"added",!1),_defineProperty$a(this,"isDirty",!1)}}function _defineProperty$9(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Chunks{constructor(){_defineProperty$9(this,"materials",new Map),_defineProperty$9(this,"uniforms",{fogColor:{value:new three__WEBPACK_IMPORTED_MODULE_0__.Ilk("#B1CCFD")},fogNear:{value:100},fogFar:{value:200},ao:{value:new three__WEBPACK_IMPORTED_MODULE_0__.Ltg(100,170,210,255)},minLightLevel:{value:0},sunlightIntensity:{value:1},time:{value:performance.now()}}),_defineProperty$9(this,"requested",new Map),_defineProperty$9(this,"toRequest",[]),_defineProperty$9(this,"loaded",new Map),_defineProperty$9(this,"toProcess",[]),_defineProperty$9(this,"toUpdate",[]),_defineProperty$9(this,"toEmit",[])}}var omggif={},GifReader_1,GifWriter_1;function GifWriter(g,I,C,A){var t=0,e=void 0===(A=void 0===A?{}:A).loop?null:A.loop,o=void 0===A.palette?null:A.palette;if(I<=0||C<=0||I>65535||C>65535)throw new Error("Width/Height invalid.");function i(g){var I=g.length;if(I<2||I>256||I&I-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return I}g[t++]=71,g[t++]=73,g[t++]=70,g[t++]=56,g[t++]=57,g[t++]=97;var l=0,c=0;if(null!==o){for(var n=i(o);n>>=1;)++l;if(n=1<<l,--l,void 0!==A.background){if((c=A.background)>=n)throw new Error("Background index out of range.");if(0===c)throw new Error("Background index explicitly passed as 0.")}}if(g[t++]=255&I,g[t++]=I>>8&255,g[t++]=255&C,g[t++]=C>>8&255,g[t++]=(null!==o?128:0)|l,g[t++]=c,g[t++]=0,null!==o)for(var d=0,s=o.length;d<s;++d){var Z=o[d];g[t++]=Z>>16&255,g[t++]=Z>>8&255,g[t++]=255&Z}if(null!==e){if(e<0||e>65535)throw new Error("Loop count invalid.");g[t++]=33,g[t++]=255,g[t++]=11,g[t++]=78,g[t++]=69,g[t++]=84,g[t++]=83,g[t++]=67,g[t++]=65,g[t++]=80,g[t++]=69,g[t++]=50,g[t++]=46,g[t++]=48,g[t++]=3,g[t++]=1,g[t++]=255&e,g[t++]=e>>8&255,g[t++]=0}var b=!1;this.addFrame=function(I,C,A,e,l,c){if(!0===b&&(--t,b=!1),c=void 0===c?{}:c,I<0||C<0||I>65535||C>65535)throw new Error("x/y invalid.");if(A<=0||e<=0||A>65535||e>65535)throw new Error("Width/Height invalid.");if(l.length<A*e)throw new Error("Not enough pixels for the frame size.");var n=!0,d=c.palette;if(null==d&&(n=!1,d=o),null==d)throw new Error("Must supply either a local or global palette.");for(var s=i(d),Z=0;s>>=1;)++Z;s=1<<Z;var a=void 0===c.delay?0:c.delay,m=void 0===c.disposal?0:c.disposal;if(m<0||m>3)throw new Error("Disposal out of range.");var r=!1,h=0;if(void 0!==c.transparent&&null!==c.transparent&&(r=!0,(h=c.transparent)<0||h>=s))throw new Error("Transparent color index.");if((0!==m||r||0!==a)&&(g[t++]=33,g[t++]=249,g[t++]=4,g[t++]=m<<2|(!0===r?1:0),g[t++]=255&a,g[t++]=a>>8&255,g[t++]=h,g[t++]=0),g[t++]=44,g[t++]=255&I,g[t++]=I>>8&255,g[t++]=255&C,g[t++]=C>>8&255,g[t++]=255&A,g[t++]=A>>8&255,g[t++]=255&e,g[t++]=e>>8&255,g[t++]=!0===n?128|Z-1:0,!0===n)for(var B=0,G=d.length;B<G;++B){var W=d[B];g[t++]=W>>16&255,g[t++]=W>>8&255,g[t++]=255&W}return t=GifWriterOutputLZWCodeStream(g,t,Z<2?2:Z,l)},this.end=function(){return!1===b&&(g[t++]=59,b=!0),t},this.getOutputBuffer=function(){return g},this.setOutputBuffer=function(I){g=I},this.getOutputBufferPosition=function(){return t},this.setOutputBufferPosition=function(g){t=g}}function GifWriterOutputLZWCodeStream(g,I,C,A){g[I++]=C;var t=I++,e=1<<C,o=e-1,i=e+1,l=i+1,c=C+1,n=0,d=0;function s(C){for(;n>=C;)g[I++]=255&d,d>>=8,n-=8,I===t+256&&(g[t]=255,t=I++)}function Z(g){d|=g<<n,n+=c,s(8)}var b=A[0]&o,a={};Z(e);for(var m=1,r=A.length;m<r;++m){var h=A[m]&o,B=b<<8|h,G=a[B];if(void 0===G){for(d|=b<<n,n+=c;n>=8;)g[I++]=255&d,d>>=8,n-=8,I===t+256&&(g[t]=255,t=I++);4096===l?(Z(e),l=i+1,c=C+1,a={}):(l>=1<<c&&++c,a[B]=l++),b=h}else b=G}return Z(b),Z(i),s(1),t+1===I?g[t]=0:(g[t]=I-t-1,g[I++]=0),I}function GifReader(g){var I=0;if(71!==g[I++]||73!==g[I++]||70!==g[I++]||56!==g[I++]||56!=(g[I++]+1&253)||97!==g[I++])throw new Error("Invalid GIF 87a/89a header.");var C=g[I++]|g[I++]<<8,A=g[I++]|g[I++]<<8,t=g[I++],e=t>>7,o=1<<(7&t)+1;g[I++],g[I++];var i=null,l=null;e&&(i=I,l=o,I+=3*o);var c=!0,n=[],d=0,s=null,Z=0,b=null;for(this.width=C,this.height=A;c&&I<g.length;)switch(g[I++]){case 33:switch(g[I++]){case 255:if(11!==g[I]||78==g[I+1]&&69==g[I+2]&&84==g[I+3]&&83==g[I+4]&&67==g[I+5]&&65==g[I+6]&&80==g[I+7]&&69==g[I+8]&&50==g[I+9]&&46==g[I+10]&&48==g[I+11]&&3==g[I+12]&&1==g[I+13]&&0==g[I+16])I+=14,b=g[I++]|g[I++]<<8,I++;else for(I+=12;;){if(!((Y=g[I++])>=0))throw Error("Invalid block size");if(0===Y)break;I+=Y}break;case 249:if(4!==g[I++]||0!==g[I+4])throw new Error("Invalid graphics extension block.");var a=g[I++];d=g[I++]|g[I++]<<8,s=g[I++],0==(1&a)&&(s=null),Z=a>>2&7,I++;break;case 254:for(;;){if(!((Y=g[I++])>=0))throw Error("Invalid block size");if(0===Y)break;I+=Y}break;default:throw new Error("Unknown graphic control label: 0x"+g[I-1].toString(16))}break;case 44:var m=g[I++]|g[I++]<<8,r=g[I++]|g[I++]<<8,h=g[I++]|g[I++]<<8,B=g[I++]|g[I++]<<8,G=g[I++],W=G>>6&1,u=1<<(7&G)+1,y=i,p=l,V=!1;if(G>>7){V=!0;y=I,p=u,I+=3*u}var S=I;for(I++;;){var Y;if(!((Y=g[I++])>=0))throw Error("Invalid block size");if(0===Y)break;I+=Y}n.push({x:m,y:r,width:h,height:B,has_local_palette:V,palette_offset:y,palette_size:p,data_offset:S,data_length:I-S,transparent_index:s,interlaced:!!W,delay:d,disposal:Z});break;case 59:c=!1;break;default:throw new Error("Unknown gif block: 0x"+g[I-1].toString(16))}this.numFrames=function(){return n.length},this.loopCount=function(){return b},this.frameInfo=function(g){if(g<0||g>=n.length)throw new Error("Frame index out of range.");return n[g]},this.decodeAndBlitFrameBGRA=function(I,A){var t=this.frameInfo(I),e=t.width*t.height,o=new Uint8Array(e);GifReaderLZWOutputIndexStream(g,t.data_offset,o,e);var i=t.palette_offset,l=t.transparent_index;null===l&&(l=256);var c=t.width,n=C-c,d=c,s=4*(t.y*C+t.x),Z=4*((t.y+t.height)*C+t.x),b=s,a=4*n;!0===t.interlaced&&(a+=4*C*7);for(var m=8,r=0,h=o.length;r<h;++r){var B=o[r];if(0===d&&(d=c,(b+=a)>=Z&&(a=4*n+4*C*(m-1),b=s+(c+n)*(m<<1),m>>=1)),B===l)b+=4;else{var G=g[i+3*B],W=g[i+3*B+1],u=g[i+3*B+2];A[b++]=u,A[b++]=W,A[b++]=G,A[b++]=255}--d}},this.decodeAndBlitFrameRGBA=function(I,A){var t=this.frameInfo(I),e=t.width*t.height,o=new Uint8Array(e);GifReaderLZWOutputIndexStream(g,t.data_offset,o,e);var i=t.palette_offset,l=t.transparent_index;null===l&&(l=256);var c=t.width,n=C-c,d=c,s=4*(t.y*C+t.x),Z=4*((t.y+t.height)*C+t.x),b=s,a=4*n;!0===t.interlaced&&(a+=4*C*7);for(var m=8,r=0,h=o.length;r<h;++r){var B=o[r];if(0===d&&(d=c,(b+=a)>=Z&&(a=4*n+4*C*(m-1),b=s+(c+n)*(m<<1),m>>=1)),B===l)b+=4;else{var G=g[i+3*B],W=g[i+3*B+1],u=g[i+3*B+2];A[b++]=G,A[b++]=W,A[b++]=u,A[b++]=255}--d}}}function GifReaderLZWOutputIndexStream(g,I,C,A){for(var t=g[I++],e=1<<t,o=e+1,i=o+1,l=t+1,c=(1<<l)-1,n=0,d=0,s=0,Z=g[I++],b=new Int32Array(4096),a=null;;){for(;n<16&&0!==Z;)d|=g[I++]<<n,n+=8,1===Z?Z=g[I++]:--Z;if(n<l)break;var m=d&c;if(d>>=l,n-=l,m!==e){if(m===o)break;for(var r=m<i?m:a,h=0,B=r;B>e;)B=b[B]>>8,++h;var G=B;if(s+h+(r!==m?1:0)>A)return void console.log("Warning, gif stream longer than expected.");C[s++]=G;var W=s+=h;for(r!==m&&(C[s++]=G),B=r;h--;)B=b[B],C[--W]=255&B,B>>=8;null!==a&&i<4096&&(b[i++]=a<<8|G,i>=c+1&&l<12&&(++l,c=c<<1|1)),a=m}else i=o+1,c=(1<<(l=t+1))-1,a=null}return s!==A&&console.log("Warning, gif stream shorter than expected."),C}try{GifWriter_1=omggif.GifWriter=GifWriter,GifReader_1=omggif.GifReader=GifReader}catch(e){}function _defineProperty$8(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Loader{constructor(){_defineProperty$8(this,"textures",new Map),_defineProperty$8(this,"images",new Map),_defineProperty$8(this,"audioBuffers",new Map),_defineProperty$8(this,"progress",0),_defineProperty$8(this,"manager",new three__WEBPACK_IMPORTED_MODULE_0__.lLk),_defineProperty$8(this,"textureLoader",new three__WEBPACK_IMPORTED_MODULE_0__.dpR(this.manager)),_defineProperty$8(this,"audioLoader",new three__WEBPACK_IMPORTED_MODULE_0__.mTL(this.manager)),_defineProperty$8(this,"assetPromises",new Map),_defineProperty$8(this,"audioCallbacks",new Map),_defineProperty$8(this,"loadGifImages",((g,I)=>{const C=new Promise((C=>{(async()=>{const A=await fetch(g),t=await A.blob(),e=await t.arrayBuffer(),o=new Uint8Array(e),i=new GifReader_1(o),l=i.frameInfo(0),c=new Array(i.numFrames()).fill(0).map(((g,I)=>{const C=new ImageData(l.width,l.height);i.decodeAndBlitFrameRGBA(I,C.data);const A=document.createElement("canvas"),t=A.getContext("2d");A.width=C.width,A.height=C.height,t.putImageData(C,0,0);const e=new Image;return e.src=A.toDataURL(),e}));this.images.set(g,c),this.assetPromises.delete(g),null==I||I(c),C(c)})()}));return this.assetPromises.set(g,C),C})),_defineProperty$8(this,"loadTexture",((g,I)=>{const C=new Promise((C=>{this.textureLoader.load(g,(A=>{this.textures.set(g,A),this.assetPromises.delete(g),null==I||I(A),C(A)}))}));return this.assetPromises.set(g,C),C})),_defineProperty$8(this,"loadImage",((g,I)=>{const C=new Promise((C=>{const A=new Image;A.crossOrigin="anonymous",A.src=g,A.onload=()=>{this.assetPromises.delete(g),null==I||I(A),C(A)}}));return this.assetPromises.set(g,C),C})),_defineProperty$8(this,"getTexture",(g=>{const I=this.textures.get(g);if(Array.isArray(I))throw new Error("`getTexture` was called on a gif texture. Use `getGifTexture` instead.");return I})),_defineProperty$8(this,"getGifTexture",(g=>{const I=this.textures.get(g);if(!Array.isArray(I))throw new Error("`getGifTexture` was called on a non-gif texture. Use `getTexture` instead.");return I})),_defineProperty$8(this,"loadAudioBuffer",((g,I)=>new Promise((C=>{this.audioCallbacks.set(g,(async()=>new Promise((A=>{this.audioLoader.load(g,(g=>{null==I||I(g),A(g),C(g)}))}))))})))),_defineProperty$8(this,"load",(async()=>{await Promise.all(Array.from(this.assetPromises.values())),this.assetPromises.clear()})),_defineProperty$8(this,"loadAudios",(async()=>{for(const[g,I]of this.audioCallbacks){const C=await I();this.audioBuffers.set(g,C)}this.audioCallbacks.clear()})),this.manager.onProgress=(g,I,C)=>{this.progress=I/C};const g=()=>{this.loadAudios(),window.removeEventListener("click",g)};window.addEventListener("click",g)}}function _defineProperty$7(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Registry{serialize(){return JSON.parse(JSON.stringify({blocksByName:Array.from(this.blocksByName.entries()),blocksById:Array.from(this.blocksById.entries()),nameMap:Array.from(this.nameMap.entries()),idMap:Array.from(this.idMap.entries())}))}static deserialize(g){const I=new Registry;return I.blocksByName=new Map(g.blocksByName),I.blocksById=new Map(g.blocksById),I.nameMap=new Map(g.nameMap),I.idMap=new Map(g.idMap),I}constructor(){_defineProperty$7(this,"blocksByName",new Map),_defineProperty$7(this,"blocksById",new Map),_defineProperty$7(this,"nameMap",new Map),_defineProperty$7(this,"idMap",new Map)}}function _defineProperty$6(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$2(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$6(g,I,C[I])}))}return g}const DEFAULT_CHUNK_SHADERS={vertex:three__WEBPACK_IMPORTED_MODULE_0__.Vj0.basic.vertexShader.replace("#include <common>","\nattribute int light;\n\nvarying float vAO;\nvarying vec4 vLight;\nvarying vec4 vWorldPosition;\nuniform vec4 uAOTable;\nuniform float uTime;\n\nvec4 unpackLight(int l) {\n  float r = float((l >> 8) & 0xF) / 15.0;\n  float g = float((l >> 4) & 0xF) / 15.0;\n  float b = float(l & 0xF) / 15.0;\n  float s = float((l >> 12) & 0xF) / 15.0;\n  return vec4(r, g, b, s);\n}\n\n#include <common>\n").replace("#include <color_vertex>","\n#include <color_vertex>\n\nint ao = light >> 16;\n\nvAO = ((ao == 0) ? uAOTable.x :\n    (ao == 1) ? uAOTable.y :\n    (ao == 2) ? uAOTable.z : uAOTable.w) / 255.0; \n\nvLight = unpackLight(light & ((1 << 16) - 1));\n").replace("#include <worldpos_vertex>","\nvec4 worldPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n  worldPosition = instanceMatrix * worldPosition;\n#endif\nworldPosition = modelMatrix * worldPosition;\nvWorldPosition = worldPosition;\n"),fragment:three__WEBPACK_IMPORTED_MODULE_0__.Vj0.basic.fragmentShader.replace("#include <common>","\nuniform vec3 uFogColor;\nuniform float uFogNear;\nuniform float uFogFar;\nuniform float uSunlightIntensity;\nuniform float uMinLightLevel;\nuniform float uTime;\nvarying float vAO;\nvarying vec4 vLight; \nvarying vec4 vWorldPosition;\n\n#include <common>\n").replace("#include <envmap_fragment>","\n#include <envmap_fragment>\n\n// Intensity of light is wavelength ** 2 \nfloat s = min(vLight.a * vLight.a * uSunlightIntensity * (1.0 - uMinLightLevel) + uMinLightLevel, 1.0);\ns = s * (1.0 - exp(-s) * 0.02); // Smooth the intensity without clamping to a hard upper limit\nfloat scale = 2.0;\n\noutgoingLight.rgb *= vec3(s + pow(vLight.r, scale), s + pow(vLight.g, scale), s + pow(vLight.b, scale));\noutgoingLight *= vAO;\n").replace("#include <fog_fragment>","\n    vec3 fogOrigin = cameraPosition;\n\n    float depth = sqrt(pow(vWorldPosition.x - fogOrigin.x, 2.0) + pow(vWorldPosition.z - fogOrigin.z, 2.0));\n    float fogFactor = smoothstep(uFogNear, uFogFar, depth);\n\n    gl_FragColor.rgb = mix(gl_FragColor.rgb, uFogColor, fogFactor);\n    ")},customShaders={sway(g){void 0===g&&(g={});const{speed:I,amplitude:C,rooted:A,scale:t,yScale:e}=_objectSpread$2({speed:1,amplitude:.1,rooted:!1,scale:1,yScale:1},g);return{vertexShader:DEFAULT_CHUNK_SHADERS.vertex.replace("#include <common>","\n//\tSimplex 3D Noise \n//\tby Ian McEwan, Ashima Arts\n//\nvec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n\nfloat snoise(vec3 v){ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //  x0 = x0 - 0. + 0.0 * C \n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n// Permutations\n  i = mod(i, 289.0 ); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), \n                                dot(p2,x2), dot(p3,x3) ) );\n}\n").replace("#include <begin_vertex>",`\nvec3 transformed = vec3(position);\nfloat scale = uTime * 0.00002 * ${I.toFixed(2)};\ntransformed.x = position.x \n             + ${A?"(position.y - floor(position.y))":"1.0"} * ${t.toFixed(2)} * snoise(vec3(position.x * scale, position.y * scale * ${e.toFixed(2)}, position.z * scale)) * 2.0 * ${C.toFixed(2)};\n`),fragmentShader:DEFAULT_CHUNK_SHADERS.fragment}}};function _defineProperty$5(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class AtlasTexture extends three__WEBPACK_IMPORTED_MODULE_0__.ROQ{drawImageToRange(g,I,C,A){void 0===C&&(C=!0),void 0===A&&(A=1);const{startU:t,endV:e}=g,o=I instanceof three__WEBPACK_IMPORTED_MODULE_0__.xEZ?I.image:I;if(!o)return;const i=this.canvas.getContext("2d");i.save();const l=this.canvas.width,c=this.canvas.height;if(i.globalAlpha=A,1!==A&&(i.globalCompositeOperation="lighter"),C&&i.clearRect((t-this.atlasOffset)*l,(1-e-this.atlasOffset)*c,this.dimension*this.atlasRatio+2*this.atlasMargin,this.dimension*this.atlasRatio+2*this.atlasMargin),I.isColor)return i.fillStyle=`#${I.getHexString()}`,void i.fillRect((t-this.atlasOffset)*l,(1-e-this.atlasOffset)*c,this.dimension*this.atlasRatio+2*this.atlasMargin,this.dimension*this.atlasRatio+2*this.atlasMargin);C&&(i.drawImage(o,(t-this.atlasOffset)*l,(1-e-this.atlasOffset)*c,this.dimension*this.atlasRatio+2*this.atlasMargin,this.dimension*this.atlasRatio+2*this.atlasMargin),i.clearRect((t-this.atlasOffset)*l+this.atlasMargin,(1-e-this.atlasOffset)*c+this.atlasMargin,this.dimension*this.atlasRatio,this.dimension*this.atlasRatio)),i.drawImage(o,(t-this.atlasOffset)*l+this.atlasMargin,(1-e-this.atlasOffset)*c+this.atlasMargin,this.dimension*this.atlasRatio,this.dimension*this.atlasRatio),i.restore(),this.needsUpdate=!0}registerAnimation(g,I,C){var A=this;void 0===C&&(C=0);const t=new FaceAnimation(g,I,C),e={animation:t,timer:null},o=function(I){void 0===I&&(I=0);const i=t.keyframes[I];A.drawImageToRange(g,i[1],1!==A.countPerSide),e.timer=setTimeout((()=>{clearTimeout(e.timer);const l=(I+1)%t.keyframes.length;if(C>0){const I=t.keyframes[l],e=function(t){void 0===t&&(t=0),t>C?o(l):(requestAnimationFrame((()=>e(t+1))),A.drawImageToRange(g,I[1],!0,t/C),A.drawImageToRange(g,i[1],!1,1-t/C),A.needsUpdate=!0)};e()}else o(l);A.needsUpdate=!0}),i[0])};this.animations.push(e),o()}makeCanvasPowerOfTwo(g){var I;let C=!1;g||(g=this.canvas,C=!0);const A=g.width,t=g.height,e=Math.pow(2,Math.round(Math.log(A)/Math.log(2))),o=Math.pow(2,Math.round(Math.log(t)/Math.log(2))),i=document.createElement("canvas");i.width=e,i.height=o,null===(I=i.getContext("2d"))||void 0===I||I.drawImage(g,0,0,e,o),C&&(this.canvas=i)}static makeUnknownImage(g,I,C){void 0===I&&(I="#0A2647"),void 0===C&&(C="#E1D7C6");const A=document.createElement("canvas"),t=A.getContext("2d");return t.imageSmoothingEnabled=!1,t.canvas.width=g,t.canvas.height=g,t.fillStyle=C,t.fillRect(0,0,g,g),t.fillStyle=I,t.textAlign="center",t.textBaseline="middle",t.fillText("?",g/2,g/2,g),A}static makeUnknownTexture(g){const I=new three__WEBPACK_IMPORTED_MODULE_0__.ROQ(AtlasTexture.makeUnknownImage(g));return I.minFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD,I.magFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD,I.generateMipmaps=!1,I.needsUpdate=!0,I.colorSpace=three__WEBPACK_IMPORTED_MODULE_0__.KI_,I}constructor(g,I,C){if(void 0===C&&(C=document.createElement("canvas")),super(C),_defineProperty$5(this,"countPerSide",void 0),_defineProperty$5(this,"dimension",void 0),_defineProperty$5(this,"canvas",void 0),_defineProperty$5(this,"atlasMargin",0),_defineProperty$5(this,"atlasOffset",0),_defineProperty$5(this,"atlasRatio",0),_defineProperty$5(this,"animations",[]),this.canvas=C,this.countPerSide=g,this.dimension=I,1===g)this.atlasOffset=0,this.atlasRatio=1,this.atlasMargin=0;else for(this.atlasOffset=1/(4*g),this.atlasMargin=1,this.atlasRatio=(this.atlasMargin/this.atlasOffset/g-2*this.atlasMargin)/I;this.atlasRatio!==Math.floor(this.atlasRatio);)this.atlasRatio*=2,this.atlasMargin*=2;const A=(I*this.atlasRatio+2*this.atlasMargin)*g,t=(I*this.atlasRatio+2*this.atlasMargin)*g;this.canvas.width=A,this.canvas.height=t;const e=this.canvas.getContext("2d");e.imageSmoothingEnabled=!1,this.makeCanvasPowerOfTwo(this.canvas),this.wrapS=three__WEBPACK_IMPORTED_MODULE_0__.uWy,this.wrapT=three__WEBPACK_IMPORTED_MODULE_0__.uWy,this.minFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD,this.magFilter=three__WEBPACK_IMPORTED_MODULE_0__.TyD,this.generateMipmaps=!1,this.needsUpdate=!0,this.colorSpace=three__WEBPACK_IMPORTED_MODULE_0__.KI_;const o=AtlasTexture.makeUnknownImage(A/g);for(let i=0;i<g;i++)for(let I=0;I<g;I++)e.drawImage(o,i/g*A,I/g*t,A/g,t/g)}}class FaceAnimation{constructor(g,I,C){if(void 0===C&&(C=0),_defineProperty$5(this,"range",void 0),_defineProperty$5(this,"keyframes",void 0),_defineProperty$5(this,"fadeFrames",void 0),!g)throw new Error("Texture range is required for FaceAnimation.");if(I.length<=1)throw new Error("FaceAnimation must have at least two keyframe.");this.range=g,this.keyframes=I,this.fadeFrames=C}}function _defineProperty$4(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread$1(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$4(g,I,C[I])}))}return g}function ownKeys(g,I){var C=Object.keys(g);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(g);I&&(A=A.filter((function(I){return Object.getOwnPropertyDescriptor(g,I).enumerable}))),C.push.apply(C,A)}return C}function _objectSpreadProps(g,I){return I=null!=I?I:{},Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(I)):ownKeys(Object(I)).forEach((function(C){Object.defineProperty(g,C,Object.getOwnPropertyDescriptor(I,C))})),g}const VOXEL_NEIGHBORS=[[1,0,0],[-1,0,0],[0,0,1],[0,0,-1],[0,1,0],[0,-1,0]],defaultOptions$1={maxChunkRequestsPerUpdate:12,maxProcessesPerUpdate:4,maxUpdatesPerUpdate:1e3,shouldGenerateChunkMeshes:!0,minLightLevel:.04,chunkRerequestInterval:300,defaultRenderRadius:8,textureUnitDimension:8,chunkLoadExponent:8,skyOptions:{},cloudsOptions:{},chunkUniformsOverwrite:{},sunlightStartTimeFrac:.25,sunlightEndTimeFrac:.7,sunlightChangeSpan:.15,timeForceThreshold:.1,statsSyncInterval:500};class World extends three__WEBPACK_IMPORTED_MODULE_0__.xsS{async meshChunkLocally(g,I,C){const A=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]].map((C=>{let[A,t]=C;return this.getChunkByCoords(g+A,I+t)})),t=A[4],{min:e,max:o}=t,i=Math.floor(this.options.maxHeight/this.options.subChunks),l=[e[0],i*C,e[2]],c=[o[0],i*(C+1),o[2]],n=[],d=[];for(const a of A){if(!a){n.push(null);continue}const[g,I]=a.serialize();n.push(g),d.push(...I)}const s={chunksData:n,options:this.options,min:l,max:c};if(this.chunks.toProcess.find((C=>C.data.x===g&&C.data.z===I)))return;const{geometries:Z}=await new Promise((g=>{this.meshWorkerPool.addJob({message:s,buffers:d,resolve:g})}));if(this.chunks.toProcess.find((C=>C.data.x===g&&C.data.z===I)))return;const b={level:C,geometries:Z.map((g=>({indices:Array.from(g.indices),positions:Array.from(g.positions),uvs:Array.from(g.uvs),lights:Array.from(g.lights),voxel:g.voxel,faceName:g.faceName})))};this.buildChunkMesh(g,I,b)}async applyBlockTexture(g,I,C){this.checkIsInitialized("apply block texture",!1);const A=this.getBlockOf(g);I=Array.isArray(I)?I:[I];const t="string"==typeof C?await this.loader.loadImage(C):C;I.forEach((g=>{const I=A.faces.find((I=>I.name===g));if(!I)throw new Error(`Face "${g}" does not exist on block "${A.name}"`);const e=this.getBlockFaceMaterial(A.id,g);if(I.independent){if(C instanceof three__WEBPACK_IMPORTED_MODULE_0__.xEZ)e.map=C,e.uniforms.map={value:C},e.needsUpdate=!0;else if(t instanceof HTMLImageElement)e.map.image=t,e.map.needsUpdate=!0,e.needsUpdate=!0;else{if(!(t instanceof three__WEBPACK_IMPORTED_MODULE_0__.Ilk))throw new Error(`Cannot apply texture to face "${g}" on block "${A.name}" because the source is not an image or a color.`);{const g=e.map.image;g.width=1,g.height=1;const I=g.getContext("2d");I.fillStyle=t.getStyle(),I.fillRect(0,0,1,1),e.map.needsUpdate=!0,e.needsUpdate=!0}}return}e.map.drawImageToRange(I.range,t),e.map.needsUpdate=!0}))}async applyBlockTextures(g){return Promise.all(g.map((g=>{let{idOrName:I,faceNames:C,source:A}=g;return this.applyBlockTexture(I,C,A)})))}async applyBlockFrames(g,I,C,A){void 0===A&&(A=0),this.checkIsInitialized("apply block animation",!1);const t=this.getBlockOf(g),e=[];for(const[o,i]of C)"string"!=typeof i?e.push([o,i]):e.push([o,await this.loader.loadImage(i)]);(I=Array.isArray(I)?I:[I]).forEach((g=>{const I=t.faces.find((I=>I.name===g));if(!I)throw new Error(`Face "${g}" does not exist on block "${t.name}"`);const C=this.getBlockFaceMaterial(t.id,g);if(!(C.map instanceof AtlasTexture)){const{image:A}=C.map;if(!A||!A.width)throw new Error(`Cannot animate face "${g}" on block "${t.name}" because it does not have a texture.`);{const g=new AtlasTexture(1,A.width);g.drawImageToRange(I.range,A),C.map.dispose(),C.map=g,C.uniforms.map={value:g},C.needsUpdate=!0}}C.map.registerAnimation(I.range,e,A)}))}async applyBlockGif(g,I,C,A){void 0===A&&(A=66.666667),this.checkIsInitialized("apply GIF animation",!1),C.endsWith(".gif")||console.warn("There's a chance that this file isn't a GIF as it doesn't end with .gif");const t=(await this.loader.loadGifImages(C)).map((g=>[A,g]));await this.applyBlockFrames(g,I,t)}async setResolutionOf(g,I,C){this.checkIsInitialized("apply resolution",!1);const A=this.getBlockOf(g);I=Array.isArray(I)?I:[I];for(const e of I){const g=A.faces.find((g=>g.name===e));if(!g)throw new Error(`Face "${e}" does not exist on block "${A.name}"`);if(!g.independent)throw new Error(`Cannot apply resolution to face "${e}" on block "${A.name}" because it is not independent.`);const I=this.getBlockFaceMaterial(A.id,e);if(I.map instanceof AtlasTexture)throw new Error("Cannot apply resolution to a face that is using an atlas texture. Have you accidentally applied keyframes to this face?");var t;const o=null!==(t=I.map.image)&&void 0!==t?t:I.map.source.data;if(o instanceof HTMLImageElement&&await new Promise((g=>{o.complete?g():o.onload=()=>{g()}})),!o)throw new Error(`Cannot apply resolution to face "${e}" on block "${A.name}" because it does not have or has not loaded a texture.`);const{width:i,height:l}=o,c=document.createElement("canvas"),n="number"==typeof C?C:C.x,d="number"==typeof C?C:C.y;c.width=n,c.height=d;c.getContext("2d").drawImage(o,0,0,i,l,0,0,n,d),I.map.image=c,I.map.needsUpdate=!0,I.needsUpdate=!0}}getChunkByName(g){return this.checkIsInitialized("get chunk by name",!1),this.chunks.loaded.get(g)}getChunkByCoords(g,I){this.checkIsInitialized("get chunk by coords",!1);const C=ChunkUtils.getChunkName([g,I]);return this.getChunkByName(C)}getChunkByPosition(g,I,C){this.checkIsInitialized("get chunk by position",!1);const A=ChunkUtils.mapVoxelToChunk([0|g,0|I,0|C],this.options.chunkSize);return this.getChunkByCoords(...A)}getVoxelAt(g,I,C){this.checkIsInitialized("get voxel",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?0:A.getVoxel(g,I,C)}setVoxelAt(g,I,C,A){this.checkIsInitialized("set voxel",!1);const t=this.getChunkByPosition(g,I,C);void 0!==t&&(t.setVoxel(g,I,C,A),this.trackChunkAt(g,I,C))}getVoxelRotationAt(g,I,C){this.checkIsInitialized("get voxel rotation",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?new BlockRotation:A.getVoxelRotation(g,I,C)}setVoxelRotationAt(g,I,C,A){this.checkIsInitialized("set voxel rotation",!1);const t=this.getChunkByPosition(g,I,C);void 0!==t&&(t.setVoxelRotation(g,I,C,A),this.trackChunkAt(g,I,C))}getVoxelStageAt(g,I,C){this.checkIsInitialized("get voxel stage",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?0:A.getVoxelStage(g,I,C)}getSunlightAt(g,I,C){this.checkIsInitialized("get sunlight",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?0:A.getSunlight(g,I,C)}setSunlightAt(g,I,C,A){this.checkIsInitialized("set sunlight",!1);const t=this.getChunkByPosition(g,I,C);void 0!==t&&(t.setSunlight(g,I,C,A),this.trackChunkAt(g,I,C))}getTorchLightAt(g,I,C,A){this.checkIsInitialized("get torch light",!1);const t=this.getChunkByPosition(g,I,C);return void 0===t?0:t.getTorchLight(g,I,C,A)}setTorchLightAt(g,I,C,A,t){this.checkIsInitialized("set torch light",!1);const e=this.getChunkByPosition(g,I,C);void 0!==e&&(e.setTorchLight(g,I,C,A,t),this.trackChunkAt(g,I,C))}getLightColorAt(g,I,C){this.checkIsInitialized("get light color",!1);const A=this.getSunlightAt(g,I,C),t=this.getTorchLightAt(g,I,C,"RED"),e=this.getTorchLightAt(g,I,C,"GREEN"),o=this.getTorchLightAt(g,I,C,"BLUE"),{sunlightIntensity:i,minLightLevel:l}=this.chunks.uniforms,c=Math.min((A/this.options.maxLightLevel)**2*i.value*(1-l.value)+l.value,1);return new three__WEBPACK_IMPORTED_MODULE_0__.Ilk(c+Math.pow(t/this.options.maxLightLevel,2),c+Math.pow(e/this.options.maxLightLevel,2),c+Math.pow(o/this.options.maxLightLevel,2))}getBlockAt(g,I,C){this.checkIsInitialized("get block",!1);const A=this.getChunkByPosition(g,I,C);if(void 0===A)return null;const t=A.getVoxel(g,I,C);return this.getBlockById(t)}getMaxHeightAt(g,I){this.checkIsInitialized("get max height",!1);const C=0|g,A=0|I;for(let t=this.options.maxHeight-1;t>=0;t--){if(!this.getBlockAt(C,t,A).isEmpty)return t}return 0}getPreviousValueAt(g,I,C,A){void 0===A&&(A=1);const t=ChunkUtils.getVoxelName([0|g,0|I,0|C]),e=this.oldBlocks.get(t)||[];return e[e.length-A]||0}getBlockOf(g){return"number"==typeof g?this.getBlockById(g):this.getBlockByName(g.toLowerCase())}getBlockById(g){const I=this.registry.blocksById.get(g);if(!I)throw new Error(`Block with id ${g} does not exist`);return I}getBlockByName(g){const I=this.registry.blocksByName.get(g.toLowerCase());if(!I)throw new Error(`Block with name ${g} does not exist`);return I}getChunkStatus(g,I){const C=ChunkUtils.getChunkName([g,I]),A=this.chunks.requested.has(C),t=this.chunks.loaded.has(C),e=!!this.chunks.toProcess.find((C=>{let{data:A}=C;return A.x===g&&A.z===I})),o=!!this.chunks.toRequest.find((C=>{let[A,t]=C;return A===g&&t===I}));if(A&&e||A&&o||e&&o)throw new Error(`Chunk ${C} is in more than one state other than the loaded state. This should not happen. These are the states: requested: ${A}, loaded: ${t}, processing: ${e}, to request: ${o}`);return t?"loaded":e?"processing":A?"requested":o?"to request":null}getBlockFaceMaterial(g,I){this.checkIsInitialized("get material",!1);const C=this.getBlockOf(g);return I&&C.independentFaces.has(I)?this.chunks.materials.get(this.makeChunkMaterialKey(C.id,I)):this.chunks.materials.get(this.makeChunkMaterialKey(C.id))}isWithinWorld(g,I){const{minChunk:C,maxChunk:A}=this.options;return g>=C[0]&&g<=A[0]&&I>=C[1]&&I<=A[1]}isChunkInView(g,I,C,A){const[t,e]=g,[o,i]=I;if((t-o)**2+(e-i)**2<Math.floor(this.renderRadius/2)**2)return!0;const l=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(i-e,o-t,0),c=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4(C.z,C.x,0),n=MathUtils.normalizeAngle(l.angleTo(c));return Math.abs(n)<A}floodLight(g,I,C,A){if(!g.length)return;const{maxHeight:t,minChunk:e,maxChunk:o,maxLightLevel:i,chunkSize:l}=this.options,[c,n]=e,[d,s]=o,Z="SUNLIGHT"===I;for(;g.length;){const e=g.shift(),{voxel:o,level:b}=e;if(0===b)continue;const[a,m,r]=o,h=this.getBlockAt(a,m,r),B=!Z&&BlockUtils.getBlockTorchLightLevel(h,I)>0?[!0,!0,!0,!0,!0,!0]:BlockUtils.getBlockRotatedTransparency(h,this.getVoxelRotationAt(a,m,r));for(const[G,W,u]of VOXEL_NEIGHBORS){const e=m+W;if(e<0||e>=t)continue;const o=a+G,h=r+u,[y,p]=ChunkUtils.mapVoxelToChunk([o,e,h],l);if(y<c||y>d||p<n||p>s||C&&(o<C[0]||h<C[2])||A&&(o>=A[0]||h>=A[2]))continue;const V=[o,e,h],S=this.getBlockAt(o,e,h),Y=BlockUtils.getBlockRotatedTransparency(S,this.getVoxelRotationAt(o,e,h)),J=b-(Z&&!S.lightReduce&&-1===W&&b===i?0:1);!LightUtils.canEnter(B,Y,G,W,u)||(Z?this.getSunlightAt(o,e,h):this.getTorchLightAt(o,e,h,I))>=J||(Z?this.setSunlightAt(o,e,h,J):this.setTorchLightAt(o,e,h,J,I),g.push({voxel:V,level:J}))}}}removeLight(g,I){const{maxHeight:C,maxLightLevel:A,chunkSize:t,minChunk:e,maxChunk:o}=this.options,i=[],l=[],c="SUNLIGHT"===I,[n,d,s]=g;for(l.push({voxel:g,level:c?this.getSunlightAt(n,d,s):this.getTorchLightAt(n,d,s,I)}),c?this.setSunlightAt(n,d,s,0):this.setTorchLightAt(n,d,s,0,I);l.length;){const g=l.shift(),{voxel:n,level:d}=g,[s,Z,b]=n;for(const[a,m,r]of VOXEL_NEIGHBORS){const g=Z+m;if(g<0||g>=C)continue;const n=s+a,h=b+r,[B,G]=ChunkUtils.mapVoxelToChunk([n,g,h],t);if(B<e[0]||G<e[1]||B>o[0]||G>o[1])continue;const W=this.getBlockAt(n,g,h),u=this.getVoxelRotationAt(n,g,h),y=BlockUtils.getBlockRotatedTransparency(W,u);if((c||0===BlockUtils.getBlockTorchLightLevel(W,I))&&!LightUtils.canEnterInto(y,a,m,r))continue;const p=[n,g,h],V=c?this.getSunlightAt(n,g,h):this.getTorchLightAt(n,g,h,I);0!==V&&(V<d||c&&-1===m&&d===A&&V===A?(l.push({voxel:p,level:V}),c?this.setSunlightAt(n,g,h,0):this.setTorchLightAt(n,g,h,0,I)):(c&&-1===m?V>d:V>=d)&&i.push({voxel:p,level:V}))}}this.floodLight(i,I)}async initialize(){if(this.isInitialized)return void console.warn("World has already been isInitialized.");if(null===this.initialData)throw new Error("World has not received any initialization data from the server.");const{blocks:g,options:I,stats:C}=this.initialData;this._time=C.time,Object.keys(g).forEach((I=>{const C=g[I],{id:A,aabbs:t,isDynamic:e}=C,o=I.toLowerCase();C.independentFaces=new Set,C.faces.forEach((g=>{g.independent&&C.independentFaces.add(g.name)})),C.aabbs=t.map((g=>{let{minX:I,minY:C,minZ:A,maxX:t,maxY:e,maxZ:o}=g;return new AABB(I,C,A,t,e,o)})),e&&(C.dynamicFn=()=>({aabbs:C.aabbs,faces:C.faces,isTransparent:C.isTransparent})),this.registry.blocksByName.set(o,C),this.registry.blocksById.set(A,C),this.registry.nameMap.set(o,A),this.registry.idMap.set(A,o)})),this.options=_objectSpread$1({},this.options,I),this.physics.options=this.options,await this.loadMaterials();const A=this.registry.serialize();this.meshWorkerPool.postMessage({type:"init",registryData:A}),this.isInitialized=!0,this.renderRadius=this.options.defaultRenderRadius}update(g,I){if(void 0===g&&(g=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),void 0===I&&(I=new three__WEBPACK_IMPORTED_MODULE_0__.Pa4),!this.isInitialized)return;const C=this.clock.getDelta(),A=ChunkUtils.mapVoxelToChunk(g.toArray(),this.options.chunkSize);this._time=(this.time+C)%this.options.timePerDay,this.maintainChunks(A,I),this.requestChunks(A,I),this.processChunks(A),this.updatePhysics(C),this.updateUniforms(),this.updateSkyAndClouds(g),this.processClientUpdates(),this.emitServerUpdates()}onMessage(g){const{type:I}=g;switch(I){case"INIT":{const{json:I}=g;this.initialData=I;break}case"STATS":{const{json:I}=g;Math.abs(I.time-this.time)>this.options.timeForceThreshold&&(this._time=I.time);break}case"LOAD":{const{chunks:I}=g;I.forEach((g=>{const{x:I,z:C}=g,A=ChunkUtils.getChunkName([I,C]);this.chunks.requested.delete(A),this.chunks.toProcess.push({source:"load",data:g})}));break}case"UPDATE":{const{updates:I}=g;I.forEach((g=>{const{vx:I,vy:C,vz:A,voxel:t}=g,e=BlockUtils.extractID(t),o=BlockUtils.extractRotation(t),i=this.getVoxelRotationAt(I,C,A);this.getVoxelAt(I,C,A)===e&&i.value===o.value&&i.yRotation===o.yRotation||this.updateVoxel(I,C,A,e,o.value,o.yRotation,"server")}));break}}}get time(){return this._time}set time(g){this._time=g,this.isInitialized&&this.packets.push({type:"METHOD",method:{name:"vox-builtin:set-time",payload:JSON.stringify({time:g})}})}get renderRadius(){return this._renderRadius}set renderRadius(g){this.checkIsInitialized("set render radius",!1),g=Math.floor(g),this._renderRadius=g,this._deleteRadius=1.1*g;const{chunkSize:I}=this.options;this.chunks.uniforms.fogNear.value=.7*g*I,this.chunks.uniforms.fogFar.value=g*I}get deleteRadius(){return this._deleteRadius}requestChunks(g,I){const{renderRadius:C,options:{chunkRerequestInterval:A,chunkLoadExponent:t}}=this,e=this.chunks.loaded.size+this.chunks.requested.size+this.chunks.toRequest.length+this.chunks.toProcess.length,o=this.chunks.loaded.size/e,i=I.length()>0,l=1===o?3*Math.PI/8:Math.max(o**t,.1),[c,n]=g;for(let Z=-C;Z<=C;Z++)for(let t=-C;t<=C;t++){if(Z*Z+t*t>C*C)continue;const e=c+Z,o=n+t;if(!this.isWithinWorld(e,o))continue;if(i&&!this.isChunkInView(g,[e,o],I,l))continue;const d=this.getChunkStatus(e,o);if(d){if("loaded"!==d)if("requested"!==d);else{const g=ChunkUtils.getChunkName([e,o]),I=this.chunks.requested.get(g);I+1>A?(this.chunks.requested.delete(g),this.chunks.toRequest.push([e,o])):this.chunks.requested.set(g,I+1)}}else this.chunks.toRequest.find((g=>{let[I,C]=g;return I===e&&C===o}))||this.chunks.toRequest.push([e,o])}if(0===this.chunks.toRequest.length)return;this.chunks.toRequest.sort(((I,C)=>{const[A,t]=I,[e,o]=C;return(A-g[0])**2+(t-g[1])**2-((e-g[0])**2+(o-g[1])**2)}));const{maxChunkRequestsPerUpdate:d}=this.options,s=this.chunks.toRequest.splice(0,d);this.packets.push({type:"LOAD",json:{center:g,chunks:s}}),s.forEach((g=>{const I=ChunkUtils.getChunkName(g);this.chunks.requested.set(I,0)}))}processChunks(g){if(0===this.chunks.toProcess.length)return;this.chunks.toProcess.sort(((I,C)=>{const{x:A,z:t}=I.data,{x:e,z:o}=C.data;return(A-g[0])**2+(t-g[1])**2-((e-g[0])**2+(o-g[1])**2)}));const{maxProcessesPerUpdate:I,chunkSize:C,maxHeight:A,subChunks:t,shouldGenerateChunkMeshes:e}=this.options,o=g=>{const I=this.chunkInitializeListeners.get(g.name);Array.isArray(I)&&(I.forEach((I=>I(g))),this.chunkInitializeListeners.delete(g.name))};this.chunks.toProcess.splice(0,I).forEach((g=>{const{x:I,z:i,id:l,meshes:c}=g.data,n=ChunkUtils.getChunkName([I,i]);let d=this.getChunkByCoords(I,i);if(d||(d=new Chunk(l,[I,i],{maxHeight:A,subChunks:t,size:C})),d.setData(g.data),d.isDirty=!1,this.chunks.loaded.set(n,d),e){for(const g of c)this.buildChunkMesh(I,i,g);o(d)}else o(d)}))}maintainChunks(g,I){const{deleteRadius:C}=this,[A,t]=g,e=[];this.chunks.loaded.forEach((g=>{const{name:I,coords:[o,i]}=g;if((o-A)**2+(i-t)**2>C**2){const g=this.chunks.loaded.get(I);g.dispose(),this.chunks.loaded.delete(I),e.push(g.coords)}})),this.chunks.requested.forEach(((g,I)=>{const[o,i]=ChunkUtils.parseChunkName(I);(o-A)**2+(i-t)**2>C**2&&(this.chunks.requested.delete(I),e.push([o,i]))}));const o=[...this.chunks.toRequest];this.chunks.toRequest.length=0,this.chunks.toRequest.push(...o.filter((g=>{let[I,e]=g;return(I-A)**2+(e-t)**2<=C**2})));const i=[...this.chunks.toProcess];this.chunks.toProcess.length=0,this.chunks.toProcess.push(...i.filter((g=>{const{x:I,z:e}=g.data;return(I-A)**2+(e-t)**2<=C**2}))),e.forEach((g=>{const I=ChunkUtils.getChunkName(g);this.chunkInitializeListeners.delete(I)})),e.length&&this.packets.push({type:"UNLOAD",json:{chunks:e}})}triggerBlockUpdateListeners(g,I,C,A,t){this.blockUpdateListeners.forEach((e=>e({voxel:[g,I,C],oldValue:A,newValue:t})))}attemptBlockCache(g,I,C,A){const t=this.getChunkByPosition(g,I,C);if(!t)return;const e=t.getRawValue(g,I,C);if(e!==A){const t=ChunkUtils.getVoxelName([g,I,C]),o=this.oldBlocks.get(t)||[];o.push(e),this.oldBlocks.set(t,o),this.triggerBlockUpdateListeners(g,I,C,e,A)}}updateSkyAndClouds(g){var I;const{sunlightStartTimeFrac:C,sunlightEndTimeFrac:A,sunlightChangeSpan:t,timePerDay:e,minLightLevel:o}=this.options;this.sky.update(g,this.time,e),this.clouds.update(g);const i=Math.floor(C*e),l=Math.floor(A*e),c=Math.floor(t*e),n=Math.max(o,this.time<i?0:this.time<i+c?(this.time-i)/c:this.time<=l?1:this.time<=l+c?1-(this.time-l)/c:0);this.chunks.uniforms.sunlightIntensity.value=n;const d=this.clouds.material.uniforms.uCloudColor.value,s=d.getHSL({});d.setHSL(s.h,s.s,three__WEBPACK_IMPORTED_MODULE_0__.M8C.clamp(n,0,1)),null===(I=this.chunks.uniforms.fogColor.value)||void 0===I||I.copy(this.sky.uMiddleColor.value)}buildChunkMesh(g,I,C){var A,t;const e=this.getChunkByCoords(g,I);if(!e)return;const{maxHeight:o,subChunks:i,chunkSize:l}=this.options,{level:c,geometries:n}=C,d=Math.floor(o/i);if(null===(A=e.meshes.get(c))||void 0===A||A.forEach((g=>{g.geometry.dispose(),this.remove(g)})),e.meshes.delete(c),0===n.length)return;const s=n.map((C=>{const{voxel:A,faceName:t,indices:e,lights:o,positions:i,uvs:n}=C,s=new three__WEBPACK_IMPORTED_MODULE_0__.u9r;s.setAttribute("position",new three__WEBPACK_IMPORTED_MODULE_0__.a$l(i,3)),s.setAttribute("uv",new three__WEBPACK_IMPORTED_MODULE_0__.a$l(n,2)),s.setAttribute("light",new three__WEBPACK_IMPORTED_MODULE_0__.j87(o,1)),s.setIndex(e);const Z=this.getBlockFaceMaterial(A,t);if(!Z)return;const b=new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(s,Z);return b.position.set(g*l,c*d,I*l),b.updateMatrix(),b.matrixAutoUpdate=!1,b.matrixWorldAutoUpdate=!1,b.userData={isChunk:!0,voxel:A},this.add(b),b}));e.meshes.has(c)||e.meshes.set(c,[]),null===(t=e.meshes.get(c))||void 0===t||t.push(...s)}setupComponents(){const{skyOptions:g,cloudsOptions:I}=this.options;this.registry=new Registry,this.loader=new Loader,this.chunks=new Chunks,I.uFogColor||(I.uFogColor=this.chunks.uniforms.fogColor),this.sky=new Sky(g),this.clouds=new Clouds(I),this.add(this.sky,this.clouds),this.physics=new Engine(((g,I,C)=>{if(!this.getChunkByPosition(g,I,C))return[];const A=this.getVoxelAt(g,I,C),t=this.getVoxelRotationAt(g,I,C),{aabbs:e,isPassable:o,isFluid:i}=this.getBlockById(A);return o||i?[]:e.map((A=>t.rotateAABB(A).translate([g,I,C])))}),((g,I,C)=>{if(!this.getChunkByPosition(g,I,C))return!1;const A=this.getVoxelAt(g,I,C),{isFluid:t}=this.getBlockById(A);return t}),this.options)}setupUniforms(){const{minLightLevel:g}=this.options;this.chunks.uniforms.minLightLevel.value=g}async loadMaterials(){const{textureUnitDimension:g}=this.options,I=g=>{let I=1;const C=Math.ceil(Math.sqrt(g));for(;I<C;)I*=2;return I},C=(g,I)=>{const C=this.makeShaderMaterial();return C.side=g?three__WEBPACK_IMPORTED_MODULE_0__.ub3:three__WEBPACK_IMPORTED_MODULE_0__.Wl3,C.transparent=g,C.map=I,C.uniforms.map.value=I,C};for(const A of this.registry.blocksById.values()){let t=A.faces.length;A.faces.forEach((g=>{g.independent&&t--}));const e=I(t),o=new AtlasTexture(e,g),i=C(A.isSeeThrough,o),l=this.makeChunkMaterialKey(A.id);this.chunks.materials.set(l,i);for(const I of A.faces){if(!I.independent)continue;const t=C(A.isSeeThrough,AtlasTexture.makeUnknownTexture(g)),e=this.makeChunkMaterialKey(A.id,I.name);this.chunks.materials.set(e,t)}}}makeChunkMaterialKey(g,I){return I?`${g}-${I}`:`${g}`}trackChunkAt(g,I,C){if(!this.isTrackingChunks)return;const{chunkSize:A,maxHeight:t,subChunks:e}=this.options,o=[0|g,0|I,0|C],[i,l]=ChunkUtils.mapVoxelToChunk(o,A),[c,,n]=ChunkUtils.mapVoxelToChunkLocal(o,A);if(this.chunksTracker.find((g=>{let[[I,C]]=g;return I===i&&C===l})))return;const d=t/e,s=Math.floor(I/d),Z=[];Z.push([i,l]),0===c&&Z.push([i-1,l]),0===n&&Z.push([i,l-1]),0===c&&0===n&&Z.push([i-1,l-1]),c===A-1&&Z.push([i+1,l]),n===A-1&&Z.push([i,l+1]),c===A-1&&n===A-1&&Z.push([i+1,l+1]);const b=[];I%d==0&&s>0?b.push(s-1):I%d==d-1&&s<e&&b.push(s+1),b.push(s);for(const[a,m]of Z)for(const g of b)this.chunksTracker.push([[a,m],g])}checkIsInitialized(g,I){if(void 0===I&&(I=!0),I?this.isInitialized:!this.isInitialized)throw new Error(`Cannot ${g} ${I?"after":"before"} the world ${I?"has been":"is"} isInitialized. ${I?"This has to be called before `world.init`.":"Remember to call the asynchronous function `world.init` beforehand."}`)}constructor(g){var I,C;void 0===g&&(g={}),super(),I=this,_defineProperty$4(this,"options",void 0),_defineProperty$4(this,"registry",void 0),_defineProperty$4(this,"loader",void 0),_defineProperty$4(this,"chunks",void 0),_defineProperty$4(this,"physics",void 0),_defineProperty$4(this,"sky",void 0),_defineProperty$4(this,"clouds",void 0),_defineProperty$4(this,"isInitialized",!1),_defineProperty$4(this,"packets",[]),_defineProperty$4(this,"oldBlocks",new Map),_defineProperty$4(this,"clock",new three__WEBPACK_IMPORTED_MODULE_0__.SUY),_defineProperty$4(this,"chunkInitializeListeners",new Map),_defineProperty$4(this,"blockUpdateListeners",new Set),_defineProperty$4(this,"initialData",null),_defineProperty$4(this,"_time",0),_defineProperty$4(this,"_renderRadius",0),_defineProperty$4(this,"_deleteRadius",0),_defineProperty$4(this,"meshWorkerPool",new WorkerPool(WorkerFactory$2,{maxWorker:null!==(C=navigator.hardwareConcurrency)&&void 0!==C?C:4})),_defineProperty$4(this,"chunksTracker",[]),_defineProperty$4(this,"isTrackingChunks",!1),_defineProperty$4(this,"addChunkInitListener",((g,I)=>{const C=ChunkUtils.getChunkName(g);if(this.chunks.loaded.has(C))return void I(this.chunks.loaded.get(C));const A=this.chunkInitializeListeners.get(C)||[];A.push(I),this.chunkInitializeListeners.set(C,A)})),_defineProperty$4(this,"addBlockUpdateListener",(g=>{this.blockUpdateListeners.add(g)})),_defineProperty$4(this,"raycastVoxels",(function(g,C,A,t){void 0===t&&(t={}),I.checkIsInitialized("raycast voxels",!1);const{ignoreFluids:e,ignorePassables:o,ignoreSeeThrough:i}=_objectSpread$1({ignoreFluids:!0,ignorePassables:!1,ignoreSeeThrough:!1},t),l=new Set(t.ignoreList||[]);return raycast(((g,C,A)=>{const t=I.getBlockAt(g,C,A);if(!t)return[];const{id:c,isFluid:n,isPassable:d,isSeeThrough:s,aabbs:Z,dynamicFn:b,isDynamic:a}=t;if(l.has(c))return[];if(a&&!b&&console.warn(`Block of ID ${c} is dynamic but has no dynamic function.`),n&&e||d&&o||s&&i)return[];const m=I.getVoxelRotationAt(g,C,A);return(a&&b?b([0|g,0|C,0|A]).aabbs:Z).map((g=>m.rotateAABB(g)))}),g,C,A)})),_defineProperty$4(this,"updateVoxel",(function(g,C,A,t,e,o,i){void 0===e&&(e=PY_ROTATION),void 0===o&&(o=0),void 0===i&&(i="client"),I.updateVoxels([{vx:g,vy:C,vz:A,type:t,rotation:e,yRotation:o}],i)})),_defineProperty$4(this,"updateVoxels",(function(g,C){void 0===C&&(C="client"),I.checkIsInitialized("update voxels",!1);const A=g.filter((g=>{if(g.vy<0||g.vy>=I.options.maxHeight)return!1;const{vx:C,vy:A,vz:t,type:e,rotation:o,yRotation:i}=g,l=I.getVoxelAt(C,A,t),c=I.getVoxelRotationAt(C,A,t);return I.getBlockById(e)?l!==e||void 0===o||c.value!==o||void 0===i||c.yRotation!==i:(console.warn(`Block ID ${e} does not exist.`),!1)})).map((g=>(isNaN(g.rotation)&&(g.rotation=0),I.getBlockById(g.type).yRotatable||(g.yRotation=0),g)));I.chunks.toUpdate.push(...A.map((g=>({source:C,update:g}))))})),_defineProperty$4(this,"makeBlockMesh",(function(g,C){if(void 0===C&&(C={}),I.checkIsInitialized("make block mesh",!1),!g)return null;const A=I.getBlockOf(g);if(!A)return null;const{separateFaces:t,crumbs:e,material:o}=_objectSpread$1({separateFaces:!1,crumbs:!1,material:"basic"},C),{faces:i,isSeeThrough:l}=A,c=new Map;i.forEach(((g,C)=>{const i=e&&t?Math.random()+.5:1,{corners:n,name:d,range:s}=g,Z=`${A.name}-${d}-${t?C:"all"}`;let b=c.get(Z);if(!b){const g=I.getBlockFaceMaterial(A.id,d),C={transparent:l,map:g.map,side:l?three__WEBPACK_IMPORTED_MODULE_0__.ub3:three__WEBPACK_IMPORTED_MODULE_0__.Wl3};b={identifier:Z,positions:[],uvs:[],indices:[],material:"basic"===o?new three__WEBPACK_IMPORTED_MODULE_0__.vBJ(C):new three__WEBPACK_IMPORTED_MODULE_0__.Wid(C)}}const{positions:a,uvs:m,indices:r}=b,h=Math.floor(a.length/3);let{startU:B,endU:G,startV:W,endV:u}=s;e&&(Math.random()<.5?(B+=(G-B)/2*Math.random(),u-=(u-W)/2*Math.random()):(G-=(G-B)/2*Math.random(),W+=(u-W)/2*Math.random())),n.forEach((g=>{let{uv:I,pos:C}=g;a.push(...C.map((g=>g*i))),m.push(I[0]*(G-B)+B,I[1]*(u-W)+W)})),r.push(h,h+1,h+2,h+2,h+1,h+3),c.set(Z,b)}));const n=new three__WEBPACK_IMPORTED_MODULE_0__.ZAu;return c.forEach((g=>{let{identifier:I,positions:C,uvs:A,indices:t,material:e}=g;const o=new three__WEBPACK_IMPORTED_MODULE_0__.u9r;o.setAttribute("position",new three__WEBPACK_IMPORTED_MODULE_0__.a$l(C,3)),o.setAttribute("uv",new three__WEBPACK_IMPORTED_MODULE_0__.a$l(A,2)),o.setIndex(t),o.computeVertexNormals();const i=new three__WEBPACK_IMPORTED_MODULE_0__.Kj0(o,e);i.name=I,n.add(i)})),n.name=A.name,n.position.x-=.5,n.position.y-=.5,n.position.z-=.5,n})),_defineProperty$4(this,"customizeMaterialShaders",(function(g,C,A){void 0===C&&(C=null),void 0===A&&(A={vertexShader:DEFAULT_CHUNK_SHADERS.vertex,fragmentShader:DEFAULT_CHUNK_SHADERS.fragment,uniforms:{}}),I.checkIsInitialized("customize material shaders",!1);const{vertexShader:t=DEFAULT_CHUNK_SHADERS.vertex,fragmentShader:e=DEFAULT_CHUNK_SHADERS.fragment,uniforms:o={}}=A,i=I.getBlockFaceMaterial(g,C);if(!i)throw new Error(`Could not find material for block ${g} and face ${C}`);return i.vertexShader=t,i.fragmentShader=e,i.uniforms=_objectSpread$1({},i.uniforms,o),i.needsUpdate=!0,i})),_defineProperty$4(this,"customizeBlockDynamic",((g,I)=>{this.checkIsInitialized("customize block dynamic",!1);const C=this.getBlockOf(g);if(!C)throw new Error(`Block with ID ${g} does not exist, could not overwrite dynamic function.`);C.dynamicFn=I})),_defineProperty$4(this,"updatePhysics",(g=>{if(!this.physics||!this.options.gravity)return;const I=this.options.gravity[0]**2+this.options.gravity[1]**2+this.options.gravity[2]**2<.01;this.physics.bodies.forEach((C=>{const A=ChunkUtils.mapVoxelToChunk(C.getPosition(),this.options.chunkSize),t=this.getChunkByPosition(...C.getPosition());(t&&t.isReady||!this.isWithinWorld(...A))&&this.physics.iterateBody(C,g,I)}))})),_defineProperty$4(this,"updateUniforms",(()=>{this.chunks.uniforms.time.value=performance.now()})),_defineProperty$4(this,"processClientUpdates",(()=>{if(0===this.chunks.toUpdate.length)return;const g=this.chunks.toUpdate.splice(0,this.options.maxUpdatesPerUpdate);g.sort(((g,I)=>I.update.vy-g.update.vy));const{maxHeight:I,maxLightLevel:C}=this.options,A=[],t=[],e=[],o=[];this.isTrackingChunks=!0;for(const l of g){const{update:{type:g,vx:i,vy:c,vz:n,rotation:d,yRotation:s}}=l,Z=this.getBlockAt(i,c,n),b=this.getVoxelRotationAt(i,c,n),a=BlockUtils.getBlockRotatedTransparency(Z,b),m=this.getBlockById(g),r=BlockRotation.encode(d,s),h=BlockUtils.getBlockRotatedTransparency(m,r),B=BlockUtils.insertAll(m.id,m.rotatable?r:void 0);if(this.attemptBlockCache(i,c,n,B),this.setVoxelAt(i,c,n,g),m.rotatable&&this.setVoxelRotationAt(i,c,n,r),m.isOpaque||m.lightReduce)this.getSunlightAt(i,c,n)>0&&this.removeLight([i,c,n],"SUNLIGHT"),[RED_LIGHT,GREEN_LIGHT,BLUE_LIGHT].map((g=>{this.getTorchLightAt(i,c,n,g)>0&&this.removeLight([i,c,n],g)}));else{let g=0;const A=[[SUNLIGHT,this.getSunlightAt(i,c,n)],[RED_LIGHT,this.getTorchLightAt(i,c,n,"RED")],[GREEN_LIGHT,this.getTorchLightAt(i,c,n,"GREEN")],[BLUE_LIGHT,this.getTorchLightAt(i,c,n,"BLUE")]];VOXEL_NEIGHBORS.forEach((t=>{let[e,o,l]=t;const d=c+o;if(d<0||d>=I)return;const s=i+e,Z=n+l,m=this.getBlockAt(s,d,Z),r=BlockUtils.getBlockRotatedTransparency(m,b);LightUtils.canEnter(a,r,e,o,l)&&!LightUtils.canEnter(h,r,e,o,l)&&A.forEach((I=>{let[A,t]=I;const e=A===SUNLIGHT,i=e?this.getSunlightAt(s,d,Z):this.getTorchLightAt(s,d,Z,A);(i<t||-1===o&&e&&i===C&&t===C)&&(g+=1,this.removeLight([s,d,Z],A))}))})),0===g&&(0!==this.getSunlightAt(i,c,n)&&this.removeLight([i,c,n],"SUNLIGHT"),[RED_LIGHT,GREEN_LIGHT,BLUE_LIGHT].map((g=>{0!==this.getTorchLightAt(i,c,n,g)&&this.removeLight([i,c,n],g)})))}m.isLight?(m.redLightLevel>0&&(this.setTorchLightAt(i,c,n,m.redLightLevel,"RED"),A.push({voxel:[i,c,n],level:m.redLightLevel})),m.greenLightLevel>0&&(this.setTorchLightAt(i,c,n,m.greenLightLevel,"GREEN"),t.push({voxel:[i,c,n],level:m.greenLightLevel})),m.blueLightLevel>0&&(this.setTorchLightAt(i,c,n,m.blueLightLevel,"BLUE"),e.push({voxel:[i,c,n],level:m.blueLightLevel}))):VOXEL_NEIGHBORS.forEach((g=>{let[l,d,s]=g;const Z=c+d;if(Z<0)return;if(Z>=I)return void(LightUtils.canEnter([!0,!0,!0,!0,!0,!0],h,l,-1,s)&&o.push({voxel:[i+l,c,n+s],level:C}));const b=i+l,r=n+s,B=this.getBlockAt(b,Z,r),G=BlockUtils.getBlockRotatedTransparency(B,this.getVoxelRotationAt(b,Z,r)),W=[b,Z,r];if(LightUtils.canEnter(a,G,l,d,s)||!LightUtils.canEnter(h,G,l,d,s))return;const u=this.getSunlightAt(b,Z,r)-(m.lightReduce?1:0);0!==u&&o.push({voxel:W,level:u});const y=this.getTorchLightAt(b,Z,r,"RED")-(m.lightReduce?1:0);0!==y&&A.push({voxel:W,level:y});const p=this.getTorchLightAt(b,Z,r,"GREEN")-(m.lightReduce?1:0);0!==p&&t.push({voxel:W,level:p});const V=this.getTorchLightAt(b,Z,r,"BLUE")-(m.lightReduce?1:0);0!==V&&e.push({voxel:W,level:V})}))}this.floodLight(o,"SUNLIGHT"),this.floodLight(A,"RED"),this.floodLight(t,"GREEN"),this.floodLight(e,"BLUE"),this.isTrackingChunks=!1;const i=this.chunksTracker.splice(0,this.chunksTracker.length);(async()=>{for(const[g,I]of i){const[C,A]=g;await this.meshChunkLocally(C,A,I)}})().then((()=>{this.chunks.toEmit.push(...g.filter((g=>{let{source:I}=g;return"client"===I})).map((g=>{let{update:I}=g;return I})))}))})),_defineProperty$4(this,"emitServerUpdates",(()=>{if(0===this.chunks.toEmit.length)return;const g=this.chunks.toEmit.splice(0,this.options.maxUpdatesPerUpdate);this.packets.push({type:"UPDATE",updates:g.map((g=>{const{type:I,rotation:C,yRotation:A}=g,t=this.getBlockById(I);let e=0;return e=BlockUtils.insertID(e,I),!t.rotatable||isNaN(C)&&isNaN(A)||(e=BlockUtils.insertRotation(e,BlockRotation.encode(C,A))),_objectSpreadProps(_objectSpread$1({},g),{voxel:e})}))})})),_defineProperty$4(this,"makeShaderMaterial",(function(g,C,A){void 0===g&&(g=DEFAULT_CHUNK_SHADERS.fragment),void 0===C&&(C=DEFAULT_CHUNK_SHADERS.vertex),void 0===A&&(A={});const t=_objectSpread$1({},I.chunks.uniforms,I.options.chunkUniformsOverwrite),e=new three__WEBPACK_IMPORTED_MODULE_0__.jyz({vertexColors:!0,fragmentShader:g,vertexShader:C,uniforms:_objectSpread$1(_objectSpreadProps(_objectSpread$1({},three__WEBPACK_IMPORTED_MODULE_0__.rDY.clone(three__WEBPACK_IMPORTED_MODULE_0__.Vj0.basic.uniforms)),{uSunlightIntensity:t.sunlightIntensity,uAOTable:t.ao,uMinLightLevel:t.minLightLevel,uFogNear:t.fogNear,uFogFar:t.fogFar,uFogColor:t.fogColor,uTime:t.time}),A)});return Object.defineProperty(e,"renderStage",{get:function(){return e.uniforms.renderStage.value},set:function(g){e.uniforms.renderStage.value=parseFloat(g)}}),e.map=AtlasTexture.makeUnknownTexture(),e.uniforms.map={value:e.map},e}));const{statsSyncInterval:A}=this.options=_objectSpread$1({},defaultOptions$1,g);this.setupComponents(),this.setupUniforms(),setWorkerInterval((()=>{this.packets.push({type:"METHOD",method:{name:"vox-builtin:get-stats",payload:{}}})}),A)}}var url_min={exports:{}},module;module=url_min,function(g){var I,C=/^[a-z]+:/,A=/[-a-z0-9]+(\.[-a-z0-9])*:\d+/i,t=/\/\/(.*?)(?::(.*?))?@/,e=/^win/i,o=/:$/,i=/^\?/,l=/^#/,c=/(.*\/)/,n=/^\/{2,}/,d=/(^\/?)/,s=/'/g,Z=/%([ef][0-9a-f])%([89ab][0-9a-f])%([89ab][0-9a-f])/gi,b=/%([cd][0-9a-f])%([89ab][0-9a-f])/gi,a=/%([0-7][0-9a-f])/gi,m=/\+/g,r=/^\w:$/,h=/[^/#?]/,B="undefined"==typeof window&&void 0!==commonjsGlobal&&"function"==typeof commonjsRequire,G=!B&&g.navigator&&g.navigator.userAgent&&~g.navigator.userAgent.indexOf("MSIE"),W=B?g.require:null,u={protocol:"protocol",host:"hostname",port:"port",path:"pathname",query:"search",hash:"hash"},y={ftp:21,gopher:70,http:80,https:443,ws:80,wss:443};function p(){return B?I=I||"file://"+(process.platform.match(e)?"/":"")+W("fs").realpathSync("."):"about:srcdoc"===document.location.href?self.parent.document.location.href:document.location.href}function V(g){return encodeURIComponent(g).replace(s,"%27")}function S(g){return(g=(g=(g=g.replace(m," ")).replace(Z,(function(g,I,C,A){var t=parseInt(I,16)-224,e=parseInt(C,16)-128;if(0==t&&e<32)return g;var o=(t<<12)+(e<<6)+(parseInt(A,16)-128);return 65535<o?g:String.fromCharCode(o)}))).replace(b,(function(g,I,C){var A=parseInt(I,16)-192;if(A<2)return g;var t=parseInt(C,16)-128;return String.fromCharCode((A<<6)+t)}))).replace(a,(function(g,I){return String.fromCharCode(parseInt(I,16))}))}function Y(g){for(var I=g.split("&"),C=0,A=I.length;C<A;C++){var t=I[C].split("="),e=decodeURIComponent(t[0].replace(m," "));if(e){var o=void 0!==t[1]?S(t[1]):null;void 0===this[e]?this[e]=o:(this[e]instanceof Array||(this[e]=[this[e]]),this[e].push(o))}}}function J(g,I){!function(g,I,e){var s,Z,b;I=I||p(),B?s=W("url").parse(I):(s=document.createElement("a")).href=I;var a,m,r=(m={path:!0,query:!0,hash:!0},(a=I)&&C.test(a)&&(m.protocol=!0,m.host=!0,A.test(a)&&(m.port=!0),t.test(a)&&(m.user=!0,m.pass=!0)),m);for(Z in b=I.match(t)||[],u)r[Z]?g[Z]=s[u[Z]]||"":g[Z]="";if(g.protocol=g.protocol.replace(o,""),g.query=g.query.replace(i,""),g.hash=S(g.hash.replace(l,"")),g.user=S(b[1]||""),g.pass=S(b[2]||""),g.port=y[g.protocol]==g.port||0==g.port?"":g.port,!r.protocol&&h.test(I.charAt(0))&&(g.path=I.split("?")[0].split("#")[0]),!r.protocol&&e){var V=new J(p().match(c)[0]),X=V.path.split("/"),K=g.path.split("/"),H=["protocol","user","pass","host","port"],R=H.length;for(X.pop(),Z=0;Z<R;Z++)g[H[Z]]=V[H[Z]];for(;".."===K[0];)X.pop(),K.shift();g.path=("/"!==I.charAt(0)?X.join("/"):"")+"/"+K.join("/")}g.path=g.path.replace(n,"/"),G&&(g.path=g.path.replace(d,"/")),g.paths(g.paths()),g.query=new Y(g.query)}(this,g,!I)}Y.prototype.toString=function(){var g,I,C="",A=V;for(g in this){var t=this[g];if(!(t instanceof Function||void 0===t))if(t instanceof Array){var e=t.length;if(!e){C+=(C?"&":"")+A(g)+"=";continue}for(I=0;I<e;I++){var o=t[I];void 0!==o&&(C+=C?"&":"",C+=A(g)+(null===o?"":"="+A(o)))}}else C+=C?"&":"",C+=A(g)+(null===t?"":"="+A(t))}return C},J.prototype.clearQuery=function(){for(var g in this.query)this.query[g]instanceof Function||delete this.query[g];return this},J.prototype.queryLength=function(){var g=0;for(var I in this.query)this.query[I]instanceof Function||g++;return g},J.prototype.isEmptyQuery=function(){return 0===this.queryLength()},J.prototype.paths=function(g){var I,C="",A=0;if(g&&g.length&&g+""!==g){for(this.isAbsolute()&&(C="/"),I=g.length;A<I;A++)g[A]=!A&&r.test(g[A])?g[A]:V(g[A]);this.path=C+g.join("/")}for(A=0,I=(g=("/"===this.path.charAt(0)?this.path.slice(1):this.path).split("/")).length;A<I;A++)g[A]=S(g[A]);return g},J.prototype.encode=V,J.prototype.decode=S,J.prototype.isAbsolute=function(){return this.protocol||"/"===this.path.charAt(0)},J.prototype.toString=function(){return(this.protocol&&this.protocol+"://")+(this.user&&V(this.user)+(this.pass&&":"+V(this.pass))+"@")+(this.host&&this.host)+(this.port&&":"+this.port)+(this.path&&this.path)+(this.query.toString()&&"?"+this.query)+(this.hash&&"#"+V(this.hash))},g[g.exports?"exports":"Url"]=J}(module.exports?module:window);var DOMUrl=url_min.exports;function createBase64SharedWorkerFactory(g,I,C){var A;return function(t){return A=A||createURL(g,I,C),new SharedWorker(A,t)}}var WorkerFactory=createBase64SharedWorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewoJJ3VzZSBzdHJpY3QnOwoKCXZhciBjb21tb25qc0dsb2JhbCA9IHR5cGVvZiBnbG9iYWxUaGlzICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbFRoaXMgOiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnID8gc2VsZiA6IHt9OwoKCXZhciBpbmRleE1pbmltYWwgPSB7fTsKCgl2YXIgbWluaW1hbCQxID0ge307CgoJdmFyIGFzcHJvbWlzZSA9IGFzUHJvbWlzZTsNCg0KCS8qKg0KCSAqIENhbGxiYWNrIGFzIHVzZWQgYnkge0BsaW5rIHV0aWwuYXNQcm9taXNlfS4NCgkgKiBAdHlwZWRlZiBhc1Byb21pc2VDYWxsYmFjaw0KCSAqIEB0eXBlIHtmdW5jdGlvbn0NCgkgKiBAcGFyYW0ge0Vycm9yfG51bGx9IGVycm9yIEVycm9yLCBpZiBhbnkNCgkgKiBAcGFyYW0gey4uLip9IHBhcmFtcyBBZGRpdGlvbmFsIGFyZ3VtZW50cw0KCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9DQoJICovDQoNCgkvKioNCgkgKiBSZXR1cm5zIGEgcHJvbWlzZSBmcm9tIGEgbm9kZS1zdHlsZSBjYWxsYmFjayBmdW5jdGlvbi4NCgkgKiBAbWVtYmVyb2YgdXRpbA0KCSAqIEBwYXJhbSB7YXNQcm9taXNlQ2FsbGJhY2t9IGZuIEZ1bmN0aW9uIHRvIGNhbGwNCgkgKiBAcGFyYW0geyp9IGN0eCBGdW5jdGlvbiBjb250ZXh0DQoJICogQHBhcmFtIHsuLi4qfSBwYXJhbXMgRnVuY3Rpb24gYXJndW1lbnRzDQoJICogQHJldHVybnMge1Byb21pc2U8Kj59IFByb21pc2lmaWVkIGZ1bmN0aW9uDQoJICovDQoJZnVuY3Rpb24gYXNQcm9taXNlKGZuLCBjdHgvKiwgdmFyYXJncyAqLykgew0KCSAgICB2YXIgcGFyYW1zICA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSksDQoJICAgICAgICBvZmZzZXQgID0gMCwNCgkgICAgICAgIGluZGV4ICAgPSAyLA0KCSAgICAgICAgcGVuZGluZyA9IHRydWU7DQoJICAgIHdoaWxlIChpbmRleCA8IGFyZ3VtZW50cy5sZW5ndGgpDQoJICAgICAgICBwYXJhbXNbb2Zmc2V0KytdID0gYXJndW1lbnRzW2luZGV4KytdOw0KCSAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gZXhlY3V0b3IocmVzb2x2ZSwgcmVqZWN0KSB7DQoJICAgICAgICBwYXJhbXNbb2Zmc2V0XSA9IGZ1bmN0aW9uIGNhbGxiYWNrKGVyci8qLCB2YXJhcmdzICovKSB7DQoJICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsNCgkgICAgICAgICAgICAgICAgcGVuZGluZyA9IGZhbHNlOw0KCSAgICAgICAgICAgICAgICBpZiAoZXJyKQ0KCSAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7DQoJICAgICAgICAgICAgICAgIGVsc2Ugew0KCSAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSksDQoJICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gMDsNCgkgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBwYXJhbXMubGVuZ3RoKQ0KCSAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1tvZmZzZXQrK10gPSBhcmd1bWVudHNbb2Zmc2V0XTsNCgkgICAgICAgICAgICAgICAgICAgIHJlc29sdmUuYXBwbHkobnVsbCwgcGFyYW1zKTsNCgkgICAgICAgICAgICAgICAgfQ0KCSAgICAgICAgICAgIH0NCgkgICAgICAgIH07DQoJICAgICAgICB0cnkgew0KCSAgICAgICAgICAgIGZuLmFwcGx5KGN0eCB8fCBudWxsLCBwYXJhbXMpOw0KCSAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQoJICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsNCgkgICAgICAgICAgICAgICAgcGVuZGluZyA9IGZhbHNlOw0KCSAgICAgICAgICAgICAgICByZWplY3QoZXJyKTsNCgkgICAgICAgICAgICB9DQoJICAgICAgICB9DQoJICAgIH0pOw0KCX0KCgl2YXIgYmFzZTY0JDEgPSB7fTsKCgkoZnVuY3Rpb24gKGV4cG9ydHMpIHsKDQoJLyoqDQoJICogQSBtaW5pbWFsIGJhc2U2NCBpbXBsZW1lbnRhdGlvbiBmb3IgbnVtYmVyIGFycmF5cy4NCgkgKiBAbWVtYmVyb2YgdXRpbA0KCSAqIEBuYW1lc3BhY2UNCgkgKi8NCgl2YXIgYmFzZTY0ID0gZXhwb3J0czsNCg0KCS8qKg0KCSAqIENhbGN1bGF0ZXMgdGhlIGJ5dGUgbGVuZ3RoIG9mIGEgYmFzZTY0IGVuY29kZWQgc3RyaW5nLg0KCSAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgQmFzZTY0IGVuY29kZWQgc3RyaW5nDQoJICogQHJldHVybnMge251bWJlcn0gQnl0ZSBsZW5ndGgNCgkgKi8NCgliYXNlNjQubGVuZ3RoID0gZnVuY3Rpb24gbGVuZ3RoKHN0cmluZykgew0KCSAgICB2YXIgcCA9IHN0cmluZy5sZW5ndGg7DQoJICAgIGlmICghcCkNCgkgICAgICAgIHJldHVybiAwOw0KCSAgICB2YXIgbiA9IDA7DQoJICAgIHdoaWxlICgtLXAgJSA0ID4gMSAmJiBzdHJpbmcuY2hhckF0KHApID09PSAiPSIpDQoJICAgICAgICArK247DQoJICAgIHJldHVybiBNYXRoLmNlaWwoc3RyaW5nLmxlbmd0aCAqIDMpIC8gNCAtIG47DQoJfTsNCg0KCS8vIEJhc2U2NCBlbmNvZGluZyB0YWJsZQ0KCXZhciBiNjQgPSBuZXcgQXJyYXkoNjQpOw0KDQoJLy8gQmFzZTY0IGRlY29kaW5nIHRhYmxlDQoJdmFyIHM2NCA9IG5ldyBBcnJheSgxMjMpOw0KDQoJLy8gNjUuLjkwLCA5Ny4uMTIyLCA0OC4uNTcsIDQzLCA0Nw0KCWZvciAodmFyIGkgPSAwOyBpIDwgNjQ7KQ0KCSAgICBzNjRbYjY0W2ldID0gaSA8IDI2ID8gaSArIDY1IDogaSA8IDUyID8gaSArIDcxIDogaSA8IDYyID8gaSAtIDQgOiBpIC0gNTkgfCA0M10gPSBpKys7DQoNCgkvKioNCgkgKiBFbmNvZGVzIGEgYnVmZmVyIHRvIGEgYmFzZTY0IGVuY29kZWQgc3RyaW5nLg0KCSAqIEBwYXJhbSB7VWludDhBcnJheX0gYnVmZmVyIFNvdXJjZSBidWZmZXINCgkgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgU291cmNlIHN0YXJ0DQoJICogQHBhcmFtIHtudW1iZXJ9IGVuZCBTb3VyY2UgZW5kDQoJICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0IGVuY29kZWQgc3RyaW5nDQoJICovDQoJYmFzZTY0LmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShidWZmZXIsIHN0YXJ0LCBlbmQpIHsNCgkgICAgdmFyIHBhcnRzID0gbnVsbCwNCgkgICAgICAgIGNodW5rID0gW107DQoJICAgIHZhciBpID0gMCwgLy8gb3V0cHV0IGluZGV4DQoJICAgICAgICBqID0gMCwgLy8gZ290byBpbmRleA0KCSAgICAgICAgdDsgICAgIC8vIHRlbXBvcmFyeQ0KCSAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsNCgkgICAgICAgIHZhciBiID0gYnVmZmVyW3N0YXJ0KytdOw0KCSAgICAgICAgc3dpdGNoIChqKSB7DQoJICAgICAgICAgICAgY2FzZSAwOg0KCSAgICAgICAgICAgICAgICBjaHVua1tpKytdID0gYjY0W2IgPj4gMl07DQoJICAgICAgICAgICAgICAgIHQgPSAoYiAmIDMpIDw8IDQ7DQoJICAgICAgICAgICAgICAgIGogPSAxOw0KCSAgICAgICAgICAgICAgICBicmVhazsNCgkgICAgICAgICAgICBjYXNlIDE6DQoJICAgICAgICAgICAgICAgIGNodW5rW2krK10gPSBiNjRbdCB8IGIgPj4gNF07DQoJICAgICAgICAgICAgICAgIHQgPSAoYiAmIDE1KSA8PCAyOw0KCSAgICAgICAgICAgICAgICBqID0gMjsNCgkgICAgICAgICAgICAgICAgYnJlYWs7DQoJICAgICAgICAgICAgY2FzZSAyOg0KCSAgICAgICAgICAgICAgICBjaHVua1tpKytdID0gYjY0W3QgfCBiID4+IDZdOw0KCSAgICAgICAgICAgICAgICBjaHVua1tpKytdID0gYjY0W2IgJiA2M107DQoJICAgICAgICAgICAgICAgIGogPSAwOw0KCSAgICAgICAgICAgICAgICBicmVhazsNCgkgICAgICAgIH0NCgkgICAgICAgIGlmIChpID4gODE5MSkgew0KCSAgICAgICAgICAgIChwYXJ0cyB8fCAocGFydHMgPSBbXSkpLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNodW5rKSk7DQoJICAgICAgICAgICAgaSA9IDA7DQoJICAgICAgICB9DQoJICAgIH0NCgkgICAgaWYgKGopIHsNCgkgICAgICAgIGNodW5rW2krK10gPSBiNjRbdF07DQoJICAgICAgICBjaHVua1tpKytdID0gNjE7DQoJICAgICAgICBpZiAoaiA9PT0gMSkNCgkgICAgICAgICAgICBjaHVua1tpKytdID0gNjE7DQoJICAgIH0NCgkgICAgaWYgKHBhcnRzKSB7DQoJICAgICAgICBpZiAoaSkNCgkgICAgICAgICAgICBwYXJ0cy5wdXNoKFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBjaHVuay5zbGljZSgwLCBpKSkpOw0KCSAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oIiIpOw0KCSAgICB9DQoJICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY2h1bmsuc2xpY2UoMCwgaSkpOw0KCX07DQoNCgl2YXIgaW52YWxpZEVuY29kaW5nID0gImludmFsaWQgZW5jb2RpbmciOw0KDQoJLyoqDQoJICogRGVjb2RlcyBhIGJhc2U2NCBlbmNvZGVkIHN0cmluZyB0byBhIGJ1ZmZlci4NCgkgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFNvdXJjZSBzdHJpbmcNCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZmZlciBEZXN0aW5hdGlvbiBidWZmZXINCgkgKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0IERlc3RpbmF0aW9uIG9mZnNldA0KCSAqIEByZXR1cm5zIHtudW1iZXJ9IE51bWJlciBvZiBieXRlcyB3cml0dGVuDQoJICogQHRocm93cyB7RXJyb3J9IElmIGVuY29kaW5nIGlzIGludmFsaWQNCgkgKi8NCgliYXNlNjQuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHN0cmluZywgYnVmZmVyLCBvZmZzZXQpIHsNCgkgICAgdmFyIHN0YXJ0ID0gb2Zmc2V0Ow0KCSAgICB2YXIgaiA9IDAsIC8vIGdvdG8gaW5kZXgNCgkgICAgICAgIHQ7ICAgICAvLyB0ZW1wb3JhcnkNCgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHJpbmcubGVuZ3RoOykgew0KCSAgICAgICAgdmFyIGMgPSBzdHJpbmcuY2hhckNvZGVBdChpKyspOw0KCSAgICAgICAgaWYgKGMgPT09IDYxICYmIGogPiAxKQ0KCSAgICAgICAgICAgIGJyZWFrOw0KCSAgICAgICAgaWYgKChjID0gczY0W2NdKSA9PT0gdW5kZWZpbmVkKQ0KCSAgICAgICAgICAgIHRocm93IEVycm9yKGludmFsaWRFbmNvZGluZyk7DQoJICAgICAgICBzd2l0Y2ggKGopIHsNCgkgICAgICAgICAgICBjYXNlIDA6DQoJICAgICAgICAgICAgICAgIHQgPSBjOw0KCSAgICAgICAgICAgICAgICBqID0gMTsNCgkgICAgICAgICAgICAgICAgYnJlYWs7DQoJICAgICAgICAgICAgY2FzZSAxOg0KCSAgICAgICAgICAgICAgICBidWZmZXJbb2Zmc2V0KytdID0gdCA8PCAyIHwgKGMgJiA0OCkgPj4gNDsNCgkgICAgICAgICAgICAgICAgdCA9IGM7DQoJICAgICAgICAgICAgICAgIGogPSAyOw0KCSAgICAgICAgICAgICAgICBicmVhazsNCgkgICAgICAgICAgICBjYXNlIDI6DQoJICAgICAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSAodCAmIDE1KSA8PCA0IHwgKGMgJiA2MCkgPj4gMjsNCgkgICAgICAgICAgICAgICAgdCA9IGM7DQoJICAgICAgICAgICAgICAgIGogPSAzOw0KCSAgICAgICAgICAgICAgICBicmVhazsNCgkgICAgICAgICAgICBjYXNlIDM6DQoJICAgICAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSAodCAmIDMpIDw8IDYgfCBjOw0KCSAgICAgICAgICAgICAgICBqID0gMDsNCgkgICAgICAgICAgICAgICAgYnJlYWs7DQoJICAgICAgICB9DQoJICAgIH0NCgkgICAgaWYgKGogPT09IDEpDQoJICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkRW5jb2RpbmcpOw0KCSAgICByZXR1cm4gb2Zmc2V0IC0gc3RhcnQ7DQoJfTsNCg0KCS8qKg0KCSAqIFRlc3RzIGlmIHRoZSBzcGVjaWZpZWQgc3RyaW5nIGFwcGVhcnMgdG8gYmUgYmFzZTY0IGVuY29kZWQuDQoJICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gdGVzdA0KCSAqIEByZXR1cm5zIHtib29sZWFufSBgdHJ1ZWAgaWYgcHJvYmFibHkgYmFzZTY0IGVuY29kZWQsIG90aGVyd2lzZSBmYWxzZQ0KCSAqLw0KCWJhc2U2NC50ZXN0ID0gZnVuY3Rpb24gdGVzdChzdHJpbmcpIHsNCgkgICAgcmV0dXJuIC9eKD86W0EtWmEtejAtOSsvXXs0fSkqKD86W0EtWmEtejAtOSsvXXsyfT09fFtBLVphLXowLTkrL117M309KT8kLy50ZXN0KHN0cmluZyk7DQoJfTsKCX0oYmFzZTY0JDEpKTsKCgl2YXIgZXZlbnRlbWl0dGVyID0gRXZlbnRFbWl0dGVyOw0KDQoJLyoqDQoJICogQ29uc3RydWN0cyBhIG5ldyBldmVudCBlbWl0dGVyIGluc3RhbmNlLg0KCSAqIEBjbGFzc2Rlc2MgQSBtaW5pbWFsIGV2ZW50IGVtaXR0ZXIuDQoJICogQG1lbWJlcm9mIHV0aWwNCgkgKiBAY29uc3RydWN0b3INCgkgKi8NCglmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7DQoNCgkgICAgLyoqDQoJICAgICAqIFJlZ2lzdGVyZWQgbGlzdGVuZXJzLg0KCSAgICAgKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsKj59DQoJICAgICAqIEBwcml2YXRlDQoJICAgICAqLw0KCSAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsNCgl9DQoNCgkvKioNCgkgKiBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIuDQoJICogQHBhcmFtIHtzdHJpbmd9IGV2dCBFdmVudCBuYW1lDQoJICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gTGlzdGVuZXINCgkgKiBAcGFyYW0geyp9IFtjdHhdIExpc3RlbmVyIGNvbnRleHQNCgkgKiBAcmV0dXJucyB7dXRpbC5FdmVudEVtaXR0ZXJ9IGB0aGlzYA0KCSAqLw0KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldnQsIGZuLCBjdHgpIHsNCgkgICAgKHRoaXMuX2xpc3RlbmVyc1tldnRdIHx8ICh0aGlzLl9saXN0ZW5lcnNbZXZ0XSA9IFtdKSkucHVzaCh7DQoJICAgICAgICBmbiAgOiBmbiwNCgkgICAgICAgIGN0eCA6IGN0eCB8fCB0aGlzDQoJICAgIH0pOw0KCSAgICByZXR1cm4gdGhpczsNCgl9Ow0KDQoJLyoqDQoJICogUmVtb3ZlcyBhbiBldmVudCBsaXN0ZW5lciBvciBhbnkgbWF0Y2hpbmcgbGlzdGVuZXJzIGlmIGFyZ3VtZW50cyBhcmUgb21pdHRlZC4NCgkgKiBAcGFyYW0ge3N0cmluZ30gW2V2dF0gRXZlbnQgbmFtZS4gUmVtb3ZlcyBhbGwgbGlzdGVuZXJzIGlmIG9taXR0ZWQuDQoJICogQHBhcmFtIHtmdW5jdGlvbn0gW2ZuXSBMaXN0ZW5lciB0byByZW1vdmUuIFJlbW92ZXMgYWxsIGxpc3RlbmVycyBvZiBgZXZ0YCBpZiBvbWl0dGVkLg0KCSAqIEByZXR1cm5zIHt1dGlsLkV2ZW50RW1pdHRlcn0gYHRoaXNgDQoJICovDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbiBvZmYoZXZ0LCBmbikgew0KCSAgICBpZiAoZXZ0ID09PSB1bmRlZmluZWQpDQoJICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsNCgkgICAgZWxzZSB7DQoJICAgICAgICBpZiAoZm4gPT09IHVuZGVmaW5lZCkNCgkgICAgICAgICAgICB0aGlzLl9saXN0ZW5lcnNbZXZ0XSA9IFtdOw0KCSAgICAgICAgZWxzZSB7DQoJICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyc1tldnRdOw0KCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDspDQoJICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0uZm4gPT09IGZuKQ0KCSAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsNCgkgICAgICAgICAgICAgICAgZWxzZQ0KCSAgICAgICAgICAgICAgICAgICAgKytpOw0KCSAgICAgICAgfQ0KCSAgICB9DQoJICAgIHJldHVybiB0aGlzOw0KCX07DQoNCgkvKioNCgkgKiBFbWl0cyBhbiBldmVudCBieSBjYWxsaW5nIGl0cyBsaXN0ZW5lcnMgd2l0aCB0aGUgc3BlY2lmaWVkIGFyZ3VtZW50cy4NCgkgKiBAcGFyYW0ge3N0cmluZ30gZXZ0IEV2ZW50IG5hbWUNCgkgKiBAcGFyYW0gey4uLip9IGFyZ3MgQXJndW1lbnRzDQoJICogQHJldHVybnMge3V0aWwuRXZlbnRFbWl0dGVyfSBgdGhpc2ANCgkgKi8NCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbiBlbWl0KGV2dCkgew0KCSAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzW2V2dF07DQoJICAgIGlmIChsaXN0ZW5lcnMpIHsNCgkgICAgICAgIHZhciBhcmdzID0gW10sDQoJICAgICAgICAgICAgaSA9IDE7DQoJICAgICAgICBmb3IgKDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7KQ0KCSAgICAgICAgICAgIGFyZ3MucHVzaChhcmd1bWVudHNbaSsrXSk7DQoJICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDspDQoJICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpKytdLmN0eCwgYXJncyk7DQoJICAgIH0NCgkgICAgcmV0dXJuIHRoaXM7DQoJfTsKCgl2YXIgZmxvYXQgPSBmYWN0b3J5KGZhY3RvcnkpOw0KDQoJLyoqDQoJICogUmVhZHMgLyB3cml0ZXMgZmxvYXRzIC8gZG91YmxlcyBmcm9tIC8gdG8gYnVmZmVycy4NCgkgKiBAbmFtZSB1dGlsLmZsb2F0DQoJICogQG5hbWVzcGFjZQ0KCSAqLw0KDQoJLyoqDQoJICogV3JpdGVzIGEgMzIgYml0IGZsb2F0IHRvIGEgYnVmZmVyIHVzaW5nIGxpdHRsZSBlbmRpYW4gYnl0ZSBvcmRlci4NCgkgKiBAbmFtZSB1dGlsLmZsb2F0LndyaXRlRmxvYXRMRQ0KCSAqIEBmdW5jdGlvbg0KCSAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgVmFsdWUgdG8gd3JpdGUNCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZiBUYXJnZXQgYnVmZmVyDQoJICogQHBhcmFtIHtudW1iZXJ9IHBvcyBUYXJnZXQgYnVmZmVyIG9mZnNldA0KCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9DQoJICovDQoNCgkvKioNCgkgKiBXcml0ZXMgYSAzMiBiaXQgZmxvYXQgdG8gYSBidWZmZXIgdXNpbmcgYmlnIGVuZGlhbiBieXRlIG9yZGVyLg0KCSAqIEBuYW1lIHV0aWwuZmxvYXQud3JpdGVGbG9hdEJFDQoJICogQGZ1bmN0aW9uDQoJICogQHBhcmFtIHtudW1iZXJ9IHZhbCBWYWx1ZSB0byB3cml0ZQ0KCSAqIEBwYXJhbSB7VWludDhBcnJheX0gYnVmIFRhcmdldCBidWZmZXINCgkgKiBAcGFyYW0ge251bWJlcn0gcG9zIFRhcmdldCBidWZmZXIgb2Zmc2V0DQoJICogQHJldHVybnMge3VuZGVmaW5lZH0NCgkgKi8NCg0KCS8qKg0KCSAqIFJlYWRzIGEgMzIgYml0IGZsb2F0IGZyb20gYSBidWZmZXIgdXNpbmcgbGl0dGxlIGVuZGlhbiBieXRlIG9yZGVyLg0KCSAqIEBuYW1lIHV0aWwuZmxvYXQucmVhZEZsb2F0TEUNCgkgKiBAZnVuY3Rpb24NCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZiBTb3VyY2UgYnVmZmVyDQoJICogQHBhcmFtIHtudW1iZXJ9IHBvcyBTb3VyY2UgYnVmZmVyIG9mZnNldA0KCSAqIEByZXR1cm5zIHtudW1iZXJ9IFZhbHVlIHJlYWQNCgkgKi8NCg0KCS8qKg0KCSAqIFJlYWRzIGEgMzIgYml0IGZsb2F0IGZyb20gYSBidWZmZXIgdXNpbmcgYmlnIGVuZGlhbiBieXRlIG9yZGVyLg0KCSAqIEBuYW1lIHV0aWwuZmxvYXQucmVhZEZsb2F0QkUNCgkgKiBAZnVuY3Rpb24NCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZiBTb3VyY2UgYnVmZmVyDQoJICogQHBhcmFtIHtudW1iZXJ9IHBvcyBTb3VyY2UgYnVmZmVyIG9mZnNldA0KCSAqIEByZXR1cm5zIHtudW1iZXJ9IFZhbHVlIHJlYWQNCgkgKi8NCg0KCS8qKg0KCSAqIFdyaXRlcyBhIDY0IGJpdCBkb3VibGUgdG8gYSBidWZmZXIgdXNpbmcgbGl0dGxlIGVuZGlhbiBieXRlIG9yZGVyLg0KCSAqIEBuYW1lIHV0aWwuZmxvYXQud3JpdGVEb3VibGVMRQ0KCSAqIEBmdW5jdGlvbg0KCSAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgVmFsdWUgdG8gd3JpdGUNCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZiBUYXJnZXQgYnVmZmVyDQoJICogQHBhcmFtIHtudW1iZXJ9IHBvcyBUYXJnZXQgYnVmZmVyIG9mZnNldA0KCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9DQoJICovDQoNCgkvKioNCgkgKiBXcml0ZXMgYSA2NCBiaXQgZG91YmxlIHRvIGEgYnVmZmVyIHVzaW5nIGJpZyBlbmRpYW4gYnl0ZSBvcmRlci4NCgkgKiBAbmFtZSB1dGlsLmZsb2F0LndyaXRlRG91YmxlQkUNCgkgKiBAZnVuY3Rpb24NCgkgKiBAcGFyYW0ge251bWJlcn0gdmFsIFZhbHVlIHRvIHdyaXRlDQoJICogQHBhcmFtIHtVaW50OEFycmF5fSBidWYgVGFyZ2V0IGJ1ZmZlcg0KCSAqIEBwYXJhbSB7bnVtYmVyfSBwb3MgVGFyZ2V0IGJ1ZmZlciBvZmZzZXQNCgkgKiBAcmV0dXJucyB7dW5kZWZpbmVkfQ0KCSAqLw0KDQoJLyoqDQoJICogUmVhZHMgYSA2NCBiaXQgZG91YmxlIGZyb20gYSBidWZmZXIgdXNpbmcgbGl0dGxlIGVuZGlhbiBieXRlIG9yZGVyLg0KCSAqIEBuYW1lIHV0aWwuZmxvYXQucmVhZERvdWJsZUxFDQoJICogQGZ1bmN0aW9uDQoJICogQHBhcmFtIHtVaW50OEFycmF5fSBidWYgU291cmNlIGJ1ZmZlcg0KCSAqIEBwYXJhbSB7bnVtYmVyfSBwb3MgU291cmNlIGJ1ZmZlciBvZmZzZXQNCgkgKiBAcmV0dXJucyB7bnVtYmVyfSBWYWx1ZSByZWFkDQoJICovDQoNCgkvKioNCgkgKiBSZWFkcyBhIDY0IGJpdCBkb3VibGUgZnJvbSBhIGJ1ZmZlciB1c2luZyBiaWcgZW5kaWFuIGJ5dGUgb3JkZXIuDQoJICogQG5hbWUgdXRpbC5mbG9hdC5yZWFkRG91YmxlQkUNCgkgKiBAZnVuY3Rpb24NCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZiBTb3VyY2UgYnVmZmVyDQoJICogQHBhcmFtIHtudW1iZXJ9IHBvcyBTb3VyY2UgYnVmZmVyIG9mZnNldA0KCSAqIEByZXR1cm5zIHtudW1iZXJ9IFZhbHVlIHJlYWQNCgkgKi8NCg0KCS8vIEZhY3RvcnkgZnVuY3Rpb24gZm9yIHRoZSBwdXJwb3NlIG9mIG5vZGUtYmFzZWQgdGVzdGluZyBpbiBtb2RpZmllZCBnbG9iYWwgZW52aXJvbm1lbnRzDQoJZnVuY3Rpb24gZmFjdG9yeShleHBvcnRzKSB7DQoNCgkgICAgLy8gZmxvYXQ6IHR5cGVkIGFycmF5DQoJICAgIGlmICh0eXBlb2YgRmxvYXQzMkFycmF5ICE9PSAidW5kZWZpbmVkIikgKGZ1bmN0aW9uKCkgew0KDQoJICAgICAgICB2YXIgZjMyID0gbmV3IEZsb2F0MzJBcnJheShbIC0wIF0pLA0KCSAgICAgICAgICAgIGY4YiA9IG5ldyBVaW50OEFycmF5KGYzMi5idWZmZXIpLA0KCSAgICAgICAgICAgIGxlICA9IGY4YlszXSA9PT0gMTI4Ow0KDQoJICAgICAgICBmdW5jdGlvbiB3cml0ZUZsb2F0X2YzMl9jcHkodmFsLCBidWYsIHBvcykgew0KCSAgICAgICAgICAgIGYzMlswXSA9IHZhbDsNCgkgICAgICAgICAgICBidWZbcG9zICAgIF0gPSBmOGJbMF07DQoJICAgICAgICAgICAgYnVmW3BvcyArIDFdID0gZjhiWzFdOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgKyAyXSA9IGY4YlsyXTsNCgkgICAgICAgICAgICBidWZbcG9zICsgM10gPSBmOGJbM107DQoJICAgICAgICB9DQoNCgkgICAgICAgIGZ1bmN0aW9uIHdyaXRlRmxvYXRfZjMyX3Jldih2YWwsIGJ1ZiwgcG9zKSB7DQoJICAgICAgICAgICAgZjMyWzBdID0gdmFsOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgICAgXSA9IGY4YlszXTsNCgkgICAgICAgICAgICBidWZbcG9zICsgMV0gPSBmOGJbMl07DQoJICAgICAgICAgICAgYnVmW3BvcyArIDJdID0gZjhiWzFdOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgKyAzXSA9IGY4YlswXTsNCgkgICAgICAgIH0NCg0KCSAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8NCgkgICAgICAgIGV4cG9ydHMud3JpdGVGbG9hdExFID0gbGUgPyB3cml0ZUZsb2F0X2YzMl9jcHkgOiB3cml0ZUZsb2F0X2YzMl9yZXY7DQoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLw0KCSAgICAgICAgZXhwb3J0cy53cml0ZUZsb2F0QkUgPSBsZSA/IHdyaXRlRmxvYXRfZjMyX3JldiA6IHdyaXRlRmxvYXRfZjMyX2NweTsNCg0KCSAgICAgICAgZnVuY3Rpb24gcmVhZEZsb2F0X2YzMl9jcHkoYnVmLCBwb3MpIHsNCgkgICAgICAgICAgICBmOGJbMF0gPSBidWZbcG9zICAgIF07DQoJICAgICAgICAgICAgZjhiWzFdID0gYnVmW3BvcyArIDFdOw0KCSAgICAgICAgICAgIGY4YlsyXSA9IGJ1Zltwb3MgKyAyXTsNCgkgICAgICAgICAgICBmOGJbM10gPSBidWZbcG9zICsgM107DQoJICAgICAgICAgICAgcmV0dXJuIGYzMlswXTsNCgkgICAgICAgIH0NCg0KCSAgICAgICAgZnVuY3Rpb24gcmVhZEZsb2F0X2YzMl9yZXYoYnVmLCBwb3MpIHsNCgkgICAgICAgICAgICBmOGJbM10gPSBidWZbcG9zICAgIF07DQoJICAgICAgICAgICAgZjhiWzJdID0gYnVmW3BvcyArIDFdOw0KCSAgICAgICAgICAgIGY4YlsxXSA9IGJ1Zltwb3MgKyAyXTsNCgkgICAgICAgICAgICBmOGJbMF0gPSBidWZbcG9zICsgM107DQoJICAgICAgICAgICAgcmV0dXJuIGYzMlswXTsNCgkgICAgICAgIH0NCg0KCSAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8NCgkgICAgICAgIGV4cG9ydHMucmVhZEZsb2F0TEUgPSBsZSA/IHJlYWRGbG9hdF9mMzJfY3B5IDogcmVhZEZsb2F0X2YzMl9yZXY7DQoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLw0KCSAgICAgICAgZXhwb3J0cy5yZWFkRmxvYXRCRSA9IGxlID8gcmVhZEZsb2F0X2YzMl9yZXYgOiByZWFkRmxvYXRfZjMyX2NweTsNCg0KCSAgICAvLyBmbG9hdDogaWVlZTc1NA0KCSAgICB9KSgpOyBlbHNlIChmdW5jdGlvbigpIHsNCg0KCSAgICAgICAgZnVuY3Rpb24gd3JpdGVGbG9hdF9pZWVlNzU0KHdyaXRlVWludCwgdmFsLCBidWYsIHBvcykgew0KCSAgICAgICAgICAgIHZhciBzaWduID0gdmFsIDwgMCA/IDEgOiAwOw0KCSAgICAgICAgICAgIGlmIChzaWduKQ0KCSAgICAgICAgICAgICAgICB2YWwgPSAtdmFsOw0KCSAgICAgICAgICAgIGlmICh2YWwgPT09IDApDQoJICAgICAgICAgICAgICAgIHdyaXRlVWludCgxIC8gdmFsID4gMCA/IC8qIHBvc2l0aXZlICovIDAgOiAvKiBuZWdhdGl2ZSAwICovIDIxNDc0ODM2NDgsIGJ1ZiwgcG9zKTsNCgkgICAgICAgICAgICBlbHNlIGlmIChpc05hTih2YWwpKQ0KCSAgICAgICAgICAgICAgICB3cml0ZVVpbnQoMjE0MzI4OTM0NCwgYnVmLCBwb3MpOw0KCSAgICAgICAgICAgIGVsc2UgaWYgKHZhbCA+IDMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgpIC8vICstSW5maW5pdHkNCgkgICAgICAgICAgICAgICAgd3JpdGVVaW50KChzaWduIDw8IDMxIHwgMjEzOTA5NTA0MCkgPj4+IDAsIGJ1ZiwgcG9zKTsNCgkgICAgICAgICAgICBlbHNlIGlmICh2YWwgPCAxLjE3NTQ5NDM1MDgyMjI4NzVlLTM4KSAvLyBkZW5vcm1hbA0KCSAgICAgICAgICAgICAgICB3cml0ZVVpbnQoKHNpZ24gPDwgMzEgfCBNYXRoLnJvdW5kKHZhbCAvIDEuNDAxMjk4NDY0MzI0ODE3ZS00NSkpID4+PiAwLCBidWYsIHBvcyk7DQoJICAgICAgICAgICAgZWxzZSB7DQoJICAgICAgICAgICAgICAgIHZhciBleHBvbmVudCA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsKSAvIE1hdGguTE4yKSwNCgkgICAgICAgICAgICAgICAgICAgIG1hbnRpc3NhID0gTWF0aC5yb3VuZCh2YWwgKiBNYXRoLnBvdygyLCAtZXhwb25lbnQpICogODM4ODYwOCkgJiA4Mzg4NjA3Ow0KCSAgICAgICAgICAgICAgICB3cml0ZVVpbnQoKHNpZ24gPDwgMzEgfCBleHBvbmVudCArIDEyNyA8PCAyMyB8IG1hbnRpc3NhKSA+Pj4gMCwgYnVmLCBwb3MpOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgIH0NCg0KCSAgICAgICAgZXhwb3J0cy53cml0ZUZsb2F0TEUgPSB3cml0ZUZsb2F0X2llZWU3NTQuYmluZChudWxsLCB3cml0ZVVpbnRMRSk7DQoJICAgICAgICBleHBvcnRzLndyaXRlRmxvYXRCRSA9IHdyaXRlRmxvYXRfaWVlZTc1NC5iaW5kKG51bGwsIHdyaXRlVWludEJFKTsNCg0KCSAgICAgICAgZnVuY3Rpb24gcmVhZEZsb2F0X2llZWU3NTQocmVhZFVpbnQsIGJ1ZiwgcG9zKSB7DQoJICAgICAgICAgICAgdmFyIHVpbnQgPSByZWFkVWludChidWYsIHBvcyksDQoJICAgICAgICAgICAgICAgIHNpZ24gPSAodWludCA+PiAzMSkgKiAyICsgMSwNCgkgICAgICAgICAgICAgICAgZXhwb25lbnQgPSB1aW50ID4+PiAyMyAmIDI1NSwNCgkgICAgICAgICAgICAgICAgbWFudGlzc2EgPSB1aW50ICYgODM4ODYwNzsNCgkgICAgICAgICAgICByZXR1cm4gZXhwb25lbnQgPT09IDI1NQ0KCSAgICAgICAgICAgICAgICA/IG1hbnRpc3NhDQoJICAgICAgICAgICAgICAgID8gTmFODQoJICAgICAgICAgICAgICAgIDogc2lnbiAqIEluZmluaXR5DQoJICAgICAgICAgICAgICAgIDogZXhwb25lbnQgPT09IDAgLy8gZGVub3JtYWwNCgkgICAgICAgICAgICAgICAgPyBzaWduICogMS40MDEyOTg0NjQzMjQ4MTdlLTQ1ICogbWFudGlzc2ENCgkgICAgICAgICAgICAgICAgOiBzaWduICogTWF0aC5wb3coMiwgZXhwb25lbnQgLSAxNTApICogKG1hbnRpc3NhICsgODM4ODYwOCk7DQoJICAgICAgICB9DQoNCgkgICAgICAgIGV4cG9ydHMucmVhZEZsb2F0TEUgPSByZWFkRmxvYXRfaWVlZTc1NC5iaW5kKG51bGwsIHJlYWRVaW50TEUpOw0KCSAgICAgICAgZXhwb3J0cy5yZWFkRmxvYXRCRSA9IHJlYWRGbG9hdF9pZWVlNzU0LmJpbmQobnVsbCwgcmVhZFVpbnRCRSk7DQoNCgkgICAgfSkoKTsNCg0KCSAgICAvLyBkb3VibGU6IHR5cGVkIGFycmF5DQoJICAgIGlmICh0eXBlb2YgRmxvYXQ2NEFycmF5ICE9PSAidW5kZWZpbmVkIikgKGZ1bmN0aW9uKCkgew0KDQoJICAgICAgICB2YXIgZjY0ID0gbmV3IEZsb2F0NjRBcnJheShbLTBdKSwNCgkgICAgICAgICAgICBmOGIgPSBuZXcgVWludDhBcnJheShmNjQuYnVmZmVyKSwNCgkgICAgICAgICAgICBsZSAgPSBmOGJbN10gPT09IDEyODsNCg0KCSAgICAgICAgZnVuY3Rpb24gd3JpdGVEb3VibGVfZjY0X2NweSh2YWwsIGJ1ZiwgcG9zKSB7DQoJICAgICAgICAgICAgZjY0WzBdID0gdmFsOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgICAgXSA9IGY4YlswXTsNCgkgICAgICAgICAgICBidWZbcG9zICsgMV0gPSBmOGJbMV07DQoJICAgICAgICAgICAgYnVmW3BvcyArIDJdID0gZjhiWzJdOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgKyAzXSA9IGY4YlszXTsNCgkgICAgICAgICAgICBidWZbcG9zICsgNF0gPSBmOGJbNF07DQoJICAgICAgICAgICAgYnVmW3BvcyArIDVdID0gZjhiWzVdOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgKyA2XSA9IGY4Yls2XTsNCgkgICAgICAgICAgICBidWZbcG9zICsgN10gPSBmOGJbN107DQoJICAgICAgICB9DQoNCgkgICAgICAgIGZ1bmN0aW9uIHdyaXRlRG91YmxlX2Y2NF9yZXYodmFsLCBidWYsIHBvcykgew0KCSAgICAgICAgICAgIGY2NFswXSA9IHZhbDsNCgkgICAgICAgICAgICBidWZbcG9zICAgIF0gPSBmOGJbN107DQoJICAgICAgICAgICAgYnVmW3BvcyArIDFdID0gZjhiWzZdOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgKyAyXSA9IGY4Yls1XTsNCgkgICAgICAgICAgICBidWZbcG9zICsgM10gPSBmOGJbNF07DQoJICAgICAgICAgICAgYnVmW3BvcyArIDRdID0gZjhiWzNdOw0KCSAgICAgICAgICAgIGJ1Zltwb3MgKyA1XSA9IGY4YlsyXTsNCgkgICAgICAgICAgICBidWZbcG9zICsgNl0gPSBmOGJbMV07DQoJICAgICAgICAgICAgYnVmW3BvcyArIDddID0gZjhiWzBdOw0KCSAgICAgICAgfQ0KDQoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLw0KCSAgICAgICAgZXhwb3J0cy53cml0ZURvdWJsZUxFID0gbGUgPyB3cml0ZURvdWJsZV9mNjRfY3B5IDogd3JpdGVEb3VibGVfZjY0X3JldjsNCgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovDQoJICAgICAgICBleHBvcnRzLndyaXRlRG91YmxlQkUgPSBsZSA/IHdyaXRlRG91YmxlX2Y2NF9yZXYgOiB3cml0ZURvdWJsZV9mNjRfY3B5Ow0KDQoJICAgICAgICBmdW5jdGlvbiByZWFkRG91YmxlX2Y2NF9jcHkoYnVmLCBwb3MpIHsNCgkgICAgICAgICAgICBmOGJbMF0gPSBidWZbcG9zICAgIF07DQoJICAgICAgICAgICAgZjhiWzFdID0gYnVmW3BvcyArIDFdOw0KCSAgICAgICAgICAgIGY4YlsyXSA9IGJ1Zltwb3MgKyAyXTsNCgkgICAgICAgICAgICBmOGJbM10gPSBidWZbcG9zICsgM107DQoJICAgICAgICAgICAgZjhiWzRdID0gYnVmW3BvcyArIDRdOw0KCSAgICAgICAgICAgIGY4Yls1XSA9IGJ1Zltwb3MgKyA1XTsNCgkgICAgICAgICAgICBmOGJbNl0gPSBidWZbcG9zICsgNl07DQoJICAgICAgICAgICAgZjhiWzddID0gYnVmW3BvcyArIDddOw0KCSAgICAgICAgICAgIHJldHVybiBmNjRbMF07DQoJICAgICAgICB9DQoNCgkgICAgICAgIGZ1bmN0aW9uIHJlYWREb3VibGVfZjY0X3JldihidWYsIHBvcykgew0KCSAgICAgICAgICAgIGY4Yls3XSA9IGJ1Zltwb3MgICAgXTsNCgkgICAgICAgICAgICBmOGJbNl0gPSBidWZbcG9zICsgMV07DQoJICAgICAgICAgICAgZjhiWzVdID0gYnVmW3BvcyArIDJdOw0KCSAgICAgICAgICAgIGY4Yls0XSA9IGJ1Zltwb3MgKyAzXTsNCgkgICAgICAgICAgICBmOGJbM10gPSBidWZbcG9zICsgNF07DQoJICAgICAgICAgICAgZjhiWzJdID0gYnVmW3BvcyArIDVdOw0KCSAgICAgICAgICAgIGY4YlsxXSA9IGJ1Zltwb3MgKyA2XTsNCgkgICAgICAgICAgICBmOGJbMF0gPSBidWZbcG9zICsgN107DQoJICAgICAgICAgICAgcmV0dXJuIGY2NFswXTsNCgkgICAgICAgIH0NCg0KCSAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8NCgkgICAgICAgIGV4cG9ydHMucmVhZERvdWJsZUxFID0gbGUgPyByZWFkRG91YmxlX2Y2NF9jcHkgOiByZWFkRG91YmxlX2Y2NF9yZXY7DQoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLw0KCSAgICAgICAgZXhwb3J0cy5yZWFkRG91YmxlQkUgPSBsZSA/IHJlYWREb3VibGVfZjY0X3JldiA6IHJlYWREb3VibGVfZjY0X2NweTsNCg0KCSAgICAvLyBkb3VibGU6IGllZWU3NTQNCgkgICAgfSkoKTsgZWxzZSAoZnVuY3Rpb24oKSB7DQoNCgkgICAgICAgIGZ1bmN0aW9uIHdyaXRlRG91YmxlX2llZWU3NTQod3JpdGVVaW50LCBvZmYwLCBvZmYxLCB2YWwsIGJ1ZiwgcG9zKSB7DQoJICAgICAgICAgICAgdmFyIHNpZ24gPSB2YWwgPCAwID8gMSA6IDA7DQoJICAgICAgICAgICAgaWYgKHNpZ24pDQoJICAgICAgICAgICAgICAgIHZhbCA9IC12YWw7DQoJICAgICAgICAgICAgaWYgKHZhbCA9PT0gMCkgew0KCSAgICAgICAgICAgICAgICB3cml0ZVVpbnQoMCwgYnVmLCBwb3MgKyBvZmYwKTsNCgkgICAgICAgICAgICAgICAgd3JpdGVVaW50KDEgLyB2YWwgPiAwID8gLyogcG9zaXRpdmUgKi8gMCA6IC8qIG5lZ2F0aXZlIDAgKi8gMjE0NzQ4MzY0OCwgYnVmLCBwb3MgKyBvZmYxKTsNCgkgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTmFOKHZhbCkpIHsNCgkgICAgICAgICAgICAgICAgd3JpdGVVaW50KDAsIGJ1ZiwgcG9zICsgb2ZmMCk7DQoJICAgICAgICAgICAgICAgIHdyaXRlVWludCgyMTQ2OTU5MzYwLCBidWYsIHBvcyArIG9mZjEpOw0KCSAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsID4gMS43OTc2OTMxMzQ4NjIzMTU3ZSszMDgpIHsgLy8gKy1JbmZpbml0eQ0KCSAgICAgICAgICAgICAgICB3cml0ZVVpbnQoMCwgYnVmLCBwb3MgKyBvZmYwKTsNCgkgICAgICAgICAgICAgICAgd3JpdGVVaW50KChzaWduIDw8IDMxIHwgMjE0NjQzNTA3MikgPj4+IDAsIGJ1ZiwgcG9zICsgb2ZmMSk7DQoJICAgICAgICAgICAgfSBlbHNlIHsNCgkgICAgICAgICAgICAgICAgdmFyIG1hbnRpc3NhOw0KCSAgICAgICAgICAgICAgICBpZiAodmFsIDwgMi4yMjUwNzM4NTg1MDcyMDE0ZS0zMDgpIHsgLy8gZGVub3JtYWwNCgkgICAgICAgICAgICAgICAgICAgIG1hbnRpc3NhID0gdmFsIC8gNWUtMzI0Ow0KCSAgICAgICAgICAgICAgICAgICAgd3JpdGVVaW50KG1hbnRpc3NhID4+PiAwLCBidWYsIHBvcyArIG9mZjApOw0KCSAgICAgICAgICAgICAgICAgICAgd3JpdGVVaW50KChzaWduIDw8IDMxIHwgbWFudGlzc2EgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCwgYnVmLCBwb3MgKyBvZmYxKTsNCgkgICAgICAgICAgICAgICAgfSBlbHNlIHsNCgkgICAgICAgICAgICAgICAgICAgIHZhciBleHBvbmVudCA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsKSAvIE1hdGguTE4yKTsNCgkgICAgICAgICAgICAgICAgICAgIGlmIChleHBvbmVudCA9PT0gMTAyNCkNCgkgICAgICAgICAgICAgICAgICAgICAgICBleHBvbmVudCA9IDEwMjM7DQoJICAgICAgICAgICAgICAgICAgICBtYW50aXNzYSA9IHZhbCAqIE1hdGgucG93KDIsIC1leHBvbmVudCk7DQoJICAgICAgICAgICAgICAgICAgICB3cml0ZVVpbnQobWFudGlzc2EgKiA0NTAzNTk5NjI3MzcwNDk2ID4+PiAwLCBidWYsIHBvcyArIG9mZjApOw0KCSAgICAgICAgICAgICAgICAgICAgd3JpdGVVaW50KChzaWduIDw8IDMxIHwgZXhwb25lbnQgKyAxMDIzIDw8IDIwIHwgbWFudGlzc2EgKiAxMDQ4NTc2ICYgMTA0ODU3NSkgPj4+IDAsIGJ1ZiwgcG9zICsgb2ZmMSk7DQoJICAgICAgICAgICAgICAgIH0NCgkgICAgICAgICAgICB9DQoJICAgICAgICB9DQoNCgkgICAgICAgIGV4cG9ydHMud3JpdGVEb3VibGVMRSA9IHdyaXRlRG91YmxlX2llZWU3NTQuYmluZChudWxsLCB3cml0ZVVpbnRMRSwgMCwgNCk7DQoJICAgICAgICBleHBvcnRzLndyaXRlRG91YmxlQkUgPSB3cml0ZURvdWJsZV9pZWVlNzU0LmJpbmQobnVsbCwgd3JpdGVVaW50QkUsIDQsIDApOw0KDQoJICAgICAgICBmdW5jdGlvbiByZWFkRG91YmxlX2llZWU3NTQocmVhZFVpbnQsIG9mZjAsIG9mZjEsIGJ1ZiwgcG9zKSB7DQoJICAgICAgICAgICAgdmFyIGxvID0gcmVhZFVpbnQoYnVmLCBwb3MgKyBvZmYwKSwNCgkgICAgICAgICAgICAgICAgaGkgPSByZWFkVWludChidWYsIHBvcyArIG9mZjEpOw0KCSAgICAgICAgICAgIHZhciBzaWduID0gKGhpID4+IDMxKSAqIDIgKyAxLA0KCSAgICAgICAgICAgICAgICBleHBvbmVudCA9IGhpID4+PiAyMCAmIDIwNDcsDQoJICAgICAgICAgICAgICAgIG1hbnRpc3NhID0gNDI5NDk2NzI5NiAqIChoaSAmIDEwNDg1NzUpICsgbG87DQoJICAgICAgICAgICAgcmV0dXJuIGV4cG9uZW50ID09PSAyMDQ3DQoJICAgICAgICAgICAgICAgID8gbWFudGlzc2ENCgkgICAgICAgICAgICAgICAgPyBOYU4NCgkgICAgICAgICAgICAgICAgOiBzaWduICogSW5maW5pdHkNCgkgICAgICAgICAgICAgICAgOiBleHBvbmVudCA9PT0gMCAvLyBkZW5vcm1hbA0KCSAgICAgICAgICAgICAgICA/IHNpZ24gKiA1ZS0zMjQgKiBtYW50aXNzYQ0KCSAgICAgICAgICAgICAgICA6IHNpZ24gKiBNYXRoLnBvdygyLCBleHBvbmVudCAtIDEwNzUpICogKG1hbnRpc3NhICsgNDUwMzU5OTYyNzM3MDQ5Nik7DQoJICAgICAgICB9DQoNCgkgICAgICAgIGV4cG9ydHMucmVhZERvdWJsZUxFID0gcmVhZERvdWJsZV9pZWVlNzU0LmJpbmQobnVsbCwgcmVhZFVpbnRMRSwgMCwgNCk7DQoJICAgICAgICBleHBvcnRzLnJlYWREb3VibGVCRSA9IHJlYWREb3VibGVfaWVlZTc1NC5iaW5kKG51bGwsIHJlYWRVaW50QkUsIDQsIDApOw0KDQoJICAgIH0pKCk7DQoNCgkgICAgcmV0dXJuIGV4cG9ydHM7DQoJfQ0KDQoJLy8gdWludCBoZWxwZXJzDQoNCglmdW5jdGlvbiB3cml0ZVVpbnRMRSh2YWwsIGJ1ZiwgcG9zKSB7DQoJICAgIGJ1Zltwb3MgICAgXSA9ICB2YWwgICAgICAgICYgMjU1Ow0KCSAgICBidWZbcG9zICsgMV0gPSAgdmFsID4+PiA4ICAmIDI1NTsNCgkgICAgYnVmW3BvcyArIDJdID0gIHZhbCA+Pj4gMTYgJiAyNTU7DQoJICAgIGJ1Zltwb3MgKyAzXSA9ICB2YWwgPj4+IDI0Ow0KCX0NCg0KCWZ1bmN0aW9uIHdyaXRlVWludEJFKHZhbCwgYnVmLCBwb3MpIHsNCgkgICAgYnVmW3BvcyAgICBdID0gIHZhbCA+Pj4gMjQ7DQoJICAgIGJ1Zltwb3MgKyAxXSA9ICB2YWwgPj4+IDE2ICYgMjU1Ow0KCSAgICBidWZbcG9zICsgMl0gPSAgdmFsID4+PiA4ICAmIDI1NTsNCgkgICAgYnVmW3BvcyArIDNdID0gIHZhbCAgICAgICAgJiAyNTU7DQoJfQ0KDQoJZnVuY3Rpb24gcmVhZFVpbnRMRShidWYsIHBvcykgew0KCSAgICByZXR1cm4gKGJ1Zltwb3MgICAgXQ0KCSAgICAgICAgICB8IGJ1Zltwb3MgKyAxXSA8PCA4DQoJICAgICAgICAgIHwgYnVmW3BvcyArIDJdIDw8IDE2DQoJICAgICAgICAgIHwgYnVmW3BvcyArIDNdIDw8IDI0KSA+Pj4gMDsNCgl9DQoNCglmdW5jdGlvbiByZWFkVWludEJFKGJ1ZiwgcG9zKSB7DQoJICAgIHJldHVybiAoYnVmW3BvcyAgICBdIDw8IDI0DQoJICAgICAgICAgIHwgYnVmW3BvcyArIDFdIDw8IDE2DQoJICAgICAgICAgIHwgYnVmW3BvcyArIDJdIDw8IDgNCgkgICAgICAgICAgfCBidWZbcG9zICsgM10pID4+PiAwOw0KCX0KCgl2YXIgaW5xdWlyZV8xID0gaW5xdWlyZTsNCg0KCS8qKg0KCSAqIFJlcXVpcmVzIGEgbW9kdWxlIG9ubHkgaWYgYXZhaWxhYmxlLg0KCSAqIEBtZW1iZXJvZiB1dGlsDQoJICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZU5hbWUgTW9kdWxlIHRvIHJlcXVpcmUNCgkgKiBAcmV0dXJucyB7P09iamVjdH0gUmVxdWlyZWQgbW9kdWxlIGlmIGF2YWlsYWJsZSBhbmQgbm90IGVtcHR5LCBvdGhlcndpc2UgYG51bGxgDQoJICovDQoJZnVuY3Rpb24gaW5xdWlyZShtb2R1bGVOYW1lKSB7DQoJICAgIHRyeSB7DQoJICAgICAgICB2YXIgbW9kID0gZXZhbCgicXVpcmUiLnJlcGxhY2UoL14vLCJyZSIpKShtb2R1bGVOYW1lKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1ldmFsDQoJICAgICAgICBpZiAobW9kICYmIChtb2QubGVuZ3RoIHx8IE9iamVjdC5rZXlzKG1vZCkubGVuZ3RoKSkNCgkgICAgICAgICAgICByZXR1cm4gbW9kOw0KCSAgICB9IGNhdGNoIChlKSB7fSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWVtcHR5DQoJICAgIHJldHVybiBudWxsOw0KCX0KCgl2YXIgdXRmOCQyID0ge307CgoJKGZ1bmN0aW9uIChleHBvcnRzKSB7Cg0KCS8qKg0KCSAqIEEgbWluaW1hbCBVVEY4IGltcGxlbWVudGF0aW9uIGZvciBudW1iZXIgYXJyYXlzLg0KCSAqIEBtZW1iZXJvZiB1dGlsDQoJICogQG5hbWVzcGFjZQ0KCSAqLw0KCXZhciB1dGY4ID0gZXhwb3J0czsNCg0KCS8qKg0KCSAqIENhbGN1bGF0ZXMgdGhlIFVURjggYnl0ZSBsZW5ndGggb2YgYSBzdHJpbmcuDQoJICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcNCgkgKiBAcmV0dXJucyB7bnVtYmVyfSBCeXRlIGxlbmd0aA0KCSAqLw0KCXV0ZjgubGVuZ3RoID0gZnVuY3Rpb24gdXRmOF9sZW5ndGgoc3RyaW5nKSB7DQoJICAgIHZhciBsZW4gPSAwLA0KCSAgICAgICAgYyA9IDA7DQoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyaW5nLmxlbmd0aDsgKytpKSB7DQoJICAgICAgICBjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSk7DQoJICAgICAgICBpZiAoYyA8IDEyOCkNCgkgICAgICAgICAgICBsZW4gKz0gMTsNCgkgICAgICAgIGVsc2UgaWYgKGMgPCAyMDQ4KQ0KCSAgICAgICAgICAgIGxlbiArPSAyOw0KCSAgICAgICAgZWxzZSBpZiAoKGMgJiAweEZDMDApID09PSAweEQ4MDAgJiYgKHN0cmluZy5jaGFyQ29kZUF0KGkgKyAxKSAmIDB4RkMwMCkgPT09IDB4REMwMCkgew0KCSAgICAgICAgICAgICsraTsNCgkgICAgICAgICAgICBsZW4gKz0gNDsNCgkgICAgICAgIH0gZWxzZQ0KCSAgICAgICAgICAgIGxlbiArPSAzOw0KCSAgICB9DQoJICAgIHJldHVybiBsZW47DQoJfTsNCg0KCS8qKg0KCSAqIFJlYWRzIFVURjggYnl0ZXMgYXMgYSBzdHJpbmcuDQoJICogQHBhcmFtIHtVaW50OEFycmF5fSBidWZmZXIgU291cmNlIGJ1ZmZlcg0KCSAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBTb3VyY2Ugc3RhcnQNCgkgKiBAcGFyYW0ge251bWJlcn0gZW5kIFNvdXJjZSBlbmQNCgkgKiBAcmV0dXJucyB7c3RyaW5nfSBTdHJpbmcgcmVhZA0KCSAqLw0KCXV0ZjgucmVhZCA9IGZ1bmN0aW9uIHV0ZjhfcmVhZChidWZmZXIsIHN0YXJ0LCBlbmQpIHsNCgkgICAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0Ow0KCSAgICBpZiAobGVuIDwgMSkNCgkgICAgICAgIHJldHVybiAiIjsNCgkgICAgdmFyIHBhcnRzID0gbnVsbCwNCgkgICAgICAgIGNodW5rID0gW10sDQoJICAgICAgICBpID0gMCwgLy8gY2hhciBvZmZzZXQNCgkgICAgICAgIHQ7ICAgICAvLyB0ZW1wb3JhcnkNCgkgICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7DQoJICAgICAgICB0ID0gYnVmZmVyW3N0YXJ0KytdOw0KCSAgICAgICAgaWYgKHQgPCAxMjgpDQoJICAgICAgICAgICAgY2h1bmtbaSsrXSA9IHQ7DQoJICAgICAgICBlbHNlIGlmICh0ID4gMTkxICYmIHQgPCAyMjQpDQoJICAgICAgICAgICAgY2h1bmtbaSsrXSA9ICh0ICYgMzEpIDw8IDYgfCBidWZmZXJbc3RhcnQrK10gJiA2MzsNCgkgICAgICAgIGVsc2UgaWYgKHQgPiAyMzkgJiYgdCA8IDM2NSkgew0KCSAgICAgICAgICAgIHQgPSAoKHQgJiA3KSA8PCAxOCB8IChidWZmZXJbc3RhcnQrK10gJiA2MykgPDwgMTIgfCAoYnVmZmVyW3N0YXJ0KytdICYgNjMpIDw8IDYgfCBidWZmZXJbc3RhcnQrK10gJiA2MykgLSAweDEwMDAwOw0KCSAgICAgICAgICAgIGNodW5rW2krK10gPSAweEQ4MDAgKyAodCA+PiAxMCk7DQoJICAgICAgICAgICAgY2h1bmtbaSsrXSA9IDB4REMwMCArICh0ICYgMTAyMyk7DQoJICAgICAgICB9IGVsc2UNCgkgICAgICAgICAgICBjaHVua1tpKytdID0gKHQgJiAxNSkgPDwgMTIgfCAoYnVmZmVyW3N0YXJ0KytdICYgNjMpIDw8IDYgfCBidWZmZXJbc3RhcnQrK10gJiA2MzsNCgkgICAgICAgIGlmIChpID4gODE5MSkgew0KCSAgICAgICAgICAgIChwYXJ0cyB8fCAocGFydHMgPSBbXSkpLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNodW5rKSk7DQoJICAgICAgICAgICAgaSA9IDA7DQoJICAgICAgICB9DQoJICAgIH0NCgkgICAgaWYgKHBhcnRzKSB7DQoJICAgICAgICBpZiAoaSkNCgkgICAgICAgICAgICBwYXJ0cy5wdXNoKFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBjaHVuay5zbGljZSgwLCBpKSkpOw0KCSAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oIiIpOw0KCSAgICB9DQoJICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY2h1bmsuc2xpY2UoMCwgaSkpOw0KCX07DQoNCgkvKioNCgkgKiBXcml0ZXMgYSBzdHJpbmcgYXMgVVRGOCBieXRlcy4NCgkgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFNvdXJjZSBzdHJpbmcNCgkgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ1ZmZlciBEZXN0aW5hdGlvbiBidWZmZXINCgkgKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0IERlc3RpbmF0aW9uIG9mZnNldA0KCSAqIEByZXR1cm5zIHtudW1iZXJ9IEJ5dGVzIHdyaXR0ZW4NCgkgKi8NCgl1dGY4LndyaXRlID0gZnVuY3Rpb24gdXRmOF93cml0ZShzdHJpbmcsIGJ1ZmZlciwgb2Zmc2V0KSB7DQoJICAgIHZhciBzdGFydCA9IG9mZnNldCwNCgkgICAgICAgIGMxLCAvLyBjaGFyYWN0ZXIgMQ0KCSAgICAgICAgYzI7IC8vIGNoYXJhY3RlciAyDQoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyaW5nLmxlbmd0aDsgKytpKSB7DQoJICAgICAgICBjMSA9IHN0cmluZy5jaGFyQ29kZUF0KGkpOw0KCSAgICAgICAgaWYgKGMxIDwgMTI4KSB7DQoJICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxOw0KCSAgICAgICAgfSBlbHNlIGlmIChjMSA8IDIwNDgpIHsNCgkgICAgICAgICAgICBidWZmZXJbb2Zmc2V0KytdID0gYzEgPj4gNiAgICAgICB8IDE5MjsNCgkgICAgICAgICAgICBidWZmZXJbb2Zmc2V0KytdID0gYzEgICAgICAgJiA2MyB8IDEyODsNCgkgICAgICAgIH0gZWxzZSBpZiAoKGMxICYgMHhGQzAwKSA9PT0gMHhEODAwICYmICgoYzIgPSBzdHJpbmcuY2hhckNvZGVBdChpICsgMSkpICYgMHhGQzAwKSA9PT0gMHhEQzAwKSB7DQoJICAgICAgICAgICAgYzEgPSAweDEwMDAwICsgKChjMSAmIDB4MDNGRikgPDwgMTApICsgKGMyICYgMHgwM0ZGKTsNCgkgICAgICAgICAgICArK2k7DQoJICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxID4+IDE4ICAgICAgfCAyNDA7DQoJICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxID4+IDEyICYgNjMgfCAxMjg7DQoJICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxID4+IDYgICYgNjMgfCAxMjg7DQoJICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxICAgICAgICYgNjMgfCAxMjg7DQoJICAgICAgICB9IGVsc2Ugew0KCSAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSBjMSA+PiAxMiAgICAgIHwgMjI0Ow0KCSAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSBjMSA+PiA2ICAmIDYzIHwgMTI4Ow0KCSAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSBjMSAgICAgICAmIDYzIHwgMTI4Ow0KCSAgICAgICAgfQ0KCSAgICB9DQoJICAgIHJldHVybiBvZmZzZXQgLSBzdGFydDsNCgl9OwoJfSh1dGY4JDIpKTsKCgl2YXIgcG9vbF8xID0gcG9vbDsNCg0KCS8qKg0KCSAqIEFuIGFsbG9jYXRvciBhcyB1c2VkIGJ5IHtAbGluayB1dGlsLnBvb2x9Lg0KCSAqIEB0eXBlZGVmIFBvb2xBbGxvY2F0b3INCgkgKiBAdHlwZSB7ZnVuY3Rpb259DQoJICogQHBhcmFtIHtudW1iZXJ9IHNpemUgQnVmZmVyIHNpemUNCgkgKiBAcmV0dXJucyB7VWludDhBcnJheX0gQnVmZmVyDQoJICovDQoNCgkvKioNCgkgKiBBIHNsaWNlciBhcyB1c2VkIGJ5IHtAbGluayB1dGlsLnBvb2x9Lg0KCSAqIEB0eXBlZGVmIFBvb2xTbGljZXINCgkgKiBAdHlwZSB7ZnVuY3Rpb259DQoJICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IFN0YXJ0IG9mZnNldA0KCSAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgRW5kIG9mZnNldA0KCSAqIEByZXR1cm5zIHtVaW50OEFycmF5fSBCdWZmZXIgc2xpY2UNCgkgKiBAdGhpcyB7VWludDhBcnJheX0NCgkgKi8NCg0KCS8qKg0KCSAqIEEgZ2VuZXJhbCBwdXJwb3NlIGJ1ZmZlciBwb29sLg0KCSAqIEBtZW1iZXJvZiB1dGlsDQoJICogQGZ1bmN0aW9uDQoJICogQHBhcmFtIHtQb29sQWxsb2NhdG9yfSBhbGxvYyBBbGxvY2F0b3INCgkgKiBAcGFyYW0ge1Bvb2xTbGljZXJ9IHNsaWNlIFNsaWNlcg0KCSAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT04MTkyXSBTbGFiIHNpemUNCgkgKiBAcmV0dXJucyB7UG9vbEFsbG9jYXRvcn0gUG9vbGVkIGFsbG9jYXRvcg0KCSAqLw0KCWZ1bmN0aW9uIHBvb2woYWxsb2MsIHNsaWNlLCBzaXplKSB7DQoJICAgIHZhciBTSVpFICAgPSBzaXplIHx8IDgxOTI7DQoJICAgIHZhciBNQVggICAgPSBTSVpFID4+PiAxOw0KCSAgICB2YXIgc2xhYiAgID0gbnVsbDsNCgkgICAgdmFyIG9mZnNldCA9IFNJWkU7DQoJICAgIHJldHVybiBmdW5jdGlvbiBwb29sX2FsbG9jKHNpemUpIHsNCgkgICAgICAgIGlmIChzaXplIDwgMSB8fCBzaXplID4gTUFYKQ0KCSAgICAgICAgICAgIHJldHVybiBhbGxvYyhzaXplKTsNCgkgICAgICAgIGlmIChvZmZzZXQgKyBzaXplID4gU0laRSkgew0KCSAgICAgICAgICAgIHNsYWIgPSBhbGxvYyhTSVpFKTsNCgkgICAgICAgICAgICBvZmZzZXQgPSAwOw0KCSAgICAgICAgfQ0KCSAgICAgICAgdmFyIGJ1ZiA9IHNsaWNlLmNhbGwoc2xhYiwgb2Zmc2V0LCBvZmZzZXQgKz0gc2l6ZSk7DQoJICAgICAgICBpZiAob2Zmc2V0ICYgNykgLy8gYWxpZ24gdG8gMzIgYml0DQoJICAgICAgICAgICAgb2Zmc2V0ID0gKG9mZnNldCB8IDcpICsgMTsNCgkgICAgICAgIHJldHVybiBidWY7DQoJICAgIH07DQoJfQoKCXZhciBsb25nYml0cyA9IExvbmdCaXRzJDI7CgoJdmFyIHV0aWwkNSA9IG1pbmltYWwkMTsKCgkvKioKCSAqIENvbnN0cnVjdHMgbmV3IGxvbmcgYml0cy4KCSAqIEBjbGFzc2Rlc2MgSGVscGVyIGNsYXNzIGZvciB3b3JraW5nIHdpdGggdGhlIGxvdyBhbmQgaGlnaCBiaXRzIG9mIGEgNjQgYml0IHZhbHVlLgoJICogQG1lbWJlcm9mIHV0aWwKCSAqIEBjb25zdHJ1Y3RvcgoJICogQHBhcmFtIHtudW1iZXJ9IGxvIExvdyAzMiBiaXRzLCB1bnNpZ25lZAoJICogQHBhcmFtIHtudW1iZXJ9IGhpIEhpZ2ggMzIgYml0cywgdW5zaWduZWQKCSAqLwoJZnVuY3Rpb24gTG9uZ0JpdHMkMihsbywgaGkpIHsKCgkgICAgLy8gbm90ZSB0aGF0IHRoZSBjYXN0cyBiZWxvdyBhcmUgdGhlb3JldGljYWxseSB1bm5lY2Vzc2FyeSBhcyBvZiB0b2RheSwgYnV0IG9sZGVyIHN0YXRpY2FsbHkKCSAgICAvLyBnZW5lcmF0ZWQgY29udmVydGVyIGNvZGUgbWlnaHQgc3RpbGwgY2FsbCB0aGUgY3RvciB3aXRoIHNpZ25lZCAzMmJpdHMuIGtlcHQgZm9yIGNvbXBhdC4KCgkgICAgLyoqCgkgICAgICogTG93IGJpdHMuCgkgICAgICogQHR5cGUge251bWJlcn0KCSAgICAgKi8KCSAgICB0aGlzLmxvID0gbG8gPj4+IDA7CgoJICAgIC8qKgoJICAgICAqIEhpZ2ggYml0cy4KCSAgICAgKiBAdHlwZSB7bnVtYmVyfQoJICAgICAqLwoJICAgIHRoaXMuaGkgPSBoaSA+Pj4gMDsKCX0KCgkvKioKCSAqIFplcm8gYml0cy4KCSAqIEBtZW1iZXJvZiB1dGlsLkxvbmdCaXRzCgkgKiBAdHlwZSB7dXRpbC5Mb25nQml0c30KCSAqLwoJdmFyIHplcm8gPSBMb25nQml0cyQyLnplcm8gPSBuZXcgTG9uZ0JpdHMkMigwLCAwKTsKCgl6ZXJvLnRvTnVtYmVyID0gZnVuY3Rpb24oKSB7IHJldHVybiAwOyB9OwoJemVyby56ekVuY29kZSA9IHplcm8uenpEZWNvZGUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH07Cgl6ZXJvLmxlbmd0aCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gMTsgfTsKCgkvKioKCSAqIFplcm8gaGFzaC4KCSAqIEBtZW1iZXJvZiB1dGlsLkxvbmdCaXRzCgkgKiBAdHlwZSB7c3RyaW5nfQoJICovCgl2YXIgemVyb0hhc2ggPSBMb25nQml0cyQyLnplcm9IYXNoID0gIlwwXDBcMFwwXDBcMFwwXDAiOwoKCS8qKgoJICogQ29uc3RydWN0cyBuZXcgbG9uZyBiaXRzIGZyb20gdGhlIHNwZWNpZmllZCBudW1iZXIuCgkgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgVmFsdWUKCSAqIEByZXR1cm5zIHt1dGlsLkxvbmdCaXRzfSBJbnN0YW5jZQoJICovCglMb25nQml0cyQyLmZyb21OdW1iZXIgPSBmdW5jdGlvbiBmcm9tTnVtYmVyKHZhbHVlKSB7CgkgICAgaWYgKHZhbHVlID09PSAwKQoJICAgICAgICByZXR1cm4gemVybzsKCSAgICB2YXIgc2lnbiA9IHZhbHVlIDwgMDsKCSAgICBpZiAoc2lnbikKCSAgICAgICAgdmFsdWUgPSAtdmFsdWU7CgkgICAgdmFyIGxvID0gdmFsdWUgPj4+IDAsCgkgICAgICAgIGhpID0gKHZhbHVlIC0gbG8pIC8gNDI5NDk2NzI5NiA+Pj4gMDsKCSAgICBpZiAoc2lnbikgewoJICAgICAgICBoaSA9IH5oaSA+Pj4gMDsKCSAgICAgICAgbG8gPSB+bG8gPj4+IDA7CgkgICAgICAgIGlmICgrK2xvID4gNDI5NDk2NzI5NSkgewoJICAgICAgICAgICAgbG8gPSAwOwoJICAgICAgICAgICAgaWYgKCsraGkgPiA0Mjk0OTY3Mjk1KQoJICAgICAgICAgICAgICAgIGhpID0gMDsKCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gbmV3IExvbmdCaXRzJDIobG8sIGhpKTsKCX07CgoJLyoqCgkgKiBDb25zdHJ1Y3RzIG5ldyBsb25nIGJpdHMgZnJvbSBhIG51bWJlciwgbG9uZyBvciBzdHJpbmcuCgkgKiBAcGFyYW0ge0xvbmd8bnVtYmVyfHN0cmluZ30gdmFsdWUgVmFsdWUKCSAqIEByZXR1cm5zIHt1dGlsLkxvbmdCaXRzfSBJbnN0YW5jZQoJICovCglMb25nQml0cyQyLmZyb20gPSBmdW5jdGlvbiBmcm9tKHZhbHVlKSB7CgkgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpCgkgICAgICAgIHJldHVybiBMb25nQml0cyQyLmZyb21OdW1iZXIodmFsdWUpOwoJICAgIGlmICh1dGlsJDUuaXNTdHJpbmcodmFsdWUpKSB7CgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgkgICAgICAgIGlmICh1dGlsJDUuTG9uZykKCSAgICAgICAgICAgIHZhbHVlID0gdXRpbCQ1LkxvbmcuZnJvbVN0cmluZyh2YWx1ZSk7CgkgICAgICAgIGVsc2UKCSAgICAgICAgICAgIHJldHVybiBMb25nQml0cyQyLmZyb21OdW1iZXIocGFyc2VJbnQodmFsdWUsIDEwKSk7CgkgICAgfQoJICAgIHJldHVybiB2YWx1ZS5sb3cgfHwgdmFsdWUuaGlnaCA/IG5ldyBMb25nQml0cyQyKHZhbHVlLmxvdyA+Pj4gMCwgdmFsdWUuaGlnaCA+Pj4gMCkgOiB6ZXJvOwoJfTsKCgkvKioKCSAqIENvbnZlcnRzIHRoaXMgbG9uZyBiaXRzIHRvIGEgcG9zc2libHkgdW5zYWZlIEphdmFTY3JpcHQgbnVtYmVyLgoJICogQHBhcmFtIHtib29sZWFufSBbdW5zaWduZWQ9ZmFsc2VdIFdoZXRoZXIgdW5zaWduZWQgb3Igbm90CgkgKiBAcmV0dXJucyB7bnVtYmVyfSBQb3NzaWJseSB1bnNhZmUgbnVtYmVyCgkgKi8KCUxvbmdCaXRzJDIucHJvdG90eXBlLnRvTnVtYmVyID0gZnVuY3Rpb24gdG9OdW1iZXIodW5zaWduZWQpIHsKCSAgICBpZiAoIXVuc2lnbmVkICYmIHRoaXMuaGkgPj4+IDMxKSB7CgkgICAgICAgIHZhciBsbyA9IH50aGlzLmxvICsgMSA+Pj4gMCwKCSAgICAgICAgICAgIGhpID0gfnRoaXMuaGkgICAgID4+PiAwOwoJICAgICAgICBpZiAoIWxvKQoJICAgICAgICAgICAgaGkgPSBoaSArIDEgPj4+IDA7CgkgICAgICAgIHJldHVybiAtKGxvICsgaGkgKiA0Mjk0OTY3Mjk2KTsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXMubG8gKyB0aGlzLmhpICogNDI5NDk2NzI5NjsKCX07CgoJLyoqCgkgKiBDb252ZXJ0cyB0aGlzIGxvbmcgYml0cyB0byBhIGxvbmcuCgkgKiBAcGFyYW0ge2Jvb2xlYW59IFt1bnNpZ25lZD1mYWxzZV0gV2hldGhlciB1bnNpZ25lZCBvciBub3QKCSAqIEByZXR1cm5zIHtMb25nfSBMb25nCgkgKi8KCUxvbmdCaXRzJDIucHJvdG90eXBlLnRvTG9uZyA9IGZ1bmN0aW9uIHRvTG9uZyh1bnNpZ25lZCkgewoJICAgIHJldHVybiB1dGlsJDUuTG9uZwoJICAgICAgICA/IG5ldyB1dGlsJDUuTG9uZyh0aGlzLmxvIHwgMCwgdGhpcy5oaSB8IDAsIEJvb2xlYW4odW5zaWduZWQpKQoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoJICAgICAgICA6IHsgbG93OiB0aGlzLmxvIHwgMCwgaGlnaDogdGhpcy5oaSB8IDAsIHVuc2lnbmVkOiBCb29sZWFuKHVuc2lnbmVkKSB9OwoJfTsKCgl2YXIgY2hhckNvZGVBdCA9IFN0cmluZy5wcm90b3R5cGUuY2hhckNvZGVBdDsKCgkvKioKCSAqIENvbnN0cnVjdHMgbmV3IGxvbmcgYml0cyBmcm9tIHRoZSBzcGVjaWZpZWQgOCBjaGFyYWN0ZXJzIGxvbmcgaGFzaC4KCSAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoIEhhc2gKCSAqIEByZXR1cm5zIHt1dGlsLkxvbmdCaXRzfSBCaXRzCgkgKi8KCUxvbmdCaXRzJDIuZnJvbUhhc2ggPSBmdW5jdGlvbiBmcm9tSGFzaChoYXNoKSB7CgkgICAgaWYgKGhhc2ggPT09IHplcm9IYXNoKQoJICAgICAgICByZXR1cm4gemVybzsKCSAgICByZXR1cm4gbmV3IExvbmdCaXRzJDIoCgkgICAgICAgICggY2hhckNvZGVBdC5jYWxsKGhhc2gsIDApCgkgICAgICAgIHwgY2hhckNvZGVBdC5jYWxsKGhhc2gsIDEpIDw8IDgKCSAgICAgICAgfCBjaGFyQ29kZUF0LmNhbGwoaGFzaCwgMikgPDwgMTYKCSAgICAgICAgfCBjaGFyQ29kZUF0LmNhbGwoaGFzaCwgMykgPDwgMjQpID4+PiAwCgkgICAgLAoJICAgICAgICAoIGNoYXJDb2RlQXQuY2FsbChoYXNoLCA0KQoJICAgICAgICB8IGNoYXJDb2RlQXQuY2FsbChoYXNoLCA1KSA8PCA4CgkgICAgICAgIHwgY2hhckNvZGVBdC5jYWxsKGhhc2gsIDYpIDw8IDE2CgkgICAgICAgIHwgY2hhckNvZGVBdC5jYWxsKGhhc2gsIDcpIDw8IDI0KSA+Pj4gMAoJICAgICk7Cgl9OwoKCS8qKgoJICogQ29udmVydHMgdGhpcyBsb25nIGJpdHMgdG8gYSA4IGNoYXJhY3RlcnMgbG9uZyBoYXNoLgoJICogQHJldHVybnMge3N0cmluZ30gSGFzaAoJICovCglMb25nQml0cyQyLnByb3RvdHlwZS50b0hhc2ggPSBmdW5jdGlvbiB0b0hhc2goKSB7CgkgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoCgkgICAgICAgIHRoaXMubG8gICAgICAgICYgMjU1LAoJICAgICAgICB0aGlzLmxvID4+PiA4ICAmIDI1NSwKCSAgICAgICAgdGhpcy5sbyA+Pj4gMTYgJiAyNTUsCgkgICAgICAgIHRoaXMubG8gPj4+IDI0ICAgICAgLAoJICAgICAgICB0aGlzLmhpICAgICAgICAmIDI1NSwKCSAgICAgICAgdGhpcy5oaSA+Pj4gOCAgJiAyNTUsCgkgICAgICAgIHRoaXMuaGkgPj4+IDE2ICYgMjU1LAoJICAgICAgICB0aGlzLmhpID4+PiAyNAoJICAgICk7Cgl9OwoKCS8qKgoJICogWmlnLXphZyBlbmNvZGVzIHRoaXMgbG9uZyBiaXRzLgoJICogQHJldHVybnMge3V0aWwuTG9uZ0JpdHN9IGB0aGlzYAoJICovCglMb25nQml0cyQyLnByb3RvdHlwZS56ekVuY29kZSA9IGZ1bmN0aW9uIHp6RW5jb2RlKCkgewoJICAgIHZhciBtYXNrID0gICB0aGlzLmhpID4+IDMxOwoJICAgIHRoaXMuaGkgID0gKCh0aGlzLmhpIDw8IDEgfCB0aGlzLmxvID4+PiAzMSkgXiBtYXNrKSA+Pj4gMDsKCSAgICB0aGlzLmxvICA9ICggdGhpcy5sbyA8PCAxICAgICAgICAgICAgICAgICAgIF4gbWFzaykgPj4+IDA7CgkgICAgcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogWmlnLXphZyBkZWNvZGVzIHRoaXMgbG9uZyBiaXRzLgoJICogQHJldHVybnMge3V0aWwuTG9uZ0JpdHN9IGB0aGlzYAoJICovCglMb25nQml0cyQyLnByb3RvdHlwZS56ekRlY29kZSA9IGZ1bmN0aW9uIHp6RGVjb2RlKCkgewoJICAgIHZhciBtYXNrID0gLSh0aGlzLmxvICYgMSk7CgkgICAgdGhpcy5sbyAgPSAoKHRoaXMubG8gPj4+IDEgfCB0aGlzLmhpIDw8IDMxKSBeIG1hc2spID4+PiAwOwoJICAgIHRoaXMuaGkgID0gKCB0aGlzLmhpID4+PiAxICAgICAgICAgICAgICAgICAgXiBtYXNrKSA+Pj4gMDsKCSAgICByZXR1cm4gdGhpczsKCX07CgoJLyoqCgkgKiBDYWxjdWxhdGVzIHRoZSBsZW5ndGggb2YgdGhpcyBsb25nYml0cyB3aGVuIGVuY29kZWQgYXMgYSB2YXJpbnQuCgkgKiBAcmV0dXJucyB7bnVtYmVyfSBMZW5ndGgKCSAqLwoJTG9uZ0JpdHMkMi5wcm90b3R5cGUubGVuZ3RoID0gZnVuY3Rpb24gbGVuZ3RoKCkgewoJICAgIHZhciBwYXJ0MCA9ICB0aGlzLmxvLAoJICAgICAgICBwYXJ0MSA9ICh0aGlzLmxvID4+PiAyOCB8IHRoaXMuaGkgPDwgNCkgPj4+IDAsCgkgICAgICAgIHBhcnQyID0gIHRoaXMuaGkgPj4+IDI0OwoJICAgIHJldHVybiBwYXJ0MiA9PT0gMAoJICAgICAgICAgPyBwYXJ0MSA9PT0gMAoJICAgICAgICAgICA/IHBhcnQwIDwgMTYzODQKCSAgICAgICAgICAgICA/IHBhcnQwIDwgMTI4ID8gMSA6IDIKCSAgICAgICAgICAgICA6IHBhcnQwIDwgMjA5NzE1MiA/IDMgOiA0CgkgICAgICAgICAgIDogcGFydDEgPCAxNjM4NAoJICAgICAgICAgICAgID8gcGFydDEgPCAxMjggPyA1IDogNgoJICAgICAgICAgICAgIDogcGFydDEgPCAyMDk3MTUyID8gNyA6IDgKCSAgICAgICAgIDogcGFydDIgPCAxMjggPyA5IDogMTA7Cgl9OwoKCShmdW5jdGlvbiAoZXhwb3J0cykgewoJdmFyIHV0aWwgPSBleHBvcnRzOwoKCS8vIHVzZWQgdG8gcmV0dXJuIGEgUHJvbWlzZSB3aGVyZSBjYWxsYmFjayBpcyBvbWl0dGVkCgl1dGlsLmFzUHJvbWlzZSA9IGFzcHJvbWlzZTsKCgkvLyBjb252ZXJ0cyB0byAvIGZyb20gYmFzZTY0IGVuY29kZWQgc3RyaW5ncwoJdXRpbC5iYXNlNjQgPSBiYXNlNjQkMTsKCgkvLyBiYXNlIGNsYXNzIG9mIHJwYy5TZXJ2aWNlCgl1dGlsLkV2ZW50RW1pdHRlciA9IGV2ZW50ZW1pdHRlcjsKCgkvLyBmbG9hdCBoYW5kbGluZyBhY2Nyb3NzIGJyb3dzZXJzCgl1dGlsLmZsb2F0ID0gZmxvYXQ7CgoJLy8gcmVxdWlyZXMgbW9kdWxlcyBvcHRpb25hbGx5IGFuZCBoaWRlcyB0aGUgY2FsbCBmcm9tIGJ1bmRsZXJzCgl1dGlsLmlucXVpcmUgPSBpbnF1aXJlXzE7CgoJLy8gY29udmVydHMgdG8gLyBmcm9tIHV0ZjggZW5jb2RlZCBzdHJpbmdzCgl1dGlsLnV0ZjggPSB1dGY4JDI7CgoJLy8gcHJvdmlkZXMgYSBub2RlLWxpa2UgYnVmZmVyIHBvb2wgaW4gdGhlIGJyb3dzZXIKCXV0aWwucG9vbCA9IHBvb2xfMTsKCgkvLyB1dGlsaXR5IHRvIHdvcmsgd2l0aCB0aGUgbG93IGFuZCBoaWdoIGJpdHMgb2YgYSA2NCBiaXQgdmFsdWUKCXV0aWwuTG9uZ0JpdHMgPSBsb25nYml0czsKCgkvKioKCSAqIFdoZXRoZXIgcnVubmluZyB3aXRoaW4gbm9kZSBvciBub3QuCgkgKiBAbWVtYmVyb2YgdXRpbAoJICogQHR5cGUge2Jvb2xlYW59CgkgKi8KCXV0aWwuaXNOb2RlID0gQm9vbGVhbih0eXBlb2YgY29tbW9uanNHbG9iYWwgIT09ICJ1bmRlZmluZWQiCgkgICAgICAgICAgICAgICAgICAgJiYgY29tbW9uanNHbG9iYWwKCSAgICAgICAgICAgICAgICAgICAmJiBjb21tb25qc0dsb2JhbC5wcm9jZXNzCgkgICAgICAgICAgICAgICAgICAgJiYgY29tbW9uanNHbG9iYWwucHJvY2Vzcy52ZXJzaW9ucwoJICAgICAgICAgICAgICAgICAgICYmIGNvbW1vbmpzR2xvYmFsLnByb2Nlc3MudmVyc2lvbnMubm9kZSk7CgoJLyoqCgkgKiBHbG9iYWwgb2JqZWN0IHJlZmVyZW5jZS4KCSAqIEBtZW1iZXJvZiB1dGlsCgkgKiBAdHlwZSB7T2JqZWN0fQoJICovCgl1dGlsLmdsb2JhbCA9IHV0aWwuaXNOb2RlICYmIGNvbW1vbmpzR2xvYmFsCgkgICAgICAgICAgIHx8IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdwoJICAgICAgICAgICB8fCB0eXBlb2Ygc2VsZiAgICE9PSAidW5kZWZpbmVkIiAmJiBzZWxmCgkgICAgICAgICAgIHx8IGNvbW1vbmpzR2xvYmFsOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWludmFsaWQtdGhpcwoKCS8qKgoJICogQW4gaW1tdWFibGUgZW1wdHkgYXJyYXkuCgkgKiBAbWVtYmVyb2YgdXRpbAoJICogQHR5cGUge0FycmF5LjwqPn0KCSAqIEBjb25zdAoJICovCgl1dGlsLmVtcHR5QXJyYXkgPSBPYmplY3QuZnJlZXplID8gT2JqZWN0LmZyZWV6ZShbXSkgOiAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLyBbXTsgLy8gdXNlZCBvbiBwcm90b3R5cGVzCgoJLyoqCgkgKiBBbiBpbW11dGFibGUgZW1wdHkgb2JqZWN0LgoJICogQHR5cGUge09iamVjdH0KCSAqIEBjb25zdAoJICovCgl1dGlsLmVtcHR5T2JqZWN0ID0gT2JqZWN0LmZyZWV6ZSA/IE9iamVjdC5mcmVlemUoe30pIDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8ge307IC8vIHVzZWQgb24gcHJvdG90eXBlcwoKCS8qKgoJICogVGVzdHMgaWYgdGhlIHNwZWNpZmllZCB2YWx1ZSBpcyBhbiBpbnRlZ2VyLgoJICogQGZ1bmN0aW9uCgkgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIHRvIHRlc3QKCSAqIEByZXR1cm5zIHtib29sZWFufSBgdHJ1ZWAgaWYgdGhlIHZhbHVlIGlzIGFuIGludGVnZXIKCSAqLwoJdXRpbC5pc0ludGVnZXIgPSBOdW1iZXIuaXNJbnRlZ2VyIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovIGZ1bmN0aW9uIGlzSW50ZWdlcih2YWx1ZSkgewoJICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiICYmIGlzRmluaXRlKHZhbHVlKSAmJiBNYXRoLmZsb29yKHZhbHVlKSA9PT0gdmFsdWU7Cgl9OwoKCS8qKgoJICogVGVzdHMgaWYgdGhlIHNwZWNpZmllZCB2YWx1ZSBpcyBhIHN0cmluZy4KCSAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgdG8gdGVzdAoJICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcKCSAqLwoJdXRpbC5pc1N0cmluZyA9IGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CgkgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJpbmc7Cgl9OwoKCS8qKgoJICogVGVzdHMgaWYgdGhlIHNwZWNpZmllZCB2YWx1ZSBpcyBhIG5vbi1udWxsIG9iamVjdC4KCSAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgdG8gdGVzdAoJICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgdmFsdWUgaXMgYSBub24tbnVsbCBvYmplY3QKCSAqLwoJdXRpbC5pc09iamVjdCA9IGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CgkgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCI7Cgl9OwoKCS8qKgoJICogQ2hlY2tzIGlmIGEgcHJvcGVydHkgb24gYSBtZXNzYWdlIGlzIGNvbnNpZGVyZWQgdG8gYmUgcHJlc2VudC4KCSAqIFRoaXMgaXMgYW4gYWxpYXMgb2Yge0BsaW5rIHV0aWwuaXNTZXR9LgoJICogQGZ1bmN0aW9uCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqIFBsYWluIG9iamVjdCBvciBtZXNzYWdlIGluc3RhbmNlCgkgKiBAcGFyYW0ge3N0cmluZ30gcHJvcCBQcm9wZXJ0eSBuYW1lCgkgKiBAcmV0dXJucyB7Ym9vbGVhbn0gYHRydWVgIGlmIGNvbnNpZGVyZWQgdG8gYmUgcHJlc2VudCwgb3RoZXJ3aXNlIGBmYWxzZWAKCSAqLwoJdXRpbC5pc3NldCA9CgoJLyoqCgkgKiBDaGVja3MgaWYgYSBwcm9wZXJ0eSBvbiBhIG1lc3NhZ2UgaXMgY29uc2lkZXJlZCB0byBiZSBwcmVzZW50LgoJICogQHBhcmFtIHtPYmplY3R9IG9iaiBQbGFpbiBvYmplY3Qgb3IgbWVzc2FnZSBpbnN0YW5jZQoJICogQHBhcmFtIHtzdHJpbmd9IHByb3AgUHJvcGVydHkgbmFtZQoJICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiBjb25zaWRlcmVkIHRvIGJlIHByZXNlbnQsIG90aGVyd2lzZSBgZmFsc2VgCgkgKi8KCXV0aWwuaXNTZXQgPSBmdW5jdGlvbiBpc1NldChvYmosIHByb3ApIHsKCSAgICB2YXIgdmFsdWUgPSBvYmpbcHJvcF07CgkgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgb2JqLmhhc093blByb3BlcnR5KHByb3ApKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGVxZXFlcSwgbm8tcHJvdG90eXBlLWJ1aWx0aW5zCgkgICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiIHx8IChBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLmxlbmd0aCA6IE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGgpID4gMDsKCSAgICByZXR1cm4gZmFsc2U7Cgl9OwoKCS8qKgoJICogQW55IGNvbXBhdGlibGUgQnVmZmVyIGluc3RhbmNlLgoJICogVGhpcyBpcyBhIG1pbmltYWwgc3RhbmQtYWxvbmUgZGVmaW5pdGlvbiBvZiBhIEJ1ZmZlciBpbnN0YW5jZS4gVGhlIGFjdHVhbCB0eXBlIGlzIHRoYXQgZXhwb3J0ZWQgYnkgbm9kZSdzIHR5cGluZ3MuCgkgKiBAaW50ZXJmYWNlIEJ1ZmZlcgoJICogQGV4dGVuZHMgVWludDhBcnJheQoJICovCgoJLyoqCgkgKiBOb2RlJ3MgQnVmZmVyIGNsYXNzIGlmIGF2YWlsYWJsZS4KCSAqIEB0eXBlIHtDb25zdHJ1Y3RvcjxCdWZmZXI+fQoJICovCgl1dGlsLkJ1ZmZlciA9IChmdW5jdGlvbigpIHsKCSAgICB0cnkgewoJICAgICAgICB2YXIgQnVmZmVyID0gdXRpbC5pbnF1aXJlKCJidWZmZXIiKS5CdWZmZXI7CgkgICAgICAgIC8vIHJlZnVzZSB0byB1c2Ugbm9uLW5vZGUgYnVmZmVycyBpZiBub3QgZXhwbGljaXRseSBhc3NpZ25lZCAocGVyZiByZWFzb25zKToKCSAgICAgICAgcmV0dXJuIEJ1ZmZlci5wcm90b3R5cGUudXRmOFdyaXRlID8gQnVmZmVyIDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gbnVsbDsKCSAgICB9IGNhdGNoIChlKSB7CgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCX0pKCk7CgoJLy8gSW50ZXJuYWwgYWxpYXMgb2Ygb3IgcG9seWZ1bGwgZm9yIEJ1ZmZlci5mcm9tLgoJdXRpbC5fQnVmZmVyX2Zyb20gPSBudWxsOwoKCS8vIEludGVybmFsIGFsaWFzIG9mIG9yIHBvbHlmaWxsIGZvciBCdWZmZXIuYWxsb2NVbnNhZmUuCgl1dGlsLl9CdWZmZXJfYWxsb2NVbnNhZmUgPSBudWxsOwoKCS8qKgoJICogQ3JlYXRlcyBhIG5ldyBidWZmZXIgb2Ygd2hhdGV2ZXIgdHlwZSBzdXBwb3J0ZWQgYnkgdGhlIGVudmlyb25tZW50LgoJICogQHBhcmFtIHtudW1iZXJ8bnVtYmVyW119IFtzaXplT3JBcnJheT0wXSBCdWZmZXIgc2l6ZSBvciBudW1iZXIgYXJyYXkKCSAqIEByZXR1cm5zIHtVaW50OEFycmF5fEJ1ZmZlcn0gQnVmZmVyCgkgKi8KCXV0aWwubmV3QnVmZmVyID0gZnVuY3Rpb24gbmV3QnVmZmVyKHNpemVPckFycmF5KSB7CgkgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICByZXR1cm4gdHlwZW9mIHNpemVPckFycmF5ID09PSAibnVtYmVyIgoJICAgICAgICA/IHV0aWwuQnVmZmVyCgkgICAgICAgICAgICA/IHV0aWwuX0J1ZmZlcl9hbGxvY1Vuc2FmZShzaXplT3JBcnJheSkKCSAgICAgICAgICAgIDogbmV3IHV0aWwuQXJyYXkoc2l6ZU9yQXJyYXkpCgkgICAgICAgIDogdXRpbC5CdWZmZXIKCSAgICAgICAgICAgID8gdXRpbC5fQnVmZmVyX2Zyb20oc2l6ZU9yQXJyYXkpCgkgICAgICAgICAgICA6IHR5cGVvZiBVaW50OEFycmF5ID09PSAidW5kZWZpbmVkIgoJICAgICAgICAgICAgICAgID8gc2l6ZU9yQXJyYXkKCSAgICAgICAgICAgICAgICA6IG5ldyBVaW50OEFycmF5KHNpemVPckFycmF5KTsKCX07CgoJLyoqCgkgKiBBcnJheSBpbXBsZW1lbnRhdGlvbiB1c2VkIGluIHRoZSBicm93c2VyLiBgVWludDhBcnJheWAgaWYgc3VwcG9ydGVkLCBvdGhlcndpc2UgYEFycmF5YC4KCSAqIEB0eXBlIHtDb25zdHJ1Y3RvcjxVaW50OEFycmF5Pn0KCSAqLwoJdXRpbC5BcnJheSA9IHR5cGVvZiBVaW50OEFycmF5ICE9PSAidW5kZWZpbmVkIiA/IFVpbnQ4QXJyYXkgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gOiBBcnJheTsKCgkvKioKCSAqIEFueSBjb21wYXRpYmxlIExvbmcgaW5zdGFuY2UuCgkgKiBUaGlzIGlzIGEgbWluaW1hbCBzdGFuZC1hbG9uZSBkZWZpbml0aW9uIG9mIGEgTG9uZyBpbnN0YW5jZS4gVGhlIGFjdHVhbCB0eXBlIGlzIHRoYXQgZXhwb3J0ZWQgYnkgbG9uZy5qcy4KCSAqIEBpbnRlcmZhY2UgTG9uZwoJICogQHByb3BlcnR5IHtudW1iZXJ9IGxvdyBMb3cgYml0cwoJICogQHByb3BlcnR5IHtudW1iZXJ9IGhpZ2ggSGlnaCBiaXRzCgkgKiBAcHJvcGVydHkge2Jvb2xlYW59IHVuc2lnbmVkIFdoZXRoZXIgdW5zaWduZWQgb3Igbm90CgkgKi8KCgkvKioKCSAqIExvbmcuanMncyBMb25nIGNsYXNzIGlmIGF2YWlsYWJsZS4KCSAqIEB0eXBlIHtDb25zdHJ1Y3RvcjxMb25nPn0KCSAqLwoJdXRpbC5Mb25nID0gLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gdXRpbC5nbG9iYWwuZGNvZGVJTyAmJiAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLyB1dGlsLmdsb2JhbC5kY29kZUlPLkxvbmcKCSAgICAgICAgIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovIHV0aWwuZ2xvYmFsLkxvbmcKCSAgICAgICAgIHx8IHV0aWwuaW5xdWlyZSgibG9uZyIpOwoKCS8qKgoJICogUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gdmVyaWZ5IDIgYml0IChgYm9vbGApIG1hcCBrZXlzLgoJICogQHR5cGUge1JlZ0V4cH0KCSAqIEBjb25zdAoJICovCgl1dGlsLmtleTJSZSA9IC9edHJ1ZXxmYWxzZXwwfDEkLzsKCgkvKioKCSAqIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHZlcmlmeSAzMiBiaXQgKGBpbnQzMmAgZXRjLikgbWFwIGtleXMuCgkgKiBAdHlwZSB7UmVnRXhwfQoJICogQGNvbnN0CgkgKi8KCXV0aWwua2V5MzJSZSA9IC9eLT8oPzowfFsxLTldWzAtOV0qKSQvOwoKCS8qKgoJICogUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gdmVyaWZ5IDY0IGJpdCAoYGludDY0YCBldGMuKSBtYXAga2V5cy4KCSAqIEB0eXBlIHtSZWdFeHB9CgkgKiBAY29uc3QKCSAqLwoJdXRpbC5rZXk2NFJlID0gL14oPzpbXFx4MDAtXFx4ZmZdezh9fC0/KD86MHxbMS05XVswLTldKikpJC87CgoJLyoqCgkgKiBDb252ZXJ0cyBhIG51bWJlciBvciBsb25nIHRvIGFuIDggY2hhcmFjdGVycyBsb25nIGhhc2ggc3RyaW5nLgoJICogQHBhcmFtIHtMb25nfG51bWJlcn0gdmFsdWUgVmFsdWUgdG8gY29udmVydAoJICogQHJldHVybnMge3N0cmluZ30gSGFzaAoJICovCgl1dGlsLmxvbmdUb0hhc2ggPSBmdW5jdGlvbiBsb25nVG9IYXNoKHZhbHVlKSB7CgkgICAgcmV0dXJuIHZhbHVlCgkgICAgICAgID8gdXRpbC5Mb25nQml0cy5mcm9tKHZhbHVlKS50b0hhc2goKQoJICAgICAgICA6IHV0aWwuTG9uZ0JpdHMuemVyb0hhc2g7Cgl9OwoKCS8qKgoJICogQ29udmVydHMgYW4gOCBjaGFyYWN0ZXJzIGxvbmcgaGFzaCBzdHJpbmcgdG8gYSBsb25nIG9yIG51bWJlci4KCSAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoIEhhc2gKCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Vuc2lnbmVkPWZhbHNlXSBXaGV0aGVyIHVuc2lnbmVkIG9yIG5vdAoJICogQHJldHVybnMge0xvbmd8bnVtYmVyfSBPcmlnaW5hbCB2YWx1ZQoJICovCgl1dGlsLmxvbmdGcm9tSGFzaCA9IGZ1bmN0aW9uIGxvbmdGcm9tSGFzaChoYXNoLCB1bnNpZ25lZCkgewoJICAgIHZhciBiaXRzID0gdXRpbC5Mb25nQml0cy5mcm9tSGFzaChoYXNoKTsKCSAgICBpZiAodXRpbC5Mb25nKQoJICAgICAgICByZXR1cm4gdXRpbC5Mb25nLmZyb21CaXRzKGJpdHMubG8sIGJpdHMuaGksIHVuc2lnbmVkKTsKCSAgICByZXR1cm4gYml0cy50b051bWJlcihCb29sZWFuKHVuc2lnbmVkKSk7Cgl9OwoKCS8qKgoJICogTWVyZ2VzIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBzb3VyY2Ugb2JqZWN0IGludG8gdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KCSAqIEBtZW1iZXJvZiB1dGlsCgkgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBkc3QgRGVzdGluYXRpb24gb2JqZWN0CgkgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBzcmMgU291cmNlIG9iamVjdAoJICogQHBhcmFtIHtib29sZWFufSBbaWZOb3RTZXQ9ZmFsc2VdIE1lcmdlcyBvbmx5IGlmIHRoZSBrZXkgaXMgbm90IGFscmVhZHkgc2V0CgkgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IERlc3RpbmF0aW9uIG9iamVjdAoJICovCglmdW5jdGlvbiBtZXJnZShkc3QsIHNyYywgaWZOb3RTZXQpIHsgLy8gdXNlZCBieSBjb252ZXJ0ZXJzCgkgICAgZm9yICh2YXIga2V5cyA9IE9iamVjdC5rZXlzKHNyYyksIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSkKCSAgICAgICAgaWYgKGRzdFtrZXlzW2ldXSA9PT0gdW5kZWZpbmVkIHx8ICFpZk5vdFNldCkKCSAgICAgICAgICAgIGRzdFtrZXlzW2ldXSA9IHNyY1trZXlzW2ldXTsKCSAgICByZXR1cm4gZHN0OwoJfQoKCXV0aWwubWVyZ2UgPSBtZXJnZTsKCgkvKioKCSAqIENvbnZlcnRzIHRoZSBmaXJzdCBjaGFyYWN0ZXIgb2YgYSBzdHJpbmcgdG8gbG93ZXIgY2FzZS4KCSAqIEBwYXJhbSB7c3RyaW5nfSBzdHIgU3RyaW5nIHRvIGNvbnZlcnQKCSAqIEByZXR1cm5zIHtzdHJpbmd9IENvbnZlcnRlZCBzdHJpbmcKCSAqLwoJdXRpbC5sY0ZpcnN0ID0gZnVuY3Rpb24gbGNGaXJzdChzdHIpIHsKCSAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpICsgc3RyLnN1YnN0cmluZygxKTsKCX07CgoJLyoqCgkgKiBDcmVhdGVzIGEgY3VzdG9tIGVycm9yIGNvbnN0cnVjdG9yLgoJICogQG1lbWJlcm9mIHV0aWwKCSAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEVycm9yIG5hbWUKCSAqIEByZXR1cm5zIHtDb25zdHJ1Y3RvcjxFcnJvcj59IEN1c3RvbSBlcnJvciBjb25zdHJ1Y3RvcgoJICovCglmdW5jdGlvbiBuZXdFcnJvcihuYW1lKSB7CgoJICAgIGZ1bmN0aW9uIEN1c3RvbUVycm9yKG1lc3NhZ2UsIHByb3BlcnRpZXMpIHsKCgkgICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBDdXN0b21FcnJvcikpCgkgICAgICAgICAgICByZXR1cm4gbmV3IEN1c3RvbUVycm9yKG1lc3NhZ2UsIHByb3BlcnRpZXMpOwoKCSAgICAgICAgLy8gRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKCSAgICAgICAgLy8gXiBqdXN0IHJldHVybnMgYSBuZXcgZXJyb3IgaW5zdGFuY2UgYmVjYXVzZSB0aGUgY3RvciBjYW4gYmUgY2FsbGVkIGFzIGEgZnVuY3Rpb24KCgkgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAibWVzc2FnZSIsIHsgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG1lc3NhZ2U7IH0gfSk7CgoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoJICAgICAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIC8vIG5vZGUKCSAgICAgICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIEN1c3RvbUVycm9yKTsKCSAgICAgICAgZWxzZQoJICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJzdGFjayIsIHsgdmFsdWU6IG5ldyBFcnJvcigpLnN0YWNrIHx8ICIiIH0pOwoKCSAgICAgICAgaWYgKHByb3BlcnRpZXMpCgkgICAgICAgICAgICBtZXJnZSh0aGlzLCBwcm9wZXJ0aWVzKTsKCSAgICB9CgoJICAgIEN1c3RvbUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlLCB7CgkgICAgICAgIGNvbnN0cnVjdG9yOiB7CgkgICAgICAgICAgICB2YWx1ZTogQ3VzdG9tRXJyb3IsCgkgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKCSAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAoJICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAoJICAgICAgICB9LAoJICAgICAgICBuYW1lOiB7CgkgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsgcmV0dXJuIG5hbWU7IH0sCgkgICAgICAgICAgICBzZXQ6IHVuZGVmaW5lZCwKCSAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAoJICAgICAgICAgICAgLy8gY29uZmlndXJhYmxlOiBmYWxzZSB3b3VsZCBhY2N1cmF0ZWx5IHByZXNlcnZlIHRoZSBiZWhhdmlvciBvZgoJICAgICAgICAgICAgLy8gdGhlIG9yaWdpbmFsLCBidXQgSSdtIGd1ZXNzaW5nIHRoYXQgd2FzIG5vdCBpbnRlbnRpb25hbC4KCSAgICAgICAgICAgIC8vIEZvciBhbiBhY3R1YWwgZXJyb3Igc3ViY2xhc3MsIHRoaXMgcHJvcGVydHkgd291bGQKCSAgICAgICAgICAgIC8vIGJlIGNvbmZpZ3VyYWJsZS4KCSAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKCSAgICAgICAgfSwKCSAgICAgICAgdG9TdHJpbmc6IHsKCSAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsgcmV0dXJuIHRoaXMubmFtZSArICI6ICIgKyB0aGlzLm1lc3NhZ2U7IH0sCgkgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKCSAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAoJICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAoJICAgICAgICB9LAoJICAgIH0pOwoKCSAgICByZXR1cm4gQ3VzdG9tRXJyb3I7Cgl9CgoJdXRpbC5uZXdFcnJvciA9IG5ld0Vycm9yOwoKCS8qKgoJICogQ29uc3RydWN0cyBhIG5ldyBwcm90b2NvbCBlcnJvci4KCSAqIEBjbGFzc2Rlc2MgRXJyb3Igc3ViY2xhc3MgaW5kaWNhdGluZyBhIHByb3RvY29sIHNwZWNpZmMgZXJyb3IuCgkgKiBAbWVtYmVyb2YgdXRpbAoJICogQGV4dGVuZHMgRXJyb3IKCSAqIEB0ZW1wbGF0ZSBUIGV4dGVuZHMgTWVzc2FnZTxUPgoJICogQGNvbnN0cnVjdG9yCgkgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZSBFcnJvciBtZXNzYWdlCgkgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBbcHJvcGVydGllc10gQWRkaXRpb25hbCBwcm9wZXJ0aWVzCgkgKiBAZXhhbXBsZQoJICogdHJ5IHsKCSAqICAgICBNeU1lc3NhZ2UuZGVjb2RlKHNvbWVCdWZmZXIpOyAvLyB0aHJvd3MgaWYgcmVxdWlyZWQgZmllbGRzIGFyZSBtaXNzaW5nCgkgKiB9IGNhdGNoIChlKSB7CgkgKiAgICAgaWYgKGUgaW5zdGFuY2VvZiBQcm90b2NvbEVycm9yICYmIGUuaW5zdGFuY2UpCgkgKiAgICAgICAgIGNvbnNvbGUubG9nKCJkZWNvZGVkIHNvIGZhcjogIiArIEpTT04uc3RyaW5naWZ5KGUuaW5zdGFuY2UpKTsKCSAqIH0KCSAqLwoJdXRpbC5Qcm90b2NvbEVycm9yID0gbmV3RXJyb3IoIlByb3RvY29sRXJyb3IiKTsKCgkvKioKCSAqIFNvIGZhciBkZWNvZGVkIG1lc3NhZ2UgaW5zdGFuY2UuCgkgKiBAbmFtZSB1dGlsLlByb3RvY29sRXJyb3IjaW5zdGFuY2UKCSAqIEB0eXBlIHtNZXNzYWdlPFQ+fQoJICovCgoJLyoqCgkgKiBBIE9uZU9mIGdldHRlciBhcyByZXR1cm5lZCBieSB7QGxpbmsgdXRpbC5vbmVPZkdldHRlcn0uCgkgKiBAdHlwZWRlZiBPbmVPZkdldHRlcgoJICogQHR5cGUge2Z1bmN0aW9ufQoJICogQHJldHVybnMge3N0cmluZ3x1bmRlZmluZWR9IFNldCBmaWVsZCBuYW1lLCBpZiBhbnkKCSAqLwoKCS8qKgoJICogQnVpbGRzIGEgZ2V0dGVyIGZvciBhIG9uZW9mJ3MgcHJlc2VudCBmaWVsZCBuYW1lLgoJICogQHBhcmFtIHtzdHJpbmdbXX0gZmllbGROYW1lcyBGaWVsZCBuYW1lcwoJICogQHJldHVybnMge09uZU9mR2V0dGVyfSBVbmJvdW5kIGdldHRlcgoJICovCgl1dGlsLm9uZU9mR2V0dGVyID0gZnVuY3Rpb24gZ2V0T25lT2YoZmllbGROYW1lcykgewoJICAgIHZhciBmaWVsZE1hcCA9IHt9OwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmllbGROYW1lcy5sZW5ndGg7ICsraSkKCSAgICAgICAgZmllbGRNYXBbZmllbGROYW1lc1tpXV0gPSAxOwoKCSAgICAvKioKCSAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gU2V0IGZpZWxkIG5hbWUsIGlmIGFueQoJICAgICAqIEB0aGlzIE9iamVjdAoJICAgICAqIEBpZ25vcmUKCSAgICAgKi8KCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY29uc2lzdGVudC1yZXR1cm4KCSAgICAgICAgZm9yICh2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMpLCBpID0ga2V5cy5sZW5ndGggLSAxOyBpID4gLTE7IC0taSkKCSAgICAgICAgICAgIGlmIChmaWVsZE1hcFtrZXlzW2ldXSA9PT0gMSAmJiB0aGlzW2tleXNbaV1dICE9PSB1bmRlZmluZWQgJiYgdGhpc1trZXlzW2ldXSAhPT0gbnVsbCkKCSAgICAgICAgICAgICAgICByZXR1cm4ga2V5c1tpXTsKCSAgICB9OwoJfTsKCgkvKioKCSAqIEEgT25lT2Ygc2V0dGVyIGFzIHJldHVybmVkIGJ5IHtAbGluayB1dGlsLm9uZU9mU2V0dGVyfS4KCSAqIEB0eXBlZGVmIE9uZU9mU2V0dGVyCgkgKiBAdHlwZSB7ZnVuY3Rpb259CgkgKiBAcGFyYW0ge3N0cmluZ3x1bmRlZmluZWR9IHZhbHVlIEZpZWxkIG5hbWUKCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9CgkgKi8KCgkvKioKCSAqIEJ1aWxkcyBhIHNldHRlciBmb3IgYSBvbmVvZidzIHByZXNlbnQgZmllbGQgbmFtZS4KCSAqIEBwYXJhbSB7c3RyaW5nW119IGZpZWxkTmFtZXMgRmllbGQgbmFtZXMKCSAqIEByZXR1cm5zIHtPbmVPZlNldHRlcn0gVW5ib3VuZCBzZXR0ZXIKCSAqLwoJdXRpbC5vbmVPZlNldHRlciA9IGZ1bmN0aW9uIHNldE9uZU9mKGZpZWxkTmFtZXMpIHsKCgkgICAgLyoqCgkgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRmllbGQgbmFtZQoJICAgICAqIEByZXR1cm5zIHt1bmRlZmluZWR9CgkgICAgICogQHRoaXMgT2JqZWN0CgkgICAgICogQGlnbm9yZQoJICAgICAqLwoJICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CgkgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmllbGROYW1lcy5sZW5ndGg7ICsraSkKCSAgICAgICAgICAgIGlmIChmaWVsZE5hbWVzW2ldICE9PSBuYW1lKQoJICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2ZpZWxkTmFtZXNbaV1dOwoJICAgIH07Cgl9OwoKCS8qKgoJICogRGVmYXVsdCBjb252ZXJzaW9uIG9wdGlvbnMgdXNlZCBmb3Ige0BsaW5rIE1lc3NhZ2UjdG9KU09OfSBpbXBsZW1lbnRhdGlvbnMuCgkgKgoJICogVGhlc2Ugb3B0aW9ucyBhcmUgY2xvc2UgdG8gcHJvdG8zJ3MgSlNPTiBtYXBwaW5nIHdpdGggdGhlIGV4Y2VwdGlvbiB0aGF0IGludGVybmFsIHR5cGVzIGxpa2UgQW55IGFyZSBoYW5kbGVkIGp1c3QgbGlrZSBtZXNzYWdlcy4gTW9yZSBwcmVjaXNlbHk6CgkgKgoJICogLSBMb25ncyBiZWNvbWUgc3RyaW5ncwoJICogLSBFbnVtcyBiZWNvbWUgc3RyaW5nIGtleXMKCSAqIC0gQnl0ZXMgYmVjb21lIGJhc2U2NCBlbmNvZGVkIHN0cmluZ3MKCSAqIC0gKFN1Yi0pTWVzc2FnZXMgYmVjb21lIHBsYWluIG9iamVjdHMKCSAqIC0gTWFwcyBiZWNvbWUgcGxhaW4gb2JqZWN0cyB3aXRoIGFsbCBzdHJpbmcga2V5cwoJICogLSBSZXBlYXRlZCBmaWVsZHMgYmVjb21lIGFycmF5cwoJICogLSBOYU4gYW5kIEluZmluaXR5IGZvciBmbG9hdCBhbmQgZG91YmxlIGZpZWxkcyBiZWNvbWUgc3RyaW5ncwoJICoKCSAqIEB0eXBlIHtJQ29udmVyc2lvbk9wdGlvbnN9CgkgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL3Byb3RvY29sLWJ1ZmZlcnMvZG9jcy9wcm90bzM/aGw9ZW4janNvbgoJICovCgl1dGlsLnRvSlNPTk9wdGlvbnMgPSB7CgkgICAgbG9uZ3M6IFN0cmluZywKCSAgICBlbnVtczogU3RyaW5nLAoJICAgIGJ5dGVzOiBTdHJpbmcsCgkgICAganNvbjogdHJ1ZQoJfTsKCgkvLyBTZXRzIHVwIGJ1ZmZlciB1dGlsaXR5IGFjY29yZGluZyB0byB0aGUgZW52aXJvbm1lbnQgKGNhbGxlZCBpbiBpbmRleC1taW5pbWFsKQoJdXRpbC5fY29uZmlndXJlID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIEJ1ZmZlciA9IHV0aWwuQnVmZmVyOwoJICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgIGlmICghQnVmZmVyKSB7CgkgICAgICAgIHV0aWwuX0J1ZmZlcl9mcm9tID0gdXRpbC5fQnVmZmVyX2FsbG9jVW5zYWZlID0gbnVsbDsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICAvLyBiZWNhdXNlIG5vZGUgNC54IGJ1ZmZlcnMgYXJlIGluY29tcGF0aWJsZSAmIGltbXV0YWJsZQoJICAgIC8vIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2Rjb2RlSU8vcHJvdG9idWYuanMvcHVsbC82NjUKCSAgICB1dGlsLl9CdWZmZXJfZnJvbSA9IEJ1ZmZlci5mcm9tICE9PSBVaW50OEFycmF5LmZyb20gJiYgQnVmZmVyLmZyb20gfHwKCSAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICAgICAgZnVuY3Rpb24gQnVmZmVyX2Zyb20odmFsdWUsIGVuY29kaW5nKSB7CgkgICAgICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcih2YWx1ZSwgZW5jb2RpbmcpOwoJICAgICAgICB9OwoJICAgIHV0aWwuX0J1ZmZlcl9hbGxvY1Vuc2FmZSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSB8fAoJICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoJICAgICAgICBmdW5jdGlvbiBCdWZmZXJfYWxsb2NVbnNhZmUoc2l6ZSkgewoJICAgICAgICAgICAgcmV0dXJuIG5ldyBCdWZmZXIoc2l6ZSk7CgkgICAgICAgIH07Cgl9OwoJfShtaW5pbWFsJDEpKTsKCgl2YXIgd3JpdGVyID0gV3JpdGVyJDE7CgoJdmFyIHV0aWwkNCAgICAgID0gbWluaW1hbCQxOwoKCXZhciBCdWZmZXJXcml0ZXIkMTsgLy8gY3ljbGljCgoJdmFyIExvbmdCaXRzJDEgID0gdXRpbCQ0LkxvbmdCaXRzLAoJICAgIGJhc2U2NCAgICA9IHV0aWwkNC5iYXNlNjQsCgkgICAgdXRmOCQxICAgICAgPSB1dGlsJDQudXRmODsKCgkvKioKCSAqIENvbnN0cnVjdHMgYSBuZXcgd3JpdGVyIG9wZXJhdGlvbiBpbnN0YW5jZS4KCSAqIEBjbGFzc2Rlc2MgU2NoZWR1bGVkIHdyaXRlciBvcGVyYXRpb24uCgkgKiBAY29uc3RydWN0b3IKCSAqIEBwYXJhbSB7ZnVuY3Rpb24oKiwgVWludDhBcnJheSwgbnVtYmVyKX0gZm4gRnVuY3Rpb24gdG8gY2FsbAoJICogQHBhcmFtIHtudW1iZXJ9IGxlbiBWYWx1ZSBieXRlIGxlbmd0aAoJICogQHBhcmFtIHsqfSB2YWwgVmFsdWUgdG8gd3JpdGUKCSAqIEBpZ25vcmUKCSAqLwoJZnVuY3Rpb24gT3AoZm4sIGxlbiwgdmFsKSB7CgoJICAgIC8qKgoJICAgICAqIEZ1bmN0aW9uIHRvIGNhbGwuCgkgICAgICogQHR5cGUge2Z1bmN0aW9uKFVpbnQ4QXJyYXksIG51bWJlciwgKil9CgkgICAgICovCgkgICAgdGhpcy5mbiA9IGZuOwoKCSAgICAvKioKCSAgICAgKiBWYWx1ZSBieXRlIGxlbmd0aC4KCSAgICAgKiBAdHlwZSB7bnVtYmVyfQoJICAgICAqLwoJICAgIHRoaXMubGVuID0gbGVuOwoKCSAgICAvKioKCSAgICAgKiBOZXh0IG9wZXJhdGlvbi4KCSAgICAgKiBAdHlwZSB7V3JpdGVyLk9wfHVuZGVmaW5lZH0KCSAgICAgKi8KCSAgICB0aGlzLm5leHQgPSB1bmRlZmluZWQ7CgoJICAgIC8qKgoJICAgICAqIFZhbHVlIHRvIHdyaXRlLgoJICAgICAqIEB0eXBlIHsqfQoJICAgICAqLwoJICAgIHRoaXMudmFsID0gdmFsOyAvLyB0eXBlIHZhcmllcwoJfQoKCS8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCglmdW5jdGlvbiBub29wKCkge30gLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1lbXB0eS1mdW5jdGlvbgoKCS8qKgoJICogQ29uc3RydWN0cyBhIG5ldyB3cml0ZXIgc3RhdGUgaW5zdGFuY2UuCgkgKiBAY2xhc3NkZXNjIENvcGllZCB3cml0ZXIgc3RhdGUuCgkgKiBAbWVtYmVyb2YgV3JpdGVyCgkgKiBAY29uc3RydWN0b3IKCSAqIEBwYXJhbSB7V3JpdGVyfSB3cml0ZXIgV3JpdGVyIHRvIGNvcHkgc3RhdGUgZnJvbQoJICogQGlnbm9yZQoJICovCglmdW5jdGlvbiBTdGF0ZSh3cml0ZXIpIHsKCgkgICAgLyoqCgkgICAgICogQ3VycmVudCBoZWFkLgoJICAgICAqIEB0eXBlIHtXcml0ZXIuT3B9CgkgICAgICovCgkgICAgdGhpcy5oZWFkID0gd3JpdGVyLmhlYWQ7CgoJICAgIC8qKgoJICAgICAqIEN1cnJlbnQgdGFpbC4KCSAgICAgKiBAdHlwZSB7V3JpdGVyLk9wfQoJICAgICAqLwoJICAgIHRoaXMudGFpbCA9IHdyaXRlci50YWlsOwoKCSAgICAvKioKCSAgICAgKiBDdXJyZW50IGJ1ZmZlciBsZW5ndGguCgkgICAgICogQHR5cGUge251bWJlcn0KCSAgICAgKi8KCSAgICB0aGlzLmxlbiA9IHdyaXRlci5sZW47CgoJICAgIC8qKgoJICAgICAqIE5leHQgc3RhdGUuCgkgICAgICogQHR5cGUge1N0YXRlfG51bGx9CgkgICAgICovCgkgICAgdGhpcy5uZXh0ID0gd3JpdGVyLnN0YXRlczsKCX0KCgkvKioKCSAqIENvbnN0cnVjdHMgYSBuZXcgd3JpdGVyIGluc3RhbmNlLgoJICogQGNsYXNzZGVzYyBXaXJlIGZvcm1hdCB3cml0ZXIgdXNpbmcgYFVpbnQ4QXJyYXlgIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGBBcnJheWAuCgkgKiBAY29uc3RydWN0b3IKCSAqLwoJZnVuY3Rpb24gV3JpdGVyJDEoKSB7CgoJICAgIC8qKgoJICAgICAqIEN1cnJlbnQgbGVuZ3RoLgoJICAgICAqIEB0eXBlIHtudW1iZXJ9CgkgICAgICovCgkgICAgdGhpcy5sZW4gPSAwOwoKCSAgICAvKioKCSAgICAgKiBPcGVyYXRpb25zIGhlYWQuCgkgICAgICogQHR5cGUge09iamVjdH0KCSAgICAgKi8KCSAgICB0aGlzLmhlYWQgPSBuZXcgT3Aobm9vcCwgMCwgMCk7CgoJICAgIC8qKgoJICAgICAqIE9wZXJhdGlvbnMgdGFpbAoJICAgICAqIEB0eXBlIHtPYmplY3R9CgkgICAgICovCgkgICAgdGhpcy50YWlsID0gdGhpcy5oZWFkOwoKCSAgICAvKioKCSAgICAgKiBMaW5rZWQgZm9ya2VkIHN0YXRlcy4KCSAgICAgKiBAdHlwZSB7T2JqZWN0fG51bGx9CgkgICAgICovCgkgICAgdGhpcy5zdGF0ZXMgPSBudWxsOwoKCSAgICAvLyBXaGVuIGEgdmFsdWUgaXMgd3JpdHRlbiwgdGhlIHdyaXRlciBjYWxjdWxhdGVzIGl0cyBieXRlIGxlbmd0aCBhbmQgcHV0cyBpdCBpbnRvIGEgbGlua2VkCgkgICAgLy8gbGlzdCBvZiBvcGVyYXRpb25zIHRvIHBlcmZvcm0gd2hlbiBmaW5pc2goKSBpcyBjYWxsZWQuIFRoaXMgYm90aCBhbGxvd3MgdXMgdG8gYWxsb2NhdGUKCSAgICAvLyBidWZmZXJzIG9mIHRoZSBleGFjdCByZXF1aXJlZCBzaXplIGFuZCByZWR1Y2VzIHRoZSBhbW91bnQgb2Ygd29yayB3ZSBoYXZlIHRvIGRvIGNvbXBhcmVkCgkgICAgLy8gdG8gZmlyc3QgY2FsY3VsYXRpbmcgb3ZlciBvYmplY3RzIGFuZCB0aGVuIGVuY29kaW5nIG92ZXIgb2JqZWN0cy4gSW4gb3VyIGNhc2UsIHRoZSBlbmNvZGluZwoJICAgIC8vIHBhcnQgaXMganVzdCBhIGxpbmtlZCBsaXN0IHdhbGsgY2FsbGluZyBvcGVyYXRpb25zIHdpdGggYWxyZWFkeSBwcmVwYXJlZCB2YWx1ZXMuCgl9CgoJdmFyIGNyZWF0ZSQxID0gZnVuY3Rpb24gY3JlYXRlKCkgewoJICAgIHJldHVybiB1dGlsJDQuQnVmZmVyCgkgICAgICAgID8gZnVuY3Rpb24gY3JlYXRlX2J1ZmZlcl9zZXR1cCgpIHsKCSAgICAgICAgICAgIHJldHVybiAoV3JpdGVyJDEuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlX2J1ZmZlcigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcldyaXRlciQxKCk7CgkgICAgICAgICAgICB9KSgpOwoJICAgICAgICB9CgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgkgICAgICAgIDogZnVuY3Rpb24gY3JlYXRlX2FycmF5KCkgewoJICAgICAgICAgICAgcmV0dXJuIG5ldyBXcml0ZXIkMSgpOwoJICAgICAgICB9OwoJfTsKCgkvKioKCSAqIENyZWF0ZXMgYSBuZXcgd3JpdGVyLgoJICogQGZ1bmN0aW9uCgkgKiBAcmV0dXJucyB7QnVmZmVyV3JpdGVyfFdyaXRlcn0gQSB7QGxpbmsgQnVmZmVyV3JpdGVyfSB3aGVuIEJ1ZmZlcnMgYXJlIHN1cHBvcnRlZCwgb3RoZXJ3aXNlIGEge0BsaW5rIFdyaXRlcn0KCSAqLwoJV3JpdGVyJDEuY3JlYXRlID0gY3JlYXRlJDEoKTsKCgkvKioKCSAqIEFsbG9jYXRlcyBhIGJ1ZmZlciBvZiB0aGUgc3BlY2lmaWVkIHNpemUuCgkgKiBAcGFyYW0ge251bWJlcn0gc2l6ZSBCdWZmZXIgc2l6ZQoJICogQHJldHVybnMge1VpbnQ4QXJyYXl9IEJ1ZmZlcgoJICovCglXcml0ZXIkMS5hbGxvYyA9IGZ1bmN0aW9uIGFsbG9jKHNpemUpIHsKCSAgICByZXR1cm4gbmV3IHV0aWwkNC5BcnJheShzaXplKTsKCX07CgoJLy8gVXNlIFVpbnQ4QXJyYXkgYnVmZmVyIHBvb2wgaW4gdGhlIGJyb3dzZXIsIGp1c3QgbGlrZSBub2RlIGRvZXMgd2l0aCBidWZmZXJzCgkvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoJaWYgKHV0aWwkNC5BcnJheSAhPT0gQXJyYXkpCgkgICAgV3JpdGVyJDEuYWxsb2MgPSB1dGlsJDQucG9vbChXcml0ZXIkMS5hbGxvYywgdXRpbCQ0LkFycmF5LnByb3RvdHlwZS5zdWJhcnJheSk7CgoJLyoqCgkgKiBQdXNoZXMgYSBuZXcgb3BlcmF0aW9uIHRvIHRoZSBxdWV1ZS4KCSAqIEBwYXJhbSB7ZnVuY3Rpb24oVWludDhBcnJheSwgbnVtYmVyLCAqKX0gZm4gRnVuY3Rpb24gdG8gY2FsbAoJICogQHBhcmFtIHtudW1iZXJ9IGxlbiBWYWx1ZSBieXRlIGxlbmd0aAoJICogQHBhcmFtIHtudW1iZXJ9IHZhbCBWYWx1ZSB0byB3cml0ZQoJICogQHJldHVybnMge1dyaXRlcn0gYHRoaXNgCgkgKiBAcHJpdmF0ZQoJICovCglXcml0ZXIkMS5wcm90b3R5cGUuX3B1c2ggPSBmdW5jdGlvbiBwdXNoKGZuLCBsZW4sIHZhbCkgewoJICAgIHRoaXMudGFpbCA9IHRoaXMudGFpbC5uZXh0ID0gbmV3IE9wKGZuLCBsZW4sIHZhbCk7CgkgICAgdGhpcy5sZW4gKz0gbGVuOwoJICAgIHJldHVybiB0aGlzOwoJfTsKCglmdW5jdGlvbiB3cml0ZUJ5dGUodmFsLCBidWYsIHBvcykgewoJICAgIGJ1Zltwb3NdID0gdmFsICYgMjU1OwoJfQoKCWZ1bmN0aW9uIHdyaXRlVmFyaW50MzIodmFsLCBidWYsIHBvcykgewoJICAgIHdoaWxlICh2YWwgPiAxMjcpIHsKCSAgICAgICAgYnVmW3BvcysrXSA9IHZhbCAmIDEyNyB8IDEyODsKCSAgICAgICAgdmFsID4+Pj0gNzsKCSAgICB9CgkgICAgYnVmW3Bvc10gPSB2YWw7Cgl9CgoJLyoqCgkgKiBDb25zdHJ1Y3RzIGEgbmV3IHZhcmludCB3cml0ZXIgb3BlcmF0aW9uIGluc3RhbmNlLgoJICogQGNsYXNzZGVzYyBTY2hlZHVsZWQgdmFyaW50IHdyaXRlciBvcGVyYXRpb24uCgkgKiBAZXh0ZW5kcyBPcAoJICogQGNvbnN0cnVjdG9yCgkgKiBAcGFyYW0ge251bWJlcn0gbGVuIFZhbHVlIGJ5dGUgbGVuZ3RoCgkgKiBAcGFyYW0ge251bWJlcn0gdmFsIFZhbHVlIHRvIHdyaXRlCgkgKiBAaWdub3JlCgkgKi8KCWZ1bmN0aW9uIFZhcmludE9wKGxlbiwgdmFsKSB7CgkgICAgdGhpcy5sZW4gPSBsZW47CgkgICAgdGhpcy5uZXh0ID0gdW5kZWZpbmVkOwoJICAgIHRoaXMudmFsID0gdmFsOwoJfQoKCVZhcmludE9wLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoT3AucHJvdG90eXBlKTsKCVZhcmludE9wLnByb3RvdHlwZS5mbiA9IHdyaXRlVmFyaW50MzI7CgoJLyoqCgkgKiBXcml0ZXMgYW4gdW5zaWduZWQgMzIgYml0IHZhbHVlIGFzIGEgdmFyaW50LgoJICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLnVpbnQzMiA9IGZ1bmN0aW9uIHdyaXRlX3VpbnQzMih2YWx1ZSkgewoJICAgIC8vIGhlcmUsIHRoZSBjYWxsIHRvIHRoaXMucHVzaCBoYXMgYmVlbiBpbmxpbmVkIGFuZCBhIHZhcmludCBzcGVjaWZpYyBPcCBzdWJjbGFzcyBpcyB1c2VkLgoJICAgIC8vIHVpbnQzMiBpcyBieSBmYXIgdGhlIG1vc3QgZnJlcXVlbnRseSB1c2VkIG9wZXJhdGlvbiBhbmQgYmVuZWZpdHMgc2lnbmlmaWNhbnRseSBmcm9tIHRoaXMuCgkgICAgdGhpcy5sZW4gKz0gKHRoaXMudGFpbCA9IHRoaXMudGFpbC5uZXh0ID0gbmV3IFZhcmludE9wKAoJICAgICAgICAodmFsdWUgPSB2YWx1ZSA+Pj4gMCkKCSAgICAgICAgICAgICAgICA8IDEyOCAgICAgICA/IDEKCSAgICAgICAgOiB2YWx1ZSA8IDE2Mzg0ICAgICA/IDIKCSAgICAgICAgOiB2YWx1ZSA8IDIwOTcxNTIgICA/IDMKCSAgICAgICAgOiB2YWx1ZSA8IDI2ODQzNTQ1NiA/IDQKCSAgICAgICAgOiAgICAgICAgICAgICAgICAgICAgIDUsCgkgICAgdmFsdWUpKS5sZW47CgkgICAgcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogV3JpdGVzIGEgc2lnbmVkIDMyIGJpdCB2YWx1ZSBhcyBhIHZhcmludC4KCSAqIEBmdW5jdGlvbgoJICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLmludDMyID0gZnVuY3Rpb24gd3JpdGVfaW50MzIodmFsdWUpIHsKCSAgICByZXR1cm4gdmFsdWUgPCAwCgkgICAgICAgID8gdGhpcy5fcHVzaCh3cml0ZVZhcmludDY0LCAxMCwgTG9uZ0JpdHMkMS5mcm9tTnVtYmVyKHZhbHVlKSkgLy8gMTAgYnl0ZXMgcGVyIHNwZWMKCSAgICAgICAgOiB0aGlzLnVpbnQzMih2YWx1ZSk7Cgl9OwoKCS8qKgoJICogV3JpdGVzIGEgMzIgYml0IHZhbHVlIGFzIGEgdmFyaW50LCB6aWctemFnIGVuY29kZWQuCgkgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgVmFsdWUgdG8gd3JpdGUKCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICovCglXcml0ZXIkMS5wcm90b3R5cGUuc2ludDMyID0gZnVuY3Rpb24gd3JpdGVfc2ludDMyKHZhbHVlKSB7CgkgICAgcmV0dXJuIHRoaXMudWludDMyKCh2YWx1ZSA8PCAxIF4gdmFsdWUgPj4gMzEpID4+PiAwKTsKCX07CgoJZnVuY3Rpb24gd3JpdGVWYXJpbnQ2NCh2YWwsIGJ1ZiwgcG9zKSB7CgkgICAgd2hpbGUgKHZhbC5oaSkgewoJICAgICAgICBidWZbcG9zKytdID0gdmFsLmxvICYgMTI3IHwgMTI4OwoJICAgICAgICB2YWwubG8gPSAodmFsLmxvID4+PiA3IHwgdmFsLmhpIDw8IDI1KSA+Pj4gMDsKCSAgICAgICAgdmFsLmhpID4+Pj0gNzsKCSAgICB9CgkgICAgd2hpbGUgKHZhbC5sbyA+IDEyNykgewoJICAgICAgICBidWZbcG9zKytdID0gdmFsLmxvICYgMTI3IHwgMTI4OwoJICAgICAgICB2YWwubG8gPSB2YWwubG8gPj4+IDc7CgkgICAgfQoJICAgIGJ1Zltwb3MrK10gPSB2YWwubG87Cgl9CgoJLyoqCgkgKiBXcml0ZXMgYW4gdW5zaWduZWQgNjQgYml0IHZhbHVlIGFzIGEgdmFyaW50LgoJICogQHBhcmFtIHtMb25nfG51bWJlcnxzdHJpbmd9IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gSWYgYHZhbHVlYCBpcyBhIHN0cmluZyBhbmQgbm8gbG9uZyBsaWJyYXJ5IGlzIHByZXNlbnQuCgkgKi8KCVdyaXRlciQxLnByb3RvdHlwZS51aW50NjQgPSBmdW5jdGlvbiB3cml0ZV91aW50NjQodmFsdWUpIHsKCSAgICB2YXIgYml0cyA9IExvbmdCaXRzJDEuZnJvbSh2YWx1ZSk7CgkgICAgcmV0dXJuIHRoaXMuX3B1c2god3JpdGVWYXJpbnQ2NCwgYml0cy5sZW5ndGgoKSwgYml0cyk7Cgl9OwoKCS8qKgoJICogV3JpdGVzIGEgc2lnbmVkIDY0IGJpdCB2YWx1ZSBhcyBhIHZhcmludC4KCSAqIEBmdW5jdGlvbgoJICogQHBhcmFtIHtMb25nfG51bWJlcnxzdHJpbmd9IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gSWYgYHZhbHVlYCBpcyBhIHN0cmluZyBhbmQgbm8gbG9uZyBsaWJyYXJ5IGlzIHByZXNlbnQuCgkgKi8KCVdyaXRlciQxLnByb3RvdHlwZS5pbnQ2NCA9IFdyaXRlciQxLnByb3RvdHlwZS51aW50NjQ7CgoJLyoqCgkgKiBXcml0ZXMgYSBzaWduZWQgNjQgYml0IHZhbHVlIGFzIGEgdmFyaW50LCB6aWctemFnIGVuY29kZWQuCgkgKiBAcGFyYW0ge0xvbmd8bnVtYmVyfHN0cmluZ30gdmFsdWUgVmFsdWUgdG8gd3JpdGUKCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICogQHRocm93cyB7VHlwZUVycm9yfSBJZiBgdmFsdWVgIGlzIGEgc3RyaW5nIGFuZCBubyBsb25nIGxpYnJhcnkgaXMgcHJlc2VudC4KCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLnNpbnQ2NCA9IGZ1bmN0aW9uIHdyaXRlX3NpbnQ2NCh2YWx1ZSkgewoJICAgIHZhciBiaXRzID0gTG9uZ0JpdHMkMS5mcm9tKHZhbHVlKS56ekVuY29kZSgpOwoJICAgIHJldHVybiB0aGlzLl9wdXNoKHdyaXRlVmFyaW50NjQsIGJpdHMubGVuZ3RoKCksIGJpdHMpOwoJfTsKCgkvKioKCSAqIFdyaXRlcyBhIGJvb2xpc2ggdmFsdWUgYXMgYSB2YXJpbnQuCgkgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLmJvb2wgPSBmdW5jdGlvbiB3cml0ZV9ib29sKHZhbHVlKSB7CgkgICAgcmV0dXJuIHRoaXMuX3B1c2god3JpdGVCeXRlLCAxLCB2YWx1ZSA/IDEgOiAwKTsKCX07CgoJZnVuY3Rpb24gd3JpdGVGaXhlZDMyKHZhbCwgYnVmLCBwb3MpIHsKCSAgICBidWZbcG9zICAgIF0gPSAgdmFsICAgICAgICAgJiAyNTU7CgkgICAgYnVmW3BvcyArIDFdID0gIHZhbCA+Pj4gOCAgICYgMjU1OwoJICAgIGJ1Zltwb3MgKyAyXSA9ICB2YWwgPj4+IDE2ICAmIDI1NTsKCSAgICBidWZbcG9zICsgM10gPSAgdmFsID4+PiAyNDsKCX0KCgkvKioKCSAqIFdyaXRlcyBhbiB1bnNpZ25lZCAzMiBiaXQgdmFsdWUgYXMgZml4ZWQgMzIgYml0cy4KCSAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSBWYWx1ZSB0byB3cml0ZQoJICogQHJldHVybnMge1dyaXRlcn0gYHRoaXNgCgkgKi8KCVdyaXRlciQxLnByb3RvdHlwZS5maXhlZDMyID0gZnVuY3Rpb24gd3JpdGVfZml4ZWQzMih2YWx1ZSkgewoJICAgIHJldHVybiB0aGlzLl9wdXNoKHdyaXRlRml4ZWQzMiwgNCwgdmFsdWUgPj4+IDApOwoJfTsKCgkvKioKCSAqIFdyaXRlcyBhIHNpZ25lZCAzMiBiaXQgdmFsdWUgYXMgZml4ZWQgMzIgYml0cy4KCSAqIEBmdW5jdGlvbgoJICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLnNmaXhlZDMyID0gV3JpdGVyJDEucHJvdG90eXBlLmZpeGVkMzI7CgoJLyoqCgkgKiBXcml0ZXMgYW4gdW5zaWduZWQgNjQgYml0IHZhbHVlIGFzIGZpeGVkIDY0IGJpdHMuCgkgKiBAcGFyYW0ge0xvbmd8bnVtYmVyfHN0cmluZ30gdmFsdWUgVmFsdWUgdG8gd3JpdGUKCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICogQHRocm93cyB7VHlwZUVycm9yfSBJZiBgdmFsdWVgIGlzIGEgc3RyaW5nIGFuZCBubyBsb25nIGxpYnJhcnkgaXMgcHJlc2VudC4KCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLmZpeGVkNjQgPSBmdW5jdGlvbiB3cml0ZV9maXhlZDY0KHZhbHVlKSB7CgkgICAgdmFyIGJpdHMgPSBMb25nQml0cyQxLmZyb20odmFsdWUpOwoJICAgIHJldHVybiB0aGlzLl9wdXNoKHdyaXRlRml4ZWQzMiwgNCwgYml0cy5sbykuX3B1c2god3JpdGVGaXhlZDMyLCA0LCBiaXRzLmhpKTsKCX07CgoJLyoqCgkgKiBXcml0ZXMgYSBzaWduZWQgNjQgYml0IHZhbHVlIGFzIGZpeGVkIDY0IGJpdHMuCgkgKiBAZnVuY3Rpb24KCSAqIEBwYXJhbSB7TG9uZ3xudW1iZXJ8c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byB3cml0ZQoJICogQHJldHVybnMge1dyaXRlcn0gYHRoaXNgCgkgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IElmIGB2YWx1ZWAgaXMgYSBzdHJpbmcgYW5kIG5vIGxvbmcgbGlicmFyeSBpcyBwcmVzZW50LgoJICovCglXcml0ZXIkMS5wcm90b3R5cGUuc2ZpeGVkNjQgPSBXcml0ZXIkMS5wcm90b3R5cGUuZml4ZWQ2NDsKCgkvKioKCSAqIFdyaXRlcyBhIGZsb2F0ICgzMiBiaXQpLgoJICogQGZ1bmN0aW9uCgkgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgVmFsdWUgdG8gd3JpdGUKCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICovCglXcml0ZXIkMS5wcm90b3R5cGUuZmxvYXQgPSBmdW5jdGlvbiB3cml0ZV9mbG9hdCh2YWx1ZSkgewoJICAgIHJldHVybiB0aGlzLl9wdXNoKHV0aWwkNC5mbG9hdC53cml0ZUZsb2F0TEUsIDQsIHZhbHVlKTsKCX07CgoJLyoqCgkgKiBXcml0ZXMgYSBkb3VibGUgKDY0IGJpdCBmbG9hdCkuCgkgKiBAZnVuY3Rpb24KCSAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSBWYWx1ZSB0byB3cml0ZQoJICogQHJldHVybnMge1dyaXRlcn0gYHRoaXNgCgkgKi8KCVdyaXRlciQxLnByb3RvdHlwZS5kb3VibGUgPSBmdW5jdGlvbiB3cml0ZV9kb3VibGUodmFsdWUpIHsKCSAgICByZXR1cm4gdGhpcy5fcHVzaCh1dGlsJDQuZmxvYXQud3JpdGVEb3VibGVMRSwgOCwgdmFsdWUpOwoJfTsKCgl2YXIgd3JpdGVCeXRlcyA9IHV0aWwkNC5BcnJheS5wcm90b3R5cGUuc2V0CgkgICAgPyBmdW5jdGlvbiB3cml0ZUJ5dGVzX3NldCh2YWwsIGJ1ZiwgcG9zKSB7CgkgICAgICAgIGJ1Zi5zZXQodmFsLCBwb3MpOyAvLyBhbHNvIHdvcmtzIGZvciBwbGFpbiBhcnJheSB2YWx1ZXMKCSAgICB9CgkgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICA6IGZ1bmN0aW9uIHdyaXRlQnl0ZXNfZm9yKHZhbCwgYnVmLCBwb3MpIHsKCSAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWwubGVuZ3RoOyArK2kpCgkgICAgICAgICAgICBidWZbcG9zICsgaV0gPSB2YWxbaV07CgkgICAgfTsKCgkvKioKCSAqIFdyaXRlcyBhIHNlcXVlbmNlIG9mIGJ5dGVzLgoJICogQHBhcmFtIHtVaW50OEFycmF5fHN0cmluZ30gdmFsdWUgQnVmZmVyIG9yIGJhc2U2NCBlbmNvZGVkIHN0cmluZyB0byB3cml0ZQoJICogQHJldHVybnMge1dyaXRlcn0gYHRoaXNgCgkgKi8KCVdyaXRlciQxLnByb3RvdHlwZS5ieXRlcyA9IGZ1bmN0aW9uIHdyaXRlX2J5dGVzKHZhbHVlKSB7CgkgICAgdmFyIGxlbiA9IHZhbHVlLmxlbmd0aCA+Pj4gMDsKCSAgICBpZiAoIWxlbikKCSAgICAgICAgcmV0dXJuIHRoaXMuX3B1c2god3JpdGVCeXRlLCAxLCAwKTsKCSAgICBpZiAodXRpbCQ0LmlzU3RyaW5nKHZhbHVlKSkgewoJICAgICAgICB2YXIgYnVmID0gV3JpdGVyJDEuYWxsb2MobGVuID0gYmFzZTY0Lmxlbmd0aCh2YWx1ZSkpOwoJICAgICAgICBiYXNlNjQuZGVjb2RlKHZhbHVlLCBidWYsIDApOwoJICAgICAgICB2YWx1ZSA9IGJ1ZjsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXMudWludDMyKGxlbikuX3B1c2god3JpdGVCeXRlcywgbGVuLCB2YWx1ZSk7Cgl9OwoKCS8qKgoJICogV3JpdGVzIGEgc3RyaW5nLgoJICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIHRvIHdyaXRlCgkgKiBAcmV0dXJucyB7V3JpdGVyfSBgdGhpc2AKCSAqLwoJV3JpdGVyJDEucHJvdG90eXBlLnN0cmluZyA9IGZ1bmN0aW9uIHdyaXRlX3N0cmluZyh2YWx1ZSkgewoJICAgIHZhciBsZW4gPSB1dGY4JDEubGVuZ3RoKHZhbHVlKTsKCSAgICByZXR1cm4gbGVuCgkgICAgICAgID8gdGhpcy51aW50MzIobGVuKS5fcHVzaCh1dGY4JDEud3JpdGUsIGxlbiwgdmFsdWUpCgkgICAgICAgIDogdGhpcy5fcHVzaCh3cml0ZUJ5dGUsIDEsIDApOwoJfTsKCgkvKioKCSAqIEZvcmtzIHRoaXMgd3JpdGVyJ3Mgc3RhdGUgYnkgcHVzaGluZyBpdCB0byBhIHN0YWNrLgoJICogQ2FsbGluZyB7QGxpbmsgV3JpdGVyI3Jlc2V0fHJlc2V0fSBvciB7QGxpbmsgV3JpdGVyI2xkZWxpbXxsZGVsaW19IHJlc2V0cyB0aGUgd3JpdGVyIHRvIHRoZSBwcmV2aW91cyBzdGF0ZS4KCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICovCglXcml0ZXIkMS5wcm90b3R5cGUuZm9yayA9IGZ1bmN0aW9uIGZvcmsoKSB7CgkgICAgdGhpcy5zdGF0ZXMgPSBuZXcgU3RhdGUodGhpcyk7CgkgICAgdGhpcy5oZWFkID0gdGhpcy50YWlsID0gbmV3IE9wKG5vb3AsIDAsIDApOwoJICAgIHRoaXMubGVuID0gMDsKCSAgICByZXR1cm4gdGhpczsKCX07CgoJLyoqCgkgKiBSZXNldHMgdGhpcyBpbnN0YW5jZSB0byB0aGUgbGFzdCBzdGF0ZS4KCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICovCglXcml0ZXIkMS5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKCSAgICBpZiAodGhpcy5zdGF0ZXMpIHsKCSAgICAgICAgdGhpcy5oZWFkICAgPSB0aGlzLnN0YXRlcy5oZWFkOwoJICAgICAgICB0aGlzLnRhaWwgICA9IHRoaXMuc3RhdGVzLnRhaWw7CgkgICAgICAgIHRoaXMubGVuICAgID0gdGhpcy5zdGF0ZXMubGVuOwoJICAgICAgICB0aGlzLnN0YXRlcyA9IHRoaXMuc3RhdGVzLm5leHQ7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5oZWFkID0gdGhpcy50YWlsID0gbmV3IE9wKG5vb3AsIDAsIDApOwoJICAgICAgICB0aGlzLmxlbiAgPSAwOwoJICAgIH0KCSAgICByZXR1cm4gdGhpczsKCX07CgoJLyoqCgkgKiBSZXNldHMgdG8gdGhlIGxhc3Qgc3RhdGUgYW5kIGFwcGVuZHMgdGhlIGZvcmsgc3RhdGUncyBjdXJyZW50IHdyaXRlIGxlbmd0aCBhcyBhIHZhcmludCBmb2xsb3dlZCBieSBpdHMgb3BlcmF0aW9ucy4KCSAqIEByZXR1cm5zIHtXcml0ZXJ9IGB0aGlzYAoJICovCglXcml0ZXIkMS5wcm90b3R5cGUubGRlbGltID0gZnVuY3Rpb24gbGRlbGltKCkgewoJICAgIHZhciBoZWFkID0gdGhpcy5oZWFkLAoJICAgICAgICB0YWlsID0gdGhpcy50YWlsLAoJICAgICAgICBsZW4gID0gdGhpcy5sZW47CgkgICAgdGhpcy5yZXNldCgpLnVpbnQzMihsZW4pOwoJICAgIGlmIChsZW4pIHsKCSAgICAgICAgdGhpcy50YWlsLm5leHQgPSBoZWFkLm5leHQ7IC8vIHNraXAgbm9vcAoJICAgICAgICB0aGlzLnRhaWwgPSB0YWlsOwoJICAgICAgICB0aGlzLmxlbiArPSBsZW47CgkgICAgfQoJICAgIHJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEZpbmlzaGVzIHRoZSB3cml0ZSBvcGVyYXRpb24uCgkgKiBAcmV0dXJucyB7VWludDhBcnJheX0gRmluaXNoZWQgYnVmZmVyCgkgKi8KCVdyaXRlciQxLnByb3RvdHlwZS5maW5pc2ggPSBmdW5jdGlvbiBmaW5pc2goKSB7CgkgICAgdmFyIGhlYWQgPSB0aGlzLmhlYWQubmV4dCwgLy8gc2tpcCBub29wCgkgICAgICAgIGJ1ZiAgPSB0aGlzLmNvbnN0cnVjdG9yLmFsbG9jKHRoaXMubGVuKSwKCSAgICAgICAgcG9zICA9IDA7CgkgICAgd2hpbGUgKGhlYWQpIHsKCSAgICAgICAgaGVhZC5mbihoZWFkLnZhbCwgYnVmLCBwb3MpOwoJICAgICAgICBwb3MgKz0gaGVhZC5sZW47CgkgICAgICAgIGhlYWQgPSBoZWFkLm5leHQ7CgkgICAgfQoJICAgIC8vIHRoaXMuaGVhZCA9IHRoaXMudGFpbCA9IG51bGw7CgkgICAgcmV0dXJuIGJ1ZjsKCX07CgoJV3JpdGVyJDEuX2NvbmZpZ3VyZSA9IGZ1bmN0aW9uKEJ1ZmZlcldyaXRlcl8pIHsKCSAgICBCdWZmZXJXcml0ZXIkMSA9IEJ1ZmZlcldyaXRlcl87CgkgICAgV3JpdGVyJDEuY3JlYXRlID0gY3JlYXRlJDEoKTsKCSAgICBCdWZmZXJXcml0ZXIkMS5fY29uZmlndXJlKCk7Cgl9OwoKCXZhciB3cml0ZXJfYnVmZmVyID0gQnVmZmVyV3JpdGVyOwoKCS8vIGV4dGVuZHMgV3JpdGVyCgl2YXIgV3JpdGVyID0gd3JpdGVyOwoJKEJ1ZmZlcldyaXRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFdyaXRlci5wcm90b3R5cGUpKS5jb25zdHJ1Y3RvciA9IEJ1ZmZlcldyaXRlcjsKCgl2YXIgdXRpbCQzID0gbWluaW1hbCQxOwoKCS8qKgoJICogQ29uc3RydWN0cyBhIG5ldyBidWZmZXIgd3JpdGVyIGluc3RhbmNlLgoJICogQGNsYXNzZGVzYyBXaXJlIGZvcm1hdCB3cml0ZXIgdXNpbmcgbm9kZSBidWZmZXJzLgoJICogQGV4dGVuZHMgV3JpdGVyCgkgKiBAY29uc3RydWN0b3IKCSAqLwoJZnVuY3Rpb24gQnVmZmVyV3JpdGVyKCkgewoJICAgIFdyaXRlci5jYWxsKHRoaXMpOwoJfQoKCUJ1ZmZlcldyaXRlci5fY29uZmlndXJlID0gZnVuY3Rpb24gKCkgewoJICAgIC8qKgoJICAgICAqIEFsbG9jYXRlcyBhIGJ1ZmZlciBvZiB0aGUgc3BlY2lmaWVkIHNpemUuCgkgICAgICogQGZ1bmN0aW9uCgkgICAgICogQHBhcmFtIHtudW1iZXJ9IHNpemUgQnVmZmVyIHNpemUKCSAgICAgKiBAcmV0dXJucyB7QnVmZmVyfSBCdWZmZXIKCSAgICAgKi8KCSAgICBCdWZmZXJXcml0ZXIuYWxsb2MgPSB1dGlsJDMuX0J1ZmZlcl9hbGxvY1Vuc2FmZTsKCgkgICAgQnVmZmVyV3JpdGVyLndyaXRlQnl0ZXNCdWZmZXIgPSB1dGlsJDMuQnVmZmVyICYmIHV0aWwkMy5CdWZmZXIucHJvdG90eXBlIGluc3RhbmNlb2YgVWludDhBcnJheSAmJiB1dGlsJDMuQnVmZmVyLnByb3RvdHlwZS5zZXQubmFtZSA9PT0gInNldCIKCSAgICAgICAgPyBmdW5jdGlvbiB3cml0ZUJ5dGVzQnVmZmVyX3NldCh2YWwsIGJ1ZiwgcG9zKSB7CgkgICAgICAgICAgYnVmLnNldCh2YWwsIHBvcyk7IC8vIGZhc3RlciB0aGFuIGNvcHkgKHJlcXVpcmVzIG5vZGUgPj0gNCB3aGVyZSBCdWZmZXJzIGV4dGVuZCBVaW50OEFycmF5IGFuZCBzZXQgaXMgcHJvcGVybHkgaW5oZXJpdGVkKQoJICAgICAgICAgIC8vIGFsc28gd29ya3MgZm9yIHBsYWluIGFycmF5IHZhbHVlcwoJICAgICAgICB9CgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgkgICAgICAgIDogZnVuY3Rpb24gd3JpdGVCeXRlc0J1ZmZlcl9jb3B5KHZhbCwgYnVmLCBwb3MpIHsKCSAgICAgICAgICBpZiAodmFsLmNvcHkpIC8vIEJ1ZmZlciB2YWx1ZXMKCSAgICAgICAgICAgIHZhbC5jb3B5KGJ1ZiwgcG9zLCAwLCB2YWwubGVuZ3RoKTsKCSAgICAgICAgICBlbHNlIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsLmxlbmd0aDspIC8vIHBsYWluIGFycmF5IHZhbHVlcwoJICAgICAgICAgICAgYnVmW3BvcysrXSA9IHZhbFtpKytdOwoJICAgICAgICB9OwoJfTsKCgoJLyoqCgkgKiBAb3ZlcnJpZGUKCSAqLwoJQnVmZmVyV3JpdGVyLnByb3RvdHlwZS5ieXRlcyA9IGZ1bmN0aW9uIHdyaXRlX2J5dGVzX2J1ZmZlcih2YWx1ZSkgewoJICAgIGlmICh1dGlsJDMuaXNTdHJpbmcodmFsdWUpKQoJICAgICAgICB2YWx1ZSA9IHV0aWwkMy5fQnVmZmVyX2Zyb20odmFsdWUsICJiYXNlNjQiKTsKCSAgICB2YXIgbGVuID0gdmFsdWUubGVuZ3RoID4+PiAwOwoJICAgIHRoaXMudWludDMyKGxlbik7CgkgICAgaWYgKGxlbikKCSAgICAgICAgdGhpcy5fcHVzaChCdWZmZXJXcml0ZXIud3JpdGVCeXRlc0J1ZmZlciwgbGVuLCB2YWx1ZSk7CgkgICAgcmV0dXJuIHRoaXM7Cgl9OwoKCWZ1bmN0aW9uIHdyaXRlU3RyaW5nQnVmZmVyKHZhbCwgYnVmLCBwb3MpIHsKCSAgICBpZiAodmFsLmxlbmd0aCA8IDQwKSAvLyBwbGFpbiBqcyBpcyBmYXN0ZXIgZm9yIHNob3J0IHN0cmluZ3MgKHByb2JhYmx5IGR1ZSB0byByZWR1bmRhbnQgYXNzZXJ0aW9ucykKCSAgICAgICAgdXRpbCQzLnV0Zjgud3JpdGUodmFsLCBidWYsIHBvcyk7CgkgICAgZWxzZSBpZiAoYnVmLnV0ZjhXcml0ZSkKCSAgICAgICAgYnVmLnV0ZjhXcml0ZSh2YWwsIHBvcyk7CgkgICAgZWxzZQoJICAgICAgICBidWYud3JpdGUodmFsLCBwb3MpOwoJfQoKCS8qKgoJICogQG92ZXJyaWRlCgkgKi8KCUJ1ZmZlcldyaXRlci5wcm90b3R5cGUuc3RyaW5nID0gZnVuY3Rpb24gd3JpdGVfc3RyaW5nX2J1ZmZlcih2YWx1ZSkgewoJICAgIHZhciBsZW4gPSB1dGlsJDMuQnVmZmVyLmJ5dGVMZW5ndGgodmFsdWUpOwoJICAgIHRoaXMudWludDMyKGxlbik7CgkgICAgaWYgKGxlbikKCSAgICAgICAgdGhpcy5fcHVzaCh3cml0ZVN0cmluZ0J1ZmZlciwgbGVuLCB2YWx1ZSk7CgkgICAgcmV0dXJuIHRoaXM7Cgl9OwoKCgkvKioKCSAqIEZpbmlzaGVzIHRoZSB3cml0ZSBvcGVyYXRpb24uCgkgKiBAbmFtZSBCdWZmZXJXcml0ZXIjZmluaXNoCgkgKiBAZnVuY3Rpb24KCSAqIEByZXR1cm5zIHtCdWZmZXJ9IEZpbmlzaGVkIGJ1ZmZlcgoJICovCgoJQnVmZmVyV3JpdGVyLl9jb25maWd1cmUoKTsKCgl2YXIgcmVhZGVyID0gUmVhZGVyJDE7CgoJdmFyIHV0aWwkMiAgICAgID0gbWluaW1hbCQxOwoKCXZhciBCdWZmZXJSZWFkZXIkMTsgLy8gY3ljbGljCgoJdmFyIExvbmdCaXRzICA9IHV0aWwkMi5Mb25nQml0cywKCSAgICB1dGY4ICAgICAgPSB1dGlsJDIudXRmODsKCgkvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoJZnVuY3Rpb24gaW5kZXhPdXRPZlJhbmdlKHJlYWRlciwgd3JpdGVMZW5ndGgpIHsKCSAgICByZXR1cm4gUmFuZ2VFcnJvcigiaW5kZXggb3V0IG9mIHJhbmdlOiAiICsgcmVhZGVyLnBvcyArICIgKyAiICsgKHdyaXRlTGVuZ3RoIHx8IDEpICsgIiA+ICIgKyByZWFkZXIubGVuKTsKCX0KCgkvKioKCSAqIENvbnN0cnVjdHMgYSBuZXcgcmVhZGVyIGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgYnVmZmVyLgoJICogQGNsYXNzZGVzYyBXaXJlIGZvcm1hdCByZWFkZXIgdXNpbmcgYFVpbnQ4QXJyYXlgIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGBBcnJheWAuCgkgKiBAY29uc3RydWN0b3IKCSAqIEBwYXJhbSB7VWludDhBcnJheX0gYnVmZmVyIEJ1ZmZlciB0byByZWFkIGZyb20KCSAqLwoJZnVuY3Rpb24gUmVhZGVyJDEoYnVmZmVyKSB7CgoJICAgIC8qKgoJICAgICAqIFJlYWQgYnVmZmVyLgoJICAgICAqIEB0eXBlIHtVaW50OEFycmF5fQoJICAgICAqLwoJICAgIHRoaXMuYnVmID0gYnVmZmVyOwoKCSAgICAvKioKCSAgICAgKiBSZWFkIGJ1ZmZlciBwb3NpdGlvbi4KCSAgICAgKiBAdHlwZSB7bnVtYmVyfQoJICAgICAqLwoJICAgIHRoaXMucG9zID0gMDsKCgkgICAgLyoqCgkgICAgICogUmVhZCBidWZmZXIgbGVuZ3RoLgoJICAgICAqIEB0eXBlIHtudW1iZXJ9CgkgICAgICovCgkgICAgdGhpcy5sZW4gPSBidWZmZXIubGVuZ3RoOwoJfQoKCXZhciBjcmVhdGVfYXJyYXkgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gInVuZGVmaW5lZCIKCSAgICA/IGZ1bmN0aW9uIGNyZWF0ZV90eXBlZF9hcnJheShidWZmZXIpIHsKCSAgICAgICAgaWYgKGJ1ZmZlciBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgQXJyYXkuaXNBcnJheShidWZmZXIpKQoJICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWFkZXIkMShidWZmZXIpOwoJICAgICAgICB0aHJvdyBFcnJvcigiaWxsZWdhbCBidWZmZXIiKTsKCSAgICB9CgkgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICA6IGZ1bmN0aW9uIGNyZWF0ZV9hcnJheShidWZmZXIpIHsKCSAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYnVmZmVyKSkKCSAgICAgICAgICAgIHJldHVybiBuZXcgUmVhZGVyJDEoYnVmZmVyKTsKCSAgICAgICAgdGhyb3cgRXJyb3IoImlsbGVnYWwgYnVmZmVyIik7CgkgICAgfTsKCgl2YXIgY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKCkgewoJICAgIHJldHVybiB1dGlsJDIuQnVmZmVyCgkgICAgICAgID8gZnVuY3Rpb24gY3JlYXRlX2J1ZmZlcl9zZXR1cChidWZmZXIpIHsKCSAgICAgICAgICAgIHJldHVybiAoUmVhZGVyJDEuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlX2J1ZmZlcihidWZmZXIpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gdXRpbCQyLkJ1ZmZlci5pc0J1ZmZlcihidWZmZXIpCgkgICAgICAgICAgICAgICAgICAgID8gbmV3IEJ1ZmZlclJlYWRlciQxKGJ1ZmZlcikKCSAgICAgICAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICAgICAgICAgICAgICAgICAgOiBjcmVhdGVfYXJyYXkoYnVmZmVyKTsKCSAgICAgICAgICAgIH0pKGJ1ZmZlcik7CgkgICAgICAgIH0KCSAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICAgICAgOiBjcmVhdGVfYXJyYXk7Cgl9OwoKCS8qKgoJICogQ3JlYXRlcyBhIG5ldyByZWFkZXIgdXNpbmcgdGhlIHNwZWNpZmllZCBidWZmZXIuCgkgKiBAZnVuY3Rpb24KCSAqIEBwYXJhbSB7VWludDhBcnJheXxCdWZmZXJ9IGJ1ZmZlciBCdWZmZXIgdG8gcmVhZCBmcm9tCgkgKiBAcmV0dXJucyB7UmVhZGVyfEJ1ZmZlclJlYWRlcn0gQSB7QGxpbmsgQnVmZmVyUmVhZGVyfSBpZiBgYnVmZmVyYCBpcyBhIEJ1ZmZlciwgb3RoZXJ3aXNlIGEge0BsaW5rIFJlYWRlcn0KCSAqIEB0aHJvd3Mge0Vycm9yfSBJZiBgYnVmZmVyYCBpcyBub3QgYSB2YWxpZCBidWZmZXIKCSAqLwoJUmVhZGVyJDEuY3JlYXRlID0gY3JlYXRlKCk7CgoJUmVhZGVyJDEucHJvdG90eXBlLl9zbGljZSA9IHV0aWwkMi5BcnJheS5wcm90b3R5cGUuc3ViYXJyYXkgfHwgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gdXRpbCQyLkFycmF5LnByb3RvdHlwZS5zbGljZTsKCgkvKioKCSAqIFJlYWRzIGEgdmFyaW50IGFzIGFuIHVuc2lnbmVkIDMyIGJpdCB2YWx1ZS4KCSAqIEBmdW5jdGlvbgoJICogQHJldHVybnMge251bWJlcn0gVmFsdWUgcmVhZAoJICovCglSZWFkZXIkMS5wcm90b3R5cGUudWludDMyID0gKGZ1bmN0aW9uIHJlYWRfdWludDMyX3NldHVwKCkgewoJICAgIHZhciB2YWx1ZSA9IDQyOTQ5NjcyOTU7IC8vIG9wdGltaXplciB0eXBlLWhpbnQsIHRlbmRzIHRvIGRlb3B0IG90aGVyd2lzZSAoPyEpCgkgICAgcmV0dXJuIGZ1bmN0aW9uIHJlYWRfdWludDMyKCkgewoJICAgICAgICB2YWx1ZSA9ICggICAgICAgICB0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcgICAgICAgKSA+Pj4gMDsgaWYgKHRoaXMuYnVmW3RoaXMucG9zKytdIDwgMTI4KSByZXR1cm4gdmFsdWU7CgkgICAgICAgIHZhbHVlID0gKHZhbHVlIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmIDEyNykgPDwgIDcpID4+PiAwOyBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpIHJldHVybiB2YWx1ZTsKCSAgICAgICAgdmFsdWUgPSAodmFsdWUgfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCAxNCkgPj4+IDA7IGlmICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSA8IDEyOCkgcmV0dXJuIHZhbHVlOwoJICAgICAgICB2YWx1ZSA9ICh2YWx1ZSB8ICh0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcpIDw8IDIxKSA+Pj4gMDsgaWYgKHRoaXMuYnVmW3RoaXMucG9zKytdIDwgMTI4KSByZXR1cm4gdmFsdWU7CgkgICAgICAgIHZhbHVlID0gKHZhbHVlIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmICAxNSkgPDwgMjgpID4+PiAwOyBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpIHJldHVybiB2YWx1ZTsKCgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgICAgICBpZiAoKHRoaXMucG9zICs9IDUpID4gdGhpcy5sZW4pIHsKCSAgICAgICAgICAgIHRoaXMucG9zID0gdGhpcy5sZW47CgkgICAgICAgICAgICB0aHJvdyBpbmRleE91dE9mUmFuZ2UodGhpcywgMTApOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB2YWx1ZTsKCSAgICB9OwoJfSkoKTsKCgkvKioKCSAqIFJlYWRzIGEgdmFyaW50IGFzIGEgc2lnbmVkIDMyIGJpdCB2YWx1ZS4KCSAqIEByZXR1cm5zIHtudW1iZXJ9IFZhbHVlIHJlYWQKCSAqLwoJUmVhZGVyJDEucHJvdG90eXBlLmludDMyID0gZnVuY3Rpb24gcmVhZF9pbnQzMigpIHsKCSAgICByZXR1cm4gdGhpcy51aW50MzIoKSB8IDA7Cgl9OwoKCS8qKgoJICogUmVhZHMgYSB6aWctemFnIGVuY29kZWQgdmFyaW50IGFzIGEgc2lnbmVkIDMyIGJpdCB2YWx1ZS4KCSAqIEByZXR1cm5zIHtudW1iZXJ9IFZhbHVlIHJlYWQKCSAqLwoJUmVhZGVyJDEucHJvdG90eXBlLnNpbnQzMiA9IGZ1bmN0aW9uIHJlYWRfc2ludDMyKCkgewoJICAgIHZhciB2YWx1ZSA9IHRoaXMudWludDMyKCk7CgkgICAgcmV0dXJuIHZhbHVlID4+PiAxIF4gLSh2YWx1ZSAmIDEpIHwgMDsKCX07CgoJLyogZXNsaW50LWRpc2FibGUgbm8taW52YWxpZC10aGlzICovCgoJZnVuY3Rpb24gcmVhZExvbmdWYXJpbnQoKSB7CgkgICAgLy8gdGVuZHMgdG8gZGVvcHQgd2l0aCBsb2NhbCB2YXJzIGZvciBvY3RldCBldGMuCgkgICAgdmFyIGJpdHMgPSBuZXcgTG9uZ0JpdHMoMCwgMCk7CgkgICAgdmFyIGkgPSAwOwoJICAgIGlmICh0aGlzLmxlbiAtIHRoaXMucG9zID4gNCkgeyAvLyBmYXN0IHJvdXRlIChsbykKCSAgICAgICAgZm9yICg7IGkgPCA0OyArK2kpIHsKCSAgICAgICAgICAgIC8vIDFzdC4uNHRoCgkgICAgICAgICAgICBiaXRzLmxvID0gKGJpdHMubG8gfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCBpICogNykgPj4+IDA7CgkgICAgICAgICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGJpdHM7CgkgICAgICAgIH0KCSAgICAgICAgLy8gNXRoCgkgICAgICAgIGJpdHMubG8gPSAoYml0cy5sbyB8ICh0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcpIDw8IDI4KSA+Pj4gMDsKCSAgICAgICAgYml0cy5oaSA9IChiaXRzLmhpIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmIDEyNykgPj4gIDQpID4+PiAwOwoJICAgICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCgkgICAgICAgICAgICByZXR1cm4gYml0czsKCSAgICAgICAgaSA9IDA7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgZm9yICg7IGkgPCAzOyArK2kpIHsKCSAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgICAgICAgICAgaWYgKHRoaXMucG9zID49IHRoaXMubGVuKQoJICAgICAgICAgICAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzKTsKCSAgICAgICAgICAgIC8vIDFzdC4uM3RoCgkgICAgICAgICAgICBiaXRzLmxvID0gKGJpdHMubG8gfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCBpICogNykgPj4+IDA7CgkgICAgICAgICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGJpdHM7CgkgICAgICAgIH0KCSAgICAgICAgLy8gNHRoCgkgICAgICAgIGJpdHMubG8gPSAoYml0cy5sbyB8ICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSAmIDEyNykgPDwgaSAqIDcpID4+PiAwOwoJICAgICAgICByZXR1cm4gYml0czsKCSAgICB9CgkgICAgaWYgKHRoaXMubGVuIC0gdGhpcy5wb3MgPiA0KSB7IC8vIGZhc3Qgcm91dGUgKGhpKQoJICAgICAgICBmb3IgKDsgaSA8IDU7ICsraSkgewoJICAgICAgICAgICAgLy8gNnRoLi4xMHRoCgkgICAgICAgICAgICBiaXRzLmhpID0gKGJpdHMuaGkgfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCBpICogNyArIDMpID4+PiAwOwoJICAgICAgICAgICAgaWYgKHRoaXMuYnVmW3RoaXMucG9zKytdIDwgMTI4KQoJICAgICAgICAgICAgICAgIHJldHVybiBiaXRzOwoJICAgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgICAgZm9yICg7IGkgPCA1OyArK2kpIHsKCSAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgICAgICAgICAgaWYgKHRoaXMucG9zID49IHRoaXMubGVuKQoJICAgICAgICAgICAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzKTsKCSAgICAgICAgICAgIC8vIDZ0aC4uMTB0aAoJICAgICAgICAgICAgYml0cy5oaSA9IChiaXRzLmhpIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmIDEyNykgPDwgaSAqIDcgKyAzKSA+Pj4gMDsKCSAgICAgICAgICAgIGlmICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSA8IDEyOCkKCSAgICAgICAgICAgICAgICByZXR1cm4gYml0czsKCSAgICAgICAgfQoJICAgIH0KCSAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoJICAgIHRocm93IEVycm9yKCJpbnZhbGlkIHZhcmludCBlbmNvZGluZyIpOwoJfQoKCS8qIGVzbGludC1lbmFibGUgbm8taW52YWxpZC10aGlzICovCgoJLyoqCgkgKiBSZWFkcyBhIHZhcmludCBhcyBhIHNpZ25lZCA2NCBiaXQgdmFsdWUuCgkgKiBAbmFtZSBSZWFkZXIjaW50NjQKCSAqIEBmdW5jdGlvbgoJICogQHJldHVybnMge0xvbmd9IFZhbHVlIHJlYWQKCSAqLwoKCS8qKgoJICogUmVhZHMgYSB2YXJpbnQgYXMgYW4gdW5zaWduZWQgNjQgYml0IHZhbHVlLgoJICogQG5hbWUgUmVhZGVyI3VpbnQ2NAoJICogQGZ1bmN0aW9uCgkgKiBAcmV0dXJucyB7TG9uZ30gVmFsdWUgcmVhZAoJICovCgoJLyoqCgkgKiBSZWFkcyBhIHppZy16YWcgZW5jb2RlZCB2YXJpbnQgYXMgYSBzaWduZWQgNjQgYml0IHZhbHVlLgoJICogQG5hbWUgUmVhZGVyI3NpbnQ2NAoJICogQGZ1bmN0aW9uCgkgKiBAcmV0dXJucyB7TG9uZ30gVmFsdWUgcmVhZAoJICovCgoJLyoqCgkgKiBSZWFkcyBhIHZhcmludCBhcyBhIGJvb2xlYW4uCgkgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVmFsdWUgcmVhZAoJICovCglSZWFkZXIkMS5wcm90b3R5cGUuYm9vbCA9IGZ1bmN0aW9uIHJlYWRfYm9vbCgpIHsKCSAgICByZXR1cm4gdGhpcy51aW50MzIoKSAhPT0gMDsKCX07CgoJZnVuY3Rpb24gcmVhZEZpeGVkMzJfZW5kKGJ1ZiwgZW5kKSB7IC8vIG5vdGUgdGhhdCB0aGlzIHVzZXMgYGVuZGAsIG5vdCBgcG9zYAoJICAgIHJldHVybiAoYnVmW2VuZCAtIDRdCgkgICAgICAgICAgfCBidWZbZW5kIC0gM10gPDwgOAoJICAgICAgICAgIHwgYnVmW2VuZCAtIDJdIDw8IDE2CgkgICAgICAgICAgfCBidWZbZW5kIC0gMV0gPDwgMjQpID4+PiAwOwoJfQoKCS8qKgoJICogUmVhZHMgZml4ZWQgMzIgYml0cyBhcyBhbiB1bnNpZ25lZCAzMiBiaXQgaW50ZWdlci4KCSAqIEByZXR1cm5zIHtudW1iZXJ9IFZhbHVlIHJlYWQKCSAqLwoJUmVhZGVyJDEucHJvdG90eXBlLmZpeGVkMzIgPSBmdW5jdGlvbiByZWFkX2ZpeGVkMzIoKSB7CgoJICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgIGlmICh0aGlzLnBvcyArIDQgPiB0aGlzLmxlbikKCSAgICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMsIDQpOwoKCSAgICByZXR1cm4gcmVhZEZpeGVkMzJfZW5kKHRoaXMuYnVmLCB0aGlzLnBvcyArPSA0KTsKCX07CgoJLyoqCgkgKiBSZWFkcyBmaXhlZCAzMiBiaXRzIGFzIGEgc2lnbmVkIDMyIGJpdCBpbnRlZ2VyLgoJICogQHJldHVybnMge251bWJlcn0gVmFsdWUgcmVhZAoJICovCglSZWFkZXIkMS5wcm90b3R5cGUuc2ZpeGVkMzIgPSBmdW5jdGlvbiByZWFkX3NmaXhlZDMyKCkgewoKCSAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCSAgICBpZiAodGhpcy5wb3MgKyA0ID4gdGhpcy5sZW4pCgkgICAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCA0KTsKCgkgICAgcmV0dXJuIHJlYWRGaXhlZDMyX2VuZCh0aGlzLmJ1ZiwgdGhpcy5wb3MgKz0gNCkgfCAwOwoJfTsKCgkvKiBlc2xpbnQtZGlzYWJsZSBuby1pbnZhbGlkLXRoaXMgKi8KCglmdW5jdGlvbiByZWFkRml4ZWQ2NCgvKiB0aGlzOiBSZWFkZXIgKi8pIHsKCgkgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgkgICAgaWYgKHRoaXMucG9zICsgOCA+IHRoaXMubGVuKQoJICAgICAgICB0aHJvdyBpbmRleE91dE9mUmFuZ2UodGhpcywgOCk7CgoJICAgIHJldHVybiBuZXcgTG9uZ0JpdHMocmVhZEZpeGVkMzJfZW5kKHRoaXMuYnVmLCB0aGlzLnBvcyArPSA0KSwgcmVhZEZpeGVkMzJfZW5kKHRoaXMuYnVmLCB0aGlzLnBvcyArPSA0KSk7Cgl9CgoJLyogZXNsaW50LWVuYWJsZSBuby1pbnZhbGlkLXRoaXMgKi8KCgkvKioKCSAqIFJlYWRzIGZpeGVkIDY0IGJpdHMuCgkgKiBAbmFtZSBSZWFkZXIjZml4ZWQ2NAoJICogQGZ1bmN0aW9uCgkgKiBAcmV0dXJucyB7TG9uZ30gVmFsdWUgcmVhZAoJICovCgoJLyoqCgkgKiBSZWFkcyB6aWctemFnIGVuY29kZWQgZml4ZWQgNjQgYml0cy4KCSAqIEBuYW1lIFJlYWRlciNzZml4ZWQ2NAoJICogQGZ1bmN0aW9uCgkgKiBAcmV0dXJucyB7TG9uZ30gVmFsdWUgcmVhZAoJICovCgoJLyoqCgkgKiBSZWFkcyBhIGZsb2F0ICgzMiBiaXQpIGFzIGEgbnVtYmVyLgoJICogQGZ1bmN0aW9uCgkgKiBAcmV0dXJucyB7bnVtYmVyfSBWYWx1ZSByZWFkCgkgKi8KCVJlYWRlciQxLnByb3RvdHlwZS5mbG9hdCA9IGZ1bmN0aW9uIHJlYWRfZmxvYXQoKSB7CgoJICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgIGlmICh0aGlzLnBvcyArIDQgPiB0aGlzLmxlbikKCSAgICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMsIDQpOwoKCSAgICB2YXIgdmFsdWUgPSB1dGlsJDIuZmxvYXQucmVhZEZsb2F0TEUodGhpcy5idWYsIHRoaXMucG9zKTsKCSAgICB0aGlzLnBvcyArPSA0OwoJICAgIHJldHVybiB2YWx1ZTsKCX07CgoJLyoqCgkgKiBSZWFkcyBhIGRvdWJsZSAoNjQgYml0IGZsb2F0KSBhcyBhIG51bWJlci4KCSAqIEBmdW5jdGlvbgoJICogQHJldHVybnMge251bWJlcn0gVmFsdWUgcmVhZAoJICovCglSZWFkZXIkMS5wcm90b3R5cGUuZG91YmxlID0gZnVuY3Rpb24gcmVhZF9kb3VibGUoKSB7CgoJICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgIGlmICh0aGlzLnBvcyArIDggPiB0aGlzLmxlbikKCSAgICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMsIDQpOwoKCSAgICB2YXIgdmFsdWUgPSB1dGlsJDIuZmxvYXQucmVhZERvdWJsZUxFKHRoaXMuYnVmLCB0aGlzLnBvcyk7CgkgICAgdGhpcy5wb3MgKz0gODsKCSAgICByZXR1cm4gdmFsdWU7Cgl9OwoKCS8qKgoJICogUmVhZHMgYSBzZXF1ZW5jZSBvZiBieXRlcyBwcmVjZWVkZWQgYnkgaXRzIGxlbmd0aCBhcyBhIHZhcmludC4KCSAqIEByZXR1cm5zIHtVaW50OEFycmF5fSBWYWx1ZSByZWFkCgkgKi8KCVJlYWRlciQxLnByb3RvdHlwZS5ieXRlcyA9IGZ1bmN0aW9uIHJlYWRfYnl0ZXMoKSB7CgkgICAgdmFyIGxlbmd0aCA9IHRoaXMudWludDMyKCksCgkgICAgICAgIHN0YXJ0ICA9IHRoaXMucG9zLAoJICAgICAgICBlbmQgICAgPSB0aGlzLnBvcyArIGxlbmd0aDsKCgkgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgkgICAgaWYgKGVuZCA+IHRoaXMubGVuKQoJICAgICAgICB0aHJvdyBpbmRleE91dE9mUmFuZ2UodGhpcywgbGVuZ3RoKTsKCgkgICAgdGhpcy5wb3MgKz0gbGVuZ3RoOwoJICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuYnVmKSkgLy8gcGxhaW4gYXJyYXkKCSAgICAgICAgcmV0dXJuIHRoaXMuYnVmLnNsaWNlKHN0YXJ0LCBlbmQpOwoJICAgIHJldHVybiBzdGFydCA9PT0gZW5kIC8vIGZpeCBmb3IgSUUgMTAvV2luOCBhbmQgb3RoZXJzJyBzdWJhcnJheSByZXR1cm5pbmcgYXJyYXkgb2Ygc2l6ZSAxCgkgICAgICAgID8gbmV3IHRoaXMuYnVmLmNvbnN0cnVjdG9yKDApCgkgICAgICAgIDogdGhpcy5fc2xpY2UuY2FsbCh0aGlzLmJ1Ziwgc3RhcnQsIGVuZCk7Cgl9OwoKCS8qKgoJICogUmVhZHMgYSBzdHJpbmcgcHJlY2VlZGVkIGJ5IGl0cyBieXRlIGxlbmd0aCBhcyBhIHZhcmludC4KCSAqIEByZXR1cm5zIHtzdHJpbmd9IFZhbHVlIHJlYWQKCSAqLwoJUmVhZGVyJDEucHJvdG90eXBlLnN0cmluZyA9IGZ1bmN0aW9uIHJlYWRfc3RyaW5nKCkgewoJICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMoKTsKCSAgICByZXR1cm4gdXRmOC5yZWFkKGJ5dGVzLCAwLCBieXRlcy5sZW5ndGgpOwoJfTsKCgkvKioKCSAqIFNraXBzIHRoZSBzcGVjaWZpZWQgbnVtYmVyIG9mIGJ5dGVzIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIHNraXBzIGEgdmFyaW50LgoJICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGhdIExlbmd0aCBpZiBrbm93biwgb3RoZXJ3aXNlIGEgdmFyaW50IGlzIGFzc3VtZWQKCSAqIEByZXR1cm5zIHtSZWFkZXJ9IGB0aGlzYAoJICovCglSZWFkZXIkMS5wcm90b3R5cGUuc2tpcCA9IGZ1bmN0aW9uIHNraXAobGVuZ3RoKSB7CgkgICAgaWYgKHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiKSB7CgkgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoJICAgICAgICBpZiAodGhpcy5wb3MgKyBsZW5ndGggPiB0aGlzLmxlbikKCSAgICAgICAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCBsZW5ndGgpOwoJICAgICAgICB0aGlzLnBvcyArPSBsZW5ndGg7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgZG8gewoJICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgkgICAgICAgICAgICBpZiAodGhpcy5wb3MgPj0gdGhpcy5sZW4pCgkgICAgICAgICAgICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMpOwoJICAgICAgICB9IHdoaWxlICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSAmIDEyOCk7CgkgICAgfQoJICAgIHJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIFNraXBzIHRoZSBuZXh0IGVsZW1lbnQgb2YgdGhlIHNwZWNpZmllZCB3aXJlIHR5cGUuCgkgKiBAcGFyYW0ge251bWJlcn0gd2lyZVR5cGUgV2lyZSB0eXBlIHJlY2VpdmVkCgkgKiBAcmV0dXJucyB7UmVhZGVyfSBgdGhpc2AKCSAqLwoJUmVhZGVyJDEucHJvdG90eXBlLnNraXBUeXBlID0gZnVuY3Rpb24od2lyZVR5cGUpIHsKCSAgICBzd2l0Y2ggKHdpcmVUeXBlKSB7CgkgICAgICAgIGNhc2UgMDoKCSAgICAgICAgICAgIHRoaXMuc2tpcCgpOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgIGNhc2UgMToKCSAgICAgICAgICAgIHRoaXMuc2tpcCg4KTsKCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICBjYXNlIDI6CgkgICAgICAgICAgICB0aGlzLnNraXAodGhpcy51aW50MzIoKSk7CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgY2FzZSAzOgoJICAgICAgICAgICAgd2hpbGUgKCh3aXJlVHlwZSA9IHRoaXMudWludDMyKCkgJiA3KSAhPT0gNCkgewoJICAgICAgICAgICAgICAgIHRoaXMuc2tpcFR5cGUod2lyZVR5cGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgIGNhc2UgNToKCSAgICAgICAgICAgIHRoaXMuc2tpcCg0KTsKCSAgICAgICAgICAgIGJyZWFrOwoKCSAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCSAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgIHRocm93IEVycm9yKCJpbnZhbGlkIHdpcmUgdHlwZSAiICsgd2lyZVR5cGUgKyAiIGF0IG9mZnNldCAiICsgdGhpcy5wb3MpOwoJICAgIH0KCSAgICByZXR1cm4gdGhpczsKCX07CgoJUmVhZGVyJDEuX2NvbmZpZ3VyZSA9IGZ1bmN0aW9uKEJ1ZmZlclJlYWRlcl8pIHsKCSAgICBCdWZmZXJSZWFkZXIkMSA9IEJ1ZmZlclJlYWRlcl87CgkgICAgUmVhZGVyJDEuY3JlYXRlID0gY3JlYXRlKCk7CgkgICAgQnVmZmVyUmVhZGVyJDEuX2NvbmZpZ3VyZSgpOwoKCSAgICB2YXIgZm4gPSB1dGlsJDIuTG9uZyA/ICJ0b0xvbmciIDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gInRvTnVtYmVyIjsKCSAgICB1dGlsJDIubWVyZ2UoUmVhZGVyJDEucHJvdG90eXBlLCB7CgoJICAgICAgICBpbnQ2NDogZnVuY3Rpb24gcmVhZF9pbnQ2NCgpIHsKCSAgICAgICAgICAgIHJldHVybiByZWFkTG9uZ1ZhcmludC5jYWxsKHRoaXMpW2ZuXShmYWxzZSk7CgkgICAgICAgIH0sCgoJICAgICAgICB1aW50NjQ6IGZ1bmN0aW9uIHJlYWRfdWludDY0KCkgewoJICAgICAgICAgICAgcmV0dXJuIHJlYWRMb25nVmFyaW50LmNhbGwodGhpcylbZm5dKHRydWUpOwoJICAgICAgICB9LAoKCSAgICAgICAgc2ludDY0OiBmdW5jdGlvbiByZWFkX3NpbnQ2NCgpIHsKCSAgICAgICAgICAgIHJldHVybiByZWFkTG9uZ1ZhcmludC5jYWxsKHRoaXMpLnp6RGVjb2RlKClbZm5dKGZhbHNlKTsKCSAgICAgICAgfSwKCgkgICAgICAgIGZpeGVkNjQ6IGZ1bmN0aW9uIHJlYWRfZml4ZWQ2NCgpIHsKCSAgICAgICAgICAgIHJldHVybiByZWFkRml4ZWQ2NC5jYWxsKHRoaXMpW2ZuXSh0cnVlKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHNmaXhlZDY0OiBmdW5jdGlvbiByZWFkX3NmaXhlZDY0KCkgewoJICAgICAgICAgICAgcmV0dXJuIHJlYWRGaXhlZDY0LmNhbGwodGhpcylbZm5dKGZhbHNlKTsKCSAgICAgICAgfQoKCSAgICB9KTsKCX07CgoJdmFyIHJlYWRlcl9idWZmZXIgPSBCdWZmZXJSZWFkZXI7CgoJLy8gZXh0ZW5kcyBSZWFkZXIKCXZhciBSZWFkZXIgPSByZWFkZXI7CgkoQnVmZmVyUmVhZGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmVhZGVyLnByb3RvdHlwZSkpLmNvbnN0cnVjdG9yID0gQnVmZmVyUmVhZGVyOwoKCXZhciB1dGlsJDEgPSBtaW5pbWFsJDE7CgoJLyoqCgkgKiBDb25zdHJ1Y3RzIGEgbmV3IGJ1ZmZlciByZWFkZXIgaW5zdGFuY2UuCgkgKiBAY2xhc3NkZXNjIFdpcmUgZm9ybWF0IHJlYWRlciB1c2luZyBub2RlIGJ1ZmZlcnMuCgkgKiBAZXh0ZW5kcyBSZWFkZXIKCSAqIEBjb25zdHJ1Y3RvcgoJICogQHBhcmFtIHtCdWZmZXJ9IGJ1ZmZlciBCdWZmZXIgdG8gcmVhZCBmcm9tCgkgKi8KCWZ1bmN0aW9uIEJ1ZmZlclJlYWRlcihidWZmZXIpIHsKCSAgICBSZWFkZXIuY2FsbCh0aGlzLCBidWZmZXIpOwoKCSAgICAvKioKCSAgICAgKiBSZWFkIGJ1ZmZlci4KCSAgICAgKiBAbmFtZSBCdWZmZXJSZWFkZXIjYnVmCgkgICAgICogQHR5cGUge0J1ZmZlcn0KCSAgICAgKi8KCX0KCglCdWZmZXJSZWFkZXIuX2NvbmZpZ3VyZSA9IGZ1bmN0aW9uICgpIHsKCSAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoJICAgIGlmICh1dGlsJDEuQnVmZmVyKQoJICAgICAgICBCdWZmZXJSZWFkZXIucHJvdG90eXBlLl9zbGljZSA9IHV0aWwkMS5CdWZmZXIucHJvdG90eXBlLnNsaWNlOwoJfTsKCgoJLyoqCgkgKiBAb3ZlcnJpZGUKCSAqLwoJQnVmZmVyUmVhZGVyLnByb3RvdHlwZS5zdHJpbmcgPSBmdW5jdGlvbiByZWFkX3N0cmluZ19idWZmZXIoKSB7CgkgICAgdmFyIGxlbiA9IHRoaXMudWludDMyKCk7IC8vIG1vZGlmaWVzIHBvcwoJICAgIHJldHVybiB0aGlzLmJ1Zi51dGY4U2xpY2UKCSAgICAgICAgPyB0aGlzLmJ1Zi51dGY4U2xpY2UodGhpcy5wb3MsIHRoaXMucG9zID0gTWF0aC5taW4odGhpcy5wb3MgKyBsZW4sIHRoaXMubGVuKSkKCSAgICAgICAgOiB0aGlzLmJ1Zi50b1N0cmluZygidXRmLTgiLCB0aGlzLnBvcywgdGhpcy5wb3MgPSBNYXRoLm1pbih0aGlzLnBvcyArIGxlbiwgdGhpcy5sZW4pKTsKCX07CgoJLyoqCgkgKiBSZWFkcyBhIHNlcXVlbmNlIG9mIGJ5dGVzIHByZWNlZWRlZCBieSBpdHMgbGVuZ3RoIGFzIGEgdmFyaW50LgoJICogQG5hbWUgQnVmZmVyUmVhZGVyI2J5dGVzCgkgKiBAZnVuY3Rpb24KCSAqIEByZXR1cm5zIHtCdWZmZXJ9IFZhbHVlIHJlYWQKCSAqLwoKCUJ1ZmZlclJlYWRlci5fY29uZmlndXJlKCk7CgoJdmFyIHJwYyA9IHt9OwoKCXZhciBzZXJ2aWNlID0gU2VydmljZTsKCgl2YXIgdXRpbCA9IG1pbmltYWwkMTsKCgkvLyBFeHRlbmRzIEV2ZW50RW1pdHRlcgoJKFNlcnZpY2UucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh1dGlsLkV2ZW50RW1pdHRlci5wcm90b3R5cGUpKS5jb25zdHJ1Y3RvciA9IFNlcnZpY2U7CgoJLyoqCgkgKiBBIHNlcnZpY2UgbWV0aG9kIGNhbGxiYWNrIGFzIHVzZWQgYnkge0BsaW5rIHJwYy5TZXJ2aWNlTWV0aG9kfFNlcnZpY2VNZXRob2R9LgoJICoKCSAqIERpZmZlcnMgZnJvbSB7QGxpbmsgUlBDSW1wbENhbGxiYWNrfSBpbiB0aGF0IGl0IGlzIGFuIGFjdHVhbCBjYWxsYmFjayBvZiBhIHNlcnZpY2UgbWV0aG9kIHdoaWNoIG1heSBub3QgcmV0dXJuIGByZXNwb25zZSA9IG51bGxgLgoJICogQHR5cGVkZWYgcnBjLlNlcnZpY2VNZXRob2RDYWxsYmFjawoJICogQHRlbXBsYXRlIFRSZXMgZXh0ZW5kcyBNZXNzYWdlPFRSZXM+CgkgKiBAdHlwZSB7ZnVuY3Rpb259CgkgKiBAcGFyYW0ge0Vycm9yfG51bGx9IGVycm9yIEVycm9yLCBpZiBhbnkKCSAqIEBwYXJhbSB7VFJlc30gW3Jlc3BvbnNlXSBSZXNwb25zZSBtZXNzYWdlCgkgKiBAcmV0dXJucyB7dW5kZWZpbmVkfQoJICovCgoJLyoqCgkgKiBBIHNlcnZpY2UgbWV0aG9kIHBhcnQgb2YgYSB7QGxpbmsgcnBjLlNlcnZpY2V9IGFzIGNyZWF0ZWQgYnkge0BsaW5rIFNlcnZpY2UuY3JlYXRlfS4KCSAqIEB0eXBlZGVmIHJwYy5TZXJ2aWNlTWV0aG9kCgkgKiBAdGVtcGxhdGUgVFJlcSBleHRlbmRzIE1lc3NhZ2U8VFJlcT4KCSAqIEB0ZW1wbGF0ZSBUUmVzIGV4dGVuZHMgTWVzc2FnZTxUUmVzPgoJICogQHR5cGUge2Z1bmN0aW9ufQoJICogQHBhcmFtIHtUUmVxfFByb3BlcnRpZXM8VFJlcT59IHJlcXVlc3QgUmVxdWVzdCBtZXNzYWdlIG9yIHBsYWluIG9iamVjdAoJICogQHBhcmFtIHtycGMuU2VydmljZU1ldGhvZENhbGxiYWNrPFRSZXM+fSBbY2FsbGJhY2tdIE5vZGUtc3R5bGUgY2FsbGJhY2sgY2FsbGVkIHdpdGggdGhlIGVycm9yLCBpZiBhbnksIGFuZCB0aGUgcmVzcG9uc2UgbWVzc2FnZQoJICogQHJldHVybnMge1Byb21pc2U8TWVzc2FnZTxUUmVzPj59IFByb21pc2UgaWYgYGNhbGxiYWNrYCBoYXMgYmVlbiBvbWl0dGVkLCBvdGhlcndpc2UgYHVuZGVmaW5lZGAKCSAqLwoKCS8qKgoJICogQ29uc3RydWN0cyBhIG5ldyBSUEMgc2VydmljZSBpbnN0YW5jZS4KCSAqIEBjbGFzc2Rlc2MgQW4gUlBDIHNlcnZpY2UgYXMgcmV0dXJuZWQgYnkge0BsaW5rIFNlcnZpY2UjY3JlYXRlfS4KCSAqIEBleHBvcnRzIHJwYy5TZXJ2aWNlCgkgKiBAZXh0ZW5kcyB1dGlsLkV2ZW50RW1pdHRlcgoJICogQGNvbnN0cnVjdG9yCgkgKiBAcGFyYW0ge1JQQ0ltcGx9IHJwY0ltcGwgUlBDIGltcGxlbWVudGF0aW9uCgkgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXF1ZXN0RGVsaW1pdGVkPWZhbHNlXSBXaGV0aGVyIHJlcXVlc3RzIGFyZSBsZW5ndGgtZGVsaW1pdGVkCgkgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNwb25zZURlbGltaXRlZD1mYWxzZV0gV2hldGhlciByZXNwb25zZXMgYXJlIGxlbmd0aC1kZWxpbWl0ZWQKCSAqLwoJZnVuY3Rpb24gU2VydmljZShycGNJbXBsLCByZXF1ZXN0RGVsaW1pdGVkLCByZXNwb25zZURlbGltaXRlZCkgewoKCSAgICBpZiAodHlwZW9mIHJwY0ltcGwgIT09ICJmdW5jdGlvbiIpCgkgICAgICAgIHRocm93IFR5cGVFcnJvcigicnBjSW1wbCBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKCgkgICAgdXRpbC5FdmVudEVtaXR0ZXIuY2FsbCh0aGlzKTsKCgkgICAgLyoqCgkgICAgICogUlBDIGltcGxlbWVudGF0aW9uLiBCZWNvbWVzIGBudWxsYCBvbmNlIHRoZSBzZXJ2aWNlIGlzIGVuZGVkLgoJICAgICAqIEB0eXBlIHtSUENJbXBsfG51bGx9CgkgICAgICovCgkgICAgdGhpcy5ycGNJbXBsID0gcnBjSW1wbDsKCgkgICAgLyoqCgkgICAgICogV2hldGhlciByZXF1ZXN0cyBhcmUgbGVuZ3RoLWRlbGltaXRlZC4KCSAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KCSAgICAgKi8KCSAgICB0aGlzLnJlcXVlc3REZWxpbWl0ZWQgPSBCb29sZWFuKHJlcXVlc3REZWxpbWl0ZWQpOwoKCSAgICAvKioKCSAgICAgKiBXaGV0aGVyIHJlc3BvbnNlcyBhcmUgbGVuZ3RoLWRlbGltaXRlZC4KCSAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KCSAgICAgKi8KCSAgICB0aGlzLnJlc3BvbnNlRGVsaW1pdGVkID0gQm9vbGVhbihyZXNwb25zZURlbGltaXRlZCk7Cgl9CgoJLyoqCgkgKiBDYWxscyBhIHNlcnZpY2UgbWV0aG9kIHRocm91Z2gge0BsaW5rIHJwYy5TZXJ2aWNlI3JwY0ltcGx8cnBjSW1wbH0uCgkgKiBAcGFyYW0ge01ldGhvZHxycGMuU2VydmljZU1ldGhvZDxUUmVxLFRSZXM+fSBtZXRob2QgUmVmbGVjdGVkIG9yIHN0YXRpYyBtZXRob2QKCSAqIEBwYXJhbSB7Q29uc3RydWN0b3I8VFJlcT59IHJlcXVlc3RDdG9yIFJlcXVlc3QgY29uc3RydWN0b3IKCSAqIEBwYXJhbSB7Q29uc3RydWN0b3I8VFJlcz59IHJlc3BvbnNlQ3RvciBSZXNwb25zZSBjb25zdHJ1Y3RvcgoJICogQHBhcmFtIHtUUmVxfFByb3BlcnRpZXM8VFJlcT59IHJlcXVlc3QgUmVxdWVzdCBtZXNzYWdlIG9yIHBsYWluIG9iamVjdAoJICogQHBhcmFtIHtycGMuU2VydmljZU1ldGhvZENhbGxiYWNrPFRSZXM+fSBjYWxsYmFjayBTZXJ2aWNlIGNhbGxiYWNrCgkgKiBAcmV0dXJucyB7dW5kZWZpbmVkfQoJICogQHRlbXBsYXRlIFRSZXEgZXh0ZW5kcyBNZXNzYWdlPFRSZXE+CgkgKiBAdGVtcGxhdGUgVFJlcyBleHRlbmRzIE1lc3NhZ2U8VFJlcz4KCSAqLwoJU2VydmljZS5wcm90b3R5cGUucnBjQ2FsbCA9IGZ1bmN0aW9uIHJwY0NhbGwobWV0aG9kLCByZXF1ZXN0Q3RvciwgcmVzcG9uc2VDdG9yLCByZXF1ZXN0LCBjYWxsYmFjaykgewoKCSAgICBpZiAoIXJlcXVlc3QpCgkgICAgICAgIHRocm93IFR5cGVFcnJvcigicmVxdWVzdCBtdXN0IGJlIHNwZWNpZmllZCIpOwoKCSAgICB2YXIgc2VsZiA9IHRoaXM7CgkgICAgaWYgKCFjYWxsYmFjaykKCSAgICAgICAgcmV0dXJuIHV0aWwuYXNQcm9taXNlKHJwY0NhbGwsIHNlbGYsIG1ldGhvZCwgcmVxdWVzdEN0b3IsIHJlc3BvbnNlQ3RvciwgcmVxdWVzdCk7CgoJICAgIGlmICghc2VsZi5ycGNJbXBsKSB7CgkgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGNhbGxiYWNrKEVycm9yKCJhbHJlYWR5IGVuZGVkIikpOyB9LCAwKTsKCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCSAgICB9CgoJICAgIHRyeSB7CgkgICAgICAgIHJldHVybiBzZWxmLnJwY0ltcGwoCgkgICAgICAgICAgICBtZXRob2QsCgkgICAgICAgICAgICByZXF1ZXN0Q3RvcltzZWxmLnJlcXVlc3REZWxpbWl0ZWQgPyAiZW5jb2RlRGVsaW1pdGVkIiA6ICJlbmNvZGUiXShyZXF1ZXN0KS5maW5pc2goKSwKCSAgICAgICAgICAgIGZ1bmN0aW9uIHJwY0NhbGxiYWNrKGVyciwgcmVzcG9uc2UpIHsKCgkgICAgICAgICAgICAgICAgaWYgKGVycikgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLmVtaXQoImVycm9yIiwgZXJyLCBtZXRob2QpOwoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKCSAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZSA9PT0gbnVsbCkgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLmVuZCgvKiBlbmRlZEJ5UlBDICovIHRydWUpOwoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgaWYgKCEocmVzcG9uc2UgaW5zdGFuY2VvZiByZXNwb25zZUN0b3IpKSB7CgkgICAgICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlc3BvbnNlQ3RvcltzZWxmLnJlc3BvbnNlRGVsaW1pdGVkID8gImRlY29kZURlbGltaXRlZCIgOiAiZGVjb2RlIl0ocmVzcG9uc2UpOwoJICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgiZXJyb3IiLCBlcnIsIG1ldGhvZCk7CgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCJkYXRhIiwgcmVzcG9uc2UsIG1ldGhvZCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgKTsKCSAgICB9IGNhdGNoIChlcnIpIHsKCSAgICAgICAgc2VsZi5lbWl0KCJlcnJvciIsIGVyciwgbWV0aG9kKTsKCSAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsgY2FsbGJhY2soZXJyKTsgfSwgMCk7CgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgfQoJfTsKCgkvKioKCSAqIEVuZHMgdGhpcyBzZXJ2aWNlIGFuZCBlbWl0cyB0aGUgYGVuZGAgZXZlbnQuCgkgKiBAcGFyYW0ge2Jvb2xlYW59IFtlbmRlZEJ5UlBDPWZhbHNlXSBXaGV0aGVyIHRoZSBzZXJ2aWNlIGhhcyBiZWVuIGVuZGVkIGJ5IHRoZSBSUEMgaW1wbGVtZW50YXRpb24uCgkgKiBAcmV0dXJucyB7cnBjLlNlcnZpY2V9IGB0aGlzYAoJICovCglTZXJ2aWNlLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiBlbmQoZW5kZWRCeVJQQykgewoJICAgIGlmICh0aGlzLnJwY0ltcGwpIHsKCSAgICAgICAgaWYgKCFlbmRlZEJ5UlBDKSAvLyBzaWduYWwgZW5kIHRvIHJwY0ltcGwKCSAgICAgICAgICAgIHRoaXMucnBjSW1wbChudWxsLCBudWxsLCBudWxsKTsKCSAgICAgICAgdGhpcy5ycGNJbXBsID0gbnVsbDsKCSAgICAgICAgdGhpcy5lbWl0KCJlbmQiKS5vZmYoKTsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXM7Cgl9OwoKCShmdW5jdGlvbiAoZXhwb3J0cykgewoKCS8qKgoJICogU3RyZWFtaW5nIFJQQyBoZWxwZXJzLgoJICogQG5hbWVzcGFjZQoJICovCgl2YXIgcnBjID0gZXhwb3J0czsKCgkvKioKCSAqIFJQQyBpbXBsZW1lbnRhdGlvbiBwYXNzZWQgdG8ge0BsaW5rIFNlcnZpY2UjY3JlYXRlfSBwZXJmb3JtaW5nIGEgc2VydmljZSByZXF1ZXN0IG9uIG5ldHdvcmsgbGV2ZWwsIGkuZS4gYnkgdXRpbGl6aW5nIGh0dHAgcmVxdWVzdHMgb3Igd2Vic29ja2V0cy4KCSAqIEB0eXBlZGVmIFJQQ0ltcGwKCSAqIEB0eXBlIHtmdW5jdGlvbn0KCSAqIEBwYXJhbSB7TWV0aG9kfHJwYy5TZXJ2aWNlTWV0aG9kPE1lc3NhZ2U8e30+LE1lc3NhZ2U8e30+Pn0gbWV0aG9kIFJlZmxlY3RlZCBvciBzdGF0aWMgbWV0aG9kIGJlaW5nIGNhbGxlZAoJICogQHBhcmFtIHtVaW50OEFycmF5fSByZXF1ZXN0RGF0YSBSZXF1ZXN0IGRhdGEKCSAqIEBwYXJhbSB7UlBDSW1wbENhbGxiYWNrfSBjYWxsYmFjayBDYWxsYmFjayBmdW5jdGlvbgoJICogQHJldHVybnMge3VuZGVmaW5lZH0KCSAqIEBleGFtcGxlCgkgKiBmdW5jdGlvbiBycGNJbXBsKG1ldGhvZCwgcmVxdWVzdERhdGEsIGNhbGxiYWNrKSB7CgkgKiAgICAgaWYgKHByb3RvYnVmLnV0aWwubGNGaXJzdChtZXRob2QubmFtZSkgIT09ICJteU1ldGhvZCIpIC8vIGNvbXBhdGlibGUgd2l0aCBzdGF0aWMgY29kZQoJICogICAgICAgICB0aHJvdyBFcnJvcigibm8gc3VjaCBtZXRob2QiKTsKCSAqICAgICBhc3luY2hyb25vdXNseU9idGFpbkFSZXNwb25zZShyZXF1ZXN0RGF0YSwgZnVuY3Rpb24oZXJyLCByZXNwb25zZURhdGEpIHsKCSAqICAgICAgICAgY2FsbGJhY2soZXJyLCByZXNwb25zZURhdGEpOwoJICogICAgIH0pOwoJICogfQoJICovCgoJLyoqCgkgKiBOb2RlLXN0eWxlIGNhbGxiYWNrIGFzIHVzZWQgYnkge0BsaW5rIFJQQ0ltcGx9LgoJICogQHR5cGVkZWYgUlBDSW1wbENhbGxiYWNrCgkgKiBAdHlwZSB7ZnVuY3Rpb259CgkgKiBAcGFyYW0ge0Vycm9yfG51bGx9IGVycm9yIEVycm9yLCBpZiBhbnksIG90aGVyd2lzZSBgbnVsbGAKCSAqIEBwYXJhbSB7VWludDhBcnJheXxudWxsfSBbcmVzcG9uc2VdIFJlc3BvbnNlIGRhdGEgb3IgYG51bGxgIHRvIHNpZ25hbCBlbmQgb2Ygc3RyZWFtLCBpZiB0aGVyZSBoYXNuJ3QgYmVlbiBhbiBlcnJvcgoJICogQHJldHVybnMge3VuZGVmaW5lZH0KCSAqLwoKCXJwYy5TZXJ2aWNlID0gc2VydmljZTsKCX0ocnBjKSk7CgoJdmFyIHJvb3RzID0ge307CgoJKGZ1bmN0aW9uIChleHBvcnRzKSB7Cgl2YXIgcHJvdG9idWYgPSBleHBvcnRzOwoKCS8qKgoJICogQnVpbGQgdHlwZSwgb25lIG9mIGAiZnVsbCJgLCBgImxpZ2h0ImAgb3IgYCJtaW5pbWFsImAuCgkgKiBAbmFtZSBidWlsZAoJICogQHR5cGUge3N0cmluZ30KCSAqIEBjb25zdAoJICovCglwcm90b2J1Zi5idWlsZCA9ICJtaW5pbWFsIjsKCgkvLyBTZXJpYWxpemF0aW9uCglwcm90b2J1Zi5Xcml0ZXIgICAgICAgPSB3cml0ZXI7Cglwcm90b2J1Zi5CdWZmZXJXcml0ZXIgPSB3cml0ZXJfYnVmZmVyOwoJcHJvdG9idWYuUmVhZGVyICAgICAgID0gcmVhZGVyOwoJcHJvdG9idWYuQnVmZmVyUmVhZGVyID0gcmVhZGVyX2J1ZmZlcjsKCgkvLyBVdGlsaXR5Cglwcm90b2J1Zi51dGlsICAgICAgICAgPSBtaW5pbWFsJDE7Cglwcm90b2J1Zi5ycGMgICAgICAgICAgPSBycGM7Cglwcm90b2J1Zi5yb290cyAgICAgICAgPSByb290czsKCXByb3RvYnVmLmNvbmZpZ3VyZSAgICA9IGNvbmZpZ3VyZTsKCgkvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoJLyoqCgkgKiBSZWNvbmZpZ3VyZXMgdGhlIGxpYnJhcnkgYWNjb3JkaW5nIHRvIHRoZSBlbnZpcm9ubWVudC4KCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9CgkgKi8KCWZ1bmN0aW9uIGNvbmZpZ3VyZSgpIHsKCSAgICBwcm90b2J1Zi51dGlsLl9jb25maWd1cmUoKTsKCSAgICBwcm90b2J1Zi5Xcml0ZXIuX2NvbmZpZ3VyZShwcm90b2J1Zi5CdWZmZXJXcml0ZXIpOwoJICAgIHByb3RvYnVmLlJlYWRlci5fY29uZmlndXJlKHByb3RvYnVmLkJ1ZmZlclJlYWRlcik7Cgl9CgoJLy8gU2V0IHVwIGJ1ZmZlciB1dGlsaXR5IGFjY29yZGluZyB0byB0aGUgZW52aXJvbm1lbnQKCWNvbmZpZ3VyZSgpOwoJfShpbmRleE1pbmltYWwpKTsKCgl2YXIgbWluaW1hbCA9IGluZGV4TWluaW1hbDsKCgl2YXIgJHByb3RvYnVmID0gbWluaW1hbDsKCS8vIENvbW1vbiBhbGlhc2VzCgl2YXIgJFJlYWRlciA9ICRwcm90b2J1Zi5SZWFkZXIsICRXcml0ZXIgPSAkcHJvdG9idWYuV3JpdGVyLCAkdXRpbCA9ICRwcm90b2J1Zi51dGlsOwoJLy8gRXhwb3J0ZWQgcm9vdCBuYW1lc3BhY2UKCXZhciAkcm9vdCA9ICRwcm90b2J1Zi5yb290c1siZGVmYXVsdCJdIHx8ICgkcHJvdG9idWYucm9vdHNbImRlZmF1bHQiXSA9IHt9KTsKCSRyb290LnByb3RvY29sID0gZnVuY3Rpb24oKSB7CgkgICAgLyoqCgkgICAgICogTmFtZXNwYWNlIHByb3RvY29sLgoJICAgICAqIEBleHBvcnRzIHByb3RvY29sCgkgICAgICogQG5hbWVzcGFjZQoJICAgICAqLyB2YXIgcHJvdG9jb2wgPSB7fTsKCSAgICBwcm90b2NvbC5HZW9tZXRyeSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAvKioKCSAgICAgICAgICogUHJvcGVydGllcyBvZiBhIEdlb21ldHJ5LgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGludGVyZmFjZSBJR2VvbWV0cnkKCSAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ8bnVsbH0gW3ZveGVsXSBHZW9tZXRyeSB2b3hlbAoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbZmFjZU5hbWVdIEdlb21ldHJ5IGZhY2VOYW1lCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPG51bWJlcj58bnVsbH0gW3Bvc2l0aW9uc10gR2VvbWV0cnkgcG9zaXRpb25zCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPG51bWJlcj58bnVsbH0gW3V2c10gR2VvbWV0cnkgdXZzCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPG51bWJlcj58bnVsbH0gW2luZGljZXNdIEdlb21ldHJ5IGluZGljZXMKCSAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48bnVtYmVyPnxudWxsfSBbbGlnaHRzXSBHZW9tZXRyeSBsaWdodHMKCSAgICAgICAgICovIC8qKgoJICAgICAgICAgKiBDb25zdHJ1Y3RzIGEgbmV3IEdlb21ldHJ5LgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGEgR2VvbWV0cnkuCgkgICAgICAgICAqIEBpbXBsZW1lbnRzIElHZW9tZXRyeQoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JR2VvbWV0cnk9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICovIGZ1bmN0aW9uIEdlb21ldHJ5KHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gW107CgkgICAgICAgICAgICB0aGlzLnV2cyA9IFtdOwoJICAgICAgICAgICAgdGhpcy5pbmRpY2VzID0gW107CgkgICAgICAgICAgICB0aGlzLmxpZ2h0cyA9IFtdOwoJICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKWlmIChwcm9wZXJ0aWVzW2tleXNbaV1dICE9IG51bGwpIHRoaXNba2V5c1tpXV0gPSBwcm9wZXJ0aWVzW2tleXNbaV1dOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBHZW9tZXRyeSB2b3hlbC4KCSAgICAgICAgICogQG1lbWJlciB7bnVtYmVyfSB2b3hlbAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBHZW9tZXRyeS5wcm90b3R5cGUudm94ZWwgPSAwOwoJICAgICAgICAvKioKCSAgICAgICAgICogR2VvbWV0cnkgZmFjZU5hbWUuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ3xudWxsfHVuZGVmaW5lZH0gZmFjZU5hbWUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkdlb21ldHJ5CgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gR2VvbWV0cnkucHJvdG90eXBlLmZhY2VOYW1lID0gbnVsbDsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdlb21ldHJ5IHBvc2l0aW9ucy4KCSAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPG51bWJlcj59IHBvc2l0aW9ucwoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBHZW9tZXRyeS5wcm90b3R5cGUucG9zaXRpb25zID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdlb21ldHJ5IHV2cy4KCSAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPG51bWJlcj59IHV2cwoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBHZW9tZXRyeS5wcm90b3R5cGUudXZzID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdlb21ldHJ5IGluZGljZXMuCgkgICAgICAgICAqIEBtZW1iZXIge0FycmF5LjxudW1iZXI+fSBpbmRpY2VzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5HZW9tZXRyeQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIEdlb21ldHJ5LnByb3RvdHlwZS5pbmRpY2VzID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdlb21ldHJ5IGxpZ2h0cy4KCSAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPG51bWJlcj59IGxpZ2h0cwoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBHZW9tZXRyeS5wcm90b3R5cGUubGlnaHRzID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLy8gT25lT2YgZmllbGQgbmFtZXMgYm91bmQgdG8gdmlydHVhbCBnZXR0ZXJzIGFuZCBzZXR0ZXJzCgkgICAgICAgIHZhciAkb25lT2ZGaWVsZHM7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBHZW9tZXRyeSBfZmFjZU5hbWUuCgkgICAgICAgICAqIEBtZW1iZXIgeyJmYWNlTmFtZSJ8dW5kZWZpbmVkfSBfZmFjZU5hbWUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkdlb21ldHJ5CgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gT2JqZWN0LmRlZmluZVByb3BlcnR5KEdlb21ldHJ5LnByb3RvdHlwZSwgIl9mYWNlTmFtZSIsIHsKCSAgICAgICAgICAgIGdldDogJHV0aWwub25lT2ZHZXR0ZXIoJG9uZU9mRmllbGRzID0gWwoJICAgICAgICAgICAgICAgICJmYWNlTmFtZSIKCSAgICAgICAgICAgIF0pLAoJICAgICAgICAgICAgc2V0OiAkdXRpbC5vbmVPZlNldHRlcigkb25lT2ZGaWVsZHMpCgkgICAgICAgIH0pOwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBHZW9tZXRyeSBpbnN0YW5jZSB1c2luZyB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkdlb21ldHJ5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JR2VvbWV0cnk9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkdlb21ldHJ5fSBHZW9tZXRyeSBpbnN0YW5jZQoJICAgICAgICAgKi8gR2VvbWV0cnkuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnkocHJvcGVydGllcyk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgR2VvbWV0cnkgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuR2VvbWV0cnkudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkdlb21ldHJ5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JR2VvbWV0cnl9IG1lc3NhZ2UgR2VvbWV0cnkgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBHZW9tZXRyeS5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICBpZiAoIXdyaXRlcikgd3JpdGVyID0gJFdyaXRlci5jcmVhdGUoKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnZveGVsICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInZveGVsIikpIHdyaXRlci51aW50MzIoLyogaWQgMSwgd2lyZVR5cGUgMCA9Ki8gOCkudWludDMyKG1lc3NhZ2Uudm94ZWwpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmFjZU5hbWUgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAiZmFjZU5hbWUiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAyLCB3aXJlVHlwZSAyID0qLyAxOCkuc3RyaW5nKG1lc3NhZ2UuZmFjZU5hbWUpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucG9zaXRpb25zICE9IG51bGwgJiYgbWVzc2FnZS5wb3NpdGlvbnMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgd3JpdGVyLnVpbnQzMigvKiBpZCAzLCB3aXJlVHlwZSAyID0qLyAyNikuZm9yaygpOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBtZXNzYWdlLnBvc2l0aW9ucy5sZW5ndGg7ICsraSl3cml0ZXIuZmxvYXQobWVzc2FnZS5wb3NpdGlvbnNbaV0pOwoJICAgICAgICAgICAgICAgIHdyaXRlci5sZGVsaW0oKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnV2cyAhPSBudWxsICYmIG1lc3NhZ2UudXZzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHdyaXRlci51aW50MzIoLyogaWQgNCwgd2lyZVR5cGUgMiA9Ki8gMzQpLmZvcmsoKTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS51dnMubGVuZ3RoOyArK2kpd3JpdGVyLmZsb2F0KG1lc3NhZ2UudXZzW2ldKTsKCSAgICAgICAgICAgICAgICB3cml0ZXIubGRlbGltKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5pbmRpY2VzICE9IG51bGwgJiYgbWVzc2FnZS5pbmRpY2VzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHdyaXRlci51aW50MzIoLyogaWQgNSwgd2lyZVR5cGUgMiA9Ki8gNDIpLmZvcmsoKTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5pbmRpY2VzLmxlbmd0aDsgKytpKXdyaXRlci5pbnQzMihtZXNzYWdlLmluZGljZXNbaV0pOwoJICAgICAgICAgICAgICAgIHdyaXRlci5sZGVsaW0oKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmxpZ2h0cyAhPSBudWxsICYmIG1lc3NhZ2UubGlnaHRzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHdyaXRlci51aW50MzIoLyogaWQgNiwgd2lyZVR5cGUgMiA9Ki8gNTApLmZvcmsoKTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5saWdodHMubGVuZ3RoOyArK2kpd3JpdGVyLmludDMyKG1lc3NhZ2UubGlnaHRzW2ldKTsKCSAgICAgICAgICAgICAgICB3cml0ZXIubGRlbGltKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gd3JpdGVyOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRW5jb2RlcyB0aGUgc3BlY2lmaWVkIEdlb21ldHJ5IG1lc3NhZ2UsIGxlbmd0aCBkZWxpbWl0ZWQuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIHByb3RvY29sLkdlb21ldHJ5LnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5HZW9tZXRyeQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSUdlb21ldHJ5fSBtZXNzYWdlIEdlb21ldHJ5IG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gR2VvbWV0cnkuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikubGRlbGltKCk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBEZWNvZGVzIGEgR2VvbWV0cnkgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlci4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5SZWFkZXJ8VWludDhBcnJheX0gcmVhZGVyIFJlYWRlciBvciBidWZmZXIgdG8gZGVjb2RlIGZyb20KCSAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGhdIE1lc3NhZ2UgbGVuZ3RoIGlmIGtub3duIGJlZm9yZWhhbmQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkdlb21ldHJ5fSBHZW9tZXRyeQoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIEdlb21ldHJ5LmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIsIGxlbmd0aCkgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9ICRSZWFkZXIuY3JlYXRlKHJlYWRlcik7CgkgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5HZW9tZXRyeSgpOwoJICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZCl7CgkgICAgICAgICAgICAgICAgdmFyIHRhZyA9IHJlYWRlci51aW50MzIoKTsKCSAgICAgICAgICAgICAgICBzd2l0Y2godGFnID4+PiAzKXsKCSAgICAgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Uudm94ZWwgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmZhY2VOYW1lID0gcmVhZGVyLnN0cmluZygpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5wb3NpdGlvbnMgJiYgbWVzc2FnZS5wb3NpdGlvbnMubGVuZ3RoKSkgbWVzc2FnZS5wb3NpdGlvbnMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmQyID0gcmVhZGVyLnVpbnQzMigpICsgcmVhZGVyLnBvczsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZDIpbWVzc2FnZS5wb3NpdGlvbnMucHVzaChyZWFkZXIuZmxvYXQoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIG1lc3NhZ2UucG9zaXRpb25zLnB1c2gocmVhZGVyLmZsb2F0KCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS51dnMgJiYgbWVzc2FnZS51dnMubGVuZ3RoKSkgbWVzc2FnZS51dnMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmQyID0gcmVhZGVyLnVpbnQzMigpICsgcmVhZGVyLnBvczsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZDIpbWVzc2FnZS51dnMucHVzaChyZWFkZXIuZmxvYXQoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIG1lc3NhZ2UudXZzLnB1c2gocmVhZGVyLmZsb2F0KCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDU6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5pbmRpY2VzICYmIG1lc3NhZ2UuaW5kaWNlcy5sZW5ndGgpKSBtZXNzYWdlLmluZGljZXMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmQyID0gcmVhZGVyLnVpbnQzMigpICsgcmVhZGVyLnBvczsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZDIpbWVzc2FnZS5pbmRpY2VzLnB1c2gocmVhZGVyLmludDMyKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBtZXNzYWdlLmluZGljZXMucHVzaChyZWFkZXIuaW50MzIoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgNjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLmxpZ2h0cyAmJiBtZXNzYWdlLmxpZ2h0cy5sZW5ndGgpKSBtZXNzYWdlLmxpZ2h0cyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGFnICYgNykgPT09IDIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZDIgPSByZWFkZXIudWludDMyKCkgKyByZWFkZXIucG9zOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShyZWFkZXIucG9zIDwgZW5kMiltZXNzYWdlLmxpZ2h0cy5wdXNoKHJlYWRlci5pbnQzMigpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgbWVzc2FnZS5saWdodHMucHVzaChyZWFkZXIuaW50MzIoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnICYgNyk7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBHZW9tZXRyeSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5HZW9tZXRyeQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuR2VvbWV0cnl9IEdlb21ldHJ5CgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gR2VvbWV0cnkuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcikgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9IG5ldyAkUmVhZGVyKHJlYWRlcik7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogVmVyaWZpZXMgYSBHZW9tZXRyeSBtZXNzYWdlLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5HZW9tZXRyeQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG1lc3NhZ2UgUGxhaW4gb2JqZWN0IHRvIHZlcmlmeQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgKi8gR2VvbWV0cnkudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWwgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2b3hlbCIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52b3hlbCkpIHJldHVybiAidm94ZWw6IGludGVnZXIgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmFjZU5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJmYWNlTmFtZSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLmZhY2VOYW1lKSkgcmV0dXJuICJmYWNlTmFtZTogc3RyaW5nIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnBvc2l0aW9ucyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBvc2l0aW9ucyIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UucG9zaXRpb25zKSkgcmV0dXJuICJwb3NpdGlvbnM6IGFycmF5IGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5wb3NpdGlvbnMubGVuZ3RoOyArK2kpaWYgKHR5cGVvZiBtZXNzYWdlLnBvc2l0aW9uc1tpXSAhPT0gIm51bWJlciIpIHJldHVybiAicG9zaXRpb25zOiBudW1iZXJbXSBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS51dnMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ1dnMiKSkgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLnV2cykpIHJldHVybiAidXZzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UudXZzLmxlbmd0aDsgKytpKWlmICh0eXBlb2YgbWVzc2FnZS51dnNbaV0gIT09ICJudW1iZXIiKSByZXR1cm4gInV2czogbnVtYmVyW10gZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuaW5kaWNlcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImluZGljZXMiKSkgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLmluZGljZXMpKSByZXR1cm4gImluZGljZXM6IGFycmF5IGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5pbmRpY2VzLmxlbmd0aDsgKytpKWlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UuaW5kaWNlc1tpXSkpIHJldHVybiAiaW5kaWNlczogaW50ZWdlcltdIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmxpZ2h0cyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImxpZ2h0cyIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UubGlnaHRzKSkgcmV0dXJuICJsaWdodHM6IGFycmF5IGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5saWdodHMubGVuZ3RoOyArK2kpaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS5saWdodHNbaV0pKSByZXR1cm4gImxpZ2h0czogaW50ZWdlcltdIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIEdlb21ldHJ5IG1lc3NhZ2UgZnJvbSBhIHBsYWluIG9iamVjdC4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gdGhlaXIgcmVzcGVjdGl2ZSBpbnRlcm5hbCB0eXBlcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGZyb21PYmplY3QKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkdlb21ldHJ5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gb2JqZWN0IFBsYWluIG9iamVjdAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuR2VvbWV0cnl9IEdlb21ldHJ5CgkgICAgICAgICAqLyBHZW9tZXRyeS5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKCSAgICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5HZW9tZXRyeSkgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkdlb21ldHJ5KCk7CgkgICAgICAgICAgICBpZiAob2JqZWN0LnZveGVsICE9IG51bGwpIG1lc3NhZ2Uudm94ZWwgPSBvYmplY3Qudm94ZWwgPj4+IDA7CgkgICAgICAgICAgICBpZiAob2JqZWN0LmZhY2VOYW1lICE9IG51bGwpIG1lc3NhZ2UuZmFjZU5hbWUgPSBTdHJpbmcob2JqZWN0LmZhY2VOYW1lKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QucG9zaXRpb25zKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5wb3NpdGlvbnMpKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5HZW9tZXRyeS5wb3NpdGlvbnM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5wb3NpdGlvbnMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0LnBvc2l0aW9ucy5sZW5ndGg7ICsraSltZXNzYWdlLnBvc2l0aW9uc1tpXSA9IE51bWJlcihvYmplY3QucG9zaXRpb25zW2ldKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvYmplY3QudXZzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC51dnMpKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5HZW9tZXRyeS51dnM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS51dnMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0LnV2cy5sZW5ndGg7ICsraSltZXNzYWdlLnV2c1tpXSA9IE51bWJlcihvYmplY3QudXZzW2ldKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvYmplY3QuaW5kaWNlcykgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QuaW5kaWNlcykpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLkdlb21ldHJ5LmluZGljZXM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5pbmRpY2VzID0gW107CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG9iamVjdC5pbmRpY2VzLmxlbmd0aDsgKytpKW1lc3NhZ2UuaW5kaWNlc1tpXSA9IG9iamVjdC5pbmRpY2VzW2ldIHwgMDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvYmplY3QubGlnaHRzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5saWdodHMpKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5HZW9tZXRyeS5saWdodHM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5saWdodHMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0LmxpZ2h0cy5sZW5ndGg7ICsraSltZXNzYWdlLmxpZ2h0c1tpXSA9IG9iamVjdC5saWdodHNbaV0gfCAwOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBHZW9tZXRyeSBtZXNzYWdlLiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byBvdGhlciB0eXBlcyBpZiBzcGVjaWZpZWQuCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b09iamVjdAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLkdlb21ldHJ5fSBtZXNzYWdlIEdlb21ldHJ5CgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLklDb252ZXJzaW9uT3B0aW9uc30gW29wdGlvbnNdIENvbnZlcnNpb24gb3B0aW9ucwoJICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgKi8gR2VvbWV0cnkudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmFycmF5cyB8fCBvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnBvc2l0aW9ucyA9IFtdOwoJICAgICAgICAgICAgICAgIG9iamVjdC51dnMgPSBbXTsKCSAgICAgICAgICAgICAgICBvYmplY3QuaW5kaWNlcyA9IFtdOwoJICAgICAgICAgICAgICAgIG9iamVjdC5saWdodHMgPSBbXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSBvYmplY3Qudm94ZWwgPSAwOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWwgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2b3hlbCIpKSBvYmplY3Qudm94ZWwgPSBtZXNzYWdlLnZveGVsOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmFjZU5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJmYWNlTmFtZSIpKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LmZhY2VOYW1lID0gbWVzc2FnZS5mYWNlTmFtZTsKCSAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5vbmVvZnMpIG9iamVjdC5fZmFjZU5hbWUgPSAiZmFjZU5hbWUiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucG9zaXRpb25zICYmIG1lc3NhZ2UucG9zaXRpb25zLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC5wb3NpdGlvbnMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS5wb3NpdGlvbnMubGVuZ3RoOyArK2opb2JqZWN0LnBvc2l0aW9uc1tqXSA9IG9wdGlvbnMuanNvbiAmJiAhaXNGaW5pdGUobWVzc2FnZS5wb3NpdGlvbnNbal0pID8gU3RyaW5nKG1lc3NhZ2UucG9zaXRpb25zW2pdKSA6IG1lc3NhZ2UucG9zaXRpb25zW2pdOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudXZzICYmIG1lc3NhZ2UudXZzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC51dnMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS51dnMubGVuZ3RoOyArK2opb2JqZWN0LnV2c1tqXSA9IG9wdGlvbnMuanNvbiAmJiAhaXNGaW5pdGUobWVzc2FnZS51dnNbal0pID8gU3RyaW5nKG1lc3NhZ2UudXZzW2pdKSA6IG1lc3NhZ2UudXZzW2pdOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuaW5kaWNlcyAmJiBtZXNzYWdlLmluZGljZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LmluZGljZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS5pbmRpY2VzLmxlbmd0aDsgKytqKW9iamVjdC5pbmRpY2VzW2pdID0gbWVzc2FnZS5pbmRpY2VzW2pdOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGlnaHRzICYmIG1lc3NhZ2UubGlnaHRzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC5saWdodHMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS5saWdodHMubGVuZ3RoOyArK2opb2JqZWN0LmxpZ2h0c1tqXSA9IG1lc3NhZ2UubGlnaHRzW2pdOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENvbnZlcnRzIHRoaXMgR2VvbWV0cnkgdG8gSlNPTi4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuR2VvbWV0cnkKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICovIEdlb21ldHJ5LnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIEdlb21ldHJ5CgkgICAgICAgICAqIEBmdW5jdGlvbiBnZXRUeXBlVXJsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5HZW9tZXRyeQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdHlwZVVybFByZWZpeF0geW91ciBjdXN0b20gdHlwZVVybFByZWZpeChkZWZhdWx0ICJ0eXBlLmdvb2dsZWFwaXMuY29tIikKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgdHlwZSB1cmwKCSAgICAgICAgICovIEdlb21ldHJ5LmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKCSAgICAgICAgICAgIGlmICh0eXBlVXJsUHJlZml4ID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLkdlb21ldHJ5IjsKCSAgICAgICAgfTsKCSAgICAgICAgcmV0dXJuIEdlb21ldHJ5OwoJICAgIH0oKTsKCSAgICBwcm90b2NvbC5NZXNoID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGEgTWVzaC4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBpbnRlcmZhY2UgSU1lc2gKCSAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ8bnVsbH0gW2xldmVsXSBNZXNoIGxldmVsCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPHByb3RvY29sLklHZW9tZXRyeT58bnVsbH0gW2dlb21ldHJpZXNdIE1lc2ggZ2VvbWV0cmllcwoJICAgICAgICAgKi8gLyoqCgkgICAgICAgICAqIENvbnN0cnVjdHMgYSBuZXcgTWVzaC4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBjbGFzc2Rlc2MgUmVwcmVzZW50cyBhIE1lc2guCgkgICAgICAgICAqIEBpbXBsZW1lbnRzIElNZXNoCgkgICAgICAgICAqIEBjb25zdHJ1Y3RvcgoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklNZXNoPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqLyBmdW5jdGlvbiBNZXNoKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHRoaXMuZ2VvbWV0cmllcyA9IFtdOwoJICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKWlmIChwcm9wZXJ0aWVzW2tleXNbaV1dICE9IG51bGwpIHRoaXNba2V5c1tpXV0gPSBwcm9wZXJ0aWVzW2tleXNbaV1dOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBNZXNoIGxldmVsLgoJICAgICAgICAgKiBAbWVtYmVyIHtudW1iZXJ9IGxldmVsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNoCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gTWVzaC5wcm90b3R5cGUubGV2ZWwgPSAwOwoJICAgICAgICAvKioKCSAgICAgICAgICogTWVzaCBnZW9tZXRyaWVzLgoJICAgICAgICAgKiBAbWVtYmVyIHtBcnJheS48cHJvdG9jb2wuSUdlb21ldHJ5Pn0gZ2VvbWV0cmllcwoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzaAoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIE1lc2gucHJvdG90eXBlLmdlb21ldHJpZXMgPSAkdXRpbC5lbXB0eUFycmF5OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBNZXNoIGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGNyZWF0ZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzaAoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSU1lc2g9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLk1lc2h9IE1lc2ggaW5zdGFuY2UKCSAgICAgICAgICovIE1lc2guY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHJldHVybiBuZXcgTWVzaChwcm9wZXJ0aWVzKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBNZXNoIG1lc3NhZ2UuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIHByb3RvY29sLk1lc2gudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc2gKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklNZXNofSBtZXNzYWdlIE1lc2ggbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBNZXNoLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgIGlmICghd3JpdGVyKSB3cml0ZXIgPSAkV3JpdGVyLmNyZWF0ZSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGV2ZWwgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAibGV2ZWwiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAxLCB3aXJlVHlwZSAwID0qLyA4KS5pbnQzMihtZXNzYWdlLmxldmVsKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmdlb21ldHJpZXMgIT0gbnVsbCAmJiBtZXNzYWdlLmdlb21ldHJpZXMubGVuZ3RoKSBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5nZW9tZXRyaWVzLmxlbmd0aDsgKytpKSRyb290LnByb3RvY29sLkdlb21ldHJ5LmVuY29kZShtZXNzYWdlLmdlb21ldHJpZXNbaV0sIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8gMTgpLmZvcmsoKSkubGRlbGltKCk7CgkgICAgICAgICAgICByZXR1cm4gd3JpdGVyOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRW5jb2RlcyB0aGUgc3BlY2lmaWVkIE1lc2ggbWVzc2FnZSwgbGVuZ3RoIGRlbGltaXRlZC4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuTWVzaC52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzaAoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSU1lc2h9IG1lc3NhZ2UgTWVzaCBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuV3JpdGVyfSBbd3JpdGVyXSBXcml0ZXIgdG8gZW5jb2RlIHRvCgkgICAgICAgICAqIEByZXR1cm5zIHskcHJvdG9idWYuV3JpdGVyfSBXcml0ZXIKCSAgICAgICAgICovIE1lc2guZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikubGRlbGltKCk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBEZWNvZGVzIGEgTWVzaCBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNoCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbGVuZ3RoXSBNZXNzYWdlIGxlbmd0aCBpZiBrbm93biBiZWZvcmVoYW5kCgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5NZXNofSBNZXNoCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gTWVzaC5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyLCBsZW5ndGgpIHsKCSAgICAgICAgICAgIGlmICghKHJlYWRlciBpbnN0YW5jZW9mICRSZWFkZXIpKSByZWFkZXIgPSAkUmVhZGVyLmNyZWF0ZShyZWFkZXIpOwoJICAgICAgICAgICAgdmFyIGVuZCA9IGxlbmd0aCA9PT0gdW5kZWZpbmVkID8gcmVhZGVyLmxlbiA6IHJlYWRlci5wb3MgKyBsZW5ndGgsIG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuTWVzaCgpOwoJICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZCl7CgkgICAgICAgICAgICAgICAgdmFyIHRhZyA9IHJlYWRlci51aW50MzIoKTsKCSAgICAgICAgICAgICAgICBzd2l0Y2godGFnID4+PiAzKXsKCSAgICAgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubGV2ZWwgPSByZWFkZXIuaW50MzIoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG1lc3NhZ2UuZ2VvbWV0cmllcyAmJiBtZXNzYWdlLmdlb21ldHJpZXMubGVuZ3RoKSkgbWVzc2FnZS5nZW9tZXRyaWVzID0gW107CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5nZW9tZXRyaWVzLnB1c2goJHJvb3QucHJvdG9jb2wuR2VvbWV0cnkuZGVjb2RlKHJlYWRlciwgcmVhZGVyLnVpbnQzMigpKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnICYgNyk7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBNZXNoIG1lc3NhZ2UgZnJvbSB0aGUgc3BlY2lmaWVkIHJlYWRlciBvciBidWZmZXIsIGxlbmd0aCBkZWxpbWl0ZWQuCgkgICAgICAgICAqIEBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc2gKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5SZWFkZXJ8VWludDhBcnJheX0gcmVhZGVyIFJlYWRlciBvciBidWZmZXIgdG8gZGVjb2RlIGZyb20KCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLk1lc2h9IE1lc2gKCSAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICogQHRocm93cyB7JHByb3RvYnVmLnV0aWwuUHJvdG9jb2xFcnJvcn0gSWYgcmVxdWlyZWQgZmllbGRzIGFyZSBtaXNzaW5nCgkgICAgICAgICAqLyBNZXNoLmRlY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZChyZWFkZXIpIHsKCSAgICAgICAgICAgIGlmICghKHJlYWRlciBpbnN0YW5jZW9mICRSZWFkZXIpKSByZWFkZXIgPSBuZXcgJFJlYWRlcihyZWFkZXIpOwoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlciwgcmVhZGVyLnVpbnQzMigpKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIFZlcmlmaWVzIGEgTWVzaCBtZXNzYWdlLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNoCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8bnVsbH0gYG51bGxgIGlmIHZhbGlkLCBvdGhlcndpc2UgdGhlIHJlYXNvbiB3aHkgaXQgaXMgbm90CgkgICAgICAgICAqLyBNZXNoLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShtZXNzYWdlKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09ICJvYmplY3QiIHx8IG1lc3NhZ2UgPT09IG51bGwpIHJldHVybiAib2JqZWN0IGV4cGVjdGVkIjsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmxldmVsICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibGV2ZWwiKSkgewoJICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UubGV2ZWwpKSByZXR1cm4gImxldmVsOiBpbnRlZ2VyIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmdlb21ldHJpZXMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJnZW9tZXRyaWVzIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5nZW9tZXRyaWVzKSkgcmV0dXJuICJnZW9tZXRyaWVzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UuZ2VvbWV0cmllcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9ICRyb290LnByb3RvY29sLkdlb21ldHJ5LnZlcmlmeShtZXNzYWdlLmdlb21ldHJpZXNbaV0pOwoJICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiAiZ2VvbWV0cmllcy4iICsgZXJyb3I7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgTWVzaCBtZXNzYWdlIGZyb20gYSBwbGFpbiBvYmplY3QuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIHRoZWlyIHJlc3BlY3RpdmUgaW50ZXJuYWwgdHlwZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBmcm9tT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNoCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gb2JqZWN0IFBsYWluIG9iamVjdAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuTWVzaH0gTWVzaAoJICAgICAgICAgKi8gTWVzaC5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKCSAgICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5NZXNoKSByZXR1cm4gb2JqZWN0OwoJICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuTWVzaCgpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC5sZXZlbCAhPSBudWxsKSBtZXNzYWdlLmxldmVsID0gb2JqZWN0LmxldmVsIHwgMDsKCSAgICAgICAgICAgIGlmIChvYmplY3QuZ2VvbWV0cmllcykgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QuZ2VvbWV0cmllcykpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc2guZ2VvbWV0cmllczogYXJyYXkgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLmdlb21ldHJpZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0Lmdlb21ldHJpZXMubGVuZ3RoOyArK2kpewoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5nZW9tZXRyaWVzW2ldICE9PSAib2JqZWN0IikgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzaC5nZW9tZXRyaWVzOiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5nZW9tZXRyaWVzW2ldID0gJHJvb3QucHJvdG9jb2wuR2VvbWV0cnkuZnJvbU9iamVjdChvYmplY3QuZ2VvbWV0cmllc1tpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBNZXNoIG1lc3NhZ2UuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIG90aGVyIHR5cGVzIGlmIHNwZWNpZmllZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNoCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5NZXNofSBtZXNzYWdlIE1lc2gKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gUGxhaW4gb2JqZWN0CgkgICAgICAgICAqLyBNZXNoLnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewoJICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgkgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CgkgICAgICAgICAgICBpZiAob3B0aW9ucy5hcnJheXMgfHwgb3B0aW9ucy5kZWZhdWx0cykgb2JqZWN0Lmdlb21ldHJpZXMgPSBbXTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSBvYmplY3QubGV2ZWwgPSAwOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGV2ZWwgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsZXZlbCIpKSBvYmplY3QubGV2ZWwgPSBtZXNzYWdlLmxldmVsOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZ2VvbWV0cmllcyAmJiBtZXNzYWdlLmdlb21ldHJpZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0Lmdlb21ldHJpZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS5nZW9tZXRyaWVzLmxlbmd0aDsgKytqKW9iamVjdC5nZW9tZXRyaWVzW2pdID0gJHJvb3QucHJvdG9jb2wuR2VvbWV0cnkudG9PYmplY3QobWVzc2FnZS5nZW9tZXRyaWVzW2pdLCBvcHRpb25zKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDb252ZXJ0cyB0aGlzIE1lc2ggdG8gSlNPTi4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzaAoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICogQHJldHVybnMge09iamVjdC48c3RyaW5nLCo+fSBKU09OIG9iamVjdAoJICAgICAgICAgKi8gTWVzaC5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OKCkgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudG9PYmplY3QodGhpcywgJHByb3RvYnVmLnV0aWwudG9KU09OT3B0aW9ucyk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBHZXRzIHRoZSBkZWZhdWx0IHR5cGUgdXJsIGZvciBNZXNoCgkgICAgICAgICAqIEBmdW5jdGlvbiBnZXRUeXBlVXJsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNoCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlVXJsUHJlZml4XSB5b3VyIGN1c3RvbSB0eXBlVXJsUHJlZml4KGRlZmF1bHQgInR5cGUuZ29vZ2xlYXBpcy5jb20iKQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCB0eXBlIHVybAoJICAgICAgICAgKi8gTWVzaC5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CgkgICAgICAgICAgICBpZiAodHlwZVVybFByZWZpeCA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgdHlwZVVybFByZWZpeCA9ICJ0eXBlLmdvb2dsZWFwaXMuY29tIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB0eXBlVXJsUHJlZml4ICsgIi9wcm90b2NvbC5NZXNoIjsKCSAgICAgICAgfTsKCSAgICAgICAgcmV0dXJuIE1lc2g7CgkgICAgfSgpOwoJICAgIHByb3RvY29sLkNodW5rID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGEgQ2h1bmsuCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbAoJICAgICAgICAgKiBAaW50ZXJmYWNlIElDaHVuawoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbeF0gQ2h1bmsgeAoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbel0gQ2h1bmsgegoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbaWRdIENodW5rIGlkCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPHByb3RvY29sLklNZXNoPnxudWxsfSBbbWVzaGVzXSBDaHVuayBtZXNoZXMKCSAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48bnVtYmVyPnxudWxsfSBbdm94ZWxzXSBDaHVuayB2b3hlbHMKCSAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48bnVtYmVyPnxudWxsfSBbbGlnaHRzXSBDaHVuayBsaWdodHMKCSAgICAgICAgICovIC8qKgoJICAgICAgICAgKiBDb25zdHJ1Y3RzIGEgbmV3IENodW5rLgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGEgQ2h1bmsuCgkgICAgICAgICAqIEBpbXBsZW1lbnRzIElDaHVuawoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2h1bms9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICovIGZ1bmN0aW9uIENodW5rKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHRoaXMubWVzaGVzID0gW107CgkgICAgICAgICAgICB0aGlzLnZveGVscyA9IFtdOwoJICAgICAgICAgICAgdGhpcy5saWdodHMgPSBbXTsKCSAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSlpZiAocHJvcGVydGllc1trZXlzW2ldXSAhPSBudWxsKSB0aGlzW2tleXNbaV1dID0gcHJvcGVydGllc1trZXlzW2ldXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICAvKioKCSAgICAgICAgICogQ2h1bmsgeC4KCSAgICAgICAgICogQG1lbWJlciB7bnVtYmVyfSB4CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIENodW5rLnByb3RvdHlwZS54ID0gMDsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENodW5rIHouCgkgICAgICAgICAqIEBtZW1iZXIge251bWJlcn0gegoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2h1bmsKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBDaHVuay5wcm90b3R5cGUueiA9IDA7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDaHVuayBpZC4KCSAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSBpZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2h1bmsKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBDaHVuay5wcm90b3R5cGUuaWQgPSAiIjsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENodW5rIG1lc2hlcy4KCSAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPHByb3RvY29sLklNZXNoPn0gbWVzaGVzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIENodW5rLnByb3RvdHlwZS5tZXNoZXMgPSAkdXRpbC5lbXB0eUFycmF5OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ2h1bmsgdm94ZWxzLgoJICAgICAgICAgKiBAbWVtYmVyIHtBcnJheS48bnVtYmVyPn0gdm94ZWxzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIENodW5rLnByb3RvdHlwZS52b3hlbHMgPSAkdXRpbC5lbXB0eUFycmF5OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ2h1bmsgbGlnaHRzLgoJICAgICAgICAgKiBAbWVtYmVyIHtBcnJheS48bnVtYmVyPn0gbGlnaHRzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIENodW5rLnByb3RvdHlwZS5saWdodHMgPSAkdXRpbC5lbXB0eUFycmF5OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBDaHVuayBpbnN0YW5jZSB1c2luZyB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkNodW5rCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2h1bms9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkNodW5rfSBDaHVuayBpbnN0YW5jZQoJICAgICAgICAgKi8gQ2h1bmsuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHJldHVybiBuZXcgQ2h1bmsocHJvcGVydGllcyk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgQ2h1bmsgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuQ2h1bmsudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkNodW5rCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2h1bmt9IG1lc3NhZ2UgQ2h1bmsgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBDaHVuay5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICBpZiAoIXdyaXRlcikgd3JpdGVyID0gJFdyaXRlci5jcmVhdGUoKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnggIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAieCIpKSB3cml0ZXIudWludDMyKC8qIGlkIDEsIHdpcmVUeXBlIDAgPSovIDgpLmludDMyKG1lc3NhZ2UueCk7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS56ICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInoiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAyLCB3aXJlVHlwZSAwID0qLyAxNikuaW50MzIobWVzc2FnZS56KTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImlkIikpIHdyaXRlci51aW50MzIoLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8gMjYpLnN0cmluZyhtZXNzYWdlLmlkKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm1lc2hlcyAhPSBudWxsICYmIG1lc3NhZ2UubWVzaGVzLmxlbmd0aCkgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UubWVzaGVzLmxlbmd0aDsgKytpKSRyb290LnByb3RvY29sLk1lc2guZW5jb2RlKG1lc3NhZ2UubWVzaGVzW2ldLCB3cml0ZXIudWludDMyKC8qIGlkIDQsIHdpcmVUeXBlIDIgPSovIDM0KS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWxzICE9IG51bGwgJiYgbWVzc2FnZS52b3hlbHMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgd3JpdGVyLnVpbnQzMigvKiBpZCA1LCB3aXJlVHlwZSAyID0qLyA0MikuZm9yaygpOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBtZXNzYWdlLnZveGVscy5sZW5ndGg7ICsraSl3cml0ZXIudWludDMyKG1lc3NhZ2Uudm94ZWxzW2ldKTsKCSAgICAgICAgICAgICAgICB3cml0ZXIubGRlbGltKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgIT0gbnVsbCAmJiBtZXNzYWdlLmxpZ2h0cy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICB3cml0ZXIudWludDMyKC8qIGlkIDYsIHdpcmVUeXBlIDIgPSovIDUwKS5mb3JrKCk7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UubGlnaHRzLmxlbmd0aDsgKytpKXdyaXRlci51aW50MzIobWVzc2FnZS5saWdodHNbaV0pOwoJICAgICAgICAgICAgICAgIHdyaXRlci5sZGVsaW0oKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB3cml0ZXI7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgQ2h1bmsgbWVzc2FnZSwgbGVuZ3RoIGRlbGltaXRlZC4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuQ2h1bmsudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkNodW5rCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2h1bmt9IG1lc3NhZ2UgQ2h1bmsgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBDaHVuay5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyKS5sZGVsaW0oKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBDaHVuayBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuQ2h1bmt9IENodW5rCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gQ2h1bmsuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHJlYWRlciwgbGVuZ3RoKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgIHZhciBlbmQgPSBsZW5ndGggPT09IHVuZGVmaW5lZCA/IHJlYWRlci5sZW4gOiByZWFkZXIucG9zICsgbGVuZ3RoLCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkNodW5rKCk7CgkgICAgICAgICAgICB3aGlsZShyZWFkZXIucG9zIDwgZW5kKXsKCSAgICAgICAgICAgICAgICB2YXIgdGFnID0gcmVhZGVyLnVpbnQzMigpOwoJICAgICAgICAgICAgICAgIHN3aXRjaCh0YWcgPj4+IDMpewoJICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS54ID0gcmVhZGVyLmludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnogPSByZWFkZXIuaW50MzIoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuaWQgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLm1lc2hlcyAmJiBtZXNzYWdlLm1lc2hlcy5sZW5ndGgpKSBtZXNzYWdlLm1lc2hlcyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubWVzaGVzLnB1c2goJHJvb3QucHJvdG9jb2wuTWVzaC5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSA1OgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG1lc3NhZ2Uudm94ZWxzICYmIG1lc3NhZ2Uudm94ZWxzLmxlbmd0aCkpIG1lc3NhZ2Uudm94ZWxzID0gW107CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0YWcgJiA3KSA9PT0gMikgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5kMiA9IHJlYWRlci51aW50MzIoKSArIHJlYWRlci5wb3M7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHJlYWRlci5wb3MgPCBlbmQyKW1lc3NhZ2Uudm94ZWxzLnB1c2gocmVhZGVyLnVpbnQzMigpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgbWVzc2FnZS52b3hlbHMucHVzaChyZWFkZXIudWludDMyKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5saWdodHMgJiYgbWVzc2FnZS5saWdodHMubGVuZ3RoKSkgbWVzc2FnZS5saWdodHMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmQyID0gcmVhZGVyLnVpbnQzMigpICsgcmVhZGVyLnBvczsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZDIpbWVzc2FnZS5saWdodHMucHVzaChyZWFkZXIudWludDMyKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBtZXNzYWdlLmxpZ2h0cy5wdXNoKHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnICYgNyk7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBDaHVuayBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuQ2h1bmt9IENodW5rCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gQ2h1bmsuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcikgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9IG5ldyAkUmVhZGVyKHJlYWRlcik7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogVmVyaWZpZXMgYSBDaHVuayBtZXNzYWdlLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG1lc3NhZ2UgUGxhaW4gb2JqZWN0IHRvIHZlcmlmeQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgKi8gQ2h1bmsudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UueCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIngiKSkgewoJICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UueCkpIHJldHVybiAieDogaW50ZWdlciBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS56ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgieiIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS56KSkgcmV0dXJuICJ6OiBpbnRlZ2VyIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewoJICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5pZCkpIHJldHVybiAiaWQ6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5tZXNoZXMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJtZXNoZXMiKSkgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLm1lc2hlcykpIHJldHVybiAibWVzaGVzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UubWVzaGVzLmxlbmd0aDsgKytpKXsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJHJvb3QucHJvdG9jb2wuTWVzaC52ZXJpZnkobWVzc2FnZS5tZXNoZXNbaV0pOwoJICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiAibWVzaGVzLiIgKyBlcnJvcjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS52b3hlbHMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2b3hlbHMiKSkgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLnZveGVscykpIHJldHVybiAidm94ZWxzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2Uudm94ZWxzLmxlbmd0aDsgKytpKWlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2Uudm94ZWxzW2ldKSkgcmV0dXJuICJ2b3hlbHM6IGludGVnZXJbXSBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsaWdodHMiKSkgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLmxpZ2h0cykpIHJldHVybiAibGlnaHRzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UubGlnaHRzLmxlbmd0aDsgKytpKWlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UubGlnaHRzW2ldKSkgcmV0dXJuICJsaWdodHM6IGludGVnZXJbXSBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBDaHVuayBtZXNzYWdlIGZyb20gYSBwbGFpbiBvYmplY3QuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIHRoZWlyIHJlc3BlY3RpdmUgaW50ZXJuYWwgdHlwZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBmcm9tT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG9iamVjdCBQbGFpbiBvYmplY3QKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkNodW5rfSBDaHVuawoJICAgICAgICAgKi8gQ2h1bmsuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqZWN0KSB7CgkgICAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QucHJvdG9jb2wuQ2h1bmspIHJldHVybiBvYmplY3Q7CgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5DaHVuaygpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC54ICE9IG51bGwpIG1lc3NhZ2UueCA9IG9iamVjdC54IHwgMDsKCSAgICAgICAgICAgIGlmIChvYmplY3QueiAhPSBudWxsKSBtZXNzYWdlLnogPSBvYmplY3QueiB8IDA7CgkgICAgICAgICAgICBpZiAob2JqZWN0LmlkICE9IG51bGwpIG1lc3NhZ2UuaWQgPSBTdHJpbmcob2JqZWN0LmlkKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QubWVzaGVzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5tZXNoZXMpKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5DaHVuay5tZXNoZXM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5tZXNoZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0Lm1lc2hlcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0Lm1lc2hlc1tpXSAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLkNodW5rLm1lc2hlczogb2JqZWN0IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubWVzaGVzW2ldID0gJHJvb3QucHJvdG9jb2wuTWVzaC5mcm9tT2JqZWN0KG9iamVjdC5tZXNoZXNbaV0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvYmplY3Qudm94ZWxzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC52b3hlbHMpKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5DaHVuay52b3hlbHM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS52b3hlbHMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0LnZveGVscy5sZW5ndGg7ICsraSltZXNzYWdlLnZveGVsc1tpXSA9IG9iamVjdC52b3hlbHNbaV0gPj4+IDA7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAob2JqZWN0LmxpZ2h0cykgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QubGlnaHRzKSkgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuQ2h1bmsubGlnaHRzOiBhcnJheSBleHBlY3RlZCIpOwoJICAgICAgICAgICAgICAgIG1lc3NhZ2UubGlnaHRzID0gW107CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG9iamVjdC5saWdodHMubGVuZ3RoOyArK2kpbWVzc2FnZS5saWdodHNbaV0gPSBvYmplY3QubGlnaHRzW2ldID4+PiAwOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBDaHVuayBtZXNzYWdlLiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byBvdGhlciB0eXBlcyBpZiBzcGVjaWZpZWQuCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b09iamVjdAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2h1bmsKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLkNodW5rfSBtZXNzYWdlIENodW5rCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLklDb252ZXJzaW9uT3B0aW9uc30gW29wdGlvbnNdIENvbnZlcnNpb24gb3B0aW9ucwoJICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgKi8gQ2h1bmsudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmFycmF5cyB8fCBvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0Lm1lc2hlcyA9IFtdOwoJICAgICAgICAgICAgICAgIG9iamVjdC52b3hlbHMgPSBbXTsKCSAgICAgICAgICAgICAgICBvYmplY3QubGlnaHRzID0gW107CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewoJICAgICAgICAgICAgICAgIG9iamVjdC54ID0gMDsKCSAgICAgICAgICAgICAgICBvYmplY3QueiA9IDA7CgkgICAgICAgICAgICAgICAgb2JqZWN0LmlkID0gIiI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS54ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgieCIpKSBvYmplY3QueCA9IG1lc3NhZ2UueDsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnogIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ6IikpIG9iamVjdC56ID0gbWVzc2FnZS56OwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuaWQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJpZCIpKSBvYmplY3QuaWQgPSBtZXNzYWdlLmlkOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubWVzaGVzICYmIG1lc3NhZ2UubWVzaGVzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC5tZXNoZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS5tZXNoZXMubGVuZ3RoOyArK2opb2JqZWN0Lm1lc2hlc1tqXSA9ICRyb290LnByb3RvY29sLk1lc2gudG9PYmplY3QobWVzc2FnZS5tZXNoZXNbal0sIG9wdGlvbnMpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWxzICYmIG1lc3NhZ2Uudm94ZWxzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC52b3hlbHMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS52b3hlbHMubGVuZ3RoOyArK2opb2JqZWN0LnZveGVsc1tqXSA9IG1lc3NhZ2Uudm94ZWxzW2pdOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGlnaHRzICYmIG1lc3NhZ2UubGlnaHRzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC5saWdodHMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS5saWdodHMubGVuZ3RoOyArK2opb2JqZWN0LmxpZ2h0c1tqXSA9IG1lc3NhZ2UubGlnaHRzW2pdOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENvbnZlcnRzIHRoaXMgQ2h1bmsgdG8gSlNPTi4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2h1bmsKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICovIENodW5rLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIENodW5rCgkgICAgICAgICAqIEBmdW5jdGlvbiBnZXRUeXBlVXJsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaHVuawoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdHlwZVVybFByZWZpeF0geW91ciBjdXN0b20gdHlwZVVybFByZWZpeChkZWZhdWx0ICJ0eXBlLmdvb2dsZWFwaXMuY29tIikKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgdHlwZSB1cmwKCSAgICAgICAgICovIENodW5rLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKCSAgICAgICAgICAgIGlmICh0eXBlVXJsUHJlZml4ID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLkNodW5rIjsKCSAgICAgICAgfTsKCSAgICAgICAgcmV0dXJuIENodW5rOwoJICAgIH0oKTsKCSAgICBwcm90b2NvbC5QZWVyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGEgUGVlci4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBpbnRlcmZhY2UgSVBlZXIKCSAgICAgICAgICogQHByb3BlcnR5IHtzdHJpbmd8bnVsbH0gW2lkXSBQZWVyIGlkCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bGx9IFt1c2VybmFtZV0gUGVlciB1c2VybmFtZQoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbbWV0YWRhdGFdIFBlZXIgbWV0YWRhdGEKCSAgICAgICAgICovIC8qKgoJICAgICAgICAgKiBDb25zdHJ1Y3RzIGEgbmV3IFBlZXIuCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbAoJICAgICAgICAgKiBAY2xhc3NkZXNjIFJlcHJlc2VudHMgYSBQZWVyLgoJICAgICAgICAgKiBAaW1wbGVtZW50cyBJUGVlcgoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JUGVlcj19IFtwcm9wZXJ0aWVzXSBQcm9wZXJ0aWVzIHRvIHNldAoJICAgICAgICAgKi8gZnVuY3Rpb24gUGVlcihwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICBpZiAocHJvcGVydGllcykgewoJICAgICAgICAgICAgICAgIGZvcih2YXIga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpaWYgKHByb3BlcnRpZXNba2V5c1tpXV0gIT0gbnVsbCkgdGhpc1trZXlzW2ldXSA9IHByb3BlcnRpZXNba2V5c1tpXV07CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgLyoqCgkgICAgICAgICAqIFBlZXIgaWQuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gaWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlBlZXIKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBQZWVyLnByb3RvdHlwZS5pZCA9ICIiOwoJICAgICAgICAvKioKCSAgICAgICAgICogUGVlciB1c2VybmFtZS4KCSAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSB1c2VybmFtZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuUGVlcgoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIFBlZXIucHJvdG90eXBlLnVzZXJuYW1lID0gIiI7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQZWVyIG1ldGFkYXRhLgoJICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9IG1ldGFkYXRhCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5QZWVyCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gUGVlci5wcm90b3R5cGUubWV0YWRhdGEgPSAiIjsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgUGVlciBpbnN0YW5jZSB1c2luZyB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlBlZXIKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklQZWVyPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5QZWVyfSBQZWVyIGluc3RhbmNlCgkgICAgICAgICAqLyBQZWVyLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICByZXR1cm4gbmV3IFBlZXIocHJvcGVydGllcyk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgUGVlciBtZXNzYWdlLiBEb2VzIG5vdCBpbXBsaWNpdGx5IHtAbGluayBwcm90b2NvbC5QZWVyLnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5QZWVyCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JUGVlcn0gbWVzc2FnZSBQZWVyIG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gUGVlci5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICBpZiAoIXdyaXRlcikgd3JpdGVyID0gJFdyaXRlci5jcmVhdGUoKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImlkIikpIHdyaXRlci51aW50MzIoLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8gMTApLnN0cmluZyhtZXNzYWdlLmlkKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnVzZXJuYW1lICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInVzZXJuYW1lIikpIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8gMTgpLnN0cmluZyhtZXNzYWdlLnVzZXJuYW1lKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm1ldGFkYXRhICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIm1ldGFkYXRhIikpIHdyaXRlci51aW50MzIoLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8gMjYpLnN0cmluZyhtZXNzYWdlLm1ldGFkYXRhKTsKCSAgICAgICAgICAgIHJldHVybiB3cml0ZXI7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgUGVlciBtZXNzYWdlLCBsZW5ndGggZGVsaW1pdGVkLiBEb2VzIG5vdCBpbXBsaWNpdGx5IHtAbGluayBwcm90b2NvbC5QZWVyLnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5QZWVyCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JUGVlcn0gbWVzc2FnZSBQZWVyIG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gUGVlci5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyKS5sZGVsaW0oKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBQZWVyIG1lc3NhZ2UgZnJvbSB0aGUgc3BlY2lmaWVkIHJlYWRlciBvciBidWZmZXIuCgkgICAgICAgICAqIEBmdW5jdGlvbiBkZWNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlBlZXIKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5SZWFkZXJ8VWludDhBcnJheX0gcmVhZGVyIFJlYWRlciBvciBidWZmZXIgdG8gZGVjb2RlIGZyb20KCSAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGhdIE1lc3NhZ2UgbGVuZ3RoIGlmIGtub3duIGJlZm9yZWhhbmQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLlBlZXJ9IFBlZXIKCSAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICogQHRocm93cyB7JHByb3RvYnVmLnV0aWwuUHJvdG9jb2xFcnJvcn0gSWYgcmVxdWlyZWQgZmllbGRzIGFyZSBtaXNzaW5nCgkgICAgICAgICAqLyBQZWVyLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIsIGxlbmd0aCkgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9ICRSZWFkZXIuY3JlYXRlKHJlYWRlcik7CgkgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5QZWVyKCk7CgkgICAgICAgICAgICB3aGlsZShyZWFkZXIucG9zIDwgZW5kKXsKCSAgICAgICAgICAgICAgICB2YXIgdGFnID0gcmVhZGVyLnVpbnQzMigpOwoJICAgICAgICAgICAgICAgIHN3aXRjaCh0YWcgPj4+IDMpewoJICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5pZCA9IHJlYWRlci5zdHJpbmcoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudXNlcm5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm1ldGFkYXRhID0gcmVhZGVyLnN0cmluZygpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICAgICAgcmVhZGVyLnNraXBUeXBlKHRhZyAmIDcpOwoJICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBEZWNvZGVzIGEgUGVlciBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5QZWVyCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5QZWVyfSBQZWVyCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gUGVlci5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gbmV3ICRSZWFkZXIocmVhZGVyKTsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBWZXJpZmllcyBhIFBlZXIgbWVzc2FnZS4KCSAgICAgICAgICogQGZ1bmN0aW9uIHZlcmlmeQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuUGVlcgoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG1lc3NhZ2UgUGxhaW4gb2JqZWN0IHRvIHZlcmlmeQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgKi8gUGVlci52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKSByZXR1cm4gIm9iamVjdCBleHBlY3RlZCI7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImlkIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UuaWQpKSByZXR1cm4gImlkOiBzdHJpbmcgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudXNlcm5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ1c2VybmFtZSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnVzZXJuYW1lKSkgcmV0dXJuICJ1c2VybmFtZTogc3RyaW5nIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm1ldGFkYXRhICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibWV0YWRhdGEiKSkgewoJICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5tZXRhZGF0YSkpIHJldHVybiAibWV0YWRhdGE6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBQZWVyIG1lc3NhZ2UgZnJvbSBhIHBsYWluIG9iamVjdC4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gdGhlaXIgcmVzcGVjdGl2ZSBpbnRlcm5hbCB0eXBlcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGZyb21PYmplY3QKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlBlZXIKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBvYmplY3QgUGxhaW4gb2JqZWN0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5QZWVyfSBQZWVyCgkgICAgICAgICAqLyBQZWVyLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewoJICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLlBlZXIpIHJldHVybiBvYmplY3Q7CgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5QZWVyKCk7CgkgICAgICAgICAgICBpZiAob2JqZWN0LmlkICE9IG51bGwpIG1lc3NhZ2UuaWQgPSBTdHJpbmcob2JqZWN0LmlkKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QudXNlcm5hbWUgIT0gbnVsbCkgbWVzc2FnZS51c2VybmFtZSA9IFN0cmluZyhvYmplY3QudXNlcm5hbWUpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC5tZXRhZGF0YSAhPSBudWxsKSBtZXNzYWdlLm1ldGFkYXRhID0gU3RyaW5nKG9iamVjdC5tZXRhZGF0YSk7CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBwbGFpbiBvYmplY3QgZnJvbSBhIFBlZXIgbWVzc2FnZS4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gb3RoZXIgdHlwZXMgaWYgc3BlY2lmaWVkLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdG9PYmplY3QKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlBlZXIKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLlBlZXJ9IG1lc3NhZ2UgUGVlcgoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5JQ29udmVyc2lvbk9wdGlvbnN9IFtvcHRpb25zXSBDb252ZXJzaW9uIG9wdGlvbnMKCSAgICAgICAgICogQHJldHVybnMge09iamVjdC48c3RyaW5nLCo+fSBQbGFpbiBvYmplY3QKCSAgICAgICAgICovIFBlZXIudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LmlkID0gIiI7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnVzZXJuYW1lID0gIiI7CgkgICAgICAgICAgICAgICAgb2JqZWN0Lm1ldGFkYXRhID0gIiI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImlkIikpIG9iamVjdC5pZCA9IG1lc3NhZ2UuaWQ7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS51c2VybmFtZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInVzZXJuYW1lIikpIG9iamVjdC51c2VybmFtZSA9IG1lc3NhZ2UudXNlcm5hbWU7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGFkYXRhIikpIG9iamVjdC5tZXRhZGF0YSA9IG1lc3NhZ2UubWV0YWRhdGE7CgkgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ29udmVydHMgdGhpcyBQZWVyIHRvIEpTT04uCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b0pTT04KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlBlZXIKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICovIFBlZXIucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsICRwcm90b2J1Zi51dGlsLnRvSlNPTk9wdGlvbnMpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogR2V0cyB0aGUgZGVmYXVsdCB0eXBlIHVybCBmb3IgUGVlcgoJICAgICAgICAgKiBAZnVuY3Rpb24gZ2V0VHlwZVVybAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuUGVlcgoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdHlwZVVybFByZWZpeF0geW91ciBjdXN0b20gdHlwZVVybFByZWZpeChkZWZhdWx0ICJ0eXBlLmdvb2dsZWFwaXMuY29tIikKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgdHlwZSB1cmwKCSAgICAgICAgICovIFBlZXIuZ2V0VHlwZVVybCA9IGZ1bmN0aW9uIGdldFR5cGVVcmwodHlwZVVybFByZWZpeCkgewoJICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIHR5cGVVcmxQcmVmaXggPSAidHlwZS5nb29nbGVhcGlzLmNvbSI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuUGVlciI7CgkgICAgICAgIH07CgkgICAgICAgIHJldHVybiBQZWVyOwoJICAgIH0oKTsKCSAgICBwcm90b2NvbC5FbnRpdHkgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIFByb3BlcnRpZXMgb2YgYW4gRW50aXR5LgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGludGVyZmFjZSBJRW50aXR5CgkgICAgICAgICAqIEBwcm9wZXJ0eSB7cHJvdG9jb2wuRW50aXR5Lk9wZXJhdGlvbnxudWxsfSBbb3BlcmF0aW9uXSBFbnRpdHkgb3BlcmF0aW9uCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bGx9IFtpZF0gRW50aXR5IGlkCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bGx9IFt0eXBlXSBFbnRpdHkgdHlwZQoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbbWV0YWRhdGFdIEVudGl0eSBtZXRhZGF0YQoJICAgICAgICAgKi8gLyoqCgkgICAgICAgICAqIENvbnN0cnVjdHMgYSBuZXcgRW50aXR5LgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGFuIEVudGl0eS4KCSAgICAgICAgICogQGltcGxlbWVudHMgSUVudGl0eQoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JRW50aXR5PX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqLyBmdW5jdGlvbiBFbnRpdHkocHJvcGVydGllcykgewoJICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKWlmIChwcm9wZXJ0aWVzW2tleXNbaV1dICE9IG51bGwpIHRoaXNba2V5c1tpXV0gPSBwcm9wZXJ0aWVzW2tleXNbaV1dOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbnRpdHkgb3BlcmF0aW9uLgoJICAgICAgICAgKiBAbWVtYmVyIHtwcm90b2NvbC5FbnRpdHkuT3BlcmF0aW9ufSBvcGVyYXRpb24KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkVudGl0eQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIEVudGl0eS5wcm90b3R5cGUub3BlcmF0aW9uID0gMDsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVudGl0eSBpZC4KCSAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSBpZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gRW50aXR5LnByb3RvdHlwZS5pZCA9ICIiOwoJICAgICAgICAvKioKCSAgICAgICAgICogRW50aXR5IHR5cGUuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gdHlwZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gRW50aXR5LnByb3RvdHlwZS50eXBlID0gIiI7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbnRpdHkgbWV0YWRhdGEuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gbWV0YWRhdGEKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkVudGl0eQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIEVudGl0eS5wcm90b3R5cGUubWV0YWRhdGEgPSAiIjsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgRW50aXR5IGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGNyZWF0ZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JRW50aXR5PX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5FbnRpdHl9IEVudGl0eSBpbnN0YW5jZQoJICAgICAgICAgKi8gRW50aXR5LmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICByZXR1cm4gbmV3IEVudGl0eShwcm9wZXJ0aWVzKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBFbnRpdHkgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuRW50aXR5LnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FbnRpdHkKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklFbnRpdHl9IG1lc3NhZ2UgRW50aXR5IG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gRW50aXR5LmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgIGlmICghd3JpdGVyKSB3cml0ZXIgPSAkV3JpdGVyLmNyZWF0ZSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uub3BlcmF0aW9uICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIm9wZXJhdGlvbiIpKSB3cml0ZXIudWludDMyKC8qIGlkIDEsIHdpcmVUeXBlIDAgPSovIDgpLmludDMyKG1lc3NhZ2Uub3BlcmF0aW9uKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImlkIikpIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8gMTgpLnN0cmluZyhtZXNzYWdlLmlkKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidHlwZSIpKSB3cml0ZXIudWludDMyKC8qIGlkIDMsIHdpcmVUeXBlIDIgPSovIDI2KS5zdHJpbmcobWVzc2FnZS50eXBlKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm1ldGFkYXRhICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIm1ldGFkYXRhIikpIHdyaXRlci51aW50MzIoLyogaWQgNCwgd2lyZVR5cGUgMiA9Ki8gMzQpLnN0cmluZyhtZXNzYWdlLm1ldGFkYXRhKTsKCSAgICAgICAgICAgIHJldHVybiB3cml0ZXI7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgRW50aXR5IG1lc3NhZ2UsIGxlbmd0aCBkZWxpbWl0ZWQuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIHByb3RvY29sLkVudGl0eS52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JRW50aXR5fSBtZXNzYWdlIEVudGl0eSBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuV3JpdGVyfSBbd3JpdGVyXSBXcml0ZXIgdG8gZW5jb2RlIHRvCgkgICAgICAgICAqIEByZXR1cm5zIHskcHJvdG9idWYuV3JpdGVyfSBXcml0ZXIKCSAgICAgICAgICovIEVudGl0eS5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyKS5sZGVsaW0oKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYW4gRW50aXR5IG1lc3NhZ2UgZnJvbSB0aGUgc3BlY2lmaWVkIHJlYWRlciBvciBidWZmZXIuCgkgICAgICAgICAqIEBmdW5jdGlvbiBkZWNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkVudGl0eQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuRW50aXR5fSBFbnRpdHkKCSAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICogQHRocm93cyB7JHByb3RvYnVmLnV0aWwuUHJvdG9jb2xFcnJvcn0gSWYgcmVxdWlyZWQgZmllbGRzIGFyZSBtaXNzaW5nCgkgICAgICAgICAqLyBFbnRpdHkuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHJlYWRlciwgbGVuZ3RoKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgIHZhciBlbmQgPSBsZW5ndGggPT09IHVuZGVmaW5lZCA/IHJlYWRlci5sZW4gOiByZWFkZXIucG9zICsgbGVuZ3RoLCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkVudGl0eSgpOwoJICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZCl7CgkgICAgICAgICAgICAgICAgdmFyIHRhZyA9IHJlYWRlci51aW50MzIoKTsKCSAgICAgICAgICAgICAgICBzd2l0Y2godGFnID4+PiAzKXsKCSAgICAgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Uub3BlcmF0aW9uID0gcmVhZGVyLmludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmlkID0gcmVhZGVyLnN0cmluZygpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gcmVhZGVyLnN0cmluZygpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5tZXRhZGF0YSA9IHJlYWRlci5zdHJpbmcoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRlci5za2lwVHlwZSh0YWcgJiA3KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRGVjb2RlcyBhbiBFbnRpdHkgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlciwgbGVuZ3RoIGRlbGltaXRlZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5FbnRpdHl9IEVudGl0eQoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIEVudGl0eS5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gbmV3ICRSZWFkZXIocmVhZGVyKTsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBWZXJpZmllcyBhbiBFbnRpdHkgbWVzc2FnZS4KCSAgICAgICAgICogQGZ1bmN0aW9uIHZlcmlmeQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8bnVsbH0gYG51bGxgIGlmIHZhbGlkLCBvdGhlcndpc2UgdGhlIHJlYXNvbiB3aHkgaXQgaXMgbm90CgkgICAgICAgICAqLyBFbnRpdHkudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uub3BlcmF0aW9uICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgib3BlcmF0aW9uIikpIHN3aXRjaChtZXNzYWdlLm9wZXJhdGlvbil7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJvcGVyYXRpb246IGVudW0gdmFsdWUgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgICAgIGNhc2UgMDoKCSAgICAgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewoJICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5pZCkpIHJldHVybiAiaWQ6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS50eXBlICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidHlwZSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnR5cGUpKSByZXR1cm4gInR5cGU6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGFkYXRhIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UubWV0YWRhdGEpKSByZXR1cm4gIm1ldGFkYXRhOiBzdHJpbmcgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGFuIEVudGl0eSBtZXNzYWdlIGZyb20gYSBwbGFpbiBvYmplY3QuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIHRoZWlyIHJlc3BlY3RpdmUgaW50ZXJuYWwgdHlwZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBmcm9tT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FbnRpdHkKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBvYmplY3QgUGxhaW4gb2JqZWN0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5FbnRpdHl9IEVudGl0eQoJICAgICAgICAgKi8gRW50aXR5LmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewoJICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLkVudGl0eSkgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkVudGl0eSgpOwoJICAgICAgICAgICAgc3dpdGNoKG9iamVjdC5vcGVyYXRpb24pewoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0Lm9wZXJhdGlvbiA9PT0gIm51bWJlciIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Uub3BlcmF0aW9uID0gb2JqZWN0Lm9wZXJhdGlvbjsKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIkNSRUFURSI6CgkgICAgICAgICAgICAgICAgY2FzZSAwOgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm9wZXJhdGlvbiA9IDA7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIkRFTEVURSI6CgkgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm9wZXJhdGlvbiA9IDE7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIlVQREFURSI6CgkgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm9wZXJhdGlvbiA9IDI7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG9iamVjdC5pZCAhPSBudWxsKSBtZXNzYWdlLmlkID0gU3RyaW5nKG9iamVjdC5pZCk7CgkgICAgICAgICAgICBpZiAob2JqZWN0LnR5cGUgIT0gbnVsbCkgbWVzc2FnZS50eXBlID0gU3RyaW5nKG9iamVjdC50eXBlKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QubWV0YWRhdGEgIT0gbnVsbCkgbWVzc2FnZS5tZXRhZGF0YSA9IFN0cmluZyhvYmplY3QubWV0YWRhdGEpOwoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYW4gRW50aXR5IG1lc3NhZ2UuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIG90aGVyIHR5cGVzIGlmIHNwZWNpZmllZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FbnRpdHkKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLkVudGl0eX0gbWVzc2FnZSBFbnRpdHkKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gUGxhaW4gb2JqZWN0CgkgICAgICAgICAqLyBFbnRpdHkudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0Lm9wZXJhdGlvbiA9IG9wdGlvbnMuZW51bXMgPT09IFN0cmluZyA/ICJDUkVBVEUiIDogMDsKCSAgICAgICAgICAgICAgICBvYmplY3QuaWQgPSAiIjsKCSAgICAgICAgICAgICAgICBvYmplY3QudHlwZSA9ICIiOwoJICAgICAgICAgICAgICAgIG9iamVjdC5tZXRhZGF0YSA9ICIiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uub3BlcmF0aW9uICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgib3BlcmF0aW9uIikpIG9iamVjdC5vcGVyYXRpb24gPSBvcHRpb25zLmVudW1zID09PSBTdHJpbmcgPyAkcm9vdC5wcm90b2NvbC5FbnRpdHkuT3BlcmF0aW9uW21lc3NhZ2Uub3BlcmF0aW9uXSA9PT0gdW5kZWZpbmVkID8gbWVzc2FnZS5vcGVyYXRpb24gOiAkcm9vdC5wcm90b2NvbC5FbnRpdHkuT3BlcmF0aW9uW21lc3NhZ2Uub3BlcmF0aW9uXSA6IG1lc3NhZ2Uub3BlcmF0aW9uOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuaWQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJpZCIpKSBvYmplY3QuaWQgPSBtZXNzYWdlLmlkOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkgb2JqZWN0LnR5cGUgPSBtZXNzYWdlLnR5cGU7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGFkYXRhIikpIG9iamVjdC5tZXRhZGF0YSA9IG1lc3NhZ2UubWV0YWRhdGE7CgkgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ29udmVydHMgdGhpcyBFbnRpdHkgdG8gSlNPTi4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRW50aXR5CgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IEpTT04gb2JqZWN0CgkgICAgICAgICAqLyBFbnRpdHkucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsICRwcm90b2J1Zi51dGlsLnRvSlNPTk9wdGlvbnMpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogR2V0cyB0aGUgZGVmYXVsdCB0eXBlIHVybCBmb3IgRW50aXR5CgkgICAgICAgICAqIEBmdW5jdGlvbiBnZXRUeXBlVXJsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FbnRpdHkKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3R5cGVVcmxQcmVmaXhdIHlvdXIgY3VzdG9tIHR5cGVVcmxQcmVmaXgoZGVmYXVsdCAidHlwZS5nb29nbGVhcGlzLmNvbSIpCgkgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBkZWZhdWx0IHR5cGUgdXJsCgkgICAgICAgICAqLyBFbnRpdHkuZ2V0VHlwZVVybCA9IGZ1bmN0aW9uIGdldFR5cGVVcmwodHlwZVVybFByZWZpeCkgewoJICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIHR5cGVVcmxQcmVmaXggPSAidHlwZS5nb29nbGVhcGlzLmNvbSI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuRW50aXR5IjsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE9wZXJhdGlvbiBlbnVtLgoJICAgICAgICAgKiBAbmFtZSBwcm90b2NvbC5FbnRpdHkuT3BlcmF0aW9uCgkgICAgICAgICAqIEBlbnVtIHtudW1iZXJ9CgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBDUkVBVEU9MCBDUkVBVEUgdmFsdWUKCSAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IERFTEVURT0xIERFTEVURSB2YWx1ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gVVBEQVRFPTIgVVBEQVRFIHZhbHVlCgkgICAgICAgICAqLyBFbnRpdHkuT3BlcmF0aW9uID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWVzQnlJZCA9IHt9LCB2YWx1ZXMgPSBPYmplY3QuY3JlYXRlKHZhbHVlc0J5SWQpOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMF0gPSAiQ1JFQVRFIl0gPSAwOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMV0gPSAiREVMRVRFIl0gPSAxOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMl0gPSAiVVBEQVRFIl0gPSAyOwoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKCSAgICAgICAgfSgpOwoJICAgICAgICByZXR1cm4gRW50aXR5OwoJICAgIH0oKTsKCSAgICBwcm90b2NvbC5FdmVudCA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAvKioKCSAgICAgICAgICogUHJvcGVydGllcyBvZiBhbiBFdmVudC4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBpbnRlcmZhY2UgSUV2ZW50CgkgICAgICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bGx9IFtuYW1lXSBFdmVudCBuYW1lCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7Z29vZ2xlLnByb3RvYnVmLklTdHJ1Y3R8bnVsbH0gW3BheWxvYWRdIEV2ZW50IHBheWxvYWQKCSAgICAgICAgICovIC8qKgoJICAgICAgICAgKiBDb25zdHJ1Y3RzIGEgbmV3IEV2ZW50LgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGFuIEV2ZW50LgoJICAgICAgICAgKiBAaW1wbGVtZW50cyBJRXZlbnQKCSAgICAgICAgICogQGNvbnN0cnVjdG9yCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSUV2ZW50PX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqLyBmdW5jdGlvbiBFdmVudChwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICBpZiAocHJvcGVydGllcykgewoJICAgICAgICAgICAgICAgIGZvcih2YXIga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpaWYgKHByb3BlcnRpZXNba2V5c1tpXV0gIT0gbnVsbCkgdGhpc1trZXlzW2ldXSA9IHByb3BlcnRpZXNba2V5c1tpXV07CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgLyoqCgkgICAgICAgICAqIEV2ZW50IG5hbWUuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gbmFtZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRXZlbnQKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBFdmVudC5wcm90b3R5cGUubmFtZSA9ICIiOwoJICAgICAgICAvKioKCSAgICAgICAgICogRXZlbnQgcGF5bG9hZC4KCSAgICAgICAgICogQG1lbWJlciB7Z29vZ2xlLnByb3RvYnVmLklTdHJ1Y3R8bnVsbHx1bmRlZmluZWR9IHBheWxvYWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkV2ZW50CgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gRXZlbnQucHJvdG90eXBlLnBheWxvYWQgPSBudWxsOwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBFdmVudCBpbnN0YW5jZSB1c2luZyB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkV2ZW50CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JRXZlbnQ9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkV2ZW50fSBFdmVudCBpbnN0YW5jZQoJICAgICAgICAgKi8gRXZlbnQuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHJldHVybiBuZXcgRXZlbnQocHJvcGVydGllcyk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgRXZlbnQgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuRXZlbnQudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkV2ZW50CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JRXZlbnR9IG1lc3NhZ2UgRXZlbnQgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBFdmVudC5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICBpZiAoIXdyaXRlcikgd3JpdGVyID0gJFdyaXRlci5jcmVhdGUoKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm5hbWUgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAibmFtZSIpKSB3cml0ZXIudWludDMyKC8qIGlkIDEsIHdpcmVUeXBlIDIgPSovIDEwKS5zdHJpbmcobWVzc2FnZS5uYW1lKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnBheWxvYWQgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAicGF5bG9hZCIpKSAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0LmVuY29kZShtZXNzYWdlLnBheWxvYWQsIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8gMTgpLmZvcmsoKSkubGRlbGltKCk7CgkgICAgICAgICAgICByZXR1cm4gd3JpdGVyOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRW5jb2RlcyB0aGUgc3BlY2lmaWVkIEV2ZW50IG1lc3NhZ2UsIGxlbmd0aCBkZWxpbWl0ZWQuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIHByb3RvY29sLkV2ZW50LnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FdmVudAoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSUV2ZW50fSBtZXNzYWdlIEV2ZW50IG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gRXZlbnQuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikubGRlbGltKCk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBEZWNvZGVzIGFuIEV2ZW50IG1lc3NhZ2UgZnJvbSB0aGUgc3BlY2lmaWVkIHJlYWRlciBvciBidWZmZXIuCgkgICAgICAgICAqIEBmdW5jdGlvbiBkZWNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkV2ZW50CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbGVuZ3RoXSBNZXNzYWdlIGxlbmd0aCBpZiBrbm93biBiZWZvcmVoYW5kCgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5FdmVudH0gRXZlbnQKCSAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICogQHRocm93cyB7JHByb3RvYnVmLnV0aWwuUHJvdG9jb2xFcnJvcn0gSWYgcmVxdWlyZWQgZmllbGRzIGFyZSBtaXNzaW5nCgkgICAgICAgICAqLyBFdmVudC5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyLCBsZW5ndGgpIHsKCSAgICAgICAgICAgIGlmICghKHJlYWRlciBpbnN0YW5jZW9mICRSZWFkZXIpKSByZWFkZXIgPSAkUmVhZGVyLmNyZWF0ZShyZWFkZXIpOwoJICAgICAgICAgICAgdmFyIGVuZCA9IGxlbmd0aCA9PT0gdW5kZWZpbmVkID8gcmVhZGVyLmxlbiA6IHJlYWRlci5wb3MgKyBsZW5ndGgsIG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuRXZlbnQoKTsKCSAgICAgICAgICAgIHdoaWxlKHJlYWRlci5wb3MgPCBlbmQpewoJICAgICAgICAgICAgICAgIHZhciB0YWcgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgc3dpdGNoKHRhZyA+Pj4gMyl7CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMToKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBheWxvYWQgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0LmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnICYgNyk7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYW4gRXZlbnQgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlciwgbGVuZ3RoIGRlbGltaXRlZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRXZlbnQKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5SZWFkZXJ8VWludDhBcnJheX0gcmVhZGVyIFJlYWRlciBvciBidWZmZXIgdG8gZGVjb2RlIGZyb20KCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkV2ZW50fSBFdmVudAoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIEV2ZW50LmRlY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZChyZWFkZXIpIHsKCSAgICAgICAgICAgIGlmICghKHJlYWRlciBpbnN0YW5jZW9mICRSZWFkZXIpKSByZWFkZXIgPSBuZXcgJFJlYWRlcihyZWFkZXIpOwoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlciwgcmVhZGVyLnVpbnQzMigpKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIFZlcmlmaWVzIGFuIEV2ZW50IG1lc3NhZ2UuCgkgICAgICAgICAqIEBmdW5jdGlvbiB2ZXJpZnkKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkV2ZW50CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8bnVsbH0gYG51bGxgIGlmIHZhbGlkLCBvdGhlcndpc2UgdGhlIHJlYXNvbiB3aHkgaXQgaXMgbm90CgkgICAgICAgICAqLyBFdmVudC52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKSByZXR1cm4gIm9iamVjdCBleHBlY3RlZCI7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5uYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibmFtZSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLm5hbWUpKSByZXR1cm4gIm5hbWU6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5wYXlsb2FkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgicGF5bG9hZCIpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC52ZXJpZnkobWVzc2FnZS5wYXlsb2FkKTsKCSAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiAicGF5bG9hZC4iICsgZXJyb3I7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYW4gRXZlbnQgbWVzc2FnZSBmcm9tIGEgcGxhaW4gb2JqZWN0LiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byB0aGVpciByZXNwZWN0aXZlIGludGVybmFsIHR5cGVzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZnJvbU9iamVjdAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuRXZlbnQKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBvYmplY3QgUGxhaW4gb2JqZWN0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5FdmVudH0gRXZlbnQKCSAgICAgICAgICovIEV2ZW50LmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewoJICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLkV2ZW50KSByZXR1cm4gb2JqZWN0OwoJICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuRXZlbnQoKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QubmFtZSAhPSBudWxsKSBtZXNzYWdlLm5hbWUgPSBTdHJpbmcob2JqZWN0Lm5hbWUpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC5wYXlsb2FkICE9IG51bGwpIHsKCSAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5wYXlsb2FkICE9PSAib2JqZWN0IikgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuRXZlbnQucGF5bG9hZDogb2JqZWN0IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXlsb2FkID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC5mcm9tT2JqZWN0KG9iamVjdC5wYXlsb2FkKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIHBsYWluIG9iamVjdCBmcm9tIGFuIEV2ZW50IG1lc3NhZ2UuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIG90aGVyIHR5cGVzIGlmIHNwZWNpZmllZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FdmVudAoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuRXZlbnR9IG1lc3NhZ2UgRXZlbnQKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gUGxhaW4gb2JqZWN0CgkgICAgICAgICAqLyBFdmVudC50b09iamVjdCA9IGZ1bmN0aW9uIHRvT2JqZWN0KG1lc3NhZ2UsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwoJICAgICAgICAgICAgdmFyIG9iamVjdCA9IHt9OwoJICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGVmYXVsdHMpIHsKCSAgICAgICAgICAgICAgICBvYmplY3QubmFtZSA9ICIiOwoJICAgICAgICAgICAgICAgIG9iamVjdC5wYXlsb2FkID0gbnVsbDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJuYW1lIikpIG9iamVjdC5uYW1lID0gbWVzc2FnZS5uYW1lOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBheWxvYWQiKSkgb2JqZWN0LnBheWxvYWQgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0LnRvT2JqZWN0KG1lc3NhZ2UucGF5bG9hZCwgb3B0aW9ucyk7CgkgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ29udmVydHMgdGhpcyBFdmVudCB0byBKU09OLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdG9KU09OCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5FdmVudAoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICogQHJldHVybnMge09iamVjdC48c3RyaW5nLCo+fSBKU09OIG9iamVjdAoJICAgICAgICAgKi8gRXZlbnQucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsICRwcm90b2J1Zi51dGlsLnRvSlNPTk9wdGlvbnMpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogR2V0cyB0aGUgZGVmYXVsdCB0eXBlIHVybCBmb3IgRXZlbnQKCSAgICAgICAgICogQGZ1bmN0aW9uIGdldFR5cGVVcmwKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkV2ZW50CgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlVXJsUHJlZml4XSB5b3VyIGN1c3RvbSB0eXBlVXJsUHJlZml4KGRlZmF1bHQgInR5cGUuZ29vZ2xlYXBpcy5jb20iKQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCB0eXBlIHVybAoJICAgICAgICAgKi8gRXZlbnQuZ2V0VHlwZVVybCA9IGZ1bmN0aW9uIGdldFR5cGVVcmwodHlwZVVybFByZWZpeCkgewoJICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIHR5cGVVcmxQcmVmaXggPSAidHlwZS5nb29nbGVhcGlzLmNvbSI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuRXZlbnQiOwoJICAgICAgICB9OwoJICAgICAgICByZXR1cm4gRXZlbnQ7CgkgICAgfSgpOwoJICAgIHByb3RvY29sLk1ldGhvZCA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAvKioKCSAgICAgICAgICogUHJvcGVydGllcyBvZiBhIE1ldGhvZC4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBpbnRlcmZhY2UgSU1ldGhvZAoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbbmFtZV0gTWV0aG9kIG5hbWUKCSAgICAgICAgICogQHByb3BlcnR5IHtzdHJpbmd8bnVsbH0gW3BheWxvYWRdIE1ldGhvZCBwYXlsb2FkCgkgICAgICAgICAqLyAvKioKCSAgICAgICAgICogQ29uc3RydWN0cyBhIG5ldyBNZXRob2QuCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbAoJICAgICAgICAgKiBAY2xhc3NkZXNjIFJlcHJlc2VudHMgYSBNZXRob2QuCgkgICAgICAgICAqIEBpbXBsZW1lbnRzIElNZXRob2QKCSAgICAgICAgICogQGNvbnN0cnVjdG9yCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSU1ldGhvZD19IFtwcm9wZXJ0aWVzXSBQcm9wZXJ0aWVzIHRvIHNldAoJICAgICAgICAgKi8gZnVuY3Rpb24gTWV0aG9kKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSlpZiAocHJvcGVydGllc1trZXlzW2ldXSAhPSBudWxsKSB0aGlzW2tleXNbaV1dID0gcHJvcGVydGllc1trZXlzW2ldXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICAvKioKCSAgICAgICAgICogTWV0aG9kIG5hbWUuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gbmFtZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWV0aG9kCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gTWV0aG9kLnByb3RvdHlwZS5uYW1lID0gIiI7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBNZXRob2QgcGF5bG9hZC4KCSAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSBwYXlsb2FkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXRob2QKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBNZXRob2QucHJvdG90eXBlLnBheWxvYWQgPSAiIjsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgTWV0aG9kIGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGNyZWF0ZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWV0aG9kCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JTWV0aG9kPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5NZXRob2R9IE1ldGhvZCBpbnN0YW5jZQoJICAgICAgICAgKi8gTWV0aG9kLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICByZXR1cm4gbmV3IE1ldGhvZChwcm9wZXJ0aWVzKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBNZXRob2QgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuTWV0aG9kLnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXRob2QKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklNZXRob2R9IG1lc3NhZ2UgTWV0aG9kIG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gTWV0aG9kLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgIGlmICghd3JpdGVyKSB3cml0ZXIgPSAkV3JpdGVyLmNyZWF0ZSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubmFtZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJuYW1lIikpIHdyaXRlci51aW50MzIoLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8gMTApLnN0cmluZyhtZXNzYWdlLm5hbWUpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJwYXlsb2FkIikpIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8gMTgpLnN0cmluZyhtZXNzYWdlLnBheWxvYWQpOwoJICAgICAgICAgICAgcmV0dXJuIHdyaXRlcjsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBNZXRob2QgbWVzc2FnZSwgbGVuZ3RoIGRlbGltaXRlZC4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuTWV0aG9kLnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXRob2QKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklNZXRob2R9IG1lc3NhZ2UgTWV0aG9kIG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gTWV0aG9kLmVuY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZChtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmVuY29kZShtZXNzYWdlLCB3cml0ZXIpLmxkZWxpbSgpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRGVjb2RlcyBhIE1ldGhvZCBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXRob2QKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5SZWFkZXJ8VWludDhBcnJheX0gcmVhZGVyIFJlYWRlciBvciBidWZmZXIgdG8gZGVjb2RlIGZyb20KCSAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGhdIE1lc3NhZ2UgbGVuZ3RoIGlmIGtub3duIGJlZm9yZWhhbmQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLk1ldGhvZH0gTWV0aG9kCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gTWV0aG9kLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIsIGxlbmd0aCkgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9ICRSZWFkZXIuY3JlYXRlKHJlYWRlcik7CgkgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5NZXRob2QoKTsKCSAgICAgICAgICAgIHdoaWxlKHJlYWRlci5wb3MgPCBlbmQpewoJICAgICAgICAgICAgICAgIHZhciB0YWcgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgc3dpdGNoKHRhZyA+Pj4gMyl7CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMToKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBheWxvYWQgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnICYgNyk7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBNZXRob2QgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlciwgbGVuZ3RoIGRlbGltaXRlZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWV0aG9kCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5NZXRob2R9IE1ldGhvZAoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIE1ldGhvZC5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gbmV3ICRSZWFkZXIocmVhZGVyKTsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBWZXJpZmllcyBhIE1ldGhvZCBtZXNzYWdlLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXRob2QKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBtZXNzYWdlIFBsYWluIG9iamVjdCB0byB2ZXJpZnkKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ3xudWxsfSBgbnVsbGAgaWYgdmFsaWQsIG90aGVyd2lzZSB0aGUgcmVhc29uIHdoeSBpdCBpcyBub3QKCSAgICAgICAgICovIE1ldGhvZC52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKSByZXR1cm4gIm9iamVjdCBleHBlY3RlZCI7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5uYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibmFtZSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLm5hbWUpKSByZXR1cm4gIm5hbWU6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5wYXlsb2FkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgicGF5bG9hZCIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnBheWxvYWQpKSByZXR1cm4gInBheWxvYWQ6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBNZXRob2QgbWVzc2FnZSBmcm9tIGEgcGxhaW4gb2JqZWN0LiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byB0aGVpciByZXNwZWN0aXZlIGludGVybmFsIHR5cGVzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZnJvbU9iamVjdAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWV0aG9kCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gb2JqZWN0IFBsYWluIG9iamVjdAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuTWV0aG9kfSBNZXRob2QKCSAgICAgICAgICovIE1ldGhvZC5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKCSAgICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5NZXRob2QpIHJldHVybiBvYmplY3Q7CgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5NZXRob2QoKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QubmFtZSAhPSBudWxsKSBtZXNzYWdlLm5hbWUgPSBTdHJpbmcob2JqZWN0Lm5hbWUpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC5wYXlsb2FkICE9IG51bGwpIG1lc3NhZ2UucGF5bG9hZCA9IFN0cmluZyhvYmplY3QucGF5bG9hZCk7CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBwbGFpbiBvYmplY3QgZnJvbSBhIE1ldGhvZCBtZXNzYWdlLiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byBvdGhlciB0eXBlcyBpZiBzcGVjaWZpZWQuCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b09iamVjdAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWV0aG9kCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5NZXRob2R9IG1lc3NhZ2UgTWV0aG9kCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLklDb252ZXJzaW9uT3B0aW9uc30gW29wdGlvbnNdIENvbnZlcnNpb24gb3B0aW9ucwoJICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgKi8gTWV0aG9kLnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewoJICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgkgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CgkgICAgICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewoJICAgICAgICAgICAgICAgIG9iamVjdC5uYW1lID0gIiI7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnBheWxvYWQgPSAiIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJuYW1lIikpIG9iamVjdC5uYW1lID0gbWVzc2FnZS5uYW1lOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBheWxvYWQiKSkgb2JqZWN0LnBheWxvYWQgPSBtZXNzYWdlLnBheWxvYWQ7CgkgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ29udmVydHMgdGhpcyBNZXRob2QgdG8gSlNPTi4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWV0aG9kCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IEpTT04gb2JqZWN0CgkgICAgICAgICAqLyBNZXRob2QucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsICRwcm90b2J1Zi51dGlsLnRvSlNPTk9wdGlvbnMpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogR2V0cyB0aGUgZGVmYXVsdCB0eXBlIHVybCBmb3IgTWV0aG9kCgkgICAgICAgICAqIEBmdW5jdGlvbiBnZXRUeXBlVXJsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXRob2QKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3R5cGVVcmxQcmVmaXhdIHlvdXIgY3VzdG9tIHR5cGVVcmxQcmVmaXgoZGVmYXVsdCAidHlwZS5nb29nbGVhcGlzLmNvbSIpCgkgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBkZWZhdWx0IHR5cGUgdXJsCgkgICAgICAgICAqLyBNZXRob2QuZ2V0VHlwZVVybCA9IGZ1bmN0aW9uIGdldFR5cGVVcmwodHlwZVVybFByZWZpeCkgewoJICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIHR5cGVVcmxQcmVmaXggPSAidHlwZS5nb29nbGVhcGlzLmNvbSI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuTWV0aG9kIjsKCSAgICAgICAgfTsKCSAgICAgICAgcmV0dXJuIE1ldGhvZDsKCSAgICB9KCk7CgkgICAgcHJvdG9jb2wuVXBkYXRlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGFuIFVwZGF0ZS4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBpbnRlcmZhY2UgSVVwZGF0ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbdnhdIFVwZGF0ZSB2eAoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbdnldIFVwZGF0ZSB2eQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbdnpdIFVwZGF0ZSB2egoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbdm94ZWxdIFVwZGF0ZSB2b3hlbAoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcnxudWxsfSBbbGlnaHRdIFVwZGF0ZSBsaWdodAoJICAgICAgICAgKi8gLyoqCgkgICAgICAgICAqIENvbnN0cnVjdHMgYSBuZXcgVXBkYXRlLgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGFuIFVwZGF0ZS4KCSAgICAgICAgICogQGltcGxlbWVudHMgSVVwZGF0ZQoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JVXBkYXRlPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqLyBmdW5jdGlvbiBVcGRhdGUocHJvcGVydGllcykgewoJICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKWlmIChwcm9wZXJ0aWVzW2tleXNbaV1dICE9IG51bGwpIHRoaXNba2V5c1tpXV0gPSBwcm9wZXJ0aWVzW2tleXNbaV1dOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBVcGRhdGUgdnguCgkgICAgICAgICAqIEBtZW1iZXIge251bWJlcn0gdngKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlVwZGF0ZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIFVwZGF0ZS5wcm90b3R5cGUudnggPSAwOwoJICAgICAgICAvKioKCSAgICAgICAgICogVXBkYXRlIHZ5LgoJICAgICAgICAgKiBAbWVtYmVyIHtudW1iZXJ9IHZ5CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5VcGRhdGUKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBVcGRhdGUucHJvdG90eXBlLnZ5ID0gMDsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIFVwZGF0ZSB2ei4KCSAgICAgICAgICogQG1lbWJlciB7bnVtYmVyfSB2egoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuVXBkYXRlCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gVXBkYXRlLnByb3RvdHlwZS52eiA9IDA7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBVcGRhdGUgdm94ZWwuCgkgICAgICAgICAqIEBtZW1iZXIge251bWJlcn0gdm94ZWwKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlVwZGF0ZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIFVwZGF0ZS5wcm90b3R5cGUudm94ZWwgPSAwOwoJICAgICAgICAvKioKCSAgICAgICAgICogVXBkYXRlIGxpZ2h0LgoJICAgICAgICAgKiBAbWVtYmVyIHtudW1iZXJ9IGxpZ2h0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5VcGRhdGUKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBVcGRhdGUucHJvdG90eXBlLmxpZ2h0ID0gMDsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgVXBkYXRlIGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGNyZWF0ZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuVXBkYXRlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JVXBkYXRlPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5VcGRhdGV9IFVwZGF0ZSBpbnN0YW5jZQoJICAgICAgICAgKi8gVXBkYXRlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICByZXR1cm4gbmV3IFVwZGF0ZShwcm9wZXJ0aWVzKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBVcGRhdGUgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuVXBkYXRlLnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5VcGRhdGUKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklVcGRhdGV9IG1lc3NhZ2UgVXBkYXRlIG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgKi8gVXBkYXRlLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgIGlmICghd3JpdGVyKSB3cml0ZXIgPSAkV3JpdGVyLmNyZWF0ZSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnggIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidngiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAxLCB3aXJlVHlwZSAwID0qLyA4KS5pbnQzMihtZXNzYWdlLnZ4KTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnZ5ICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInZ5IikpIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMCA9Ki8gMTYpLmludDMyKG1lc3NhZ2UudnkpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnogIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidnoiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAzLCB3aXJlVHlwZSAwID0qLyAyNCkuaW50MzIobWVzc2FnZS52eik7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS52b3hlbCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ2b3hlbCIpKSB3cml0ZXIudWludDMyKC8qIGlkIDQsIHdpcmVUeXBlIDAgPSovIDMyKS51aW50MzIobWVzc2FnZS52b3hlbCk7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5saWdodCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJsaWdodCIpKSB3cml0ZXIudWludDMyKC8qIGlkIDUsIHdpcmVUeXBlIDAgPSovIDQwKS51aW50MzIobWVzc2FnZS5saWdodCk7CgkgICAgICAgICAgICByZXR1cm4gd3JpdGVyOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRW5jb2RlcyB0aGUgc3BlY2lmaWVkIFVwZGF0ZSBtZXNzYWdlLCBsZW5ndGggZGVsaW1pdGVkLiBEb2VzIG5vdCBpbXBsaWNpdGx5IHtAbGluayBwcm90b2NvbC5VcGRhdGUudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlVwZGF0ZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSVVwZGF0ZX0gbWVzc2FnZSBVcGRhdGUgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBVcGRhdGUuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikubGRlbGltKCk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBEZWNvZGVzIGFuIFVwZGF0ZSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5VcGRhdGUKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5SZWFkZXJ8VWludDhBcnJheX0gcmVhZGVyIFJlYWRlciBvciBidWZmZXIgdG8gZGVjb2RlIGZyb20KCSAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtsZW5ndGhdIE1lc3NhZ2UgbGVuZ3RoIGlmIGtub3duIGJlZm9yZWhhbmQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLlVwZGF0ZX0gVXBkYXRlCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gVXBkYXRlLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIsIGxlbmd0aCkgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9ICRSZWFkZXIuY3JlYXRlKHJlYWRlcik7CgkgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5VcGRhdGUoKTsKCSAgICAgICAgICAgIHdoaWxlKHJlYWRlci5wb3MgPCBlbmQpewoJICAgICAgICAgICAgICAgIHZhciB0YWcgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgc3dpdGNoKHRhZyA+Pj4gMyl7CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMToKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnZ4ID0gcmVhZGVyLmludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnZ5ID0gcmVhZGVyLmludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnZ6ID0gcmVhZGVyLmludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnZveGVsID0gcmVhZGVyLnVpbnQzMigpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDU6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5saWdodCA9IHJlYWRlci51aW50MzIoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRlci5za2lwVHlwZSh0YWcgJiA3KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRGVjb2RlcyBhbiBVcGRhdGUgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlciwgbGVuZ3RoIGRlbGltaXRlZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuVXBkYXRlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5VcGRhdGV9IFVwZGF0ZQoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIFVwZGF0ZS5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gbmV3ICRSZWFkZXIocmVhZGVyKTsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBWZXJpZmllcyBhbiBVcGRhdGUgbWVzc2FnZS4KCSAgICAgICAgICogQGZ1bmN0aW9uIHZlcmlmeQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuVXBkYXRlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8bnVsbH0gYG51bGxgIGlmIHZhbGlkLCBvdGhlcndpc2UgdGhlIHJlYXNvbiB3aHkgaXQgaXMgbm90CgkgICAgICAgICAqLyBVcGRhdGUudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnggIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eCIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52eCkpIHJldHVybiAidng6IGludGVnZXIgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnkgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52eSkpIHJldHVybiAidnk6IGludGVnZXIgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnogIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eiIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52eikpIHJldHVybiAidno6IGludGVnZXIgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWwgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2b3hlbCIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52b3hlbCkpIHJldHVybiAidm94ZWw6IGludGVnZXIgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGlnaHQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsaWdodCIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS5saWdodCkpIHJldHVybiAibGlnaHQ6IGludGVnZXIgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGFuIFVwZGF0ZSBtZXNzYWdlIGZyb20gYSBwbGFpbiBvYmplY3QuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIHRoZWlyIHJlc3BlY3RpdmUgaW50ZXJuYWwgdHlwZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBmcm9tT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5VcGRhdGUKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBvYmplY3QgUGxhaW4gb2JqZWN0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5VcGRhdGV9IFVwZGF0ZQoJICAgICAgICAgKi8gVXBkYXRlLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewoJICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLlVwZGF0ZSkgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLlVwZGF0ZSgpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC52eCAhPSBudWxsKSBtZXNzYWdlLnZ4ID0gb2JqZWN0LnZ4IHwgMDsKCSAgICAgICAgICAgIGlmIChvYmplY3QudnkgIT0gbnVsbCkgbWVzc2FnZS52eSA9IG9iamVjdC52eSB8IDA7CgkgICAgICAgICAgICBpZiAob2JqZWN0LnZ6ICE9IG51bGwpIG1lc3NhZ2UudnogPSBvYmplY3QudnogfCAwOwoJICAgICAgICAgICAgaWYgKG9iamVjdC52b3hlbCAhPSBudWxsKSBtZXNzYWdlLnZveGVsID0gb2JqZWN0LnZveGVsID4+PiAwOwoJICAgICAgICAgICAgaWYgKG9iamVjdC5saWdodCAhPSBudWxsKSBtZXNzYWdlLmxpZ2h0ID0gb2JqZWN0LmxpZ2h0ID4+PiAwOwoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYW4gVXBkYXRlIG1lc3NhZ2UuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIG90aGVyIHR5cGVzIGlmIHNwZWNpZmllZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5VcGRhdGUKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLlVwZGF0ZX0gbWVzc2FnZSBVcGRhdGUKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gUGxhaW4gb2JqZWN0CgkgICAgICAgICAqLyBVcGRhdGUudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnZ4ID0gMDsKCSAgICAgICAgICAgICAgICBvYmplY3QudnkgPSAwOwoJICAgICAgICAgICAgICAgIG9iamVjdC52eiA9IDA7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnZveGVsID0gMDsKCSAgICAgICAgICAgICAgICBvYmplY3QubGlnaHQgPSAwOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnggIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eCIpKSBvYmplY3QudnggPSBtZXNzYWdlLnZ4OwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnkgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eSIpKSBvYmplY3QudnkgPSBtZXNzYWdlLnZ5OwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudnogIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eiIpKSBvYmplY3QudnogPSBtZXNzYWdlLnZ6OwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWwgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2b3hlbCIpKSBvYmplY3Qudm94ZWwgPSBtZXNzYWdlLnZveGVsOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGlnaHQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsaWdodCIpKSBvYmplY3QubGlnaHQgPSBtZXNzYWdlLmxpZ2h0OwoJICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENvbnZlcnRzIHRoaXMgVXBkYXRlIHRvIEpTT04uCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b0pTT04KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLlVwZGF0ZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICogQHJldHVybnMge09iamVjdC48c3RyaW5nLCo+fSBKU09OIG9iamVjdAoJICAgICAgICAgKi8gVXBkYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIFVwZGF0ZQoJICAgICAgICAgKiBAZnVuY3Rpb24gZ2V0VHlwZVVybAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuVXBkYXRlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlVXJsUHJlZml4XSB5b3VyIGN1c3RvbSB0eXBlVXJsUHJlZml4KGRlZmF1bHQgInR5cGUuZ29vZ2xlYXBpcy5jb20iKQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCB0eXBlIHVybAoJICAgICAgICAgKi8gVXBkYXRlLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKCSAgICAgICAgICAgIGlmICh0eXBlVXJsUHJlZml4ID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLlVwZGF0ZSI7CgkgICAgICAgIH07CgkgICAgICAgIHJldHVybiBVcGRhdGU7CgkgICAgfSgpOwoJICAgIHByb3RvY29sLkNoYXRNZXNzYWdlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGEgQ2hhdE1lc3NhZ2UuCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbAoJICAgICAgICAgKiBAaW50ZXJmYWNlIElDaGF0TWVzc2FnZQoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbdHlwZV0gQ2hhdE1lc3NhZ2UgdHlwZQoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbc2VuZGVyXSBDaGF0TWVzc2FnZSBzZW5kZXIKCSAgICAgICAgICogQHByb3BlcnR5IHtzdHJpbmd8bnVsbH0gW2JvZHldIENoYXRNZXNzYWdlIGJvZHkKCSAgICAgICAgICovIC8qKgoJICAgICAgICAgKiBDb25zdHJ1Y3RzIGEgbmV3IENoYXRNZXNzYWdlLgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wKCSAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGEgQ2hhdE1lc3NhZ2UuCgkgICAgICAgICAqIEBpbXBsZW1lbnRzIElDaGF0TWVzc2FnZQoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2hhdE1lc3NhZ2U9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICovIGZ1bmN0aW9uIENoYXRNZXNzYWdlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSlpZiAocHJvcGVydGllc1trZXlzW2ldXSAhPSBudWxsKSB0aGlzW2tleXNbaV1dID0gcHJvcGVydGllc1trZXlzW2ldXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICAvKioKCSAgICAgICAgICogQ2hhdE1lc3NhZ2UgdHlwZS4KCSAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSB0eXBlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIENoYXRNZXNzYWdlLnByb3RvdHlwZS50eXBlID0gIiI7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDaGF0TWVzc2FnZSBzZW5kZXIuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gc2VuZGVyCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIENoYXRNZXNzYWdlLnByb3RvdHlwZS5zZW5kZXIgPSAiIjsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENoYXRNZXNzYWdlIGJvZHkuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gYm9keQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2hhdE1lc3NhZ2UKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBDaGF0TWVzc2FnZS5wcm90b3R5cGUuYm9keSA9ICIiOwoJICAgICAgICAvKioKCSAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBDaGF0TWVzc2FnZSBpbnN0YW5jZSB1c2luZyB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkNoYXRNZXNzYWdlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2hhdE1lc3NhZ2U9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkNoYXRNZXNzYWdlfSBDaGF0TWVzc2FnZSBpbnN0YW5jZQoJICAgICAgICAgKi8gQ2hhdE1lc3NhZ2UuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIHJldHVybiBuZXcgQ2hhdE1lc3NhZ2UocHJvcGVydGllcyk7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgQ2hhdE1lc3NhZ2UgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuQ2hhdE1lc3NhZ2UudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGUKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkNoYXRNZXNzYWdlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2hhdE1lc3NhZ2V9IG1lc3NhZ2UgQ2hhdE1lc3NhZ2UgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBDaGF0TWVzc2FnZS5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICBpZiAoIXdyaXRlcikgd3JpdGVyID0gJFdyaXRlci5jcmVhdGUoKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidHlwZSIpKSB3cml0ZXIudWludDMyKC8qIGlkIDEsIHdpcmVUeXBlIDIgPSovIDEwKS5zdHJpbmcobWVzc2FnZS50eXBlKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnNlbmRlciAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJzZW5kZXIiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAyLCB3aXJlVHlwZSAyID0qLyAxOCkuc3RyaW5nKG1lc3NhZ2Uuc2VuZGVyKTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmJvZHkgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAiYm9keSIpKSB3cml0ZXIudWludDMyKC8qIGlkIDMsIHdpcmVUeXBlIDIgPSovIDI2KS5zdHJpbmcobWVzc2FnZS5ib2R5KTsKCSAgICAgICAgICAgIHJldHVybiB3cml0ZXI7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgQ2hhdE1lc3NhZ2UgbWVzc2FnZSwgbGVuZ3RoIGRlbGltaXRlZC4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuQ2hhdE1lc3NhZ2UudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLkNoYXRNZXNzYWdlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JQ2hhdE1lc3NhZ2V9IG1lc3NhZ2UgQ2hhdE1lc3NhZ2UgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBDaGF0TWVzc2FnZS5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyKS5sZGVsaW0oKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBDaGF0TWVzc2FnZSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuQ2hhdE1lc3NhZ2V9IENoYXRNZXNzYWdlCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gQ2hhdE1lc3NhZ2UuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHJlYWRlciwgbGVuZ3RoKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgIHZhciBlbmQgPSBsZW5ndGggPT09IHVuZGVmaW5lZCA/IHJlYWRlci5sZW4gOiByZWFkZXIucG9zICsgbGVuZ3RoLCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlKCk7CgkgICAgICAgICAgICB3aGlsZShyZWFkZXIucG9zIDwgZW5kKXsKCSAgICAgICAgICAgICAgICB2YXIgdGFnID0gcmVhZGVyLnVpbnQzMigpOwoJICAgICAgICAgICAgICAgIHN3aXRjaCh0YWcgPj4+IDMpewoJICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gcmVhZGVyLnN0cmluZygpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDI6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5zZW5kZXIgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmJvZHkgPSByZWFkZXIuc3RyaW5nKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnICYgNyk7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIERlY29kZXMgYSBDaGF0TWVzc2FnZSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuQ2hhdE1lc3NhZ2V9IENoYXRNZXNzYWdlCgkgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgKi8gQ2hhdE1lc3NhZ2UuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcikgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9IG5ldyAkUmVhZGVyKHJlYWRlcik7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogVmVyaWZpZXMgYSBDaGF0TWVzc2FnZSBtZXNzYWdlLgoJICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG1lc3NhZ2UgUGxhaW4gb2JqZWN0IHRvIHZlcmlmeQoJICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgKi8gQ2hhdE1lc3NhZ2UudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkgewoJICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS50eXBlKSkgcmV0dXJuICJ0eXBlOiBzdHJpbmcgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uuc2VuZGVyICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgic2VuZGVyIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2Uuc2VuZGVyKSkgcmV0dXJuICJzZW5kZXI6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5ib2R5ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiYm9keSIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLmJvZHkpKSByZXR1cm4gImJvZHk6IHN0cmluZyBleHBlY3RlZCI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBDaGF0TWVzc2FnZSBtZXNzYWdlIGZyb20gYSBwbGFpbiBvYmplY3QuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIHRoZWlyIHJlc3BlY3RpdmUgaW50ZXJuYWwgdHlwZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBmcm9tT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG9iamVjdCBQbGFpbiBvYmplY3QKCSAgICAgICAgICogQHJldHVybnMge3Byb3RvY29sLkNoYXRNZXNzYWdlfSBDaGF0TWVzc2FnZQoJICAgICAgICAgKi8gQ2hhdE1lc3NhZ2UuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqZWN0KSB7CgkgICAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QucHJvdG9jb2wuQ2hhdE1lc3NhZ2UpIHJldHVybiBvYmplY3Q7CgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5DaGF0TWVzc2FnZSgpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC50eXBlICE9IG51bGwpIG1lc3NhZ2UudHlwZSA9IFN0cmluZyhvYmplY3QudHlwZSk7CgkgICAgICAgICAgICBpZiAob2JqZWN0LnNlbmRlciAhPSBudWxsKSBtZXNzYWdlLnNlbmRlciA9IFN0cmluZyhvYmplY3Quc2VuZGVyKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QuYm9keSAhPSBudWxsKSBtZXNzYWdlLmJvZHkgPSBTdHJpbmcob2JqZWN0LmJvZHkpOwoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBDaGF0TWVzc2FnZSBtZXNzYWdlLiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byBvdGhlciB0eXBlcyBpZiBzcGVjaWZpZWQuCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b09iamVjdAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2hhdE1lc3NhZ2UKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLkNoYXRNZXNzYWdlfSBtZXNzYWdlIENoYXRNZXNzYWdlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLklDb252ZXJzaW9uT3B0aW9uc30gW29wdGlvbnNdIENvbnZlcnNpb24gb3B0aW9ucwoJICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgKi8gQ2hhdE1lc3NhZ2UudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CgkgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnR5cGUgPSAiIjsKCSAgICAgICAgICAgICAgICBvYmplY3Quc2VuZGVyID0gIiI7CgkgICAgICAgICAgICAgICAgb2JqZWN0LmJvZHkgPSAiIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ0eXBlIikpIG9iamVjdC50eXBlID0gbWVzc2FnZS50eXBlOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2Uuc2VuZGVyICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgic2VuZGVyIikpIG9iamVjdC5zZW5kZXIgPSBtZXNzYWdlLnNlbmRlcjsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmJvZHkgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJib2R5IikpIG9iamVjdC5ib2R5ID0gbWVzc2FnZS5ib2R5OwoJICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENvbnZlcnRzIHRoaXMgQ2hhdE1lc3NhZ2UgdG8gSlNPTi4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuQ2hhdE1lc3NhZ2UKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICovIENoYXRNZXNzYWdlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIENoYXRNZXNzYWdlCgkgICAgICAgICAqIEBmdW5jdGlvbiBnZXRUeXBlVXJsCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5DaGF0TWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdHlwZVVybFByZWZpeF0geW91ciBjdXN0b20gdHlwZVVybFByZWZpeChkZWZhdWx0ICJ0eXBlLmdvb2dsZWFwaXMuY29tIikKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgdHlwZSB1cmwKCSAgICAgICAgICovIENoYXRNZXNzYWdlLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKCSAgICAgICAgICAgIGlmICh0eXBlVXJsUHJlZml4ID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLkNoYXRNZXNzYWdlIjsKCSAgICAgICAgfTsKCSAgICAgICAgcmV0dXJuIENoYXRNZXNzYWdlOwoJICAgIH0oKTsKCSAgICBwcm90b2NvbC5NZXNzYWdlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGEgTWVzc2FnZS4KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sCgkgICAgICAgICAqIEBpbnRlcmZhY2UgSU1lc3NhZ2UKCSAgICAgICAgICogQHByb3BlcnR5IHtwcm90b2NvbC5NZXNzYWdlLlR5cGV8bnVsbH0gW3R5cGVdIE1lc3NhZ2UgdHlwZQoJICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ3xudWxsfSBbanNvbl0gTWVzc2FnZSBqc29uCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bGx9IFt0ZXh0XSBNZXNzYWdlIHRleHQKCSAgICAgICAgICogQHByb3BlcnR5IHtwcm90b2NvbC5JTWV0aG9kfG51bGx9IFttZXRob2RdIE1lc3NhZ2UgbWV0aG9kCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7cHJvdG9jb2wuSUNoYXRNZXNzYWdlfG51bGx9IFtjaGF0XSBNZXNzYWdlIGNoYXQKCSAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48cHJvdG9jb2wuSVBlZXI+fG51bGx9IFtwZWVyc10gTWVzc2FnZSBwZWVycwoJICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5Ljxwcm90b2NvbC5JRW50aXR5PnxudWxsfSBbZW50aXRpZXNdIE1lc3NhZ2UgZW50aXRpZXMKCSAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48cHJvdG9jb2wuSUNodW5rPnxudWxsfSBbY2h1bmtzXSBNZXNzYWdlIGNodW5rcwoJICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5Ljxwcm90b2NvbC5JRXZlbnQ+fG51bGx9IFtldmVudHNdIE1lc3NhZ2UgZXZlbnRzCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPHByb3RvY29sLklVcGRhdGU+fG51bGx9IFt1cGRhdGVzXSBNZXNzYWdlIHVwZGF0ZXMKCSAgICAgICAgICovIC8qKgoJICAgICAgICAgKiBDb25zdHJ1Y3RzIGEgbmV3IE1lc3NhZ2UuCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbAoJICAgICAgICAgKiBAY2xhc3NkZXNjIFJlcHJlc2VudHMgYSBNZXNzYWdlLgoJICAgICAgICAgKiBAaW1wbGVtZW50cyBJTWVzc2FnZQoJICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JTWVzc2FnZT19IFtwcm9wZXJ0aWVzXSBQcm9wZXJ0aWVzIHRvIHNldAoJICAgICAgICAgKi8gZnVuY3Rpb24gTWVzc2FnZShwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICB0aGlzLnBlZXJzID0gW107CgkgICAgICAgICAgICB0aGlzLmVudGl0aWVzID0gW107CgkgICAgICAgICAgICB0aGlzLmNodW5rcyA9IFtdOwoJICAgICAgICAgICAgdGhpcy5ldmVudHMgPSBbXTsKCSAgICAgICAgICAgIHRoaXMudXBkYXRlcyA9IFtdOwoJICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKWlmIChwcm9wZXJ0aWVzW2tleXNbaV1dICE9IG51bGwpIHRoaXNba2V5c1tpXV0gPSBwcm9wZXJ0aWVzW2tleXNbaV1dOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBNZXNzYWdlIHR5cGUuCgkgICAgICAgICAqIEBtZW1iZXIge3Byb3RvY29sLk1lc3NhZ2UuVHlwZX0gdHlwZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIE1lc3NhZ2UucHJvdG90eXBlLnR5cGUgPSAwOwoJICAgICAgICAvKioKCSAgICAgICAgICogTWVzc2FnZSBqc29uLgoJICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9IGpzb24KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBNZXNzYWdlLnByb3RvdHlwZS5qc29uID0gIiI7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBNZXNzYWdlIHRleHQuCgkgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gdGV4dAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIE1lc3NhZ2UucHJvdG90eXBlLnRleHQgPSAiIjsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE1lc3NhZ2UgbWV0aG9kLgoJICAgICAgICAgKiBAbWVtYmVyIHtwcm90b2NvbC5JTWV0aG9kfG51bGx8dW5kZWZpbmVkfSBtZXRob2QKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBNZXNzYWdlLnByb3RvdHlwZS5tZXRob2QgPSBudWxsOwoJICAgICAgICAvKioKCSAgICAgICAgICogTWVzc2FnZSBjaGF0LgoJICAgICAgICAgKiBAbWVtYmVyIHtwcm90b2NvbC5JQ2hhdE1lc3NhZ2V8bnVsbHx1bmRlZmluZWR9IGNoYXQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqLyBNZXNzYWdlLnByb3RvdHlwZS5jaGF0ID0gbnVsbDsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE1lc3NhZ2UgcGVlcnMuCgkgICAgICAgICAqIEBtZW1iZXIge0FycmF5Ljxwcm90b2NvbC5JUGVlcj59IHBlZXJzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNzYWdlCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gTWVzc2FnZS5wcm90b3R5cGUucGVlcnMgPSAkdXRpbC5lbXB0eUFycmF5OwoJICAgICAgICAvKioKCSAgICAgICAgICogTWVzc2FnZSBlbnRpdGllcy4KCSAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPHByb3RvY29sLklFbnRpdHk+fSBlbnRpdGllcwoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICovIE1lc3NhZ2UucHJvdG90eXBlLmVudGl0aWVzID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE1lc3NhZ2UgY2h1bmtzLgoJICAgICAgICAgKiBAbWVtYmVyIHtBcnJheS48cHJvdG9jb2wuSUNodW5rPn0gY2h1bmtzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNzYWdlCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gTWVzc2FnZS5wcm90b3R5cGUuY2h1bmtzID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE1lc3NhZ2UgZXZlbnRzLgoJICAgICAgICAgKiBAbWVtYmVyIHtBcnJheS48cHJvdG9jb2wuSUV2ZW50Pn0gZXZlbnRzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNzYWdlCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gTWVzc2FnZS5wcm90b3R5cGUuZXZlbnRzID0gJHV0aWwuZW1wdHlBcnJheTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE1lc3NhZ2UgdXBkYXRlcy4KCSAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPHByb3RvY29sLklVcGRhdGU+fSB1cGRhdGVzCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNzYWdlCgkgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgKi8gTWVzc2FnZS5wcm90b3R5cGUudXBkYXRlcyA9ICR1dGlsLmVtcHR5QXJyYXk7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgbmV3IE1lc3NhZ2UgaW5zdGFuY2UgdXNpbmcgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgoJICAgICAgICAgKiBAZnVuY3Rpb24gY3JlYXRlCgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNzYWdlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5JTWVzc2FnZT19IFtwcm9wZXJ0aWVzXSBQcm9wZXJ0aWVzIHRvIHNldAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuTWVzc2FnZX0gTWVzc2FnZSBpbnN0YW5jZQoJICAgICAgICAgKi8gTWVzc2FnZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocHJvcGVydGllcykgewoJICAgICAgICAgICAgcmV0dXJuIG5ldyBNZXNzYWdlKHByb3BlcnRpZXMpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRW5jb2RlcyB0aGUgc3BlY2lmaWVkIE1lc3NhZ2UgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgcHJvdG9jb2wuTWVzc2FnZS52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGVuY29kZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7cHJvdG9jb2wuSU1lc3NhZ2V9IG1lc3NhZ2UgTWVzc2FnZSBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuV3JpdGVyfSBbd3JpdGVyXSBXcml0ZXIgdG8gZW5jb2RlIHRvCgkgICAgICAgICAqIEByZXR1cm5zIHskcHJvdG9idWYuV3JpdGVyfSBXcml0ZXIKCSAgICAgICAgICovIE1lc3NhZ2UuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgaWYgKCF3cml0ZXIpIHdyaXRlciA9ICRXcml0ZXIuY3JlYXRlKCk7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS50eXBlICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInR5cGUiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAxLCB3aXJlVHlwZSAwID0qLyA4KS5pbnQzMihtZXNzYWdlLnR5cGUpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuanNvbiAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJqc29uIikpIHdyaXRlci51aW50MzIoLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8gMTgpLnN0cmluZyhtZXNzYWdlLmpzb24pOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudGV4dCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ0ZXh0IikpIHdyaXRlci51aW50MzIoLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8gMjYpLnN0cmluZyhtZXNzYWdlLnRleHQpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UubWV0aG9kICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIm1ldGhvZCIpKSAkcm9vdC5wcm90b2NvbC5NZXRob2QuZW5jb2RlKG1lc3NhZ2UubWV0aG9kLCB3cml0ZXIudWludDMyKC8qIGlkIDQsIHdpcmVUeXBlIDIgPSovIDM0KS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuY2hhdCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJjaGF0IikpICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlLmVuY29kZShtZXNzYWdlLmNoYXQsIHdyaXRlci51aW50MzIoLyogaWQgNSwgd2lyZVR5cGUgMiA9Ki8gNDIpLmZvcmsoKSkubGRlbGltKCk7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5wZWVycyAhPSBudWxsICYmIG1lc3NhZ2UucGVlcnMubGVuZ3RoKSBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5wZWVycy5sZW5ndGg7ICsraSkkcm9vdC5wcm90b2NvbC5QZWVyLmVuY29kZShtZXNzYWdlLnBlZXJzW2ldLCB3cml0ZXIudWludDMyKC8qIGlkIDYsIHdpcmVUeXBlIDIgPSovIDUwKS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZW50aXRpZXMgIT0gbnVsbCAmJiBtZXNzYWdlLmVudGl0aWVzLmxlbmd0aCkgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UuZW50aXRpZXMubGVuZ3RoOyArK2kpJHJvb3QucHJvdG9jb2wuRW50aXR5LmVuY29kZShtZXNzYWdlLmVudGl0aWVzW2ldLCB3cml0ZXIudWludDMyKC8qIGlkIDcsIHdpcmVUeXBlIDIgPSovIDU4KS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuY2h1bmtzICE9IG51bGwgJiYgbWVzc2FnZS5jaHVua3MubGVuZ3RoKSBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5jaHVua3MubGVuZ3RoOyArK2kpJHJvb3QucHJvdG9jb2wuQ2h1bmsuZW5jb2RlKG1lc3NhZ2UuY2h1bmtzW2ldLCB3cml0ZXIudWludDMyKC8qIGlkIDgsIHdpcmVUeXBlIDIgPSovIDY2KS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZXZlbnRzICE9IG51bGwgJiYgbWVzc2FnZS5ldmVudHMubGVuZ3RoKSBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5ldmVudHMubGVuZ3RoOyArK2kpJHJvb3QucHJvdG9jb2wuRXZlbnQuZW5jb2RlKG1lc3NhZ2UuZXZlbnRzW2ldLCB3cml0ZXIudWludDMyKC8qIGlkIDksIHdpcmVUeXBlIDIgPSovIDc0KS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudXBkYXRlcyAhPSBudWxsICYmIG1lc3NhZ2UudXBkYXRlcy5sZW5ndGgpIGZvcih2YXIgaSA9IDA7IGkgPCBtZXNzYWdlLnVwZGF0ZXMubGVuZ3RoOyArK2kpJHJvb3QucHJvdG9jb2wuVXBkYXRlLmVuY29kZShtZXNzYWdlLnVwZGF0ZXNbaV0sIHdyaXRlci51aW50MzIoLyogaWQgMTAsIHdpcmVUeXBlIDIgPSovIDgyKS5mb3JrKCkpLmxkZWxpbSgpOwoJICAgICAgICAgICAgcmV0dXJuIHdyaXRlcjsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBNZXNzYWdlIG1lc3NhZ2UsIGxlbmd0aCBkZWxpbWl0ZWQuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIHByb3RvY29sLk1lc3NhZ2UudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge3Byb3RvY29sLklNZXNzYWdlfSBtZXNzYWdlIE1lc3NhZ2UgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAqLyBNZXNzYWdlLmVuY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZChtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmVuY29kZShtZXNzYWdlLCB3cml0ZXIpLmxkZWxpbSgpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRGVjb2RlcyBhIE1lc3NhZ2UgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlci4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZQoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuTWVzc2FnZX0gTWVzc2FnZQoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIE1lc3NhZ2UuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHJlYWRlciwgbGVuZ3RoKSB7CgkgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgIHZhciBlbmQgPSBsZW5ndGggPT09IHVuZGVmaW5lZCA/IHJlYWRlci5sZW4gOiByZWFkZXIucG9zICsgbGVuZ3RoLCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLk1lc3NhZ2UoKTsKCSAgICAgICAgICAgIHdoaWxlKHJlYWRlci5wb3MgPCBlbmQpewoJICAgICAgICAgICAgICAgIHZhciB0YWcgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgc3dpdGNoKHRhZyA+Pj4gMyl7CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgMToKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSByZWFkZXIuaW50MzIoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuanNvbiA9IHJlYWRlci5zdHJpbmcoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudGV4dCA9IHJlYWRlci5zdHJpbmcoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubWV0aG9kID0gJHJvb3QucHJvdG9jb2wuTWV0aG9kLmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgNToKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYXQgPSAkcm9vdC5wcm90b2NvbC5DaGF0TWVzc2FnZS5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CgkgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5wZWVycyAmJiBtZXNzYWdlLnBlZXJzLmxlbmd0aCkpIG1lc3NhZ2UucGVlcnMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBlZXJzLnB1c2goJHJvb3QucHJvdG9jb2wuUGVlci5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSA3OgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG1lc3NhZ2UuZW50aXRpZXMgJiYgbWVzc2FnZS5lbnRpdGllcy5sZW5ndGgpKSBtZXNzYWdlLmVudGl0aWVzID0gW107CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcy5wdXNoKCRyb290LnByb3RvY29sLkVudGl0eS5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG1lc3NhZ2UuY2h1bmtzICYmIG1lc3NhZ2UuY2h1bmtzLmxlbmd0aCkpIG1lc3NhZ2UuY2h1bmtzID0gW107CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5jaHVua3MucHVzaCgkcm9vdC5wcm90b2NvbC5DaHVuay5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSA5OgoJICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG1lc3NhZ2UuZXZlbnRzICYmIG1lc3NhZ2UuZXZlbnRzLmxlbmd0aCkpIG1lc3NhZ2UuZXZlbnRzID0gW107CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5ldmVudHMucHVzaCgkcm9vdC5wcm90b2NvbC5FdmVudC5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDoKCSAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLnVwZGF0ZXMgJiYgbWVzc2FnZS51cGRhdGVzLmxlbmd0aCkpIG1lc3NhZ2UudXBkYXRlcyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudXBkYXRlcy5wdXNoKCRyb290LnByb3RvY29sLlVwZGF0ZS5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRlci5za2lwVHlwZSh0YWcgJiA3KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogRGVjb2RlcyBhIE1lc3NhZ2UgbWVzc2FnZSBmcm9tIHRoZSBzcGVjaWZpZWQgcmVhZGVyIG9yIGJ1ZmZlciwgbGVuZ3RoIGRlbGltaXRlZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgKiBAcmV0dXJucyB7cHJvdG9jb2wuTWVzc2FnZX0gTWVzc2FnZQoJICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBheWxvYWQgaXMgbm90IGEgcmVhZGVyIG9yIHZhbGlkIGJ1ZmZlcgoJICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICovIE1lc3NhZ2UuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcikgewoJICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9IG5ldyAkUmVhZGVyKHJlYWRlcik7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogVmVyaWZpZXMgYSBNZXNzYWdlIG1lc3NhZ2UuCgkgICAgICAgICAqIEBmdW5jdGlvbiB2ZXJpZnkKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBtZXNzYWdlIFBsYWluIG9iamVjdCB0byB2ZXJpZnkKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ3xudWxsfSBgbnVsbGAgaWYgdmFsaWQsIG90aGVyd2lzZSB0aGUgcmVhc29uIHdoeSBpdCBpcyBub3QKCSAgICAgICAgICovIE1lc3NhZ2UudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkgc3dpdGNoKG1lc3NhZ2UudHlwZSl7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJ0eXBlOiBlbnVtIHZhbHVlIGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICBjYXNlIDA6CgkgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgIGNhc2UgMjoKCSAgICAgICAgICAgICAgICBjYXNlIDM6CgkgICAgICAgICAgICAgICAgY2FzZSA0OgoJICAgICAgICAgICAgICAgIGNhc2UgNToKCSAgICAgICAgICAgICAgICBjYXNlIDY6CgkgICAgICAgICAgICAgICAgY2FzZSA3OgoJICAgICAgICAgICAgICAgIGNhc2UgODoKCSAgICAgICAgICAgICAgICBjYXNlIDk6CgkgICAgICAgICAgICAgICAgY2FzZSAxMDoKCSAgICAgICAgICAgICAgICBjYXNlIDExOgoJICAgICAgICAgICAgICAgIGNhc2UgMTI6CgkgICAgICAgICAgICAgICAgY2FzZSAxMzoKCSAgICAgICAgICAgICAgICBjYXNlIDE0OgoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmpzb24gIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJqc29uIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UuanNvbikpIHJldHVybiAianNvbjogc3RyaW5nIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLnRleHQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ0ZXh0IikpIHsKCSAgICAgICAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UudGV4dCkpIHJldHVybiAidGV4dDogc3RyaW5nIGV4cGVjdGVkIjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLm1ldGhvZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGhvZCIpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJHJvb3QucHJvdG9jb2wuTWV0aG9kLnZlcmlmeShtZXNzYWdlLm1ldGhvZCk7CgkgICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gIm1ldGhvZC4iICsgZXJyb3I7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5jaGF0ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiY2hhdCIpKSB7CgkgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJHJvb3QucHJvdG9jb2wuQ2hhdE1lc3NhZ2UudmVyaWZ5KG1lc3NhZ2UuY2hhdCk7CgkgICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gImNoYXQuIiArIGVycm9yOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucGVlcnMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJwZWVycyIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UucGVlcnMpKSByZXR1cm4gInBlZXJzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UucGVlcnMubGVuZ3RoOyArK2kpewoJICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5QZWVyLnZlcmlmeShtZXNzYWdlLnBlZXJzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gInBlZXJzLiIgKyBlcnJvcjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5lbnRpdGllcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImVudGl0aWVzIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5lbnRpdGllcykpIHJldHVybiAiZW50aXRpZXM6IGFycmF5IGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5lbnRpdGllcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9ICRyb290LnByb3RvY29sLkVudGl0eS52ZXJpZnkobWVzc2FnZS5lbnRpdGllc1tpXSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuICJlbnRpdGllcy4iICsgZXJyb3I7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuY2h1bmtzICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiY2h1bmtzIikpIHsKCSAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5jaHVua3MpKSByZXR1cm4gImNodW5rczogYXJyYXkgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBtZXNzYWdlLmNodW5rcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9ICRyb290LnByb3RvY29sLkNodW5rLnZlcmlmeShtZXNzYWdlLmNodW5rc1tpXSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuICJjaHVua3MuIiArIGVycm9yOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmV2ZW50cyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImV2ZW50cyIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UuZXZlbnRzKSkgcmV0dXJuICJldmVudHM6IGFycmF5IGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbWVzc2FnZS5ldmVudHMubGVuZ3RoOyArK2kpewoJICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5FdmVudC52ZXJpZnkobWVzc2FnZS5ldmVudHNbaV0pOwoJICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiAiZXZlbnRzLiIgKyBlcnJvcjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS51cGRhdGVzICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidXBkYXRlcyIpKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UudXBkYXRlcykpIHJldHVybiAidXBkYXRlczogYXJyYXkgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBtZXNzYWdlLnVwZGF0ZXMubGVuZ3RoOyArK2kpewoJICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5VcGRhdGUudmVyaWZ5KG1lc3NhZ2UudXBkYXRlc1tpXSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuICJ1cGRhdGVzLiIgKyBlcnJvcjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIENyZWF0ZXMgYSBNZXNzYWdlIG1lc3NhZ2UgZnJvbSBhIHBsYWluIG9iamVjdC4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gdGhlaXIgcmVzcGVjdGl2ZSBpbnRlcm5hbCB0eXBlcy4KCSAgICAgICAgICogQGZ1bmN0aW9uIGZyb21PYmplY3QKCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCo+fSBvYmplY3QgUGxhaW4gb2JqZWN0CgkgICAgICAgICAqIEByZXR1cm5zIHtwcm90b2NvbC5NZXNzYWdlfSBNZXNzYWdlCgkgICAgICAgICAqLyBNZXNzYWdlLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewoJICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLk1lc3NhZ2UpIHJldHVybiBvYmplY3Q7CgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5NZXNzYWdlKCk7CgkgICAgICAgICAgICBzd2l0Y2gob2JqZWN0LnR5cGUpewoJICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnR5cGUgPT09ICJudW1iZXIiKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSBvYmplY3QudHlwZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIklOSVQiOgoJICAgICAgICAgICAgICAgIGNhc2UgMDoKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gMDsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgY2FzZSAiSk9JTiI6CgkgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAxOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJMRUFWRSI6CgkgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAyOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJFUlJPUiI6CgkgICAgICAgICAgICAgICAgY2FzZSAzOgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAzOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJQRUVSIjoKCSAgICAgICAgICAgICAgICBjYXNlIDQ6CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDQ7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIkVOVElUWSI6CgkgICAgICAgICAgICAgICAgY2FzZSA1OgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSA1OwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJMT0FEIjoKCSAgICAgICAgICAgICAgICBjYXNlIDY6CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDY7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIlVOTE9BRCI6CgkgICAgICAgICAgICAgICAgY2FzZSA3OgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSA3OwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJVUERBVEUiOgoJICAgICAgICAgICAgICAgIGNhc2UgODoKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gODsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgY2FzZSAiTUVUSE9EIjoKCSAgICAgICAgICAgICAgICBjYXNlIDk6CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDk7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIkNIQVQiOgoJICAgICAgICAgICAgICAgIGNhc2UgMTA6CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDEwOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJUUkFOU1BPUlQiOgoJICAgICAgICAgICAgICAgIGNhc2UgMTE6CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDExOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICBjYXNlICJFVkVOVCI6CgkgICAgICAgICAgICAgICAgY2FzZSAxMjoKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gMTI7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIkFDVElPTiI6CgkgICAgICAgICAgICAgICAgY2FzZSAxMzoKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gMTM7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIlNUQVRTIjoKCSAgICAgICAgICAgICAgICBjYXNlIDE0OgoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAxNDsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAob2JqZWN0Lmpzb24gIT0gbnVsbCkgbWVzc2FnZS5qc29uID0gU3RyaW5nKG9iamVjdC5qc29uKTsKCSAgICAgICAgICAgIGlmIChvYmplY3QudGV4dCAhPSBudWxsKSBtZXNzYWdlLnRleHQgPSBTdHJpbmcob2JqZWN0LnRleHQpOwoJICAgICAgICAgICAgaWYgKG9iamVjdC5tZXRob2QgIT0gbnVsbCkgewoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0Lm1ldGhvZCAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UubWV0aG9kOiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLm1ldGhvZCA9ICRyb290LnByb3RvY29sLk1ldGhvZC5mcm9tT2JqZWN0KG9iamVjdC5tZXRob2QpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG9iamVjdC5jaGF0ICE9IG51bGwpIHsKCSAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5jaGF0ICE9PSAib2JqZWN0IikgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5jaGF0OiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYXQgPSAkcm9vdC5wcm90b2NvbC5DaGF0TWVzc2FnZS5mcm9tT2JqZWN0KG9iamVjdC5jaGF0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvYmplY3QucGVlcnMpIHsKCSAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LnBlZXJzKSkgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5wZWVyczogYXJyYXkgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLnBlZXJzID0gW107CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG9iamVjdC5wZWVycy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnBlZXJzW2ldICE9PSAib2JqZWN0IikgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5wZWVyczogb2JqZWN0IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UucGVlcnNbaV0gPSAkcm9vdC5wcm90b2NvbC5QZWVyLmZyb21PYmplY3Qob2JqZWN0LnBlZXJzW2ldKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAob2JqZWN0LmVudGl0aWVzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5lbnRpdGllcykpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UuZW50aXRpZXM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBvYmplY3QuZW50aXRpZXMubGVuZ3RoOyArK2kpewoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5lbnRpdGllc1tpXSAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UuZW50aXRpZXM6IG9iamVjdCBleHBlY3RlZCIpOwoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmVudGl0aWVzW2ldID0gJHJvb3QucHJvdG9jb2wuRW50aXR5LmZyb21PYmplY3Qob2JqZWN0LmVudGl0aWVzW2ldKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAob2JqZWN0LmNodW5rcykgewoJICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QuY2h1bmtzKSkgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5jaHVua3M6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5jaHVua3MgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2JqZWN0LmNodW5rcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LmNodW5rc1tpXSAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UuY2h1bmtzOiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5jaHVua3NbaV0gPSAkcm9vdC5wcm90b2NvbC5DaHVuay5mcm9tT2JqZWN0KG9iamVjdC5jaHVua3NbaV0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvYmplY3QuZXZlbnRzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5ldmVudHMpKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5NZXNzYWdlLmV2ZW50czogYXJyYXkgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLmV2ZW50cyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBvYmplY3QuZXZlbnRzLmxlbmd0aDsgKytpKXsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZXZlbnRzW2ldICE9PSAib2JqZWN0IikgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5ldmVudHM6IG9iamVjdCBleHBlY3RlZCIpOwoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmV2ZW50c1tpXSA9ICRyb290LnByb3RvY29sLkV2ZW50LmZyb21PYmplY3Qob2JqZWN0LmV2ZW50c1tpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG9iamVjdC51cGRhdGVzKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC51cGRhdGVzKSkgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS51cGRhdGVzOiBhcnJheSBleHBlY3RlZCIpOwoJICAgICAgICAgICAgICAgIG1lc3NhZ2UudXBkYXRlcyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBvYmplY3QudXBkYXRlcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnVwZGF0ZXNbaV0gIT09ICJvYmplY3QiKSB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5NZXNzYWdlLnVwZGF0ZXM6IG9iamVjdCBleHBlY3RlZCIpOwoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnVwZGF0ZXNbaV0gPSAkcm9vdC5wcm90b2NvbC5VcGRhdGUuZnJvbU9iamVjdChvYmplY3QudXBkYXRlc1tpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBNZXNzYWdlIG1lc3NhZ2UuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIG90aGVyIHR5cGVzIGlmIHNwZWNpZmllZC4KCSAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAqIEBtZW1iZXJvZiBwcm90b2NvbC5NZXNzYWdlCgkgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICogQHBhcmFtIHtwcm90b2NvbC5NZXNzYWdlfSBtZXNzYWdlIE1lc3NhZ2UKCSAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gUGxhaW4gb2JqZWN0CgkgICAgICAgICAqLyBNZXNzYWdlLnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewoJICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CgkgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CgkgICAgICAgICAgICBpZiAob3B0aW9ucy5hcnJheXMgfHwgb3B0aW9ucy5kZWZhdWx0cykgewoJICAgICAgICAgICAgICAgIG9iamVjdC5wZWVycyA9IFtdOwoJICAgICAgICAgICAgICAgIG9iamVjdC5lbnRpdGllcyA9IFtdOwoJICAgICAgICAgICAgICAgIG9iamVjdC5jaHVua3MgPSBbXTsKCSAgICAgICAgICAgICAgICBvYmplY3QuZXZlbnRzID0gW107CgkgICAgICAgICAgICAgICAgb2JqZWN0LnVwZGF0ZXMgPSBbXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnR5cGUgPSBvcHRpb25zLmVudW1zID09PSBTdHJpbmcgPyAiSU5JVCIgOiAwOwoJICAgICAgICAgICAgICAgIG9iamVjdC5qc29uID0gIiI7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnRleHQgPSAiIjsKCSAgICAgICAgICAgICAgICBvYmplY3QubWV0aG9kID0gbnVsbDsKCSAgICAgICAgICAgICAgICBvYmplY3QuY2hhdCA9IG51bGw7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS50eXBlICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidHlwZSIpKSBvYmplY3QudHlwZSA9IG9wdGlvbnMuZW51bXMgPT09IFN0cmluZyA/ICRyb290LnByb3RvY29sLk1lc3NhZ2UuVHlwZVttZXNzYWdlLnR5cGVdID09PSB1bmRlZmluZWQgPyBtZXNzYWdlLnR5cGUgOiAkcm9vdC5wcm90b2NvbC5NZXNzYWdlLlR5cGVbbWVzc2FnZS50eXBlXSA6IG1lc3NhZ2UudHlwZTsKCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmpzb24gIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJqc29uIikpIG9iamVjdC5qc29uID0gbWVzc2FnZS5qc29uOwoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudGV4dCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInRleHQiKSkgb2JqZWN0LnRleHQgPSBtZXNzYWdlLnRleHQ7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5tZXRob2QgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJtZXRob2QiKSkgb2JqZWN0Lm1ldGhvZCA9ICRyb290LnByb3RvY29sLk1ldGhvZC50b09iamVjdChtZXNzYWdlLm1ldGhvZCwgb3B0aW9ucyk7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5jaGF0ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiY2hhdCIpKSBvYmplY3QuY2hhdCA9ICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlLnRvT2JqZWN0KG1lc3NhZ2UuY2hhdCwgb3B0aW9ucyk7CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5wZWVycyAmJiBtZXNzYWdlLnBlZXJzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC5wZWVycyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBtZXNzYWdlLnBlZXJzLmxlbmd0aDsgKytqKW9iamVjdC5wZWVyc1tqXSA9ICRyb290LnByb3RvY29sLlBlZXIudG9PYmplY3QobWVzc2FnZS5wZWVyc1tqXSwgb3B0aW9ucyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5lbnRpdGllcyAmJiBtZXNzYWdlLmVudGl0aWVzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIG9iamVjdC5lbnRpdGllcyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBtZXNzYWdlLmVudGl0aWVzLmxlbmd0aDsgKytqKW9iamVjdC5lbnRpdGllc1tqXSA9ICRyb290LnByb3RvY29sLkVudGl0eS50b09iamVjdChtZXNzYWdlLmVudGl0aWVzW2pdLCBvcHRpb25zKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChtZXNzYWdlLmNodW5rcyAmJiBtZXNzYWdlLmNodW5rcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICBvYmplY3QuY2h1bmtzID0gW107CgkgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IG1lc3NhZ2UuY2h1bmtzLmxlbmd0aDsgKytqKW9iamVjdC5jaHVua3Nbal0gPSAkcm9vdC5wcm90b2NvbC5DaHVuay50b09iamVjdChtZXNzYWdlLmNodW5rc1tqXSwgb3B0aW9ucyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5ldmVudHMgJiYgbWVzc2FnZS5ldmVudHMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LmV2ZW50cyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBtZXNzYWdlLmV2ZW50cy5sZW5ndGg7ICsrailvYmplY3QuZXZlbnRzW2pdID0gJHJvb3QucHJvdG9jb2wuRXZlbnQudG9PYmplY3QobWVzc2FnZS5ldmVudHNbal0sIG9wdGlvbnMpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UudXBkYXRlcyAmJiBtZXNzYWdlLnVwZGF0ZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgb2JqZWN0LnVwZGF0ZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbWVzc2FnZS51cGRhdGVzLmxlbmd0aDsgKytqKW9iamVjdC51cGRhdGVzW2pdID0gJHJvb3QucHJvdG9jb2wuVXBkYXRlLnRvT2JqZWN0KG1lc3NhZ2UudXBkYXRlc1tqXSwgb3B0aW9ucyk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogQ29udmVydHMgdGhpcyBNZXNzYWdlIHRvIEpTT04uCgkgICAgICAgICAqIEBmdW5jdGlvbiB0b0pTT04KCSAgICAgICAgICogQG1lbWJlcm9mIHByb3RvY29sLk1lc3NhZ2UKCSAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICovIE1lc3NhZ2UucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsICRwcm90b2J1Zi51dGlsLnRvSlNPTk9wdGlvbnMpOwoJICAgICAgICB9OwoJICAgICAgICAvKioKCSAgICAgICAgICogR2V0cyB0aGUgZGVmYXVsdCB0eXBlIHVybCBmb3IgTWVzc2FnZQoJICAgICAgICAgKiBAZnVuY3Rpb24gZ2V0VHlwZVVybAoJICAgICAgICAgKiBAbWVtYmVyb2YgcHJvdG9jb2wuTWVzc2FnZQoJICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdHlwZVVybFByZWZpeF0geW91ciBjdXN0b20gdHlwZVVybFByZWZpeChkZWZhdWx0ICJ0eXBlLmdvb2dsZWFwaXMuY29tIikKCSAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgdHlwZSB1cmwKCSAgICAgICAgICovIE1lc3NhZ2UuZ2V0VHlwZVVybCA9IGZ1bmN0aW9uIGdldFR5cGVVcmwodHlwZVVybFByZWZpeCkgewoJICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgIHR5cGVVcmxQcmVmaXggPSAidHlwZS5nb29nbGVhcGlzLmNvbSI7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuTWVzc2FnZSI7CgkgICAgICAgIH07CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBUeXBlIGVudW0uCgkgICAgICAgICAqIEBuYW1lIHByb3RvY29sLk1lc3NhZ2UuVHlwZQoJICAgICAgICAgKiBAZW51bSB7bnVtYmVyfQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gSU5JVD0wIElOSVQgdmFsdWUKCSAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IEpPSU49MSBKT0lOIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBMRUFWRT0yIExFQVZFIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBFUlJPUj0zIEVSUk9SIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBQRUVSPTQgUEVFUiB2YWx1ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gRU5USVRZPTUgRU5USVRZIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBMT0FEPTYgTE9BRCB2YWx1ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gVU5MT0FEPTcgVU5MT0FEIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBVUERBVEU9OCBVUERBVEUgdmFsdWUKCSAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IE1FVEhPRD05IE1FVEhPRCB2YWx1ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gQ0hBVD0xMCBDSEFUIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBUUkFOU1BPUlQ9MTEgVFJBTlNQT1JUIHZhbHVlCgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBFVkVOVD0xMiBFVkVOVCB2YWx1ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gQUNUSU9OPTEzIEFDVElPTiB2YWx1ZQoJICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gU1RBVFM9MTQgU1RBVFMgdmFsdWUKCSAgICAgICAgICovIE1lc3NhZ2UuVHlwZSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgdmFyIHZhbHVlc0J5SWQgPSB7fSwgdmFsdWVzID0gT2JqZWN0LmNyZWF0ZSh2YWx1ZXNCeUlkKTsKCSAgICAgICAgICAgIHZhbHVlc1t2YWx1ZXNCeUlkWzBdID0gIklOSVQiXSA9IDA7CgkgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxXSA9ICJKT0lOIl0gPSAxOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMl0gPSAiTEVBVkUiXSA9IDI7CgkgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFszXSA9ICJFUlJPUiJdID0gMzsKCSAgICAgICAgICAgIHZhbHVlc1t2YWx1ZXNCeUlkWzRdID0gIlBFRVIiXSA9IDQ7CgkgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFs1XSA9ICJFTlRJVFkiXSA9IDU7CgkgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFs2XSA9ICJMT0FEIl0gPSA2OwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbN10gPSAiVU5MT0FEIl0gPSA3OwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbOF0gPSAiVVBEQVRFIl0gPSA4OwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbOV0gPSAiTUVUSE9EIl0gPSA5OwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMTBdID0gIkNIQVQiXSA9IDEwOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMTFdID0gIlRSQU5TUE9SVCJdID0gMTE7CgkgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxMl0gPSAiRVZFTlQiXSA9IDEyOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMTNdID0gIkFDVElPTiJdID0gMTM7CgkgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxNF0gPSAiU1RBVFMiXSA9IDE0OwoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKCSAgICAgICAgfSgpOwoJICAgICAgICByZXR1cm4gTWVzc2FnZTsKCSAgICB9KCk7CgkgICAgcmV0dXJuIHByb3RvY29sOwoJfSgpOwoJJHJvb3QuZ29vZ2xlID0gZnVuY3Rpb24oKSB7CgkgICAgLyoqCgkgICAgICogTmFtZXNwYWNlIGdvb2dsZS4KCSAgICAgKiBAZXhwb3J0cyBnb29nbGUKCSAgICAgKiBAbmFtZXNwYWNlCgkgICAgICovIHZhciBnb29nbGUgPSB7fTsKCSAgICBnb29nbGUucHJvdG9idWYgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE5hbWVzcGFjZSBwcm90b2J1Zi4KCSAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZQoJICAgICAgICAgKiBAbmFtZXNwYWNlCgkgICAgICAgICAqLyB2YXIgcHJvdG9idWYgPSB7fTsKCSAgICAgICAgcHJvdG9idWYuU3RydWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFByb3BlcnRpZXMgb2YgYSBTdHJ1Y3QuCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmCgkgICAgICAgICAgICAgKiBAaW50ZXJmYWNlIElTdHJ1Y3QKCSAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0LjxzdHJpbmcsZ29vZ2xlLnByb3RvYnVmLklWYWx1ZT58bnVsbH0gW2ZpZWxkc10gU3RydWN0IGZpZWxkcwoJICAgICAgICAgICAgICovIC8qKgoJICAgICAgICAgICAgICogQ29uc3RydWN0cyBhIG5ldyBTdHJ1Y3QuCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmCgkgICAgICAgICAgICAgKiBAY2xhc3NkZXNjIFJlcHJlc2VudHMgYSBTdHJ1Y3QuCgkgICAgICAgICAgICAgKiBAaW1wbGVtZW50cyBJU3RydWN0CgkgICAgICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICAgICAqIEBwYXJhbSB7Z29vZ2xlLnByb3RvYnVmLklTdHJ1Y3Q9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICAgICAqLyBmdW5jdGlvbiBTdHJ1Y3QocHJvcGVydGllcykgewoJICAgICAgICAgICAgICAgIHRoaXMuZmllbGRzID0ge307CgkgICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSlpZiAocHJvcGVydGllc1trZXlzW2ldXSAhPSBudWxsKSB0aGlzW2tleXNbaV1dID0gcHJvcGVydGllc1trZXlzW2ldXTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFN0cnVjdCBmaWVsZHMuCgkgICAgICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3QuPHN0cmluZyxnb29nbGUucHJvdG9idWYuSVZhbHVlPn0gZmllbGRzCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdAoJICAgICAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAgICAgKi8gU3RydWN0LnByb3RvdHlwZS5maWVsZHMgPSAkdXRpbC5lbXB0eU9iamVjdDsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBTdHJ1Y3QgaW5zdGFuY2UgdXNpbmcgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGNyZWF0ZQoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5TdHJ1Y3QKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7Z29vZ2xlLnByb3RvYnVmLklTdHJ1Y3Q9fSBbcHJvcGVydGllc10gUHJvcGVydGllcyB0byBzZXQKCSAgICAgICAgICAgICAqIEByZXR1cm5zIHtnb29nbGUucHJvdG9idWYuU3RydWN0fSBTdHJ1Y3QgaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBTdHJ1Y3QuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFN0cnVjdChwcm9wZXJ0aWVzKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBTdHJ1Y3QgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGUKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuU3RydWN0CgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge2dvb2dsZS5wcm90b2J1Zi5JU3RydWN0fSBtZXNzYWdlIFN0cnVjdCBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgICAgICovIFN0cnVjdC5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICAgICAgaWYgKCF3cml0ZXIpIHdyaXRlciA9ICRXcml0ZXIuY3JlYXRlKCk7CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmllbGRzICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImZpZWxkcyIpKSBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhtZXNzYWdlLmZpZWxkcyksIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgIHdyaXRlci51aW50MzIoLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8gMTApLmZvcmsoKS51aW50MzIoLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8gMTApLnN0cmluZyhrZXlzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlZhbHVlLmVuY29kZShtZXNzYWdlLmZpZWxkc1trZXlzW2ldXSwgd3JpdGVyLnVpbnQzMigvKiBpZCAyLCB3aXJlVHlwZSAyID0qLyAxOCkuZm9yaygpKS5sZGVsaW0oKS5sZGVsaW0oKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIHdyaXRlcjsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBTdHJ1Y3QgbWVzc2FnZSwgbGVuZ3RoIGRlbGltaXRlZC4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuU3RydWN0CgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge2dvb2dsZS5wcm90b2J1Zi5JU3RydWN0fSBtZXNzYWdlIFN0cnVjdCBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgICAgICovIFN0cnVjdC5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikubGRlbGltKCk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBEZWNvZGVzIGEgU3RydWN0IG1lc3NhZ2UgZnJvbSB0aGUgc3BlY2lmaWVkIHJlYWRlciBvciBidWZmZXIuCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdAoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5TdHJ1Y3R9IFN0cnVjdAoJICAgICAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgICAgICovIFN0cnVjdC5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyLCBsZW5ndGgpIHsKCSAgICAgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0KCksIGtleSwgdmFsdWU7CgkgICAgICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZCl7CgkgICAgICAgICAgICAgICAgICAgIHZhciB0YWcgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgIHN3aXRjaCh0YWcgPj4+IDMpewoJICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmllbGRzID09PSAkdXRpbC5lbXB0eU9iamVjdCkgbWVzc2FnZS5maWVsZHMgPSB7fTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZDIgPSByZWFkZXIudWludDMyKCkgKyByZWFkZXIucG9zOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAiIjsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBudWxsOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShyZWFkZXIucG9zIDwgZW5kMil7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFnMiA9IHJlYWRlci51aW50MzIoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCh0YWcyID4+PiAzKXsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHJlYWRlci5zdHJpbmcoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRyb290Lmdvb2dsZS5wcm90b2J1Zi5WYWx1ZS5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkZXIuc2tpcFR5cGUodGFnMiAmIDcpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmZpZWxkc1trZXldID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZGVyLnNraXBUeXBlKHRhZyAmIDcpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogRGVjb2RlcyBhIFN0cnVjdCBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5TdHJ1Y3QKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5TdHJ1Y3R9IFN0cnVjdAoJICAgICAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgICAgICovIFN0cnVjdC5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9IG5ldyAkUmVhZGVyKHJlYWRlcik7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlciwgcmVhZGVyLnVpbnQzMigpKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFZlcmlmaWVzIGEgU3RydWN0IG1lc3NhZ2UuCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdAoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgICAgICovIFN0cnVjdC52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmZpZWxkcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImZpZWxkcyIpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmICghJHV0aWwuaXNPYmplY3QobWVzc2FnZS5maWVsZHMpKSByZXR1cm4gImZpZWxkczogb2JqZWN0IGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IE9iamVjdC5rZXlzKG1lc3NhZ2UuZmllbGRzKTsKCSAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGtleS5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuVmFsdWUudmVyaWZ5KG1lc3NhZ2UuZmllbGRzW2tleVtpXV0pOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gImZpZWxkcy4iICsgZXJyb3I7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBDcmVhdGVzIGEgU3RydWN0IG1lc3NhZ2UgZnJvbSBhIHBsYWluIG9iamVjdC4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gdGhlaXIgcmVzcGVjdGl2ZSBpbnRlcm5hbCB0eXBlcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBmcm9tT2JqZWN0CgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdAoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gb2JqZWN0IFBsYWluIG9iamVjdAoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5TdHJ1Y3R9IFN0cnVjdAoJICAgICAgICAgICAgICovIFN0cnVjdC5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKCSAgICAgICAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlN0cnVjdCkgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0KCk7CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdC5maWVsZHMpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZmllbGRzICE9PSAib2JqZWN0IikgdGhyb3cgVHlwZUVycm9yKCIuZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC5maWVsZHM6IG9iamVjdCBleHBlY3RlZCIpOwoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmZpZWxkcyA9IHt9OwoJICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3QuZmllbGRzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKXsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LmZpZWxkc1trZXlzW2ldXSAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLmdvb2dsZS5wcm90b2J1Zi5TdHJ1Y3QuZmllbGRzOiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZmllbGRzW2tleXNbaV1dID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlZhbHVlLmZyb21PYmplY3Qob2JqZWN0LmZpZWxkc1trZXlzW2ldXSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBTdHJ1Y3QgbWVzc2FnZS4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gb3RoZXIgdHlwZXMgaWYgc3BlY2lmaWVkLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlN0cnVjdAoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtnb29nbGUucHJvdG9idWYuU3RydWN0fSBtZXNzYWdlIFN0cnVjdAoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgICAgICovIFN0cnVjdC50b09iamVjdCA9IGZ1bmN0aW9uIHRvT2JqZWN0KG1lc3NhZ2UsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CgkgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub2JqZWN0cyB8fCBvcHRpb25zLmRlZmF1bHRzKSBvYmplY3QuZmllbGRzID0ge307CgkgICAgICAgICAgICAgICAgdmFyIGtleXMyOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmZpZWxkcyAmJiAoa2V5czIgPSBPYmplY3Qua2V5cyhtZXNzYWdlLmZpZWxkcykpLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgICAgICBvYmplY3QuZmllbGRzID0ge307CgkgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBrZXlzMi5sZW5ndGg7ICsrailvYmplY3QuZmllbGRzW2tleXMyW2pdXSA9ICRyb290Lmdvb2dsZS5wcm90b2J1Zi5WYWx1ZS50b09iamVjdChtZXNzYWdlLmZpZWxkc1trZXlzMltqXV0sIG9wdGlvbnMpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQ29udmVydHMgdGhpcyBTdHJ1Y3QgdG8gSlNPTi4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiB0b0pTT04KCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuU3RydWN0CgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICAgICAqLyBTdHJ1Y3QucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIFN0cnVjdAoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGdldFR5cGVVcmwKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuU3RydWN0CgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3R5cGVVcmxQcmVmaXhdIHlvdXIgY3VzdG9tIHR5cGVVcmxQcmVmaXgoZGVmYXVsdCAidHlwZS5nb29nbGVhcGlzLmNvbSIpCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCB0eXBlIHVybAoJICAgICAgICAgICAgICovIFN0cnVjdC5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CgkgICAgICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvZ29vZ2xlLnByb3RvYnVmLlN0cnVjdCI7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIFN0cnVjdDsKCSAgICAgICAgfSgpOwoJICAgICAgICBwcm90b2J1Zi5WYWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBQcm9wZXJ0aWVzIG9mIGEgVmFsdWUuCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmCgkgICAgICAgICAgICAgKiBAaW50ZXJmYWNlIElWYWx1ZQoJICAgICAgICAgICAgICogQHByb3BlcnR5IHtnb29nbGUucHJvdG9idWYuTnVsbFZhbHVlfG51bGx9IFtudWxsVmFsdWVdIFZhbHVlIG51bGxWYWx1ZQoJICAgICAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ8bnVsbH0gW251bWJlclZhbHVlXSBWYWx1ZSBudW1iZXJWYWx1ZQoJICAgICAgICAgICAgICogQHByb3BlcnR5IHtzdHJpbmd8bnVsbH0gW3N0cmluZ1ZhbHVlXSBWYWx1ZSBzdHJpbmdWYWx1ZQoJICAgICAgICAgICAgICogQHByb3BlcnR5IHtib29sZWFufG51bGx9IFtib29sVmFsdWVdIFZhbHVlIGJvb2xWYWx1ZQoJICAgICAgICAgICAgICogQHByb3BlcnR5IHtnb29nbGUucHJvdG9idWYuSVN0cnVjdHxudWxsfSBbc3RydWN0VmFsdWVdIFZhbHVlIHN0cnVjdFZhbHVlCgkgICAgICAgICAgICAgKiBAcHJvcGVydHkge2dvb2dsZS5wcm90b2J1Zi5JTGlzdFZhbHVlfG51bGx9IFtsaXN0VmFsdWVdIFZhbHVlIGxpc3RWYWx1ZQoJICAgICAgICAgICAgICovIC8qKgoJICAgICAgICAgICAgICogQ29uc3RydWN0cyBhIG5ldyBWYWx1ZS4KCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYKCSAgICAgICAgICAgICAqIEBjbGFzc2Rlc2MgUmVwcmVzZW50cyBhIFZhbHVlLgoJICAgICAgICAgICAgICogQGltcGxlbWVudHMgSVZhbHVlCgkgICAgICAgICAgICAgKiBAY29uc3RydWN0b3IKCSAgICAgICAgICAgICAqIEBwYXJhbSB7Z29vZ2xlLnByb3RvYnVmLklWYWx1ZT19IFtwcm9wZXJ0aWVzXSBQcm9wZXJ0aWVzIHRvIHNldAoJICAgICAgICAgICAgICovIGZ1bmN0aW9uIFZhbHVlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllcykgewoJICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKWlmIChwcm9wZXJ0aWVzW2tleXNbaV1dICE9IG51bGwpIHRoaXNba2V5c1tpXV0gPSBwcm9wZXJ0aWVzW2tleXNbaV1dOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogVmFsdWUgbnVsbFZhbHVlLgoJICAgICAgICAgICAgICogQG1lbWJlciB7Z29vZ2xlLnByb3RvYnVmLk51bGxWYWx1ZXxudWxsfHVuZGVmaW5lZH0gbnVsbFZhbHVlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlZhbHVlCgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBWYWx1ZS5wcm90b3R5cGUubnVsbFZhbHVlID0gbnVsbDsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogVmFsdWUgbnVtYmVyVmFsdWUuCgkgICAgICAgICAgICAgKiBAbWVtYmVyIHtudW1iZXJ8bnVsbHx1bmRlZmluZWR9IG51bWJlclZhbHVlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlZhbHVlCgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBWYWx1ZS5wcm90b3R5cGUubnVtYmVyVmFsdWUgPSBudWxsOwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBWYWx1ZSBzdHJpbmdWYWx1ZS4KCSAgICAgICAgICAgICAqIEBtZW1iZXIge3N0cmluZ3xudWxsfHVuZGVmaW5lZH0gc3RyaW5nVmFsdWUKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuVmFsdWUKCSAgICAgICAgICAgICAqIEBpbnN0YW5jZQoJICAgICAgICAgICAgICovIFZhbHVlLnByb3RvdHlwZS5zdHJpbmdWYWx1ZSA9IG51bGw7CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFZhbHVlIGJvb2xWYWx1ZS4KCSAgICAgICAgICAgICAqIEBtZW1iZXIge2Jvb2xlYW58bnVsbHx1bmRlZmluZWR9IGJvb2xWYWx1ZQoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAgICAgKi8gVmFsdWUucHJvdG90eXBlLmJvb2xWYWx1ZSA9IG51bGw7CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFZhbHVlIHN0cnVjdFZhbHVlLgoJICAgICAgICAgICAgICogQG1lbWJlciB7Z29vZ2xlLnByb3RvYnVmLklTdHJ1Y3R8bnVsbHx1bmRlZmluZWR9IHN0cnVjdFZhbHVlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlZhbHVlCgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBWYWx1ZS5wcm90b3R5cGUuc3RydWN0VmFsdWUgPSBudWxsOwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBWYWx1ZSBsaXN0VmFsdWUuCgkgICAgICAgICAgICAgKiBAbWVtYmVyIHtnb29nbGUucHJvdG9idWYuSUxpc3RWYWx1ZXxudWxsfHVuZGVmaW5lZH0gbGlzdFZhbHVlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlZhbHVlCgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBWYWx1ZS5wcm90b3R5cGUubGlzdFZhbHVlID0gbnVsbDsKCSAgICAgICAgICAgIC8vIE9uZU9mIGZpZWxkIG5hbWVzIGJvdW5kIHRvIHZpcnR1YWwgZ2V0dGVycyBhbmQgc2V0dGVycwoJICAgICAgICAgICAgdmFyICRvbmVPZkZpZWxkczsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogVmFsdWUga2luZC4KCSAgICAgICAgICAgICAqIEBtZW1iZXIgeyJudWxsVmFsdWUifCJudW1iZXJWYWx1ZSJ8InN0cmluZ1ZhbHVlInwiYm9vbFZhbHVlInwic3RydWN0VmFsdWUifCJsaXN0VmFsdWUifHVuZGVmaW5lZH0ga2luZAoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAgICAgKi8gT2JqZWN0LmRlZmluZVByb3BlcnR5KFZhbHVlLnByb3RvdHlwZSwgImtpbmQiLCB7CgkgICAgICAgICAgICAgICAgZ2V0OiAkdXRpbC5vbmVPZkdldHRlcigkb25lT2ZGaWVsZHMgPSBbCgkgICAgICAgICAgICAgICAgICAgICJudWxsVmFsdWUiLAoJICAgICAgICAgICAgICAgICAgICAibnVtYmVyVmFsdWUiLAoJICAgICAgICAgICAgICAgICAgICAic3RyaW5nVmFsdWUiLAoJICAgICAgICAgICAgICAgICAgICAiYm9vbFZhbHVlIiwKCSAgICAgICAgICAgICAgICAgICAgInN0cnVjdFZhbHVlIiwKCSAgICAgICAgICAgICAgICAgICAgImxpc3RWYWx1ZSIKCSAgICAgICAgICAgICAgICBdKSwKCSAgICAgICAgICAgICAgICBzZXQ6ICR1dGlsLm9uZU9mU2V0dGVyKCRvbmVPZkZpZWxkcykKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBDcmVhdGVzIGEgbmV3IFZhbHVlIGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuVmFsdWUKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7Z29vZ2xlLnByb3RvYnVmLklWYWx1ZT19IFtwcm9wZXJ0aWVzXSBQcm9wZXJ0aWVzIHRvIHNldAoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5WYWx1ZX0gVmFsdWUgaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBWYWx1ZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocHJvcGVydGllcykgewoJICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVmFsdWUocHJvcGVydGllcyk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgVmFsdWUgbWVzc2FnZS4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgZ29vZ2xlLnByb3RvYnVmLlZhbHVlLnZlcmlmeXx2ZXJpZnl9IG1lc3NhZ2VzLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGVuY29kZQoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtnb29nbGUucHJvdG9idWYuSVZhbHVlfSBtZXNzYWdlIFZhbHVlIG1lc3NhZ2Ugb3IgcGxhaW4gb2JqZWN0IHRvIGVuY29kZQoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuV3JpdGVyfSBbd3JpdGVyXSBXcml0ZXIgdG8gZW5jb2RlIHRvCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7JHByb3RvYnVmLldyaXRlcn0gV3JpdGVyCgkgICAgICAgICAgICAgKi8gVmFsdWUuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgICAgIGlmICghd3JpdGVyKSB3cml0ZXIgPSAkV3JpdGVyLmNyZWF0ZSgpOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLm51bGxWYWx1ZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJudWxsVmFsdWUiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAxLCB3aXJlVHlwZSAwID0qLyA4KS5pbnQzMihtZXNzYWdlLm51bGxWYWx1ZSk7CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubnVtYmVyVmFsdWUgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAibnVtYmVyVmFsdWUiKSkgd3JpdGVyLnVpbnQzMigvKiBpZCAyLCB3aXJlVHlwZSAxID0qLyAxNykuZG91YmxlKG1lc3NhZ2UubnVtYmVyVmFsdWUpOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnN0cmluZ1ZhbHVlICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInN0cmluZ1ZhbHVlIikpIHdyaXRlci51aW50MzIoLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8gMjYpLnN0cmluZyhtZXNzYWdlLnN0cmluZ1ZhbHVlKTsKCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5ib29sVmFsdWUgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAiYm9vbFZhbHVlIikpIHdyaXRlci51aW50MzIoLyogaWQgNCwgd2lyZVR5cGUgMCA9Ki8gMzIpLmJvb2wobWVzc2FnZS5ib29sVmFsdWUpOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnN0cnVjdFZhbHVlICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInN0cnVjdFZhbHVlIikpICRyb290Lmdvb2dsZS5wcm90b2J1Zi5TdHJ1Y3QuZW5jb2RlKG1lc3NhZ2Uuc3RydWN0VmFsdWUsIHdyaXRlci51aW50MzIoLyogaWQgNSwgd2lyZVR5cGUgMiA9Ki8gNDIpLmZvcmsoKSkubGRlbGltKCk7CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGlzdFZhbHVlICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImxpc3RWYWx1ZSIpKSAkcm9vdC5nb29nbGUucHJvdG9idWYuTGlzdFZhbHVlLmVuY29kZShtZXNzYWdlLmxpc3RWYWx1ZSwgd3JpdGVyLnVpbnQzMigvKiBpZCA2LCB3aXJlVHlwZSAyID0qLyA1MCkuZm9yaygpKS5sZGVsaW0oKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gd3JpdGVyOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogRW5jb2RlcyB0aGUgc3BlY2lmaWVkIFZhbHVlIG1lc3NhZ2UsIGxlbmd0aCBkZWxpbWl0ZWQuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZS52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuVmFsdWUKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7Z29vZ2xlLnByb3RvYnVmLklWYWx1ZX0gbWVzc2FnZSBWYWx1ZSBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgICAgICovIFZhbHVlLmVuY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZChtZXNzYWdlLCB3cml0ZXIpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyKS5sZGVsaW0oKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIERlY29kZXMgYSBWYWx1ZSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZQoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5WYWx1ZX0gVmFsdWUKCSAgICAgICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgcGF5bG9hZCBpcyBub3QgYSByZWFkZXIgb3IgdmFsaWQgYnVmZmVyCgkgICAgICAgICAgICAgKiBAdGhyb3dzIHskcHJvdG9idWYudXRpbC5Qcm90b2NvbEVycm9yfSBJZiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcKCSAgICAgICAgICAgICAqLyBWYWx1ZS5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyLCBsZW5ndGgpIHsKCSAgICAgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5nb29nbGUucHJvdG9idWYuVmFsdWUoKTsKCSAgICAgICAgICAgICAgICB3aGlsZShyZWFkZXIucG9zIDwgZW5kKXsKCSAgICAgICAgICAgICAgICAgICAgdmFyIHRhZyA9IHJlYWRlci51aW50MzIoKTsKCSAgICAgICAgICAgICAgICAgICAgc3dpdGNoKHRhZyA+Pj4gMyl7CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm51bGxWYWx1ZSA9IHJlYWRlci5pbnQzMigpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm51bWJlclZhbHVlID0gcmVhZGVyLmRvdWJsZSgpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnN0cmluZ1ZhbHVlID0gcmVhZGVyLnN0cmluZygpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmJvb2xWYWx1ZSA9IHJlYWRlci5ib29sKCk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNToKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Uuc3RydWN0VmFsdWUgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0LmRlY29kZShyZWFkZXIsIHJlYWRlci51aW50MzIoKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubGlzdFZhbHVlID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZS5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRlci5za2lwVHlwZSh0YWcgJiA3KTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIERlY29kZXMgYSBWYWx1ZSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7Z29vZ2xlLnByb3RvYnVmLlZhbHVlfSBWYWx1ZQoJICAgICAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgICAgICovIFZhbHVlLmRlY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZChyZWFkZXIpIHsKCSAgICAgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gbmV3ICRSZWFkZXIocmVhZGVyKTsKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyLCByZWFkZXIudWludDMyKCkpOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogVmVyaWZpZXMgYSBWYWx1ZSBtZXNzYWdlLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIHZlcmlmeQoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgICAgICovIFZhbHVlLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShtZXNzYWdlKSB7CgkgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKSByZXR1cm4gIm9iamVjdCBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7fTsKCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5udWxsVmFsdWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJudWxsVmFsdWUiKSkgewoJICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzLmtpbmQgPSAxOwoJICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobWVzc2FnZS5udWxsVmFsdWUpewoJICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIm51bGxWYWx1ZTogZW51bSB2YWx1ZSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubnVtYmVyVmFsdWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJudW1iZXJWYWx1ZSIpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmtpbmQgPT09IDEpIHJldHVybiAia2luZDogbXVsdGlwbGUgdmFsdWVzIjsKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5raW5kID0gMTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlLm51bWJlclZhbHVlICE9PSAibnVtYmVyIikgcmV0dXJuICJudW1iZXJWYWx1ZTogbnVtYmVyIGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2Uuc3RyaW5nVmFsdWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJzdHJpbmdWYWx1ZSIpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmtpbmQgPT09IDEpIHJldHVybiAia2luZDogbXVsdGlwbGUgdmFsdWVzIjsKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5raW5kID0gMTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnN0cmluZ1ZhbHVlKSkgcmV0dXJuICJzdHJpbmdWYWx1ZTogc3RyaW5nIGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuYm9vbFZhbHVlICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiYm9vbFZhbHVlIikpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMua2luZCA9PT0gMSkgcmV0dXJuICJraW5kOiBtdWx0aXBsZSB2YWx1ZXMiOwoJICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzLmtpbmQgPSAxOwoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG1lc3NhZ2UuYm9vbFZhbHVlICE9PSAiYm9vbGVhbiIpIHJldHVybiAiYm9vbFZhbHVlOiBib29sZWFuIGV4cGVjdGVkIjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2Uuc3RydWN0VmFsdWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJzdHJ1Y3RWYWx1ZSIpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmtpbmQgPT09IDEpIHJldHVybiAia2luZDogbXVsdGlwbGUgdmFsdWVzIjsKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5raW5kID0gMTsKCSAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC52ZXJpZnkobWVzc2FnZS5zdHJ1Y3RWYWx1ZSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiAic3RydWN0VmFsdWUuIiArIGVycm9yOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmxpc3RWYWx1ZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImxpc3RWYWx1ZSIpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmtpbmQgPT09IDEpIHJldHVybiAia2luZDogbXVsdGlwbGUgdmFsdWVzIjsKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5raW5kID0gMTsKCSAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZS52ZXJpZnkobWVzc2FnZS5saXN0VmFsdWUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gImxpc3RWYWx1ZS4iICsgZXJyb3I7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBDcmVhdGVzIGEgVmFsdWUgbWVzc2FnZSBmcm9tIGEgcGxhaW4gb2JqZWN0LiBBbHNvIGNvbnZlcnRzIHZhbHVlcyB0byB0aGVpciByZXNwZWN0aXZlIGludGVybmFsIHR5cGVzLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGZyb21PYmplY3QKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuVmFsdWUKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG9iamVjdCBQbGFpbiBvYmplY3QKCSAgICAgICAgICAgICAqIEByZXR1cm5zIHtnb29nbGUucHJvdG9idWYuVmFsdWV9IFZhbHVlCgkgICAgICAgICAgICAgKi8gVmFsdWUuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqZWN0KSB7CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290Lmdvb2dsZS5wcm90b2J1Zi5WYWx1ZSkgcmV0dXJuIG9iamVjdDsKCSAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyAkcm9vdC5nb29nbGUucHJvdG9idWYuVmFsdWUoKTsKCSAgICAgICAgICAgICAgICBzd2l0Y2gob2JqZWN0Lm51bGxWYWx1ZSl7CgkgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5udWxsVmFsdWUgPT09ICJudW1iZXIiKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5udWxsVmFsdWUgPSBvYmplY3QubnVsbFZhbHVlOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgIGNhc2UgIk5VTExfVkFMVUUiOgoJICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CgkgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLm51bGxWYWx1ZSA9IDA7CgkgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdC5udW1iZXJWYWx1ZSAhPSBudWxsKSBtZXNzYWdlLm51bWJlclZhbHVlID0gTnVtYmVyKG9iamVjdC5udW1iZXJWYWx1ZSk7CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdC5zdHJpbmdWYWx1ZSAhPSBudWxsKSBtZXNzYWdlLnN0cmluZ1ZhbHVlID0gU3RyaW5nKG9iamVjdC5zdHJpbmdWYWx1ZSk7CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdC5ib29sVmFsdWUgIT0gbnVsbCkgbWVzc2FnZS5ib29sVmFsdWUgPSBCb29sZWFuKG9iamVjdC5ib29sVmFsdWUpOwoJICAgICAgICAgICAgICAgIGlmIChvYmplY3Quc3RydWN0VmFsdWUgIT0gbnVsbCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5zdHJ1Y3RWYWx1ZSAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLmdvb2dsZS5wcm90b2J1Zi5WYWx1ZS5zdHJ1Y3RWYWx1ZTogb2JqZWN0IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Uuc3RydWN0VmFsdWUgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuU3RydWN0LmZyb21PYmplY3Qob2JqZWN0LnN0cnVjdFZhbHVlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdC5saXN0VmFsdWUgIT0gbnVsbCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5saXN0VmFsdWUgIT09ICJvYmplY3QiKSB0aHJvdyBUeXBlRXJyb3IoIi5nb29nbGUucHJvdG9idWYuVmFsdWUubGlzdFZhbHVlOiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5saXN0VmFsdWUgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuTGlzdFZhbHVlLmZyb21PYmplY3Qob2JqZWN0Lmxpc3RWYWx1ZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQ3JlYXRlcyBhIHBsYWluIG9iamVjdCBmcm9tIGEgVmFsdWUgbWVzc2FnZS4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gb3RoZXIgdHlwZXMgaWYgc3BlY2lmaWVkLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLlZhbHVlCgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge2dvb2dsZS5wcm90b2J1Zi5WYWx1ZX0gbWVzc2FnZSBWYWx1ZQoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgICAgICovIFZhbHVlLnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewoJICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwoJICAgICAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5udWxsVmFsdWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJudWxsVmFsdWUiKSkgewoJICAgICAgICAgICAgICAgICAgICBvYmplY3QubnVsbFZhbHVlID0gb3B0aW9ucy5lbnVtcyA9PT0gU3RyaW5nID8gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLk51bGxWYWx1ZVttZXNzYWdlLm51bGxWYWx1ZV0gPT09IHVuZGVmaW5lZCA/IG1lc3NhZ2UubnVsbFZhbHVlIDogJHJvb3QuZ29vZ2xlLnByb3RvYnVmLk51bGxWYWx1ZVttZXNzYWdlLm51bGxWYWx1ZV0gOiBtZXNzYWdlLm51bGxWYWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub25lb2ZzKSBvYmplY3Qua2luZCA9ICJudWxsVmFsdWUiOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5udW1iZXJWYWx1ZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm51bWJlclZhbHVlIikpIHsKCSAgICAgICAgICAgICAgICAgICAgb2JqZWN0Lm51bWJlclZhbHVlID0gb3B0aW9ucy5qc29uICYmICFpc0Zpbml0ZShtZXNzYWdlLm51bWJlclZhbHVlKSA/IFN0cmluZyhtZXNzYWdlLm51bWJlclZhbHVlKSA6IG1lc3NhZ2UubnVtYmVyVmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm9uZW9mcykgb2JqZWN0LmtpbmQgPSAibnVtYmVyVmFsdWUiOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5zdHJpbmdWYWx1ZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInN0cmluZ1ZhbHVlIikpIHsKCSAgICAgICAgICAgICAgICAgICAgb2JqZWN0LnN0cmluZ1ZhbHVlID0gbWVzc2FnZS5zdHJpbmdWYWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub25lb2ZzKSBvYmplY3Qua2luZCA9ICJzdHJpbmdWYWx1ZSI7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmJvb2xWYWx1ZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImJvb2xWYWx1ZSIpKSB7CgkgICAgICAgICAgICAgICAgICAgIG9iamVjdC5ib29sVmFsdWUgPSBtZXNzYWdlLmJvb2xWYWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub25lb2ZzKSBvYmplY3Qua2luZCA9ICJib29sVmFsdWUiOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5zdHJ1Y3RWYWx1ZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInN0cnVjdFZhbHVlIikpIHsKCSAgICAgICAgICAgICAgICAgICAgb2JqZWN0LnN0cnVjdFZhbHVlID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlN0cnVjdC50b09iamVjdChtZXNzYWdlLnN0cnVjdFZhbHVlLCBvcHRpb25zKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub25lb2ZzKSBvYmplY3Qua2luZCA9ICJzdHJ1Y3RWYWx1ZSI7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmxpc3RWYWx1ZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImxpc3RWYWx1ZSIpKSB7CgkgICAgICAgICAgICAgICAgICAgIG9iamVjdC5saXN0VmFsdWUgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuTGlzdFZhbHVlLnRvT2JqZWN0KG1lc3NhZ2UubGlzdFZhbHVlLCBvcHRpb25zKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub25lb2ZzKSBvYmplY3Qua2luZCA9ICJsaXN0VmFsdWUiOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQ29udmVydHMgdGhpcyBWYWx1ZSB0byBKU09OLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIHRvSlNPTgoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQGluc3RhbmNlCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IEpTT04gb2JqZWN0CgkgICAgICAgICAgICAgKi8gVmFsdWUucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIFZhbHVlCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gZ2V0VHlwZVVybAoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5WYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlVXJsUHJlZml4XSB5b3VyIGN1c3RvbSB0eXBlVXJsUHJlZml4KGRlZmF1bHQgInR5cGUuZ29vZ2xlYXBpcy5jb20iKQoJICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRlZmF1bHQgdHlwZSB1cmwKCSAgICAgICAgICAgICAqLyBWYWx1ZS5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CgkgICAgICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvZ29vZ2xlLnByb3RvYnVmLlZhbHVlIjsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICByZXR1cm4gVmFsdWU7CgkgICAgICAgIH0oKTsKCSAgICAgICAgLyoqCgkgICAgICAgICAqIE51bGxWYWx1ZSBlbnVtLgoJICAgICAgICAgKiBAbmFtZSBnb29nbGUucHJvdG9idWYuTnVsbFZhbHVlCgkgICAgICAgICAqIEBlbnVtIHtudW1iZXJ9CgkgICAgICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBOVUxMX1ZBTFVFPTAgTlVMTF9WQUxVRSB2YWx1ZQoJICAgICAgICAgKi8gcHJvdG9idWYuTnVsbFZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWVzQnlJZCA9IHt9LCB2YWx1ZXMgPSBPYmplY3QuY3JlYXRlKHZhbHVlc0J5SWQpOwoJICAgICAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMF0gPSAiTlVMTF9WQUxVRSJdID0gMDsKCSAgICAgICAgICAgIHJldHVybiB2YWx1ZXM7CgkgICAgICAgIH0oKTsKCSAgICAgICAgcHJvdG9idWYuTGlzdFZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFByb3BlcnRpZXMgb2YgYSBMaXN0VmFsdWUuCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmCgkgICAgICAgICAgICAgKiBAaW50ZXJmYWNlIElMaXN0VmFsdWUKCSAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPGdvb2dsZS5wcm90b2J1Zi5JVmFsdWU+fG51bGx9IFt2YWx1ZXNdIExpc3RWYWx1ZSB2YWx1ZXMKCSAgICAgICAgICAgICAqLyAvKioKCSAgICAgICAgICAgICAqIENvbnN0cnVjdHMgYSBuZXcgTGlzdFZhbHVlLgoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1ZgoJICAgICAgICAgICAgICogQGNsYXNzZGVzYyBSZXByZXNlbnRzIGEgTGlzdFZhbHVlLgoJICAgICAgICAgICAgICogQGltcGxlbWVudHMgSUxpc3RWYWx1ZQoJICAgICAgICAgICAgICogQGNvbnN0cnVjdG9yCgkgICAgICAgICAgICAgKiBAcGFyYW0ge2dvb2dsZS5wcm90b2J1Zi5JTGlzdFZhbHVlPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAgICAgKi8gZnVuY3Rpb24gTGlzdFZhbHVlKHByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgICAgICB0aGlzLnZhbHVlcyA9IFtdOwoJICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICAgICAgICAgIGZvcih2YXIga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpaWYgKHByb3BlcnRpZXNba2V5c1tpXV0gIT0gbnVsbCkgdGhpc1trZXlzW2ldXSA9IHByb3BlcnRpZXNba2V5c1tpXV07CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBMaXN0VmFsdWUgdmFsdWVzLgoJICAgICAgICAgICAgICogQG1lbWJlciB7QXJyYXkuPGdvb2dsZS5wcm90b2J1Zi5JVmFsdWU+fSB2YWx1ZXMKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlCgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqLyBMaXN0VmFsdWUucHJvdG90eXBlLnZhbHVlcyA9ICR1dGlsLmVtcHR5QXJyYXk7CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgTGlzdFZhbHVlIGluc3RhbmNlIHVzaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBjcmVhdGUKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlCgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge2dvb2dsZS5wcm90b2J1Zi5JTGlzdFZhbHVlPX0gW3Byb3BlcnRpZXNdIFByb3BlcnRpZXMgdG8gc2V0CgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7Z29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZX0gTGlzdFZhbHVlIGluc3RhbmNlCgkgICAgICAgICAgICAgKi8gTGlzdFZhbHVlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShwcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBMaXN0VmFsdWUocHJvcGVydGllcyk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBFbmNvZGVzIHRoZSBzcGVjaWZpZWQgTGlzdFZhbHVlIG1lc3NhZ2UuIERvZXMgbm90IGltcGxpY2l0bHkge0BsaW5rIGdvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWUudmVyaWZ5fHZlcmlmeX0gbWVzc2FnZXMuCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gZW5jb2RlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtnb29nbGUucHJvdG9idWYuSUxpc3RWYWx1ZX0gbWVzc2FnZSBMaXN0VmFsdWUgbWVzc2FnZSBvciBwbGFpbiBvYmplY3QgdG8gZW5jb2RlCgkgICAgICAgICAgICAgKiBAcGFyYW0geyRwcm90b2J1Zi5Xcml0ZXJ9IFt3cml0ZXJdIFdyaXRlciB0byBlbmNvZGUgdG8KCSAgICAgICAgICAgICAqIEByZXR1cm5zIHskcHJvdG9idWYuV3JpdGVyfSBXcml0ZXIKCSAgICAgICAgICAgICAqLyBMaXN0VmFsdWUuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikgewoJICAgICAgICAgICAgICAgIGlmICghd3JpdGVyKSB3cml0ZXIgPSAkV3JpdGVyLmNyZWF0ZSgpOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnZhbHVlcyAhPSBudWxsICYmIG1lc3NhZ2UudmFsdWVzLmxlbmd0aCkgZm9yKHZhciBpID0gMDsgaSA8IG1lc3NhZ2UudmFsdWVzLmxlbmd0aDsgKytpKSRyb290Lmdvb2dsZS5wcm90b2J1Zi5WYWx1ZS5lbmNvZGUobWVzc2FnZS52YWx1ZXNbaV0sIHdyaXRlci51aW50MzIoLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8gMTApLmZvcmsoKSkubGRlbGltKCk7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHdyaXRlcjsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIEVuY29kZXMgdGhlIHNwZWNpZmllZCBMaXN0VmFsdWUgbWVzc2FnZSwgbGVuZ3RoIGRlbGltaXRlZC4gRG9lcyBub3QgaW1wbGljaXRseSB7QGxpbmsgZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZS52ZXJpZnl8dmVyaWZ5fSBtZXNzYWdlcy4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlCgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge2dvb2dsZS5wcm90b2J1Zi5JTGlzdFZhbHVlfSBtZXNzYWdlIExpc3RWYWx1ZSBtZXNzYWdlIG9yIHBsYWluIG9iamVjdCB0byBlbmNvZGUKCSAgICAgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLldyaXRlcn0gW3dyaXRlcl0gV3JpdGVyIHRvIGVuY29kZSB0bwoJICAgICAgICAgICAgICogQHJldHVybnMgeyRwcm90b2J1Zi5Xcml0ZXJ9IFdyaXRlcgoJICAgICAgICAgICAgICovIExpc3RWYWx1ZS5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcikubGRlbGltKCk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBEZWNvZGVzIGEgTGlzdFZhbHVlIG1lc3NhZ2UgZnJvbSB0aGUgc3BlY2lmaWVkIHJlYWRlciBvciBidWZmZXIuCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gZGVjb2RlCgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuUmVhZGVyfFVpbnQ4QXJyYXl9IHJlYWRlciBSZWFkZXIgb3IgYnVmZmVyIHRvIGRlY29kZSBmcm9tCgkgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aF0gTWVzc2FnZSBsZW5ndGggaWYga25vd24gYmVmb3JlaGFuZAoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWV9IExpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgICAgICovIExpc3RWYWx1ZS5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyLCBsZW5ndGgpIHsKCSAgICAgICAgICAgICAgICBpZiAoIShyZWFkZXIgaW5zdGFuY2VvZiAkUmVhZGVyKSkgcmVhZGVyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyKTsKCSAgICAgICAgICAgICAgICB2YXIgZW5kID0gbGVuZ3RoID09PSB1bmRlZmluZWQgPyByZWFkZXIubGVuIDogcmVhZGVyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5nb29nbGUucHJvdG9idWYuTGlzdFZhbHVlKCk7CgkgICAgICAgICAgICAgICAgd2hpbGUocmVhZGVyLnBvcyA8IGVuZCl7CgkgICAgICAgICAgICAgICAgICAgIHZhciB0YWcgPSByZWFkZXIudWludDMyKCk7CgkgICAgICAgICAgICAgICAgICAgIHN3aXRjaCh0YWcgPj4+IDMpewoJICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS52YWx1ZXMgJiYgbWVzc2FnZS52YWx1ZXMubGVuZ3RoKSkgbWVzc2FnZS52YWx1ZXMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS52YWx1ZXMucHVzaCgkcm9vdC5nb29nbGUucHJvdG9idWYuVmFsdWUuZGVjb2RlKHJlYWRlciwgcmVhZGVyLnVpbnQzMigpKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZGVyLnNraXBUeXBlKHRhZyAmIDcpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogRGVjb2RlcyBhIExpc3RWYWx1ZSBtZXNzYWdlIGZyb20gdGhlIHNwZWNpZmllZCByZWFkZXIgb3IgYnVmZmVyLCBsZW5ndGggZGVsaW1pdGVkLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZAoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWUKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7JHByb3RvYnVmLlJlYWRlcnxVaW50OEFycmF5fSByZWFkZXIgUmVhZGVyIG9yIGJ1ZmZlciB0byBkZWNvZGUgZnJvbQoJICAgICAgICAgICAgICogQHJldHVybnMge2dvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWV9IExpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYXlsb2FkIGlzIG5vdCBhIHJlYWRlciBvciB2YWxpZCBidWZmZXIKCSAgICAgICAgICAgICAqIEB0aHJvd3MgeyRwcm90b2J1Zi51dGlsLlByb3RvY29sRXJyb3J9IElmIHJlcXVpcmVkIGZpZWxkcyBhcmUgbWlzc2luZwoJICAgICAgICAgICAgICovIExpc3RWYWx1ZS5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyKSB7CgkgICAgICAgICAgICAgICAgaWYgKCEocmVhZGVyIGluc3RhbmNlb2YgJFJlYWRlcikpIHJlYWRlciA9IG5ldyAkUmVhZGVyKHJlYWRlcik7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlciwgcmVhZGVyLnVpbnQzMigpKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIFZlcmlmaWVzIGEgTGlzdFZhbHVlIG1lc3NhZ2UuCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gdmVyaWZ5CgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywqPn0gbWVzc2FnZSBQbGFpbiBvYmplY3QgdG8gdmVyaWZ5CgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9IGBudWxsYCBpZiB2YWxpZCwgb3RoZXJ3aXNlIHRoZSByZWFzb24gd2h5IGl0IGlzIG5vdAoJICAgICAgICAgICAgICovIExpc3RWYWx1ZS52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwoJICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnZhbHVlcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInZhbHVlcyIpKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLnZhbHVlcykpIHJldHVybiAidmFsdWVzOiBhcnJheSBleHBlY3RlZCI7CgkgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBtZXNzYWdlLnZhbHVlcy5sZW5ndGg7ICsraSl7CgkgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSAkcm9vdC5nb29nbGUucHJvdG9idWYuVmFsdWUudmVyaWZ5KG1lc3NhZ2UudmFsdWVzW2ldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuICJ2YWx1ZXMuIiArIGVycm9yOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQ3JlYXRlcyBhIExpc3RWYWx1ZSBtZXNzYWdlIGZyb20gYSBwbGFpbiBvYmplY3QuIEFsc28gY29udmVydHMgdmFsdWVzIHRvIHRoZWlyIHJlc3BlY3RpdmUgaW50ZXJuYWwgdHlwZXMuCgkgICAgICAgICAgICAgKiBAZnVuY3Rpb24gZnJvbU9iamVjdAoJICAgICAgICAgICAgICogQG1lbWJlcm9mIGdvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWUKCSAgICAgICAgICAgICAqIEBzdGF0aWMKCSAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsKj59IG9iamVjdCBQbGFpbiBvYmplY3QKCSAgICAgICAgICAgICAqIEByZXR1cm5zIHtnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlfSBMaXN0VmFsdWUKCSAgICAgICAgICAgICAqLyBMaXN0VmFsdWUuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqZWN0KSB7CgkgICAgICAgICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290Lmdvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWUpIHJldHVybiBvYmplY3Q7CgkgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgJHJvb3QuZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZSgpOwoJICAgICAgICAgICAgICAgIGlmIChvYmplY3QudmFsdWVzKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QudmFsdWVzKSkgdGhyb3cgVHlwZUVycm9yKCIuZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZS52YWx1ZXM6IGFycmF5IGV4cGVjdGVkIik7CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudmFsdWVzID0gW107CgkgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBvYmplY3QudmFsdWVzLmxlbmd0aDsgKytpKXsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnZhbHVlc1tpXSAhPT0gIm9iamVjdCIpIHRocm93IFR5cGVFcnJvcigiLmdvb2dsZS5wcm90b2J1Zi5MaXN0VmFsdWUudmFsdWVzOiBvYmplY3QgZXhwZWN0ZWQiKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudmFsdWVzW2ldID0gJHJvb3QuZ29vZ2xlLnByb3RvYnVmLlZhbHVlLmZyb21PYmplY3Qob2JqZWN0LnZhbHVlc1tpXSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBDcmVhdGVzIGEgcGxhaW4gb2JqZWN0IGZyb20gYSBMaXN0VmFsdWUgbWVzc2FnZS4gQWxzbyBjb252ZXJ0cyB2YWx1ZXMgdG8gb3RoZXIgdHlwZXMgaWYgc3BlY2lmaWVkLgoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIHRvT2JqZWN0CgkgICAgICAgICAgICAgKiBAbWVtYmVyb2YgZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHN0YXRpYwoJICAgICAgICAgICAgICogQHBhcmFtIHtnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlfSBtZXNzYWdlIExpc3RWYWx1ZQoJICAgICAgICAgICAgICogQHBhcmFtIHskcHJvdG9idWYuSUNvbnZlcnNpb25PcHRpb25zfSBbb3B0aW9uc10gQ29udmVyc2lvbiBvcHRpb25zCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsKj59IFBsYWluIG9iamVjdAoJICAgICAgICAgICAgICovIExpc3RWYWx1ZS50b09iamVjdCA9IGZ1bmN0aW9uIHRvT2JqZWN0KG1lc3NhZ2UsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CgkgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXJyYXlzIHx8IG9wdGlvbnMuZGVmYXVsdHMpIG9iamVjdC52YWx1ZXMgPSBbXTsKCSAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS52YWx1ZXMgJiYgbWVzc2FnZS52YWx1ZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgIG9iamVjdC52YWx1ZXMgPSBbXTsKCSAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IG1lc3NhZ2UudmFsdWVzLmxlbmd0aDsgKytqKW9iamVjdC52YWx1ZXNbal0gPSAkcm9vdC5nb29nbGUucHJvdG9idWYuVmFsdWUudG9PYmplY3QobWVzc2FnZS52YWx1ZXNbal0sIG9wdGlvbnMpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQ29udmVydHMgdGhpcyBMaXN0VmFsdWUgdG8gSlNPTi4KCSAgICAgICAgICAgICAqIEBmdW5jdGlvbiB0b0pTT04KCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlCgkgICAgICAgICAgICAgKiBAaW5zdGFuY2UKCSAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywqPn0gSlNPTiBvYmplY3QKCSAgICAgICAgICAgICAqLyBMaXN0VmFsdWUucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCAkcHJvdG9idWYudXRpbC50b0pTT05PcHRpb25zKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICAvKioKCSAgICAgICAgICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdHlwZSB1cmwgZm9yIExpc3RWYWx1ZQoJICAgICAgICAgICAgICogQGZ1bmN0aW9uIGdldFR5cGVVcmwKCSAgICAgICAgICAgICAqIEBtZW1iZXJvZiBnb29nbGUucHJvdG9idWYuTGlzdFZhbHVlCgkgICAgICAgICAgICAgKiBAc3RhdGljCgkgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3R5cGVVcmxQcmVmaXhdIHlvdXIgY3VzdG9tIHR5cGVVcmxQcmVmaXgoZGVmYXVsdCAidHlwZS5nb29nbGVhcGlzLmNvbSIpCgkgICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGVmYXVsdCB0eXBlIHVybAoJICAgICAgICAgICAgICovIExpc3RWYWx1ZS5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CgkgICAgICAgICAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvZ29vZ2xlLnByb3RvYnVmLkxpc3RWYWx1ZSI7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIExpc3RWYWx1ZTsKCSAgICAgICAgfSgpOwoJICAgICAgICByZXR1cm4gcHJvdG9idWY7CgkgICAgfSgpOwoJICAgIHJldHVybiBnb29nbGU7Cgl9KCk7Cgl2YXIgcHJvdG9jb2wgPSAkcm9vdDsKCgkvLyBERUZMQVRFIGlzIGEgY29tcGxleCBmb3JtYXQ7IHRvIHJlYWQgdGhpcyBjb2RlLCB5b3Ugc2hvdWxkIHByb2JhYmx5IGNoZWNrIHRoZSBSRkMgZmlyc3Q6CgoJLy8gYWxpYXNlcyBmb3Igc2hvcnRlciBjb21wcmVzc2VkIGNvZGUgKG1vc3QgbWluaWZlcnMgZG9uJ3QgZG8gdGhpcykKCXZhciB1OCA9IFVpbnQ4QXJyYXksIHUxNiA9IFVpbnQxNkFycmF5LCB1MzIgPSBVaW50MzJBcnJheTsKCS8vIGZpeGVkIGxlbmd0aCBleHRyYSBiaXRzCgl2YXIgZmxlYiA9IG5ldyB1OChbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMSwgMSwgMSwgMSwgMiwgMiwgMiwgMiwgMywgMywgMywgMywgNCwgNCwgNCwgNCwgNSwgNSwgNSwgNSwgMCwgLyogdW51c2VkICovIDAsIDAsIC8qIGltcG9zc2libGUgKi8gMF0pOwoJLy8gZml4ZWQgZGlzdGFuY2UgZXh0cmEgYml0cwoJLy8gc2VlIGZsZWIgbm90ZQoJdmFyIGZkZWIgPSBuZXcgdTgoWzAsIDAsIDAsIDAsIDEsIDEsIDIsIDIsIDMsIDMsIDQsIDQsIDUsIDUsIDYsIDYsIDcsIDcsIDgsIDgsIDksIDksIDEwLCAxMCwgMTEsIDExLCAxMiwgMTIsIDEzLCAxMywgLyogdW51c2VkICovIDAsIDBdKTsKCS8vIGNvZGUgbGVuZ3RoIGluZGV4IG1hcAoJdmFyIGNsaW0gPSBuZXcgdTgoWzE2LCAxNywgMTgsIDAsIDgsIDcsIDksIDYsIDEwLCA1LCAxMSwgNCwgMTIsIDMsIDEzLCAyLCAxNCwgMSwgMTVdKTsKCS8vIGdldCBiYXNlLCByZXZlcnNlIGluZGV4IG1hcCBmcm9tIGV4dHJhIGJpdHMKCXZhciBmcmViID0gZnVuY3Rpb24gKGViLCBzdGFydCkgewoJICAgIHZhciBiID0gbmV3IHUxNigzMSk7CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzMTsgKytpKSB7CgkgICAgICAgIGJbaV0gPSBzdGFydCArPSAxIDw8IGViW2kgLSAxXTsKCSAgICB9CgkgICAgLy8gbnVtYmVycyBoZXJlIGFyZSBhdCBtYXggMTggYml0cwoJICAgIHZhciByID0gbmV3IHUzMihiWzMwXSk7CgkgICAgZm9yICh2YXIgaSA9IDE7IGkgPCAzMDsgKytpKSB7CgkgICAgICAgIGZvciAodmFyIGogPSBiW2ldOyBqIDwgYltpICsgMV07ICsraikgewoJICAgICAgICAgICAgcltqXSA9ICgoaiAtIGJbaV0pIDw8IDUpIHwgaTsKCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gW2IsIHJdOwoJfTsKCXZhciBfYSA9IGZyZWIoZmxlYiwgMiksIGZsID0gX2FbMF0sIHJldmZsID0gX2FbMV07CgkvLyB3ZSBjYW4gaWdub3JlIHRoZSBmYWN0IHRoYXQgdGhlIG90aGVyIG51bWJlcnMgYXJlIHdyb25nOyB0aGV5IG5ldmVyIGhhcHBlbiBhbnl3YXkKCWZsWzI4XSA9IDI1OCwgcmV2ZmxbMjU4XSA9IDI4OwoJdmFyIF9iID0gZnJlYihmZGViLCAwKSwgZmQgPSBfYlswXTsKCS8vIG1hcCBvZiB2YWx1ZSB0byByZXZlcnNlIChhc3N1bWluZyAxNiBiaXRzKQoJdmFyIHJldiA9IG5ldyB1MTYoMzI3NjgpOwoJZm9yICh2YXIgaSA9IDA7IGkgPCAzMjc2ODsgKytpKSB7CgkgICAgLy8gcmV2ZXJzZSB0YWJsZSBhbGdvcml0aG0gZnJvbSBTTwoJICAgIHZhciB4ID0gKChpICYgMHhBQUFBKSA+Pj4gMSkgfCAoKGkgJiAweDU1NTUpIDw8IDEpOwoJICAgIHggPSAoKHggJiAweENDQ0MpID4+PiAyKSB8ICgoeCAmIDB4MzMzMykgPDwgMik7CgkgICAgeCA9ICgoeCAmIDB4RjBGMCkgPj4+IDQpIHwgKCh4ICYgMHgwRjBGKSA8PCA0KTsKCSAgICByZXZbaV0gPSAoKCh4ICYgMHhGRjAwKSA+Pj4gOCkgfCAoKHggJiAweDAwRkYpIDw8IDgpKSA+Pj4gMTsKCX0KCS8vIGNyZWF0ZSBodWZmbWFuIHRyZWUgZnJvbSB1OCAibWFwIjogaW5kZXggLT4gY29kZSBsZW5ndGggZm9yIGNvZGUgaW5kZXgKCS8vIG1iIChtYXggYml0cykgbXVzdCBiZSBhdCBtb3N0IDE1CgkvLyBUT0RPOiBvcHRpbWl6ZS9zcGxpdCB1cD8KCXZhciBoTWFwID0gKGZ1bmN0aW9uIChjZCwgbWIsIHIpIHsKCSAgICB2YXIgcyA9IGNkLmxlbmd0aDsKCSAgICAvLyBpbmRleAoJICAgIHZhciBpID0gMDsKCSAgICAvLyB1MTYgIm1hcCI6IGluZGV4IC0+ICMgb2YgY29kZXMgd2l0aCBiaXQgbGVuZ3RoID0gaW5kZXgKCSAgICB2YXIgbCA9IG5ldyB1MTYobWIpOwoJICAgIC8vIGxlbmd0aCBvZiBjZCBtdXN0IGJlIDI4OCAodG90YWwgIyBvZiBjb2RlcykKCSAgICBmb3IgKDsgaSA8IHM7ICsraSkgewoJICAgICAgICBpZiAoY2RbaV0pCgkgICAgICAgICAgICArK2xbY2RbaV0gLSAxXTsKCSAgICB9CgkgICAgLy8gdTE2ICJtYXAiOiBpbmRleCAtPiBtaW5pbXVtIGNvZGUgZm9yIGJpdCBsZW5ndGggPSBpbmRleAoJICAgIHZhciBsZSA9IG5ldyB1MTYobWIpOwoJICAgIGZvciAoaSA9IDA7IGkgPCBtYjsgKytpKSB7CgkgICAgICAgIGxlW2ldID0gKGxlW2kgLSAxXSArIGxbaSAtIDFdKSA8PCAxOwoJICAgIH0KCSAgICB2YXIgY287CgkgICAgaWYgKHIpIHsKCSAgICAgICAgLy8gdTE2ICJtYXAiOiBpbmRleCAtPiBudW1iZXIgb2YgYWN0dWFsIGJpdHMsIHN5bWJvbCBmb3IgY29kZQoJICAgICAgICBjbyA9IG5ldyB1MTYoMSA8PCBtYik7CgkgICAgICAgIC8vIGJpdHMgdG8gcmVtb3ZlIGZvciByZXZlcnNlcgoJICAgICAgICB2YXIgcnZiID0gMTUgLSBtYjsKCSAgICAgICAgZm9yIChpID0gMDsgaSA8IHM7ICsraSkgewoJICAgICAgICAgICAgLy8gaWdub3JlIDAgbGVuZ3RocwoJICAgICAgICAgICAgaWYgKGNkW2ldKSB7CgkgICAgICAgICAgICAgICAgLy8gbnVtIGVuY29kaW5nIGJvdGggc3ltYm9sIGFuZCBiaXRzIHJlYWQKCSAgICAgICAgICAgICAgICB2YXIgc3YgPSAoaSA8PCA0KSB8IGNkW2ldOwoJICAgICAgICAgICAgICAgIC8vIGZyZWUgYml0cwoJICAgICAgICAgICAgICAgIHZhciByXzEgPSBtYiAtIGNkW2ldOwoJICAgICAgICAgICAgICAgIC8vIHN0YXJ0IHZhbHVlCgkgICAgICAgICAgICAgICAgdmFyIHYgPSBsZVtjZFtpXSAtIDFdKysgPDwgcl8xOwoJICAgICAgICAgICAgICAgIC8vIG0gaXMgZW5kIHZhbHVlCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgbSA9IHYgfCAoKDEgPDwgcl8xKSAtIDEpOyB2IDw9IG07ICsrdikgewoJICAgICAgICAgICAgICAgICAgICAvLyBldmVyeSAxNiBiaXQgdmFsdWUgc3RhcnRpbmcgd2l0aCB0aGUgY29kZSB5aWVsZHMgdGhlIHNhbWUgcmVzdWx0CgkgICAgICAgICAgICAgICAgICAgIGNvW3Jldlt2XSA+Pj4gcnZiXSA9IHN2OwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0KCSAgICBlbHNlIHsKCSAgICAgICAgY28gPSBuZXcgdTE2KHMpOwoJICAgICAgICBmb3IgKGkgPSAwOyBpIDwgczsgKytpKSB7CgkgICAgICAgICAgICBpZiAoY2RbaV0pIHsKCSAgICAgICAgICAgICAgICBjb1tpXSA9IHJldltsZVtjZFtpXSAtIDFdKytdID4+PiAoMTUgLSBjZFtpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIGNvOwoJfSk7CgkvLyBmaXhlZCBsZW5ndGggdHJlZQoJdmFyIGZsdCA9IG5ldyB1OCgyODgpOwoJZm9yICh2YXIgaSA9IDA7IGkgPCAxNDQ7ICsraSkKCSAgICBmbHRbaV0gPSA4OwoJZm9yICh2YXIgaSA9IDE0NDsgaSA8IDI1NjsgKytpKQoJICAgIGZsdFtpXSA9IDk7Cglmb3IgKHZhciBpID0gMjU2OyBpIDwgMjgwOyArK2kpCgkgICAgZmx0W2ldID0gNzsKCWZvciAodmFyIGkgPSAyODA7IGkgPCAyODg7ICsraSkKCSAgICBmbHRbaV0gPSA4OwoJLy8gZml4ZWQgZGlzdGFuY2UgdHJlZQoJdmFyIGZkdCA9IG5ldyB1OCgzMik7Cglmb3IgKHZhciBpID0gMDsgaSA8IDMyOyArK2kpCgkgICAgZmR0W2ldID0gNTsKCS8vIGZpeGVkIGxlbmd0aCBtYXAKCXZhciBmbHJtID0gLyojX19QVVJFX18qLyBoTWFwKGZsdCwgOSwgMSk7CgkvLyBmaXhlZCBkaXN0YW5jZSBtYXAKCXZhciBmZHJtID0gLyojX19QVVJFX18qLyBoTWFwKGZkdCwgNSwgMSk7CgkvLyBmaW5kIG1heCBvZiBhcnJheQoJdmFyIG1heCA9IGZ1bmN0aW9uIChhKSB7CgkgICAgdmFyIG0gPSBhWzBdOwoJICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYS5sZW5ndGg7ICsraSkgewoJICAgICAgICBpZiAoYVtpXSA+IG0pCgkgICAgICAgICAgICBtID0gYVtpXTsKCSAgICB9CgkgICAgcmV0dXJuIG07Cgl9OwoJLy8gcmVhZCBkLCBzdGFydGluZyBhdCBiaXQgcCBhbmQgbWFzayB3aXRoIG0KCXZhciBiaXRzID0gZnVuY3Rpb24gKGQsIHAsIG0pIHsKCSAgICB2YXIgbyA9IChwIC8gOCkgfCAwOwoJICAgIHJldHVybiAoKGRbb10gfCAoZFtvICsgMV0gPDwgOCkpID4+IChwICYgNykpICYgbTsKCX07CgkvLyByZWFkIGQsIHN0YXJ0aW5nIGF0IGJpdCBwIGNvbnRpbnVpbmcgZm9yIGF0IGxlYXN0IDE2IGJpdHMKCXZhciBiaXRzMTYgPSBmdW5jdGlvbiAoZCwgcCkgewoJICAgIHZhciBvID0gKHAgLyA4KSB8IDA7CgkgICAgcmV0dXJuICgoZFtvXSB8IChkW28gKyAxXSA8PCA4KSB8IChkW28gKyAyXSA8PCAxNikpID4+IChwICYgNykpOwoJfTsKCS8vIGdldCBlbmQgb2YgYnl0ZQoJdmFyIHNoZnQgPSBmdW5jdGlvbiAocCkgeyByZXR1cm4gKChwICsgNykgLyA4KSB8IDA7IH07CgkvLyB0eXBlZCBhcnJheSBzbGljZSAtIGFsbG93cyBnYXJiYWdlIGNvbGxlY3RvciB0byBmcmVlIG9yaWdpbmFsIHJlZmVyZW5jZSwKCS8vIHdoaWxlIGJlaW5nIG1vcmUgY29tcGF0aWJsZSB0aGFuIC5zbGljZQoJdmFyIHNsYyA9IGZ1bmN0aW9uICh2LCBzLCBlKSB7CgkgICAgaWYgKHMgPT0gbnVsbCB8fCBzIDwgMCkKCSAgICAgICAgcyA9IDA7CgkgICAgaWYgKGUgPT0gbnVsbCB8fCBlID4gdi5sZW5ndGgpCgkgICAgICAgIGUgPSB2Lmxlbmd0aDsKCSAgICAvLyBjYW4ndCB1c2UgLmNvbnN0cnVjdG9yIGluIGNhc2UgdXNlci1zdXBwbGllZAoJICAgIHZhciBuID0gbmV3ICh2LkJZVEVTX1BFUl9FTEVNRU5UID09IDIgPyB1MTYgOiB2LkJZVEVTX1BFUl9FTEVNRU5UID09IDQgPyB1MzIgOiB1OCkoZSAtIHMpOwoJICAgIG4uc2V0KHYuc3ViYXJyYXkocywgZSkpOwoJICAgIHJldHVybiBuOwoJfTsKCS8vIGVycm9yIGNvZGVzCgl2YXIgZWMgPSBbCgkgICAgJ3VuZXhwZWN0ZWQgRU9GJywKCSAgICAnaW52YWxpZCBibG9jayB0eXBlJywKCSAgICAnaW52YWxpZCBsZW5ndGgvbGl0ZXJhbCcsCgkgICAgJ2ludmFsaWQgZGlzdGFuY2UnLAoJICAgICdzdHJlYW0gZmluaXNoZWQnLAoJICAgICdubyBzdHJlYW0gaGFuZGxlcicsCgkgICAgLAoJICAgICdubyBjYWxsYmFjaycsCgkgICAgJ2ludmFsaWQgVVRGLTggZGF0YScsCgkgICAgJ2V4dHJhIGZpZWxkIHRvbyBsb25nJywKCSAgICAnZGF0ZSBub3QgaW4gcmFuZ2UgMTk4MC0yMDk5JywKCSAgICAnZmlsZW5hbWUgdG9vIGxvbmcnLAoJICAgICdzdHJlYW0gZmluaXNoaW5nJywKCSAgICAnaW52YWxpZCB6aXAgZGF0YScKCSAgICAvLyBkZXRlcm1pbmVkIGJ5IHVua25vd24gY29tcHJlc3Npb24gbWV0aG9kCgldOwoJdmFyIGVyciA9IGZ1bmN0aW9uIChpbmQsIG1zZywgbnQpIHsKCSAgICB2YXIgZSA9IG5ldyBFcnJvcihtc2cgfHwgZWNbaW5kXSk7CgkgICAgZS5jb2RlID0gaW5kOwoJICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkKCSAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UoZSwgZXJyKTsKCSAgICBpZiAoIW50KQoJICAgICAgICB0aHJvdyBlOwoJICAgIHJldHVybiBlOwoJfTsKCS8vIGV4cGFuZHMgcmF3IERFRkxBVEUgZGF0YQoJdmFyIGluZmx0ID0gZnVuY3Rpb24gKGRhdCwgYnVmLCBzdCkgewoJICAgIC8vIHNvdXJjZSBsZW5ndGgKCSAgICB2YXIgc2wgPSBkYXQubGVuZ3RoOwoJICAgIGlmICghc2wgfHwgKHN0ICYmIHN0LmYgJiYgIXN0LmwpKQoJICAgICAgICByZXR1cm4gYnVmIHx8IG5ldyB1OCgwKTsKCSAgICAvLyBoYXZlIHRvIGVzdGltYXRlIHNpemUKCSAgICB2YXIgbm9CdWYgPSAhYnVmIHx8IHN0OwoJICAgIC8vIG5vIHN0YXRlCgkgICAgdmFyIG5vU3QgPSAhc3QgfHwgc3QuaTsKCSAgICBpZiAoIXN0KQoJICAgICAgICBzdCA9IHt9OwoJICAgIC8vIEFzc3VtZXMgcm91Z2hseSAzMyUgY29tcHJlc3Npb24gcmF0aW8gYXZlcmFnZQoJICAgIGlmICghYnVmKQoJICAgICAgICBidWYgPSBuZXcgdTgoc2wgKiAzKTsKCSAgICAvLyBlbnN1cmUgYnVmZmVyIGNhbiBmaXQgYXQgbGVhc3QgbCBlbGVtZW50cwoJICAgIHZhciBjYnVmID0gZnVuY3Rpb24gKGwpIHsKCSAgICAgICAgdmFyIGJsID0gYnVmLmxlbmd0aDsKCSAgICAgICAgLy8gbmVlZCB0byBpbmNyZWFzZSBzaXplIHRvIGZpdAoJICAgICAgICBpZiAobCA+IGJsKSB7CgkgICAgICAgICAgICAvLyBEb3VibGUgb3Igc2V0IHRvIG5lY2Vzc2FyeSwgd2hpY2hldmVyIGlzIGdyZWF0ZXIKCSAgICAgICAgICAgIHZhciBuYnVmID0gbmV3IHU4KE1hdGgubWF4KGJsICogMiwgbCkpOwoJICAgICAgICAgICAgbmJ1Zi5zZXQoYnVmKTsKCSAgICAgICAgICAgIGJ1ZiA9IG5idWY7CgkgICAgICAgIH0KCSAgICB9OwoJICAgIC8vICBsYXN0IGNodW5rICAgICAgICAgYml0cG9zICAgICAgICAgICBieXRlcwoJICAgIHZhciBmaW5hbCA9IHN0LmYgfHwgMCwgcG9zID0gc3QucCB8fCAwLCBidCA9IHN0LmIgfHwgMCwgbG0gPSBzdC5sLCBkbSA9IHN0LmQsIGxidCA9IHN0Lm0sIGRidCA9IHN0Lm47CgkgICAgLy8gdG90YWwgYml0cwoJICAgIHZhciB0YnRzID0gc2wgKiA4OwoJICAgIGRvIHsKCSAgICAgICAgaWYgKCFsbSkgewoJICAgICAgICAgICAgLy8gQkZJTkFMIC0gdGhpcyBpcyBvbmx5IDEgd2hlbiBsYXN0IGNodW5rIGlzIG5leHQKCSAgICAgICAgICAgIGZpbmFsID0gYml0cyhkYXQsIHBvcywgMSk7CgkgICAgICAgICAgICAvLyB0eXBlOiAwID0gbm8gY29tcHJlc3Npb24sIDEgPSBmaXhlZCBodWZmbWFuLCAyID0gZHluYW1pYyBodWZmbWFuCgkgICAgICAgICAgICB2YXIgdHlwZSA9IGJpdHMoZGF0LCBwb3MgKyAxLCAzKTsKCSAgICAgICAgICAgIHBvcyArPSAzOwoJICAgICAgICAgICAgaWYgKCF0eXBlKSB7CgkgICAgICAgICAgICAgICAgLy8gZ28gdG8gZW5kIG9mIGJ5dGUgYm91bmRhcnkKCSAgICAgICAgICAgICAgICB2YXIgcyA9IHNoZnQocG9zKSArIDQsIGwgPSBkYXRbcyAtIDRdIHwgKGRhdFtzIC0gM10gPDwgOCksIHQgPSBzICsgbDsKCSAgICAgICAgICAgICAgICBpZiAodCA+IHNsKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChub1N0KQoJICAgICAgICAgICAgICAgICAgICAgICAgZXJyKDApOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgLy8gZW5zdXJlIHNpemUKCSAgICAgICAgICAgICAgICBpZiAobm9CdWYpCgkgICAgICAgICAgICAgICAgICAgIGNidWYoYnQgKyBsKTsKCSAgICAgICAgICAgICAgICAvLyBDb3B5IG92ZXIgdW5jb21wcmVzc2VkIGRhdGEKCSAgICAgICAgICAgICAgICBidWYuc2V0KGRhdC5zdWJhcnJheShzLCB0KSwgYnQpOwoJICAgICAgICAgICAgICAgIC8vIEdldCBuZXcgYml0cG9zLCB1cGRhdGUgYnl0ZSBjb3VudAoJICAgICAgICAgICAgICAgIHN0LmIgPSBidCArPSBsLCBzdC5wID0gcG9zID0gdCAqIDgsIHN0LmYgPSBmaW5hbDsKCSAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gMSkKCSAgICAgICAgICAgICAgICBsbSA9IGZscm0sIGRtID0gZmRybSwgbGJ0ID0gOSwgZGJ0ID0gNTsKCSAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gMikgewoJICAgICAgICAgICAgICAgIC8vICBsaXRlcmFsICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aHMKCSAgICAgICAgICAgICAgICB2YXIgaExpdCA9IGJpdHMoZGF0LCBwb3MsIDMxKSArIDI1NywgaGNMZW4gPSBiaXRzKGRhdCwgcG9zICsgMTAsIDE1KSArIDQ7CgkgICAgICAgICAgICAgICAgdmFyIHRsID0gaExpdCArIGJpdHMoZGF0LCBwb3MgKyA1LCAzMSkgKyAxOwoJICAgICAgICAgICAgICAgIHBvcyArPSAxNDsKCSAgICAgICAgICAgICAgICAvLyBsZW5ndGgrZGlzdGFuY2UgdHJlZQoJICAgICAgICAgICAgICAgIHZhciBsZHQgPSBuZXcgdTgodGwpOwoJICAgICAgICAgICAgICAgIC8vIGNvZGUgbGVuZ3RoIHRyZWUKCSAgICAgICAgICAgICAgICB2YXIgY2x0ID0gbmV3IHU4KDE5KTsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhjTGVuOyArK2kpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGluZGV4IG1hcCB0byBnZXQgcmVhbCBjb2RlCgkgICAgICAgICAgICAgICAgICAgIGNsdFtjbGltW2ldXSA9IGJpdHMoZGF0LCBwb3MgKyBpICogMywgNyk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIHBvcyArPSBoY0xlbiAqIDM7CgkgICAgICAgICAgICAgICAgLy8gY29kZSBsZW5ndGhzIGJpdHMKCSAgICAgICAgICAgICAgICB2YXIgY2xiID0gbWF4KGNsdCksIGNsYm1zayA9ICgxIDw8IGNsYikgLSAxOwoJICAgICAgICAgICAgICAgIC8vIGNvZGUgbGVuZ3RocyBtYXAKCSAgICAgICAgICAgICAgICB2YXIgY2xtID0gaE1hcChjbHQsIGNsYiwgMSk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0bDspIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIHIgPSBjbG1bYml0cyhkYXQsIHBvcywgY2xibXNrKV07CgkgICAgICAgICAgICAgICAgICAgIC8vIGJpdHMgcmVhZAoJICAgICAgICAgICAgICAgICAgICBwb3MgKz0gciAmIDE1OwoJICAgICAgICAgICAgICAgICAgICAvLyBzeW1ib2wKCSAgICAgICAgICAgICAgICAgICAgdmFyIHMgPSByID4+PiA0OwoJICAgICAgICAgICAgICAgICAgICAvLyBjb2RlIGxlbmd0aCB0byBjb3B5CgkgICAgICAgICAgICAgICAgICAgIGlmIChzIDwgMTYpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGxkdFtpKytdID0gczsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vICBjb3B5ICAgY291bnQKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gMCwgbiA9IDA7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAocyA9PSAxNikKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBuID0gMyArIGJpdHMoZGF0LCBwb3MsIDMpLCBwb3MgKz0gMiwgYyA9IGxkdFtpIC0gMV07CgkgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzID09IDE3KQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4gPSAzICsgYml0cyhkYXQsIHBvcywgNyksIHBvcyArPSAzOwoJICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocyA9PSAxOCkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBuID0gMTEgKyBiaXRzKGRhdCwgcG9zLCAxMjcpLCBwb3MgKz0gNzsKCSAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChuLS0pCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGR0W2krK10gPSBjOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIC8vICAgIGxlbmd0aCB0cmVlICAgICAgICAgICAgICAgICBkaXN0YW5jZSB0cmVlCgkgICAgICAgICAgICAgICAgdmFyIGx0ID0gbGR0LnN1YmFycmF5KDAsIGhMaXQpLCBkdCA9IGxkdC5zdWJhcnJheShoTGl0KTsKCSAgICAgICAgICAgICAgICAvLyBtYXggbGVuZ3RoIGJpdHMKCSAgICAgICAgICAgICAgICBsYnQgPSBtYXgobHQpOwoJICAgICAgICAgICAgICAgIC8vIG1heCBkaXN0IGJpdHMKCSAgICAgICAgICAgICAgICBkYnQgPSBtYXgoZHQpOwoJICAgICAgICAgICAgICAgIGxtID0gaE1hcChsdCwgbGJ0LCAxKTsKCSAgICAgICAgICAgICAgICBkbSA9IGhNYXAoZHQsIGRidCwgMSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgZXJyKDEpOwoJICAgICAgICAgICAgaWYgKHBvcyA+IHRidHMpIHsKCSAgICAgICAgICAgICAgICBpZiAobm9TdCkKCSAgICAgICAgICAgICAgICAgICAgZXJyKDApOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGUgYnVmZmVyIGNhbiBob2xkIHRoaXMgKyB0aGUgbGFyZ2VzdCBwb3NzaWJsZSBhZGRpdGlvbgoJICAgICAgICAvLyBNYXhpbXVtIGNodW5rIHNpemUgKHByYWN0aWNhbGx5LCB0aGVvcmV0aWNhbGx5IGluZmluaXRlKSBpcyAyXjE3OwoJICAgICAgICBpZiAobm9CdWYpCgkgICAgICAgICAgICBjYnVmKGJ0ICsgMTMxMDcyKTsKCSAgICAgICAgdmFyIGxtcyA9ICgxIDw8IGxidCkgLSAxLCBkbXMgPSAoMSA8PCBkYnQpIC0gMTsKCSAgICAgICAgdmFyIGxwb3MgPSBwb3M7CgkgICAgICAgIGZvciAoOzsgbHBvcyA9IHBvcykgewoJICAgICAgICAgICAgLy8gYml0cyByZWFkLCBjb2RlCgkgICAgICAgICAgICB2YXIgYyA9IGxtW2JpdHMxNihkYXQsIHBvcykgJiBsbXNdLCBzeW0gPSBjID4+PiA0OwoJICAgICAgICAgICAgcG9zICs9IGMgJiAxNTsKCSAgICAgICAgICAgIGlmIChwb3MgPiB0YnRzKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vU3QpCgkgICAgICAgICAgICAgICAgICAgIGVycigwKTsKCSAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICghYykKCSAgICAgICAgICAgICAgICBlcnIoMik7CgkgICAgICAgICAgICBpZiAoc3ltIDwgMjU2KQoJICAgICAgICAgICAgICAgIGJ1ZltidCsrXSA9IHN5bTsKCSAgICAgICAgICAgIGVsc2UgaWYgKHN5bSA9PSAyNTYpIHsKCSAgICAgICAgICAgICAgICBscG9zID0gcG9zLCBsbSA9IG51bGw7CgkgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICB2YXIgYWRkID0gc3ltIC0gMjU0OwoJICAgICAgICAgICAgICAgIC8vIG5vIGV4dHJhIGJpdHMgbmVlZGVkIGlmIGxlc3MKCSAgICAgICAgICAgICAgICBpZiAoc3ltID4gMjY0KSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIGluZGV4CgkgICAgICAgICAgICAgICAgICAgIHZhciBpID0gc3ltIC0gMjU3LCBiID0gZmxlYltpXTsKCSAgICAgICAgICAgICAgICAgICAgYWRkID0gYml0cyhkYXQsIHBvcywgKDEgPDwgYikgLSAxKSArIGZsW2ldOwoJICAgICAgICAgICAgICAgICAgICBwb3MgKz0gYjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgLy8gZGlzdAoJICAgICAgICAgICAgICAgIHZhciBkID0gZG1bYml0czE2KGRhdCwgcG9zKSAmIGRtc10sIGRzeW0gPSBkID4+PiA0OwoJICAgICAgICAgICAgICAgIGlmICghZCkKCSAgICAgICAgICAgICAgICAgICAgZXJyKDMpOwoJICAgICAgICAgICAgICAgIHBvcyArPSBkICYgMTU7CgkgICAgICAgICAgICAgICAgdmFyIGR0ID0gZmRbZHN5bV07CgkgICAgICAgICAgICAgICAgaWYgKGRzeW0gPiAzKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBiID0gZmRlYltkc3ltXTsKCSAgICAgICAgICAgICAgICAgICAgZHQgKz0gYml0czE2KGRhdCwgcG9zKSAmICgoMSA8PCBiKSAtIDEpLCBwb3MgKz0gYjsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKHBvcyA+IHRidHMpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG5vU3QpCgkgICAgICAgICAgICAgICAgICAgICAgICBlcnIoMCk7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAobm9CdWYpCgkgICAgICAgICAgICAgICAgICAgIGNidWYoYnQgKyAxMzEwNzIpOwoJICAgICAgICAgICAgICAgIHZhciBlbmQgPSBidCArIGFkZDsKCSAgICAgICAgICAgICAgICBmb3IgKDsgYnQgPCBlbmQ7IGJ0ICs9IDQpIHsKCSAgICAgICAgICAgICAgICAgICAgYnVmW2J0XSA9IGJ1ZltidCAtIGR0XTsKCSAgICAgICAgICAgICAgICAgICAgYnVmW2J0ICsgMV0gPSBidWZbYnQgKyAxIC0gZHRdOwoJICAgICAgICAgICAgICAgICAgICBidWZbYnQgKyAyXSA9IGJ1ZltidCArIDIgLSBkdF07CgkgICAgICAgICAgICAgICAgICAgIGJ1ZltidCArIDNdID0gYnVmW2J0ICsgMyAtIGR0XTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgYnQgPSBlbmQ7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgc3QubCA9IGxtLCBzdC5wID0gbHBvcywgc3QuYiA9IGJ0LCBzdC5mID0gZmluYWw7CgkgICAgICAgIGlmIChsbSkKCSAgICAgICAgICAgIGZpbmFsID0gMSwgc3QubSA9IGxidCwgc3QuZCA9IGRtLCBzdC5uID0gZGJ0OwoJICAgIH0gd2hpbGUgKCFmaW5hbCk7CgkgICAgcmV0dXJuIGJ0ID09IGJ1Zi5sZW5ndGggPyBidWYgOiBzbGMoYnVmLCAwLCBidCk7Cgl9OwoJLy8gZW1wdHkKCXZhciBldCA9IC8qI19fUFVSRV9fKi8gbmV3IHU4KDApOwoJLy8gemxpYiB2YWxpZAoJdmFyIHpsdiA9IGZ1bmN0aW9uIChkKSB7CgkgICAgaWYgKChkWzBdICYgMTUpICE9IDggfHwgKGRbMF0gPj4+IDQpID4gNyB8fCAoKGRbMF0gPDwgOCB8IGRbMV0pICUgMzEpKQoJICAgICAgICBlcnIoNiwgJ2ludmFsaWQgemxpYiBkYXRhJyk7CgkgICAgaWYgKGRbMV0gJiAzMikKCSAgICAgICAgZXJyKDYsICdpbnZhbGlkIHpsaWIgZGF0YTogcHJlc2V0IGRpY3Rpb25hcmllcyBub3Qgc3VwcG9ydGVkJyk7Cgl9OwoJLyoqCgkgKiBFeHBhbmRzIFpsaWIgZGF0YQoJICogQHBhcmFtIGRhdGEgVGhlIGRhdGEgdG8gZGVjb21wcmVzcwoJICogQHBhcmFtIG91dCBXaGVyZSB0byB3cml0ZSB0aGUgZGF0YS4gU2F2ZXMgbWVtb3J5IGlmIHlvdSBrbm93IHRoZSBkZWNvbXByZXNzZWQgc2l6ZSBhbmQgcHJvdmlkZSBhbiBvdXRwdXQgYnVmZmVyIG9mIHRoYXQgbGVuZ3RoLgoJICogQHJldHVybnMgVGhlIGRlY29tcHJlc3NlZCB2ZXJzaW9uIG9mIHRoZSBkYXRhCgkgKi8KCWZ1bmN0aW9uIHVuemxpYlN5bmMoZGF0YSwgb3V0KSB7CgkgICAgcmV0dXJuIGluZmx0KCh6bHYoZGF0YSksIGRhdGEuc3ViYXJyYXkoMiwgLTQpKSwgb3V0KTsKCX0KCS8vIHRleHQgZGVjb2RlcgoJdmFyIHRkID0gdHlwZW9mIFRleHREZWNvZGVyICE9ICd1bmRlZmluZWQnICYmIC8qI19fUFVSRV9fKi8gbmV3IFRleHREZWNvZGVyKCk7CgkvLyB0ZXh0IGRlY29kZXIgc3RyZWFtCgl2YXIgdGRzID0gMDsKCXRyeSB7CgkgICAgdGQuZGVjb2RlKGV0LCB7IHN0cmVhbTogdHJ1ZSB9KTsKCSAgICB0ZHMgPSAxOwoJfQoJY2F0Y2ggKGUpIHsgfQoKCWNvbnN0IHsgTWVzc2FnZSAsIEVudGl0eSAgfSA9IHByb3RvY29sLnByb3RvY29sOwoJLy8gQHRzLWlnbm9yZQoJb25jb25uZWN0ID0gKGUpPT57CgkgICAgY29uc3QgcG9ydCA9IGUucG9ydHNbMF07CgkgICAgcG9ydC5vbm1lc3NhZ2UgPSAoZSk9PnsKCSAgICAgICAgbGV0IHsgZGF0YTogYnVmZmVycyAgfSA9IGU7CgkgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShidWZmZXJzKSkgewoJICAgICAgICAgICAgYnVmZmVycyA9IFsKCSAgICAgICAgICAgICAgICBidWZmZXJzCgkgICAgICAgICAgICBdOwoJICAgICAgICB9CgkgICAgICAgIGNvbnN0IHRyYW5zZmVyYWJsZXMgPSBbXTsKCSAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBidWZmZXJzLm1hcCgoYnVmZmVyKT0+ewoJICAgICAgICAgICAgaWYgKGJ1ZmZlclswXSA9PT0gMHg3OCAmJiBidWZmZXJbMV0gPT09IDB4OWMpIHsKCSAgICAgICAgICAgICAgICBidWZmZXIgPSB1bnpsaWJTeW5jKGJ1ZmZlcik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gTWVzc2FnZS50b09iamVjdChNZXNzYWdlLmRlY29kZShidWZmZXIpLCB7CgkgICAgICAgICAgICAgICAgZGVmYXVsdHM6IHRydWUKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gTWVzc2FnZS5UeXBlW21lc3NhZ2UudHlwZV07CgkgICAgICAgICAgICBpZiAobWVzc2FnZS5qc29uKSB7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5qc29uID0gSlNPTi5wYXJzZShtZXNzYWdlLmpzb24pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZW50aXRpZXMpIHsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLmVudGl0aWVzLmZvckVhY2goKGVudGl0eSk9PnsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eS5tZXRhZGF0YSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5Lm1ldGFkYXRhID0gSlNPTi5wYXJzZShlbnRpdHkubWV0YWRhdGEpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGVudGl0eS5vcGVyYXRpb24gPSBFbnRpdHkuT3BlcmF0aW9uW2VudGl0eS5vcGVyYXRpb25dOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UucGVlcnMpIHsKCSAgICAgICAgICAgICAgICBtZXNzYWdlLnBlZXJzLmZvckVhY2goKHBlZXIpPT57CgkgICAgICAgICAgICAgICAgICAgIGlmIChwZWVyLm1ldGFkYXRhKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBwZWVyLm1ldGFkYXRhID0gSlNPTi5wYXJzZShwZWVyLm1ldGFkYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZXZlbnRzKSB7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5ldmVudHMuZm9yRWFjaCgoZXZlbnQpPT57CgkgICAgICAgICAgICAgICAgICAgIGV2ZW50LnBheWxvYWQgPSBKU09OLnBhcnNlKGV2ZW50LnBheWxvYWQpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKG1lc3NhZ2UuY2h1bmtzKSB7CgkgICAgICAgICAgICAgICAgbWVzc2FnZS5jaHVua3MuZm9yRWFjaCgoY2h1bmspPT57CgkgICAgICAgICAgICAgICAgICAgIFsKCSAgICAgICAgICAgICAgICAgICAgICAgICJsaWdodHMiLAoJICAgICAgICAgICAgICAgICAgICAgICAgInZveGVscyIKCSAgICAgICAgICAgICAgICAgICAgXS5mb3JFYWNoKChrZXkpPT57CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2h1bmtba2V5XSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rW2tleV0gPSBuZXcgVWludDMyQXJyYXkoY2h1bmtba2V5XSkuYnVmZmVyOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZmVyYWJsZXMucHVzaChjaHVua1trZXldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChjaHVuay5tZXNoKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBbCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluZGljZXMiLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICJsaWdodHMiCgkgICAgICAgICAgICAgICAgICAgICAgICBdLmZvckVhY2goKGtleSk9PnsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IG9wYXF1ZSAsIHRyYW5zcGFyZW50ICB9ID0gY2h1bmsubWVzaDsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYXF1ZSwKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLmZvckVhY2goKG1lc2gpPT57CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNoICYmIG1lc2hba2V5XSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzaFtrZXldID0gbmV3IEludDMyQXJyYXkobWVzaFtrZXldKS5idWZmZXI7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2ZlcmFibGVzLnB1c2gobWVzaFtrZXldKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBbCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgInBvc2l0aW9ucyIsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgInV2cyIKCSAgICAgICAgICAgICAgICAgICAgICAgIF0uZm9yRWFjaCgoa2V5KT0+ewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgb3BhcXVlICwgdHJhbnNwYXJlbnQgIH0gPSBjaHVuay5tZXNoOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BhcXVlLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc3BhcmVudAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uZm9yRWFjaCgobWVzaCk9PnsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc2ggJiYgbWVzaFtrZXldKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNoW2tleV0gPSBuZXcgRmxvYXQzMkFycmF5KG1lc2hba2V5XSkuYnVmZmVyOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmZXJhYmxlcy5wdXNoKG1lc2hba2V5XSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKCSAgICAgICAgfSk7CgkgICAgICAgIC8vIEB0cy1pZ25vcmUKCSAgICAgICAgcG9ydC5wb3N0TWVzc2FnZShtZXNzYWdlcywgdHJhbnNmZXJhYmxlcyk7CgkgICAgfTsKCX07Cgp9KSgpOwoK",null,!1);function _defineProperty$3(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}function _objectSpread(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{},A=Object.keys(C);"function"==typeof Object.getOwnPropertySymbols&&(A=A.concat(Object.getOwnPropertySymbols(C).filter((function(g){return Object.getOwnPropertyDescriptor(C,g).enumerable})))),A.forEach((function(I){_defineProperty$3(g,I,C[I])}))}return g}const{Message:Message}=protocol.protocol,defaultOptions={maxPacketsPerTick:8};class Network{get concurrentWorkers(){return this.pool.workingCount}get packetQueueLength(){return this.packetQueue.length}static encodeSync(g){return g.json&&(g.json=JSON.stringify(g.json)),g.type=Message.Type[g.type],g.entities&&g.entities.forEach((g=>g.metadata=JSON.stringify(g.metadata))),g.peers&&g.peers.forEach((g=>g.metadata=JSON.stringify(g.metadata))),protocol.protocol.Message.encode(protocol.protocol.Message.create(g)).finish()}constructor(g){var I=this;void 0===g&&(g={}),_defineProperty$3(this,"options",void 0),_defineProperty$3(this,"clientInfo",{id:"",username:""}),_defineProperty$3(this,"intercepts",[]),_defineProperty$3(this,"ws",void 0),_defineProperty$3(this,"url",void 0),_defineProperty$3(this,"world",void 0),_defineProperty$3(this,"socket",void 0),_defineProperty$3(this,"connected",!1),_defineProperty$3(this,"joined",!1),_defineProperty$3(this,"onJoin",void 0),_defineProperty$3(this,"onLeave",void 0),_defineProperty$3(this,"onConnect",void 0),_defineProperty$3(this,"onDisconnect",void 0),_defineProperty$3(this,"pool",new SharedWorkerPool(WorkerFactory,{maxWorker:window.navigator.hardwareConcurrency||4})),_defineProperty$3(this,"reconnection",void 0),_defineProperty$3(this,"joinResolve",null),_defineProperty$3(this,"joinReject",null),_defineProperty$3(this,"packetQueue",[]),_defineProperty$3(this,"connect",(async function(g,C){if(void 0===C&&(C={}),!g)throw new Error("No server URL provided.");if("string"!=typeof g)throw new Error("Server URL must be a string.");I.url=new DOMUrl(g),I.url.protocol=I.url.protocol.replace(/ws/,"http"),I.url.hash="";const A=new DOMUrl(g);A.path="/ws/",I.socket=new URL(A.toString()),I.socket.protocol=I.socket.protocol.replace(/http/,"ws"),I.socket.hash="",I.socket.searchParams.set("secret",C.secret||""),I.socket.searchParams.set("client_id",I.clientInfo.id||"");let t=Math.floor(1e4*Math.random()).toString();return t=new Array(1e4.toString().length-t.length).fill("0").join("")+t,I.clientInfo.username=`Guest ${t}`,I.ws&&(I.ws.onclose=null,I.ws.onmessage=null,I.ws.close(),I.reconnection&&clearTimeout(I.reconnection)),new Promise((A=>{const t=new WebSocket(I.socket.toString());t.binaryType="arraybuffer",t.sendEvent=g=>{t.send(Network.encodeSync(g))},t.onopen=()=>{var g,C;I.connected=!0,null===(C=(g=I).onConnect)||void 0===C||C.call(g),clearTimeout(I.reconnection),A(I)},t.onerror=console.error,t.onmessage=g=>{let{data:C}=g;I.packetQueue.push(C)},t.onclose=()=>{var A,t;I.connected=!1,null===(t=(A=I).onDisconnect)||void 0===t||t.call(A),C.reconnectTimeout&&(I.reconnection=setTimeout((()=>{I.connect(g,C)}),C.reconnectTimeout))},I.ws=t}))})),_defineProperty$3(this,"join",(async g=>(this.joined&&this.leave(),this.joined=!0,this.world=g,this.send({type:"JOIN",json:{world:g,username:this.clientInfo.username}}),new Promise(((g,I)=>{this.joinResolve=g,this.joinReject=I}))))),_defineProperty$3(this,"leave",(()=>{this.joined&&(this.joined=!1,this.send({type:"LEAVE",text:this.world}))})),_defineProperty$3(this,"action",(async(g,I)=>{this.send({type:"ACTION",json:{action:g,data:I}})})),_defineProperty$3(this,"sync",(()=>{this.connected&&this.packetQueue.length&&!this.pool.isBusy&&this.decode(this.packetQueue.splice(0,Math.min(this.options.maxPacketsPerTick,this.packetQueue.length)).map((g=>new Uint8Array(g)))).then((async g=>{g.forEach((g=>{this.onMessage(g)}))}))})),_defineProperty$3(this,"flush",(()=>{this.intercepts.forEach((g=>{g.packets&&g.packets.length&&g.packets.splice(0,g.packets.length).forEach((g=>{this.send(g)}))}))})),_defineProperty$3(this,"register",(function(){for(var g=arguments.length,C=new Array(g),A=0;A<g;A++)C[A]=arguments[A];return C.forEach((g=>{I.intercepts.push(g)})),I})),_defineProperty$3(this,"unregister",(function(){for(var g=arguments.length,C=new Array(g),A=0;A<g;A++)C[A]=arguments[A];return C.forEach((g=>{const C=I.intercepts.indexOf(g);-1!==C&&I.intercepts.splice(C,1)})),I})),_defineProperty$3(this,"disconnect",(()=>{this.connected&&(this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close()),this.reconnection&&clearTimeout(this.reconnection))})),_defineProperty$3(this,"send",(g=>{this.ws.sendEvent(g)})),_defineProperty$3(this,"setID",(g=>{this.clientInfo.id=g||""})),_defineProperty$3(this,"setUsername",(g=>{this.clientInfo.username=g||" "})),_defineProperty$3(this,"onMessage",(async g=>{const{type:I}=g;if("ERROR"===I){const{text:I}=g;return this.disconnect(),void this.joinReject(I)}if("INIT"===I){const{id:I}=g.json;if(I){if(this.clientInfo.id&&this.clientInfo.id!==I)throw new Error("Something went wrong with IDs! Better check if you're passing two same ID's to the same Voxelize server.");this.clientInfo.id=I}}if(this.intercepts.forEach((I=>{var C;null===(C=I.onMessage)||void 0===C||C.call(I,g,this.clientInfo)})),"INIT"===I){var C;if(!this.joinResolve)throw new Error("Something went wrong with joining worlds...");this.joinResolve(this),null===(C=this.onJoin)||void 0===C||C.call(this,this.world)}})),_defineProperty$3(this,"decode",(async g=>new Promise((I=>{this.pool.addJob({message:g,buffers:g.map((g=>g.buffer)),resolve:I})})))),this.options=_objectSpread({},defaultOptions,g),setWorkerInterval((()=>{this.flush(),this.sync()}),1e3/60)}}function _defineProperty$2(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Chat{send(g){if(g.body.startsWith(this._commandSymbol)){const I=g.body.substring(this._commandSymbol.length).split(" ").filter(Boolean),C=I.shift(),A=I.join(" "),t=this.commands.get(C);if(t)return void t(A.trim())}this.packets.push({type:"CHAT",chat:g})}addCommand(g,I,C){if(void 0===C&&(C=[]),this.commands.has(g))throw new Error(`Command trigger already taken: ${g}`);if(g.split(" ").length>1)throw new Error("Command trigger must be one word.");this.commands.set(g,I);for(const A of C)this.commands.has(A)?console.warn(`Command alias for "${g}", "${A}" ignored as already taken.`):this.commands.set(A,I)}removeCommand(g){return!!this.commands.delete(g)}get commandSymbol(){return this._commandSymbol}constructor(){_defineProperty$2(this,"commands",new Map),_defineProperty$2(this,"packets",[]),_defineProperty$2(this,"_commandSymbol",void 0),_defineProperty$2(this,"onChat",void 0),_defineProperty$2(this,"onMessage",(g=>{switch(g.type){case"INIT":{const{commandSymbol:I}=g.json.options;this._commandSymbol=I;break}case"CHAT":{var I;const{chat:C}=g;null===(I=this.onChat)||void 0===I||I.call(this,C);break}}}))}}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&!(getRandomValues="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}var REGEX=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(g){return"string"==typeof g&&REGEX.test(g)}for(var byteToHex=[],i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify(g){var I=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,C=(byteToHex[g[I+0]]+byteToHex[g[I+1]]+byteToHex[g[I+2]]+byteToHex[g[I+3]]+"-"+byteToHex[g[I+4]]+byteToHex[g[I+5]]+"-"+byteToHex[g[I+6]]+byteToHex[g[I+7]]+"-"+byteToHex[g[I+8]]+byteToHex[g[I+9]]+"-"+byteToHex[g[I+10]]+byteToHex[g[I+11]]+byteToHex[g[I+12]]+byteToHex[g[I+13]]+byteToHex[g[I+14]]+byteToHex[g[I+15]]).toLowerCase();if(!validate(C))throw TypeError("Stringified UUID is invalid");return C}function v4(g,I,C){var A=(g=g||{}).random||(g.rng||rng)();if(A[6]=15&A[6]|64,A[8]=63&A[8]|128,I){C=C||0;for(var t=0;t<16;++t)I[C+t]=A[t];return I}return stringify(A)}function _defineProperty$1(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Inputs extends events.exports.EventEmitter{on(g,I){return super.on(g,I),this}constructor(){var g;super(),g=this,_defineProperty$1(this,"namespace",void 0),_defineProperty$1(this,"clickCallbacks",new Map),_defineProperty$1(this,"scrollCallbacks",new Map),_defineProperty$1(this,"keyDownCallbacks",new Map),_defineProperty$1(this,"keyUpCallbacks",new Map),_defineProperty$1(this,"keyPressCallbacks",new Map),_defineProperty$1(this,"keyBounds",new Map),_defineProperty$1(this,"unbinds",[]),_defineProperty$1(this,"click",(function(I,C,A){var t;void 0===A&&(A="*");const e=v4();return null===(t=g.clickCallbacks.get(I))||void 0===t||t.set(e,{namespace:A,callback:C}),()=>g.clickCallbacks.get(I).delete(e)})),_defineProperty$1(this,"scroll",(function(I,C,A){void 0===A&&(A="*");const t=v4();return g.scrollCallbacks.set(t,{up:I,down:C,namespace:A}),()=>g.scrollCallbacks.delete(t)})),_defineProperty$1(this,"bind",(function(I,C,A,t){void 0===A&&(A="*"),void 0===t&&(t={}),I=g.modifyKey(I);const{occasion:e="keydown",identifier:o="default"}=t,i=I+e,l=g.keyBounds.get(i);if(l&&l[o])throw new Error(`Error registering input, key ${I}: already bound.`);switch(e){case"keydown":g.keyDownCallbacks.set(i,[...g.keyDownCallbacks.get(i)||[],C]);break;case"keyup":g.keyUpCallbacks.set(i,[...g.keyUpCallbacks.get(i)||[],C]);break;case"keypress":g.keyPressCallbacks.set(i,[...g.keyPressCallbacks.get(i)||[],C])}const c=g.keyBounds.get(i)||{},n=()=>{[["keydown",g.keyDownCallbacks],["keyup",g.keyUpCallbacks],["keypress",g.keyPressCallbacks]].forEach((g=>{let[I,A]=g;var t;if(I!==e)return;const o=A.get(i);if(o){const g=o.indexOf(C);-1!==g&&o.splice(g,1)}0===(null===(t=A.get(i))||void 0===t?void 0:t.length)&&A.delete(i)})),delete c[o]};return c[o]={unbind:n,callback:C,namespace:A},g.keyBounds.set(i,c),n})),_defineProperty$1(this,"unbind",(function(I,C){void 0===C&&(C={}),I=g.modifyKey(I);const{occasion:A="keydown",identifier:t="default"}=C,e=I+A,o=(g.keyBounds.get(e)||{})[t];if(o){const{unbind:g}=o;return g(),!0}return!1})),_defineProperty$1(this,"swap",(function(I,C,A){void 0===A&&(A={}),I=g.modifyKey(I),C=g.modifyKey(C);const{occasion:t="keydown",identifier:e="default"}=A,o=I+t,i=C+t,l=(g.keyBounds.get(o)||{})[e],c=(g.keyBounds.get(i)||{})[e];if(!l)throw new Error(`Key ${o} is not bound.`);if(!c)throw new Error(`Key ${i} is not bound.`);const{unbind:n,callback:d,namespace:s}=l,{unbind:Z,callback:b,namespace:a}=c;n(),Z(),g.bind(C,d,s,A),g.bind(I,b,a,A)})),_defineProperty$1(this,"remap",(function(I,C,A){void 0===A&&(A={}),I=g.modifyKey(I);const{occasion:t="keydown",identifier:e="default"}=A,o=I+t,i=(g.keyBounds.get(o)||{})[e];if(!i)throw new Error(`Key ${o} is not bound.`);const{unbind:l,callback:c,namespace:n}=i;l(),g.bind(C,c,n,A)})),_defineProperty$1(this,"setNamespace",(g=>{this.namespace=g,this.emit("namespace",g)})),_defineProperty$1(this,"reset",(()=>{this.keyBounds.forEach((g=>Object.values(g).forEach((g=>g.unbind())))),this.unbinds.forEach((g=>g()))})),_defineProperty$1(this,"modifyKey",(g=>(g.length>1?g.charAt(0).toUpperCase()+g.slice(1):g).toLowerCase())),_defineProperty$1(this,"initializeKeyListeners",(()=>{const g=g=>I=>{const{key:C,code:A}=I,t=(C||A).toLowerCase()+g,e=this.keyBounds.get(t);e&&Object.values(e).forEach((g=>{const{callback:I,namespace:C}=g;"*"!==C&&C!==this.namespace||I()}))};document.addEventListener("keydown",g("keydown")),document.addEventListener("keyup",g("keyup")),document.addEventListener("keypress",g("keypress"))})),_defineProperty$1(this,"initializeClickListeners",(()=>{["left","middle","right"].forEach((g=>this.clickCallbacks.set(g,new Map)));const g=g=>{let I,{button:C}=g;0===C?I=this.clickCallbacks.get("left"):1===C?I=this.clickCallbacks.get("middle"):2===C&&(I=this.clickCallbacks.get("right")),I.forEach((g=>{let{namespace:I,callback:C}=g;this.namespace!==I&&"*"!==I||C()}))};document.addEventListener("mousedown",g,!1),this.unbinds.push((()=>document.removeEventListener("mousedown",g,!1)))})),_defineProperty$1(this,"initializeScrollListeners",(()=>{const g=g=>{let{deltaY:I}=g;this.scrollCallbacks.forEach((g=>{let{up:C,down:A,namespace:t}=g;this.namespace!==t&&"*"!==t||(I>0?C(I):I<0&&A(I))}))};document.addEventListener("wheel",g),this.unbinds.push((()=>document.removeEventListener("wheel",g)))})),this.initializeKeyListeners(),this.initializeClickListeners(),this.initializeScrollListeners()}}function _defineProperty(g,I,C){return I in g?Object.defineProperty(g,I,{value:C,enumerable:!0,configurable:!0,writable:!0}):g[I]=C,g}class Method{constructor(){var g=this;_defineProperty(this,"packets",[]),_defineProperty(this,"call",(function(I,C){void 0===C&&(C={}),g.packets.push({type:"METHOD",method:{name:I,payload:JSON.stringify(C)}})}))}}}}]);